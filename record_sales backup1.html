<!DOCTYPE html>
<html lang="th">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta charset="UTF-8" />
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</title>
  <style>
    :root{
      --teal:#0f766e;
      --teal-600:#0d9488;
      --bg:#f7f7f7;
      --card:#ffffff;
      --muted:#6b7280;
      --line:#e5e7eb;
      --chip:#eef7f6;
      --danger:#c62828;
    }
    *{box-sizing:border-box}
    body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background-color: var(--bg); padding: 10px 10px 140px; color:#111827 }
    h2 { text-align: center; color: var(--teal); font-size: 20px; margin: 10px 0 0 }
    .container { max-width: 880px; margin: 20px auto; background: var(--card); border-radius: 14px; padding: 22px; box-shadow: 0 6px 22px rgba(2,8,23,.06) }
    .section-title{display:flex;align-items:center;gap:8px;margin:8px 0 6px;font-weight:800;color:#0b7660}
    .section-sub{margin:0 0 10px;color:var(--muted);font-size:12px}

    /* inline field rows */
    .field-row{display:grid;grid-template-columns:180px 1fr;gap:12px;align-items:center;margin:8px 0}
    .field-row label{font-weight:700;font-size:14px;margin:0}
    input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; background:#fff; font-size:14px }
    input:focus, select:focus, textarea:focus{ outline: 2px solid #94d3ce; border-color: #94d3ce }
    .muted{ color: var(--muted); font-size:12px }
    .pill{background:var(--chip); border:1px solid #cfe9e6; color:#0b7660; padding:4px 8px; border-radius:999px; font-size:12px; display:inline-flex; align-items:center; gap:6px }
    .row{display:flex;gap:8px;align-items:center}
    .nowrap{flex-wrap:nowrap}
    .grow{flex:1; min-width:0}

    /* buttons */
    .btn { display:inline-flex; gap:8px; align-items:center; justify-content:center; padding: 10px 12px; border-radius: 10px; border:none; cursor:pointer; font-weight:700; font-size:14px }
    .btn-primary{ background: var(--teal-600); color:#fff }
    .btn-save{ background:#43a047; color:#fff; padding:12px 18px }
    .btn-ghost{ background:#f1f5f9 }
    .btn-danger{ background: var(--danger); color:#fff }
    .btn-outline{ background:#fff; color:#0b7660; border:1px solid #a7e1da }

    /* items */
    .item-row { display: grid; grid-template-columns: 1.2fr 1.2fr .7fr .6fr auto; gap: 10px; margin-top: 10px; align-items: center }
    .item-row.single{grid-template-columns: 1.2fr 1.2fr .7fr .6fr auto}
    .item-actions{display:flex;justify-content:flex-end}

    /* Edit panel */
    .edit-panel {background:#f9fbfb;border:1px solid #e0efef;border-radius:14px;padding:16px;margin-top:16px}
    .chips{ margin-top:8px }
    .chip{display:inline-block;padding:6px 10px;border-radius:20px;border:1px solid #cde;cursor:pointer;background:#fff;margin:4px 6px 0 0;font-size:13px}
    .chip.active{background:#0b7660;color:#fff;border-color:#0b7660}
    .card{border:1px solid var(--line);padding:12px;border-radius:12px;margin:8px 0;display:flex;justify-content:space-between;gap:12px}
    .card .left{min-width:0}
    /* ‚ñº ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£/‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
#editRecordList .card{ font-size:14px; }
#editRecordList .card .left strong{ font-size:14px; font-weight:700; }
#editRecordList .items-list{ font-size:14px; margin:4px 0 0; padding-left:18px; }
#editRecordList .items-list li{ margin:0; line-height:1.35; } /* ‡∏ï‡πà‡∏≠‡πÜ‡∏Å‡∏±‡∏ô ‡∏ä‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô */
#editRecordList .total-line{ margin-top:6px; font-weight:700; color:#0b7660; font-size:14px; }

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ */
#editRecordList .actions .btn{ font-size:13px; padding:8px 12px; }


    /* Review table */
    table{ width:100%; border-collapse: collapse; margin-top:8px }
    th, td{ border:1px solid var(--line); padding:8px; font-size:13px; vertical-align:top }
    thead tr{ background:#f8fafc }
    .actions{ display:flex; gap:6px; justify-content:center }

    /* Toggle (‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÑ‡∏î‡πâ) */
    .toggle{
      position: relative; display: inline-grid; grid-template-columns: 1fr 1fr;
      align-items:center; width: 160px; height: 38px; border:1px solid #a7e1da;
      border-radius: 999px; background: transparent; overflow:hidden; user-select:none;
    }
    .toggle span{
      text-align:center; font-weight:700; font-size:14px; z-index:2;
      color:#0b7660; padding:0 4px;
    }
    .toggle .knob{
      position:absolute; top:2px; bottom:2px; width: calc(50% - 4px);
      background: rgba(13,148,136,.18); border:1px solid rgba(13,148,136,.35);
      border-radius: 999px; z-index:1; transition: transform .18s ease;
      transform: translateX(2px); /* default = ‡∏ã‡πâ‡∏≤‡∏¢ */
    }
    .toggle[data-side="right"] .knob{ transform: translateX(calc(100% + 2px)); }
    .toggle input{ display:none }
    .toggle[data-side="left"] span:first-child{ color:#064e3b; font-weight:800 }
    .toggle[data-side="right"] span:last-child{ color:#064e3b; font-weight:800 }

    /* amount row: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
    .amount-row input{ flex:1; min-width:0 }
    .amount-row .toggle{ flex: none; }

    /* center primary actions */
    .center-actions{ display:flex; justify-content:center; gap:10px; margin-top:12px }
    .center-actions .btn{ min-width:180px }

    @media (max-width:700px){
      .field-row{grid-template-columns:130px 1fr}
      .item-row, .item-row.single{grid-template-columns:1fr}
      .item-actions{justify-content:flex-start}
      .toggle{ width: 150px; height: 36px }
    }

    /* floating dock (unchanged) */
    .floating-toggle{position:fixed;bottom:env(safe-area-inset-bottom,18px);left:50%;transform:translateX(-50%);background:rgba(0,128,128,0);width:58px;height:58px;border-radius:50%;box-shadow:0 4px 16px rgba(251,251,251,0);display:flex;justify-content:center;align-items:center;z-index:1000;cursor:pointer}
    .floating-menu{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:#fff;border-radius:16px;padding:10px;display:none;flex-direction:column;align-items:center;gap:10px;box-shadow:0 6px 20px rgba(0,0,0,.2);z-index:999;max-height:60vh;overflow-y:auto}
    .floating-menu a img{width:52px;height:52px}
  </style>
</head>
<body>
  <div class="container">
    <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>

    <!-- üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏° (‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢) -->
    <div id="editSection" class="edit-panel">
      <div class="section-title">üõ†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°</div>
      <p class="section-sub">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏Ç OPD (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å) ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
      <div class="field-row">
        <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ OPD</label>
        <div class="row nowrap">
          <input type="text" id="editOPD" class="grow"
                 placeholder="‡πÄ‡∏ä‡πà‡∏ô 0007"
                 inputmode="numeric" pattern="\\d{4}" maxlength="4"
                 oninput="digitsOnly(this)">
          <button type="button" class="btn btn-outline" onclick="loadDatesByOPD()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </div>
      </div>
      <div id="editDateButtons" class="chips" style="margin-top:12px;"></div>
      <div id="editRecordList" style="margin-top:12px;"></div>
    </div>

    <!-- üìù ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
    <form id="saleForm" onsubmit="return false;">
      <input type="hidden" id="currentId" value="">

      <div class="section-title">üßæ ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>

      <div class="field-row">
        <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <input type="date" id="date" name="date">
      </div>

      <div class="field-row">
        <label for="opd">‡πÄ‡∏•‡∏Ç OPD</label>
        <div class="row nowrap">
          <input
            type="text" id="opd" name="opd" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç OPD 4 ‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô 0001"
            inputmode="numeric" maxlength="4" pattern="\\d{4}"
            oninput="onOPDInput(this);" class="grow">
          <span class="pill">‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å</span>
        </div>
      </div>

      <div class="field-row">
        <label for="name">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô-‡∏à‡∏£‡∏¥‡∏á</label>
        <div class="row nowrap">
          <input type="text" id="name" name="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ö‡∏ß‡πå - ‡πÄ‡∏°‡∏•‡∏î‡∏≤" disabled class="grow">
          <span id="lockNameBadge" class="pill" style="display:none;">üîí ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å</span>
        </div>
      </div>

      <div class="field-row">
        <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
        <div class="row nowrap">
          <input type="tel" id="phone" name="phone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0912345678" disabled class="grow">
          <span id="lockPhoneBadge" class="pill" style="display:none;">üîí ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å</span>
        </div>
      </div>

      <div class="section-title">üß¥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>
      <div id="itemList"></div>
      <div class="row" style="margin-top:8px">
        <button type="button" class="btn btn-outline" onclick="addItemRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      </div>

      <!-- ‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏¥‡∏î) -->
      <div class="field-row">
        <label>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</label>
        <div class="row nowrap">
          <div id="sumToggle" class="toggle" role="switch" aria-checked="false" tabindex="0" data-side="left"
               onclick="toggleSum()" onkeydown="toggleSumKey(event)">
            <span>‡∏õ‡∏¥‡∏î</span><span>‡πÄ‡∏õ‡∏¥‡∏î</span>
            <div class="knob"></div>
            <input type="hidden" id="sumHidden" value="‡∏õ‡∏¥‡∏î">
          </div>
        </div>
      </div>

      <!-- ‚úÖ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° + ‡πÇ‡∏≠‡∏ô/‡∏™‡∏î ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô -->
      <div class="field-row">
        <label for="amount">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</label>
        <div class="row nowrap amount-row">
          <input type="number" id="amount" name="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)" step="0.01" min="0" class="grow">
          <div id="payToggle" class="toggle" role="switch" aria-checked="true" tabindex="0" data-side="left"
               onclick="togglePayment()" onkeydown="togglePaymentKey(event)">
            <span>‡πÇ‡∏≠‡∏ô</span><span>‡∏™‡∏î</span>
            <div class="knob"></div>
            <input type="hidden" id="paymentHidden" value="‡πÇ‡∏≠‡∏ô">
          </div>
        </div>
      </div>

      <div class="field-row">
        <label for="note">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea id="note" name="note" rows="2" placeholder=""></textarea>
      </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ -->
      <div class="center-actions">
        <button type="button" id="btnReview" class="btn btn-primary" onclick="reviewForm()" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ)</button>
        <button type="button" class="btn btn-ghost" onclick="clearForm()">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      </div>
    </form>

    <div id="reviewSection" style="margin-top:16px;">
      <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
    </div>
    <div class="center-actions">
      <button class="btn btn-save" id="btnSaveAll" onclick="saveAllRecords()" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // ---------- Static data ----------
    const subOptionsMap = {
      "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": ["Aestox 50 u", "Aestox 100 u", "Allergan 50 u", "Allergan 100 u", "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î", "‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß", "Nabota"],
      "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥", "Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á", "E.P.T.Q ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢", "Restylane ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢"],
      "Fat/Hifu": ["Bromi", "Sisi", "HIFU", "HIFU ‡πÅ‡∏ñ‡∏°"],
      "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": [
        "Meso Chanel", "P - Cell", "Aquatic", "Hestina", "Exosome", "Rejuran",
        "Belotero Revive", "Sculptra", "Juvelook", "Aesthefill",
        "PRP", "Mesowink", "‡∏™‡∏∞‡∏Å‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "Alphaarbutin", "Transamine", "Biocollagen"
      ],
      "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster"],
      "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": ["‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤", "‡∏ú‡∏•‡∏±‡∏Å‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô", "‡∏õ‡∏±‡πà‡∏ô RF", "‡∏Å‡∏î‡∏™‡∏¥‡∏ß", "subcision‡∏™‡∏¥‡∏ß"],
      "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": [
        "‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤", "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤",
        "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÑ‡∏´‡∏° PDO", "‡πÑ‡∏´‡∏° Collagen",
        "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô/‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏™‡∏•‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå", "PRP‡∏ú‡∏°", "‡∏à‡∏µ‡πâ‡πÑ‡∏ù"
      ],
      "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©": []
    };

    // ---------- State ----------
    let records = [];                 // pending to save
    let customerMap = {};             // opd -> {name, phone}
    let currentEditId = null;         // id of record being edited (if any)
    let editDataByOPD = [];           // cache for edit list

    // ---------- Prefill customers ----------
    fetch('/api/customers').then(r=>r.json()).then(data=>{
      (data||[]).forEach(c=>{
        if(c.opd){ customerMap[c.opd] = {name:c.name||'', phone:c.phone||''}; }
      });
    }).catch(()=>{});

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', () => {
      initFirstRow();
      initDateToday();
      // Enter ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      const ipt = document.getElementById('editOPD');
      if (ipt) {
        ipt.addEventListener('keydown', (e)=>{
          if (e.key === 'Enter') { e.preventDefault(); loadDatesByOPD(); }
        });
      }
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å (‡πÅ‡∏ï‡πà default ‡∏õ‡∏¥‡∏î ‚Üí ‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏±‡∏ö amount)
      recalcAmount();
    });

    // ---------- UI helpers ----------
    function digitsOnly(el){ el.value = (el.value || '').replace(/\D/g,'').slice(0,4); }
    function isValidOPD(opd){ return /^\d{4}$/.test(opd||''); }

    function onOPDInput(el){
      digitsOnly(el);
      document.getElementById('btnReview').disabled = !isValidOPD(el.value);

      const nameEl = document.getElementById('name');
      const phoneEl = document.getElementById('phone');
      const lockName = document.getElementById('lockNameBadge');
      const lockPhone = document.getElementById('lockPhoneBadge');

      if(!isValidOPD(el.value)){
        nameEl.value=''; phoneEl.value='';
        nameEl.disabled = true; phoneEl.disabled = true;
        nameEl.readOnly = false; phoneEl.readOnly = false;
        lockName.style.display='none'; lockPhone.style.display='none';
        return;
      }

      const opd = el.value;
      const c = customerMap[opd];
      if(c){
        nameEl.value = c.name||''; phoneEl.value = c.phone||'';
        nameEl.disabled = true; phoneEl.disabled = true;
        nameEl.readOnly = true; phoneEl.readOnly = true;
        lockName.style.display='inline-flex'; lockPhone.style.display='inline-flex';
      }else{
        nameEl.disabled = false; phoneEl.disabled = false;
        nameEl.readOnly = false; phoneEl.readOnly = false;
        lockName.style.display='none'; lockPhone.style.display='none';
      }
    }

    /* ----- Toggle utilities ----- */
    function setToggle(el, side){ // side: 'left'|'right'
      el.setAttribute('data-side', side);
      el.setAttribute('aria-checked', side==='right' ? 'true':'false');
    }

    // Payment toggle
    function getPayment(){ return document.getElementById('paymentHidden').value || '‡πÇ‡∏≠‡∏ô'; }
    function setPayment(val){
      const toggle = document.getElementById('payToggle');
      const hidden = document.getElementById('paymentHidden');
      if(val === '‡∏™‡∏î'){ setToggle(toggle, 'right'); hidden.value = '‡∏™‡∏î'; }
      else { setToggle(toggle, 'left'); hidden.value = '‡πÇ‡∏≠‡∏ô'; }
    }
    function togglePayment(){
      const cur = getPayment();
      setPayment(cur === '‡πÇ‡∏≠‡∏ô' ? '‡∏™‡∏î' : '‡πÇ‡∏≠‡∏ô');
    }
    function togglePaymentKey(e){
      if([' ','Enter','ArrowLeft','ArrowRight'].includes(e.key)){
        e.preventDefault();
        if(e.key==='ArrowLeft'){ setPayment('‡πÇ‡∏≠‡∏ô'); }
        else if(e.key==='ArrowRight'){ setPayment('‡∏™‡∏î'); }
        else { togglePayment(); }
      }
    }

    // Sum toggle (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏¥‡∏î)
    function getSumState(){ return document.getElementById('sumHidden').value || '‡∏õ‡∏¥‡∏î'; }
    function setSumState(val){
      const toggle = document.getElementById('sumToggle');
      const hidden = document.getElementById('sumHidden');
      if(val === '‡πÄ‡∏õ‡∏¥‡∏î'){ setToggle(toggle, 'right'); hidden.value = '‡πÄ‡∏õ‡∏¥‡∏î'; recalcAmount(); }
      else { setToggle(toggle, 'left'); hidden.value = '‡∏õ‡∏¥‡∏î'; }
    }
    function toggleSum(){
      const cur = getSumState();
      setSumState(cur === '‡πÄ‡∏õ‡∏¥‡∏î' ? '‡∏õ‡∏¥‡∏î' : '‡πÄ‡∏õ‡∏¥‡∏î');
    }
    function toggleSumKey(e){
      if([' ','Enter','ArrowLeft','ArrowRight'].includes(e.key)){
        e.preventDefault();
        if(e.key==='ArrowLeft'){ setSumState('‡∏õ‡∏¥‡∏î'); }
        else if(e.key==='ArrowRight'){ setSumState('‡πÄ‡∏õ‡∏¥‡∏î'); }
        else { toggleSum(); }
      }
    }

    function updateSubOptions(itemSelect, subSelect){
      const selected = itemSelect.value;
      if(selected === '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©'){
        const allOptions = Object.entries(subOptionsMap)
          .filter(([k])=>k!== '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©')
          .flatMap(([_,v])=>v);
        subSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>' +
          [...new Set(allOptions)].map(opt=>`<option value="${opt}">${opt}</option>`).join('');
        return;
      }
      const options = subOptionsMap[selected] || [];
      subSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>' +
        options.map(opt=>`<option value="${opt}">${opt}</option>`).join('');
    }

    function makeItemRow(){
      const row = document.createElement('div');
      row.className = 'item-row single';
      row.innerHTML = `
        <select name="item[]" onchange="updateSubOptions(this, this.nextElementSibling)">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å --</option>
          ${Object.keys(subOptionsMap).map(k=>`<option value="${k}">${k}</option>`).join('')}
        </select>
        <select name="subitem[]"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option></select>
        <input type="number" name="price[]" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" step="0.01" min="0" oninput="recalcAmount()">
        <input type="number" name="qty[]" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" step="1" min="1" oninput="recalcAmount()">
        <div class="item-actions">
          <button type="button" class="btn btn-ghost" onclick="removeItemRow(this)">‡∏•‡∏ö</button>
        </div>
      `;
      return row;
    }

    function initFirstRow(){
      const list = document.getElementById('itemList');
      list.innerHTML = '';
      list.appendChild(makeItemRow());
      // toggle defaults
      setPayment('‡πÇ‡∏≠‡∏ô');
      setSumState('‡∏õ‡∏¥‡∏î'); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏¥‡∏î
    }

    function addItemRow(){
      const list = document.getElementById('itemList');
      list.appendChild(makeItemRow());
    }

    function removeItemRow(btn){
      const row = btn.closest('.item-row');
      const list = document.getElementById('itemList');
      if(list.children.length>1){
        row.remove();
        recalcAmount();
      }
    }

    function initDateToday(){
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      document.getElementById('date').value = `${d.getFullYear()}-${mm}-${dd}`;
    }

    function formatDate(dateStr){ if(!dateStr) return ''; const [y,m,d] = dateStr.split('-'); return `${d}/${m}/${y.slice(-2)}`; }

    // ----- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏° -----
    function loadDatesByOPD(){
      const raw = (document.getElementById('editOPD').value||'').trim();
      if(!isValidOPD(raw)) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
      const opd = raw;

      const list = document.getElementById('editRecordList');
      const dateBtns = document.getElementById('editDateButtons');
      dateBtns.innerHTML = '';
      list.innerHTML = '<div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>';

      fetch(`/api/sales?opd=${encodeURIComponent(opd)}`)
        .then(r=> r.ok ? r.json() : Promise.reject())
        .then(data=>{
          editDataByOPD = data || [];
          if(editDataByOPD.length===0){
            dateBtns.innerHTML = '';
            list.innerHTML = '<div class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á OPD ‡∏ô‡∏µ‡πâ</div>';
            return;
          }
          const dates = [...new Set(editDataByOPD.map(r=> (r.date||'').slice(0,10)))].sort((a,b)=> new Date(b)-new Date(a));
          dateBtns.innerHTML = 'üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:<br>' + dates.map((d,i)=>(
            `<span class="chip ${i===0?'active':''}" data-date="${d}" onclick="selectEditDateChip(this)">${formatDate(d)}</span>`
          )).join('');
          showEditList(dates[0]);
        })
        .catch(()=> { list.innerHTML = '<div class="muted">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>'; });
    }

    function selectEditDateChip(el){
      document.querySelectorAll('#editDateButtons .chip').forEach(c=> c.classList.remove('active'));
      el.classList.add('active');
      showEditList(el.getAttribute('data-date'));
    }

   function showEditList(date){
  const list = document.getElementById('editRecordList');
  const rows = editDataByOPD.filter(r => (r.date||'').slice(0,10) === date);
  if(rows.length === 0){
    list.innerHTML = '<div class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
    return;
  }

  // ‡∏•‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏ï‡∏£‡∏¥‡∏á  " - N ‡∏ä‡∏¥‡πâ‡∏ô x P ‡∏ö‡∏≤‡∏ó"
  const stripPrice = (s) => String(s).replace(/ - \d+(?:\.\d+)? ‡∏ä‡∏¥‡πâ‡∏ô x \d+(?:\.\d+)? ‡∏ö‡∏≤‡∏ó$/, '');
  // ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ r.amount
  const sumFromItems = (items=[]) => items.reduce((acc, line)=>{
    const m = String(line).match(/ - (\d+(?:\.\d+)?) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+(?:\.\d+)?) ‡∏ö‡∏≤‡∏ó$/);
    if(!m) return acc;
    const qty = parseFloat(m[1]||'0');
    const price = parseFloat(m[2]||'0');
    return acc + (qty*price);
  }, 0);

  const html = rows.map(r => {
    const items = Array.isArray(r.items) ? r.items : [];
    const cleanList = items.length
      ? `<ul class="items-list">${items.map(x => `<li>${safe(stripPrice(x))}</li>`).join('')}</ul>`
      : '<div class="muted">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>';

    // ‡πÉ‡∏ä‡πâ r.amount ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å items
    const total = (r.amount != null && r.amount !== '') ? Number(r.amount) : sumFromItems(items);
    const totalStr = Number.isFinite(total) ? total.toLocaleString() : '0';

    return `
      <div class="card">
        <div class="left">
          <div><strong>${safe(r.name || '-')}</strong></div>
          ${cleanList}
          <div class="total-line">‡∏£‡∏ß‡∏°: ${totalStr} ‡∏ö‡∏≤‡∏ó</div>
        </div>
        <div class="actions">
          <button type="button" class="btn btn-primary" onclick="editSelectedRecordById('${r.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button type="button" class="btn btn-danger" onclick="deleteRecordFromSupabase('${r.id}')">‡∏•‡∏ö</button>
        </div>
      </div>
    `;
  }).join('');

  list.innerHTML = html;
}



    function findRecordInEditCacheById(id){
      return (editDataByOPD || []).find(x => String(x.id) === String(id)) || null;
    }
    function editSelectedRecordById(id){
      const rec = findRecordInEditCacheById(id);
      if(!rec) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
      currentEditId = rec.id || null;
      document.getElementById('currentId').value = currentEditId || '';
      editRecordFromObject(rec);
      records = [];
      renderReviewSection();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function editRecordFromObject(rec){
      document.getElementById('date').value = (rec.date||'').slice(0,10);

      const opdEl = document.getElementById('opd');
      opdEl.value = (rec.opd||'').slice(0,4);
      onOPDInput(opdEl);

      if(!customerMap[opdEl.value]){
        document.getElementById('name').value = rec.name || '';
        document.getElementById('phone').value = rec.phone || '';
      }

      document.getElementById('amount').value = rec.amount || '';
      setPayment(rec.payment === '‡∏™‡∏î' ? '‡∏™‡∏î' : '‡πÇ‡∏≠‡∏ô');
      setSumState('‡∏õ‡∏¥‡∏î'); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      document.getElementById('note').value = rec.note || '';

      const list = document.getElementById('itemList');
      list.innerHTML = '';
      if((rec.items||[]).length === 0){
        list.appendChild(makeItemRow());
      }else{
        (rec.items||[]).forEach(line => {
          const row = makeItemRow();
          const m = String(line).match(/^(.*?) ?(?:\((.*?)\))? - (\d+(?:\.\d+)?) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+(?:\.\d+)?) ‡∏ö‡∏≤‡∏ó/);
          const itemSel = row.querySelector('select[name="item[]"]');
          const subSel  = row.querySelector('select[name="subitem[]"]');
          if(m){
            const main = (m[1]||'').trim();
            const sub = m[2]||'';
            const qty = m[3]||'';
            const price = m[4]||'';
            itemSel.value = main;
            updateSubOptions(itemSel, subSel);
            subSel.value = sub;
            row.querySelector('input[name="qty[]"]').value = qty;
            row.querySelector('input[name="price[]"]').value = price;
          }else{
            const plain = String(line).trim();
            const main = plain.split('(')[0].split('-')[0].trim();
            itemSel.value = main;
            updateSubOptions(itemSel, subSel);
          }
          list.appendChild(row);
        });
      }
      recalcAmount();
    }

    // ----- Review / Save -----
    function reviewForm(){
      const opdVal = (document.getElementById('opd').value||'').trim();
      if(!isValidOPD(opdVal)){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }

      const date = (document.getElementById('date').value||'').slice(0,10);
      const opd  = opdVal;
      const name = document.getElementById('name').value||'';
      const phone = document.getElementById('phone').value||'';
      const amount = document.getElementById('amount').value||'';
      const payment = getPayment();
      const note = document.getElementById('note').value||'';

      const itemNames = document.querySelectorAll('select[name="item[]"]');
      const itemSubs  = document.querySelectorAll('select[name="subitem[]"]');
      const itemPrices= document.querySelectorAll('input[name="price[]"]');
      const itemQtys  = document.querySelectorAll('input[name="qty[]"]');

      const items = [];
      for(let i=0;i<itemNames.length;i++){
        const main = (itemNames[i].value||'').trim();
        const sub  = (itemSubs[i].value||'').trim();
        const qty  = itemQtys[i].value;
        const priceRaw = itemPrices[i].value;
        const priceNum = Number(priceRaw==='' ? 0 : priceRaw);
        if(main && qty){
          const label = sub ? `${main} (${sub})` : main;
          const priceStr = Number.isInteger(priceNum) ? priceNum.toString() : priceNum.toFixed(2);
          items.push(`${label} - ${qty} ‡∏ä‡∏¥‡πâ‡∏ô x ${priceStr} ‡∏ö‡∏≤‡∏ó`);
        }
      }

      const rec = { date, opd, name, phone, amount, payment, note, items };
      if(currentEditId){ rec.id = currentEditId; }

      records.push(rec);
      renderReviewSection();
      validateSaveAllReady();

      // reset form (‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤ date & opd)
      const keepDate = date; const keepOPD = opd;
      document.getElementById('saleForm').reset();
      document.getElementById('date').value = keepDate;
      document.getElementById('opd').value = keepOPD;
      onOPDInput(document.getElementById('opd'));
      initFirstRow();
      currentEditId = null;
      document.getElementById('currentId').value = '';
      recalcAmount();
    }

    function renderReviewSection(){
      const section = document.getElementById('reviewSection');
      section.innerHTML = '<h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>';

      const grouped = {};
      records.forEach((r,idx)=>{ const d=r.date||''; (grouped[d]||(grouped[d]=[])).push({...r, _idx: idx}); });

      Object.entries(grouped).sort(([a],[b])=> new Date(b)-new Date(a)).forEach(([date, list])=>{
        const dayTotal = list.reduce((s,r)=> s + (parseFloat(r.amount)||0), 0);
        const container = document.createElement('div'); container.style.marginBottom='24px';
        const header = document.createElement('h4'); header.textContent = `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDate(date)} ‚Äî ‡∏£‡∏ß‡∏° ${dayTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`; container.appendChild(header);

        const rowsHtml = list.map((r,i)=>{
          const itemsHtml = (r.items||[]).map(x=>`<li>${safe(x)}</li>`).join('');
          return `<tr>
            <td>${i+1}</td>
            <td><div><strong>${safe(r.name||'-')}</strong></div><div class="muted">OPD: ${safe(r.opd)}</div></td>
            <td>${safe(r.phone||'-')}</td>
            <td><ul style='margin:0;padding-left:16px;'>${itemsHtml || '<span class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>'}</ul></td>
            <td>${safe(r.amount||0)} ‡∏ö‡∏≤‡∏ó (${safe(r.payment)})${r.note?`<div class='muted'>üìù ${safe(r.note)}</div>`:''}</td>
            <td style="text-align:center;">
              <div class="actions">
                <button type="button" class="btn btn-primary"
                  onclick="editRecordFromObject(records[${r._idx}]); currentEditId = records[${r._idx}].id || null; document.getElementById('currentId').value=currentEditId||'';">
                  ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteRecord(${r._idx})">‡∏•‡∏ö</button>
              </div>
            </td>
          </tr>`;
        }).join('');

        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr>
              <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠</th>
              <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
              <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th>‡∏¢‡∏≠‡∏î</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>`;
        container.appendChild(table);
        section.appendChild(container);
      });
    }

    function deleteRecord(idx){
      if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?')) return;
      records.splice(idx,1);
      renderReviewSection();
      validateSaveAllReady();
    }

    function validateSaveAllReady(){
      const ok = records.length>0 && records.every(r=> isValidOPD(r.opd));
      document.getElementById('btnSaveAll').disabled = !ok;
    }

    function saveAllRecords(){
      if(records.length===0) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß');
      if(!records.every(r=> isValidOPD(r.opd))){
        alert('‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà OPD ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        return;
      }
      if(!confirm('‚ú® ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')) return;
      fetch('/api/save_sales', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(records)
      })
      .then(r=>r.json())
      .then(data=>{
        if(data && (data.message||'').includes('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')){
          alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ${data.updated||0} / ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ${data.inserted||0}`);
          records = []; renderReviewSection(); validateSaveAllReady();
          clearForm();
        }else{
          alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
      })
      .catch(err=>{ console.error(err); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'); });
    }

    function deleteRecordFromSupabase(id){
      if(!id) return; if(!confirm('‚ùå ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      fetch('/api/delete_sales_record', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({id})
      })
      .then(r=>r.json()).then(()=>{ alert('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); loadDatesByOPD(); })
      .catch(()=> alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
    }

    // ----- Auto-sum -----
    function recalcAmount(){
      if(getSumState() !== '‡πÄ‡∏õ‡∏¥‡∏î') return; // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î
      const prices = document.querySelectorAll('input[name="price[]"]');
      const qtys   = document.querySelectorAll('input[name="qty[]"]');
      let total = 0;
      for(let i=0;i<prices.length;i++){
        const p = Number(prices[i].value==='' ? 0 : prices[i].value);
        const q = Number(qtys[i].value||0);
        total += p*q;
      }
      document.getElementById('amount').value = (Number.isInteger(total)? total : total.toFixed(2));
    }

    function clearForm(){
      document.getElementById('saleForm').reset();
      initDateToday();
      initFirstRow();
      onOPDInput(document.getElementById('opd')); // lock/unlock name/phone
      document.getElementById('btnReview').disabled = true;
      recalcAmount();
    }

    function safe(v){
      const map = {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
      return (v==null?'':String(v)).replace(/[&<>"']/g, s=>map[s]);
    }
  </script>

  <!-- floating menu (unchanged) -->
  <div id="floatingToggle" class="floating-toggle" onclick="toggleFloatingMenu()">
    <img src="{{ url_for('static', filename='icon/icon_menu_toggle.png') }}" alt="menu" style="width:60px;height:60px;">
  </div>
  <div id="floatingMenu" class="floating-menu">
    <a href="{{ url_for('dashboard') }}"><img src="{{ url_for('static', filename='icon/icon_dashboard.png') }}"></a>
    <a href="{{ url_for('sale_summary') }}"><img src="{{ url_for('static', filename='icon/icon_sale_summary.png') }}"></a>
    <a href="{{ url_for('record_sales') }}"><img src="{{ url_for('static', filename='icon/icon_record_sales.png') }}"></a>
    <a href="{{ url_for('customer_list') }}"><img src="{{ url_for('static', filename='icon/icon_customer_list.png') }}"></a>
    <a href="{{ url_for('record_customer') }}"><img src="{{ url_for('static', filename='icon/icon_customer_history.png') }}"></a>
    <a href="{{ url_for('oldsaledata') }}"><img src="{{ url_for('static', filename='icon/icon_old_customers.png') }}"></a>
    <a href="{{ url_for('inventory') }}"><img src="{{ url_for('static', filename='icon/icon_inventory.png') }}"></a>
    <a href="#"><img src="{{ url_for('static', filename='icon/icon_staff.png') }}"></a>
    <a href="#"><img src="{{ url_for('static', filename='icon/icon_appointments.png') }}"></a>
  </div>
  <script>
    function toggleFloatingMenu(){
      const menu = document.getElementById('floatingMenu');
      menu.style.display = (menu.style.display==='flex')?'none':'flex';
    }
    document.addEventListener('click', function(e){
      const t=document.getElementById('floatingToggle');
      const m=document.getElementById('floatingMenu');
      if(t && m && !t.contains(e.target) && !m.contains(e.target)){ m.style.display='none'; }
    });
  </script>
</body>
</html>
