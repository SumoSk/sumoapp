<!DOCTYPE html>
<html lang="th">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta charset="UTF-8" />
<title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Prompt', 'Segoe UI', sans-serif;
    margin: 0;
    background-color: white;
    padding: 10px;
    padding-bottom: 120px;
    font-size: 14px;
  }

  .menu-bar {
    display: flex;
    justify-content: space-around;
    background-color: white;
    padding: 10px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }
  .menu-bar a { text-decoration: none; font-weight: bold; color: teal; }

  .month-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .month-nav button {
    background-color: #009688; color: white; border: none;
    padding: 8px 16px; font-size: 14px; border-radius: 8px;
    cursor: pointer; transition: background-color 0.2s ease;
  }
  .month-nav button:hover { background-color: #00796b; }
  .month-nav input[type="month"]{
    padding: 6px 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;
  }
  .month-nav .sep{opacity:.7}

  #mainTitle {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background-color: #e0f2f1; border-radius: 16px; padding: 20px 30px;
    margin: 0 auto 30px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    max-width: fit-content; text-align: center;
    cursor: pointer; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ */
  }
  #mainTitle .month { font-size: 26px; font-weight: 600; color: #004d40; }
  #mainTitle .total { font-size: 18px; color: #009688; margin-top: 6px; }

  .top10-box {
    max-width: 1200px; margin: 0 auto 20px; background: #fff; padding: 15px 20px;
    border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.06);
  }
  .top10-box h3 { margin-top: 0; color: teal; font-size: 18px; text-align: center; }
  .top10-box ul { list-style: none; padding-left: 0; }
  .top10-box li { margin-bottom: 6px; padding: 4px 0; border-bottom: 1px dashed #ddd; white-space: nowrap; }
  .top10-box li span.name { font-weight: 600; color: #333; }
  .top10-box li span.date { font-size: 13px; color: #999; margin-left: 6px; }
  .top10-box li span.amount { float: right; color: #009688; font-weight: 600; white-space: nowrap; font-variant-numeric: tabular-nums; }

  @media (max-width: 768px) {
    .top10-box li span.date { font-size: 8px !important; }
  }

  .chart-summary-row {
    display: flex; justify-content: space-between; align-items: flex-start;
    gap: 20px; max-width: 1200px; margin: 0 auto 20px; flex-wrap: wrap;
  }
  .chart-container {
    flex: 1; background: #fff; padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.06);
  }
  canvas { width: 100% !important; height: 300px !important; }

  .summary-list {
    flex: 1; background: #fff; padding: 15px 20px; border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06); font-size: 14px;
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;
  }
  .summary-group ul { list-style: none; padding-left: 0px; margin: 5px 0 10px; }
  .summary-group li { margin-bottom: 4px; }
  .summary-group strong { color: #00796b; display: block; margin-bottom: 6px; font-size: 15px; }

  .floating-dock {
    position: fixed; bottom: env(safe-area-inset-bottom, 16px); left: 50%; transform: translateX(-50%);
    background: white; border-radius: 16px; padding: 6px 6px env(safe-area-inset-bottom, 16px);
    display: flex; gap: 6px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); z-index: 1000; max-width: 95vw;
  }
  .icon-button { width: 64px; height: 64px; padding: 4px; border-radius: 12px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease; text-decoration: none; flex: 0 0 auto; }
  .icon-button img { width: 60px; height: 60px; object-fit: contain; }
  .icon-button:hover { transform: scale(1.1); }

  .inline-field { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; max-width: 600px; }
  .inline-field label { min-width: 160px; font-weight: bold; font-size: 14px; color: #333; }
  .inline-field .input-pair { display: flex; gap: 6px; align-items: center; }
  .inline-field input, .inline-field select { padding: 6px 8px; font-size: 13px; width: 120px; border: 1px solid #ccc; border-radius: 6px; max-width: 100%; }
  button[type="button"] { background-color: teal; color: white; border: none; padding: 6px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; margin-top: 10px; }

  @media (max-width: 768px) {
    .inline-field { flex-direction: column; align-items: flex-start; max-width: 100%; }
    .inline-field label { min-width: unset; }
    .inline-field input, .inline-field select { width: auto; min-width: 100px; max-width: 100%; }
    .inline-field .input-pair { flex-direction: row; width: 100%; }
  }

  .add-product-button {
    background-color: #e0f7fa; color: #00796b; border: 1px solid #00bfa5;
    padding: 6px 14px; font-size: 13px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;
  }
  .add-product-button:hover { background-color: #b2dfdb; color: #004d40; transform: scale(1.03); }

  .floating-toggle {
    position: fixed; bottom: env(safe-area-inset-bottom, 18px); left: 50%; transform: translateX(-50%);
    background: rgba(0, 128, 128, 0); width: 58px; height: 58px; border-radius: 50%;
    box-shadow: 0 4px 16px rgba(251, 251, 251, 0); display: flex; justify-content: center; align-items: center; z-index: 1000; cursor: pointer;
  }
  .floating-menu {
    position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
    background: white; border-radius: 16px; padding: 10px; display: none; flex-direction: column; align-items: center; gap: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.2); z-index: 999; max-height: 60vh; overflow-y: auto;
  }
  .floating-menu a img { width: 52px; height: 52px; }

  @media (max-width: 768px) {
    body { font-size: 10px; }
    #mainTitle .month { font-size: 14px; }
    #mainTitle .total, #mainTitle .compare { font-size: 10px; }
    .summary-list { font-size: 10px; grid-template-columns: repeat(4, 1fr); }
    .summary-group strong { font-size: 10px; }
    .top10-box h3 { font-size: 12px; }
    .top10-box li span.name, .top10-box li span.date, .top10-box li span.amount { font-size: 10px; }
    .inline-field label, .inline-field input, .inline-field select { font-size: 10px; }
    .add-product-button { font-size: 10px; padding: 4px 8px; }
    #customer-modal > div { font-size: 10px !important; }
    .icon-button { width: 48px; height: 48px; }
    .icon-button img { width: 48px; height: 48px; }
    .chart-summary-row { flex-direction: column; }
  }

  @media (max-width: 1024px) {
    .floating-dock { bottom: 0; padding-bottom: env(safe-area-inset-bottom); }
  }

  #mainTitle .compare { font-size: 13px; }
  @media (max-width: 768px) { #mainTitle .compare { font-size: 10px; } }

  .filter-section {
    max-width: 650px; margin: auto; padding: 20px; background: #fefefe; border: 1px solid #ddd; border-radius: 12px; font-size: 14px;
  }
  h3 { margin-top: 0; color: #00695c; margin-bottom: 20px; font-size: 16px; }

  .product-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; flex-wrap: wrap; }
  .inline-field { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 12px; }
  .inline-field label { min-width: 180px; font-weight: bold; font-size: 14px; color: #333; }
  .input-pair { display: flex; gap: 6px; align-items: center; }
  .input-pair input { padding: 6px 8px; font-size: 13px; width: 120px; max-width: 100%; border: 1px solid #ccc; border-radius: 6px; }
  .product-list-container { margin-bottom: 16px; }
  .search-button { background-color: teal; color: white; border: none; padding: 8px 20px; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 12px; }
  .search-button:hover { background-color: #00796b; }

  @media (max-width: 768px) {
    .inline-field { flex-direction: column; align-items: flex-start; }
    .inline-field label { min-width: unset; }
    .input-pair { width: 100%; }
    .input-pair input { width: 100%; }
    .product-row { flex-direction: column; align-items: flex-start; }
  }
  @media (max-width: 768px) {
    body { font-size: 10px; }
    .filter-section, .inline-field label, .inline-field input, .inline-field select, .add-product-button, .search-button, .input-pair input { font-size: 10px !important; }
    h3 { font-size: 11px !important; }
  }
  @media (max-width: 768px) {
    #filterResults, #filterResults div, #filterResults strong, #filterResults span { font-size: 10px !important; }
  }
  .inline-field input[type="text"] { padding: 6px 8px; font-size: 13px; width: 240px; max-width: 100%; border: 1px solid #ccc; border-radius: 6px; }
  @media (max-width: 768px) { .inline-field input[type="text"] { font-size: 10px !important; } }
  @media (max-width: 480px) { #customer-modal > div { max-width: 94vw !important; padding: 12px !important; } }

  .group-header {
    font-size: 18px; color: #004d40; font-weight: bold; margin-bottom: 20px;
    text-align: center; background: #e0f2f1; padding: 10px 16px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }
  .customer-entry { padding: 12px 16px; background: #f9f9f9; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
  .customer-name { font-size: 15px; color: #00695c; margin-bottom: 6px; }
  .date-info { font-size: 13px; color: #444; display: flex; flex-wrap: wrap; gap: 8px; }
  .date-box { background: #e0f7fa; color: #004d40; padding: 4px 8px; border-radius: 8px; font-size: 13px; white-space: nowrap; border: 1px solid #b2dfdb; }

  #customer-modal-box {
    width: auto; max-width: 90vw; max-height: 90vh; font-size: 13.5px; padding: 16px; border-radius: 16px;
    overflow: auto; background: white; box-sizing: border-box;
  }
  #customer-modal {
    display: flex; justify-content: center; align-items: center; padding: 16px;
  }

  /* ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô */
.month-nav {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.month-nav button {
  background-color: #009688;
  color: #fff;
  border: none;
  padding: 8px 14px;
  font-size: 13px;
  border-radius: 10px;
  cursor: pointer;
  transition: background-color .2s ease, transform .05s ease;
  white-space: nowrap;
}
.month-nav button:hover { background-color: #00796b; }
.month-nav button:active { transform: translateY(1px); }
#openRangeBtn { background-color: #00897b; }
#clearRangeBtn { background-color: #607d8b; }
#clearRangeBtn:hover { background-color: #546e7a; }

/* ===== Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ===== */
.range-modal { position: fixed; inset: 0; z-index: 1200; display: none; }
.range-modal__backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.45); }
.range-modal__panel {
  position: absolute; left: 50%; top: 50%;
  transform: translate(-50%, -50%);
  width: min(92vw, 420px);
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 12px 30px rgba(0,0,0,.18);
  overflow: hidden;
  display: flex; flex-direction: column;
}
.range-modal__header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 14px; background: #e0f2f1; font-weight: 600; color: #004d40;
}
.range-modal__close {
  background: transparent; border: none; font-size: 18px;
  cursor: pointer; color: #004d40;
}
.range-modal__body { display: grid; gap: 12px; padding: 14px; }
.range-modal__body label { display: grid; gap: 6px; font-size: 13px; color: #335; }
.range-modal__body input[type="month"]{
  -webkit-appearance: none; appearance: none;
  width: 100%; padding: 8px 10px; font-size: 14px;
  border: 1px solid #cfe7e5; border-radius: 10px; background: #fff;
}
.range-modal__footer {
  display: flex; justify-content: flex-end; gap: 8px; padding: 12px 14px;
  border-top: 1px solid #eee;
}
.btn-primary, .btn-secondary {
  border: none; padding: 8px 14px; border-radius: 10px; font-size: 13px; cursor: pointer;
}
.btn-primary { background: #009688; color: #fff; }
.btn-primary:hover { background: #00796b; }
.btn-secondary { background: #eceff1; color: #37474f; }
.btn-secondary:hover { background: #e0e3e6; }

/* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞ modal ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô */
@media (max-width: 768px){
  .month-nav { gap: 6px; margin-bottom: 12px; }
  .month-nav button { padding: 7px 12px; font-size: 12px; border-radius: 9px; }
  .range-modal__panel { width: min(94vw, 380px); }
  .range-modal__body input[type="month"]{ font-size: 13px; padding: 7px 10px; }
}

/* ===== ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏ô popup ===== */
.table-mini { width:100%; border-collapse:collapse; font-size:13px; }
.table-mini th, .table-mini td { padding:6px 8px; border-bottom:1px dashed #e0e0e0; text-align:right; }
.table-mini th:first-child, .table-mini td:first-child { text-align:left; }
.badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#e0f2f1; color:#004d40; font-size:12px; }

/* === ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÇ‡∏ó‡∏£‡∏Å‡πà‡∏≠‡∏ô (Lead Score) === */
.lead-score-box {
  max-width: 1200px;
  margin: 0 auto 20px;
  background: #fff;
  padding: 15px 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}
.lead-score-box h3 {
  margin-top: 0;
  color: teal;
  font-size: 18px;
  text-align: center;
}
.lead-score-sub {
  text-align: center;
  font-size: 12px;
  color: #64748b;
  margin-top: 4px;
  margin-bottom: 10px;
}
#leadScoreList {
  list-style: none;
  padding-left: 0;
  margin: 0;
}
#leadScoreList li {
  padding: 6px 0;
  border-bottom: 1px dashed #e5e7eb;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 6px;
}
.lead-name {
  font-weight: 600;
  color: #00695c;
  cursor: pointer;
}
.lead-score-badge {
  background: #e0f2f1;
  color: #004d40;
  border-radius: 999px;
  padding: 2px 10px;
  font-size: 12px;
  font-weight: 600;
}
.lead-score-meta {
  font-size: 12px;
  color: #4b5563;
  flex: 1 1 auto;   /* ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏•‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
  white-space: normal;
}
.lead-absent {
  color: #dc2626;
  font-weight: 600;
}
.lead-money {
  font-weight: 600;
  color: #009688;
  margin-left: auto;
  font-variant-numeric: tabular-nums;
}
@media (max-width: 768px) {
  .lead-score-box h3 { font-size: 14px; }
  .lead-score-sub,
  .lead-score-meta,
  .lead-score-badge,
  #leadScoreList li { font-size: 10px; }
}

</style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- (legacy) ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ -->
<div id="group-modal-legacy" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
  <div id="group-modal-content-legacy" style="background:#fff; padding:20px; border-radius:10px; max-height:80vh; overflow:auto; width:90%; max-width:500px;">
    <div id="groupSelectedList-legacy"></div>
    <div style="text-align:right; margin-top:20px;">
      <button onclick="closeGroupModal()" style="padding:6px 12px;">‚ùå ‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>

<div id="customer-modal" style="display:none;position:fixed;inset:0;background-color:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;">
  <div id="customer-modal-box" style="background:white;padding:16px;border-radius:16px;width:auto;max-width:90vw;box-sizing:border-box;margin:auto;max-height:90vh;overflow:auto;position:relative; font-size:13.5px;">
    <button onclick="closeCustomerModal()" style="position:absolute;top:10px;right:14px;font-size:20px;border:none;background:none;cursor:pointer;">&times;</button>
    <div id="modal-content"></div>
  </div>
</div>

<div class="month-nav">
  <button onclick="changeMonth(-1)">‚Üê ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏≤‡∏á 2 ‡∏õ‡∏∏‡πà‡∏° -->
  <button id="openRangeBtn" onclick="openRangeModal()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
  <button id="clearRangeBtn" onclick="clearRange()">‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á</button>

  <button onclick="changeMonth(1)">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
</div>

<!-- Popup ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
<div id="rangeModal" class="range-modal" style="display:none;">
  <div class="range-modal__backdrop" onclick="closeRangeModal()"></div>
  <div class="range-modal__panel">
    <div class="range-modal__header">
      <div>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
      <button class="range-modal__close" onclick="closeRangeModal()">‚úï</button>
    </div>
    <div class="range-modal__body">
      <label>
        ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        <input type="month" id="rangeStartModal">
      </label>
      <label>
        ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
        <input type="month" id="rangeEndModal">
      </label>
    </div>
    <div class="range-modal__footer">
      <button class="btn-secondary" onclick="closeRangeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn-primary" onclick="applyRangeFromModal()">‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>
  </div>
</div>

<div id="mainTitle">
  <div class="month"></div>
  <div class="total"></div>
  <div class="compare" style="margin-top: 6px;"></div>
</div>

<div class="top10-box">
  <h3>Top 10 ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
  <ul id="top10List"></ul>
  <p id="totalCustomer" onclick="toggleCustomerList()" style="text-align:center; margin-top: 10px; font-weight: bold; color: teal; cursor: pointer;"></p>
  <ul id="allCustomerList" style="display:none; padding-top: 10px;"></ul>
</div>

<div class="chart-summary-row">
  <div class="summary-list" id="summaryList"></div>
</div>

<!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÇ‡∏ó‡∏£‡∏Å‡πà‡∏≠‡∏ô ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -->
<div class="lead-score-box">
  <h3>üìû ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ï‡∏≤‡∏°‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
  <div class="lead-score-sub">
    ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏π‡∏à‡∏≤‡∏Å <b>= ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° + ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á + ‡∏ö‡∏¥‡∏•‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢) + ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ô‡∏≤‡∏ô (‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ä‡πà‡∏ß‡∏á 46‚Äì120 ‡∏ß‡∏±‡∏ô) ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤ 45 ‡∏ß‡∏±‡∏ô</b><br>
    
  </div>
  <ul id="leadScoreList">
    <!-- JS ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á -->
  </ul>
</div>

<!-- Modal ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° -->
<div id="group-modal" style="display:none;position:fixed;inset:0;background-color:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;">
  <div id="group-modal-content" style="background:white;padding:20px;border-radius:16px;width:95%;max-width:700px;max-height:90vh;overflow:auto;position:relative; font-size:13px;">
    <div style="position:absolute; top:10px; right:10px; display:flex; gap:10px;">
      <button onclick="saveGroupModalAsImage()" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" style="background:white; border:none; border-radius:50%; width:36px; height:36px; box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer; display:flex; align-items:center; justify-content:center;">üíæ</button>
      <button onclick="closeGroupModal()" title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á" style="background:white; border:none; border-radius:50%; width:36px; height:36px; box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer; display:flex; align-items:center; justify-content:center;">‚ùå</button>
    </div>
    <div style="margin-top: 20px;" id="groupSelectedList"></div>
  </div>
</div>

<script>
  // ===== Helpers / State =====
  function formatYM(d){const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');return `${y}-${m}`;}
  const dateYM = (s)=> s.slice(0,7);
  const ymNum = (ym)=>{const[a,b]=ym.split('-').map(Number);return a*100+b;}

  let viewingDate = new Date();     // ‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏î‡∏¥‡∏°)
  let allSalesRecords = [];
  let allCustomerRecords = [];
  let fullCustomerList = [];
async function fetchLatestPitchForOPD(opd) {
  if (!opd || opd === '-') return null;

  try {
    const url = `/api/salepitch/latest?opd=${encodeURIComponent(opd)}`;
    console.log('üîç Fetch pitch:', url);
    const res = await fetch(url);

    if (!res.ok) {
      console.warn('‚ùå salepitch not OK:', res.status);
      return null;
    }

    const data = await res.json();
    console.log('‚úÖ pitch raw data for', opd, data);

    // ‡∏ñ‡πâ‡∏≤ backend ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å
    const obj = Array.isArray(data) ? data[0] : data;

    if (!obj) return null;

    // üîß ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: map key ‡∏à‡∏≤‡∏Å backend ‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠
    return {
      date:   obj.date || obj.call_date || obj.created_at,  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á
      outcome: obj.outcome || obj.result || obj.summary || '',
      content: obj.content || obj.note || ''
    };
  } catch (err) {
    console.error('fetchLatestPitchForOPD error', err);
    return null;
  }
}

// cache ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sale pitch (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÇ‡∏ó‡∏£)
const leadPitchCache = new Map();

async function fetchLatestPitchForOPD(opd){
  if(!opd) return null;
  if(leadPitchCache.has(opd)) return leadPitchCache.get(opd);
  try{
    const r = await fetch(`/api/pitches?opd=${encodeURIComponent(opd)}`);
    if(!r.ok){ 
      leadPitchCache.set(opd, null);
      return null;
    }
    const arr = await r.json() || [];
    // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ backend ‡πÑ‡∏°‡πà sort ‡πÉ‡∏´‡πâ
    arr.sort((a,b) => String(b.created_at||'').localeCompare(String(a.created_at||'')));
    const top = arr[0];
    const latest = top ? {
      date: top.created_at,
      outcome: top.outcome || '',
      content: top.content || ''
    } : null;
    leadPitchCache.set(opd, latest);
    return latest;
  }catch(e){
    console.error('fetchLatestPitchForOPD error', e);
    leadPitchCache.set(opd, null);
    return null;
  }
}


  // ‡πÇ‡∏´‡∏°‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  const monthRange = { enabled:false, startYM:null, endYM:null };

  // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢ filter(r => r.date.startsWith(prefix))
  function activeFilter(r){
    if (monthRange.enabled){
      const ym = dateYM(r.date);
      return ymNum(ym) >= ymNum(monthRange.startYM) && ymNum(ym) <= ymNum(monthRange.endYM);
    }
    return r.date.startsWith(formatYM(viewingDate));
  }

  function applyRange(){
    const s = document.getElementById('rangeStart').value;
    const e = document.getElementById('rangeEnd').value;
    if(!s || !e){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'); return; }
    if(ymNum(s) > ymNum(e)){ alert('‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'); return; }
    monthRange.enabled = true; monthRange.startYM = s; monthRange.endYM = e;
    fetchDataAndUpdate();
  }
  function clearRange(){
    monthRange.enabled = false; monthRange.startYM = monthRange.endYM = null;
    fetchDataAndUpdate();
  }

  function changeMonth(delta) {
    viewingDate.setMonth(viewingDate.getMonth() + delta);
    monthRange.enabled = false; // ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    fetchDataAndUpdate();
    refreshCustomerList();
  }

  function fetchAllCustomerRecords() {
    return fetch("/api/sales")
      .then(res => res.json())
      .then(records => { allCustomerRecords = records; })
      .catch(err => { console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err); });
  }

  function fetchDataAndUpdate() {
    if (allSalesRecords.length > 0 && allCustomerRecords.length > 0) {
      updateDashboard(allSalesRecords);
    } else {
      Promise.all([
        fetch("/api/sales").then(res => res.json()),
        fetchAllCustomerRecords()
      ]).then(([salesRecords]) => {
        allSalesRecords = salesRecords;
        updateDashboard(allSalesRecords);
      }).catch(err => {
        console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      });
    }
  }

  function updateDashboard(records) {
    const compareEl = document.querySelector('#mainTitle .compare');
    compareEl.innerHTML = ''; // reset

    // ===== ‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á =====
    if (monthRange.enabled){
      const [sy, sm] = monthRange.startYM.split('-').map(Number);
      const [ey, em] = monthRange.endYM.split('-').map(Number);
      const startText = new Date(sy, sm-1, 1).toLocaleString('th-TH',{month:'long'}) + ' ' + (sy+543);
      const endText   = new Date(ey, em-1, 1).toLocaleString('th-TH',{month:'long'}) + ' ' + (ey+543);
      document.querySelector('#mainTitle .month').textContent = `${startText} ‚Äì ${endText}`;
    } else {
      const monthName = viewingDate.toLocaleString('th-TH', { month: 'long' });
      const yearBE = viewingDate.getFullYear() + 543;
      document.querySelector('#mainTitle .month').textContent = `${monthName} ${yearBE}`;
    }

    // ===== ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° + ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô) =====
    let totalSales = 0;
    if (monthRange.enabled){
      records.filter(activeFilter).forEach(r => totalSales += parseFloat(r.amount || 0));
      document.querySelector('#mainTitle .total').innerHTML = `üí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° ${totalSales.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
      compareEl.innerHTML = `<span style="color:gray;">‡πÇ‡∏´‡∏°‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`;
    } else {
      const today = new Date();
      const todayDate = Math.min(today.getDate(), daysInMonth(viewingDate.getFullYear(), viewingDate.getMonth()+1));

      const currentPrefix = formatYM(viewingDate);
      const prev = new Date(viewingDate); prev.setMonth(viewingDate.getMonth() - 1);
      const lastPrefix = formatYM(prev);

      let lastMonthSales = 0, toDateSales = 0, toDateLastMonthSales = 0;

      records.forEach(r => {
        const amt = parseFloat(r.amount||0);
        if (r.date.startsWith(currentPrefix)){
          totalSales += amt;
          const d = parseInt(r.date.split('-')[2]); if (d <= todayDate) toDateSales += amt;
        }
        if (r.date.startsWith(lastPrefix)){
          lastMonthSales += amt;
          const d = parseInt(r.date.split('-')[2]); if (d <= todayDate) toDateLastMonthSales += amt;
        }
      });

      document.querySelector('#mainTitle .total').innerHTML = `üí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° ${totalSales.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

      let diff = totalSales - lastMonthSales;
      let text = diff > 0
        ? `<span style="color: green;">+${diff.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`
        : diff < 0
          ? `<span style="color: red;">-${Math.abs(diff).toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`
          : `<span style="color: gray;">‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`;

      diff = toDateSales - toDateLastMonthSales;
      let text2 = diff > 0
        ? `<span style="color: green;">üìÜ ‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ${todayDate} ‡∏ß‡∏±‡∏ô : +${diff.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`
        : diff < 0
          ? `<span style="color: red;">üìÜ ‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ${todayDate} ‡∏ß‡∏±‡∏ô: -${Math.abs(diff).toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`
          : `<span style="color: gray;">üìÜ ‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ${todayDate} ‡∏ß‡∏±‡∏ô: ‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`;
      compareEl.innerHTML = `${text}<br>${text2}`;

      // ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 1‚Äìn ‡∏ß‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏î‡∏µ ‡πÜ
      const allDates = records.map(r => r.date).filter(Boolean);
      const latestDate = allDates.sort().reverse()[0];
      if (latestDate){
        const targetRangeEnd = todayDate;
        const monthlyTotalMap = {};
        records.forEach(r => {
          const [y,m] = r.date.split("-");
          const ym = `${y}-${m}`;
          if (!monthlyTotalMap[ym]) monthlyTotalMap[ym] = 0;
          monthlyTotalMap[ym] += parseFloat(r.amount || 0);
        });
        const VALID_MONTH_THRESHOLD = 400000;
        const qualifiedMonths = Object.entries(monthlyTotalMap)
          .filter(([m,total]) => m !== currentPrefix && total >= VALID_MONTH_THRESHOLD)
          .map(([m]) => m);

        const rangeTotals = {};
        records.forEach(r => {
          const [y,m,d] = r.date.split("-");
          const ym = `${y}-${m}`;
          if (!qualifiedMonths.includes(ym)) return;
          if (parseInt(d) <= targetRangeEnd) {
            if (!rangeTotals[ym]) rangeTotals[ym] = 0;
            rangeTotals[ym] += parseFloat(r.amount || 0);
          }
        });
        const totalPast = Object.values(rangeTotals).reduce((s,v)=>s+v,0);
        const averagePast = Math.round(totalPast / (Object.keys(rangeTotals).length || 1));
        const currentMonthN = toDateSales;
        const diffFromAvg = currentMonthN - averagePast;

        const compareAvgDiv = document.createElement('div');
        compareAvgDiv.style.marginTop = '4px';
        compareAvgDiv.style.color = diffFromAvg > 0 ? 'green' : diffFromAvg < 0 ? 'crimson' : 'gray';
        compareAvgDiv.innerHTML =
          `üìä ‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ${targetRangeEnd} ‡∏ß‡∏±‡∏ô ‡∏Ñ‡∏∑‡∏≠: ${currentMonthN.toLocaleString()} ‡∏ö‡∏≤‡∏ó ${
            diffFromAvg > 0 ? `‚úÖ ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ +${diffFromAvg.toLocaleString()} ‡∏ö‡∏≤‡∏ó (${averagePast.toLocaleString()})` :
            diffFromAvg < 0 ? `‚ö†Ô∏è ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${Math.abs(diffFromAvg).toLocaleString()} ‡∏ö‡∏≤‡∏ó (${averagePast.toLocaleString()})` :
            `üòê ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (${averagePast.toLocaleString()} ‡∏ö‡∏≤‡∏ó)`}`;
        compareEl.appendChild(compareAvgDiv);
      }

      // ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ / ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ (‡∏≠‡∏¥‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
      let todaySales = 0, weekSales = 0;
      const todayObj = new Date();
      const dow = todayObj.getDay();
      const curM = viewingDate.getMonth(), curY = viewingDate.getFullYear();
      let monday = new Date(todayObj); monday.setDate(todayObj.getDate() - ((dow + 6) % 7));
      if (monday.getMonth() !== curM) monday = new Date(curY, curM, 1);
      const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);

      records.forEach(r => {
        const rd = new Date(r.date);
        const amt = parseFloat(r.amount || 0);
        const sameDate = rd.getFullYear()===todayObj.getFullYear() && rd.getMonth()===todayObj.getMonth() && rd.getDate()===todayObj.getDate();
        if (sameDate) todaySales += amt;

        const inCurrentMonth = rd.getMonth()===curM && rd.getFullYear()===curY;
        if (rd >= monday && rd <= sunday && inCurrentMonth) weekSales += amt;
      });

      const extraInfo = document.createElement("div");
      extraInfo.style.marginTop = "6px"; extraInfo.style.fontSize = "10px"; extraInfo.style.color = "green";
      extraInfo.innerHTML = `<span style="color: green; font-size: 10px;"> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ${todaySales.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ (${monday.getDate()}‚Äì${sunday.getDate()}): ${weekSales.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>`;
      compareEl.appendChild(extraInfo);
    }

    // ===== ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏´‡∏°‡∏ß‡∏î / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å =====
    const categoryCounts = {}, categoryDetails = {}, customerMap = {};
    records.filter(activeFilter).forEach(r => {
      const key = `${r.name}|${r.phone}`;
      if (!customerMap[key]) customerMap[key] = { name:r.name, phone:r.phone, opd:r.opd||'-', date:r.date, amount:0 };
      customerMap[key].amount += parseFloat(r.amount||0);
      if (r.date > customerMap[key].date) customerMap[key].date = r.date;

      (r.items || []).forEach(item => {
        const match = item.match(/\((.*?)\)/);
        const subItem = match ? match[1] : item;
        const qtyMatch = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+)/);
        const qty = qtyMatch ? parseInt(qtyMatch[1]) : 0;
        const categoryMatch = item.match(/^(.+?) ?\(/);
        const category = categoryMatch ? categoryMatch[1].trim() : "‡∏≠‡∏∑‡πà‡∏ô‡πÜ";

        if (!categoryCounts[category]) categoryCounts[category] = 0;
        if (!categoryDetails[category]) categoryDetails[category] = {};
        categoryCounts[category] += qty;
        (categoryDetails[category][subItem] ||= { qty:0, total:0 }).qty += qty;
      });
    });

    // ‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏°‡∏ß‡∏î
    const sortedEntries = Object.entries(categoryCounts).sort((a,b)=>b[1]-a[1]);
    document.getElementById('summaryList').innerHTML = sortedEntries.map(([cat]) => {
      const items = Object.entries(categoryDetails[cat] || {}).map(([sub, d]) => `‚Ä¢ ${sub} ${d.qty}`).join('<br>');
      const sumQty = categoryCounts[cat];
      return `
        <div class="summary-group" style="cursor:pointer;" onclick="openGroupModalByCategory('${cat}')">
          <strong>${cat}</strong> ‡∏£‡∏ß‡∏° ${sumQty} ‡∏ä‡∏¥‡πâ‡∏ô
          <ul>${items}</ul>
        </div>`;
    }).join('');
   // ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏°‡∏ß‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß -> ‡∏™‡∏£‡πâ‡∏≤‡∏á list ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÇ‡∏ó‡∏£‡∏Å‡πà‡∏≠‡∏ô
if (typeof window.buildLeadScoreList === 'function') {
  window.buildLeadScoreList();
}
    // Top 10
    const top10 = Object.values(customerMap).sort((a,b)=>b.amount-a.amount).slice(0,10);
    document.getElementById('top10List').innerHTML = top10.map((c) => {
      const key = `${c.name}|${c.phone}`;
      const allRec = allCustomerRecords.filter(r => `${r.name}|${r.phone}` === key);

      const totalVisits = allRec.length;
      const paid = allRec.filter(r => parseFloat(r.amount||0) > 0);
      const paidVisits = paid.length;
      const totalAmount = paid.reduce((s,r)=>s+parseFloat(r.amount),0);
      const avg = paidVisits>0 ? Math.round(totalAmount/paidVisits) : 0;

      const latest = allRec.length? new Date(Math.max(...allRec.map(r=>new Date(r.date)))):null;
      const daysSinceLastVisit = latest? Math.floor((new Date()-latest)/(1000*60*60*24)) : null;

      let absentColor = 'gray';
      if (daysSinceLastVisit < 30) absentColor = 'green';
      else if (daysSinceLastVisit <= 90) absentColor = 'orange';
      else absentColor = 'crimson';

      let totalColor='gray', totalExtra='', totalIcon='';
      if (totalAmount < 50000) totalColor='crimson';
      else if (totalAmount <= 99999) totalColor='green';
      else if (totalAmount <= 200000) totalColor='goldenrod';
      else { totalColor='#8B6508'; totalExtra='font-weight:bold;'; totalIcon=' üíé'; }

      let avgColor='gray';
      if (avg < 5000) avgColor='crimson';
      else if (avg <= 9999) avgColor='green';
      else avgColor='#b8860b';

      const lastVisitText = daysSinceLastVisit != null
        ? `<span style="color:${absentColor};">üîö ‡πÑ‡∏°‡πà‡∏°‡∏≤ ${daysSinceLastVisit} ‡∏ß‡∏±‡∏ô</span>` : `<span>üîö ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>`;

      const isNewCustomer = monthRange.enabled
        ? allRec.filter(r => ymNum(dateYM(r.date)) < ymNum(monthRange.startYM)).length === 0
        : allRec.filter(r => r.date < `${formatYM(viewingDate)}-01`).length === 0;
      const newBadge = isNewCustomer ? `<span style="color:red; font-weight:bold;"> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</span>` : "";

      return `
      <li style="margin-bottom: 8px;">
        <span class="name" style="cursor:pointer;" onclick="openCustomerModal('${key}')">${c.name}${newBadge}</span>
        <span class="date">
          (üí≥ <span style="color:${avgColor};">${avg.toLocaleString()}</span> √ó ${totalVisits}
           | üí∞ <span style="color:${totalColor}; ${totalExtra}">${totalAmount.toLocaleString()}${totalIcon}</span>
           | ${lastVisitText})
        </span>
        <span class="amount">${c.amount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
      </li>`;
    }).join('');

    document.getElementById('totalCustomer').textContent =
      `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${Object.keys(customerMap).length} ‡∏Ñ‡∏ô (‡∏Å‡∏î‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)`;
  }

  fetchDataAndUpdate();
  fetchAllCustomerRecords();

  // === ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î popup ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ===
  document.getElementById('mainTitle').addEventListener('click', openMonthlySalesPopup);

  // ===== ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î (modal) =====
  function openGroupModalByCategory(cat) {
    const summary = {};
    const totalQty = { count: 0 };

    const catElement = Array.from(document.querySelectorAll(".summary-group"))
      .find(group => group.querySelector("strong")?.textContent === cat);
    const catText = catElement?.innerText || "";

    allSalesRecords.filter(activeFilter).forEach(r => {
      (r.items || []).forEach(item => {
        const match = item.match(/\((.*?)\)/);
        const subItem = match ? match[1] : item.split(" - ")[0].trim();

        const qtyMatch = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
        const qty = qtyMatch ? parseInt(qtyMatch[1]) : 1;

        if (!catText.includes(subItem) && !catText.includes(item)) return;

        if (!summary[subItem]) summary[subItem] = {};
        const key = `${r.name}|${r.phone}`;
        if (!summary[subItem][key]) summary[subItem][key] = { name: r.name, dates: {} };
        summary[subItem][key].dates[r.date] = (summary[subItem][key].dates[r.date] || 0) + qty;

        totalQty.count += qty;
      });
    });

    const html = Object.entries(summary).map(([productName, buyers]) => {
      const buyerLines = Object.values(buyers).map(c => {
        const dateParts = Object.entries(c.dates)
          .sort(([a],[b]) => a.localeCompare(b))
          .map(([date, qty]) => {
            const thDate = new Date(date).toLocaleDateString('th-TH',{ day:'numeric', month:'short' });
            return `${thDate} = ${qty}`;
          }).join(" | ");
        return `üë§ <strong>${c.name}</strong>: ${dateParts}`;
      }).join("<br>");

      return `<div style="margin-bottom:15px;">
        <div style="font-weight:bold; color:#00796b; margin-bottom:5px;">üîπ ${productName}</div>
        <div>${buyerLines}</div>
      </div>`;
    }).join("");

    document.getElementById("groupSelectedList").innerHTML = `
      <div class="group-header">
        üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î: ${cat}<br>
        ‚úÖ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong style="font-size: 18px; color: #00796b;">${totalQty.count}</strong> ‡∏ä‡∏¥‡πâ‡∏ô
      </div>
      ${html || '<div style="padding:10px; color:#888;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</div>'}
    `;
    document.getElementById("group-modal").style.display = "flex";
  }
  function closeGroupModal() { document.getElementById("group-modal").style.display = "none"; }
  document.getElementById("group-modal").addEventListener("click", function (e) {
    const content = document.getElementById("group-modal-content");
    if (!content.contains(e.target)) closeGroupModal();
  });
  function saveGroupModalAsImage() {
    const node = document.getElementById("group-modal-content");
    if (!node) return;
    html2canvas(node, { scale: 2 }).then(canvas => {
      const a = document.createElement("a");
      a.download = 'group-summary.jpg';
      a.href = canvas.toDataURL("image/jpeg", 0.95);
      a.click();
    });
  }

  // ===== ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° =====
  function toggleCustomerList() {
    const listEl = document.getElementById("allCustomerList");

    if (listEl.style.display === "none") {
      listEl.style.display = "block";
      const customerMap = {};
      allSalesRecords.filter(activeFilter).forEach(r => {
        const key = `${r.name}|${r.phone}`;
        if (!customerMap[key]) customerMap[key] = { name:r.name, phone:r.phone, opd:r.opd||"-", date:r.date, amount:0 };
        customerMap[key].amount += parseFloat(r.amount || 0);
        if (r.date > customerMap[key].date) customerMap[key].date = r.date;
      });

      const customerList = Object.values(customerMap).sort((a,b)=>b.amount-a.amount).slice(10);

      listEl.innerHTML = customerList.map((c, i) => {
        const key = `${c.name}|${c.phone}`;
        const allRec = allCustomerRecords.filter(r => `${r.name}|${r.phone}` === key);

        const totalVisits = allRec.length;
        const paid = allRec.filter(r => parseFloat(r.amount||0) > 0);
        const paidVisits = paid.length;
        const totalAmount = paid.reduce((s,r)=>s+parseFloat(r.amount),0);
        const avg = paidVisits>0 ? Math.round(totalAmount/paidVisits) : 0;

        const latest = allRec.length? new Date(Math.max(...allRec.map(r=>new Date(r.date)))):null;
        const daysSinceLastVisit = latest? Math.floor((new Date()-latest)/(1000*60*60*24)) : null;

        let absentColor='gray';
        if (daysSinceLastVisit < 30) absentColor='green';
        else if (daysSinceLastVisit <= 90) absentColor='orange';
        else absentColor='crimson';

        let totalColor='gray', totalExtra='', totalIcon='';
        if (totalAmount < 50000) totalColor='crimson';
        else if (totalAmount <= 99999) totalColor='green';
        else if (totalAmount <= 200000) totalColor='goldenrod';
        else { totalColor='#8B6508'; totalExtra='font-weight:bold;'; totalIcon=' üíé'; }

        let avgColor='gray';
        if (avg < 5000) avgColor='crimson';
        else if (avg <= 9999) avgColor='green';
        else avgColor='#b8860b';

        const lastVisitText = daysSinceLastVisit != null
          ? `<span style="color:${absentColor};">üîö ‡πÑ‡∏°‡πà‡∏°‡∏≤ ${daysSinceLastVisit} ‡∏ß‡∏±‡∏ô</span>` : `<span>üîö ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>`;

        const isNewCustomer = monthRange.enabled
          ? allRec.filter(r => ymNum(dateYM(r.date)) < ymNum(monthRange.startYM)).length === 0
          : allRec.filter(r => r.date < `${formatYM(viewingDate)}-01`).length === 0;
        const newBadge = isNewCustomer ? `<span style="color:red; font-weight:bold;"> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</span>` : "";

        return `
        <li style="margin-bottom: 8px;">
          <span class="name" style="cursor:pointer;" onclick="openCustomerModal('${key}')">${i+11}. ${c.name}${newBadge}</span>
          <span class="date">
            (üí≥ <span style="color:${avgColor};">${avg.toLocaleString()}</span> √ó ${totalVisits}
             | üí∞ <span style="color:${totalColor}; ${totalExtra}">${totalAmount.toLocaleString()}${totalIcon}</span>
             | ${lastVisitText})
          </span>
          <span class="amount">${c.amount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
        </li>`;
      }).join('');
    } else {
      listEl.style.display = "none";
    }
  }
  function refreshCustomerList(){ const listEl = document.getElementById("allCustomerList"); if(listEl.style.display==="block"){ listEl.style.display="none"; toggleCustomerList(); } }
  function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }

  // ===== Modal ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ =====
  function escapeHTML(s=''){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) );}
  function closeCustomerModal(){ document.getElementById("customer-modal").style.display = "none"; }
  function formatDate(d){ if(!d) return ''; const [y,m,day]=d.split('-'); return `${day}/${m}/${y.slice(-2)}`; }

  async function openCustomerModal(key) {
  // key ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "name|phone"
  const [name, phone = ''] = String(key).split('|');
  const norm = s => (s || '').trim().toLowerCase();

  // ‡πÉ‡∏ä‡πâ allCustomerRecords (‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å /api/sales ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô)
  const records = allCustomerRecords.filter(r =>
    norm(r.name) === norm(name) &&
    norm(r.phone || '') === norm(phone)
  );

  if (!records.length) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ');
    return;
  }

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ö‡∏¥‡∏• ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î
  records.sort((a, b) => b.date.localeCompare(a.date));

  const customer = {
    name: records[0].name,
    phone: records[0].phone || '-',
    opd: records[0].opd || '-'
  };

  const lastDateStr = (records[0].date || '').slice(0, 10);
  const baseDate = new Date();
  const lastDate = new Date(lastDateStr);
  const daysAbsent = isNaN(lastDate)
    ? 0
    : Math.floor((baseDate - lastDate) / (1000 * 60 * 60 * 24));

  const totalVisits = records.length;

  // ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å amount ‡∏ï‡∏£‡∏á ‡πÜ
  const paidRecords = records.filter(r => parseFloat(r.amount || 0) > 0);
  const paidVisits = paidRecords.length;
  const totalAmount = paidRecords.reduce((s, r) => s + parseFloat(r.amount || 0), 0);
  const average = paidVisits > 0 ? Math.round(totalAmount / paidVisits) : 0;

  // ‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î
  const allItems = {};
  records.forEach(r => {
    (r.items || []).forEach(item => {
      let n = item;
      const m = item.match(/\((.*?)\)/);
      n = m ? m[1] : item.split(' - ')[0];

      const q = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
      const qty = q ? parseInt(q[1]) : 1;

      allItems[n] = (allItems[n] || 0) + qty;
    });
  });

  const categoryMap = {
    "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": ["Aestox 50 u","Aestox 100 u","Allergan 50 u","Allergan 100 u","‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î","‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß","Nabota"],
    "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥","Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á","E.P.T.Q ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢","Restylane ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢"],
    "Fat/Hifu": ["Bromi","Sisi","HIFU","HIFU ‡πÅ‡∏ñ‡∏°"],
    "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": [
      "Meso Chanel","P - Cell","Aquatic","Hestina","Exosome","Rejuran",
      "Belotero Revive","Sculptra","Juvelook","Aesthefill",
      "PRP","Mesowink","‡∏™‡∏∞‡∏Å‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™","Alphaarbutin","Transamine","Biocollagen"
    ],
    "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White","Super Aurawhite","Vitamin Mix","Brain Booster","Energy Booster"],
    "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": [
      "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™","‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß","‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤",
      "‡∏ú‡∏•‡∏±‡∏Å‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô","‡∏õ‡∏±‡πà‡∏ô RF","‡∏Å‡∏î‡∏™‡∏¥‡∏ß","subcision‡∏™‡∏¥‡∏ß"
    ],
    "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": [
      "‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤","‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤","‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤",
      "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤","‡πÑ‡∏´‡∏° PDO","‡πÑ‡∏´‡∏° Collagen",
      "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô/‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤","‡∏™‡∏•‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå","PRP‡∏ú‡∏°","‡∏à‡∏µ‡πâ‡πÑ‡∏ù"
    ],
    "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©": []
  };

  const categorizedItems = {};
  for (const [cat, names] of Object.entries(categoryMap)) {
    names.forEach(n => {
      if (allItems[n]) {
        (categorizedItems[cat] ||= []).push(`${escapeHTML(n)} : ${allItems[n]}`);
        delete allItems[n];
      }
    });
  }
  if (Object.keys(allItems).length) {
    (categorizedItems["‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] ||= []).push(
      ...Object.entries(allItems).map(([n, q]) => `${escapeHTML(n)} : ${q}`)
    );
  }

  const itemSummary = Object.entries(categorizedItems)
    .map(([cat, items]) => `
      <div style="margin-bottom:4px;">
        <strong>${escapeHTML(cat)}</strong>: ${items.join(" | ")}
      </div>
    `).join("");

  // ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
  const historyHtml = records.map(r => {
    const items = (r.items || []).map(item => {
      const m = item.match(/\((.*?)\)/);
      const name = m ? m[1] : item.split(" - ")[0];
      const q = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
      const qty = q ? parseInt(q[1]) : 1;
      return `<li>${escapeHTML(name)} : ${qty}</li>`;
    }).join("");

    const noteText = r.note
      ? `<div style="font-size:11px; margin-top:2px; font-style:italic; color:#444;">
           üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${escapeHTML(r.note)}
         </div>`
      : "";

    return `
      <div style="margin-bottom:14px;">
        <div style="font-weight:600; font-size:12px;">
          üìÖ ${formatDate((r.date || '').slice(0,10))}
        </div>
        <ul style="padding-left:16px; margin:0; font-size:11px;">${items}</ul>
        <div style="margin-top:4px; color:#0a645a; font-size:11px;">
          üíµ ${Math.round(parseFloat(r.amount || 0)).toLocaleString()} ‡∏ö‡∏≤‡∏ó
        </div>
        ${noteText}
        <hr style="margin:8px auto; border:0; border-top:1px dashed #ddd; width:60%;">
      </div>
    `;
  }).join("");

  // ==== Sale Pitch ‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô: ‡∏ß‡∏±‡∏ô‡∏¢‡πà‡∏≠ ‚Äî ‡πÇ‡∏õ‡∏£ ‚Äî Outcome (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ö‡∏ô‡∏™‡∏∏‡∏î) ====
  let pitchSectionHtml = '';

  try {
    const opd = customer.opd && customer.opd !== '-' ? customer.opd : '';
    if (opd) {
      const res = await fetch(`/api/pitches?opd=${encodeURIComponent(opd)}`);
      if (res.ok) {
        const pitches = await res.json() || [];

        if (pitches.length) {
          pitches.sort((a,b)=> String(b.created_at||'').localeCompare(String(a.created_at||'')));

          pitchSectionHtml = pitches.map(p => {
            const d = formatDate(String(p.created_at || '').slice(0,10)); // dd/mm/yy
            return `
              <div style="padding:2px 0; font-size:11px; color:#374151;">
                ${d} ‚Äî ${escapeHTML(p.promotion || '-')} ‚Äî ${escapeHTML(p.outcome || '-')}
              </div>`;
          }).join("");
        } else {
          pitchSectionHtml = `<div class="sub-muted" style="font-size:11px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sale Pitch</div>`;
        }
      } else {
        pitchSectionHtml = `<div class="sub-muted" style="font-size:11px;">‡πÇ‡∏´‡∏•‡∏î Sale Pitch ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`;
      }
    } else {
      pitchSectionHtml = `<div class="sub-muted" style="font-size:11px;">‡πÑ‡∏°‡πà‡∏°‡∏µ OPD ‡∏à‡∏∂‡∏á‡∏î‡∏∂‡∏á Sale Pitch ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>`;
    }
  } catch (e) {
    console.error(e);
    pitchSectionHtml = `<div class="sub-muted" style="font-size:11px;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Sale Pitch</div>`;
  }

  const daysAbsentText = `<span style="color:red;">(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß: ${daysAbsent} ‡∏ß‡∏±‡∏ô)</span>`;

  // ‡πÉ‡∏™‡πà HTML ‡∏•‡∏á modal
  document.getElementById("modal-content").innerHTML = `
    <h3 style="font-size:16px; margin-bottom:4px;">üìá ${escapeHTML(customer.name)}</h3>
    <div style="font-size:12px;">üÜî OPD: ${escapeHTML(customer.opd)}</div>
    <div style="font-size:12px;">üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${escapeHTML(customer.phone)}</div>
    <div style="font-size:12px;">üìÖ ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${formatDate(lastDateStr)} ${daysAbsentText}</div>
    <div style="font-size:12px; color:#00796b;">
      üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${Math.round(totalAmount).toLocaleString()} ‡∏ö‡∏≤‡∏ó
    </div>
    <div style="font-size:12px;">üîÅ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ${totalVisits} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${paidVisits} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô)</div>
    <div style="font-size:12px;">üí≥ ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ${average.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>

    <hr style="margin:14px 0; border:0; border-top:1px solid #ccc;">

    <div style="font-weight:600; font-size:13px; margin-bottom:6px;">üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</div>
    <div style="font-size:11px;">${itemSummary || '-'}</div>

    <hr style="margin:14px 0; border:0; border-top:1px solid #ccc;">

    <div style="font-weight:600; font-size:13px; margin-bottom:4px;">üó£Ô∏è Sale Pitch (‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô):</div>
    ${pitchSectionHtml}

    <hr style="margin:14px 0; border:0; border-top:1px solid #ccc;">

    <div style="font-weight:600; font-size:13px; margin-bottom:6px;">üßæ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á:</div>
    ${historyHtml}
  `;

  document.getElementById("customer-modal").style.display = 'flex';
}



  function saveModalAsImage() {
    const node = document.getElementById("modal-content");
    if (!node) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô modal");
    html2canvas(node, { scale: 2 }).then(canvas => {
      const dataUrl = canvas.toDataURL("image/jpeg", 0.95);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      if (isIOS) {
        const previewArea = document.createElement("div");
        previewArea.style.marginTop = "20px";
        previewArea.innerHTML = `<div style="font-weight:bold; margin-bottom:6px;">‡πÅ‡∏ï‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ</div><img src="${dataUrl}" style="width:100%; border:1px solid #ccc; border-radius:12px;">`;
        const existing = document.getElementById("modalImagePreview"); if (existing) existing.remove();
        previewArea.id = "modalImagePreview";
        node.appendChild(previewArea);
      } else {
        const link = document.createElement("a"); link.download = 'customer-info.jpg'; link.href = dataUrl; link.click();
      }
    });
  }

  // ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á
  document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("customer-modal");
    const box = document.getElementById("customer-modal-box");
    if (modal && box) modal.addEventListener("click", e => { if (!box.contains(e.target)) closeCustomerModal(); });
  });

  // ===== ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ) =====
  const productCategories = {
    "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": ["Aestox 50 u", "Aestox 100 u", "Allergan 50 u", "Allergan 100 u"],
    "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥", "Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á", "E.P.T.Q", "Restylane"],
    "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": ["Meso Chanel", "P - Cell", "Aquatic", "Hestina", "Exosome", "Rejuran", "Belotero Revive", "Sculptra", "Juvelook", "Aesthefill"],
    "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster"],
    "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": ["‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤"],
    "Fat/Hifu": ["Bromi", "Sisi", "HIFU", "HIFU ‡πÅ‡∏ñ‡∏°"],
    "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": ["‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤", "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤", "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÑ‡∏´‡∏° PDO", "‡πÑ‡∏´‡∏° Collagen"]
  };

  const filterUI = document.createElement("div");
  filterUI.style.cssText = "margin: 40px auto 20px; padding: 20px; background: #fefefe; border: 1px solid #e0e0e0; border-radius: 12px; max-width: 1100px; font-size: 13px; line-height: 1.6; font-family: 'Prompt', sans-serif; box-shadow: 0 3px 10px rgba(0,0,0,0.03);";
  filterUI.innerHTML = `
    <div class="filter-section">
      <h3>üîç ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
      <div class="product-row">
        <label>üß¥ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ã‡∏∑‡πâ‡∏≠:</label>
        <button type="button" class="add-product-button" onclick="addProductSelect()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      </div>
      <div id="productListContainer" class="product-list-container"></div>

      <div class="inline-field">
        <label>üìÖ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</label>
        <div class="input-pair">
          <input type="date" id="startDate">
          <span>-</span>
          <input type="date" id="endDate">
        </div>
      </div>

      <div class="inline-field">
        <label>üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏≤‡∏ó):</label>
        <div class="input-pair">
          <input type="number" id="minTotal" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
          <span>-</span>
          <input type="number" id="maxTotal" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
        </div>
      </div>

      <div class="inline-field">
        <label>üìÑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏°‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å:</label>
        <div class="input-pair">
          <input type="number" id="minVisits" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
          <span>-</span>
          <input type="number" id="maxVisits" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
        </div>
      </div>

      <div class="inline-field">
        <label>‚è≥ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å:</label>
        <div class="input-pair">
          <input type="number" id="minAbsent" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
          <span>-</span>
          <input type="number" id="maxAbsent" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
        </div>
      </div>

      <div class="inline-field">
        <label>üí≥ ‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏• (‡∏ö‡∏≤‡∏ó):</label>
        <div class="input-pair">
          <input type="number" id="minAvg" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
          <span>-</span>
          <input type="number" id="maxAvg" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
        </div>
      </div>

      <div class="inline-field">
        <label>üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</label>
        <input type="text" id="customerName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
      </div>

      <button type="button" onclick="filterGeneral()" class="search-button">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <button type="button" onclick="resetFilters()" class="add-product-button" style="margin-left: 10px;">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤</button>
      <button type="button" onclick="openGroupModal()" class="add-product-button" style="margin-left: 10px;">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
    </div>
    <div id="filterResults" style="margin-top: 24px; font-size: 13px;"></div>`;
  document.body.appendChild(filterUI);

  function addProductSelect() {
    const container = document.getElementById("productListContainer");
    const wrapper = document.createElement("div"); wrapper.style.marginBottom = "6px";
    const select = document.createElement("select"); select.className = "productInput"; select.style.cssText = "width: 240px; padding: 4px; font-size: 13px;";
    const def = document.createElement("option"); def.textContent = "‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"; def.value = ""; def.disabled = true; def.selected = true; select.appendChild(def);
    Object.entries(productCategories).forEach(([cat, items]) => {
      const group = document.createElement("optgroup"); group.label = cat;
      items.forEach(p => { const option = document.createElement("option"); option.value = p; option.textContent = p; group.appendChild(option); });
      select.appendChild(group);
    });
    wrapper.appendChild(select); container.appendChild(wrapper);
  }

  function filterGeneral() {
    const nameInput = document.getElementById("customerName").value.trim().toLowerCase();
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    const minTotal = parseFloat(document.getElementById("minTotal").value) || 0;
    const maxTotal = parseFloat(document.getElementById("maxTotal").value) || Infinity;
    const minVisits = parseInt(document.getElementById("minVisits").value) || 0;
    const maxVisits = parseInt(document.getElementById("maxVisits").value) || Infinity;
    const minAbsent = parseInt(document.getElementById("minAbsent").value) || 0;
    const maxAbsent = parseInt(document.getElementById("maxAbsent").value) || Infinity;
    const minAvg = parseFloat(document.getElementById("minAvg").value) || 0;
    const maxAvg = parseFloat(document.getElementById("maxAvg").value) || Infinity;

    const selectedProducts = Array.from(document.querySelectorAll('.productInput')).map(el => el.value).filter(Boolean);

    const grouped = {};
    const today = new Date();

    allCustomerRecords.forEach(r => {
      const key = `${r.name}|${r.phone}`;
      (grouped[key] ||= []).push(r);
    });

    const results = Object.entries(grouped).map(([key, records]) => {
      const name = records[0].name;

      const totalVisits = records.length;
      const paidRecords = records.filter(r => parseFloat(r.amount || 0) > 0);
      const paidVisits = paidRecords.length;
      const totalAmount = paidRecords.reduce((sum, r) => sum + parseFloat(r.amount), 0);
      const averageBill = paidVisits > 0 ? totalAmount / paidVisits : 0;

      const latestRecord = records.reduce((latest, r) =>
        new Date(r.date) > new Date(latest.date) ? r : latest,
        records[0]
      );

      const absentDays = Math.floor((today - new Date(latestRecord.date)) / (1000 * 60 * 60 * 24));
      const lastVisit = latestRecord.date;

      const allProducts = records.flatMap(r => r.items || []).map(item => {
        const match = item.match(/\((.*?)\)/);
        return match ? match[1] : item.split(" - ")[0].trim();
      });

      return { key, name, totalAmount, totalVisits, paidVisits, averageBill, absentDays, lastVisit, products: allProducts };
    }).filter(c => {
      const nameMatch = !nameInput || c.name.toLowerCase().includes(nameInput);
      const totalMatch = c.totalAmount >= minTotal && c.totalAmount <= maxTotal;
      const visitMatch = c.totalVisits >= minVisits && c.totalVisits <= maxVisits;
      const absentMatch = c.absentDays >= minAbsent && c.absentDays <= maxAbsent;
      const avgMatch = c.averageBill >= minAvg && c.averageBill <= maxAvg;
      const dateMatch = (!startDate || new Date(c.lastVisit) >= new Date(startDate)) && (!endDate || new Date(c.lastVisit) <= new Date(endDate));
      const productMatch = selectedProducts.length === 0 || selectedProducts.every(p => c.products.some(prod => prod.includes(p)));
      return nameMatch && totalMatch && visitMatch && absentMatch && avgMatch && dateMatch && productMatch;
    }).sort((a, b) => b.totalAmount - a.totalAmount);

    const html = results.map(c => {
      const formattedDate = new Date(c.lastVisit).toLocaleDateString('th-TH',{day:'numeric', month:'short', year:'2-digit'});
      return `<div>
        <input type="checkbox" class="selectCustomerCheckbox" value="${c.key}" style="margin-right:6px; vertical-align: middle;">
        üìá <strong style="cursor:pointer;color:#00796b;" onclick="openCustomerModal('${c.key}')">${c.name}</strong>
        üí∞ ‡∏¢‡∏≠‡∏î: ${c.totalAmount.toLocaleString()} |
        üí≥ ${Math.round(c.averageBill).toLocaleString()} |
        üîÅ ${c.totalVisits} (${c.paidVisits} ‡∏à‡πà‡∏≤‡∏¢) |
        ‚è±Ô∏è ${c.absentDays} ‡∏ß‡∏±‡∏ô |
        ${formattedDate}
      </div><hr>`;
    }).join('');

    document.getElementById("filterResults").innerHTML = `<h4>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ${results.length} ‡∏Ñ‡∏ô</h4>` + html;
  }

  // ‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏≠‡∏¢
  function toggleFloatingMenu(){ const menu = document.getElementById("floatingMenu"); menu.style.display = (menu.style.display==="flex")?"none":"flex"; }
  document.addEventListener('click', function(e) {
    const toggle = document.getElementById("floatingToggle");
    const menu = document.getElementById("floatingMenu");
    if (!toggle.contains(e.target) && !menu.contains(e.target)) menu.style.display = "none";
  });

  // ===== Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô =====
function openRangeModal(){
  const s = document.getElementById('rangeStartModal');
  const e = document.getElementById('rangeEndModal');
  s.value = monthRange.startYM || '';
  e.value = monthRange.endYM || '';
  document.getElementById('rangeModal').style.display = 'block';
}
function closeRangeModal(){ document.getElementById('rangeModal').style.display = 'none'; }
function applyRangeFromModal(){
  const s = document.getElementById('rangeStartModal').value;
  const e = document.getElementById('rangeEndModal').value;
  if(!s || !e){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'); return; }
  if(ymNum(s) > ymNum(e)){ alert('‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'); return; }
  monthRange.enabled = true;
  monthRange.startYM = s;
  monthRange.endYM = e;
  closeRangeModal();
  fetchDataAndUpdate();
}
function clearRange(){
  monthRange.enabled = false;
  monthRange.startYM = monthRange.endYM = null;
  closeRangeModal();
  fetchDataAndUpdate();
}

/* =======================
   Popup ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏ß‡∏±‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå)
   ======================= */
function openMonthlySalesPopup(){
  // Helpers
  const fmtYM = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  const parseQty = (items=[]) => items.reduce((s,it)=>{
    const m = it.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/); return s + (m? parseInt(m[1]):1);
  },0);
  const thDateWithWeekday = (iso)=>{
    const d = new Date(iso);
    const wd = d.toLocaleDateString('th-TH',{ weekday:'long' });
    const dt = d.toLocaleDateString('th-TH',{ day:'2-digit', month:'short', year:'numeric' });
    return `${dt} (${wd})`;
  };

  // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  const now = new Date();
  const curY = viewingDate.getFullYear();
  const curM = viewingDate.getMonth();

  // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: 1‚Üí‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ / ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡πâ‡∏ô
  let curStart = new Date(curY, curM, 1);
  let curEnd   = (curY===now.getFullYear() && curM===now.getMonth())
                  ? new Date(now.getFullYear(), now.getMonth(), now.getDate())
                  : new Date(curY, curM+1, 0);

  // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß: ‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  const prevStart = new Date(curY, curM-1, 1);
  const prevEnd   = new Date(curY, curM, 0);

  const curPrefix  = fmtYM(curStart);
  const prevPrefix = fmtYM(prevStart);

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î)
  function dailySummary(from, to, prefix){
    const map = {}; // date -> {total, bills, items, customers:Set}
    allSalesRecords.forEach(r=>{
      if(!r.date.startsWith(prefix)) return;
      const d = new Date(r.date);
      if(d < from || d > to) return;

      if(!map[r.date]) map[r.date] = { total:0, bills:0, items:0, customers:new Set() };
      map[r.date].total   += parseFloat(r.amount||0);
      map[r.date].bills   += 1;
      map[r.date].items   += parseQty(r.items);
      map[r.date].customers.add(`${r.name}|${r.phone}`);
    });

    const rows = Object.entries(map)
      .map(([date, v])=>({
        date,
        total: v.total,
        bills: v.bills,
        avgBill: v.bills ? Math.round(v.total / v.bills) : 0,
        items: v.items,
        customers: v.customers.size
      }))
      .filter(r=>r.total>0) // ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏ß‡∏±‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå
      .sort((a,b)=>a.date.localeCompare(b.date));

    const sum = rows.reduce((s,r)=>s+r.total,0);
    const days = rows.length;
    const avgPerDay = days? Math.round(sum/days):0;
    const best = rows.slice().sort((a,b)=>b.total-a.total)[0] || null;
    const worst = rows.slice().sort((a,b)=>a.total-b.total)[0] || null;

    const wdTotal = {0:0,1:0,2:0,3:0,4:0,5:0,6:0};
    rows.forEach(r=>{
      const wd = new Date(r.date).getDay(); // 0=‡∏≠‡∏≤
      wdTotal[wd] += r.total;
    });

    return { rows, sum, days, avgPerDay, best, worst, wdTotal };
  }

  const cur = dailySummary(curStart, curEnd, curPrefix);
  const prev = dailySummary(prevStart, prevEnd, prevPrefix);

  // ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  const toRow = r => `
    <tr>
      <td>${thDateWithWeekday(r.date)}</td>
      <td>${r.total.toLocaleString()}</td>
      <td>${r.bills.toLocaleString()}</td>
      <td>${r.avgBill.toLocaleString()}</td>
      <td>${r.items.toLocaleString()}</td>
      <td>${r.customers.toLocaleString()}</td>
    </tr>`;

  const wdNames = ['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™'];
  const wdBadges = (wdTotal)=> wdNames.map((n,i)=>`<span class="badge" title="‡∏£‡∏ß‡∏° ${n}">${n}: ${Math.round(wdTotal[i]).toLocaleString()}</span>`).join(' ');

  const curTitle = new Date(curStart).toLocaleString('th-TH',{month:'long'}) + ' ' + (curStart.getFullYear()+543);
  const prevTitle= new Date(prevStart).toLocaleString('th-TH',{month:'long'}) + ' ' + (prevStart.getFullYear()+543);

  const html = `
    <div style="position:absolute; top:10px; right:10px; display:flex; gap:10px;">
      <button onclick="saveModalAsImage()" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" style="background:white; border:none; border-radius:50%; width:36px; height:36px; box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer;">üíæ</button>
      <button onclick="closeCustomerModal()" title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á" style="background:white; border:none; border-radius:50%; width:36px; height:36px; box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer;">‚ùå</button>
    </div>

    <h3 style="margin:0 0 6px;">üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‚Äî ${curTitle}</h3>
    <div style="margin-bottom:8px;">
      <span class="badge">‡∏£‡∏ß‡∏°: ${cur.sum.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
      <span class="badge">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏≤‡∏¢: ${cur.days} ‡∏ß‡∏±‡∏ô</span>
      <span class="badge">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô: ${cur.avgPerDay.toLocaleString()}</span>
      ${cur.best ? `<span class="badge">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${thDateWithWeekday(cur.best.date)} = ${cur.best.total.toLocaleString()}</span>`:''}
      ${cur.worst ? `<span class="badge">‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î: ${thDateWithWeekday(cur.worst.date)} = ${cur.worst.total.toLocaleString()}</span>`:''}
    </div>
    <div style="margin-bottom:10px;">${wdBadges(cur.wdTotal)}</div>
    <table class="table-mini">
      <thead>
        <tr>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ß‡∏±‡∏ô)</th>
          <th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
          <th>‡∏ö‡∏¥‡∏•</th>
          <th>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏•</th>
          <th>‡∏ä‡∏¥‡πâ‡∏ô</th>
          <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
        </tr>
      </thead>
      <tbody>${cur.rows.map(toRow).join('')}</tbody>
    </table>

    <hr style="margin:16px 0; border:0; border-top:1px solid #ddd;">

    <h3 style="margin:0 0 6px;">üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Äî ${prevTitle}</h3>
    <div style="margin-bottom:8px;">
      <span class="badge">‡∏£‡∏ß‡∏°: ${prev.sum.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
      <span class="badge">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏≤‡∏¢: ${prev.days} ‡∏ß‡∏±‡∏ô</span>
      <span class="badge">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô: ${prev.avgPerDay.toLocaleString()}</span>
      ${prev.best ? `<span class="badge">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${thDateWithWeekday(prev.best.date)} = ${prev.best.total.toLocaleString()}</span>`:''}
      ${prev.worst ? `<span class="badge">‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î: ${thDateWithWeekday(prev.worst.date)} = ${prev.worst.total.toLocaleString()}</span>`:''}
    </div>
    <div style="margin-bottom:10px;">${wdBadges(prev.wdTotal)}</div>
    <table class="table-mini">
      <thead>
        <tr>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ß‡∏±‡∏ô)</th>
          <th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
          <th>‡∏ö‡∏¥‡∏•</th>
          <th>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏•</th>
          <th>‡∏ä‡∏¥‡πâ‡∏ô</th>
          <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                 </tr>
      </thead>
      <tbody>${prev.rows.map(toRow).join('')}</tbody>
    </table>
  `;

  // ‡πÉ‡∏ä‡πâ modal ‡πÄ‡∏î‡∏¥‡∏°
  document.getElementById('modal-content').innerHTML = html;
  document.getElementById('customer-modal').style.display = 'flex';
}

// ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Lead (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà) =====

// ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô" (‡πÇ‡∏Ñ‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ ‡πÜ ‡∏•‡∏î)
function recencyScore(absentDays) {
  if (absentDays <= 45) return 0; // ‡∏ä‡πà‡∏ß‡∏á‡∏û‡∏±‡∏Å‡∏ï‡∏±‡∏ß

  // 46‚Äì90 ‡∏ß‡∏±‡∏ô: ‡∏à‡∏≤‡∏Å 20 ‚Üí 40
  if (absentDays <= 90) {
    return 20 + (absentDays - 46) * (20 / (90 - 46));
  }

  // 91‚Äì180 ‡∏ß‡∏±‡∏ô: ‡∏à‡∏≤‡∏Å 40 ‚Üí 25
  if (absentDays <= 180) {
    return 40 - (absentDays - 90) * (15 / (180 - 90));
  }

  // 181‚Äì365 ‡∏ß‡∏±‡∏ô: ‡∏à‡∏≤‡∏Å 25 ‚Üí 10
  if (absentDays <= 365) {
    return 25 - (absentDays - 180) * (15 / (365 - 180));
  }

  // 366‚Äì730 ‡∏ß‡∏±‡∏ô (1‚Äì2 ‡∏õ‡∏µ): ‡∏à‡∏≤‡∏Å 10 ‚Üí 3
  if (absentDays <= 730) {
    return 10 - (absentDays - 365) * (7 / (730 - 365));
  }

  // 731‚Äì1460 ‡∏ß‡∏±‡∏ô (2‚Äì4 ‡∏õ‡∏µ): ‡∏à‡∏≤‡∏Å 3 ‚Üí 1
  if (absentDays <= 1460) {
    return 3 - (absentDays - 730) * (2 / (1460 - 730));
  }

  // ‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏Ñ‡πà‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏≠
  return 0.5;
}

// ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡∏•‡∏≠‡∏î‡∏ä‡∏µ‡∏û
function valueScore(totalAmount) {
  if (totalAmount >= 200000) return 45;
  if (totalAmount >= 100000) return 40;
  if (totalAmount >= 50000)  return 32;
  if (totalAmount >= 20000)  return 24;
  if (totalAmount >= 10000)  return 16;
  if (totalAmount >= 5000)   return 10;
  if (totalAmount >= 3000)   return 6;
  if (totalAmount >= 1000)   return 3;
  return 0;
}

// ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤
function visitScore(totalVisits) {
  if (totalVisits >= 12) return 18;
  if (totalVisits >= 8)  return 14;
  if (totalVisits >= 5)  return 10;
  if (totalVisits >= 3)  return 6;
  if (totalVisits >= 2)  return 3;
  return 0;
}

// ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å‡∏ö‡∏¥‡∏•‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
function avgScore(averageBill) {
  if (averageBill >= 20000) return 18;
  if (averageBill >= 12000) return 14;
  if (averageBill >= 8000)  return 10;
  if (averageBill >= 5000)  return 7;
  if (averageBill >= 3000)  return 4;
  if (averageBill >= 1500)  return 2;
  return 0;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
function computeLeadScoreForCustomer(core) {
  const totalAmount  = core.totalAmount || 0;
  const totalVisits  = core.totalVisits || 0;
  const averageBill  = core.averageBill || 0;
  const absentDays   = core.absentDays || 0;

  // ‡∏ï‡∏±‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏¥‡πã‡∏ß: ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å + ‡∏°‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -> ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏•‡∏¥‡∏™‡∏ï‡πå
  if (totalAmount < 2000 && totalVisits <= 1) {
    return 0;
  }

  const r = recencyScore(absentDays);      // 0‚Äì~40
  const v = valueScore(totalAmount);       // 0‚Äì45
  const f = visitScore(totalVisits);       // 0‚Äì18
  const a = avgScore(averageBill);         // 0‚Äì18

  // VIP Boost: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏ô‡∏±‡∏Å ‡πÜ ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡πà‡∏≤‡∏á‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ô‡πà‡∏≤‡πÇ‡∏ó‡∏£
  let vipBoost = 0;
  const isVIP = (totalAmount >= 100000) || (averageBill >= 10000);
  if (isVIP) {
    if (absentDays >= 60 && absentDays <= 210) {
      vipBoost = 10;      // ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á 2‚Äì7 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏î‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏µ‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢
    } else if (absentDays <= 365) {
      vipBoost = 5;       // ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏õ‡∏µ ‡∏¢‡∏±‡∏á‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡∏ï‡∏≤‡∏°
    }
  }

  const rawScore = r + v + f + a + vipBoost;

  // ‡∏õ‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡πÄ‡∏ï‡πá‡∏°‡∏™‡∏ß‡∏¢ ‡πÜ
  return Math.round(rawScore);
}


// ‡∏™‡∏£‡πâ‡∏≤‡∏á list ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÇ‡∏ó‡∏£‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏≤‡∏Å allCustomerRecords + Sale pitch
async function buildLeadScoreList() {
  const ul = document.getElementById('leadScoreList');
  if (!ul || !allCustomerRecords.length) return;

  const grouped = {};
  const today = new Date();

  // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏•‡∏≠‡∏î‡∏ä‡∏µ‡∏û‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô
  allCustomerRecords.forEach(r => {
    const key = `${r.name}|${r.phone}`;
    if (!grouped[key]) {
      grouped[key] = {
        key,
        name: r.name,
        phone: r.phone || '-',
        opd: r.opd || '-',
        records: []
      };
    }
    grouped[key].records.push(r);
  });

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô
  let scored = Object.values(grouped).map(c => {
    const recs = c.records;

    const totalVisits = recs.length;
    const paid = recs.filter(r => parseFloat(r.amount || 0) > 0);
    const paidVisits = paid.length;
    const totalAmount = paid.reduce((s, r) => s + parseFloat(r.amount || 0), 0);
    const averageBill = paidVisits > 0 ? totalAmount / paidVisits : 0;

    const latest = recs.reduce(
      (last, r) => new Date(r.date) > new Date(last.date) ? r : last,
      recs[0]
    );
    const lastDate = new Date(latest.date);
    const absentDays = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));

    const core = {
      key: c.key,
      name: c.name,
      phone: c.phone,
      opd: c.opd,
      totalVisits,
      totalAmount,
      averageBill,
      absentDays,
      lastDate: latest.date
    };

    const score = computeLeadScoreForCustomer(core);
    return { ...core, score };
  })
  // ‡∏û‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô 0‚Äì45 ‡∏ß‡∏±‡∏ô
  .filter(c => c.absentDays > 45)
  // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏°‡∏≤‡∏Å ‡πÜ ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏•‡∏¥‡∏™‡∏ï‡πå
  .filter(c => c.score >= 20);

  if (!scored.length) {
    ul.innerHTML = `<li class="lead-score-meta">
      ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå (‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 45 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏û‡∏≠‡∏™‡∏°‡∏Ñ‡∏ß‡∏£)
    </li>`;
    return;
  }

  // ‡∏î‡∏∂‡∏á Sale pitch ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô (‡∏ï‡∏≤‡∏° OPD)
  const enriched = await Promise.all(scored.map(async c => {
    const pitch = await fetchLatestPitchForOPD(c.opd);
    return { ...c, pitch };
  }));

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á -> ‡∏ï‡πà‡∏≥ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤ Top 15
  const top = enriched
    .sort((a, b) => b.score - a.score)
    .slice(0, 45);

  ul.innerHTML = top.map(c => {
    const avg   = Math.round(c.averageBill || 0).toLocaleString();
    const total = Math.round(c.totalAmount || 0).toLocaleString();
    const last  = new Date(c.lastDate).toLocaleDateString('th-TH', {
      day: '2-digit', month: 'short', year: '2-digit'
    });
    const key = c.key;

    // Sale pitch
    let pitchDateText = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÇ‡∏ó‡∏£';
    let pitchOutcomeShort = '‚Äî';
    if (c.pitch && c.pitch.date) {
      pitchDateText = formatDate(String(c.pitch.date).slice(0, 10)); // ‡πÉ‡∏ä‡πâ formatDate ‡πÄ‡∏î‡∏¥‡∏°
      const raw = c.pitch.outcome || c.pitch.content || '';
      pitchOutcomeShort = raw ? raw : '‚Äî';
    }

    return `
      <li>
        <span class="lead-name" onclick="openCustomerModal('${key}')">
          ${escapeHTML(c.name || '-')}
        </span>
        <span class="lead-score-badge">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÇ‡∏ó‡∏£: ${c.score}</span>
        <span class="lead-score-meta">
          ‚è≥ ‡πÑ‡∏°‡πà‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß <span class="lead-absent">${c.absentDays} ‡∏ß‡∏±‡∏ô</span>
          ‚Ä¢ üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ${total} ‡∏ö.
          ‚Ä¢ üí≥ ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏• ${avg} ‡∏ö.
          ‚Ä¢ üîÅ ‡∏°‡∏≤ ${c.totalVisits} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
          ‚Ä¢ üìÖ ‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${last}
          ‚Ä¢ üìû ‡πÇ‡∏ó‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${escapeHTML(pitchDateText)}
          ‚Ä¢ ‡∏ú‡∏•: ${escapeHTML(pitchOutcomeShort)}
        </span>
      </li>
    `;
  }).join('');
}



</script>

<div id="floatingToggle" class="floating-toggle" onclick="toggleFloatingMenu()">
  <img src="{{ url_for('static', filename='icon/icon_menu_toggle.png') }}" alt="menu" style="width:60px;height:60px;">
</div>

<div id="floatingMenu" class="floating-menu" aria-hidden="true">
  <a href="{{ url_for('dashboard') }}"><img src="{{ url_for('static', filename='icon/icon_dashboard.png') }}" alt="Dashboard"></a>
  <a href="{{ url_for('sale_summary') }}"><img src="{{ url_for('static', filename='icon/icon_sale_summary.png') }}" alt="Sale summary"></a>
  <a href="{{ url_for('crm') }}"><img src="{{ url_for('static', filename='icon/icon_crm.png') }}" alt="CRM"></a>
  <a href="{{ url_for('record_sales') }}"><img src="{{ url_for('static', filename='icon/icon_record_sales.png') }}" alt="Record sales"></a>
  <a href="{{ url_for('customer_list') }}"><img src="{{ url_for('static', filename='icon/icon_customer_list.png') }}" alt="Customer list"></a>
  <a href="{{ url_for('record_customer') }}"><img src="{{ url_for('static', filename='icon/icon_customer_history.png') }}" alt="Record customer"></a>
  <a href="{{ url_for('oldsaledata') }}"><img src="{{ url_for('static', filename='icon/icon_old_customers.png') }}" alt="Old customers"></a>
  <a href="{{ url_for('inventory') }}"><img src="{{ url_for('static', filename='icon/icon_inventory.png') }}" alt="Inventory"></a>
  <a href="{{ url_for('staff') }}"><img src="{{ url_for('static', filename='icon/icon_staff.png') }}" alt="Staff"></a>
  <a href="{{ url_for('appointments') }}"><img src="{{ url_for('static', filename='icon/icon_appointments.png') }}" alt="Appointments"></a>
</div>
</body>
</html>