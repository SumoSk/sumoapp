<!DOCTYPE html>
<html lang="th">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta charset="UTF-8" />
<title>แดชบอร์ด</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Prompt', 'Segoe UI', sans-serif;
    margin: 0;
    background-color: white;
    padding: 10px;
    padding-bottom: 120px;
    font-size: 14px;
  }

  .menu-bar {
    display: flex;
    justify-content: space-around;
    background-color: white;
    padding: 10px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }
  .menu-bar a { text-decoration: none; font-weight: bold; color: teal; }

  .month-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .month-nav button {
    background-color: #009688; color: white; border: none;
    padding: 8px 16px; font-size: 14px; border-radius: 8px;
    cursor: pointer; transition: background-color 0.2s ease;
  }
  .month-nav button:hover { background-color: #00796b; }
  .month-nav input[type="month"]{
    padding: 6px 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;
  }
  .month-nav .sep{opacity:.7}

  #mainTitle {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background-color: #e0f2f1; border-radius: 16px; padding: 20px 30px;
    margin: 0 auto 30px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    max-width: fit-content; text-align: center;
  }
  #mainTitle .month { font-size: 26px; font-weight: 600; color: #004d40; }
  #mainTitle .total { font-size: 18px; color: #009688; margin-top: 6px; }

  .top10-box {
    max-width: 1200px; margin: 0 auto 20px; background: #fff; padding: 15px 20px;
    border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.06);
  }
  .top10-box h3 { margin-top: 0; color: teal; font-size: 18px; text-align: center; }
  .top10-box ul { list-style: none; padding-left: 0; }
  .top10-box li { margin-bottom: 6px; padding: 4px 0; border-bottom: 1px dashed #ddd; white-space: nowrap; }
  .top10-box li span.name { font-weight: 600; color: #333; }
  .top10-box li span.date { font-size: 13px; color: #999; margin-left: 6px; }
  .top10-box li span.amount { float: right; color: #009688; font-weight: 600; white-space: nowrap; font-variant-numeric: tabular-nums; }

  @media (max-width: 768px) {
    .top10-box li span.date { font-size: 8px !important; }
  }

  .chart-summary-row {
    display: flex; justify-content: space-between; align-items: flex-start;
    gap: 20px; max-width: 1200px; margin: 0 auto 20px; flex-wrap: wrap;
  }
  .chart-container {
    flex: 1; background: #fff; padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.06);
  }
  canvas { width: 100% !important; height: 300px !important; }

  .summary-list {
    flex: 1; background: #fff; padding: 15px 20px; border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06); font-size: 14px;
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;
  }
  .summary-group ul { list-style: none; padding-left: 0px; margin: 5px 0 10px; }
  .summary-group li { margin-bottom: 4px; }
  .summary-group strong { color: #00796b; display: block; margin-bottom: 6px; font-size: 15px; }

  .floating-dock {
    position: fixed; bottom: env(safe-area-inset-bottom, 16px); left: 50%; transform: translateX(-50%);
    background: white; border-radius: 16px; padding: 6px 6px env(safe-area-inset-bottom, 16px);
    display: flex; gap: 6px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); z-index: 1000; max-width: 95vw;
  }
  .icon-button { width: 64px; height: 64px; padding: 4px; border-radius: 12px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease; text-decoration: none; flex: 0 0 auto; }
  .icon-button img { width: 60px; height: 60px; object-fit: contain; }
  .icon-button:hover { transform: scale(1.1); }

  .inline-field { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; max-width: 600px; }
  .inline-field label { min-width: 160px; font-weight: bold; font-size: 14px; color: #333; }
  .inline-field .input-pair { display: flex; gap: 6px; align-items: center; }
  .inline-field input, .inline-field select { padding: 6px 8px; font-size: 13px; width: 120px; border: 1px solid #ccc; border-radius: 6px; max-width: 100%; }
  button[type="button"] { background-color: teal; color: white; border: none; padding: 6px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; margin-top: 10px; }

  @media (max-width: 768px) {
    .inline-field { flex-direction: column; align-items: flex-start; max-width: 100%; }
    .inline-field label { min-width: unset; }
    .inline-field input, .inline-field select { width: auto; min-width: 100px; max-width: 100%; }
    .inline-field .input-pair { flex-direction: row; width: 100%; }
  }

  .add-product-button {
    background-color: #e0f7fa; color: #00796b; border: 1px solid #00bfa5;
    padding: 6px 14px; font-size: 13px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;
  }
  .add-product-button:hover { background-color: #b2dfdb; color: #004d40; transform: scale(1.03); }

  .floating-toggle {
    position: fixed; bottom: env(safe-area-inset-bottom, 18px); left: 50%; transform: translateX(-50%);
    background: rgba(0, 128, 128, 0); width: 58px; height: 58px; border-radius: 50%;
    box-shadow: 0 4px 16px rgba(251, 251, 251, 0); display: flex; justify-content: center; align-items: center; z-index: 1000; cursor: pointer;
  }
  .floating-menu {
    position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
    background: white; border-radius: 16px; padding: 10px; display: none; flex-direction: column; align-items: center; gap: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.2); z-index: 999; max-height: 60vh; overflow-y: auto;
  }
  .floating-menu a img { width: 52px; height: 52px; }

  @media (max-width: 768px) {
    body { font-size: 10px; }
    #mainTitle .month { font-size: 14px; }
    #mainTitle .total, #mainTitle .compare { font-size: 10px; }
    .summary-list { font-size: 10px; grid-template-columns: repeat(4, 1fr); }
    .summary-group strong { font-size: 10px; }
    .top10-box h3 { font-size: 12px; }
    .top10-box li span.name, .top10-box li span.date, .top10-box li span.amount { font-size: 10px; }
    .inline-field label, .inline-field input, .inline-field select { font-size: 10px; }
    .add-product-button { font-size: 10px; padding: 4px 8px; }
    #customer-modal > div { font-size: 10px !important; }
    .icon-button { width: 48px; height: 48px; }
    .icon-button img { width: 48px; height: 48px; }
    .chart-summary-row { flex-direction: column; }
  }

  @media (max-width: 1024px) {
    .floating-dock { bottom: 0; padding-bottom: env(safe-area-inset-bottom); }
  }

  #mainTitle .compare { font-size: 13px; }
  @media (max-width: 768px) { #mainTitle .compare { font-size: 10px; } }

  .filter-section {
    max-width: 650px; margin: auto; padding: 20px; background: #fefefe; border: 1px solid #ddd; border-radius: 12px; font-size: 14px;
  }
  h3 { margin-top: 0; color: #00695c; margin-bottom: 20px; font-size: 16px; }

  .product-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; flex-wrap: wrap; }
  .inline-field { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 12px; }
  .inline-field label { min-width: 180px; font-weight: bold; font-size: 14px; color: #333; }
  .input-pair { display: flex; gap: 6px; align-items: center; }
  .input-pair input { padding: 6px 8px; font-size: 13px; width: 120px; max-width: 100%; border: 1px solid #ccc; border-radius: 6px; }
  .product-list-container { margin-bottom: 16px; }
  .search-button { background-color: teal; color: white; border: none; padding: 8px 20px; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 12px; }
  .search-button:hover { background-color: #00796b; }

  @media (max-width: 768px) {
    .inline-field { flex-direction: column; align-items: flex-start; }
    .inline-field label { min-width: unset; }
    .input-pair { width: 100%; }
    .input-pair input { width: 100%; }
    .product-row { flex-direction: column; align-items: flex-start; }
  }
  @media (max-width: 768px) {
    body { font-size: 10px; }
    .filter-section, .inline-field label, .inline-field input, .inline-field select, .add-product-button, .search-button, .input-pair input { font-size: 10px !important; }
    h3 { font-size: 11px !important; }
  }
  @media (max-width: 768px) {
    #filterResults, #filterResults div, #filterResults strong, #filterResults span { font-size: 10px !important; }
  }
  .inline-field input[type="text"] { padding: 6px 8px; font-size: 13px; width: 240px; max-width: 100%; border: 1px solid #ccc; border-radius: 6px; }
  @media (max-width: 768px) { .inline-field input[type="text"] { font-size: 10px !important; } }
  @media (max-width: 480px) { #customer-modal > div { max-width: 94vw !important; padding: 12px !important; } }

  .group-header {
    font-size: 18px; color: #004d40; font-weight: bold; margin-bottom: 20px;
    text-align: center; background: #e0f2f1; padding: 10px 16px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }
  .customer-entry { padding: 12px 16px; background: #f9f9f9; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
  .customer-name { font-size: 15px; color: #00695c; margin-bottom: 6px; }
  .date-info { font-size: 13px; color: #444; display: flex; flex-wrap: wrap; gap: 8px; }
  .date-box { background: #e0f7fa; color: #004d40; padding: 4px 8px; border-radius: 8px; font-size: 13px; white-space: nowrap; border: 1px solid #b2dfdb; }

  #customer-modal-box {
    width: auto; max-width: 90vw; max-height: 90vh; font-size: 13.5px; padding: 16px; border-radius: 16px;
    overflow: auto; background: white; box-sizing: border-box;
  }
  #customer-modal {
    display: flex; justify-content: center; align-items: center; padding: 16px;
  }
</style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- (legacy) ปิดไว้แต่ยังคงเผื่อใช้ -->
<div id="group-modal-legacy" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
  <div id="group-modal-content-legacy" style="background:#fff; padding:20px; border-radius:10px; max-height:80vh; overflow:auto; width:90%; max-width:500px;">
    <div id="groupSelectedList-legacy"></div>
    <div style="text-align:right; margin-top:20px;">
      <button onclick="closeGroupModal()" style="padding:6px 12px;">❌ ปิด</button>
    </div>
  </div>
</div>

<div id="customer-modal" style="display:none;position:fixed;inset:0;background-color:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;">
  <div id="customer-modal-box" style="background:white;padding:16px;border-radius:16px;width:auto;max-width:90vw;box-sizing:border-box;margin:auto;max-height:90vh;overflow:auto;position:relative; font-size:13.5px;">
    <button onclick="closeCustomerModal()" style="position:absolute;top:10px;right:14px;font-size:20px;border:none;background:none;cursor:pointer;">&times;</button>
    <div id="modal-content"></div>
  </div>
</div>

<div class="month-nav">
  <button onclick="changeMonth(-1)">← เดือนก่อนหน้า</button>
  <button onclick="changeMonth(1)">เดือนถัดไป →</button>

  <!-- ช่วงเดือนแบบกำหนดเอง -->
  <input type="month" id="rangeStart">
  <span class="sep">–</span>
  <input type="month" id="rangeEnd">
  <button onclick="applyRange()">ใช้ช่วงเดือน</button>
  <button onclick="clearRange()">ล้างช่วง</button>
</div>

<div id="mainTitle">
  <div class="month"></div>
  <div class="total"></div>
  <div class="compare" style="margin-top: 6px;"></div>
</div>

<div class="top10-box">
  <h3>Top 10 ลูกค้าใช้จ่ายสูงสุด</h3>
  <ul id="top10List"></ul>
  <p id="totalCustomer" onclick="toggleCustomerList()" style="text-align:center; margin-top: 10px; font-weight: bold; color: teal; cursor: pointer;"></p>
  <ul id="allCustomerList" style="display:none; padding-top: 10px;"></ul>
</div>

<div class="chart-summary-row">
  <div class="summary-list" id="summaryList"></div>
</div>

<!-- Modal แสดงกลุ่ม -->
<div id="group-modal" style="display:none;position:fixed;inset:0;background-color:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;">
  <div id="group-modal-content" style="background:white;padding:20px;border-radius:16px;width:95%;max-width:700px;max-height:90vh;overflow:auto;position:relative; font-size:13px;">
    <div style="position:absolute; top:10px; right:10px; display:flex; gap:10px;">
      <button onclick="saveGroupModalAsImage()" title="บันทึกเป็นรูปภาพ" style="background:white; border:none; border-radius:50%; width:36px; height:36px; box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer; display:flex; align-items:center; justify-content:center;">💾</button>
      <button onclick="closeGroupModal()" title="ปิดหน้าต่าง" style="background:white; border:none; border-radius:50%; width:36px; height:36px; box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer; display:flex; align-items:center; justify-content:center;">❌</button>
    </div>
    <div style="margin-top: 20px;" id="groupSelectedList"></div>
  </div>
</div>

<script>
  // ===== Helpers / State =====
  function formatYM(d){const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');return `${y}-${m}`;}
  const dateYM = (s)=> s.slice(0,7);
  const ymNum = (ym)=>{const[a,b]=ym.split('-').map(Number);return a*100+b;}

  let viewingDate = new Date();     // โหมดรายเดือน (เดิม)
  let allSalesRecords = [];
  let allCustomerRecords = [];
  let fullCustomerList = [];

  // โหมดช่วงเดือน
  const monthRange = { enabled:false, startYM:null, endYM:null };

  // ใช้ฟังก์ชันนี้แทนทุกที่ที่เคย filter(r => r.date.startsWith(prefix))
  function activeFilter(r){
    if (monthRange.enabled){
      const ym = dateYM(r.date);
      return ymNum(ym) >= ymNum(monthRange.startYM) && ymNum(ym) <= ymNum(monthRange.endYM);
    }
    return r.date.startsWith(formatYM(viewingDate));
  }

  function applyRange(){
    const s = document.getElementById('rangeStart').value;
    const e = document.getElementById('rangeEnd').value;
    if(!s || !e){ alert('กรุณาเลือกเดือนเริ่มต้นและสิ้นสุด'); return; }
    if(ymNum(s) > ymNum(e)){ alert('เดือนเริ่มต้องไม่เกินเดือนสิ้นสุด'); return; }
    monthRange.enabled = true; monthRange.startYM = s; monthRange.endYM = e;
    fetchDataAndUpdate();
  }
  function clearRange(){
    monthRange.enabled = false; monthRange.startYM = monthRange.endYM = null;
    fetchDataAndUpdate();
  }

  function changeMonth(delta) {
    viewingDate.setMonth(viewingDate.getMonth() + delta);
    monthRange.enabled = false; // ถ้าขยับเดือน ให้ปิดโหมดช่วงเดือน
    fetchDataAndUpdate();
    refreshCustomerList();
  }

  function fetchAllCustomerRecords() {
    return fetch("/api/sales")
      .then(res => res.json())
      .then(records => { allCustomerRecords = records; })
      .catch(err => { console.error("❌ โหลดข้อมูลทั้งหมดไม่สำเร็จ:", err); });
  }

  function fetchDataAndUpdate() {
    if (allSalesRecords.length > 0 && allCustomerRecords.length > 0) {
      updateDashboard(allSalesRecords);
    } else {
      Promise.all([
        fetch("/api/sales").then(res => res.json()),
        fetchAllCustomerRecords()
      ]).then(([salesRecords]) => {
        allSalesRecords = salesRecords;
        updateDashboard(allSalesRecords);
      }).catch(err => {
        console.error("❌ โหลดข้อมูลไม่สำเร็จ:", err);
        alert("เกิดข้อผิดพลาดในการโหลดข้อมูล");
      });
    }
  }

  function updateDashboard(records) {
    const compareEl = document.querySelector('#mainTitle .compare');
    compareEl.innerHTML = ''; // reset

    // ===== หัวเรื่อง =====
    if (monthRange.enabled){
      const [sy, sm] = monthRange.startYM.split('-').map(Number);
      const [ey, em] = monthRange.endYM.split('-').map(Number);
      const startText = new Date(sy, sm-1, 1).toLocaleString('th-TH',{month:'long'}) + ' ' + (sy+543);
      const endText   = new Date(ey, em-1, 1).toLocaleString('th-TH',{month:'long'}) + ' ' + (ey+543);
      document.querySelector('#mainTitle .month').textContent = `${startText} – ${endText}`;
    } else {
      const monthName = viewingDate.toLocaleString('th-TH', { month: 'long' });
      const yearBE = viewingDate.getFullYear() + 543;
      document.querySelector('#mainTitle .month').textContent = `${monthName} ${yearBE}`;
    }

    // ===== สรุปยอดรวม + เทียบเดือนก่อน (เฉพาะโหมดรายเดือน) =====
    let totalSales = 0;
    if (monthRange.enabled){
      records.filter(activeFilter).forEach(r => totalSales += parseFloat(r.amount || 0));
      document.querySelector('#mainTitle .total').innerHTML = `💰 ยอดขายรวม ${totalSales.toLocaleString()} บาท`;
      compareEl.innerHTML = `<span style="color:gray;">โหมดช่วงเดือน: ไม่เปรียบเทียบกับเดือนก่อน</span>`;
    } else {
      const today = new Date();
      const todayDate = Math.min(today.getDate(), daysInMonth(viewingDate.getFullYear(), viewingDate.getMonth()+1));

      const currentPrefix = formatYM(viewingDate);
      const prev = new Date(viewingDate); prev.setMonth(viewingDate.getMonth() - 1);
      const lastPrefix = formatYM(prev);

      let lastMonthSales = 0, toDateSales = 0, toDateLastMonthSales = 0;

      records.forEach(r => {
        const amt = parseFloat(r.amount||0);
        if (r.date.startsWith(currentPrefix)){
          totalSales += amt;
          const d = parseInt(r.date.split('-')[2]); if (d <= todayDate) toDateSales += amt;
        }
        if (r.date.startsWith(lastPrefix)){
          lastMonthSales += amt;
          const d = parseInt(r.date.split('-')[2]); if (d <= todayDate) toDateLastMonthSales += amt;
        }
      });

      document.querySelector('#mainTitle .total').innerHTML = `💰 ยอดขายรวม ${totalSales.toLocaleString()} บาท`;

      let diff = totalSales - lastMonthSales;
      let text = diff > 0
        ? `<span style="color: green;">+${diff.toLocaleString()} บาท จากเดือนก่อน</span>`
        : diff < 0
          ? `<span style="color: red;">-${Math.abs(diff).toLocaleString()} บาท จากเดือนก่อน</span>`
          : `<span style="color: gray;">ยอดเท่าเดิมกับเดือนก่อน</span>`;

      diff = toDateSales - toDateLastMonthSales;
      let text2 = diff > 0
        ? `<span style="color: green;">📆 รวมเฉพาะ ${todayDate} วัน : +${diff.toLocaleString()} บาท จากเดือนก่อน</span>`
        : diff < 0
          ? `<span style="color: red;">📆 รวมเฉพาะ ${todayDate} วัน: -${Math.abs(diff).toLocaleString()} บาท จากเดือนก่อน</span>`
          : `<span style="color: gray;">📆 รวมเฉพาะ ${todayDate} วัน: ยอดเท่าเดิมกับเดือนก่อน</span>`;
      compareEl.innerHTML = `${text}<br>${text2}`;

      // เทียบค่าเฉลี่ย 1–n วันของเดือนดี ๆ
      const allDates = records.map(r => r.date).filter(Boolean);
      const latestDate = allDates.sort().reverse()[0];
      if (latestDate){
        const targetRangeEnd = todayDate;
        const monthlyTotalMap = {};
        records.forEach(r => {
          const [y,m] = r.date.split("-");
          const ym = `${y}-${m}`;
          if (!monthlyTotalMap[ym]) monthlyTotalMap[ym] = 0;
          monthlyTotalMap[ym] += parseFloat(r.amount || 0);
        });
        const VALID_MONTH_THRESHOLD = 400000;
        const qualifiedMonths = Object.entries(monthlyTotalMap)
          .filter(([m,total]) => m !== currentPrefix && total >= VALID_MONTH_THRESHOLD)
          .map(([m]) => m);

        const rangeTotals = {};
        records.forEach(r => {
          const [y,m,d] = r.date.split("-");
          const ym = `${y}-${m}`;
          if (!qualifiedMonths.includes(ym)) return;
          if (parseInt(d) <= targetRangeEnd) {
            if (!rangeTotals[ym]) rangeTotals[ym] = 0;
            rangeTotals[ym] += parseFloat(r.amount || 0);
          }
        });
        const totalPast = Object.values(rangeTotals).reduce((s,v)=>s+v,0);
        const averagePast = Math.round(totalPast / (Object.keys(rangeTotals).length || 1));
        const currentMonthN = toDateSales;
        const diffFromAvg = currentMonthN - averagePast;

        const compareAvgDiv = document.createElement('div');
        compareAvgDiv.style.marginTop = '4px';
        compareAvgDiv.style.color = diffFromAvg > 0 ? 'green' : diffFromAvg < 0 ? 'crimson' : 'gray';
        compareAvgDiv.innerHTML =
          `📊 รวมเฉพาะ ${targetRangeEnd} วัน คือ: ${currentMonthN.toLocaleString()} บาท ${
            diffFromAvg > 0 ? `✅ มากกว่าค่าเฉลี่ย +${diffFromAvg.toLocaleString()} บาท (${averagePast.toLocaleString()})` :
            diffFromAvg < 0 ? `⚠️ น้อยกว่าค่าเฉลี่ย ${Math.abs(diffFromAvg).toLocaleString()} บาท (${averagePast.toLocaleString()})` :
            `😐 เท่ากับค่าเฉลี่ย (${averagePast.toLocaleString()} บาท)`}`;
        compareEl.appendChild(compareAvgDiv);
      }

      // วันนี้ / สัปดาห์นี้ (อิงเดือนปัจจุบันเท่านั้น)
      let todaySales = 0, weekSales = 0;
      const todayObj = new Date();
      const dow = todayObj.getDay();
      const curM = viewingDate.getMonth(), curY = viewingDate.getFullYear();
      let monday = new Date(todayObj); monday.setDate(todayObj.getDate() - ((dow + 6) % 7));
      if (monday.getMonth() !== curM) monday = new Date(curY, curM, 1);
      const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);

      records.forEach(r => {
        const rd = new Date(r.date);
        const amt = parseFloat(r.amount || 0);
        const sameDate = rd.getFullYear()===todayObj.getFullYear() && rd.getMonth()===todayObj.getMonth() && rd.getDate()===todayObj.getDate();
        if (sameDate) todaySales += amt;

        const inCurrentMonth = rd.getMonth()===curM && rd.getFullYear()===curY;
        if (rd >= monday && rd <= sunday && inCurrentMonth) weekSales += amt;
      });

      const extraInfo = document.createElement("div");
      extraInfo.style.marginTop = "6px"; extraInfo.style.fontSize = "10px"; extraInfo.style.color = "green";
      extraInfo.innerHTML = `<span style="color: green; font-size: 10px;"> วันนี้: ${todaySales.toLocaleString()} บาท สัปดาห์นี้ (${monday.getDate()}–${sunday.getDate()}): ${weekSales.toLocaleString()} บาท</span>`;
      compareEl.appendChild(extraInfo);
    }

    // ===== ประมวลหมวด / ลูกค้าในช่วงที่เลือก =====
    const categoryCounts = {}, categoryDetails = {}, customerMap = {};
    records.filter(activeFilter).forEach(r => {
      const key = `${r.name}|${r.phone}`;
      if (!customerMap[key]) customerMap[key] = { name:r.name, phone:r.phone, opd:r.opd||'-', date:r.date, amount:0 };
      customerMap[key].amount += parseFloat(r.amount||0);
      if (r.date > customerMap[key].date) customerMap[key].date = r.date;

      (r.items || []).forEach(item => {
        const match = item.match(/\((.*?)\)/);
        const subItem = match ? match[1] : item;
        const qtyMatch = item.match(/- (\d+) ชิ้น x (\d+)/);
        const qty = qtyMatch ? parseInt(qtyMatch[1]) : 0;
        const categoryMatch = item.match(/^(.+?) ?\(/);
        const category = categoryMatch ? categoryMatch[1].trim() : "อื่นๆ";

        if (!categoryCounts[category]) categoryCounts[category] = 0;
        if (!categoryDetails[category]) categoryDetails[category] = {};
        categoryCounts[category] += qty;
        (categoryDetails[category][subItem] ||= { qty:0, total:0 }).qty += qty;
      });
    });

    // สรุปหมวด
    const sortedEntries = Object.entries(categoryCounts).sort((a,b)=>b[1]-a[1]);
    document.getElementById('summaryList').innerHTML = sortedEntries.map(([cat]) => {
      const items = Object.entries(categoryDetails[cat] || {}).map(([sub, d]) => `• ${sub} ${d.qty}`).join('<br>');
      const sumQty = categoryCounts[cat];
      return `
        <div class="summary-group" style="cursor:pointer;" onclick="openGroupModalByCategory('${cat}')">
          <strong>${cat}</strong> รวม ${sumQty} ชิ้น
          <ul>${items}</ul>
        </div>`;
    }).join('');

    // Top 10
    const top10 = Object.values(customerMap).sort((a,b)=>b.amount-a.amount).slice(0,10);
    document.getElementById('top10List').innerHTML = top10.map((c) => {
      const key = `${c.name}|${c.phone}`;
      const allRec = allCustomerRecords.filter(r => `${r.name}|${r.phone}` === key);

      const totalVisits = allRec.length;
      const paid = allRec.filter(r => parseFloat(r.amount||0) > 0);
      const paidVisits = paid.length;
      const totalAmount = paid.reduce((s,r)=>s+parseFloat(r.amount),0);
      const avg = paidVisits>0 ? Math.round(totalAmount/paidVisits) : 0;

      const latest = allRec.length? new Date(Math.max(...allRec.map(r=>new Date(r.date)))):null;
      const daysSinceLastVisit = latest? Math.floor((new Date()-latest)/(1000*60*60*24)) : null;

      let absentColor = 'gray';
      if (daysSinceLastVisit < 30) absentColor = 'green';
      else if (daysSinceLastVisit <= 90) absentColor = 'orange';
      else absentColor = 'crimson';

      let totalColor='gray', totalExtra='', totalIcon='';
      if (totalAmount < 50000) totalColor='crimson';
      else if (totalAmount <= 99999) totalColor='green';
      else if (totalAmount <= 200000) totalColor='goldenrod';
      else { totalColor='#8B6508'; totalExtra='font-weight:bold;'; totalIcon=' 💎'; }

      let avgColor='gray';
      if (avg < 5000) avgColor='crimson';
      else if (avg <= 9999) avgColor='green';
      else avgColor='#b8860b';

      const lastVisitText = daysSinceLastVisit != null
        ? `<span style="color:${absentColor};">🔚 ไม่มา ${daysSinceLastVisit} วัน</span>` : `<span>🔚 ไม่มีข้อมูล</span>`;

      // ลูกค้าใหม่: ไม่มีรายการก่อนช่วง (หรือก่อนเดือนปัจจุบันเมื่อไม่ใช้ช่วง)
      const isNewCustomer = monthRange.enabled
        ? allRec.filter(r => ymNum(dateYM(r.date)) < ymNum(monthRange.startYM)).length === 0
        : allRec.filter(r => r.date < `${formatYM(viewingDate)}-01`).length === 0;
      const newBadge = isNewCustomer ? `<span style="color:red; font-weight:bold;"> ลูกค้าใหม่</span>` : "";

      return `
      <li style="margin-bottom: 8px;">
        <span class="name" style="cursor:pointer;" onclick="openCustomerModal('${key}')">${c.name}${newBadge}</span>
        <span class="date">
          (💳 <span style="color:${avgColor};">${avg.toLocaleString()}</span> × ${totalVisits}
           | 💰 <span style="color:${totalColor}; ${totalExtra}">${totalAmount.toLocaleString()}${totalIcon}</span>
           | ${lastVisitText})
        </span>
        <span class="amount">${c.amount.toLocaleString()} บาท</span>
      </li>`;
    }).join('');

    document.getElementById('totalCustomer').textContent =
      `จำนวนลูกค้าที่มาใช้บริการทั้งหมด ${Object.keys(customerMap).length} คน (กดดูเพิ่มเติม)`;
  }

  fetchDataAndUpdate();
  fetchAllCustomerRecords();

  // ===== กลุ่มหมวด (modal) =====
  function openGroupModalByCategory(cat) {
    const summary = {};
    const totalQty = { count: 0 };

    const catElement = Array.from(document.querySelectorAll(".summary-group"))
      .find(group => group.querySelector("strong")?.textContent === cat);
    const catText = catElement?.innerText || "";

    allSalesRecords.filter(activeFilter).forEach(r => {
      (r.items || []).forEach(item => {
        const match = item.match(/\((.*?)\)/);
        const subItem = match ? match[1] : item.split(" - ")[0].trim();

        const qtyMatch = item.match(/- (\d+) ชิ้น/);
        const qty = qtyMatch ? parseInt(qtyMatch[1]) : 1;

        if (!catText.includes(subItem) && !catText.includes(item)) return;

        if (!summary[subItem]) summary[subItem] = {};
        const key = `${r.name}|${r.phone}`;
        if (!summary[subItem][key]) summary[subItem][key] = { name: r.name, dates: {} };
        summary[subItem][key].dates[r.date] = (summary[subItem][key].dates[r.date] || 0) + qty;

        totalQty.count += qty;
      });
    });

    const html = Object.entries(summary).map(([productName, buyers]) => {
      const buyerLines = Object.values(buyers).map(c => {
        const dateParts = Object.entries(c.dates)
          .sort(([a],[b]) => a.localeCompare(b))
          .map(([date, qty]) => {
            const thDate = new Date(date).toLocaleDateString('th-TH',{ day:'numeric', month:'short' });
            return `${thDate} = ${qty}`;
          }).join(" | ");
        return `👤 <strong>${c.name}</strong>: ${dateParts}`;
      }).join("<br>");

      return `<div style="margin-bottom:15px;">
        <div style="font-weight:bold; color:#00796b; margin-bottom:5px;">🔹 ${productName}</div>
        <div>${buyerLines}</div>
      </div>`;
    }).join("");

    document.getElementById("groupSelectedList").innerHTML = `
      <div class="group-header">
        📦 รายการในหมวด: ${cat}<br>
        ✅ รวมทั้งหมด <strong style="font-size: 18px; color: #00796b;">${totalQty.count}</strong> ชิ้น
      </div>
      ${html || '<div style="padding:10px; color:#888;">ไม่มีข้อมูลในช่วงนี้</div>'}
    `;
    document.getElementById("group-modal").style.display = "flex";
  }
  function closeGroupModal() { document.getElementById("group-modal").style.display = "none"; }
  document.getElementById("group-modal").addEventListener("click", function (e) {
    const content = document.getElementById("group-modal-content");
    if (!content.contains(e.target)) closeGroupModal();
  });
  function saveGroupModalAsImage() {
    const node = document.getElementById("group-modal-content");
    if (!node) return;
    html2canvas(node, { scale: 2 }).then(canvas => {
      const a = document.createElement("a");
      a.download = 'group-summary.jpg';
      a.href = canvas.toDataURL("image/jpeg", 0.95);
      a.click();
    });
  }

  // ===== รายการเพิ่มเติม =====
  function toggleCustomerList() {
    const listEl = document.getElementById("allCustomerList");

    if (listEl.style.display === "none") {
      listEl.style.display = "block";
      const customerMap = {};
      allSalesRecords.filter(activeFilter).forEach(r => {
        const key = `${r.name}|${r.phone}`;
        if (!customerMap[key]) customerMap[key] = { name:r.name, phone:r.phone, opd:r.opd||"-", date:r.date, amount:0 };
        customerMap[key].amount += parseFloat(r.amount || 0);
        if (r.date > customerMap[key].date) customerMap[key].date = r.date;
      });

      const customerList = Object.values(customerMap).sort((a,b)=>b.amount-a.amount).slice(10);

      listEl.innerHTML = customerList.map((c, i) => {
        const key = `${c.name}|${c.phone}`;
        const allRec = allCustomerRecords.filter(r => `${r.name}|${r.phone}` === key);

        const totalVisits = allRec.length;
        const paid = allRec.filter(r => parseFloat(r.amount||0) > 0);
        const paidVisits = paid.length;
        const totalAmount = paid.reduce((s,r)=>s+parseFloat(r.amount),0);
        const avg = paidVisits>0 ? Math.round(totalAmount/paidVisits) : 0;

        const latest = allRec.length? new Date(Math.max(...allRec.map(r=>new Date(r.date)))):null;
        const daysSinceLastVisit = latest? Math.floor((new Date()-latest)/(1000*60*60*24)) : null;

        let absentColor='gray';
        if (daysSinceLastVisit < 30) absentColor='green';
        else if (daysSinceLastVisit <= 90) absentColor='orange';
        else absentColor='crimson';

        let totalColor='gray', totalExtra='', totalIcon='';
        if (totalAmount < 50000) totalColor='crimson';
        else if (totalAmount <= 99999) totalColor='green';
        else if (totalAmount <= 200000) totalColor='goldenrod';
        else { totalColor='#8B6508'; totalExtra='font-weight:bold;'; totalIcon=' 💎'; }

        let avgColor='gray';
        if (avg < 5000) avgColor='crimson';
        else if (avg <= 9999) avgColor='green';
        else avgColor='#b8860b';

        const lastVisitText = daysSinceLastVisit != null
          ? `<span style="color:${absentColor};">🔚 ไม่มา ${daysSinceLastVisit} วัน</span>` : `<span>🔚 ไม่มีข้อมูล</span>`;

        const isNewCustomer = monthRange.enabled
          ? allRec.filter(r => ymNum(dateYM(r.date)) < ymNum(monthRange.startYM)).length === 0
          : allRec.filter(r => r.date < `${formatYM(viewingDate)}-01`).length === 0;
        const newBadge = isNewCustomer ? `<span style="color:red; font-weight:bold;"> ลูกค้าใหม่</span>` : "";

        return `
        <li style="margin-bottom: 8px;">
          <span class="name" style="cursor:pointer;" onclick="openCustomerModal('${key}')">${i+11}. ${c.name}${newBadge}</span>
          <span class="date">
            (💳 <span style="color:${avgColor};">${avg.toLocaleString()}</span> × ${totalVisits}
             | 💰 <span style="color:${totalColor}; ${totalExtra}">${totalAmount.toLocaleString()}${totalIcon}</span>
             | ${lastVisitText})
          </span>
          <span class="amount">${c.amount.toLocaleString()} บาท</span>
        </li>`;
      }).join('');
    } else {
      listEl.style.display = "none";
    }
  }
  function refreshCustomerList(){ const listEl = document.getElementById("allCustomerList"); if(listEl.style.display==="block"){ listEl.style.display="none"; toggleCustomerList(); } }
  function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }

  // ===== Modal ลูกค้า =====
  function escapeHTML(s=''){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
  function closeCustomerModal(){ document.getElementById("customer-modal").style.display = "none"; }
  function formatDate(d){ if(!d) return ''; const [y,m,day]=d.split('-'); return `${day}/${m}/${y.slice(-2)}`; }

  function openCustomerModal(key) {
    const records = allCustomerRecords.filter(r => `${r.name}|${r.phone}` === key);
    if(!records.length) return;

    const first = records[0];
    const customer = { name:first.name, phone:first.phone||'-', opd:first.opd||'-' };

    const latestRecord = records.reduce((latest,r)=> new Date(r.date) > new Date(latest.date)? r:latest, records[0]);

    const lastDate = new Date(latestRecord.date);
    const today = new Date();
    const daysAbsent = Math.floor((today - lastDate)/(1000*60*60*24));

    const totalVisits = records.length;
    const paidRecords = records.filter(r => parseFloat(r.amount||0) > 0);
    const paidVisits = paidRecords.length;
    const totalAmount = paidRecords.reduce((s,r)=>s+parseFloat(r.amount),0);
    const average = paidVisits>0 ? Math.round(totalAmount/paidVisits) : 0;

    const allItems = {};
    records.forEach(r => {
      (r.items||[]).forEach(item=>{
        let name = item;
        const m = item.match(/\((.*?)\)/); name = m? m[1] : item.split(" - ")[0];
        const q = item.match(/- (\d+) ชิ้น/); const qty = q? parseInt(q[1]) : 1;
        allItems[name] = (allItems[name]||0) + qty;
      });
    });

    const categoryMap = {
      "โบทอค":["Aestox 50 u","Aestox 100 u","Allergan 50 u","Allergan 100 u","เฉพาะจุด","แบ่งไว้แล้ว"],
      "ฟิลเลอร์":["Neuramis สีดำ","Neuramis สีทอง","E.P.T.Q ระบุสีด้วย","Restylane ระบุสีด้วย"],
      "งานผิว":["Meso Chanel","P - Cell","Aquatic","Hestina","Exosome","Rejuran","Belotero Revive","Sculptra","Juvelook","Aesthefill","Mesowink","AlphaArbutin","PRP"],
      "ดริปผิว":["Snow White","Super Aurawhite","Vitamin Mix","Brain Booster","Energy Booster"],
      "ทรีทเม้นท์":["ทรีทเมนต์หน้าใส","ทรีทเมนต์สิว","ทรีทเมนต์ฝ้า"],
      "Fat/Hifu":["Bromi","Sisi","HIFU","HIFU แถม"],
      "อื่นๆ":["ยาฉีดสลายฝ้า","ครีมทาฝ้า","ยาทานฝ้า","ไหมลิฟท์กรอบหน้า","ไหม PDO","ไหม Collagen","จ่ายเงิน/จองสินค้า"],
      "โปรโมชั่น/อีเว้นพิเศษ":["สลายฟิลเลอร์","ไหม PDO","ปั่น RF","ไหมลิฟท์กรอบหน้า","ผลักวิตามิน"]
    };

    const categorizedItems = {};
    for (const [cat, names] of Object.entries(categoryMap)) {
      names.forEach(n => {
        if (allItems[n]) {
          (categorizedItems[cat] ||= []).push(`${n} : ${allItems[n]}`);
          delete allItems[n];
        }
      });
    }
    if (Object.keys(allItems).length) categorizedItems["อื่นๆ"] =
      Object.entries(allItems).map(([n,q])=>`${n} : ${q}`);

    const itemSummary = Object.entries(categorizedItems)
      .map(([cat,items])=>`<div style="margin-bottom:6px;"><strong>${cat}</strong>: ${items.join(" | ")}</div>`).join("");

    const historyHtml = records.sort((a,b)=>b.date.localeCompare(a.date)).map(r=>{
      const items = (r.items||[]).map(item=>{
        const m = item.match(/\((.*?)\)/);
        const name = m? m[1] : item.split(" - ")[0];
        const q = item.match(/- (\d+) ชิ้น/); const qty = q? parseInt(q[1]) : 1;
        return `<li>${name} : ${qty}</li>`;
      }).join("");
      const noteText = r.note ? `<div style="margin-top:2px; font-style:italic; color:#444;">📝 หมายเหตุ: ${escapeHTML(r.note)}</div>` : "";
      return `
        <div style="margin-bottom:16px;">
          <div style="margin-bottom:4px;font-weight:bold;">📅 ${formatDate(r.date)}</div>
          <ul style="padding-left:16px;margin:0;">${items}</ul>
          <div style="margin-top:4px;color:#00796b;">💵 ยอด: ${parseFloat(r.amount||0).toLocaleString()} บาท</div>
          ${noteText}
          <hr style="margin: 10px auto; border: 0; border-top: 1px dashed #999; width: 60%;">
        </div>`;
    }).join("");

    const daysAbsentText = `<span style="color:red;">(ไม่ได้มาแล้ว: ${daysAbsent} วัน)</span>`;

    document.getElementById("modal-content").innerHTML = `
      <div style="position:absolute; top:10px; right:10px; display:flex; gap:10px;">
        <button onclick="saveModalAsImage()" title="บันทึกเป็นรูปภาพ" style="background:white; border:none; border-radius:50%; width:36px; height:36px; box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer; display:flex; align-items:center; justify-content:center;">💾</button>
        <button onclick="closeCustomerModal()" title="ปิดหน้าต่าง" style="background:white; border:none; border-radius:50%; width:36px; height:36px; box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer; display:flex; align-items:center; justify-content:center;">❌</button>
      </div>

      <h3 style="font-size:18px;margin-bottom:4px;">📇 ${customer.name}</h3>
      <div>🆔 <strong>OPD:</strong> ${customer.opd}</div>
      <div>📞 <strong>เบอร์:</strong> ${customer.phone}</div>
      <div>📅 <strong>วันล่าสุด:</strong> ${formatDate(latestRecord.date)} ${daysAbsentText}</div>
      <div style="color:#00796b;"><strong>💰 ยอดรวม:</strong> ${totalAmount.toLocaleString()} บาท</div>
      <div>🔁 มาใช้บริการ: ${totalVisits} ครั้ง (${paidVisits} ครั้งจ่ายเงิน)</div>
      <div>💳 <strong>เฉลี่ยต่อครั้ง:</strong> ${Math.round(average).toLocaleString()} บาท</div>

      <hr style="margin: 16px auto 8px; border: 0; border-top: 1px solid #ccc; width: 60%;">
      <div style="font-weight:bold;">📦 สรุปรายการซื้อทั้งหมด:</div>
      <div style="margin:6px 0 12px;">${itemSummary}</div>
      <hr style="margin: 16px auto 8px; border: 0; border-top: 1px solid #ccc; width: 60%;">
      <div style="font-weight:bold;margin-bottom:6px;">🛍️ ประวัติการซื้อย้อนหลัง:</div>
      ${historyHtml}
      <div style="margin-top:10px;font-weight:bold;color:#b8860b;">💰 รวมทั้งหมด: ${totalAmount.toLocaleString()} บาท</div>`;
    document.getElementById("customer-modal").style.display = "flex";
  }

  function saveModalAsImage() {
    const node = document.getElementById("modal-content");
    if (!node) return alert("ไม่พบเนื้อหาใน modal");
    html2canvas(node, { scale: 2 }).then(canvas => {
      const dataUrl = canvas.toDataURL("image/jpeg", 0.95);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      if (isIOS) {
        const previewArea = document.createElement("div");
        previewArea.style.marginTop = "20px";
        previewArea.innerHTML = `<div style="font-weight:bold; margin-bottom:6px;">แตะค้างที่ภาพด้านล่างเพื่อบันทึกรูป</div><img src="${dataUrl}" style="width:100%; border:1px solid #ccc; border-radius:12px;">`;
        const existing = document.getElementById("modalImagePreview"); if (existing) existing.remove();
        previewArea.id = "modalImagePreview";
        node.appendChild(previewArea);
      } else {
        const link = document.createElement("a"); link.download = 'customer-info.jpg'; link.href = dataUrl; link.click();
      }
    });
  }

  // ปิด modal เมื่อคลิกนอกกล่อง
  document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("customer-modal");
    const box = document.getElementById("customer-modal-box");
    if (modal && box) modal.addEventListener("click", e => { if (!box.contains(e.target)) closeCustomerModal(); });
  });

  // ===== ฟิลเตอร์ส่วนค้นหา (โค้ดเดิมคงไว้) =====
  const productCategories = {
    "โบทอค": ["Aestox 50 u", "Aestox 100 u", "Allergan 50 u", "Allergan 100 u"],
    "ฟิลเลอร์": ["Neuramis สีดำ", "Neuramis สีทอง", "E.P.T.Q", "Restylane"],
    "งานผิว": ["Meso Chanel", "P - Cell", "Aquatic", "Hestina", "Exosome", "Rejuran", "Belotero Revive", "Sculptra", "Juvelook", "Aesthefill"],
    "ดริปผิว": ["Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster"],
    "ทรีทเม้นท์": ["ทรีทเมนต์หน้าใส", "ทรีทเมนต์สิว", "ทรีทเมนต์ฝ้า"],
    "Fat/Hifu": ["Bromi", "Sisi", "HIFU", "HIFU แถม"],
    "อื่นๆ": ["ยาฉีดสลายฝ้า", "ครีมทาฝ้า", "ยาทานฝ้า", "ไหมลิฟท์กรอบหน้า", "ไหม PDO", "ไหม Collagen"]
  };

  const filterUI = document.createElement("div");
  filterUI.style.cssText = "margin: 40px auto 20px; padding: 20px; background: #fefefe; border: 1px solid #e0e0e0; border-radius: 12px; max-width: 1100px; font-size: 13px; line-height: 1.6; font-family: 'Prompt', sans-serif; box-shadow: 0 3px 10px rgba(0,0,0,0.03);";
  filterUI.innerHTML = `
    <div class="filter-section">
      <h3>🔍 ฟิลเตอร์ค้นหาลูกค้า</h3>
      <div class="product-row">
        <label>🧴 สินค้าที่เคยซื้อ:</label>
        <button type="button" class="add-product-button" onclick="addProductSelect()">➕ เพิ่มสินค้า</button>
      </div>
      <div id="productListContainer" class="product-list-container"></div>

      <div class="inline-field">
        <label>📅 ช่วงเวลา:</label>
        <div class="input-pair">
          <input type="date" id="startDate">
          <span>-</span>
          <input type="date" id="endDate">
        </div>
      </div>

      <div class="inline-field">
        <label>💰 ยอดรวมทั้งหมด (บาท):</label>
        <div class="input-pair">
          <input type="number" id="minTotal" placeholder="ขั้นต่ำ">
          <span>-</span>
          <input type="number" id="maxTotal" placeholder="สูงสุด">
        </div>
      </div>

      <div class="inline-field">
        <label>📄 จำนวนครั้งที่เคยมาคลินิก:</label>
        <div class="input-pair">
          <input type="number" id="minVisits" placeholder="ขั้นต่ำ">
          <span>-</span>
          <input type="number" id="maxVisits" placeholder="สูงสุด">
        </div>
      </div>

      <div class="inline-field">
        <label>⏳ จำนวนวันที่ไม่ได้มาคลินิก:</label>
        <div class="input-pair">
          <input type="number" id="minAbsent" placeholder="ขั้นต่ำ">
          <span>-</span>
          <input type="number" id="maxAbsent" placeholder="สูงสุด">
        </div>
      </div>

      <div class="inline-field">
        <label>💳 ยอดเฉลี่ยต่อบิล (บาท):</label>
        <div class="input-pair">
          <input type="number" id="minAvg" placeholder="ขั้นต่ำ">
          <span>-</span>
          <input type="number" id="maxAvg" placeholder="สูงสุด">
        </div>
      </div>

      <div class="inline-field">
        <label>👤 ชื่อลูกค้า:</label>
        <input type="text" id="customerName" placeholder="ระบุชื่อลูกค้า">
      </div>

      <button type="button" onclick="filterGeneral()" class="search-button">ค้นหา</button>
      <button type="button" onclick="resetFilters()" class="add-product-button" style="margin-left: 10px;">รีเซ็ตค่า</button>
      <button type="button" onclick="openGroupModal()" class="add-product-button" style="margin-left: 10px;">ดูรายการที่เลือก</button>
    </div>
    <div id="filterResults" style="margin-top: 24px; font-size: 13px;"></div>`;
  document.body.appendChild(filterUI);

  function addProductSelect() {
    const container = document.getElementById("productListContainer");
    const wrapper = document.createElement("div"); wrapper.style.marginBottom = "6px";
    const select = document.createElement("select"); select.className = "productInput"; select.style.cssText = "width: 240px; padding: 4px; font-size: 13px;";
    const def = document.createElement("option"); def.textContent = "กดเพื่อเลือกสินค้า"; def.value = ""; def.disabled = true; def.selected = true; select.appendChild(def);
    Object.entries(productCategories).forEach(([cat, items]) => {
      const group = document.createElement("optgroup"); group.label = cat;
      items.forEach(p => { const option = document.createElement("option"); option.value = p; option.textContent = p; group.appendChild(option); });
      select.appendChild(group);
    });
    wrapper.appendChild(select); container.appendChild(wrapper);
  }

  function filterGeneral() {
    const nameInput = document.getElementById("customerName").value.trim().toLowerCase();
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    const minTotal = parseFloat(document.getElementById("minTotal").value) || 0;
    const maxTotal = parseFloat(document.getElementById("maxTotal").value) || Infinity;
    const minVisits = parseInt(document.getElementById("minVisits").value) || 0;
    const maxVisits = parseInt(document.getElementById("maxVisits").value) || Infinity;
    const minAbsent = parseInt(document.getElementById("minAbsent").value) || 0;
    const maxAbsent = parseInt(document.getElementById("maxAbsent").value) || Infinity;
    const minAvg = parseFloat(document.getElementById("minAvg").value) || 0;
    const maxAvg = parseFloat(document.getElementById("maxAvg").value) || Infinity;

    const selectedProducts = Array.from(document.querySelectorAll('.productInput')).map(el => el.value).filter(Boolean);

    const grouped = {};
    const today = new Date();

    allCustomerRecords.forEach(r => {
      const key = `${r.name}|${r.phone}`;
      (grouped[key] ||= []).push(r);
    });

    const results = Object.entries(grouped).map(([key, records]) => {
      const name = records[0].name;

      const totalVisits = records.length;
      const paidRecords = records.filter(r => parseFloat(r.amount || 0) > 0);
      const paidVisits = paidRecords.length;
      const totalAmount = paidRecords.reduce((sum, r) => sum + parseFloat(r.amount), 0);
      const averageBill = paidVisits > 0 ? totalAmount / paidVisits : 0;

      const latestRecord = records.reduce((latest, r) =>
        new Date(r.date) > new Date(latest.date) ? r : latest,
        records[0]
      );

      const absentDays = Math.floor((today - new Date(latestRecord.date)) / (1000 * 60 * 60 * 24));
      const lastVisit = latestRecord.date;

      const allProducts = records.flatMap(r => r.items || []).map(item => {
        const match = item.match(/\((.*?)\)/);
        return match ? match[1] : item.split(" - ")[0].trim();
      });

      return { key, name, totalAmount, totalVisits, paidVisits, averageBill, absentDays, lastVisit, products: allProducts };
    }).filter(c => {
      const nameMatch = !nameInput || c.name.toLowerCase().includes(nameInput);
      const totalMatch = c.totalAmount >= minTotal && c.totalAmount <= maxTotal;
      const visitMatch = c.totalVisits >= minVisits && c.totalVisits <= maxVisits;
      const absentMatch = c.absentDays >= minAbsent && c.absentDays <= maxAbsent;
      const avgMatch = c.averageBill >= minAvg && c.averageBill <= maxAvg;
      const dateMatch = (!startDate || new Date(c.lastVisit) >= new Date(startDate)) && (!endDate || new Date(c.lastVisit) <= new Date(endDate));
      const productMatch = selectedProducts.length === 0 || selectedProducts.every(p => c.products.some(prod => prod.includes(p)));
      return nameMatch && totalMatch && visitMatch && absentMatch && avgMatch && dateMatch && productMatch;
    }).sort((a, b) => b.totalAmount - a.totalAmount);

    const html = results.map(c => {
      const formattedDate = new Date(c.lastVisit).toLocaleDateString('th-TH',{day:'numeric', month:'short', year:'2-digit'});
      return `<div>
        <input type="checkbox" class="selectCustomerCheckbox" value="${c.key}" style="margin-right:6px; vertical-align: middle;">
        📇 <strong style="cursor:pointer;color:#00796b;" onclick="openCustomerModal('${c.key}')">${c.name}</strong>
        💰 ยอด: ${c.totalAmount.toLocaleString()} |
        💳 ${Math.round(c.averageBill).toLocaleString()} |
        🔁 ${c.totalVisits} (${c.paidVisits} จ่าย) |
        ⏱️ ${c.absentDays} วัน |
        ${formattedDate}
      </div><hr>`;
    }).join('');

    document.getElementById("filterResults").innerHTML = `<h4>ผลลัพธ์ ${results.length} คน</h4>` + html;
  }

  // เมนูลอย
  function toggleFloatingMenu(){ const menu = document.getElementById("floatingMenu"); menu.style.display = (menu.style.display==="flex")?"none":"flex"; }
  document.addEventListener('click', function(e) {
    const toggle = document.getElementById("floatingToggle");
    const menu = document.getElementById("floatingMenu");
    if (!toggle.contains(e.target) && !menu.contains(e.target)) menu.style.display = "none";
  });
</script>

<div id="floatingToggle" class="floating-toggle" onclick="toggleFloatingMenu()">
  <img src="{{ url_for('static', filename='icon/icon_menu_toggle.png') }}" alt="menu" style="width:60px;height:60px;">
</div>

<div id="floatingMenu" class="floating-menu">
  <a href="{{ url_for('dashboard') }}"><img src="{{ url_for('static', filename='icon/icon_dashboard.png') }}"></a>
  <a href="{{ url_for('sale_summary') }}"><img src="{{ url_for('static', filename='icon/icon_sale_summary.png') }}"></a>
  <a href="{{ url_for('record_sales') }}"><img src="{{ url_for('static', filename='icon/icon_record_sales.png') }}"></a>
  <a href="{{ url_for('customer_list') }}"><img src="{{ url_for('static', filename='icon/icon_customer_list.png') }}"></a>
  <a href="{{ url_for('record_customer') }}"><img src="{{ url_for('static', filename='icon/icon_customer_history.png') }}"></a>
  <a href="{{ url_for('oldsaledata') }}"><img src="{{ url_for('static', filename='icon/icon_old_customers.png') }}"></a>
  <a href="{{ url_for('inventory') }}"><img src="{{ url_for('static', filename='icon/icon_inventory.png') }}"></a>
  <a href="#"><img src="{{ url_for('static', filename='icon/icon_staff.png') }}"></a>
  <a href="{{ url_for('appointments') }}"><img src="{{ url_for('static', filename='icon/icon_appointments.png') }}"></a>
</div>
</body>
</html>
