<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Prompt', 'Segoe UI', sans-serif;
      margin: 0;
      background-color: white;
      padding: 10px;
       padding-bottom: 120px;
    }
    .menu-bar {
      display: flex;
      justify-content: space-around;
      background-color: white;
      padding: 10px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .menu-bar a {
      text-decoration: none;
      font-weight: bold;
      color: teal;
    }

    .month-nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .month-nav button {
      background-color: #009688;
      color: white;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .month-nav button:hover {
      background-color: #00796b;
    }

    #mainTitle {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #e0f2f1;
      border-radius: 16px;
      padding: 20px 30px;
      margin: 0 auto 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      max-width: fit-content;
      text-align: center;
    }
    #mainTitle .month {
      font-size: 26px;
      font-weight: 600;
      color: #004d40;
    }
    #mainTitle .total {
      font-size: 18px;
      color: #009688;
      margin-top: 6px;
    }

    .top10-box {
      max-width: 1200px;
      margin: 0 auto 20px;
      background: #fff;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    .top10-box h3 {
      margin-top: 0;
      color: teal;
      font-size: 18px;
      text-align: center;
    }
    .top10-box ul {
      list-style: none;
      padding-left: 0;
    }
    .top10-box li {
      margin-bottom: 6px;
      padding: 4px 0;
      border-bottom: 1px dashed #ddd;
    }
    .top10-box li span.name {
      font-weight: 600;
      color: #333;
    }
    .top10-box li span.date {
      font-size: 13px;
      color: #999;
      margin-left: 6px;
    }
    .top10-box li span.amount {
      float: right;
      color: #009688;
      font-weight: 600;
    }

    .chart-summary-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto 20px;
      flex-wrap: wrap;
    }

    .chart-container {
      flex: 1;
      background: #fff;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    canvas {
      width: 100% !important;
      height: 300px !important;
    }

    .summary-list {
      flex: 1;
      background: #fff;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      font-size: 14px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }
    .summary-group ul {
      list-style: none;
      padding-left: 20px;
      margin: 5px 0 10px;
    }
    .summary-group li {
      margin-bottom: 4px;
    }
    .summary-group strong {
      color: #00796b;
      display: block;
      margin-bottom: 6px;
      font-size: 15px;
    }

    @media (max-width: 768px) {
      .chart-summary-row {
        flex-direction: column;
      }
      .summary-list {
        grid-template-columns: 1fr;
      }
    }

      .floating-dock {
  position: fixed;
  bottom: 8px;
  left: 50%;
  transform: translateX(-50%);
  background: rgb(249, 249, 249); /* ‡∏Ç‡∏≤‡∏ß */

  border-radius: 24px;
  padding: 4px 4px;
  display: flex;
  gap: 2px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  z-index: 1000;
}

.icon-button {
  width: 74px;
  height: 74px;
  padding: 4px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s ease;
  text-decoration: none;
}

.icon-button:hover {
  transform: scale(1.1);
}

.icon-button img {
  width: 74px;
  height: 74px;
  object-fit: contain;
}

  </style>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div id="customer-modal" style="display:none;position:fixed;inset:0;background-color:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;">
  <div style="background:white;padding:20px;border-radius:16px;width:90%;max-width:400px;max-height:90vh;overflow:auto;position:relative; font-size:13.5px;">

    <button onclick="closeCustomerModal()" style="position:absolute;top:10px;right:14px;font-size:20px;border:none;background:none;cursor:pointer;">&times;</button>
    <div id="modal-content"></div>
  </div>
</div>

  <div class="month-nav">
    <button onclick="changeMonth(-1)">‚Üê ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
    <button onclick="changeMonth(1)">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
  </div>

  <div id="mainTitle">
    <div class="month"></div>
    <div class="total"></div>
    <div class="compare" style="font-size: 13px; margin-top: 6px;"></div>
  </div>

  <div class="top10-box">
    <h3>Top 10 ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
    <ul id="top10List"></ul>
    <p id="totalCustomer" onclick="toggleCustomerList()" style="text-align:center; margin-top: 10px; font-weight: bold; color: teal; cursor: pointer;"></p>
<ul id="allCustomerList" style="display:none; padding-top: 10px;"></ul>

  </div>

  <div class="chart-summary-row">
        <div class="summary-list" id="summaryList"></div>
  </div>

  <script>
    const categoryMap = {
    "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": ["Aestox 50 u", "Aestox 100 u", "Allergan 50 u", "Allergan 100 u"],
    "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥", "Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á", "E.P.T.Q ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢", "Restylane ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢"],
    "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": ["Meso Chanel", "P - Cell", "Aquatic", "Hestina", "Exosome", "Rejuran", "Belotero Revive", "Sculptra", "Juvelook", "Aesthefill"],
    "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster"],
    "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": ["‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤"],
    "Fat/Hifu": ["Bromi", "Sisi", "HIFU", "HIFU ‡πÅ‡∏ñ‡∏°"],
    "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": ["‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤", "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤", "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÑ‡∏´‡∏° PDO", "‡πÑ‡∏´‡∏° Collagen", "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô/‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"]
  };

  let viewingDate = new Date();
  let chartInstance = null;

  function changeMonth(delta) {
    viewingDate.setMonth(viewingDate.getMonth() + delta);
    fetchDataAndUpdate();
  }

  function fetchAllCustomerRecords() {
  fetch("/api/sales")  // ‡πÉ‡∏ä‡πâ endpoint ‡πÄ‡∏î‡∏¥‡∏°
    .then(res => res.json())
    .then(records => {
      allCustomerRecords = records;
    })
    .catch(err => {
      console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
    });
}

  function fetchDataAndUpdate() {
    fetch("/api/sales")
      .then(res => res.json())
      .then(records => updateDashboard(records))
      .catch(err => {
        console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢");
      });
  }

  function updateDashboard(records) {
    const monthName = viewingDate.toLocaleString('th-TH', { month: 'long' });
    const yearBE = viewingDate.getFullYear() + 543;
    const prefix = viewingDate.toISOString().slice(0, 7);

    document.querySelector('#mainTitle .month').textContent = `${monthName} ${yearBE}`;

    let totalSales = 0;
    let lastMonthSales = 0;
    let toDateSales = 0;
    let toDateLastMonthSales = 0;


// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô reference)
const today = new Date();
const todayRealDate = today.getDate();

// ‡πÄ‡∏≠‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π
const viewingDay = Math.min(todayRealDate, daysInMonth(viewingDate.getFullYear(), viewingDate.getMonth() + 1));
const todayDate = viewingDay;




const currentPrefix = viewingDate.toISOString().slice(0, 7);
const lastMonthDate = new Date(viewingDate);
lastMonthDate.setMonth(viewingDate.getMonth() - 1);
const lastPrefix = lastMonthDate.toISOString().slice(0, 7);
    const categoryCounts = {};
    const categoryDetails = {};
    const customerMap = {};

    // ‚úÖ ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
records.forEach(r => {
  const amount = parseFloat(r.amount || 0);
  if (r.date.startsWith(currentPrefix)) {
  totalSales += amount;

  const recDay = parseInt(r.date.split("-")[2]);
  if (recDay <= todayDate) {
    toDateSales += amount;
  }
}

if (r.date.startsWith(lastPrefix)) {
  lastMonthSales += amount;

  const recDay = parseInt(r.date.split("-")[2]);
  if (recDay <= todayDate) {
    toDateLastMonthSales += amount;
  }
}
  
});

// ‚úÖ ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 2: ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
records
  .filter(r => r.date.startsWith(prefix))
  .forEach(r => {
    const key = `${r.name}|${r.phone}`;
    if (!customerMap[key]) {
      customerMap[key] = {
  name: r.name,
  phone: r.phone,
  opd: r.opd || '-',      // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
  date: r.date,
  amount: 0
};
    }
    customerMap[key].amount += parseFloat(r.amount || 0);
    customerMap[key].date = r.date > customerMap[key].date ? r.date : customerMap[key].date;

    (r.items || []).forEach(item => {
      const match = item.match(/\((.*?)\)/);
      const subItem = match ? match[1] : item;
      const qtyMatch = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+)/);
      const qty = qtyMatch ? parseInt(qtyMatch[1]) : 0;
      const price = qtyMatch ? parseInt(qtyMatch[2]) : 0;
      const total = qty * price;

      const categoryMatch = item.match(/^(.+?) ?\(/);
      const category = categoryMatch ? categoryMatch[1].trim() : "‡∏≠‡∏∑‡πà‡∏ô‡πÜ";

      if (!categoryCounts[category]) categoryCounts[category] = 0;
      if (!categoryDetails[category]) categoryDetails[category] = {};

      categoryCounts[category] += qty;
      categoryDetails[category][subItem] = categoryDetails[category][subItem] || { qty: 0, total: 0 };
      categoryDetails[category][subItem].qty += qty;
      categoryDetails[category][subItem].total += total;
    });
  });


    document.querySelector('#mainTitle .total').innerHTML = `üí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° ${totalSales.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;



const compareEl = document.querySelector('#mainTitle .compare');

let diff = totalSales - lastMonthSales;
let text = diff > 0
  ? `<span style="color: green;">+${diff.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`
  : diff < 0
    ? `<span style="color: red;">-${Math.abs(diff).toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`
    : `<span style="color: gray;">‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`;

diff = toDateSales - toDateLastMonthSales;
let text2 = diff > 0
  ? `<span style="color: green;">üìÜ ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${todayDate}: +${diff.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`
  : diff < 0
    ? `<span style="color: red;">üìÜ ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${todayDate}: -${Math.abs(diff).toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`
    : `<span style="color: gray;">üìÜ ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${todayDate}: ‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`;

compareEl.innerHTML = `${text}<br>${text2}`;

const allDates = records.map(r => r.date).filter(Boolean);
const latestDate = allDates.sort().reverse()[0];

if (latestDate) {
  const todayDay = today.getDate();
  const viewingDay = Math.min(today.getDate(), daysInMonth(viewingDate.getFullYear(), viewingDate.getMonth() + 1));
const targetRangeEnd = viewingDay;

  const groupByMonth = {};

  records.forEach(r => {
    if (!r.date) return;
    const [y, m, d] = r.date.split("-");
    const ym = `${y}-${m}`;
    const day = parseInt(d);
    if (day <= targetRangeEnd) {
      if (!groupByMonth[ym]) groupByMonth[ym] = 0;
      groupByMonth[ym] += parseFloat(r.amount || 0);
    }
  });

  const currentPrefix = viewingDate.toISOString().slice(0, 7);
  const allMonths = Object.keys(groupByMonth).filter(m => m !== currentPrefix);

  const totalPastMonths = allMonths.reduce((sum, m) => sum + groupByMonth[m], 0);
  const averagePastMonths = Math.round(totalPastMonths / allMonths.length || 1);

  const currentMonth14Total = groupByMonth[currentPrefix] || 0;

  const compareAvgDiv = document.createElement('div');
  compareAvgDiv.style.marginTop = '4px';
  compareAvgDiv.style.color = currentMonth14Total >= averagePastMonths ? 'green' : 'crimson';
  compareAvgDiv.innerHTML = `üìä ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1‚Äì${targetRangeEnd} ‡∏Ñ‡∏∑‡∏≠: ${currentMonth14Total.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‚Äî ${
    currentMonth14Total >= averagePastMonths
      ? `‚úÖ ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÜ ${averagePastMonths.toLocaleString()} ‡∏ö‡∏≤‡∏ó`
      : `‚ö†Ô∏è ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÜ ${averagePastMonths.toLocaleString()} ‡∏ö‡∏≤‡∏ó`
  }`;
  compareEl.appendChild(compareAvgDiv);
}





    const sortedEntries = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1]);
    const labels = sortedEntries.map(([cat]) => cat);
    const data = sortedEntries.map(([, qty]) => qty);

    

    document.getElementById('summaryList').innerHTML = sortedEntries.map(([cat]) => {
  const items = Object.entries(categoryDetails[cat] || {})
    .map(([sub, d]) => `<li>‚Ä¢ ${sub} ${d.qty} ‡∏ä‡∏¥‡πâ‡∏ô</li>`).join('');
  const sumQty = categoryCounts[cat];
  return `<div class="summary-group"><strong>${cat}</strong> ‚Äî ‡∏£‡∏ß‡∏° ${sumQty} ‡∏ä‡∏¥‡πâ‡∏ô<ul>${items}</ul></div>`;
}).join('');

    fullCustomerList = Object.values(customerMap).sort((a, b) => b.amount - a.amount);

    const sortedCustomers = Object.values(customerMap)
      .sort((a, b) => b.amount - a.amount)
      .slice(0, 10);

    document.getElementById('top10List').innerHTML = sortedCustomers.map((c) => {
      const date = new Date(c.date);
      const formatted = date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
      return `<li><span class="name" style="cursor:pointer;color:#333;" onclick="openCustomerModal('${c.name}')">${c.name}</span><span class="date"> (${formatted})</span><span class="amount">${c.amount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span></li>`;

    }).join('');

    document.getElementById('totalCustomer').textContent = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${Object.keys(customerMap).length} ‡∏Ñ‡∏ô (‡∏Å‡∏î‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)`;
  }

  fetchDataAndUpdate();
fetchAllCustomerRecords();

  let fullCustomerList = [];
let allCustomerRecords = [];

function toggleCustomerList() {
  const listEl = document.getElementById("allCustomerList");
  if (listEl.style.display === "none") {
    listEl.style.display = "block";
    listEl.innerHTML = fullCustomerList.slice(10).map((c, i) => {
      const date = new Date(c.date);
      const formatted = date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
      return `<li><span class="name" style="cursor:pointer;color:#333;" onclick="openCustomerModal('${c.name}')">${i + 11}. ${c.name}</span><span class="date"> (${formatted})</span><span class="amount">${c.amount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span></li>`;
    }).join('');
  } else {
    listEl.style.display = "none";
  }
}
function daysInMonth(year, month) {
  return new Date(year, month, 0).getDate();
}


function closeCustomerModal() {
  document.getElementById("customer-modal").style.display = "none";
}

function formatDate(d) {
  if (!d) return '';
  const [y, m, day] = d.split('-');
  return `${day}/${m}/${y.slice(-2)}`;
}
function openCustomerModal(name) {
  const customer = fullCustomerList.find(c => c.name === name);
  const records = allCustomerRecords.filter(r => r.name === name);

  if (!customer || records.length === 0) return;

  const latestRecord = records.reduce((latest, r) => {
  return new Date(r.date) > new Date(latest.date) ? r : latest;
}, records[0]);

const lastDate = new Date(latestRecord.date);  // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á
  const today = new Date();
  const daysAbsent = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
  const visits = records.length;
  const totalAmount = records.reduce((sum, r) => sum + parseFloat(r.amount || 0), 0);
  const average = totalAmount / visits;

  // ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const allItems = {};
  records.forEach(r => {
    (r.items || []).forEach(item => {
      const nameOnly = item.split(" - ")[0];  // ‡∏•‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤
      const qtyMatch = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
      const qty = qtyMatch ? parseInt(qtyMatch[1]) : 1;
      allItems[nameOnly] = (allItems[nameOnly] || 0) + qty;
    });
  });

  const itemSummary = Object.entries(allItems)
    .map(([item, qty]) => `‚Ä¢ ${item} ‚Äì ${qty} ‡∏ä‡∏¥‡πâ‡∏ô`)
    .join("<br>");

  // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
  const historyHtml = records
    .sort((a, b) => b.date.localeCompare(a.date))
    .map(r => {
      const items = (r.items || []).map(item => {
        const nameOnly = item.split(" - ")[0];
        return `<li>‚Ä¢ ${nameOnly}</li>`;
      }).join("");
      return `
        <div style="margin-bottom:12px;">
          <div style="margin-bottom:4px;font-weight:bold;">üìÖ ${formatDate(r.date)}</div>
          <ul style="padding-left:16px;margin:0;">${items}</ul>
          <div style="margin-top:4px;color:#666;"> ‡∏¢‡∏≠‡∏î: ${parseFloat(r.amount || 0).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
        </div>
      `;
    }).join("");

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Modal
  document.getElementById("modal-content").innerHTML = `
    <h3 style="font-size:18px;margin-bottom:4px;">üìá ${customer.name}</h3>
    <div><strong>OPD:</strong> ${customer.opd || '-'}</div>
    <div><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå:</strong> ${customer.phone || '-'}</div>
    <div><strong>‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${formatDate(latestRecord.date)} <span style="color:gray;">(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß: ${daysAbsent} ‡∏ß‡∏±‡∏ô)</span></div>
    <div><strong>üí≥ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</strong> ${totalAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
    <div><strong>‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</strong> ${visits} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
    <div><strong>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á:</strong> ${Math.round(average).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
    <hr style="margin:12px 0;">
    <div style="font-weight:bold;">üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</div>
    <div style="margin:6px 0 12px;">${itemSummary}</div>
    <div style="font-weight:bold;margin-bottom:6px;">üõçÔ∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á:</div>
    ${historyHtml}
    <div style="margin-top:10px;font-weight:bold;color:#b8860b;">üí∞ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
  `;

  document.getElementById("customer-modal").style.display = "flex";
}




function calcDaysAbsent(dateStr) {
  const today = new Date();
  const lastDate = new Date(dateStr);
  const diff = today - lastDate;
  return Math.floor(diff / (1000 * 60 * 60 * 24));
}


  </script>
  <div class="floating-dock">
  <a href="{{ url_for('dashboard') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_dashboard.png') }}">
  </a>
  <a href="{{ url_for('sale_summary') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_sale_summary.png') }}">
  </a>
  <a href="{{ url_for('record_sales') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_record_sales.png') }}">
  </a>
    <a href="{{ url_for('customer_list') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_customer_list.png') }}">
  </a>
  <a href="{{ url_for('record_customer') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_customer_history.png') }}">
  </a>
  <a href="{{ url_for('oldsaledata') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_old_customers.png') }}">
  </a>
  <a href="#" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_staff.png') }}">
  </a>
  <a href="{{ url_for('inventory') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_inventory.png') }}">
  </a>
  <a href="#" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_appointments.png') }}">
  </a>
</div>

</body>
</html>
