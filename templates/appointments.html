<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
  <title>ตารางนัด & ตารางเวร</title>

  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500&display=swap" rel="stylesheet">

  <style>
    :root{
      --teal:#0f766e; --teal-600:#0d9488;
      --bg:#f7faf9; --card:#ffffff;

      /* เส้นบางๆ โทนอ่อน */
      --line:#eef2f7;
      --grid:#eef2f7;
      --grid-soft:#f6f8fb;
      --hover:#f8fafc;

      --text:#0f172a; --muted:#6b7280;

      /* เงาเบาลง */
      --shadow:0 6px 16px rgba(2,8,23,.05);
      --radius:16px;
    }

    *{box-sizing:border-box}
    body{
      font-family:'Prompt','Segoe UI',sans-serif;
      margin:0;
      background:var(--bg);
      color:var(--text);
      padding:10px 10px 120px;
      font-size:12px;
      font-weight:400;
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
    }
    strong,b{font-weight:500}

    /* ให้ “เต็มจอมือถือ” จริง */
    .container{
      width:100%;
      max-width:980px;       /* เดสก์ท็อปยังไม่แผ่เกินไป */
      margin:10px auto;
      background:#fff;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      overflow: visible;
    }

    .headline{font-size:18px;font-weight:500;color:#0b7660;margin:0 0 6px}
    .sub-muted{color:var(--muted);font-size:12px;margin-top:-2px;line-height:1.35}

    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{
      padding:8px 12px;border:1px solid #cfeeea;border-radius:999px;
      background:#fff;color:#0b7660;font-size:12px;cursor:pointer;
      font-weight:400;user-select:none;
    }
    .chip.active{background:#0b7660;color:#fff;border-color:#0b7660}

    .panel{display:none}
    .panel.active{display:block}

    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}
    .section{margin:12px 0 16px}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding:10px 12px;border-radius:10px;border:1px solid #cfeeea;background:#fff;color:#0b7660;
      cursor:pointer;font-weight:500;font-size:12px;
      -webkit-tap-highlight-color:transparent;
    }
    .btn-primary{border-color:transparent;background:var(--teal-600);color:#fff}
    .btn-ghost{background:#f5f7fb;border-color:var(--line);color:#0f172a}

    .ipt{
      width:100%;
      padding:10px 12px;
      border:1px solid #dde3ea;
      border-radius:10px;
      background:#fff;
      font-size:13px;
      font-family:inherit;
      font-weight:400;
      -webkit-appearance:none;appearance:none;
    }

    /* =========================
       DAILY: คลีน เส้นบาง
       ========================= */
    .paperWrap{
      border:1px solid var(--grid);
      border-radius:14px;
      overflow:visible;
      background:#fff;
    }
    .paperHeader{
      display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap;
      padding:12px 12px 10px;
      border-bottom:1px solid var(--grid);
      background:linear-gradient(180deg, #ffffff 0%, #fbfffe 100%);
    }
    .paperHeader .left{
      display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;
      font-weight:500;color:#0f172a;
    }
    .paperTitle{
      font-weight:500;font-size:13px;color:#0b3d35;margin-right:4px;
    }
    .lineField{
      display:inline-flex;align-items:flex-end;gap:6px;white-space:nowrap;
      font-size:12px;color:#0f172a;font-weight:400;
    }
    .line{
      display:inline-block;
      min-width:86px;
      border-bottom:1px dotted #aab6c5;
      padding:0 6px 2px;
      font-weight:500;
      text-align:center;
      color:#0f172a;
    }
    .line.small{min-width:60px}
    .line.medium{min-width:110px}

    .paperControls{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin-top:10px;
    }
    .paperControls .group{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
    }

    .tableScroll{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
    }
    table.clean{
      width:100%;
      min-width:820px; /* Default Desktop */
      border-collapse:separate;
      border-spacing:0;
      background:#fff;
    }
    table.clean thead th{
      position:sticky; top:0;
      background:#f8fafc;
      z-index:1;
      text-align:center;
      font-weight:500;
      font-size:12px;
      padding:10px 8px;
      border-bottom:1px solid var(--grid);
    }
    table.clean th, table.clean td{
      border-right:1px solid var(--grid);
    }
    table.clean thead th:last-child,
    table.clean tbody td:last-child{border-right:none}

    table.clean tbody td{
      border-bottom:1px solid var(--grid);
      padding:8px;
      vertical-align:top;
      background:#fff;
    }
    table.clean tbody tr:nth-child(even) td{
      background:#fcfcfd;
    }
    .timeCell{
      width:90px;
      text-align:center;
      font-weight:500;
      color:#0f172a;
      background:#fbfffe !important;
    }

    /* ช่องว่าง: ทั้งช่องคลิกได้ */
    .slotEmpty{
      width:100%;
      min-height:34px;
      border:1px solid transparent;
      border-radius:12px;
      padding:8px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#94a3b8;
      font-weight:400;
      font-size:11px;
      user-select:none;
    }
    .slotEmpty:hover{
      background:var(--hover);
      border-color:#e6edf5;
      color:#64748b;
    }
    .slotEmpty.noText{color:transparent}
    .slotEmpty.noText::after{
      content:'';
      display:block;
      width:100%;
      height:18px;
    }

    /* การ์ดนัด */
    .apptCard{
      border-radius:14px;
      padding:8px 10px;
      border:1px solid rgba(15,23,42,.10);
      box-shadow:0 10px 20px rgba(2,8,23,.06);
      display:grid; gap:2px;
      cursor:pointer;
      overflow: visible;
    }
    .apptCard .name{font-weight:500;font-size:13px; white-space: nowrap; overflow: visible; text-overflow: ellipsis;}
    .apptCard .meta{font-size:11px;color:#334155;opacity:.85;font-weight:400}
    .apptCard .foot{display:flex;justify-content:space-between;align-items:center;margin-top:4px}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;font-size:10px;font-weight:500;
      border:1px solid rgba(0,0,0,.06);
      background:rgba(255,255,255,.7);
    }
    .dot{width:8px;height:8px;border-radius:999px}
    .old{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .old .dot{background:#22c55e}
    .guest{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .guest .dot{background:#f59e0b}

    /* =========================
       MONTHLY (iOS-style) ลดตัวหนา + เส้นบาง
       ========================= */
    .iosMonthHeader{
      display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding:6px 2px 10px;
    }
    .iosMonthHeader .monthTitle{font-size:28px;font-weight:500;letter-spacing:.2px}
    .iosMonthHeader .todayBtn{font-weight:500;color:#ef4444;cursor:pointer;user-select:none}

    .iosWeekHead{
      display:grid;grid-template-columns:repeat(7,1fr);
      border-top:1px solid var(--grid);border-bottom:1px solid var(--grid);
      padding:8px 0;margin-top:6px;
      color:#94a3b8;font-weight:500;font-size:12px;text-align:center;
    }
    .iosGrid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      border-bottom:1px solid var(--grid);
    }
    .iosDay{
      min-height:110px;
      border-right:1px solid var(--grid);
      border-top:1px solid var(--grid);
      padding:8px 8px 10px;
      background:#fff;
      overflow:visible;
    }
    .iosDay:nth-child(7n){border-right:none}
    .iosDay .num{font-weight:500;font-size:16px;color:#0f172a}
    .iosDay.muted .num{color:#cbd5e1}
    .iosDay .events{display:flex;flex-direction:column;gap:6px;margin-top:8px}

    .eventPill{
      display:flex;align-items:center;gap:6px;
      padding:6px 8px;border-radius:8px;
      font-weight:500;font-size:12px;
      white-space:nowrap;overflow:visible;text-overflow:ellipsis;
    }
    .ev-green{background:#d9f2cc;color:#1f5e2b}
    .ev-purple{background:#e9d5ff;color:#6b21a8}
    .ev-blue{background:#cfe8ff;color:#0b4b7a}
    .ev-brown{background:#ead8c5;color:#5a3a1a}
    .eventPill .icon{
      width:14px;height:14px;border-radius:4px;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:10px;background:rgba(0,0,0,.12);flex:0 0 auto;
    }

    /* =========================
       MODAL
       ========================= */
    .modal{
      display:none;
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      z-index:9999;
      align-items:flex-end;
      justify-content:center;
      padding:10px;
    }
    .modal.show{display:flex}
    .modal .box{
      width:min(520px, 100%);
      background:#fff;
      border-radius:16px;
      overflow:visible;
      box-shadow:0 12px 26px rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.25);
    }
    .modal .hdr{
      background:#e0f2f1;
      color:#004d40;
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;
      font-weight:500;
      font-size:13px;
    }
    .modal .close{background:transparent;border:none;font-size:18px;cursor:pointer;color:#004d40}
    .modal .body{padding:14px; display:grid; gap:10px}
    .modal .ftr{
      padding:12px 14px;
      border-top:1px solid var(--line);
      display:flex; justify-content:flex-end; gap:8px;
    }

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    /* =========================
       IPAD / TABLET (Portrait & Landscape Compact)
       แก้ให้ไม่เลื่อนจอ (Fit Screen) + ทำให้เล็ก
       ========================= */
    @media (min-width: 641px) and (max-width: 1024px) {
      body {
        padding: 5px;
      }
      .container {
        max-width: 100%;
        margin: 0;
        padding: 10px;
        border-radius: 0;
        box-shadow: none;
      }
      .headline { font-size: 16px; }
      
      /* บังคับตารางให้หดอยู่ในหน้าจอ */
      table.clean {
        min-width: 100%; 
        width: 100%;
        table-layout: fixed; /* หัวใจสำคัญ: บังคับคอลัมน์หารเท่ากันตาม % */
      }
      table.clean thead th {
        font-size: 11px;
        padding: 8px 4px;
        white-space: normal; /* ยอมให้หัวตารางตัดบรรทัดได้ถ้าที่แคบ */
      }
      table.clean tbody td {
        padding: 4px; /* ลด padding */
      }
      
      /* ลดขนาดช่องเวลา */
      .timeCell { 
        width: 55px !important; 
        font-size: 11px;
      }

      /* ย่อขนาดการ์ดนัด */
      .apptCard {
        padding: 6px;
        gap: 1px;
      }
      .apptCard .name { font-size: 11px; }
      .apptCard .meta { font-size: 9px; display: none; } /* ซ่อน meta ถ้าที่แคบมาก */
      .apptCard .foot { margin-top: 2px; }
      .tag { padding: 2px 6px; font-size: 9px; }
      .tag .dot { width: 6px; height: 6px; }

      .slotEmpty {
        font-size: 10px;
        min-height: 28px;
      }

      /* ปรับ Input ให้เล็กลง */
      .ipt, .btn {
        padding: 8px 10px;
        font-size: 12px;
      }
    }

    /* =========================
       MOBILE: ทำให้ "ไม่ใหญ่ไป" + เต็มจอ + ตารางเลื่อนง่าย
       ========================= */
    @media (max-width:640px){
      body{
        padding:8px 8px 110px;
        font-size:11.5px;
      }
      .container{
        max-width:100%;
        margin:8px auto;
        padding:10px;
        border-radius:14px;
      }

      .headline{font-size:16px}
      .sub-muted{font-size:11px}

      .btn{padding:9px 10px;font-size:11.5px;border-radius:10px}
      .ipt{padding:9px 10px;font-size:12.5px}

      /* มือถือยอมให้เลื่อนซ้ายขวาได้ เพราะจอเล็กเกิน */
      table.clean{min-width:680px}
      table.clean thead th{padding:9px 6px;font-size:11.5px}
      table.clean tbody td{padding:7px}

      .timeCell{width:72px}

      .apptCard{padding:7px 9px}
      .apptCard .name{font-size:12.5px}
      .apptCard .meta{font-size:10.5px}
      .tag{font-size:9.5px}

      .slotEmpty{min-height:30px;font-size:10.5px}

      .iosMonthHeader .monthTitle{font-size:24px}
      .iosDay{min-height:96px;padding:7px 7px 9px}
      .iosDay .num{font-size:15px}
      .eventPill{font-size:11.5px;padding:6px 7px}

      .line{min-width:74px}
      .line.medium{min-width:92px}
      .grid2{grid-template-columns:1fr}
    }

    /* เพิ่มต่อท้ายใน <style> */

.iosDay.today {
  background-color: #f0fdfa; /* สีพื้นหลังเขียวอ่อนๆ */
  box-shadow: inset 0 0 0 2px var(--teal-600); /* กรอบด้านในสีเขียวเข้ม */
  position: relative;
}

/* ทำให้ตัวเลขวันปัจจุบันเด่นขึ้นด้วย */
.iosDay.today .num {
  color: var(--teal-600);
  font-weight: 600;
}
  </style>
</head>

<body>

  <div class="container">
    <div class="headline">ระบบนัดหมาย & ตารางเวร</div>
    <div class="sub-muted">
      จัดการตารางนัดหมายและเวรแพทย์ | รองรับการเชื่อมต่อฐานข้อมูล
    </div>

    <div class="chips">
      <span class="chip active" data-tab="daily">ตารางนัดรายวัน</span>
      <span class="chip" data-tab="monthly">ตารางเวรรายเดือน</span>
      <span class="chip" data-tab="settings">ตั้งค่า</span>
    </div>

    <div class="panel active" id="panel-daily">
      <div class="section">

        <div class="paperControls">
          <div class="group">
            <div style="font-weight:500;color:#0b3d35">Daily Schedule</div>
            <button class="btn btn-ghost" type="button" onclick="UI.dailyToday()">วันนี้</button>
          </div>
          <div class="group" style="min-width:240px;flex:1;justify-content:flex-end">
            <input class="ipt" style="max-width:220px" type="date" id="dailyDate">
            <button class="btn btn-primary" type="button" onclick="UI.openApptModal()">เพิ่มนัด</button>
          </div>
        </div>

        <div class="paperWrap" style="margin-top:10px;">
          <div class="paperHeader">
            <div class="left">
              <span class="paperTitle">ตารางนัดลูกค้า</span>
              <span class="lineField">วัน <span class="line small" id="hdrDay">-</span></span>
              <span class="lineField">ที่ <span class="line small" id="hdrDateNum">-</span></span>
              <span class="lineField">เดือน <span class="line medium" id="hdrMonth">-</span></span>
            </div>
            <div class="right">
              <span class="lineField">หมอเข้าเวลา <span class="line small" id="hdrDoctorTime">11:00</span></span>
            </div>
          </div>

          <div class="tableScroll">
            <table class="clean" id="dailyTable">
              <thead>
                <tr>
                  <th class="timeCell">เวลา</th>
                  <th>เคสแพทย์</th>
                  <th>เคสแพทย์</th>
                  <th>เคสพยาบาล<br><span style="font-weight:400;font-size:11px;color:#64748b">Treatment</span></th>
                  <th>เคสพยาบาล<br><span style="font-weight:400;font-size:11px;color:#64748b">IV, PRP</span></th>
                </tr>
              </thead>
              <tbody id="dailyBody"></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

    <div class="panel" id="panel-monthly">
      <div class="section card">
        <div class="iosMonthHeader">
          <div class="monthTitle" id="monthTitle">-</div>
          <div class="todayBtn" onclick="UI.monthToday()">วันนี้</div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <input class="ipt" style="max-width:200px" type="month" id="monthPicker">
            <button class="btn btn-ghost" type="button" onclick="UI.renderMonth()">โหลดเดือน</button>
          </div>
          <button class="btn btn-primary" type="button" onclick="UI.copyWeek()">Copy เวร</button>
        </div>

        <div class="iosWeekHead">
          <div>อา.</div><div>จ.</div><div>อ.</div><div>พ.</div><div>พฤ.</div><div>ศ.</div><div>ส.</div>
        </div>

        <div class="iosGrid" id="iosGrid"></div>
      </div>
    </div>

    <div class="panel" id="panel-settings">
      <div class="section card">
        <div style="font-weight:500;color:#0b3d35;margin-bottom:8px">การตั้งค่า</div>
        <div class="sub-muted">ส่วนจัดการข้อมูลพื้นฐาน</div>
      </div>
    </div>

  </div><div class="modal" id="apptModal" onclick="UI.closeOnBackdrop(event,'apptModal')">
    <div class="box" onclick="event.stopPropagation()">
      <div class="hdr">
        <div>เพิ่มนัดหมาย</div>
        <button class="close" onclick="UI.closeModal('apptModal')">✕</button>
      </div>

      <div class="body">
        
        <div>
          <label style="font-weight:500;color:#334155;font-size:12px;margin:2px 0 4px;display:block">ประเภทลูกค้า</label>
          <select class="ipt" id="apptType">
            <option value="existing">ลูกค้าเก่า (Existing)</option>
            <option value="guest">ลูกค้าใหม่ (Guest / Walk-in)</option>
          </select>
        </div>

        <div id="existingBox">
          <label style="font-weight:500;color:#334155;font-size:12px;margin:2px 0 4px;display:block">ค้นหาลูกค้า (ชื่อ/เบอร์)</label>
          <input class="ipt" id="custSearch" placeholder="พิมพ์ชื่อเพื่อค้นหา...">
        </div>

        <div id="guestBox" style="display:none">
          <label style="font-weight:500;color:#334155;font-size:12px;margin:2px 0 4px;display:block">ชื่อลูกค้าใหม่</label>
          <input class="ipt" id="guestName" placeholder="กรอกชื่อ">
          <label style="font-weight:500;color:#334155;font-size:12px;margin:10px 0 4px;display:block">เบอร์โทร (ไม่บังคับ)</label>
          <input class="ipt" id="guestPhone" placeholder="กรอกเบอร์">
        </div>

        <div class="grid2">
          <div>
            <label style="font-weight:500;color:#334155;font-size:12px;margin:2px 0 4px;display:block">วันที่นัด</label>
            <input type="date" class="ipt" id="apptDate">
          </div>
          <div>
            <label style="font-weight:500;color:#334155;font-size:12px;margin:2px 0 4px;display:block">เวลาเริ่ม</label>
            <input type="time" class="ipt" id="apptTime" value="11:00">
          </div>
        </div>

        <div class="grid2">
          <div>
            <label style="font-weight:500;color:#334155;font-size:12px;margin:2px 0 4px;display:block">ลงช่อง</label>
            <select class="ipt" id="apptCol">
              <option value="1">เคสแพทย์ (1)</option>
              <option value="2">เคสแพทย์ (2)</option>
              <option value="3">เคสพยาบาล (Treatment)</option>
              <option value="4">เคสพยาบาล (IV, PRP)</option>
            </select>
          </div>
          <div>
            <label style="font-weight:500;color:#334155;font-size:12px;margin:2px 0 4px;display:block">หัตถการ/บริการ</label>
            <input class="ipt" id="apptService" placeholder="เช่น Botox / IV / Consult">
          </div>
        </div>

        <div>
          <label style="font-weight:500;color:#334155;font-size:12px;margin:2px 0 4px;display:block">หมายเหตุ</label>
          <textarea class="ipt" id="apptNote" rows="3" placeholder="เพิ่มโน้ต..."></textarea>
        </div>
      </div>

      <div class="ftr">
        <button class="btn btn-ghost" type="button" onclick="UI.closeModal('apptModal')">ยกเลิก</button>
        <button class="btn btn-primary" type="button" onclick="UI.saveAppt()">บันทึก</button>
      </div>
    </div>
  </div>

  <script>
    // ---------------- Helpers ----------------
    function pad2(n){ return String(n).padStart(2,'0'); }
    function toHHMM(mins){
      const h=Math.floor(mins/60), m=mins%60;
      return `${pad2(h)}:${pad2(m)}`;
    }
    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
    function uuid(){
      try{
        if (crypto && typeof crypto.randomUUID === 'function') return crypto.randomUUID();
      }catch(_){}
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // =========================
    // Appointments Store (Using LocalStorage for now, ready for API)
    // =========================
    const ApptStore = {
      key: 'CLINIC_APPTS_REAL',

      _load(){
        try{
          const raw = localStorage.getItem(this.key);
          const arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr : [];
        }catch(_){
          return [];
        }
      },

      _save(arr){
        localStorage.setItem(this.key, JSON.stringify(arr));
      },

      listByDate(date){
        const arr = this._load();
        return arr
          .filter(a => a && a.date === date)
          .sort((a,b) => (a.time||'').localeCompare(b.time||''));
      },

      upsert(appt){
        const arr = this._load();
        const i = arr.findIndex(x => x.id === appt.id);
        if(i >= 0) arr[i] = appt;
        else arr.push(appt);
        this._save(arr);
        // TODO: Call API to save appointment here
      },

      remove(id){
        const arr = this._load().filter(x => x.id !== id);
        this._save(arr);
        // TODO: Call API to delete appointment here
      }
    };

    function apptClass(type){
      return type === 'guest' ? 'guest' : 'old';
    }
    function apptTypeLabel(type){
      return type === 'guest' ? 'ลูกค้าใหม่' : 'ลูกค้าเก่า';
    }

    // ---------------- Tabs + UI ----------------
    const UI = {
      _editingApptId: null,

      goto(tab){
        document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
        document.querySelector(`.chip[data-tab="${tab}"]`)?.classList.add('active');

        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        document.getElementById(`panel-${tab}`)?.classList.add('active');
      },
      openModal(id){ document.getElementById(id)?.classList.add('show'); },
      closeModal(id){
        document.getElementById(id)?.classList.remove('show');
        if(id === 'apptModal') UI._editingApptId = null;
      },
      closeOnBackdrop(e,id){ if(e.target && e.target.id===id) UI.closeModal(id); },

      _syncModalFooterButtons(){
        const ftr = document.querySelector('#apptModal .ftr');
        if(!ftr) return;

        const delBtn = UI._editingApptId
          ? `<button class="btn" type="button" style="border-color:#fecaca;color:#b91c1c;background:#fff" onclick="UI.deleteEditingAppt()">ลบ</button>`
          : ``;

        const saveText = UI._editingApptId ? 'บันทึกการแก้ไข' : 'บันทึก';

        ftr.innerHTML = `
          <button class="btn btn-ghost" type="button" onclick="UI.closeModal('apptModal')">ยกเลิก</button>
          ${delBtn}
          <button class="btn btn-primary" type="button" onclick="UI.saveAppt()">${saveText}</button>
        `;
      },

      deleteEditingAppt(){
        if(!UI._editingApptId) return;
        if(!confirm('ยืนยันการลบนัดหมายนี้')) return;
        ApptStore.remove(UI._editingApptId);
        UI._editingApptId = null;
        UI.closeModal('apptModal');
        renderDailyTable();
      },

      openApptModal(prefill={}){
        UI._editingApptId = prefill.id || null;

        const d = prefill.date || document.getElementById('dailyDate')?.value || new Date().toISOString().slice(0,10);
        document.getElementById('apptDate').value = d;

        document.getElementById('apptTime').value = prefill.time || document.getElementById('apptTime').value || '11:00';
        document.getElementById('apptCol').value  = String(prefill.col || document.getElementById('apptCol').value || '1');

        document.getElementById('apptType').value = prefill.type || 'existing';
        document.getElementById('existingBox').style.display = (document.getElementById('apptType').value==='existing') ? '' : 'none';
        document.getElementById('guestBox').style.display = (document.getElementById('apptType').value==='guest') ? '' : 'none';

        document.getElementById('custSearch').value = (prefill.type === 'existing') ? (prefill.name || '') : '';
        document.getElementById('guestName').value  = (prefill.type === 'guest') ? (prefill.name || '') : '';
        document.getElementById('guestPhone').value = (prefill.type === 'guest') ? (prefill.phone || '') : '';

        document.getElementById('apptService').value = prefill.service || '';
        document.getElementById('apptNote').value    = prefill.note || '';

        UI.openModal('apptModal');
        UI._syncModalFooterButtons();
      },

      saveAppt(){
        try{
          const type = document.getElementById('apptType').value;

          const date = (document.getElementById('apptDate').value || '').trim();
          const time = (document.getElementById('apptTime').value || '').trim();
          const col  = parseInt(document.getElementById('apptCol').value || '1', 10);

          const service = (document.getElementById('apptService').value || '').trim();
          const note    = (document.getElementById('apptNote').value || '').trim();

          let name = '';
          let phone = '';

          if(type === 'guest'){
            name  = (document.getElementById('guestName').value || '').trim();
            phone = (document.getElementById('guestPhone').value || '').trim();
          }else{
            name = (document.getElementById('custSearch').value || '').trim();
            phone = '';
          }

          if(!date) return alert('กรุณาเลือกวันที่นัด');
          if(!time) return alert('กรุณาเลือกเวลา');
          if(!name) return alert('กรุณากรอกชื่อ/ค้นหาลูกค้า');

          const appt = {
            id: UI._editingApptId || uuid(),
            date, time, col,
            type, name, phone,
            service, note,
            status: 'PENDING',
            updatedAt: new Date().toISOString()
          };

          ApptStore.upsert(appt);

          UI.closeModal('apptModal');
          renderDailyTable();
        }catch(e){
          console.error(e);
          alert('เกิดข้อผิดพลาดในการบันทึก');
        }
      },

      dailyToday(){
        const d = new Date();
        const ymd = d.toISOString().slice(0,10);
        document.getElementById('dailyDate').value = ymd;
        applyDailyHeaderFromDate(ymd);
        renderDailyTable();
      },
      monthToday(){
        const d = new Date();
        document.getElementById('monthPicker').value = d.toISOString().slice(0,7);
        UI.renderMonth();
      },
      copyWeek(){ 
        // TODO: Implement API call to copy schedule pattern
        console.log("Function copyWeek called: Logic to replicate schedule goes here.");
      },

      renderMonth(){ renderIOSCalendar(); }
    };

    document.querySelectorAll('.chip[data-tab]').forEach(ch=>{
      ch.addEventListener('click', ()=>UI.goto(ch.getAttribute('data-tab')));
    });

    // ---------------- Modal type switch ----------------
    const apptType = document.getElementById('apptType');
    apptType.addEventListener('change', ()=>{
      const v = apptType.value;
      document.getElementById('existingBox').style.display = (v==='existing') ? '' : 'none';
      document.getElementById('guestBox').style.display = (v==='guest') ? '' : 'none';
      UI._syncModalFooterButtons();
    });

    // ---------------- Daily Table ----------------
    function renderDailyTable(){
      const tbody = document.getElementById('dailyBody');
      tbody.innerHTML='';

      const dateSel = document.getElementById('dailyDate')?.value || new Date().toISOString().slice(0,10);
      const appts = ApptStore.listByDate(dateSel);

      const start = 11*60;
      const end   = 19*60;
      const step  = 30;

      for(let t=start; t<=end; t+=step){
        const tr=document.createElement('tr');

        const tdTime=document.createElement('td');
        tdTime.className='timeCell';
        tdTime.textContent = toHHMM(t).replace(':','.');
        tr.appendChild(tdTime);

        for(let col=1; col<=4; col++){
          const td=document.createElement('td');

          const found = appts.find(a => (a.time === toHHMM(t)) && (Number(a.col) === Number(col)));

          if(found){
            td.innerHTML = `
              <div class="apptCard ${apptClass(found.type)}">
                <div class="name">${escapeHtml(found.name || '')}</div>
                <div class="meta">${escapeHtml(found.service || '—')} • ${escapeHtml(found.status || 'PENDING')}</div>
                <div class="foot">
                  <span class="tag ${apptClass(found.type)}"><span class="dot"></span>${apptTypeLabel(found.type)}</span>
                  <span style="font-size:11px;font-weight:400;opacity:.85">${escapeHtml(found.phone || '')}</span>
                </div>
              </div>
            `;
            td.querySelector('.apptCard')?.addEventListener('click', (e)=>{
              e.stopPropagation();
              UI.openApptModal(found);
            });
          }else{
            const empty=document.createElement('div');
            empty.className='slotEmpty';
            empty.textContent='';
            empty.onclick=()=>UI.openApptModal({
              time: toHHMM(t),
              col,
              date: document.getElementById('dailyDate').value
            });
            td.appendChild(empty);
          }

          tr.appendChild(td);
        }

        tbody.appendChild(tr);
      }
    }

    // ---------------- Daily header ----------------
    const TH_DAYS = ['อาทิตย์','จันทร์','อังคาร','พุธ','พฤหัสบดี','ศุกร์','เสาร์'];
    const TH_MONTHS = ['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];

    function applyDailyHeaderFromDate(ymd){
      if(!ymd) return;
      const d = new Date(ymd + 'T00:00:00');
      if(isNaN(d)) return;

      document.getElementById('hdrDay').textContent = TH_DAYS[d.getDay()];
      document.getElementById('hdrDateNum').textContent = String(d.getDate());
      document.getElementById('hdrMonth').textContent = TH_MONTHS[d.getMonth()];
      // TODO: Fetch doctor time from settings/API
      document.getElementById('hdrDoctorTime').textContent = '11:00';
    }

    // ---------------- Monthly calendar ----------------
    function thYear(y){ return y + 543; }
    function renderIOSCalendar(){
      const grid = document.getElementById('iosGrid');
      grid.innerHTML='';

      const mp = document.getElementById('monthPicker');
      // ถ้าไม่มีค่า ให้ใช้เดือนปัจจุบัน
      const ym = mp.value || new Date().toISOString().slice(0,7);
      const [Y,M] = ym.split('-').map(Number);

      const first = new Date(Y, M-1, 1);
      const last  = new Date(Y, M, 0);

      // เตรียมตัวแปรสำหรับเทียบวันปัจจุบัน
      const now = new Date(); 
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth() + 1; // getMonth() เริ่มที่ 0
      const currentDay = now.getDate();

      document.getElementById('monthTitle').textContent = `${TH_MONTHS[M-1]} ${thYear(Y)}`;

      const firstDow = first.getDay();
      for(let i=0;i<firstDow;i++){
        const b=document.createElement('div');
        b.className='iosDay muted';
        b.innerHTML=`<div class="num"></div>`;
        grid.appendChild(b);
      }

      // TODO: Fetch real shifts from API based on Y and M
      // const shifts = await fetch(`/api/shifts?month=${M}&year=${Y}`);

      for(let d=1; d<=last.getDate(); d++){
        const box=document.createElement('div');
        
        // เช็คว่าเป็นวันนี้หรือไม่
        const isToday = (Y === currentYear && M === currentMonth && d === currentDay);
        
        // ถ้าใช่ ให้เติม class 'today'
        box.className = 'iosDay' + (isToday ? ' today' : '');
        
        box.onclick=()=> {
          console.log(`Open shift modal for ${d}/${M}/${thYear(Y)}`);
        };

        const ev = ''; 

        box.innerHTML = `<div class="num">${d}</div><div class="events">${ev}</div>`;
        grid.appendChild(box);
      }
    }

    // ---------------- Init ----------------
    (function init(){
      const today = new Date();
      const ymd = today.toISOString().slice(0,10);

      document.getElementById('dailyDate').value = ymd;
      applyDailyHeaderFromDate(ymd);
      renderDailyTable();

      document.getElementById('monthPicker').value = today.toISOString().slice(0,7);
      renderIOSCalendar();

      document.getElementById('dailyDate').addEventListener('change', (e)=>{
        applyDailyHeaderFromDate(e.target.value);
        renderDailyTable();
      });
      document.getElementById('monthPicker').addEventListener('change', ()=>renderIOSCalendar());
    })();
  </script>

  {% include "floating_menu.html" %}
</body>
</html>