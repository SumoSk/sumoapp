<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
  <title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏±‡∏î & ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£</title>

  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --teal:#0f766e; --teal-600:#0d9488;
      --bg:#f7faf9; --card:#ffffff;
      --line:#eef2f7; --grid:#eef2f7; --hover:#f8fafc;
      --text:#0f172a; --muted:#6b7280;
      --shadow:0 6px 16px rgba(2,8,23,.05);
      --radius:16px;
      --danger:#ef4444; --warning:#f59e0b; --success:#10b981;
      --fs:8px;
    }

    *{ box-sizing:border-box; }
    html, body{ width:100%; height:100%; overflow-x:hidden; overflow-x:clip; }

    body{
      font-family:'Prompt',sans-serif;
      margin:0;
      background:var(--bg);
      color:var(--text);
      padding:10px 10px 90px;
      font-size:var(--fs);
      -webkit-text-size-adjust:100%;
    }

    body, button, input, select, textarea, table, th, td, label, span, div{
      font-size:var(--fs);
    }

    .container{
      width:100%;
      max-width:none;
      margin:0;
      background:#fff;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px;
    }
    .headline{ font-weight:800; color:#0b7660; margin:0 0 4px; }
    .sub-muted{ color:var(--muted); line-height:1.25; }

    /* --- Tabs --- */
    .chips{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .chip{
      padding:8px 10px; border:1px solid #cfeeea; border-radius:999px;
      background:#fff; color:#0b7660; cursor:pointer; user-select:none; transition:0.2s;
      font-weight:700; white-space:nowrap;
      font-size:10px;
    }
    .chip.active{ background:#0b7660; color:#fff; border-color:#0b7660; }
    .panel{ display:none; animation: fadeIn 0.2s; }
    .panel.active{ display:block; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(2px);} to{opacity:1; transform:translateY(0);} }

    /* --- Buttons & Inputs --- */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding:8px 10px; border-radius:10px; border:none; cursor:pointer;
      font-weight:800; transition:0.15s; white-space:nowrap;
      line-height:1;
    }
    .btn-primary{ background:var(--teal-600); color:#fff; }
    .btn-primary:active{ opacity:0.9; transform:scale(0.98); }
    .btn-ghost{ background:#f1f5f9; color:#334155; }
    .btn-danger{ background:#fee2e2; color:#b91c1c; }
    .btn-success{ background:#d1fae5; color:#047857; }
    .btn-warning{ background:#fff7ed; color:#9a3412; }
    .btn-sm{ padding:6px 8px; border-radius:9px; }

    .ipt{
      width:100%;
      padding:8px 10px;
      border:1px solid #cbd5e1;
      border-radius:10px;
      font-family:inherit;
      outline:none;
      background:#fff;
      min-width:0;
    }
    .ipt:focus{ border-color:var(--teal-600); }

    /* --- Summary boxes --- */
    .sumRow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .sumBox{
      border:1px solid #e2e8f0;
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      display:flex;
      gap:8px;
      align-items:center;
      line-height:1.15;
    }
    .sumLabel{ color:#64748b; font-weight:800; }
    .sumValue{ color:#0f172a; font-weight:900; }

    .toggleMini{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 10px;
      border:1px solid #e2e8f0;
      background:#fff;
      border-radius:12px;
      font-weight:800;
      user-select:none;
      cursor:pointer;
    }
    .toggleMini input{ margin:0; }

    /* --- Month Queue --- */
    .mqTopBar{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .mqTitle{ font-weight:900; color:#0f766e; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .mqHint{ color:#64748b; font-weight:700; }

    .mqWrap{
      margin-top:10px;
      border:1px solid #e2e8f0;
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    .mqHeaderBar{
      padding:10px;
      background:#f8fafc;
      border-bottom:1px solid #e2e8f0;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .mqList{ padding:10px; }

    .dayBlock{
      border:1px solid #e2e8f0;
      border-radius:14px;
      overflow:hidden;
      margin-bottom:10px;
      background:#fff;
    }
    .dayHdr{
      padding:10px;
      background:#ffffff;
      border-bottom:1px solid #e2e8f0;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .dayTitle{ font-weight:900; color:#0f766e; }
    .dayCount{ color:#64748b; font-weight:900; }

    .tableWrap{ overflow-x:hidden; }
    table.qTable{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      min-width:0;
    }
    table.qTable th{
      background:#f1f5f9;
      color:#475569;
      font-weight:900;
      padding:8px 6px;
      border-bottom:1px solid #e2e8f0;
      text-align:left;
      word-break:break-word;
    }
    table.qTable td{
      border-bottom:1px solid #f1f5f9;
      padding:8px 6px;
      vertical-align:middle;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }
    table.qTable tr:hover td{ background:#f8fafc; }
    .rowClickable{ cursor:pointer; }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px;
      border-radius:999px;
      font-weight:900;
      border:1px solid transparent;
      white-space:nowrap;
      line-height:1;
    }
    .pill-pending{ background:#fff7ed; color:#9a3412; border-color:#fed7aa; }
    .pill-confirmed{ background:#ecfdf5; color:#047857; border-color:#bbf7d0; }
    .pill-cancelled{ background:#fef2f2; color:#b91c1c; border-color:#fecaca; }

    /* --- Daily --- */
    .dailyTopBar{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .dateNav{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; min-width:0; }
    #dailyDatepicker{ width:auto; }

    .paperWrap{ border:1px solid var(--grid); border-radius:14px; overflow:hidden; background:#fff; margin-top:10px; }
    .paperHeader{
      padding:10px;
      background:#f8fafc;
      border-bottom:1px solid var(--grid);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      min-width:0;
    }
    .paperHeaderTitle{ font-weight:900; color:#0f766e; }
    .paperHeaderNote{ color:#64748b; font-weight:700; }

    .tableScroll{ overflow-x:hidden; }
    table.clean{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      min-width:0;
    }
    table.clean th{
      background:#f1f5f9;
      color:#475569;
      font-weight:900;
      padding:8px 6px;
      border-bottom:1px solid #e2e8f0;
      text-align:left;
      word-break:break-word;
    }
    table.clean td{
      border-bottom:1px solid #f1f5f9;
      padding:8px 6px;
      vertical-align:top;
      height:44px;
      overflow:hidden;
      min-width:0;
    }
    table.clean td.timeCell{
      width:52px;
      background:#f8fafc;
      text-align:center;
      font-weight:900;
      color:#64748b;
      border-right:1px solid #e2e8f0;
      white-space:nowrap;
    }

    .apptCard{
      background:#fff;
      border:1px solid #e2e8f0;
      border-left:4px solid var(--teal-600);
      border-radius:10px;
      padding:6px;
      cursor:pointer;
      overflow:hidden;
    }
    .apptCard.pending{ border-left-color:var(--warning); background:#fff7ed; border-color:#fed7aa; }
    .apptCard.confirmed{ border-left-color:var(--success); background:#ecfdf5; border-color:#bbf7d0; }
    .apptCard.cancelled{ border-left-color:var(--danger); background:#fef2f2; border-color:#fecaca; }
    .apptCard .name{ font-weight:900; color:#1e293b; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .apptCard .meta{ color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .apptCard .svc{ color:#334155; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:1px; }

    .slotEmpty{
      height:100%;
      border-radius:10px;
      border:1px dashed transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      color:transparent;
      cursor:pointer;
      min-height:34px;
      font-weight:800;
    }
    .slotEmpty:hover{ border-color:#cbd5e1; background:#f8fafc; color:#94a3b8; }
    .slotEmpty::after{ content:'+ ‡∏•‡∏á‡∏ô‡∏±‡∏î'; }

    /* --- Monthly Calendar --- */
    .iosMonthHeader{ display:flex; justify-content:space-between; align-items:center; padding:10px 0; gap:10px; flex-wrap:wrap; }
    .iosWeekHead{
      display:grid; grid-template-columns:repeat(7,1fr);
      text-align:center; font-weight:900; color:#64748b;
      padding:8px 0; border-bottom:1px solid #e2e8f0; border-top:1px solid #e2e8f0;
      background:#fcfcfd;
    }
    .iosGrid{ display:grid; grid-template-columns:repeat(7,1fr); border-left:1px solid #e2e8f0; border-top:1px solid #e2e8f0; }
    .iosDay{ min-height:72px; border-right:1px solid #e2e8f0; border-bottom:1px solid #e2e8f0; padding:6px; background:#fff; cursor:pointer; }
    .iosDay .num{ font-weight:900; }
    .eventPill{ padding:3px 6px; border-radius:6px; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* --- Modals --- */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; display:none; align-items:center; justify-content:center; padding:12px; opacity:0; transition: opacity 0.2s; }
    .modal.show{ display:flex; opacity:1; }
    .modal-box{ width:100%; max-width:460px; background:#fff; border-radius:16px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1); overflow:hidden; transform:scale(0.98); transition:transform 0.2s; }
    .modal.show .modal-box{ transform:scale(1); }
    .modal-hdr{ padding:12px 14px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; font-weight:900; background:#f8fafc; }
    .modal-body{ padding:14px; max-height:70vh; overflow-y:auto; }
    .modal-ftr{ padding:12px 14px; border-top:1px solid #e2e8f0; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; background:#f8fafc; }

    /* --- Search Dropdown --- */
    .search-wrapper{ position:relative; }
    .search-dropdown{ position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #cbd5e1; border-radius:0 0 12px 12px; max-height:220px; overflow-y:auto; z-index:50; display:none; box-shadow:0 10px 15px rgba(0,0,0,0.1); }
    .search-item{ padding:10px; border-bottom:1px solid #f1f5f9; cursor:pointer; }
    .search-item strong{ display:block; font-weight:900; }
    .search-item small{ color:#64748b; }

    /* --- Toast --- */
    #toast-container{ position:fixed; top:10px; right:10px; z-index:10000; display:flex; flex-direction:column; gap:8px; }
    .toast{ min-width:220px; padding:10px 12px; background:#fff; border-left:4px solid #333; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1); border-radius:12px; display:flex; align-items:center; justify-content:space-between; }
    .toast.success{ border-left-color: var(--success); }
    .toast.error{ border-left-color: var(--danger); }
    .toast.warn{ border-left-color: var(--warning); }

    /* --- Shift Rows --- */
    .shift-row { display:flex; justify-content:space-between; align-items:center; padding:10px; border:1px solid #e2e8f0; border-radius:12px; margin-bottom:8px; gap:10px; }
    .shift-row.leave { background:#fef2f2; border-color:#fecaca; }
    .shift-row.work { background:#f0fdfa; border-color:#ccfbf1; }

    /* =========================================================
       ‚úÖ OVERRIDE: ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß/‡πÅ‡∏ñ‡∏ö‡∏ö‡∏ô‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î (10px)
       ========================================================= */
    .headline,
    .sub-muted,
    .mqTitle,
    .mqHint,
    #mqDateRange,
    .sumLabel,
    .sumValue,
    .toggleMini,
    .paperHeaderTitle,
    .paperHeaderNote,
    #monthTitle {
      font-size:10px !important;
    }

    /* ‚úÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏µ‡∏ö‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô */
    .tableWrap, .tableScroll{
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table.qTable, table.clean{
      width: 100%;
      min-width: 0;
      table-layout: fixed;
      border-collapse: collapse;
    }

    table.qTable th, table.qTable td,
    table.clean th, table.clean td{
      padding: 6px 6px;
      vertical-align: middle;
    }
    
/* ‚úÖ ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏¢‡πà‡∏ô‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô ‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á "‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏û‡∏≠" ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô */
.tableWrap{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}

/* ‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ö‡∏µ‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏ô‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô */
table.qTable{
  width:100%;
  min-width:760px;      /* ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô 720-900 ‡∏ï‡∏≤‡∏°‡∏ä‡∏≠‡∏ö */
  table-layout:fixed;
}

/* ‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (7 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå) */
table.qTable th:nth-child(1), table.qTable td:nth-child(1){ width:60px;  white-space:nowrap; }  /* ‡πÄ‡∏ß‡∏•‡∏≤ */
table.qTable th:nth-child(2), table.qTable td:nth-child(2){ width:90px;  white-space:nowrap; }  /* ‡∏ä‡πà‡∏≠‡∏á */

table.qTable th:nth-child(3), table.qTable td:nth-child(3){
  width:160px;                 /* ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ */
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

table.qTable th:nth-child(6), table.qTable td:nth-child(4){
  width:170px;                 /* ‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£ */
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

table.qTable th:nth-child(5), table.qTable td:nth-child(5){
  width:110px;                 /* ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ */
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
table.qTable th:nth-child(4), table.qTable td:nth-child(6){ width:70px;  white-space:nowrap; }  /* ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó */


table.qTable th:nth-child(7), table.qTable td:nth-child(7){
  width:110px;                 /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
  white-space:nowrap;
}

    .pill{ max-width: 100%; }
    .btn{ max-width: 100%; }
  </style>
</head>

<body>
  <div id="toast-container"></div>

  <div class="container">
    <div class="headline">‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ & ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£</div>
    <div class="sub-muted">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</div>

    <div class="chips">
      <span class="chip active" data-tab="monthqueue">‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
      <span class="chip" data-tab="daily">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</span>
      <span class="chip" data-tab="monthly">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
      <span class="chip" data-tab="settings">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
    </div>

    <!-- ========================= -->
    <!-- MONTH QUEUE -->
    <!-- ========================= -->
    <div class="panel active" id="panel-monthqueue">
      <div class="mqTopBar">
        <div class="mqTitle">
          <span>‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Üí ‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</span>
          <span class="mqHint" id="mqDateRange">-</span>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn btn-ghost" onclick="MonthQueue.goToday()">‡πÑ‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
          <button class="btn btn-primary" onclick="MonthQueue.load(true)">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
      </div>

      <div class="mqWrap">
        <div class="mqHeaderBar">
          <div class="sumRow" id="mqSummaryRow">
            <div class="sumBox">
              <span class="sumLabel">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
              <span class="sumValue" id="sumToday">- ‡πÄ‡∏Ñ‡∏™</span>
            </div>
            <div class="sumBox">
              <span class="sumLabel">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
              <span class="sumValue" id="sumRemain">- ‡πÄ‡∏Ñ‡∏™</span>
            </div>
          </div>

          <label class="toggleMini" title="‡∏ã‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß">
            <input type="checkbox" id="hideEmptyDays" checked onchange="MonthQueue.renderFromCache()">
            ‡∏ã‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß
          </label>
        </div>

        <div class="mqList" id="mqList">
          <div style="padding:16px; text-align:center; color:#64748b;">- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° -</div>
        </div>
      </div>
    </div>

    <!-- ========================= -->
    <!-- DAILY -->
    <!-- ========================= -->
    <div class="panel" id="panel-daily">
      <div class="dailyTopBar">
        <div class="dateNav">
          <button class="btn btn-ghost" onclick="Daily.goToday()">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
          <button class="btn btn-ghost" onclick="Daily.goPrevDay()">‚óÄ</button>
          <input type="date" class="ipt" id="dailyDatepicker">
          <button class="btn btn-ghost" onclick="Daily.goNextDay()">‚ñ∂</button>
        </div>

        <button class="btn btn-primary" onclick="Modal.openAppt()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏î</button>
      </div>

      <div class="paperWrap">
        <div class="paperHeader">
          <div id="dailyHeaderTitle" class="paperHeaderTitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
          <div class="paperHeaderNote">*‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ô‡∏±‡∏î</div>
        </div>

        <div class="tableScroll">
          <table class="clean">
            <thead>
              <tr>
                <th class="timeCell">‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th>‡πÅ‡∏û‡∏ó‡∏¢‡πå 1</th>
                <th>‡πÅ‡∏û‡∏ó‡∏¢‡πå 2</th>
                <th>Treat</th>
                <th>IV</th>
              </tr>
            </thead>
            <tbody id="dailyTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ========================= -->
    <!-- MONTHLY ROSTER -->
    <!-- ========================= -->
    <div class="panel" id="panel-monthly">
      <div style="margin-top:12px; border:1px solid #e2e8f0; border-radius:14px; padding:0; background:#fff; overflow:hidden;">
        <div class="iosMonthHeader" style="padding:12px;">
          <div id="monthTitle" style="font-weight:900; color:#0f172a;">-</div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <button class="btn btn-ghost" onclick="Roster.goToday()">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
            <input type="month" class="ipt" id="monthPicker" style="width:auto;">
          </div>
        </div>

        <div class="iosWeekHead">
          <div>‡∏≠‡∏≤.</div><div>‡∏à.</div><div>‡∏≠.</div><div>‡∏û.</div><div>‡∏û‡∏§.</div><div>‡∏®.</div><div>‡∏™.</div>
        </div>

        <div class="iosGrid" id="monthGrid"></div>
      </div>
    </div>

    <!-- ========================= -->
    <!-- SETTINGS -->
    <!-- ========================= -->
    <div class="panel" id="panel-settings">
      <div style="padding:12px;">
        <div style="font-weight:900; color:#0f766e; margin-bottom:12px;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>

        <div style="background:#fff; padding:12px; border-radius:14px; border:1px solid #e2e8f0; margin-bottom:12px;">
          <div style="display:grid; grid-template-columns: 2fr 1.5fr 0.9fr auto; gap:10px; align-items:end;">
            <div>
              <label style="display:block; margin-bottom:6px; font-weight:900;">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
              <input class="ipt" id="newStaffName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•">
            </div>
            <div>
              <label style="display:block; margin-bottom:6px; font-weight:900;">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
              <select class="ipt" id="newStaffRole">
                <option value="doctor">‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
                <option value="nurse">‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</option>
                <option value="staff">‡∏à‡∏ô‡∏ó.</option>
              </select>
            </div>
            <div>
              <label style="display:block; margin-bottom:6px; font-weight:900;">‡∏™‡∏µ</label>
              <input type="color" class="ipt" id="newStaffColor" style="padding:2px; height:38px;" value="#0ea5e9">
            </div>
            <button class="btn btn-primary" onclick="Settings.addStaff()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
          </div>
        </div>

        <div style="font-weight:900; margin-bottom:10px; color:#64748b;">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        <div id="staffListContainer" style="background:#fff; border-radius:14px; border:1px solid #e2e8f0; overflow:hidden;"></div>
      </div>
    </div>
  </div>


<!-- Appointment Modal -->
<!-- ========================= -->
<div class="modal" id="apptModal" onclick="Modal.closeBackdrop(event, 'apptModal')">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-hdr">
      <span id="apptModalTitle">‡∏•‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</span>
      <button onclick="Modal.close('apptModal')" style="background:none;border:none;cursor:pointer;font-weight:900;">√ó</button>
    </div>

    <div class="modal-body">
      <input type="hidden" id="apptId">
      <input type="hidden" id="apptStatus">
      <input type="hidden" id="apptCustId">

      <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
      <label style="font-weight:900; margin-bottom:6px; display:block;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
      <select class="ipt" id="customerTypeSelect" onchange="Search.toggleType()">
        <option value="new">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</option>
        <option value="old">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤</option>
      </select>

      <!-- ‡∏ä‡∏∑‡πà‡∏≠ -->
      <label style="font-weight:900; margin-top:10px; margin-bottom:6px; display:block;">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
      <div class="search-wrapper">
        <input type="text" class="ipt" id="searchCustInput"
               placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠..."
               oninput="Search.handleInput(this.value)">
        <div class="search-dropdown" id="searchDropdown"></div>
      </div>

      <!-- ‡πÄ‡∏ö‡∏≠‡∏£‡πå -->
      <label style="font-weight:900; margin-top:10px; margin-bottom:6px; display:block;">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
      <input type="text" class="ipt" id="guestPhone">

      <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡πÄ‡∏ß‡∏•‡∏≤ -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px;">
        <div>
          <label style="font-weight:900; margin-bottom:6px; display:block;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input type="date" class="ipt" id="apptDate">
        </div>
        <div>
          <label style="font-weight:900; margin-bottom:6px; display:block;">‡πÄ‡∏ß‡∏•‡∏≤</label>
          <input type="time" class="ipt" id="apptTime">
        </div>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px;">
        <div>
          <label style="font-weight:900; margin-bottom:6px; display:block;">‡∏ä‡πà‡∏≠‡∏á</label>
          <select class="ipt" id="apptCol">
            <option value="1">‡πÅ‡∏û‡∏ó‡∏¢‡πå 1</option>
            <option value="2">‡πÅ‡∏û‡∏ó‡∏¢‡πå 2</option>
            <option value="3">Treat</option>
            <option value="4">IV</option>
          </select>
        </div>
        <div>
          <label style="font-weight:900; margin-bottom:6px; display:block;">‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£</label>
          <input type="text" class="ipt" id="apptProc">
        </div>
      </div>

      <div style="margin-top:12px;">
        <label style="font-weight:900; margin-bottom:6px; display:block;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea class="ipt" id="apptNote" rows="2"></textarea>
      </div>
    </div>

    <div class="modal-ftr" id="apptModalFtr"></div>
  </div>
</div>

  <!-- Roster Modal -->
  <div class="modal" id="rosterModal" onclick="Modal.closeBackdrop(event, 'rosterModal')">
    <div class="modal-box" onclick="event.stopPropagation()">
      <div class="modal-hdr">
        <span id="rosterDateTitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏£</span>
        <button onclick="Modal.close('rosterModal')" style="background:none; border:none; cursor:pointer; font-weight:900;">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="rosterSelectedDate">

        <div style="font-weight:900; color:#64748b; margin-bottom:6px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</div>
        <div id="rosterList" style="margin-bottom:12px; min-height:30px;"></div>

        <hr style="border:0; border-top:1px solid #e2e8f0; margin-bottom:12px;">

        <div style="font-weight:900; color:#0f766e; margin-bottom:10px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</div>

        <label style="font-weight:900; display:block; margin-bottom:6px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
        <select class="ipt" id="rosterStaffId">
          <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î --</option>
        </select>

        <label style="font-weight:900; display:block; margin-top:10px; margin-bottom:6px;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
        <div style="display:flex; gap:14px; margin-bottom:10px;">
          <label style="font-weight:800;"><input type="radio" name="workType" value="work" checked onchange="Roster.toggleLeave()"> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</label>
          <label style="font-weight:800;"><input type="radio" name="workType" value="leave" onchange="Roster.toggleLeave()"> ‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î</label>
        </div>

        <div id="workTimeBox">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div>
              <label style="font-weight:900; display:block; margin-bottom:6px;">‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
              <input type="time" class="ipt" id="rosterStart" value="11:00">
            </div>
            <div>
              <label style="font-weight:900; display:block; margin-bottom:6px;">‡πÄ‡∏•‡∏¥‡∏Å</label>
              <input type="time" class="ipt" id="rosterEnd" value="20:00">
            </div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label style="font-weight:900; display:block; margin-bottom:6px;">‡πÇ‡∏ô‡πâ‡∏ï</label>
          <input type="text" class="ipt" id="rosterNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ß‡∏£‡πÄ‡∏ä‡πâ‡∏≤ / ‡∏•‡∏≤‡∏Å‡∏¥‡∏à">
        </div>

        <button class="btn btn-primary" style="width:100%; margin-top:12px;" onclick="Roster.save()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal (‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£) -->
  <div class="modal" id="confirmModal">
    <div class="modal-box" style="max-width:360px;">
      <div class="modal-body" style="text-align:center; padding-top:22px;">
        <div style="font-weight:900; margin-bottom:10px;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        <div style="color:#64748b; margin-bottom:16px;">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</div>
        <div style="display:flex; justify-content:center; gap:10px; margin-top:12px;">
          <button class="btn btn-ghost" onclick="Modal.close('confirmModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-danger" id="confirmYesBtn">‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Utilities ---
    const $ = id => document.getElementById(id);

    const safeText = (v) => (v ?? '').toString();
    const trim = (v) => safeText(v).trim();

    const pad2 = (n) => String(n).padStart(2,'0');
    const toYMD = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

    const colName = (c) => {
      const m = { 1:'‡πÅ‡∏û‡∏ó‡∏¢‡πå 1', 2:'‡πÅ‡∏û‡∏ó‡∏¢‡πå 2', 3:'Treat', 4:'IV' };
      return m[Number(c)] || `‡∏ä‡πà‡∏≠‡∏á ${c}`;
    };

    // ‚úÖ API helper
    const api = async (url, method='GET', body=null) => {
      const opts = { method, headers: {'Content-Type': 'application/json'} };
      if(body) opts.body = JSON.stringify(body);

      try {
        const res = await fetch(url, opts);

        let data = null;
        const ct = res.headers.get('content-type') || '';
        if(ct.includes('application/json')) {
          data = await res.json().catch(()=>null);
        } else {
          const text = await res.text().catch(()=> '');
          data = text ? { message: text } : null;
        }

        if(!res.ok) {
          const msg =
            (data && (data.error || data.message || data.detail)) ?
              (data.error || data.message || data.detail) :
              `HTTP ${res.status}`;
          return { __http_ok:false, __status: res.status, __error: msg, __data: data };
        }

        return data;
      } catch(e) {
        console.warn('API Fetch Error:', e);
        if(url.includes('get_appointments')) return [];
        if(url.includes('get_roster')) return [];
        Toast.show('Connection Error', 'error');
        return null;
      }
    };

    // --- Toast ---
    const Toast = {
      show(msg, type='success') {
        const c = $('toast-container');
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.innerHTML = `<span>${msg}</span> <span style="cursor:pointer;font-weight:900;" onclick="this.parentElement.remove()">√ó</span>`;
        c.appendChild(el);
        setTimeout(() => { el.remove(); }, 2500);
      }
    };

    

    // --- Modal ---
    const Modal = {
      open(id) { $(id).classList.add('show'); },
      close(id) { $(id).classList.remove('show'); },
      closeBackdrop(e, id) { if(e.target.id === id) this.close(id); },

      openAppt(data = null) {
        $('apptId').value = '';
        $('apptCustId').value = '';
        $('apptStatus').value = 'pending';

        $('searchCustInput').value = '';
        $('guestPhone').value = '';
        $('apptProc').value = '';
        $('apptNote').value = '';
        $('searchDropdown').style.display = 'none';

        $('apptDate').value = $('dailyDatepicker').value || new Date().toISOString().split('T')[0];
        $('apptTime').value = '11:00';
        $('apptCol').value = '1';

        if(data) {
          if(data.id) {
            $('apptModalTitle').innerText = '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢';
            $('apptId').value = data.id;
            $('apptDate').value = data.appt_date;
            $('apptTime').value = (data.start_time || '').substring(0,5);
            $('apptCol').value = String(data.column_id || '1');
            $('apptProc').value = data.procedure || data.service || '';
            $('apptNote').value = data.note || '';
            $('apptStatus').value = data.status || 'pending';

            // ‚úÖ ‡πÑ‡∏°‡πà‡πÅ‡∏¢‡∏Å‡πÄ‡∏Å‡πà‡∏≤/‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß: ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å customer_name ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
            $('searchCustInput').value = data.customer_name || data.guest_name || data.opd || '';
            $('guestPhone').value = data.guest_phone || data.phone || '';
            $('apptCustId').value = data.customer_id || '';
          } else {
            $('apptModalTitle').innerText = '‡∏•‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà';
            $('apptStatus').value = 'pending';
            if(data.time) $('apptTime').value = data.time;
            if(data.col) $('apptCol').value = String(data.col);
            if(data.appt_date) $('apptDate').value = data.appt_date;
          }
        } else {
          $('apptModalTitle').innerText = '‡∏•‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà';
        }

        this.renderButtons();
        this.open('apptModal');
      },

      renderButtons() {
        const isEdit = !!$('apptId').value;

        const btnConfirm = isEdit
          ? `<button class="btn btn-success" onclick="Daily.setStatusUI('confirmed')">‚úÖ ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°</button>`
          : '';

        const btnBackPending = isEdit
          ? `<button class="btn btn-warning" onclick="Daily.setStatusUI('pending')">‚Ü© ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Pending</button>`
          : '';

        const btnCancelAppt = isEdit
          ? `<button class="btn btn-danger" onclick="Daily.setStatusUI('cancelled')">‚õî ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ô‡∏±‡∏î</button>`
          : '';

        const btnDeleteHard = isEdit
          ? `<button class="btn btn-ghost" style="color:#ef4444;" onclick="Daily.confirmDelete()">‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£</button>`
          : '';

        const btnClose = `<button class="btn btn-ghost" onclick="Modal.close('apptModal')">‡∏õ‡∏¥‡∏î</button>`;
        const btnSave = `<button class="btn btn-primary" onclick="Daily.save()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>`;

        $('apptModalFtr').innerHTML =
          `${btnDeleteHard} ${btnCancelAppt} ${btnBackPending} ${btnConfirm} ${btnClose} ${btnSave}`;
      }
    };

// =========================
// Search System
// =========================
const Search = {
  timer: null,

  toggleType() {
    const type = $('customerTypeSelect').value;
    if(type === 'new') {
      $('searchDropdown').style.display = 'none';
      $('apptCustId').value = '';
    }
  },

  handleInput(value) {
    const type = $('customerTypeSelect').value;
    if(type !== 'old') return;

    clearTimeout(this.timer);
    this.timer = setTimeout(() => this.search(value), 300);
  },

  async search(q) {
    if(!q || q.length < 1) {
      $('searchDropdown').style.display = 'none';
      return;
    }

    const res = await api(`/api/search_customer_simple?q=${encodeURIComponent(q)}`);
    if(!Array.isArray(res)) return;

    const box = $('searchDropdown');
    box.innerHTML = '';

    res.forEach(r => {
      const div = document.createElement('div');
      div.className = 'search-item';
      div.innerHTML = `
        <strong>${r.display_name}</strong>
        <small>${r.phone || '-'}</small>
      `;
      div.onclick = () => {
        $('searchCustInput').value = r.display_name;
        $('guestPhone').value = r.phone || '';
        $('apptCustId').value = r.opd || '';
        box.style.display = 'none';
      };
      box.appendChild(div);
    });

    box.style.display = 'block';
  }
};



    // --- Daily ---
    const Daily = {
      init() {
        const today = new Date().toISOString().split('T')[0];
        $('dailyDatepicker').value = today;
        $('dailyDatepicker').addEventListener('change', () => this.load());
        this.load();
      },

      shiftDay(delta) {
        const cur = $('dailyDatepicker').value || new Date().toISOString().split('T')[0];
        const d = new Date(cur + 'T00:00:00');
        d.setDate(d.getDate() + delta);
        $('dailyDatepicker').value = toYMD(d);
        this.load();
      },

      goPrevDay() { this.shiftDay(-1); },
      goNextDay() { this.shiftDay(1); },

      goToday() {
        $('dailyDatepicker').value = new Date().toISOString().split('T')[0];
        this.load();
      },

      async load() {
        const date = $('dailyDatepicker').value;
        $('dailyHeaderTitle').innerText = `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${this.formatDateTH(date)}`;

        const tbody = $('dailyTableBody');
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#64748b;padding:16px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';

        const appts = await api(`/api/get_appointments?date=${date}`);
        if(appts && appts.__http_ok === false) {
          tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#ef4444;padding:16px;">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${appts.__error}</td></tr>`;
          return;
        }

        this.renderTable(appts || []);
      },

      normalizeStatus(s){
        const v = (s || 'pending').toLowerCase();
        if(v === 'confirm' || v === 'confirmed') return 'confirmed';
        if(v === 'cancel' || v === 'canceled' || v === 'cancelled') return 'cancelled';
        return 'pending';
      },

      timeKey(t){
        const s = trim(t);
        if(!s) return '';
        return s.length >= 5 ? s.substring(0,5) : s;
      },

      // ‚úÖ ‡∏ä‡∏∑‡πà‡∏≠ = ‡πÉ‡∏ä‡πâ customer_name ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡πÑ‡∏°‡πà‡πÅ‡∏¢‡∏Å‡πÄ‡∏Å‡πà‡∏≤/‡πÉ‡∏´‡∏°‡πà)
      resolveDisplayName(a){
        return trim(a.customer_name) || trim(a.guest_name) || trim(a.opd) || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
      },

      renderTable(appts) {
        const tbody = $('dailyTableBody');
        tbody.innerHTML = '';

        const times = [];
        for(let h=11; h<20; h++) {
          times.push(`${pad2(h)}:00`);
          times.push(`${pad2(h)}:30`);
        }

        const idx = new Map();
        (appts || []).forEach(a => {
          const k = `${this.timeKey(a.start_time)}|${String(a.column_id)}`;
          idx.set(k, a);
        });

        times.forEach(t => {
          const tr = document.createElement('tr');

          const tdTime = document.createElement('td');
          tdTime.className = 'timeCell';
          tdTime.innerText = t;
          tr.appendChild(tdTime);

          for(let c=1; c<=4; c++) {
            const td = document.createElement('td');
            const found = idx.get(`${t}|${String(c)}`);

            if(found) {
              const nameDisplay = this.resolveDisplayName(found);
              const st = this.normalizeStatus(found.status);

              const div = document.createElement('div');
              div.className = `apptCard ${st}`;
              div.innerHTML = `
                <div class="name" title="${nameDisplay}">${nameDisplay}</div>
                <div class="meta" title="${found.guest_phone || found.phone || ''}">${found.guest_phone || found.phone || ''}</div>
                <div class="svc" title="${found.service || found.procedure || '-'}">${found.service || found.procedure || '-'}</div>
              `;
              div.onclick = () => Modal.openAppt(found);
              td.appendChild(div);
            } else {
              const div = document.createElement('div');
              div.className = 'slotEmpty';
              div.onclick = () => Modal.openAppt({ time: t, col: c, appt_date: $('dailyDatepicker').value });
              td.appendChild(div);
            }

            tr.appendChild(td);
          }

          tbody.appendChild(tr);
        });
      },

      // =========================================================
      // ‚úÖ‚úÖ‚úÖ SAVE (‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß: ‡πÑ‡∏°‡πà‡∏°‡∏µ customer_type/‡πÄ‡∏Å‡πà‡∏≤/‡πÉ‡∏´‡∏°‡πà)
      // - ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏°‡∏≠
      // - ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏õ‡πá‡∏ô optional
      // - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å dropdown ‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡πà‡∏á customer_id (optional)
      // =========================================================
      async save() {
  const id = trim($('apptId').value);

  const appt_date = trim($('apptDate').value);
  const start_time = trim($('apptTime').value);
  const column_id = parseInt(trim($('apptCol').value || '0'), 10);
  const service = trim($('apptProc').value);
  const note = trim($('apptNote').value);
  const status = this.normalizeStatus(trim($('apptStatus').value) || 'pending');

  const customer_name = trim($('searchCustInput').value);
  const guest_phone = trim($('guestPhone').value);
  const customer_type = $('customerTypeSelect').value;

  if(!customer_name) return Toast.show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'error');
  if(!appt_date) return Toast.show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'error');
  if(!start_time) return Toast.show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤', 'error');
  if(!column_id) return Toast.show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á', 'error');
  if(!service) return Toast.show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£', 'error');

  const payload = {
    appt_date,
    start_time,
    end_time: start_time,
    column_id,
    service,
    note,
    status,
    customer_name,
    guest_phone: guest_phone || null,
    customer_type
  };

  if(id) payload.id = id;

  const res = await api('/api/save_appointment', 'POST', payload);

  if(res && res.success) {
    Toast.show('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    Modal.close('apptModal');
    this.load();
    MonthQueue.load(false);
  } else {
    Toast.show('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
  }
      },

      async setStatusUI(status){
        const id = trim($('apptId').value);
        if(!id) return Toast.show('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');

        const s = this.normalizeStatus(status);
        const r = await this.setStatus(id, s);

        if(r.ok){
          $('apptStatus').value = s;
          const msg =
            s === 'confirmed' ? '‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß' :
            s === 'cancelled' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ô‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß' :
            '‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Pending ‡πÅ‡∏•‡πâ‡∏ß';

          const t =
            s === 'confirmed' ? 'success' :
            s === 'cancelled' ? 'error' :
            'warn';

          Toast.show(msg, t);
          Modal.close('apptModal');
          this.load();
          MonthQueue.load(false);
        } else {
          Toast.show(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${r.error || 'unknown'}`, 'error');
        }
      },

      async setStatus(id, status){
        const res = await api('/api/update_appointment_status', 'POST', { id, status });
        if(res && res.__http_ok === false) return { ok:false, error: res.__error };
        if(res && (res.success === true || res.ok === true || res.row)) return { ok:true };
        return { ok:false, error:'bad_response' };
      },

      confirmDelete() {
        const id = trim($('apptId').value);
        if(!id) return;
        $('confirmYesBtn').onclick = () => this.doDelete(id);
        Modal.open('confirmModal');
      },

      async doDelete(id) {
        const res = await api('/api/delete_appointment', 'POST', {id: id});
        if(res && res.__http_ok === false) return Toast.show(`‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${res.__error}`, 'error');

        if(res && res.success) {
          Toast.show('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          Modal.close('confirmModal');
          Modal.close('apptModal');
          this.load();
          MonthQueue.load(false);
        } else {
          Toast.show('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        }
      },

      formatDateTH(dateStr) {
        if(!dateStr) return '';
        const d = new Date(dateStr + 'T00:00:00');
        return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });
      }
    };

    // --- Month Queue ---
    const MonthQueue = {
      _loading:false,
      _cacheKey:'',
      _cacheData:null,
      _rowMap:{},

      normalizeStatus(s){
        const v = (s || 'pending').toLowerCase();
        if(v === 'confirm' || v === 'confirmed') return 'confirmed';
        if(v === 'cancel' || v === 'canceled' || v === 'cancelled') return 'cancelled';
        return 'pending';
      },

      pillStatus(st){
        if(st === 'confirmed') return `<span class="pill pill-confirmed">‚úÖ Confirmed</span>`;
        if(st === 'cancelled') return `<span class="pill pill-cancelled">‚õî Cancelled</span>`;
        return `<span class="pill pill-pending">‚è≥ Pending</span>`;
      },

      openByKey(k){
        const a = this._rowMap[k];
        if(a) Modal.openAppt(a);
      },

      async confirmFromRow(id){
        const r = await Daily.setStatus(id, 'confirmed');
        if(r.ok){
          Toast.show('‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß', 'success');
          await this.load(true);
        } else {
          Toast.show(`‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${r.error || 'unknown'}`, 'error');
        }
      },

      goToday(){
        const el = document.querySelector('[data-mq-today="1"]');
        if(el) el.scrollIntoView({ behavior:'smooth', block:'start' });
        else Toast.show('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', 'warn');
      },

      renderFromCache(){
        if(Array.isArray(this._cacheData)) this.render(this._cacheData, this._cacheKey.split('_')[0]);
      },

      resolveDisplayName(a){
        return trim(a.customer_name) || trim(a.guest_name) || trim(a.opd) || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
      },

      async load(force=false){
        if(this._loading) return;
        this._loading = true;

        const list = $('mqList');
        list.innerHTML = `<div style="padding:16px; text-align:center; color:#64748b;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô...</div>`;

        try {
          const now = new Date();
          const y = now.getFullYear();
          const m = now.getMonth();
          const todayStr = toYMD(now);

          const end = new Date(y, m+1, 0);
          const endStr = toYMD(end);

          $('mqDateRange').innerText =
            `${new Date(todayStr).toLocaleDateString('th-TH',{day:'numeric',month:'short'})} ‚Üí ${new Date(endStr).toLocaleDateString('th-TH',{day:'numeric',month:'short',year:'numeric'})}`;

          const cacheKey = `${todayStr}_${endStr}`;
          if(!force && this._cacheKey === cacheKey && Array.isArray(this._cacheData)){
            this.render(this._cacheData, todayStr);
            return;
          }

          const dates = [];
          const d = new Date(todayStr + 'T00:00:00');
          const endD = new Date(endStr + 'T00:00:00');
          while(d <= endD){
            dates.push(toYMD(d));
            d.setDate(d.getDate()+1);
          }

          const results = await Promise.all(
            dates.map(ds => api(`/api/get_appointments?date=${ds}`))
          );

          const byDate = {};
          results.forEach((res, i) => {
            const ds = dates[i];
            if(res && res.__http_ok === false) return;
            (res || []).forEach(a => {
              const row = { ...a, appt_date: a.appt_date || ds };
              if(!byDate[ds]) byDate[ds] = [];
              byDate[ds].push(row);
            });
          });

          Object.keys(byDate).forEach(ds => {
            byDate[ds].sort((x,y) => (trim(x.start_time).localeCompare(trim(y.start_time))));
          });

          const dayBlocks = dates.map(ds => ({
            date: ds,
            items: byDate[ds] || []
          }));

          this._cacheKey = cacheKey;
          this._cacheData = dayBlocks;

          this.render(dayBlocks, todayStr);

        } catch(e) {
          console.warn(e);
          $('mqList').innerHTML = `<div style="padding:16px; text-align:center; color:#ef4444;">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`;
        } finally {
          this._loading = false;
        }
      },

      render(dayBlocks, todayStr){
        const hideEmpty = $('hideEmptyDays')?.checked ?? true;

        let todayCount = 0;
        let remainCount = 0;

        dayBlocks.forEach(b => {
          const n = (b.items || []).length;
          if(b.date === todayStr) todayCount += n;
          remainCount += n;
        });

        $('sumToday').innerText = `${todayCount} ‡πÄ‡∏Ñ‡∏™`;
        $('sumRemain').innerText = `${remainCount} ‡πÄ‡∏Ñ‡∏™`;

        this._rowMap = {};
        let kCounter = 0;

        const list = $('mqList');
        let html = '';

        let any = false;
        dayBlocks.forEach(block => {
          const ds = block.date;
          const items = block.items || [];
          if(hideEmpty && items.length === 0) return;

          if(items.length === 0){
            const th = new Date(ds + 'T00:00:00').toLocaleDateString('th-TH', { weekday:'short', day:'numeric', month:'short' });
            html += `
              <div class="dayBlock">
                <div class="dayHdr">
                  <div class="dayTitle">${ds === todayStr ? 'üìå ' : ''}${th}</div>
                  <div class="dayCount">(0 ‡πÄ‡∏Ñ‡∏™)</div>
                </div>
                <div style="padding:10px; color:#94a3b8; text-align:center; font-weight:800;">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß -</div>
              </div>
            `;
            return;
          }

          any = true;
          const isToday = (ds === todayStr);
          const th = new Date(ds + 'T00:00:00').toLocaleDateString('th-TH', { weekday:'short', day:'numeric', month:'short' });

          html += `
            <div class="dayBlock" ${isToday ? 'data-mq-today="1"' : ''}>
              <div class="dayHdr">
                <div class="dayTitle">${isToday ? 'üìå ' : ''}${th} (${ds})</div>
                <div class="dayCount">(${items.length} ‡πÄ‡∏Ñ‡∏™)</div>
              </div>

              <div class="tableWrap">
                <table class="qTable">
                  <thead>
  <tr>
    <th style="text-align:left;">‡πÄ‡∏ß‡∏•‡∏≤</th>
<th style="text-align:left;">‡∏ä‡πà‡∏≠‡∏á</th>
<th style="text-align:left;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
<th style="text-align:left;">‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£</th>
<th style="text-align:left;">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
<th style="text-align:left;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
<th style="text-align:left;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>

  </tr>
</thead>

                  <tbody>
          `;

          items.forEach(a => {
            const st = this.normalizeStatus(a.status);
            const time = (trim(a.start_time) || '').slice(0,5) || '-';
            const col = colName(a.column_id);

            const nameDisplay = this.resolveDisplayName(a);
            const svc = a.service || a.procedure || '-';

            const key = `k${++kCounter}`;
            this._rowMap[key] = a;

            
            const customerType = a.customer_type === 'old' ? '‡πÄ‡∏Å‡πà‡∏≤' : '‡πÉ‡∏´‡∏°‡πà';
const phone = a.guest_phone || a.phone || '-';

html += `
  <tr class="rowClickable" onclick="MonthQueue.openByKey('${key}')">
    <td>${time}</td>
    <td>${col}</td>
    <td title="${nameDisplay}">${nameDisplay}</td>
    <td title="${svc}">${svc}</td>
    <td>${phone}</td>
    <td>${customerType}</td>
    <td>${this.pillStatus(st)}</td>
  </tr>
`;

          });

          html += `
                  </tbody>
                </table>
              </div>
            </div>
          `;
        });

        if(!any && hideEmpty){
          list.innerHTML = `<div style="padding:16px; text-align:center; color:#64748b; font-weight:800;">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏∂‡∏á‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -</div>`;
        } else {
          list.innerHTML = html || `<div style="padding:16px; text-align:center; color:#64748b; font-weight:800;">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -</div>`;
        }
      }
    };

    // --- ROSTER ---
    const Roster = {
      staffs: [],
      currentShifts: [],

      init() {
        const d = new Date();
        $('monthPicker').value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
        $('monthPicker').addEventListener('change', ()=>this.load());
        this.loadStaffs();
      },
      goToday() { this.init(); this.load(); },

      async loadStaffs() {
        this.staffs = await api('/api/staffs');

        const sel = $('rosterStaffId');
        sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô --</option>';

        if(this.staffs && this.staffs.__http_ok === false) {
          sel.innerHTML = `<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>`;
          return;
        }

        if(this.staffs) {
          this.staffs.forEach(s => {
            sel.innerHTML += `<option value="${s.id}">${s.name} (${s.role})</option>`;
          });
        }
      },

      async load() {
        const ym = $('monthPicker').value;
        const [y, m] = ym.split('-');
        $('monthTitle').innerText = new Date(y, m-1, 1).toLocaleDateString('th-TH', {month:'long', year:'numeric'});
        $('monthGrid').innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:16px;color:#64748b;font-weight:800;">‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£...</div>';

        const shifts = await api(`/api/get_roster?month=${ym}`);

        if(shifts && shifts.__http_ok === false) {
          $('monthGrid').innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:16px;color:#ef4444;font-weight:800;">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${shifts.__error}</div>`;
          return;
        }

        this.renderCalendar(y, m, shifts||[]);
      },

      renderCalendar(y, m, shifts) {
        const grid = $('monthGrid'); grid.innerHTML='';
        const firstDay = new Date(y, m-1, 1).getDay();
        const daysInMonth = new Date(y, m, 0).getDate();

        for(let i=0; i<firstDay; i++) grid.innerHTML+=`<div class="iosDay" style="background:#f8fafc;"></div>`;

        const today = new Date().toISOString().split('T')[0];
        for(let d=1; d<=daysInMonth; d++) {
          const dateStr = `${y}-${pad2(m)}-${pad2(d)}`;
          const dayShifts = shifts.filter(s => s.date === dateStr);

          let html = `<div class="iosDay ${today===dateStr?'today':''}" onclick="Roster.openModal('${dateStr}')">
                        <div class="num">${d}</div>`;

          dayShifts.forEach(s => {
            const isLeave = s.work_type === 'leave';
            const style = isLeave ? 'background:#fee2e2; color:#b91c1c;' :
              (s.staff_color ? `background:${s.staff_color}20; color:${s.staff_color}; border-left:2px solid ${s.staff_color};` : 'background:#ccfbf1; color:#0f766e;');

            const txt = isLeave ? `‡∏•‡∏≤(${s.staff_name})` : `${s.staff_name}`;
            const tm = isLeave ? '' : `<span style="opacity:0.7;">${(s.start_time||'').slice(0,5)}</span>`;

            html += `<div class="eventPill" style="${style}">${txt} ${tm}</div>`;
          });

          grid.innerHTML += html + `</div>`;
        }
        this.currentShifts = shifts;
      },

      openModal(date) {
        $('rosterSelectedDate').value = date;
        $('rosterDateTitle').innerText = `‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date(date).toLocaleDateString('th-TH', {day:'numeric', month:'short'})}`;

        const list = $('rosterList'); list.innerHTML = '';
        const existing = this.currentShifts.filter(s => s.date === date);

        if(existing.length === 0) list.innerHTML = '<div style="color:#94a3b8;text-align:center;padding:12px;font-weight:800;">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -</div>';
        else existing.forEach(s => {
          const isLeave = s.work_type === 'leave';
          const div = document.createElement('div');
          div.className = `shift-row ${isLeave?'leave':'work'}`;

          const timeInfo = isLeave ? '<b>‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î</b>' : `${s.start_time.slice(0,5)} - ${s.end_time.slice(0,5)}`;

          div.innerHTML = `
            <div>
              <strong style="font-weight:900;">${s.staff_name}</strong> <small style="color:#64748b; font-weight:800;">(${s.staff_role})</small><br>
              <span style="color:#334155; font-weight:800;">${timeInfo} ${s.note?`(${s.note})`:''}</span>
            </div>
            <button class="btn btn-sm btn-danger" onclick="Roster.deleteShift('${s.id}')">‡∏•‡∏ö</button>
          `;
          list.appendChild(div);
        });

        $('rosterStaffId').value = '';
        document.querySelector('input[name="workType"][value="work"]').checked = true;
        this.toggleLeave();
        $('rosterStart').value='11:00'; $('rosterEnd').value='20:00'; $('rosterNote').value='';

        Modal.open('rosterModal');
      },

      toggleLeave() {
        const t = document.querySelector('input[name="workType"]:checked').value;
        $('workTimeBox').style.display = t==='leave' ? 'none' : 'block';
      },

      async save() {
        const staffId = $('rosterStaffId').value;
        if(!staffId) return Toast.show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'error');

        const payload = {
          staff_id: staffId,
          date: $('rosterSelectedDate').value,
          work_type: document.querySelector('input[name="workType"]:checked').value,
          start_time: $('rosterStart').value,
          end_time: $('rosterEnd').value,
          note: $('rosterNote').value
        };

        const res = await api('/api/save_roster', 'POST', payload);

        if(res && res.__http_ok === false) {
          Toast.show(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${res.__error}`, 'error');
          return;
        }

        if(res && res.success) {
          Toast.show('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          Modal.close('rosterModal');
          this.load();
        } else {
          Toast.show('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
      },

      async deleteShift(id) {
        if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
        const res = await api('/api/delete_roster', 'POST', {id});
        if(res && res.__http_ok === false) return Toast.show(`‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${res.__error}`, 'error');

        if(res && res.success) {
          this.load();
          Modal.close('rosterModal');
          Toast.show('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
        } else {
          Toast.show('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        }
      }
    };

    // --- SETTINGS ---
    const Settings = {
      async load() {
        const box = $('staffListContainer');
        box.innerHTML = '<div style="padding:16px; text-align:center; color:#64748b; font-weight:800;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

        const staffs = await api('/api/staffs');
        box.innerHTML = '';

        if(staffs && staffs.__http_ok === false) {
          box.innerHTML = `<div style="padding:16px; text-align:center; color:#ef4444; font-weight:800;">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${staffs.__error}</div>`;
          return;
        }

        if(!staffs || staffs.length === 0) {
          box.innerHTML = '<div style="padding:16px; text-align:center; color:#94a3b8; font-weight:800;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>';
          return;
        }

        staffs.forEach(s => {
          const div = document.createElement('div');
          div.style.cssText = "padding:10px 12px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center; gap:10px;";
          div.innerHTML = `
            <div style="display:flex; gap:10px; align-items:center; min-width:0;">
              <div style="width:26px; height:26px; border-radius:50%; background:${s.color_code||'#ccc'}; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:900;">${(s.name||'?').charAt(0)}</div>
              <div style="min-width:0;">
                <div style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${s.name}</div>
                <div style="color:#64748b; font-weight:800;">${s.role}</div>
              </div>
            </div>
            <button class="btn btn-sm btn-ghost" style="color:#ef4444;" onclick="Settings.del(${s.id})">‡∏•‡∏ö</button>
          `;
          box.appendChild(div);
        });
      },

      async addStaff() {
        const name = $('newStaffName').value;
        const role = $('newStaffRole').value;
        const color = $('newStaffColor').value;
        if(!name) return Toast.show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠', 'error');

        const res = await api('/api/staffs', 'POST', {name, role, color_code: color});

        if(res && res.__http_ok === false) {
          Toast.show(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${res.__error}`, 'error');
          return;
        }

        if(res && res.success) {
          Toast.show('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
          $('newStaffName').value = '';
          this.load();
          Roster.loadStaffs();
        } else {
          Toast.show('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
      },

      async del(id) {
        if(!confirm('‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ?')) return;
        try {
          const r = await fetch(`/api/staffs?id=${id}`, { method: 'DELETE' });
          if(!r.ok) throw new Error(`HTTP ${r.status}`);
          Toast.show('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          this.load();
          Roster.loadStaffs();
        } catch(e) { Toast.show('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
      }
    };

    // Tab switching
    document.querySelector('.chip[data-tab="settings"]').addEventListener('click', () => Settings.load());

    document.querySelectorAll('.chip').forEach(el => {
      el.addEventListener('click', async () => {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');

        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        const tab = el.dataset.tab;
        $(`panel-${tab}`).classList.add('active');

        if(tab === 'monthly') Roster.load();
        if(tab === 'monthqueue') MonthQueue.load(false);
        if(tab === 'daily') Daily.load();
      });
    });

    // Init
    Daily.init();
    Roster.init();
    MonthQueue.load(false);
  </script>

  {% include "floating_menu.html" %}
</body>
</html>
