<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
  <title>ตารางนัด & ตารางเวร</title>

  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --teal:#0f766e; --teal-600:#0d9488;
      --bg:#f7faf9; --card:#ffffff;
      --line:#eef2f7; --grid:#eef2f7; --hover:#f8fafc;
      --text:#0f172a; --muted:#6b7280;
      --shadow:0 6px 16px rgba(2,8,23,.05);
      --radius:16px;
      --danger: #ef4444; --warning: #f59e0b;
    }

    *{box-sizing:border-box}
    body{
      font-family:'Prompt',sans-serif; margin:0; background:var(--bg); color:var(--text);
      padding:10px 10px 120px; font-size:12px; -webkit-text-size-adjust:100%;
    }
    
    /* --- Layout --- */
    .container{ width:100%; max-width:980px; margin:10px auto; background:#fff; border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; }
    .headline{ font-size:18px; font-weight:600; color:#0b7660; margin:0 0 6px; }
    .sub-muted{ color:var(--muted); font-size:12px; line-height:1.4; }

    /* --- Tabs --- */
    .chips{ display:flex; gap:8px; margin-top:10px; }
    .chip{ padding:8px 12px; border:1px solid #cfeeea; border-radius:20px; background:#fff; color:#0b7660; cursor:pointer; user-select:none; transition:0.2s; }
    .chip.active{ background:#0b7660; color:#fff; border-color:#0b7660; }
    .panel{ display:none; animation: fadeIn 0.3s; }
    .panel.active{ display:block; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

    /* --- Buttons & Inputs --- */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:500; font-size:12px; transition:0.2s;
    }
    .btn-primary{ background:var(--teal-600); color:#fff; }
    .btn-primary:active{ opacity:0.9; transform:scale(0.98); }
    .btn-ghost{ background:#f1f5f9; color:#334155; }
    .btn-danger{ background:#fee2e2; color:#b91c1c; }
    
    .ipt{ width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; font-family:inherit; font-size:13px; outline:none; }
    .ipt:focus{ border-color:var(--teal-600); ring:2px var(--teal-600); }

    /* --- Daily Table --- */
    .paperWrap{ border:1px solid var(--grid); border-radius:14px; overflow:hidden; background:#fff; margin-top:10px; }
    .paperHeader{ padding:12px; background:#f8fafc; border-bottom:1px solid var(--grid); display:flex; justify-content:space-between; align-items:center; }
    .paperTitle{ font-weight:600; color:#0f172a; font-size:14px; }
    
    .tableScroll{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
    table.clean{ width:100%; min-width:800px; border-collapse:collapse; }
    table.clean th{ position:sticky; top:0; background:#f1f5f9; color:#475569; font-weight:500; padding:10px; border-bottom:1px solid #e2e8f0; text-align:left; }
    table.clean td{ border-bottom:1px solid #f1f5f9; padding:8px; vertical-align:top; height:50px; }
    table.clean td.timeCell{ width:70px; background:#f8fafc; text-align:center; font-weight:600; color:#64748b; border-right:1px solid #e2e8f0; }
    
    /* --- Appointment Card --- */
    .apptCard{
      background:#fff; border:1px solid #e2e8f0; border-left:4px solid var(--teal-600);
      border-radius:8px; padding:8px; box-shadow:0 2px 4px rgba(0,0,0,0.03);
      cursor:pointer; transition:0.2s; position:relative; overflow:hidden;
    }
    .apptCard:hover{ transform:translateY(-1px); box-shadow:0 4px 6px rgba(0,0,0,0.06); }
    .apptCard.guest{ border-left-color:var(--warning); background:#fffbeb; }
    .apptCard .name{ font-weight:600; font-size:13px; color:#1e293b; margin-bottom:2px; }
    .apptCard .sub{ font-size:11px; color:#64748b; display:flex; justify-content:space-between; }
    
    .slotEmpty{ height:100%; border-radius:6px; border:1px dashed transparent; display:flex; align-items:center; justify-content:center; color:transparent; cursor:pointer; }
    .slotEmpty:hover{ border-color:#cbd5e1; background:#f8fafc; color:#94a3b8; font-size:11px; }
    .slotEmpty::after{ content:'+ ลงนัด'; }

    /* --- Monthly Calendar (iOS Style) --- */
    .iosMonthHeader{ display:flex; justify-content:space-between; align-items:center; padding:10px 0; }
    .iosWeekHead{ display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-weight:600; color:#64748b; padding:10px 0; border-bottom:1px solid #e2e8f0; border-top:1px solid #e2e8f0; background:#fcfcfd; }
    .iosGrid{ display:grid; grid-template-columns:repeat(7,1fr); border-left:1px solid #e2e8f0; border-top:1px solid #e2e8f0; }
    .iosDay{ min-height:100px; border-right:1px solid #e2e8f0; border-bottom:1px solid #e2e8f0; padding:6px; position:relative; background:#fff; cursor:pointer; }
    .iosDay .num{ font-weight:600; color:#334155; margin-bottom:4px; font-size:13px; }
    .iosDay.today{ background:#f0fdfa; }
    .iosDay.today .num{ color:var(--teal-600); font-size:15px; }
    
    .eventPill{ font-size:10px; padding:3px 6px; border-radius:4px; margin-bottom:2px; background:#e2e8f0; color:#334155; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .eventPill.shift{ background:#ccfbf1; color:#0f766e; }

    /* --- Modals --- */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; display:none; align-items:center; justify-content:center; padding:20px; opacity:0; transition: opacity 0.2s; }
    .modal.show{ display:flex; opacity:1; }
    .modal-box{ width:100%; max-width:480px; background:#fff; border-radius:16px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1); overflow:hidden; transform:scale(0.95); transition:transform 0.2s; }
    .modal.show .modal-box{ transform:scale(1); }
    .modal-hdr{ padding:15px 20px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; font-weight:600; font-size:16px; background:#f8fafc; color:#0f172a; }
    .modal-body{ padding:20px; max-height:70vh; overflow-y:auto; }
    .modal-ftr{ padding:15px 20px; border-top:1px solid #e2e8f0; display:flex; justify-content:flex-end; gap:10px; background:#f8fafc; }
    
    /* --- Search Dropdown --- */
    .search-wrapper{ position:relative; }
    .search-dropdown{ position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #cbd5e1; border-radius:0 0 10px 10px; max-height:200px; overflow-y:auto; z-index:50; display:none; box-shadow:0 10px 15px rgba(0,0,0,0.1); }
    .search-item{ padding:10px; border-bottom:1px solid #f1f5f9; cursor:pointer; }
    .search-item:hover{ background:#f8fafc; }
    .search-item strong{ display:block; color:#0f172a; font-size:13px; }
    .search-item small{ color:#64748b; font-size:11px; }

    /* --- Toast Notification --- */
    #toast-container{ position:fixed; top:20px; right:20px; z-index:10000; display:flex; flex-direction:column; gap:10px; }
    .toast{ min-width:250px; padding:12px 16px; background:#fff; border-left:4px solid #333; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1); border-radius:8px; font-size:13px; display:flex; align-items:center; justify-content:space-between; animation: slideIn 0.3s; }
    .toast.success{ border-left-color: #10b981; }
    .toast.error{ border-left-color: #ef4444; }
    @keyframes slideIn { from{transform:translateX(100%); opacity:0;} to{transform:translateX(0); opacity:1;} }

    /* --- Responsive --- */
    @media (max-width:640px){
      .modal{ align-items:flex-end; padding:0; }
      .modal-box{ max-width:100%; border-radius:16px 16px 0 0; }
      .paperTitle{ display:none; }
      .timeCell{ width:50px; font-size:11px; }
      .iosWeekHead{ font-size:11px; }
      .iosDay{ min-height:80px; padding:4px; }
      .iosDay .num{ font-size:12px; }
    }

    /* --- สิ่งที่ต้องเพิ่มใน CSS --- */
    .shift-row { display:flex; justify-content:space-between; align-items:center; padding:10px; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:8px; }
    .shift-row.leave { background:#fef2f2; border-color:#fecaca; } /* สีแดงสำหรับวันลา */
    .shift-row.work { background:#f0fdfa; border-color:#ccfbf1; }  /* สีเขียวสำหรับวันทำงาน */
    .btn-sm { padding:4px 8px; font-size:11px; }

  </style>
</head>
<body>

  <div id="toast-container"></div>

  <div class="container">
    <div class="headline">ระบบนัดหมาย & ตารางเวร</div>
    <div class="sub-muted">จัดการตารางนัดหมายและเวรแพทย์ (เชื่อมต่อฐานข้อมูล)</div>

    <div class="chips">
      <span class="chip active" data-tab="daily">ตารางนัดรายวัน</span>
      <span class="chip" data-tab="monthly">ตารางเวรรายเดือน</span>
      <span class="chip" data-tab="settings">ตั้งค่า</span>
    </div>

    <div class="panel active" id="panel-daily">
      <div style="margin-top:15px; display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px; align-items:center;">
        <div style="display:flex; gap:10px;">
          <button class="btn btn-ghost" onclick="Daily.goToday()">วันนี้</button>
          <input type="date" class="ipt" style="width:auto;" id="dailyDatepicker">
        </div>
        <button class="btn btn-primary" onclick="Modal.openAppt()">+ เพิ่มนัด</button>
      </div>

      <div class="paperWrap">
        <div class="paperHeader">
          <div id="dailyHeaderTitle" style="font-weight:600; color:#0f766e;">กำลังโหลด...</div>
          <div style="font-size:12px; color:#64748b;">*คลิกช่องว่างเพื่อลงนัด</div>
        </div>
        <div class="tableScroll">
          <table class="clean">
            <thead>
              <tr>
                <th class="timeCell">เวลา</th>
                <th>เคสแพทย์ (1)</th>
                <th>เคสแพทย์ (2)</th>
                <th>Treatment (3)</th>
                <th>IV/Drip (4)</th>
              </tr>
            </thead>
            <tbody id="dailyTableBody">
              </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="panel" id="panel-monthly">
      <div style="margin-top:15px; border:1px solid #e2e8f0; border-radius:12px; padding:0; background:#fff; overflow:hidden;">
        
        <div class="iosMonthHeader" style="padding:15px;">
          <div id="monthTitle" style="font-size:18px; font-weight:600; color:#0f172a;">-</div>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-ghost" onclick="Roster.goToday()">เดือนนี้</button>
            <input type="month" class="ipt" id="monthPicker" style="width:auto; padding:6px;">
          </div>
        </div>

        <div class="iosWeekHead">
          <div>อา.</div><div>จ.</div><div>อ.</div><div>พ.</div><div>พฤ.</div><div>ศ.</div><div>ส.</div>
        </div>

        <div class="iosGrid" id="monthGrid">
          </div>

      </div>
    </div>

    <div class="panel" id="panel-settings">
      <div style="padding:10px;">
        <div style="font-weight:600; color:#0f766e; margin-bottom:15px; font-size:16px;">จัดการพนักงาน</div>
        
        <div style="background:#fff; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:20px;">
           <div style="display:grid; grid-template-columns: 2fr 1.5fr 0.5fr auto; gap:10px; align-items:end;">
              <div>
                <label style="display:block; margin-bottom:4px; font-weight:500;">ชื่อพนักงาน</label>
                <input class="ipt" id="newStaffName" placeholder="ชื่อ-สกุล">
              </div>
              <div>
                <label style="display:block; margin-bottom:4px; font-weight:500;">ตำแหน่ง</label>
                <select class="ipt" id="newStaffRole">
                  <option value="doctor">แพทย์ (Doctor)</option>
                  <option value="nurse">พยาบาล (Nurse)</option>
                  <option value="staff">จนท.ทั่วไป</option>
                </select>
              </div>
              <div>
                <label style="display:block; margin-bottom:4px; font-weight:500;">สี</label>
                <input type="color" class="ipt" id="newStaffColor" style="padding:2px; height:42px;" value="#0ea5e9">
              </div>
              <button class="btn btn-primary" onclick="Settings.addStaff()">+ เพิ่ม</button>
           </div>
        </div>

        <div style="font-weight:500; margin-bottom:10px; color:#64748b;">รายชื่อพนักงานทั้งหมด</div>
        <div id="staffListContainer" style="background:#fff; border-radius:12px; border:1px solid #e2e8f0; overflow:hidden;">
           </div>
      </div>
    </div>
  </div>

  <div class="modal" id="apptModal" onclick="Modal.closeBackdrop(event, 'apptModal')">
    <div class="modal-box" onclick="event.stopPropagation()">
      <div class="modal-hdr">
        <span id="apptModalTitle">ลงนัดหมายใหม่</span>
        <button onclick="Modal.close('apptModal')" style="background:none; border:none; font-size:18px; cursor:pointer;">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="apptId">
        <input type="hidden" id="apptCustId">

        <label style="font-weight:500; display:block; margin-bottom:5px;">ประเภทลูกค้า</label>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
          <label><input type="radio" name="custType" value="existing" checked onchange="Modal.toggleCustType()"> ลูกค้าเก่า</label>
          <label><input type="radio" name="custType" value="guest" onchange="Modal.toggleCustType()"> ลูกค้าใหม่ (Walk-in)</label>
        </div>

        <div id="boxExisting">
          <label style="font-weight:500; display:block; margin-bottom:5px;">ค้นหาลูกค้า (ชื่อ/เบอร์)</label>
          <div class="search-wrapper">
            <input type="text" class="ipt" id="searchCustInput" placeholder="พิมพ์เพื่อค้นหา..." onkeyup="Search.debounce(this.value)">
            <div class="search-dropdown" id="searchDropdown"></div>
          </div>
        </div>

        <div id="boxGuest" style="display:none;">
          <label style="font-weight:500; display:block; margin-bottom:5px;">ชื่อลูกค้า</label>
          <input type="text" class="ipt" id="guestName" placeholder="ระบุชื่อ">
          <label style="font-weight:500; display:block; margin-top:10px; margin-bottom:5px;">เบอร์โทร</label>
          <input type="text" class="ipt" id="guestPhone" placeholder="ระบุเบอร์โทร">
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
          <div>
            <label style="font-weight:500; display:block; margin-bottom:5px;">วันที่</label>
            <input type="date" class="ipt" id="apptDate">
          </div>
          <div>
            <label style="font-weight:500; display:block; margin-bottom:5px;">เวลา</label>
            <input type="time" class="ipt" id="apptTime">
          </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
           <div>
            <label style="font-weight:500; display:block; margin-bottom:5px;">ลงช่อง</label>
            <select class="ipt" id="apptCol">
              <option value="1">แพทย์ 1</option>
              <option value="2">แพทย์ 2</option>
              <option value="3">Treatment</option>
              <option value="4">IV/Drip</option>
            </select>
           </div>
           <div>
            <label style="font-weight:500; display:block; margin-bottom:5px;">หัตถการ</label>
            <input type="text" class="ipt" id="apptProc" placeholder="เช่น Botox">
           </div>
        </div>

        <div style="margin-top:15px;">
           <label style="font-weight:500; display:block; margin-bottom:5px;">หมายเหตุ</label>
           <textarea class="ipt" id="apptNote" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-ftr" id="apptModalFtr">
        </div>
    </div>
  </div>
<div class="modal" id="rosterModal" onclick="Modal.closeBackdrop(event, 'rosterModal')">
    <div class="modal-box" onclick="event.stopPropagation()">
      <div class="modal-hdr">
        <span id="rosterDateTitle">จัดการเวร</span>
        <button onclick="Modal.close('rosterModal')" style="background:none; border:none; font-size:18px; cursor:pointer;">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="rosterSelectedDate">
        
        <div style="font-weight:500; color:#64748b; margin-bottom:5px; font-size:11px;">รายการที่มีอยู่</div>
        <div id="rosterList" style="margin-bottom:15px; min-height:30px;"></div>

        <hr style="border:0; border-top:1px solid #e2e8f0; margin-bottom:15px;">

        <div style="font-weight:600; color:#0f766e; margin-bottom:10px;">+ เพิ่มรายการใหม่</div>
        
        <label style="font-weight:500; display:block; margin-bottom:5px;">เลือกพนักงาน</label>
        <select class="ipt" id="rosterStaffId">
            <option value="">-- กำลังโหลด --</option>
        </select>

        <label style="font-weight:500; display:block; margin-top:10px; margin-bottom:5px;">ประเภท</label>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
           <label><input type="radio" name="workType" value="work" checked onchange="Roster.toggleLeave()"> เข้างาน</label>
           <label><input type="radio" name="workType" value="leave" onchange="Roster.toggleLeave()"> ลาหยุด/Off</label>
        </div>

        <div id="workTimeBox">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div>
                    <label style="font-weight:500; display:block; margin-bottom:5px;">เริ่ม</label>
                    <input type="time" class="ipt" id="rosterStart" value="11:00">
                </div>
                <div>
                    <label style="font-weight:500; display:block; margin-bottom:5px;">เลิก</label>
                    <input type="time" class="ipt" id="rosterEnd" value="20:00">
                </div>
            </div>
        </div>
        
        <div style="margin-top:10px;">
            <label style="font-weight:500; display:block; margin-bottom:5px;">โน้ตเพิ่มเติม</label>
            <input type="text" class="ipt" id="rosterNote" placeholder="เช่น เวรเช้า / ลากิจ">
        </div>

        <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="Roster.save()">บันทึกรายการ</button>
      </div>
    </div>
  </div>
  <div class="modal" id="confirmModal">
    <div class="modal-box" style="max-width:350px;">
      <div class="modal-body" style="text-align:center; padding-top:30px;">
        <div style="font-size:16px; font-weight:600; margin-bottom:8px;">ยืนยันการทำรายการ</div>
        <div style="color:#64748b; margin-bottom:20px;">ต้องการลบรายการนี้ใช่หรือไม่?</div>
        <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
          <button class="btn btn-ghost" onclick="Modal.close('confirmModal')">ยกเลิก</button>
          <button class="btn btn-danger" id="confirmYesBtn">ยืนยัน</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Utilities ---
    const $ = id => document.getElementById(id);
    const api = async (url, method='GET', body=null) => {
      try {
        const opts = { method, headers: {'Content-Type': 'application/json'} };
        if(body) opts.body = JSON.stringify(body);
        const res = await fetch(url, opts);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch(e) {
        console.warn('API Fetch Error:', e);
        // Fallback for demo if backend is offline
        if(url.includes('get_appointments')) return []; 
        if(url.includes('get_roster')) return [];
        
        Toast.show('Connection Error', 'error');
        return null;
      }
    };
    
    // --- Toast Notification ---
    const Toast = {
      show(msg, type='success') {
        const c = $('toast-container');
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.innerHTML = `<span>${msg}</span> <span style="cursor:pointer" onclick="this.parentElement.remove()">×</span>`;
        c.appendChild(el);
        setTimeout(() => { el.style.opacity='0'; setTimeout(()=>el.remove(), 300); }, 3000);
      }
    };

    // --- Search Logic ---
    const Search = {
      timer: null,
      debounce(kw) {
        clearTimeout(this.timer);
        this.timer = setTimeout(() => this.exec(kw), 400);
      },
      async exec(kw) {
        if(!kw || kw.length < 2) { $('searchDropdown').style.display='none'; return; }
        const res = await api(`/api/search_customer?q=${kw}`);
        const box = $('searchDropdown');
        box.innerHTML = '';
        if(res && res.length > 0) {
          res.forEach(c => {
            const div = document.createElement('div');
            div.className = 'search-item';
            div.innerHTML = `<strong>${c.name}</strong><small>${c.phone || '-'} | OPD: ${c.opd}</small>`;
            div.onclick = () => {
              $('searchCustInput').value = c.name;
              $('apptCustId').value = c.id || ''; 
              box.style.display = 'none';
            };
            box.appendChild(div);
          });
          box.style.display = 'block';
        } else {
          box.innerHTML = '<div class="search-item" style="color:#ef4444">ไม่พบข้อมูล</div>';
          box.style.display = 'block';
        }
      }
    };

    // --- Modal Logic ---
    const Modal = {
      open(id) { $(id).classList.add('show'); },
      close(id) { $(id).classList.remove('show'); },
      closeBackdrop(e, id) { if(e.target.id === id) this.close(id); },
      
      toggleCustType() {
        const type = document.querySelector('input[name="custType"]:checked').value;
        $('boxExisting').style.display = type === 'existing' ? 'block' : 'none';
        $('boxGuest').style.display = type === 'guest' ? 'block' : 'none';
      },

      openAppt(data = null) {
        // Reset Form
        $('apptId').value = '';
        $('apptCustId').value = '';
        $('searchCustInput').value = '';
        $('guestName').value = '';
        $('guestPhone').value = '';
        $('apptProc').value = '';
        $('apptNote').value = '';
        $('searchDropdown').style.display = 'none';
        
        // Default Date/Time
        $('apptDate').value = $('dailyDatepicker').value;
        $('apptTime').value = '11:00';
        $('apptCol').value = '1';

        // Pre-fill if editing or clicking slot
        if(data) {
            if(data.id) { // Editing existing
                $('apptModalTitle').innerText = 'แก้ไขนัดหมาย';
                $('apptId').value = data.id;
                $('apptDate').value = data.appt_date;
                // Cut seconds if present
                $('apptTime').value = data.start_time.substring(0,5);
                $('apptCol').value = data.column_id;
                $('apptProc').value = data.procedure || '';
                $('apptNote').value = data.note || '';
                
                if(data.customer_id || data.opd) { // Existing Cust
                    document.querySelector('input[name="custType"][value="existing"]').checked = true;
                    $('searchCustInput').value = data.customer_name || data.opd; // Mock display
                    $('apptCustId').value = data.customer_id;
                } else { // Guest
                    document.querySelector('input[name="custType"][value="guest"]').checked = true;
                    $('guestName').value = data.guest_name;
                    $('guestPhone').value = data.guest_phone;
                }
            } else { // New from slot click
                $('apptModalTitle').innerText = 'ลงนัดหมายใหม่';
                if(data.time) $('apptTime').value = data.time;
                if(data.col) $('apptCol').value = data.col;
            }
        } else {
             $('apptModalTitle').innerText = 'ลงนัดหมายใหม่';
        }
        
        this.toggleCustType();
        this.renderButtons();
        this.open('apptModal');
      },

      renderButtons() {
        const isEdit = !!$('apptId').value;
        const btnSave = `<button class="btn btn-primary" onclick="Daily.save()">บันทึก</button>`;
        const btnDel = isEdit ? `<button class="btn btn-danger" onclick="Daily.confirmDelete()">ลบ</button>` : '';
        const btnCancel = `<button class="btn btn-ghost" onclick="Modal.close('apptModal')">ยกเลิก</button>`;
        $('apptModalFtr').innerHTML = `${btnDel} ${btnCancel} ${btnSave}`;
      }
    };

    // --- Daily Schedule Logic ---
    const Daily = {
      init() {
        const today = new Date().toISOString().split('T')[0];
        $('dailyDatepicker').value = today;
        $('dailyDatepicker').addEventListener('change', () => this.load());
        this.load();
      },
      goToday() {
        $('dailyDatepicker').value = new Date().toISOString().split('T')[0];
        this.load();
      },
      async load() {
        const date = $('dailyDatepicker').value;
        $('dailyHeaderTitle').innerText = `ตารางนัดวันที่ ${this.formatDateTH(date)}`;
        
        const tbody = $('dailyTableBody');
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#64748b;padding:20px;">กำลังโหลด...</td></tr>';

        const appts = await api(`/api/get_appointments?date=${date}`);
        this.renderTable(appts || []);
      },
      renderTable(appts) {
        const tbody = $('dailyTableBody');
        tbody.innerHTML = '';
        
        // Time slots 11:00 - 19:30 (interval 30 mins)
        const times = [];
        for(let h=11; h<20; h++) {
            times.push(`${h.toString().padStart(2,'0')}:00`);
            if(h<20) times.push(`${h.toString().padStart(2,'0')}:30`);
        }

        times.forEach(t => {
            const tr = document.createElement('tr');
            
            // Time Column
            const tdTime = document.createElement('td');
            tdTime.className = 'timeCell';
            tdTime.innerText = t;
            tr.appendChild(tdTime);

            // Columns 1-4
            for(let c=1; c<=4; c++) {
                const td = document.createElement('td');
                // Find appt matching time & col
                const found = appts.find(a => a.start_time.startsWith(t) && a.column_id == c);

                if(found) {
                    const isGuest = !found.customer_id && !found.opd;
                    const nameDisplay = isGuest ? (found.guest_name || 'Guest') : (found.opd ? `คุณ ${found.guest_name || 'ลูกค้า'} (${found.opd})` : 'ลูกค้าเก่า'); 
                    
                    const div = document.createElement('div');
                    div.className = `apptCard ${isGuest ? 'guest' : ''}`;
                    div.innerHTML = `
    <div class="name">${nameDisplay}</div>
    <div style="font-size:10px; color:#64748b; margin-bottom:2px;">
        ${found.guest_phone || ''}
    </div>
    
    <div class="sub">
        <span>${found.service || '-'}</span> 
        <span>${found.status}</span>
    </div>
`;
                    div.onclick = () => Modal.openAppt(found);
                    td.appendChild(div);
                } else {
                    const div = document.createElement('div');
                    div.className = 'slotEmpty';
                    div.onclick = () => Modal.openAppt({ time: t, col: c });
                    td.appendChild(div);
                }
                tr.appendChild(td);
            }
            tbody.appendChild(tr);
        });
      },
      async save() {
        const id = $('apptId').value;
        const type = document.querySelector('input[name="custType"]:checked').value;
        const payload = {
            appt_date: $('apptDate').value,
            start_time: $('apptTime').value,
            column_id: $('apptCol').value,
            service: $('apptProc').value,
            note: $('apptNote').value,
            status: 'pending' // Default
        };

        if(type === 'existing') {
            const custId = $('apptCustId').value;
            if(custId) payload.customer_id = custId; 
            else payload.guest_name = $('searchCustInput').value; 
        } else {
            payload.guest_name = $('guestName').value;
            payload.guest_phone = $('guestPhone').value;
        }

        // Logic check: If editing, delete first (Simple approach for now)
        if(id) {
            await api('/api/delete_appointment', 'POST', {id: id});
        }

        const res = await api('/api/save_appointment', 'POST', payload);
        if(res && res.success) {
            Toast.show('บันทึกสำเร็จ');
            Modal.close('apptModal');
            this.load();
        } else {
            Toast.show('เกิดข้อผิดพลาด', 'error');
        }
      },
      confirmDelete() {
        const id = $('apptId').value;
        if(!id) return;
        $('confirmYesBtn').onclick = () => this.doDelete(id);
        Modal.open('confirmModal');
      },
      async doDelete(id) {
        const res = await api('/api/delete_appointment', 'POST', {id: id});
        if(res && res.success) {
            Toast.show('ลบรายการสำเร็จ');
            Modal.close('confirmModal');
            Modal.close('apptModal');
            this.load();
        } else {
            Toast.show('ลบไม่สำเร็จ', 'error');
        }
      },
      formatDateTH(dateStr) {
        if(!dateStr) return '';
        const d = new Date(dateStr);
        return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });
      }
    };

    // --- 4.1 ROSTER LOGIC (แบบใหม่ รองรับ Staff/Leave) ---
    const Roster = {
        staffs: [],
        currentShifts: [],
        
        init() {
            const d = new Date();
            // ตั้งค่า input month เป็นเดือนปัจจุบัน
            $('monthPicker').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            $('monthPicker').addEventListener('change', ()=>this.load());
            
            // โหลดรายชื่อพนักงานเตรียมไว้สำหรับ Dropdown
            this.loadStaffs();
        },
        goToday() { this.init(); this.load(); },
        
        async loadStaffs() {
            this.staffs = await api('/api/staffs'); // เรียก API Staffs
            const sel = $('rosterStaffId'); 
            sel.innerHTML = '<option value="">-- เลือกพนักงาน --</option>';
            if(this.staffs) {
                this.staffs.forEach(s => {
                    sel.innerHTML += `<option value="${s.id}">${s.name} (${s.role})</option>`;
                });
            }
        },
        
        async load() {
            const ym = $('monthPicker').value;
            const [y, m] = ym.split('-');
            $('monthTitle').innerText = new Date(y, m-1, 1).toLocaleDateString('th-TH', {month:'long', year:'numeric'});
            $('monthGrid').innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;">โหลดตารางเวร...</div>';
            
            const shifts = await api(`/api/get_roster?month=${ym}`);
            this.renderCalendar(y, m, shifts||[]);
        },
        
        renderCalendar(y, m, shifts) {
            const grid = $('monthGrid'); grid.innerHTML='';
            const firstDay = new Date(y, m-1, 1).getDay();
            const daysInMonth = new Date(y, m, 0).getDate();
            
            // ช่องว่างก่อนวันที่ 1
            for(let i=0; i<firstDay; i++) grid.innerHTML+=`<div class="iosDay" style="background:#f8fafc;"></div>`;
            
            const today = new Date().toISOString().split('T')[0];
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayShifts = shifts.filter(s => s.date === dateStr);
                
                let html = `<div class="iosDay ${today===dateStr?'today':''}" onclick="Roster.openModal('${dateStr}')">
                              <div class="num">${d}</div>`;
                
                dayShifts.forEach(s => {
                    const isLeave = s.work_type === 'leave';
                    // แยกสี: ลา=แดง, ทำงาน=เขียว (หรือสีประจำตัวถ้ามี)
                    const style = isLeave ? 'background:#fee2e2; color:#b91c1c;' : 
                                  (s.staff_color ? `background:${s.staff_color}20; color:${s.staff_color}; border-left:2px solid ${s.staff_color};` : 'background:#ccfbf1; color:#0f766e;');
                    
                    const txt = isLeave ? `ลาหยุด (${s.staff_name})` : `${s.staff_name}`;
                    const tm = isLeave ? '' : `<span style="opacity:0.7; font-size:9px;">${s.start_time.slice(0,5)}</span>`;
                    
                    html += `<div class="eventPill" style="${style}">${txt} ${tm}</div>`;
                });
                
                grid.innerHTML += html + `</div>`;
            }
            this.currentShifts = shifts; // เก็บไว้ใช้ตอนกดเปิด Modal
        },
        
        openModal(date) {
            $('rosterSelectedDate').value = date;
            $('rosterDateTitle').innerText = `จัดการเวรวันที่ ${new Date(date).toLocaleDateString('th-TH', {day:'numeric', month:'short'})}`;
            
            // แสดงรายการที่มีอยู่
            const list = $('rosterList'); list.innerHTML = '';
            const existing = this.currentShifts.filter(s => s.date === date);
            
            if(existing.length === 0) list.innerHTML = '<div style="color:#ccc;text-align:center;padding:10px;">- ยังไม่มีรายการ -</div>';
            else existing.forEach(s => {
                const isLeave = s.work_type === 'leave';
                const div = document.createElement('div');
                div.className = `shift-row ${isLeave?'leave':'work'}`;
                
                const timeInfo = isLeave ? '<b>ลาหยุด/Off</b>' : `${s.start_time.slice(0,5)} - ${s.end_time.slice(0,5)}`;
                
                div.innerHTML = `
                    <div>
                        <strong>${s.staff_name}</strong> <small>(${s.staff_role})</small><br>
                        <span style="font-size:11px;">${timeInfo} ${s.note?`(${s.note})`:''}</span>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="Roster.deleteShift('${s.id}')">ลบ</button>
                `;
                list.appendChild(div);
            });
            
            // รีเซ็ตฟอร์ม
            $('rosterStaffId').value = '';
            document.querySelector('input[name="workType"][value="work"]').checked = true; 
            this.toggleLeave();
            $('rosterStart').value='11:00'; $('rosterEnd').value='20:00'; $('rosterNote').value='';
            
            Modal.open('rosterModal');
        },
        
        toggleLeave() {
            const t = document.querySelector('input[name="workType"]:checked').value;
            $('workTimeBox').style.display = t==='leave' ? 'none' : 'block';
        },
        
        async save() {
            const staffId = $('rosterStaffId').value;
            if(!staffId) return Toast.show('กรุณาเลือกพนักงาน', 'error');
            
            const payload = {
                staff_id: staffId,
                date: $('rosterSelectedDate').value,
                work_type: document.querySelector('input[name="workType"]:checked').value,
                start_time: $('rosterStart').value,
                end_time: $('rosterEnd').value,
                note: $('rosterNote').value
            };
            
            const res = await api('/api/save_roster', 'POST', payload);
            if(res && res.success) {
                Toast.show('บันทึกสำเร็จ');
                Modal.close('rosterModal');
                this.load(); // โหลดปฏิทินใหม่
            } else {
                Toast.show('เกิดข้อผิดพลาด', 'error');
            }
        },
        
        async deleteShift(id) {
            if(!confirm('ยืนยันลบรายการนี้?')) return;
            const res = await api('/api/delete_roster', 'POST', {id});
            if(res && res.success) {
                // Refresh แบบง่าย: โหลดใหม่แล้วปิด Modal
                this.load();
                Modal.close('rosterModal');
                Toast.show('ลบแล้ว');
            }
        }
    };

    // --- 4.2 SETTINGS LOGIC (จัดการพนักงาน) ---
    const Settings = {
        async load() {
            const box = $('staffListContainer');
            box.innerHTML = '<div style="padding:20px; text-align:center;">กำลังโหลด...</div>';
            
            const staffs = await api('/api/staffs');
            box.innerHTML = '';
            
            if(!staffs || staffs.length === 0) {
                box.innerHTML = '<div style="padding:20px; text-align:center; color:#ccc;">ยังไม่มีพนักงาน</div>';
                return;
            }
            
            staffs.forEach(s => {
                const div = document.createElement('div');
                div.style.cssText = "padding:10px 15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;";
                div.innerHTML = `
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div style="width:30px; height:30px; border-radius:50%; background:${s.color_code||'#ccc'}; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:bold;">${s.name.charAt(0)}</div>
                        <div>
                            <div style="font-weight:500;">${s.name}</div>
                            <div style="font-size:11px; color:#64748b;">${s.role}</div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-ghost" style="color:#ef4444;" onclick="Settings.del(${s.id})">ลบ</button>
                `;
                box.appendChild(div);
            });
        },
        
        async addStaff() {
            const name = $('newStaffName').value;
            const role = $('newStaffRole').value;
            const color = $('newStaffColor').value;
            if(!name) return Toast.show('กรุณากรอกชื่อ', 'error');
            
            const res = await api('/api/staffs', 'POST', {name, role, color_code: color});
            if(res && res.success) {
                Toast.show('เพิ่มพนักงานแล้ว');
                $('newStaffName').value = '';
                this.load(); // รีเฟรชลิสต์
                Roster.loadStaffs(); // อัปเดต dropdown ในหน้าเวรด้วย
            } else {
                Toast.show('เกิดข้อผิดพลาด', 'error');
            }
        },
        
        async del(id) {
            if(!confirm('ลบพนักงานคนนี้?')) return;
            const res = await api('/api/staffs', 'DELETE', {id}); // ต้องแก้ api.delete ให้รองรับ body หรือส่ง query param
            // หมายเหตุ: โค้ด api helper เดิมรองรับ POST เป็นหลัก ถ้า DELETE อาจต้องปรับนิดหน่อย
            // หรือใช้ POST ไปที่ endpoint ลบก็ได้ตาม app.py ที่ให้ไป
            
            // เพื่อความชัวร์ ใช้ fetch ตรงๆ สำหรับ delete ตามที่ app.py เขียนไว้ (method DELETE + query param id)
            try {
                await fetch(`/api/staffs?id=${id}`, { method: 'DELETE' });
                Toast.show('ลบสำเร็จ');
                this.load();
                Roster.loadStaffs();
            } catch(e) { Toast.show('ลบไม่สำเร็จ', 'error'); }
        }
    };

    // เพิ่มการเรียก Settings.load() เมื่อกด Tab Settings
    document.querySelector('.chip[data-tab="settings"]').addEventListener('click', () => Settings.load());

    // --- Tab Navigation ---
    document.querySelectorAll('.chip').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        const tab = el.dataset.tab;
        $(`panel-${tab}`).classList.add('active');

        if(tab === 'monthly') Roster.load();
      });
    });

    // --- Init ---
    Daily.init();
    Roster.init();

  </script>
  {% include "floating_menu.html" %}
</body>
</html>