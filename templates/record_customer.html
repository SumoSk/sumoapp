<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Profile)</title>
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a;
      --primary:#0f766e; --primary-600:#0d9488; --ring:#ccfbf1;
      --line:#e2e8f0; --danger:#ef4444; --warn:#f59e0b; --success:#22c55e;
      --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Prompt', sans-serif;
      color:var(--text); background:var(--bg);
      font-size: 12px; margin:0;
    }

    .container{ max-width:1200px; margin: 20px auto 100px; padding: 0 16px; }
    
    /* Header ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏•‡∏µ‡∏ô‡πÜ */
    header.appbar{
      position:sticky; top:0; z-index:50; 
      background: rgba(255,255,255,0.9); backdrop-filter: blur(8px);
      border-bottom:1px solid var(--line);
    }
    .appbar-inner{ max-width:1200px; margin:0 auto; padding: 12px 16px; display:flex; align-items:center; gap:10px; }
    .title{ font-weight:700; font-size: 18px; color: var(--primary); display:flex; align-items:center; gap:8px; }
    .grow{flex:1}

    .btn{
      appearance:none; border:none; border-radius:8px; padding:8px 14px; cursor:pointer; font-weight:500;
      display:inline-flex; align-items:center; gap:6px; transition: all .2s; font-family:inherit; font-size:12px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background:var(--primary); color:white; box-shadow: 0 2px 6px rgba(15, 118, 110, 0.2); }
    .btn-primary:hover{ background:var(--primary-600); }
    .btn-ghost{ background:transparent; color:var(--text); border:1px solid transparent; }
    .btn-ghost:hover{ background:#f1f5f9; }
    .btn-danger{ background:#fee2e2; color:#b91c1c; }
    .btn-danger:hover{ background:#fecaca; }
    .btn-icon{ padding:6px; }
    .btn-icon svg{ width:18px; height:18px; }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }

    /* Toolbar */
    .toolbar{
      display:flex; flex-wrap:wrap; gap:10px; padding: 12px; align-items:center;
      border-bottom:1px solid var(--line); background: #f8fafc; border-radius: var(--radius) var(--radius) 0 0;
    }
    .search{ position:relative; flex:1; min-width: 240px; }
    .search input{
      width:100%; padding:9px 34px 9px 36px; border:1px solid var(--line); border-radius: 8px;
      outline:none; background:#fff; font-size:13px; transition: border-color .2s;
    }
    .search input:focus{ border-color: var(--primary); box-shadow: 0 0 0 3px var(--ring); }
    .search .icon{ position:absolute; left:10px; top:50%; transform:translateY(-50%); opacity:.5; font-size:16px; }
    .search .clear{ position:absolute; right:10px; top:50%; transform:translateY(-50%); opacity:.5; cursor:pointer; font-size:14px; }

    .month-filter{ border:1px solid var(--line); border-radius:8px; padding:8px; background:#fff; font-size:12px; cursor:pointer; }
    .chip{ display:inline-flex; align-items:center; padding:4px 10px; border-radius:99px; font-size:11px; background:#e0f2f1; color:#0f766e; font-weight:600; }

    .table-wrap{ overflow-x:auto; }

    /* Table Styles */
    table{ width:100%; border-collapse:collapse; font-size: 12px; min-width: 900px; }
    thead th{
      position:sticky; top:0; z-index:1; background:#f1f5f9; color:#475569;
      font-weight:600; text-align:left; padding:10px 12px; border-bottom:1px solid var(--line);
      white-space: nowrap; cursor:pointer; user-select:none;
    }
    thead th:hover{ background:#e2e8f0; }
    tbody td{
      padding:8px 12px; border-bottom:1px solid var(--line); vertical-align:top; color: #334155;
    }
    tbody tr:hover td{ background:#f8fafc; }

    /* Input ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    td .cell{ display:flex; align-items:center; width:100%; }
    td input, td textarea{
      width:100%; border:1px solid transparent; background:transparent;
      padding:4px; font-family:inherit; font-size:inherit; color:inherit; resize:none; border-radius:4px;
    }
    td input:focus, td textarea:focus{ outline:none; }
    tr.editing td input, tr.editing td textarea{
      background:#fff; border-color: #cbd5e1; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    /* Column Widths & Specifics */
    th.sel-col, td.sel-col{ width: 40px; text-align:center; padding-left:4px; padding-right:4px;}
    
    /* OPD */
    th[data-key="opd"], td[data-col="opd"]{ width: 80px; font-weight:600; color: var(--primary); }
    td[data-col="opd"] input { text-align:center; letter-spacing:0.5px; }

    /* Name */
    th[data-key="name"], td[data-col="name"]{ width: 180px; font-weight:600; }

    /* Profile (‡∏û‡∏£‡∏∞‡πÄ‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô) */
    th[data-key="profile"], td[data-col="profile"]{ width: auto; min-width: 250px; }
    td[data-col="profile"] textarea { min-height: 2.8em; line-height: 1.4; color: #475569; }

    /* Note */
    th[data-key="note"], td[data-col="note"]{ width: 180px; }
    
    /* Birth Month */
    th[data-key="birthMonth"], td[data-col="birthMonth"]{ width: 90px; text-align:center; }
    td[data-col="birthMonth"] input { text-align:center; }

    /* Phone (Hidden by default) */
    th[data-key="phone"]{ display:none; }
    td.phone-col{ display:none; width:110px; }
    tr.editing td.phone-col{ display:table-cell; }

    /* Actions */
    th:last-child, td:last-child{ width: 100px; text-align:center; }
    .actions{ display:flex; justify-content:center; gap:4px; opacity:0.6; transition:opacity .2s; }
    tr:hover .actions{ opacity:1; }

    /* Skeleton */
    .skeleton{ height:12px; background:#e2e8f0; border-radius:4px; animation: pulse 1.5s infinite; }
    @keyframes pulse{ 0%{opacity:.6} 50%{opacity:.3} 100%{opacity:.6} }

    /* Toast */
    .toast-wrap{ position:fixed; right:20px; bottom:20px; z-index:100; display:flex; flex-direction:column; gap:10px; }
    .toast{
      background:#fff; border-left:4px solid var(--success); padding:12px 16px; border-radius:8px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1); font-weight:500; display:flex; align-items:center; gap:10px;
      transform:translateY(20px); opacity:0; transition:all .3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .toast.show{ transform:translateY(0); opacity:1; }
    .toast.error{ border-left-color:var(--danger); }
    .toast.warn{ border-left-color:var(--warn); }

    /* Modal */
    .modal{ position:fixed; inset:0; z-index:60; display:none; align-items:center; justify-content:center; }
    .modal.open{ display:flex; }
    .modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,0.4); backdrop-filter:blur(2px); }
    .modal-box{
      position:relative; width:90%; max-width:500px; background:#fff; border-radius:16px;
      box-shadow:0 20px 50px rgba(0,0,0,0.2); padding:20px; animation: popIn .2s ease;
    }
    @keyframes popIn{ from{transform:scale(0.95); opacity:0} to{transform:scale(1); opacity:1} }
    .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .modal-title{ font-size:16px; font-weight:700; color:var(--primary); }
    .field-group{ margin-bottom:12px; }
    .field-group label{ display:block; margin-bottom:4px; font-weight:600; font-size:11px; color:#64748b; }
    .field-group input, .field-group textarea{
      width:100%; padding:8px 12px; border:1px solid var(--line); border-radius:8px; font-family:inherit; font-size:13px;
    }
    .field-group textarea{ resize:vertical; min-height:80px; }
    .modal-footer{ display:flex; justify-content:flex-end; gap:8px; margin-top:20px; }

    /* Scroll Top */
    #scrollTop{
      position:fixed; right:20px; bottom:20px; width:40px; height:40px; border-radius:50%;
      background:var(--primary); color:white; border:none; cursor:pointer;
      display:flex; align-items:center; justify-content:center; font-size:20px;
      box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3); opacity:0; pointer-events:none; transition:all .3s;
    }
    #scrollTop.visible{ opacity:1; bottom:80px; pointer-events:auto; }

    @media (max-width: 768px){
      .container{ margin-top:10px; padding:0 10px; }
      .toolbar{ gap:8px; padding:8px; }
      .search{ min-width:100%; order:2; }
      .btn{ padding:6px 10px; font-size:11px; }
      th[data-key="note"], td[data-col="note"]{ display:none; } /* ‡∏ã‡πà‡∏≠‡∏ô Note ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    }
    .floating-toggle {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: white; border: 1px solid var(--line);
    width: 50px; height: 50px; border-radius: 50%;
    box-shadow: 0 4px 14px rgba(0,0,0,0.15);
    display: flex; justify-content: center; align-items: center;
    z-index: 1000; cursor: pointer; transition: transform 0.1s;
  }
  .floating-toggle:active { transform: translateX(-50%) scale(0.95); }
  .floating-toggle img { width: 24px; height: 24px; opacity: 0.7; }
  
  .floating-menu {
    position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%);
    background: white; border-radius: 16px; padding: 8px;
    display: none; flex-direction: column; gap: 4px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 999;
    width: max-content; border: 1px solid var(--line);
  }
  .floating-menu.open { display: flex; animation: slideUp 0.2s ease; }
  @keyframes slideUp { from{opacity:0; transform:translate(-50%, 10px)} to{opacity:1; transform:translate(-50%, 0)} }
  
  .floating-menu a {
    display: flex; align-items: center; gap: 10px; padding: 8px 16px;
    text-decoration: none; color: #334155; font-weight: 500; border-radius: 8px;
  }
  .floating-menu a:hover { background: #f1f5f9; color: var(--primary); }
  .floating-menu img { width: 24px; height: 24px; object-fit: contain; }
  </style>
</head>
<body>

  <header class="appbar">
    <div class="appbar-inner">
      <div class="title">üìñ ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
      <div class="grow"></div>
      <button id="refreshBtn" class="btn btn-ghost">‚ü≥ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      <button id="openAddModalBtn" class="btn btn-primary">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <div class="toolbar">
        <div class="search">
          <span class="icon">üîé</span>
          <input id="searchInput" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏ö‡∏≠‡∏£‡πå, OPD, ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå...">
          <span id="clearSearch" class="clear" style="display:none;">‚úñ</span>
        </div>
        <select id="monthFilter" class="month-filter">
          <option value="">üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="01">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option><option value="02">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option><option value="03">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
          <option value="04">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option><option value="05">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option><option value="06">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
          <option value="07">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option><option value="08">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option><option value="09">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
          <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option><option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option><option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
        </select>
        <div class="grow"></div>
        <div class="chip" id="totalChip">0 ‡∏Ñ‡∏ô</div>
        <button id="bulkDeleteBtn" class="btn btn-ghost btn-icon" style="color:var(--danger);" title="‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">üóëÔ∏è</button>
        <button id="exportBtn" class="btn btn-ghost btn-icon" title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV">üì•</button>
      </div>

      <div class="table-wrap">
        <table id="customerTable">
          <thead>
            <tr>
              <th class="sel-col"><input type="checkbox" id="selectAll"></th>
              <th data-key="opd">OPD ‚Üï</th>
              <th data-key="name">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‚Üï</th>
              <th data-key="phone"></th>
              <th data-key="birthMonth">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‚Üï</th>
              <th data-key="profile">üìù ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏£‡∏π‡πâ) ‚Üï</th>
              <th data-key="note">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ‚Üï</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="7"><div style="padding:20px"><div class="skeleton" style="margin-bottom:10px"></div><div class="skeleton" style="width:80%"></div></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="addModal" class="modal">
    <div class="modal-backdrop" onclick="closeModal()"></div>
    <div class="modal-box">
      <div class="modal-header">
        <div class="modal-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal()">‚úï</button>
      </div>
      <div class="field-group">
        <label>‡πÄ‡∏•‡∏Ç OPD (4 ‡∏´‡∏•‡∏±‡∏Å) *‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label>
        <input id="f_opd" type="text" maxlength="4" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0123" style="font-family:monospace; letter-spacing:1px;">
      </div>
      <div class="field-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
        <input id="f_name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
      </div>
      <div class="field-group">
        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
        <input id="f_phone" type="tel" placeholder="0xx-xxx-xxxx">
      </div>
      <div class="field-group">
        <label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (01-12)</label>
        <input id="f_birth" type="number" min="1" max="12" placeholder="‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏õ‡∏µ">
      </div>
      <div class="field-group">
        <label>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</label>
        <textarea id="f_profile" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏≠‡∏ö‡∏ô‡∏ß‡∏î‡∏´‡∏ô‡πâ‡∏≤, ‡πÅ‡∏û‡πâ‡∏¢‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°..., ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì..., ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà..."></textarea>
      </div>
      <div class="field-group">
        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</label>
        <input id="f_note" type="text" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ">
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="saveCustomerBtn" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <div id="toastWrap" class="toast-wrap"></div>
  
  <button id="scrollTop">‚Üë</button>
<div id="floatingToggle" class="floating-toggle" onclick="toggleMenu()">
  <span style="font-size:24px;">‚ò∞</span>
</div>

<div id="floatingMenu" class="floating-menu">
  <a href="{{ url_for('dashboard') }}">
    <img src="{{ url_for('static', filename='icon/icon_dashboard.png') }}" alt="dash"> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
  </a>
  <a href="{{ url_for('crm') }}">
    <img src="{{ url_for('static', filename='icon/icon_crm.png') }}" alt="crm"> ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (CRM)
  </a>
  <a href="{{ url_for('sale_summary') }}">
    <img src="{{ url_for('static', filename='icon/icon_sale_summary.png') }}" alt="sale"> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢
  </a>
  <a href="{{ url_for('record_sales') }}">
    <img src="{{ url_for('static', filename='icon/icon_record_sales.png') }}" alt="record"> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢
  </a>
  <a href="{{ url_for('inventory') }}">
    <img src="{{ url_for('static', filename='icon/icon_inventory.png') }}" alt="stock"> ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  </a>
  <a href="{{ url_for('appointments') }}">
    <img src="{{ url_for('static', filename='icon/icon_appointments.png') }}" alt="appt"> ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢
  </a>
   <a href="{{ url_for('staff') }}">
    <img src="{{ url_for('static', filename='icon/icon_staff.png') }}" alt="staff"> ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
  </a>
</div>
  <script>
    function toggleMenu() {
    const m = document.getElementById('floatingMenu');
    m.classList.toggle('open');
  }
  // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π
  document.addEventListener('click', (e) => {
    const t = document.getElementById('floatingToggle');
    const m = document.getElementById('floatingMenu');
    if (!t.contains(e.target) && !m.contains(e.target)) m.classList.remove('open');
  });
    // --- Utilities ---
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));
    const pad4 = (s) => String(s||'').trim().padStart(4,'0');
    
    // Toast Notification
    const showToast = (msg, type='ok') => {
      const el = document.createElement('div');
      el.className = `toast ${type==='error'?'error':type==='warn'?'warn':''} show`;
      el.innerHTML = type==='error' ? `‚ùå ${msg}` : type==='warn' ? `‚ö†Ô∏è ${msg}` : `‚úÖ ${msg}`;
      $('#toastWrap').appendChild(el);
      setTimeout(() => { el.classList.remove('show'); setTimeout(()=>el.remove(), 300); }, 3000);
    };

    // State
    let rawData = [];
    let viewData = [];
    let selected = new Set();
    let sortConfig = { key: 'opd', asc: true };

    // Elements
    const tbody = $('#tbody');
    const searchInput = $('#searchInput');
    const monthFilter = $('#monthFilter');

    // --- Main Functions ---
    
    function loadData() {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:40px; color:#94a3b8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>`;
      fetch('/api/customers')
        .then(r => r.json())
        .then(data => {
          // Map Data to ensure clean structure
          rawData = data.map(r => ({
            opd: pad4(r.opd),
            name: r.name || '',
            phone: r.phone || '',
            birthMonth: String(r.birthMonth || '').padStart(2,'0'),
            profile: r.profile || '',
            note: r.note || ''
          }));
          
          // Remove invalid data (no OPD)
          rawData = rawData.filter(r => r.opd !== '0000' && r.opd !== '');
          
          render();
          $('#totalChip').textContent = `${rawData.length} ‡∏Ñ‡∏ô`;
          showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');
        })
        .catch(err => {
          console.error(err);
          tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:crimson; padding:20px;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
        });
    }

    function render() {
      // 1. Filter
      const q = searchInput.value.toLowerCase().trim();
      const m = monthFilter.value;
      
      viewData = rawData.filter(r => {
        const matchMonth = !m || (r.birthMonth === m);
        if (!q) return matchMonth;
        const text = `${r.opd} ${r.name} ${r.phone} ${r.profile} ${r.note}`.toLowerCase();
        return matchMonth && text.includes(q);
      });

      // 2. Sort
      const { key, asc } = sortConfig;
      viewData.sort((a, b) => {
        let valA = a[key] || '';
        let valB = b[key] || '';
        // Numeric sort for OPD
        if (key === 'opd') {
          valA = parseInt(valA) || 0;
          valB = parseInt(valB) || 0;
        }
        if (valA < valB) return asc ? -1 : 1;
        if (valA > valB) return asc ? 1 : -1;
        return 0;
      });

      // 3. Render HTML
      if (viewData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px; color:#cbd5e1;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
        return;
      }

      tbody.innerHTML = viewData.map(r => `
        <tr data-opd="${r.opd}">
          <td class="sel-col"><input type="checkbox" value="${r.opd}" ${selected.has(r.opd)?'checked':''} onchange="toggleSelect('${r.opd}')"></td>
          
          <td data-col="opd">${r.opd}</td>
          
          <td data-col="name">
            <div class="cell"><input data-key="name" value="${esc(r.name)}" readonly ondblclick="editRow(this)"></div>
          </td>

          <td class="phone-col">
            <div class="cell"><input data-key="phone" value="${esc(r.phone)}" readonly></div>
          </td>

          <td data-col="birthMonth">
            <div class="cell"><input data-key="birthMonth" value="${esc(r.birthMonth)}" readonly style="text-align:center"></div>
          </td>
          
          <td data-col="profile">
            <div class="cell"><textarea data-key="profile" readonly ondblclick="editRow(this)">${esc(r.profile)}</textarea></div>
          </td>
          
          <td data-col="note">
            <div class="cell"><input data-key="note" value="${esc(r.note)}" readonly></div>
          </td>
          
          <td>
            <div class="actions">
              <button class="btn-icon btn-ghost" onclick="editRow(this)" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
              <button class="btn-icon btn-ghost save-btn" onclick="saveRow(this)" style="display:none; color:var(--primary);" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å">üíæ</button>
              <button class="btn-icon btn-ghost cancel-btn" onclick="cancelRow(this)" style="display:none; color:var(--warn);" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">‚ùå</button>
              <button class="btn-icon btn-ghost" onclick="deleteRow('${r.opd}')" title="‡∏•‡∏ö" style="color:var(--danger);">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      `).join('');
      
      // Show/Hide clear button
      $('#clearSearch').style.display = q ? 'block' : 'none';
    }

    // --- Helpers ---
    const esc = (s) => (s||'').replace(/"/g, '&quot;');
    
    // --- Actions ---

    window.toggleSelect = (opd) => {
      if (selected.has(opd)) selected.delete(opd); else selected.add(opd);
    };
    
    $('#selectAll').onchange = (e) => {
      if (e.target.checked) viewData.forEach(r => selected.add(r.opd));
      else selected.clear();
      render();
    };

    window.editRow = (el) => {
      const tr = el.closest('tr');
      tr.classList.add('editing');
      // Enable inputs
      $$('input, textarea', tr).forEach(i => i.readOnly = false);
      // Toggle buttons
      tr.querySelector('.actions .btn-ghost').style.display = 'none'; // edit icon
      tr.querySelector('.save-btn').style.display = 'inline-block';
      tr.querySelector('.cancel-btn').style.display = 'inline-block';
      
      // Backup for cancel
      tr.dataset.backup = JSON.stringify({
        name: tr.querySelector('[data-key="name"]').value,
        phone: tr.querySelector('[data-key="phone"]').value,
        birthMonth: tr.querySelector('[data-key="birthMonth"]').value,
        profile: tr.querySelector('[data-key="profile"]').value,
        note: tr.querySelector('[data-key="note"]').value,
      });
    };

    window.cancelRow = (el) => {
      const tr = el.closest('tr');
      const backup = JSON.parse(tr.dataset.backup);
      tr.querySelector('[data-key="name"]').value = backup.name;
      tr.querySelector('[data-key="phone"]').value = backup.phone;
      tr.querySelector('[data-key="birthMonth"]').value = backup.birthMonth;
      tr.querySelector('[data-key="profile"]').value = backup.profile;
      tr.querySelector('[data-key="note"]').value = backup.note;
      
      tr.classList.remove('editing');
      $$('input, textarea', tr).forEach(i => i.readOnly = true);
      tr.querySelector('.actions .btn-ghost').style.display = 'inline-block';
      tr.querySelector('.save-btn').style.display = 'none';
      tr.querySelector('.cancel-btn').style.display = 'none';
    };

    window.saveRow = (el) => {
      const tr = el.closest('tr');
      const opd = tr.dataset.opd;
      
      const updates = {
        name: tr.querySelector('[data-key="name"]').value.trim(),
        phone: tr.querySelector('[data-key="phone"]').value.trim(),
        birthMonth: tr.querySelector('[data-key="birthMonth"]').value.trim(),
        profile: tr.querySelector('[data-key="profile"]').value.trim(),
        note: tr.querySelector('[data-key="note"]').value.trim(),
      };

      // Optimistic Update (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∑‡πà‡∏ô)
      const rec = rawData.find(r => r.opd === opd);
      if (rec) Object.assign(rec, updates);
      
      // Reset UI
      tr.classList.remove('editing');
      $$('input, textarea', tr).forEach(i => i.readOnly = true);
      tr.querySelector('.actions .btn-ghost').style.display = 'inline-block';
      tr.querySelector('.save-btn').style.display = 'none';
      tr.querySelector('.cancel-btn').style.display = 'none';

      // Send to API (Parallel requests)
      const promises = Object.entries(updates).map(([field, value]) => 
        fetch('/api/update_customer', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ opd, field, value })
        })
      );

      Promise.all(promises)
        .then(results => showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'))
        .catch(err => {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'warn');
          loadData(); // Revert if failed
        });
    };

    window.deleteRow = (opd) => {
      if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ OPD ${opd}?\n(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£)`)) return;
      fetch('/api/delete_customer', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ opd })
      })
      .then(r => r.json())
      .then(d => {
        if (d.message) {
          rawData = rawData.filter(r => r.opd !== opd);
          render();
          showToast('‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'warn');
        } else {
          showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        }
      });
    };

    // --- Sort Handler ---
    $$('th[data-key]').forEach(th => {
      th.addEventListener('click', () => {
        const k = th.dataset.key;
        if (sortConfig.key === k) sortConfig.asc = !sortConfig.asc;
        else sortConfig = { key: k, asc: true };
        
        // Update Arrows
        $$('th .sort').forEach(s => s.textContent = '‚Üï');
        const span = th.querySelector('.sort');
        if (span) span.textContent = sortConfig.asc ? '‚¨Ü' : '‚¨á';
        
        render();
      });
    });

    // --- Event Listeners ---
    searchInput.addEventListener('input', () => render());
    $('#clearSearch').onclick = () => { searchInput.value = ''; render(); };
    monthFilter.addEventListener('change', () => render());
    
    $('#refreshBtn').onclick = loadData;
    
    // Add Modal Logic
    const modal = $('#addModal');
    $('#openAddModalBtn').onclick = () => {
      $$('#addModal input, #addModal textarea').forEach(i => i.value = '');
      modal.classList.add('open');
      setTimeout(() => $('#f_opd').focus(), 100);
    };
    window.closeModal = () => modal.classList.remove('open');
    
    $('#saveCustomerBtn').onclick = () => {
      const payload = {
        opd: $('#f_opd').value.trim(),
        name: $('#f_name').value.trim(),
        phone: $('#f_phone').value.trim(),
        birthMonth: $('#f_birth').value.trim().padStart(2,'0'),
        profile: $('#f_profile').value.trim(),
        note: $('#f_note').value.trim(),
      };
      
      if (!payload.opd || payload.opd.length !== 4) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }

      fetch('/api/add_customer', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(d => {
        if (d.message) {
          closeModal();
          showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          loadData();
        } else {
          alert(d.error || 'Error');
        }
      });
    };

    // Scroll Top
    window.onscroll = () => {
      if (window.scrollY > 300) $('#scrollTop').classList.add('visible');
      else $('#scrollTop').classList.remove('visible');
    };
    $('#scrollTop').onclick = () => window.scrollTo({top:0, behavior:'smooth'});

    // Init
    loadData();

  </script>
</body>
</html>