<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Profile)</title>

  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a;
      --primary:#0f766e; --primary-600:#0d9488; --ring:#ccfbf1;
      --line:#e2e8f0; --danger:#ef4444; --warn:#f59e0b; --success:#22c55e;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Prompt', system-ui, -apple-system, Segoe UI, sans-serif;
      color:var(--text); background:var(--bg);
      font-size: 12px; margin:0;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    .container{ max-width:1200px; margin: 16px auto 120px; padding: 0 12px; }

    header.appbar{
      position:sticky; top:0; z-index:50;
      background: rgba(255,255,255,0.92); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .appbar-inner{
      max-width:1200px; margin:0 auto; padding: 12px 12px;
      display:flex; align-items:center; gap:10px;
    }
    .title{ font-weight:900; font-size: 18px; color: var(--primary); display:flex; align-items:center; gap:8px; }
    .grow{flex:1}

    .btn{
      appearance:none; border:none; border-radius:10px; padding:9px 14px; cursor:pointer; font-weight:800;
      display:inline-flex; align-items:center; gap:6px; transition: all .15s;
      font-family:inherit; font-size:12px;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background:var(--primary); color:white; box-shadow: 0 6px 18px rgba(15, 118, 110, 0.18); }
    .btn-primary:hover{ background:var(--primary-600); }
    .btn-ghost{ background:transparent; color:var(--text); border:1px solid transparent; }
    .btn-ghost:hover{ background:#f1f5f9; }
    .btn-danger{ background:#fee2e2; color:#b91c1c; }
    .btn-danger:hover{ background:#fecaca; }
    .btn-icon{ padding:8px; border-radius:10px; }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius: var(--radius);
      box-shadow: 0 10px 26px rgba(0,0,0,0.05);
      overflow:hidden;
    }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:10px; padding: 12px; align-items:center;
      border-bottom:1px solid var(--line); background: #f8fafc;
    }
    .search{ position:relative; flex:1; min-width: 240px; }
    .search input{
      width:100%; padding:10px 34px 10px 36px; border:1px solid var(--line); border-radius: 12px;
      outline:none; background:#fff; font-size:13px; transition: border-color .2s;
    }
    .search input:focus{ border-color: var(--primary); box-shadow: 0 0 0 3px var(--ring); }
    .search .icon{ position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.55; font-size:16px; }
    .search .clear{ position:absolute; right:12px; top:50%; transform:translateY(-50%); opacity:.55; cursor:pointer; font-size:14px; }

    .month-filter{
      border:1px solid var(--line); border-radius:12px; padding:9px 10px; background:#fff;
      font-size:12px; cursor:pointer;
    }
    .chip{ display:inline-flex; align-items:center; padding:5px 10px; border-radius:99px; font-size:11px; background:#e0f2f1; color:#0f766e; font-weight:900; }
    .chip.vip{ background:#fef3c7; color:#92400e; }
    .chip.mini{ padding:3px 8px; font-weight:900; }
    .muted{ color:#64748b; font-weight:800; font-size:11px; }

    .table-wrap{ overflow-x:auto; -webkit-overflow-scrolling: touch; }
    table{ width:100%; border-collapse:collapse; font-size: 12px; min-width: 980px; }
    thead th{
      position:sticky; top:0; z-index:1; background:#f1f5f9; color:#475569;
      font-weight:900; text-align:left; padding:10px 12px; border-bottom:1px solid var(--line);
      white-space: nowrap; cursor:pointer; user-select:none;
    }
    thead th:hover{ background:#e2e8f0; }
    tbody td{
      padding:9px 12px; border-bottom:1px solid var(--line); vertical-align:top; color: #334155;
    }
    tbody tr:hover td{ background:#f8fafc; }

    td .cell{ display:flex; align-items:center; width:100%; gap:8px; }
    td input, td textarea{
      width:100%; border:1px solid transparent; background:transparent;
      padding:4px; font-family:inherit; font-size:inherit; color:inherit; resize:none; border-radius:8px;
    }
    td input:focus, td textarea:focus{ outline:none; }
    tr.editing td input, tr.editing td textarea{
      background:#fff; border-color: #cbd5e1; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    th.sel-col, td.sel-col{ width: 42px; text-align:center; padding-left:6px; padding-right:6px;}
    th[data-key="opd"], td[data-col="opd"]{ width: 90px; font-weight:900; color: var(--primary); }
    td[data-col="opd"]{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    th[data-key="full_name"], td[data-col="full_name"]{ width: 240px; font-weight:900; }
    th[data-key="vip"], td[data-col="vip"]{ width: 95px; text-align:center; }
    th[data-key="birthMonth"], td[data-col="birthMonth"]{ width: 90px; text-align:center; }

    th:last-child, td:last-child{ width: 200px; text-align:center; }
    .actions{ display:flex; justify-content:center; gap:6px; opacity:0.85; transition:opacity .2s; }
    tr:hover .actions{ opacity:1; }

    .skeleton{ height:12px; background:#e2e8f0; border-radius:4px; animation: pulse 1.5s infinite; }
    @keyframes pulse{ 0%{opacity:.6} 50%{opacity:.3} 100%{opacity:.6} }

    .toast-wrap{ position:fixed; right:16px; bottom:16px; z-index:100; display:flex; flex-direction:column; gap:10px; }
    .toast{
      background:#fff; border-left:4px solid var(--success); padding:12px 14px; border-radius:12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1); font-weight:900; display:flex; align-items:center; gap:10px;
      transform:translateY(20px); opacity:0; transition:all .28s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      max-width: min(360px, calc(100vw - 32px));
    }
    .toast.show{ transform:translateY(0); opacity:1; }
    .toast.error{ border-left-color:var(--danger); }
    .toast.warn{ border-left-color:var(--warn); }

    .modal{
      position:fixed; inset:0; z-index:60;
      display:none; align-items:flex-end; justify-content:center;
    }
    .modal.open{ display:flex; }
    .modal-backdrop{
      position:absolute; inset:0; background:rgba(0,0,0,0.45);
      backdrop-filter: blur(3px);
    }
    .modal-box{
      position:relative; width:100%; max-width:760px;
      background:#fff; border-radius:18px 18px 0 0;
      box-shadow:0 30px 70px rgba(0,0,0,0.25);
      padding:16px 14px;
      max-height: 86vh; overflow:auto;
      animation: slideUp .18s ease;
    }
    @keyframes slideUp{ from{transform:translateY(10px); opacity:0} to{transform:translateY(0); opacity:1} }

    .modal-header{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; gap:12px; }
    .modal-title{ font-size:16px; font-weight:1000; color:var(--primary); display:flex; align-items:center; gap:8px; }
    .modal-sub{ font-size:11px; color:#64748b; font-weight:900; }

    .grid{ display:grid; gap:10px; grid-template-columns: repeat(12, 1fr); }
    .col-12{ grid-column: span 12; }
    .col-6{ grid-column: span 6; }
    .col-4{ grid-column: span 4; }
    .col-3{ grid-column: span 3; }

    .field-group label{ display:block; margin-bottom:4px; font-weight:1000; font-size:11px; color:#64748b; }
    .field-group input, .field-group textarea, .field-group select{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:12px;
      font-family:inherit; font-size:13px; outline:none;
    }
    .field-group input:focus, .field-group textarea:focus, .field-group select:focus{
      border-color: var(--primary); box-shadow: 0 0 0 3px var(--ring);
    }
    .field-group textarea{ resize:vertical; min-height:90px; }

    .modal-footer{ display:flex; justify-content:space-between; gap:8px; margin-top:14px; align-items:center; flex-wrap:wrap; }

    /* Scroll Top */
    #scrollTop{
      position:fixed; right:16px; bottom:16px; width:44px; height:44px; border-radius:50%;
      background:var(--primary); color:white; border:none; cursor:pointer;
      display:flex; align-items:center; justify-content:center; font-size:20px;
      box-shadow: 0 8px 18px rgba(15, 118, 110, 0.28);
      opacity:0; pointer-events:none; transition:all .25s;
      z-index: 900;
    }
    #scrollTop.visible{ opacity:1; bottom:92px; pointer-events:auto; }

    /* ‚úÖ Popup (View) */
    .view-card{
      border:1px solid var(--line);
      border-radius:16px;
      background: linear-gradient(180deg, #f8fafc, #ffffff 55%);
      padding:12px;
    }
    .view-top{
      display:flex; align-items:flex-start; gap:10px;
      padding:8px 10px;
      border-radius:14px;
      background:#ffffff;
      border:1px solid var(--line);
      box-shadow: 0 8px 16px rgba(0,0,0,0.04);
    }
    .badge-opd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-weight:1000;
      color:#0f766e;
      background:#ecfeff;
      border:1px solid #a5f3fc;
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }
    .view-name{
      font-weight:1000; font-size:15px; color:#0f172a; line-height:1.25;
    }
    .view-subline{
      margin-top:4px;
      display:flex; gap:8px; flex-wrap:wrap;
      font-weight:900; color:#475569; font-size:11px;
    }
    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px 10px;
      margin-top:12px;
    }
    .k{
      color:#64748b; font-weight:1000; font-size:11px;
      display:flex; align-items:center; gap:6px;
    }
    .v{
      color:#0f172a; font-weight:900; font-size:12px;
      word-break: break-word;
    }
    .v.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .divider{
      height:1px; background:var(--line); margin:12px 0;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      font-weight:1000; font-size:11px;
      background:#f1f5f9; color:#334155;
      border:1px solid #e2e8f0;
    }

    /* ‚úÖ Mobile: ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ */
    @media (max-width: 768px){
      .container{ margin-top:10px; padding:0 10px; }
      .toolbar{ gap:8px; padding:10px; }
      .search{ min-width:100%; order:2; }
      .btn{ padding:8px 10px; font-size:11px; }

      /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á: ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á + ‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡∏∞‡πÅ‡∏ñ‡∏ß‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢ */
      table{ min-width: 680px; }
      th[data-key="phone"], td[data-col="phone"]{ display:none; }               /* ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå */
      th[data-key="birth_th_ddmmyyyy"], td[data-col="birth_th_ddmmyyyy"]{ display:none; } /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏ï‡πá‡∏° */
      th[data-key="profile"], td[data-col="profile"]{ display:none; }          /* ‡∏ã‡πà‡∏≠‡∏ô profile */
      th[data-key="note"], td[data-col="note"]{ display:none; }                /* ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ */
      th[data-key="facebook_name"], td[data-col="facebook_name"]{ display:none; } /* ‡∏ã‡πà‡∏≠‡∏ô FB (‡πÄ‡∏î‡∏¥‡∏°) */

      /* Modal ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô full width */
      .modal-box{ border-radius:18px 18px 0 0; padding:14px 12px; }
      .col-6,.col-4,.col-3{ grid-column: span 12; }
      .kv{ grid-template-columns: 96px 1fr; }
    }
  </style>
</head>

<body>
  <header class="appbar">
    <div class="appbar-inner">
      <div class="title">üìñ ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
      <div class="grow"></div>
      <button id="refreshBtn" class="btn btn-ghost">‚ü≥ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      <button id="openAddModalBtn" class="btn btn-primary">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <div class="toolbar">
        <div class="search">
          <span class="icon">üîé</span>
          <input id="searchInput" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: OPD, ‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏ö‡∏≠‡∏£‡πå, ‡∏ö‡∏±‡∏ï‡∏£, FB, ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà, ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå, ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏...">
          <span id="clearSearch" class="clear" style="display:none;">‚úñ</span>
        </div>

        <select id="monthFilter" class="month-filter">
          <option value="">üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="01">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option><option value="02">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option><option value="03">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
          <option value="04">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option><option value="05">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option><option value="06">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
          <option value="07">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option><option value="08">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option><option value="09">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
          <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option><option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option><option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
        </select>

        <div class="grow"></div>
        <div class="chip" id="totalChip">0 ‡∏Ñ‡∏ô</div>
        <button id="bulkDeleteBtn" class="btn btn-ghost btn-icon" style="color:var(--danger);" title="‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">üóëÔ∏è</button>
        <button id="exportBtn" class="btn btn-ghost btn-icon" title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV">üì•</button>
      </div>

      <div class="table-wrap">
        <table id="customerTable">
          <thead>
            <tr>
              <th class="sel-col"><input type="checkbox" id="selectAll"></th>
              <th data-key="opd">OPD ‚Üï</th>
              <th data-key="full_name">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‚Üï</th>
              <th data-key="phone">‡πÇ‡∏ó‡∏£ ‚Üï</th>
              <th data-key="vip">VIP ‚Üï</th>
              <th data-key="birthMonth">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Üï</th>
              <th data-key="birth_th_ddmmyyyy">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î(‡πÑ‡∏ó‡∏¢) ‚Üï</th>
              <th data-key="facebook_name">Facebook ‚Üï</th>
              <th data-key="profile">üìù ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‚Üï</th>
              <th data-key="note">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ‚Üï</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="11"><div style="padding:20px">
              <div class="skeleton" style="margin-bottom:10px"></div>
              <div class="skeleton" style="width:80%"></div>
            </div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Add/Edit Modal -->
  <div id="addModal" class="modal">
    <div class="modal-backdrop" onclick="closeModal('addModal')"></div>
    <div class="modal-box">
      <div class="modal-header">
        <div style="flex:1;">
          <div class="modal-title" id="formModalTitle">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</div>
          <div class="modal-sub" id="formModalSub">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô (‡∏ï‡∏≤‡∏£‡∏≤‡∏á customers ‡∏ú‡πà‡∏≤‡∏ô Flask API)</div>

          <div style="margin-top:12px; padding:10px; background:#f0f9ff; border-radius:14px; border:1px dashed #0ea5e9; display:flex; align-items:center; gap:10px;">
            <span style="font-size:20px;">ü™™</span>
            <div style="flex:1;">
              <div style="font-weight:1000; color:#0369a1;">‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (AI)</div>

              <div style="font-size:10px; color:#64748b; font-weight:900;">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
            </div>

            <input type="file" id="idCardInput" accept="image/*" style="display:none" onchange="processIDCard(this)">
            <button id="scanBtn" class="btn btn-primary" type="button" onclick="$('#idCardInput').click()">üì∏ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</button>
          </div>
        </div>

        <button class="btn btn-ghost btn-icon" onclick="closeModal('addModal')">‚úï</button>
      </div>

      <input type="hidden" id="formMode" value="add">

      <div class="grid">
        <div class="field-group col-3">
          <label>OPD (4 ‡∏´‡∏•‡∏±‡∏Å) *</label>
          <input id="f_opd" type="text" maxlength="4" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0123" style="font-family:monospace; letter-spacing:1px;">
        </div>
        <div class="field-group col-3">
          <label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (01-12)</label>
          <input id="f_birthMonth" type="text" maxlength="2" placeholder="01-12">
        </div>
        <div class="field-group col-6">
          <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏ó‡∏¢ (dd/mm/yyyy)</label>
          <input id="f_birth_th" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 05/09/2530">
        </div>

        <div class="field-group col-6">
          <label>‡∏ä‡∏∑‡πà‡∏≠ (‡∏™‡∏±‡πâ‡∏ô)</label>
          <input id="f_name" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏≠‡∏ô">
        </div>
        <div class="field-group col-6">
          <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡πÄ‡∏ï‡πá‡∏°)</label>
          <input id="f_full_name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        </div>

        <div class="field-group col-6">
          <label>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
          <input id="f_phone" type="tel" placeholder="0xx-xxx-xxxx">
        </div>
        <div class="field-group col-6">
          <label>Facebook</label>
          <input id="f_facebook_name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô FB">
        </div>

        <div class="field-group col-6">
          <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
          <input id="f_national_id" type="text" placeholder="x-xxxx-xxxxx-xx-x">
        </div>
        <div class="field-group col-6">
          <label>VIP</label>
          <select id="f_vip">
            <option value="">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
            <option value="VIP">VIP</option>
            <option value="VVIP">VVIP</option>
            <option value="Gold">Gold</option>
            <option value="Silver">Silver</option>
          </select>
        </div>

        <div class="field-group col-12">
          <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
          <input id="f_address" type="text" placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏ñ‡∏ô‡∏ô/‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
        </div>

        <div class="field-group col-12">
          <label>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏£‡∏π‡πâ)</label>
          <textarea id="f_profile" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏≠‡∏ö‡∏ô‡∏ß‡∏î‡∏´‡∏ô‡πâ‡∏≤, ‡πÅ‡∏û‡πâ‡∏¢‡∏≤..., ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ö..., ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà..."></textarea>
        </div>

        <div class="field-group col-12">
          <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <input id="f_note" type="text" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ">
        </div>
      </div>

      <div class="modal-footer">
        <div class="muted" id="formHint">‚ú® ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
        <div style="display:flex; gap:8px; width:100%; justify-content:flex-end;">
          <button class="btn btn-ghost" onclick="closeModal('addModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button id="saveCustomerBtn" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Popup ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
  <div id="viewModal" class="modal">
    <div class="modal-backdrop" onclick="closeModal('viewModal')"></div>
    <div class="modal-box">
      <div class="modal-header">
        <div>
          <div class="modal-title">üëÅÔ∏è ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
          <div class="modal-sub">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÅ‡∏ï‡∏∞ ‚úèÔ∏è ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</div>
        </div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal('viewModal')">‚úï</button>
      </div>

      <div class="view-card">
        <div class="view-top">
          <div class="badge-opd" id="v_opd">OPD 0000</div>
          <div style="flex:1; min-width:0;">
            <div class="view-name" id="v_full_name">-</div>
            <div class="view-subline">
              <span class="pill" id="v_vip">VIP: -</span>
              <span class="pill" id="v_birth_month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: -</span>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="kv">
          <div class="k">ü™™ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</div>
          <div class="v mono" id="v_national_id">-</div>

          <div class="k">üéÇ ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (‡πÑ‡∏ó‡∏¢)</div>
          <div class="v" id="v_birth_th">-</div>

          <div class="k">üìû ‡πÇ‡∏ó‡∏£</div>
          <div class="v mono" id="v_phone">-</div>

          <div class="k">üìò Facebook</div>
          <div class="v" id="v_fb">-</div>

          <div class="k">üè† ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</div>
          <div class="v" id="v_address">-</div>
        </div>

        <div class="divider"></div>

        <div class="k" style="margin-bottom:6px;">üìù ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</div>
        <div class="v" id="v_profile" style="white-space:pre-wrap;">-</div>

        <div class="divider"></div>

        <div class="k" style="margin-bottom:6px;">üóíÔ∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
        <div class="v" id="v_note" style="white-space:pre-wrap;">-</div>
      </div>

      <div class="modal-footer">
        <div class="muted" id="v_hint">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>
        <div style="display:flex; gap:8px; width:100%; justify-content:flex-end;">
          <button class="btn btn-danger" id="v_deleteBtn">üóëÔ∏è ‡∏•‡∏ö</button>
          <button class="btn btn-ghost" onclick="closeModal('viewModal')">‡∏õ‡∏¥‡∏î</button>
          <button class="btn btn-primary" id="v_editBtn">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail Modal ‡πÄ‡∏î‡∏¥‡∏° (‡∏¢‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ) -->
  <div id="detailModal" class="modal">
    <div class="modal-backdrop" onclick="closeModal('detailModal')"></div>
    <div class="modal-box">
      <div class="modal-header">
        <div>
          <div class="modal-title">üë§ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ <span class="chip mini" id="d_opd_chip">OPD 0000</span></div>
          <div class="modal-sub">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
        </div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal('detailModal')">‚úï</button>
      </div>

      <div class="grid">
        <div class="field-group col-3">
          <label>OPD</label>
          <input id="d_opd" type="text" readonly style="font-family:monospace; letter-spacing:1px; background:#f8fafc;">
        </div>
        <div class="field-group col-3">
          <label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
          <input id="d_birthMonth" type="text" maxlength="2" placeholder="01-12">
        </div>
        <div class="field-group col-6">
          <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏ó‡∏¢</label>
          <input id="d_birth_th" type="text" placeholder="dd/mm/yyyy">
        </div>

        <div class="field-group col-6">
          <label>‡∏ä‡∏∑‡πà‡∏≠ (‡∏™‡∏±‡πâ‡∏ô)</label>
          <input id="d_name" type="text">
        </div>
        <div class="field-group col-6">
          <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡πÄ‡∏ï‡πá‡∏°)</label>
          <input id="d_full_name" type="text">
        </div>

        <div class="field-group col-6">
          <label>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
          <input id="d_phone" type="text">
        </div>
        <div class="field-group col-6">
          <label>Facebook</label>
          <input id="d_facebook_name" type="text">
        </div>

        <div class="field-group col-6">
          <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
          <input id="d_national_id" type="text">
        </div>
        <div class="field-group col-6">
          <label>VIP</label>
          <select id="d_vip">
            <option value="">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
            <option value="VIP">VIP</option>
            <option value="VVIP">VVIP</option>
            <option value="Gold">Gold</option>
            <option value="Silver">Silver</option>
          </select>
        </div>

        <div class="field-group col-12">
          <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
          <input id="d_address" type="text">
        </div>

        <div class="field-group col-12">
          <label>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
          <textarea id="d_profile"></textarea>
        </div>

        <div class="field-group col-12">
          <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <input id="d_note" type="text">
        </div>
      </div>

      <div class="modal-footer">
        <div class="muted" id="d_hint">üßæ ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
        <div style="display:flex; gap:8px; width:100%; justify-content:flex-end;">
          <button class="btn btn-danger" id="detailDeleteBtn">üóëÔ∏è ‡∏•‡∏ö</button>
          <button class="btn btn-ghost" onclick="closeModal('detailModal')">‡∏õ‡∏¥‡∏î</button>
          <button class="btn btn-primary" id="detailSaveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toastWrap" class="toast-wrap"></div>

  <!-- ‚úÖ floating menu -->
  {% include 'floating_menu.html' %}

  <button id="scrollTop">‚Üë</button>

  <script>
    // =========================
    // Utilities
    // =========================
    const $ = (s) => document.querySelector(s);
    const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));
    const pad4 = (s) => String(s ?? '').trim().padStart(4,'0');
    const pad2 = (s) => String(s ?? '').trim().padStart(2,'0');
    const esc = (s) => (s ?? '').toString()
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

    const showToast = (msg, type='ok') => {
      const el = document.createElement('div');
      el.className = `toast ${type==='error'?'error':type==='warn'?'warn':''} show`;
      el.innerHTML = type==='error' ? `‚ùå ${msg}` : type==='warn' ? `‚ö†Ô∏è ${msg}` : `‚úÖ ${msg}`;
      $('#toastWrap').appendChild(el);
      setTimeout(() => { el.classList.remove('show'); setTimeout(()=>el.remove(), 280); }, 3000);
    };

    function openModal(id){ $('#'+id).classList.add('open'); }
    function closeModal(id){ $('#'+id).classList.remove('open'); }

    // =========================
    // State
    // =========================
    let rawData = [];
    let viewData = [];
    let selected = new Set();
    let sortConfig = { key: 'opd', asc: true };

    // Elements
    const tbody = $('#tbody');
    const searchInput = $('#searchInput');
    const monthFilter = $('#monthFilter');

    // =========================
    // API helpers
    // =========================
    async function apiGetCustomers(){
      const r = await fetch('/api/customers', { credentials: 'same-origin' });
      if (!r.ok) throw new Error('fetch_customers_failed');
      const data = await r.json();
      if (!Array.isArray(data)) return [];
      return data;
    }

    async function apiAddCustomerFull(payload){
      const r = await fetch('/api/add_customer_full', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify(payload)
      });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(j.error || 'add_failed');
      return j;
    }

    async function apiUpdateCustomerPatch(opd, patch){
      const r = await fetch('/api/update_customer_patch', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify({ opd, patch })
      });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(j.error || 'update_failed');
      return j;
    }

    async function apiDeleteCustomerAndSales(opd){
      const r = await fetch('/api/delete_customer_and_sales', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify({ opd })
      });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(j.error || 'delete_failed');
      return j;
    }

    // ‚úÖ Google Vision OCR ‡∏ú‡πà‡∏≤‡∏ô Flask
    async function apiOCRIdCard(file){
      const fd = new FormData();
      fd.append('image', file);

      const r = await fetch('/api/ocr_idcard', {
        method: 'POST',
        credentials: 'same-origin',
        body: fd
      });

      const j = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(j.error || 'ocr_failed');
      return j; // { text: "..." }
    }

    // =========================
    // ‚úÖ Add/Edit Form helpers
    // =========================
    function clearForm(){
      $$('#addModal input, #addModal textarea, #addModal select').forEach(i => {
        if (i.id === 'formMode') return;
        i.value = '';
      });
    }

    function setFormMode(mode){
      $('#formMode').value = mode;

      if (mode === 'add'){
        $('#formModalTitle').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
        $('#formModalSub').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô (‡∏ï‡∏≤‡∏£‡∏≤‡∏á customers ‡∏ú‡πà‡∏≤‡∏ô Flask API)';
        $('#formHint').textContent = '‚ú® ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        $('#f_opd').readOnly = false;
        $('#f_opd').style.background = '#fff';
      } else {
        $('#formModalTitle').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
        $('#formModalSub').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        $('#formHint').textContent = 'üßæ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        $('#f_opd').readOnly = true;
        $('#f_opd').style.background = '#f8fafc';
      }
    }

    function openAddForm(){
      clearForm();
      setFormMode('add');
      openModal('addModal');
      setTimeout(() => $('#f_opd').focus(), 50);
    }

    function openEditForm(opd){
      const r = rawData.find(x => x.opd === opd);
      if (!r) return;

      clearForm();
      setFormMode('edit');

      $('#f_opd').value = r.opd || '';
      $('#f_birthMonth').value = r.birthMonth || '';
      $('#f_birth_th').value = r.birth_th_ddmmyyyy || '';

      $('#f_name').value = r.name || '';
      $('#f_full_name').value = r.full_name || '';

      $('#f_phone').value = r.phone || '';
      $('#f_facebook_name').value = r.facebook_name || '';

      $('#f_national_id').value = r.national_id || '';
      $('#f_vip').value = r.vip || '';

      $('#f_address').value = r.address || '';
      $('#f_profile').value = r.profile || '';
      $('#f_note').value = r.note || '';

      openModal('addModal');
      setTimeout(() => $('#f_full_name').focus(), 50);
    }

    // =========================
    // ‚úÖ Popup View helpers
    // =========================
    function safeDash(v){ return (v===null || v===undefined || String(v).trim()==='') ? '-' : String(v); }

    function openViewPopup(opd){
      const r = rawData.find(x => x.opd === opd);
      if (!r) return;

      $('#v_opd').textContent = `OPD ${r.opd}`;
      $('#v_full_name').textContent = safeDash(r.full_name || r.name);
      $('#v_vip').textContent = `VIP: ${safeDash(r.vip)}`;
      $('#v_birth_month').textContent = `‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: ${safeDash(r.birthMonth)}`;

      $('#v_national_id').textContent = safeDash(r.national_id);
      $('#v_birth_th').textContent = safeDash(r.birth_th_ddmmyyyy);
      $('#v_phone').textContent = safeDash(r.phone);
      $('#v_fb').textContent = safeDash(r.facebook_name);
      $('#v_address').textContent = safeDash(r.address);
      $('#v_profile').textContent = safeDash(r.profile);
      $('#v_note').textContent = safeDash(r.note);

      $('#v_editBtn').onclick = () => { closeModal('viewModal'); openEditForm(opd); };
      $('#v_deleteBtn').onclick = () => deleteRow(opd, true);

      openModal('viewModal');
    }

    // =========================
    // Load + Render
    // =========================
    async function loadData() {
      tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding:40px; color:#94a3b8; font-weight:900;">
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
      </td></tr>`;

      try{
        const data = await apiGetCustomers();

        rawData = data.map(r => ({
          id: r.id ?? null,
          opd: pad4(r.opd ?? ''),
          name: r.name ?? '',
          full_name: r.full_name ?? '',
          phone: r.phone ?? '',
          national_id: r.national_id ?? '',
          address: r.address ?? '',
          facebook_name: r.facebook_name ?? '',
          birthMonth: pad2(r.birthMonth ?? ''),
          birth_th_ddmmyyyy: r.birth_th_ddmmyyyy ?? '',
          vip: r.vip ?? '',
          profile: r.profile ?? '',
          note: r.note ?? ''
        })).filter(r => r.opd && r.opd !== '0000');

        $('#totalChip').textContent = `${rawData.length} ‡∏Ñ‡∏ô`;
        render();
        showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');

      }catch(err){
        console.error("load error:", err);
        tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; color:crimson; padding:20px; font-weight:900;">
          ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        </td></tr>`;
        showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      }
    }

    function render() {
      const q = searchInput.value.toLowerCase().trim();
      const m = monthFilter.value;

      viewData = rawData.filter(r => {
        const matchMonth = !m || (r.birthMonth === m);
        if (!q) return matchMonth;

        const text = `${r.opd} ${r.name} ${r.full_name} ${r.phone} ${r.national_id} ${r.address} ${r.facebook_name} ${r.birthMonth} ${r.birth_th_ddmmyyyy} ${r.vip} ${r.profile} ${r.note}`.toLowerCase();
        return matchMonth && text.includes(q);
      });

      const { key, asc } = sortConfig;
      viewData.sort((a, b) => {
        let valA = a[key] ?? '';
        let valB = b[key] ?? '';
        if (key === 'opd') {
          valA = parseInt(valA) || 0;
          valB = parseInt(valB) || 0;
        }
        if (valA < valB) return asc ? -1 : 1;
        if (valA > valB) return asc ? 1 : -1;
        return 0;
      });

      if (viewData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding:30px; color:#cbd5e1; font-weight:900;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
        $('#clearSearch').style.display = q ? 'block' : 'none';
        return;
      }

      tbody.innerHTML = viewData.map(r => {
        const vipChip = r.vip ? `<span class="chip mini vip">${esc(r.vip)}</span>` : `<span class="muted">-</span>`;
        const displayName = r.full_name || r.name || '-';

        return `
        <tr data-opd="${esc(r.opd)}" class="row-tap">
          <td class="sel-col">
            <input type="checkbox" value="${esc(r.opd)}" ${selected.has(r.opd)?'checked':''}
              onchange="toggleSelect('${esc(r.opd)}'); event.stopPropagation();">
          </td>

          <td data-col="opd">${esc(r.opd)}</td>

          <td data-col="full_name">
            <div class="cell">
              <input data-key="full_name" value="${esc(displayName)}" readonly ondblclick="editRow(this); event.stopPropagation();">
            </div>
          </td>

          <td data-col="phone">
            <div class="cell"><input data-key="phone" value="${esc(r.phone)}" readonly ondblclick="editRow(this); event.stopPropagation();"></div>
          </td>

          <td data-col="vip" style="text-align:center">
            <div class="cell" style="justify-content:center;">
              <input data-key="vip" value="${esc(r.vip)}" readonly style="text-align:center; max-width:86px;" ondblclick="editRow(this); event.stopPropagation();">
              <span>${vipChip}</span>
            </div>
          </td>

          <td data-col="birthMonth">
            <div class="cell"><input data-key="birthMonth" value="${esc(r.birthMonth)}" readonly style="text-align:center" ondblclick="editRow(this); event.stopPropagation();"></div>
          </td>

          <td data-col="birth_th_ddmmyyyy">
            <div class="cell"><input data-key="birth_th_ddmmyyyy" value="${esc(r.birth_th_ddmmyyyy)}" readonly ondblclick="editRow(this); event.stopPropagation();"></div>
          </td>

          <td data-col="facebook_name">
            <div class="cell"><input data-key="facebook_name" value="${esc(r.facebook_name)}" readonly ondblclick="editRow(this); event.stopPropagation();"></div>
          </td>

          <td data-col="profile">
            <div class="cell"><textarea data-key="profile" readonly ondblclick="editRow(this); event.stopPropagation();">${esc(r.profile)}</textarea></div>
          </td>

          <td data-col="note">
            <div class="cell"><input data-key="note" value="${esc(r.note)}" readonly ondblclick="editRow(this); event.stopPropagation();"></div>
          </td>

          <td>
            <div class="actions">
              <button class="btn-icon btn-ghost" onclick="openViewPopup('${esc(r.opd)}'); event.stopPropagation();" title="‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">üëÅÔ∏è</button>
              <button class="btn-icon btn-ghost" onclick="openEditForm('${esc(r.opd)}'); event.stopPropagation();" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏ü‡∏≠‡∏£‡πå‡∏°)">‚úèÔ∏è</button>
              <button class="btn-icon btn-ghost save-btn" onclick="saveRow(this); event.stopPropagation();" style="display:none; color:var(--primary);" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å">üíæ</button>
              <button class="btn-icon btn-ghost cancel-btn" onclick="cancelRow(this); event.stopPropagation();" style="display:none; color:var(--warn);" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">‚ùå</button>
              <button class="btn-icon btn-ghost" onclick="deleteRow('${esc(r.opd)}'); event.stopPropagation();" title="‡∏•‡∏ö" style="color:var(--danger);">üóëÔ∏è</button>
            </div>
          </td>
        </tr>`;
      }).join('');

      // ‚úÖ ‡πÅ‡∏ï‡∏∞‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î popup (‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏°‡∏≤‡∏Å‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
      $$('#tbody tr.row-tap').forEach(tr => {
        tr.onclick = (e) => {
          // ‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°/checkbox ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡πâ‡∏≠‡∏ô
          const t = e.target;
          if (t.closest('button') || t.matches('input[type="checkbox"]') || t.closest('.actions')) return;
          const opd = tr.dataset.opd;
          if (opd) openViewPopup(opd);
        };
      });

      $('#clearSearch').style.display = q ? 'block' : 'none';
    }

    // =========================
    // Selection / Sorting
    // =========================
    window.toggleSelect = (opd) => {
      if (selected.has(opd)) selected.delete(opd);
      else selected.add(opd);
    };

    $('#selectAll').onchange = (e) => {
      if (e.target.checked) viewData.forEach(r => selected.add(r.opd));
      else selected.clear();
      render();
    };

    $$('th[data-key]').forEach(th => {
      th.addEventListener('click', () => {
        const k = th.dataset.key;
        if (sortConfig.key === k) sortConfig.asc = !sortConfig.asc;
        else sortConfig = { key: k, asc: true };
        render();
      });
    });

    // =========================
    // Inline Edit
    // =========================
    window.editRow = (el) => {
      const tr = el.closest('tr');
      tr.classList.add('editing');
      $$('input, textarea', tr).forEach(i => i.readOnly = false);

      const actions = tr.querySelector('.actions');
      actions.querySelectorAll('button').forEach(btn => btn.style.display = 'none');
      actions.querySelector('.save-btn').style.display = 'inline-flex';
      actions.querySelector('.cancel-btn').style.display = 'inline-flex';

      const backup = {};
      $$('[data-key]', tr).forEach(inp => backup[inp.dataset.key] = inp.value);
      tr.dataset.backup = JSON.stringify(backup);
    };

    window.cancelRow = (el) => {
      const tr = el.closest('tr');
      const backup = JSON.parse(tr.dataset.backup || '{}');
      $$('[data-key]', tr).forEach(inp => {
        const k = inp.dataset.key;
        if (backup[k] !== undefined) inp.value = backup[k];
      });

      tr.classList.remove('editing');
      $$('input, textarea', tr).forEach(i => i.readOnly = true);

      const actions = tr.querySelector('.actions');
      actions.querySelectorAll('button').forEach(btn => btn.style.display = 'inline-flex');
      actions.querySelector('.save-btn').style.display = 'none';
      actions.querySelector('.cancel-btn').style.display = 'none';
      render();
    };

    window.saveRow = async (el) => {
      const tr = el.closest('tr');
      const opd = tr.dataset.opd;

      const patch = {};
      $$('[data-key]', tr).forEach(inp => {
        patch[inp.dataset.key] = (inp.value ?? '').trim();
      });

      if (patch.birthMonth !== undefined) patch.birthMonth = pad2(patch.birthMonth);

      tr.classList.remove('editing');
      $$('input, textarea', tr).forEach(i => i.readOnly = true);

      const actions = tr.querySelector('.actions');
      actions.querySelectorAll('button').forEach(btn => btn.style.display = 'inline-flex');
      actions.querySelector('.save-btn').style.display = 'none';
      actions.querySelector('.cancel-btn').style.display = 'none';

      Object.keys(patch).forEach(k => { if (patch[k] === '') patch[k] = null; });

      try{
        await apiUpdateCustomerPatch(opd, patch);
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        await loadData();
      }catch(err){
        console.error(err);
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        await loadData();
      }
    };

    // =========================
    // Delete
    // =========================
    window.deleteRow = async (opd, fromDetail=false) => {
      const msg = fromDetail
        ? `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö OPD ${opd} ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•? (‡∏ñ‡∏≤‡∏ß‡∏£)`
        : `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ OPD ${opd}? (‡∏ñ‡∏≤‡∏ß‡∏£)`;
      if (!confirm(msg)) return;

      try{
        await apiDeleteCustomerAndSales(opd);
        selected.delete(opd);
        showToast('‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'warn');
        closeModal('detailModal');
        closeModal('viewModal');
        await loadData();
      }catch(err){
        console.error(err);
        showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      }
    };

    $('#bulkDeleteBtn').onclick = async () => {
      if (selected.size === 0) return showToast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'warn');
      if (!confirm(`‡∏•‡∏ö ${selected.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å? (‡∏ñ‡∏≤‡∏ß‡∏£)`)) return;

      try{
        const list = Array.from(selected);
        for (const opd of list){
          await apiDeleteCustomerAndSales(opd);
        }
        selected.clear();
        showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', 'warn');
        await loadData();
      }catch(err){
        console.error(err);
        showToast('‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        await loadData();
      }
    };

    // =========================
    // Add/Edit Save
    // =========================
    $('#openAddModalBtn').onclick = openAddForm;

    $('#saveCustomerBtn').onclick = async () => {
      const opd = pad4($('#f_opd').value.trim());
      if (!opd || opd.length !== 4) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

      const mode = $('#formMode').value;

      const rawPayload = {
        opd: opd,
        birthMonth: pad2($('#f_birthMonth').value.trim()),
        birth_th_ddmmyyyy: $('#f_birth_th').value.trim(),
        name: $('#f_name').value.trim(),
        full_name: $('#f_full_name').value.trim(),
        phone: $('#f_phone').value.trim(),
        facebook_name: $('#f_facebook_name').value.trim(),
        national_id: $('#f_national_id').value.trim(),
        vip: $('#f_vip').value,
        address: $('#f_address').value.trim(),
        profile: $('#f_profile').value.trim(),
        note: $('#f_note').value.trim()
      };

      Object.keys(rawPayload).forEach(k => { if (rawPayload[k] === '') rawPayload[k] = null; });

      if (rawPayload.birthMonth && !/^(0[1-9]|1[0-2])$/.test(rawPayload.birthMonth)) {
        return alert('‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 01-12');
      }

      if (rawPayload.birth_th_ddmmyyyy && !/^\d{2}\/\d{2}\/\d{4}$/.test(rawPayload.birth_th_ddmmyyyy)) {
        return alert('‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏ó‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yyyy (‡πÄ‡∏ä‡πà‡∏ô 05/09/2530)');
      }

      try {
        if (mode === 'add') {
          await apiAddCustomerFull(rawPayload);
          showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        } else {
          const patch = { ...rawPayload };
          delete patch.opd;
          await apiUpdateCustomerPatch(opd, patch);
          showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        closeModal('addModal');
        await loadData();

      } catch (err) {
        console.error(err);
        alert(mode === 'add'
          ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö OPD ‡∏ã‡πâ‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠ Server Error)'
          : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Server Error)');
      }
    };

    // =========================
    // Search / Filter / Refresh
    // =========================
    searchInput.addEventListener('input', () => render());
    $('#clearSearch').onclick = () => { searchInput.value = ''; render(); };
    monthFilter.addEventListener('change', () => render());
    $('#refreshBtn').onclick = loadData;

    // Export CSV
    $('#exportBtn').onclick = () => {
      const rows = (viewData.length ? viewData : rawData);
      const headers = ['opd','name','full_name','phone','national_id','address','facebook_name','birthMonth','birth_th_ddmmyyyy','vip','profile','note'];

      const csv = [
        headers.join(','),
        ...rows.map(r => headers.map(h => `"${String(r[h] ?? '').replace(/"/g,'""')}"`).join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `customers_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV ‡πÅ‡∏•‡πâ‡∏ß');
    };

    // Scroll Top
    window.onscroll = () => {
      if (window.scrollY > 300) $('#scrollTop').classList.add('visible');
      else $('#scrollTop').classList.remove('visible');
    };
    $('#scrollTop').onclick = () => window.scrollTo({top:0, behavior:'smooth'});

    // Init
    loadData();

    // =========================
    // ü™™ OCR Function (Google Vision via Flask)
    // =========================
    function formatThaiId13(id13){
      const s = String(id13 || '').replace(/\D/g,'');
      if (s.length !== 13) return '';
      return `${s[0]}-${s.slice(1,5)}-${s.slice(5,10)}-${s.slice(10,12)}-${s[12]}`;
    }

    function normalizeOCRText(text){
      return (text || '')
        .replace(/\r/g,'\n')
        .replace(/[ \t]+/g,' ')
        .replace(/\n{2,}/g,'\n')
        .trim();
    }

      async function processIDCard(input) {
  const file = input.files[0];
  if (!file) return;

  showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏î‡πâ‡∏ß‡∏¢ AI...', 'warn');

  // ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ñ‡∏±‡∏î‡∏à‡∏≤‡∏Å input (‡∏ï‡∏≤‡∏° HTML ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
  const btn = input.nextElementSibling;
  const oldText = btn ? btn.innerText : '';
  if (btn) { btn.innerText = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô...'; btn.disabled = true; }

  try {
    const fd = new FormData();
    fd.append('image', file);

    // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô endpoint ‡∏°‡∏≤‡∏ó‡∏µ‡πà OpenAI route
    const res = await fetch('/api/idcard_extract', {
      method: 'POST',
      credentials: 'same-origin',
      body: fd
    });

    const out = await res.json().catch(() => ({}));
    if (!res.ok) {
      console.error(out);
      throw new Error(out.error || 'idcard_extract_failed');
    }

    // out ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô:
    // { id_number, title_th, first_name_th, last_name_th, birth_date, address, issue_date, expiry_date }

    // ‚úÖ 1) ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡πÉ‡∏ä‡πâ full_name ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏≠‡∏Å)
    const title = (out.title_th || '').trim();
    const first = (out.first_name_th || '').trim();
    const last  = (out.last_name_th || '').trim();

    const fullName = [title, first, last].filter(Boolean).join(' ').trim();
    if (fullName) $('#f_full_name').value = fullName;

    // ‚úÖ 2) ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (‡πÑ‡∏ó‡∏¢ dd/mm/yyyy - ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á)
    const birth = (out.birth_date || '').trim();
    if (birth) {
      $('#f_birth_th').value = birth;

      // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å dd/mm/yyyy
      const parts = birth.split('/');
      const mm = (parts[1] || '').trim();
      if (/^\d{2}$/.test(mm)) $('#f_birthMonth').value = mm;
    }

    // ‚úÖ 3) ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£
    const idNo = (out.id_number || '').trim();
    if (idNo) $('#f_national_id').value = idNo;

    // ‚úÖ 4) ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
    const addr = (out.address || '').trim();
    if (addr) $('#f_address').value = addr;

    // ‚úÖ (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
    // - issue_date / expiry_date ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏µ‡πâ
    // - ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏™‡πà‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á)
    const issue = (out.issue_date || '').trim();
    const exp   = (out.expiry_date || '').trim();
    const extra = [];
    if (issue) extra.push(`‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£: ${issue}`);
    if (exp) extra.push(`‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${exp}`);
    if (extra.length) {
      const oldNote = ($('#f_note').value || '').trim();
      const addText = extra.join(' | ');
      $('#f_note').value = oldNote ? `${oldNote}\n${addText}` : addText;
    }

    if (fullName || birth || idNo || addr) {
      showToast('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)', 'ok');
    } else {
      showToast('AI ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î ‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á/‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏∞', 'warn');
    }

  } catch (err) {
    console.error(err);
    showToast('‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏∞', 'error');
  } finally {
    input.value = '';
    if (btn) { btn.innerText = oldText; btn.disabled = false; }
  }
}

  </script>
</body>
</html>
