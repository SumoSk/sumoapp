<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>
  <style>
    body {
      font-family: 'Prompt', 'Segoe UI', sans-serif;
      margin: 0;
      background-color: white;
      padding: 10px;
       padding-bottom: 120px;
    }
    .search-container {
   position: fixed;
  bottom: 120px; /* ‚úÖ ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏ô floating-dock */
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 600px;
  background: rgb(235, 255, 245); /* ‚úÖ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏õ‡∏£‡πà‡∏á */

  border-radius: 20px;
  padding: 12px 14px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  z-index: 999;
    }
    .search-container label {
      font-weight: bold;
      font-size: 14px;
      display: block;
      margin-bottom: 8px;
      text-align: center;
    }
    .search-container input {
      width: 100%;
  padding: 10px 16px 10px 40px;
  font-size: 12px;
  border: none;
  border-radius: 30px;
  background-color: rgb(255, 255, 255); /* ‚úÖ ‡πÇ‡∏õ‡∏£‡πà‡∏á‡∏ô‡∏¥‡∏î‡πÜ */
  background-image: url('https://cdn-icons-png.flaticon.com/512/622/622669.png');
  background-size: 18px;
  background-repeat: no-repeat;
  background-position: 12px center;
  box-sizing: border-box;
  color: #222;
  outline: none;
    }
       templates/sale-summary.html
    #addCustomerBtn {
      display: block;
      margin: 0 auto 15px auto;
      padding: 10px 20px;
      background-color: #4caf50;
      color: white;
      font-size: 14px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    table {
      width: 95%;
      margin: auto;
      border-collapse: collapse;
      background-color: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    th, td {
      border: 1px solid #eee;
      padding: 10px;
      text-align: left;
      font-size: 14px;
      color: #222;
      vertical-align: top;
    }
    th {
      background-color: #e0f7fa;
      color: #00796b;
      cursor: pointer;
    }
    th .arrow {
      font-size: 12px;
      margin-left: 5px;
      color: #666;
    }
    input[readonly] {
      background-color: transparent;
      color: #222;
    }
    input {
      width: 100%;
      padding: 6px;
      font-size: 14px;
      border: none;
      border-bottom: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      margin-top: 5px;
      margin-right: 5px;
      padding: 4px 10px;
      font-size: 12px;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
    }
    .edit-btn { background-color: #0288d1; }
    .save-btn { background-color: #4caf50; }
    .delete-btn { background-color: #e53935; }


      .floating-dock {
  position: fixed;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  background: rgb(235, 255, 245); /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© */

  border-radius: 24px;
  padding: 8px 12px;
  display: flex;
  gap: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  z-index: 1000;
}

.icon-button {
  width: 74px;
  height: 74px;
  padding: 4px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s ease;
  text-decoration: none;
}

.icon-button:hover {
  transform: scale(1.1);
}

.icon-button img {
  width: 74px;
  height: 74px;
  object-fit: contain;
}
  </style>
</head>
<body>
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...">
  </div>

  <button id="addCustomerBtn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>

<div id="customerForm" style="display:none; max-width: 400px; margin: 20px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
  <h3 style="margin-top: 0;">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
  <input type="text" id="new_opd" placeholder="‡πÄ‡∏•‡∏Ç OPD (4 ‡∏´‡∏•‡∏±‡∏Å)" style="margin-bottom: 10px;">
  <input type="text" id="new_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠" style="margin-bottom: 10px;">
  <input type="text" id="new_phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" style="margin-bottom: 10px;">
  <input type="text" id="new_birthMonth" placeholder="‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î" style="margin-bottom: 10px;">
  <input type="text" id="new_vip" placeholder="VIP" style="margin-bottom: 10px;">
  <input type="text" id="new_note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" style="margin-bottom: 10px;">
  <button onclick="submitNewCustomer()" class="save-btn" style="width: 100%;">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
</div>

  <table>
    <thead>
      <tr>
        <th onclick="sortTable(0, 'opd', this)">OPD <span class="arrow">‚Üï</span></th>
        <th onclick="sortTable(1, 'name', this)">‡∏ä‡∏∑‡πà‡∏≠ <span class="arrow">‚Üï</span></th>
        <th onclick="sortTable(2, 'phone', this)">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ <span class="arrow">‚Üï</span></th>
        <th onclick="sortTable(3, 'birthMonth', this)">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î <span class="arrow">‚Üï</span></th>
        <th onclick="sortTable(4, 'vip', this)">VIP <span class="arrow">‚Üï</span></th>
        <th onclick="sortTable(5, 'note', this)">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ <span class="arrow">‚Üï</span></th>
        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>
    </thead>
    <tbody id="customerTableBody"></tbody>
  </table>

  <script>
    document.getElementById('addCustomerBtn').addEventListener('click', () => {
  document.getElementById('customerForm').style.display = 'block';
});

function submitNewCustomer() {
  const opd = document.getElementById("new_opd").value.trim().padStart(4, '0');
  const name = document.getElementById("new_name").value.trim();
  const phone = document.getElementById("new_phone").value.trim();
  const birthMonth = document.getElementById("new_birthMonth").value.trim();
  const vip = document.getElementById("new_vip").value.trim();
  const note = document.getElementById("new_note").value.trim();

  if (!opd) return alert("‚ùó ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç OPD");

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥
  fetch("/api/customers")
    .then(res => res.json())
    .then(data => {
      const exists = data.some(c => String(c.opd).padStart(4, '0') === opd);
      if (exists) return alert("üö´ ‡∏°‡∏µ OPD ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");

      const payload = { opd, name, phone, birthMonth, vip, note };
      return fetch("/api/add_customer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
    })
    .then(res => res.json())
    .then(data => {
      if (data && data.message) {
        alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

        // üßπ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
        document.querySelectorAll("#customerForm input").forEach(input => input.value = "");

        // üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        location.reload();
      } else {
        alert("‚ùå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (data?.error || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"));
      }
    })
    .catch(err => {
      console.error("‚ùå ERROR:", err);
      alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå");
    });
}


  let records = [];
  let maxOPD = "0000";

  fetch("/api/customers")
    .then(res => res.json())
    .then(data => {
      console.log("üì¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å customers:", data); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
      records = data;
      const customerMap = {};
      data.forEach(r => {
        if (!r.opd) return;
        const opd = String(r.opd).padStart(4, '0');
        if (!customerMap[opd]) {
          customerMap[opd] = {
            name: r.name || '',
            phone: r.phone || '',
            birthMonth: r.birthMonth || '',
            vip: r.vip || '',
            note: r.note || ''
          };
        }
        if (opd > maxOPD) maxOPD = opd;
      });

      Object.keys(customerMap).sort().forEach(opd => {
        addRow(opd, customerMap[opd]);
      });
    })
    .catch(err => {
      console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Supabase ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
    });

  const tableBody = document.getElementById('customerTableBody');

  function createEditableCell(opd, key, value) {
    const cell = document.createElement('td');
    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.alignItems = 'center';
    wrapper.style.gap = '6px';

    const input = document.createElement('input');
    input.value = value;
    input.readOnly = true;
    input.dataset.key = key;
    input.dataset.opd = opd;
    input.style.backgroundColor = 'transparent';
    input.style.flex = '1';

    const editBtn = document.createElement('button');
    editBtn.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
    editBtn.className = 'edit-btn';
    editBtn.onclick = () => {
      input.readOnly = false;
      input.dataset.original = input.value;
      input.style.backgroundColor = 'white';
      editBtn.style.display = 'none';
      saveBtn.style.display = 'inline-block';
    };

    const saveBtn = document.createElement('button');
    saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
    saveBtn.className = 'save-btn';
    saveBtn.style.display = 'none';
    saveBtn.onclick = () => {
      const newValue = input.value;
      const originalValue = input.dataset.original;
      if (newValue !== originalValue) {
        if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á "${key}" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö OPD ${opd} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
          fetch("/api/update_customer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ opd: opd.toString(), field: key, value: newValue })
          })
            .then(res => res.json())
            .then(data => {
              if (data.message === "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à") {
                alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${key} ‡∏Ç‡∏≠‡∏á OPD ${opd} ‡πÅ‡∏•‡πâ‡∏ß`);
              } else {
                alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (data.error || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"));
              }
            })
            .catch(err => {
              console.error("Error:", err);
              alert("üö´ ‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå");
            });
        } else {
          input.value = originalValue;
        }
      }
      input.readOnly = true;
      input.style.backgroundColor = 'transparent';
      editBtn.style.display = 'inline-block';
      saveBtn.style.display = 'none';
    };

    wrapper.appendChild(input);
    wrapper.appendChild(editBtn);
    wrapper.appendChild(saveBtn);
    cell.appendChild(wrapper);
    return cell;
  }

  function createStaticCell(opd) {
    const cell = document.createElement('td');
    const input = document.createElement('input');
    input.value = opd;
    input.disabled = true;
    cell.appendChild(input);
    return cell;
  }

  function addRow(opd, data = { name: '', phone: '', birthMonth: '', vip: '', note: '' }) {
    const row = document.createElement('tr');
    row.appendChild(createStaticCell(opd));
    row.appendChild(createEditableCell(opd, 'name', data.name));
    row.appendChild(createEditableCell(opd, 'phone', data.phone));
    row.appendChild(createEditableCell(opd, 'birthMonth', data.birthMonth));
    row.appendChild(createEditableCell(opd, 'vip', data.vip));
    row.appendChild(createEditableCell(opd, 'note', data.note));

    const actionCell = document.createElement('td');
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = '‡∏•‡∏ö';
    deleteBtn.className = 'delete-btn';
    deleteBtn.onclick = () => confirmDelete(opd, deleteBtn);
    actionCell.appendChild(deleteBtn);
    row.appendChild(actionCell);

    tableBody.appendChild(row);
  }

  

  document.getElementById("searchInput").addEventListener("input", function () {
    const keyword = this.value.toLowerCase();
    const rows = tableBody.querySelectorAll("tr");
    rows.forEach(row => {
      const name = row.children[1].querySelector("input").value.toLowerCase();
      row.style.display = name.includes(keyword) ? "" : "none";
    });
  });

  function confirmDelete(opd, btn) {
    if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OPD ${opd} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    fetch("/api/delete_customer", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ opd: opd.toString() })
    })
      .then(res => res.json())
      .then(data => {
        if (data.message === "‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à") {
          alert(`üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OPD ${opd} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
          btn.closest('tr').remove();
        } else {
          alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (data.error || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"));
        }
      })
      .catch(err => {
        console.error("Error:", err);
        alert("üö´ ‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå");
      });
  }

  let sortState = {};
  function sortTable(columnIndex, keyName, thElement) {
    const rows = Array.from(tableBody.querySelectorAll("tr"));
    const ascending = !sortState[keyName];
    rows.sort((a, b) => {
      const aVal = a.children[columnIndex].querySelector("input").value.toLowerCase();
      const bVal = b.children[columnIndex].querySelector("input").value.toLowerCase();
      const aNum = parseFloat(aVal);
      const bNum = parseFloat(bVal);
      const aIsNum = !isNaN(aNum);
      const bIsNum = !isNaN(bNum);
      if (aIsNum && bIsNum) {
        return ascending ? aNum - bNum : bNum - aNum;
      } else {
        return ascending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
      }
    });
    tableBody.innerHTML = "";
    rows.forEach(row => tableBody.appendChild(row));
    document.querySelectorAll("th .arrow").forEach(el => el.textContent = "‚Üï");
    thElement.querySelector(".arrow").textContent = ascending ? "üîº" : "üîΩ";
    sortState[keyName] = ascending;
  }
</script>
  <div class="floating-dock">
  <a href="{{ url_for('dashboard') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_dashboard.png') }}">
  </a>
  <a href="{{ url_for('sale_summary') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_sale_summary.png') }}">
  </a>
  <a href="{{ url_for('record_sales') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_record_sales.png') }}">
  </a>
    <a href="{{ url_for('customer_list') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_customer_list.png') }}">
  </a>
  <a href="{{ url_for('record_customer') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_customer_history.png') }}">
  </a>
  <a href="{{ url_for('oldsaledata') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_old_customers.png') }}">
  </a>
  <a href="#" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_staff.png') }}">
  </a>
  <a href="#" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_inventory.png') }}">
  </a>
  <a href="#" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_appointments.png') }}">
  </a>
</div>

</body>
</html>