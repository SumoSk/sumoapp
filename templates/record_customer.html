<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Profile)</title>

  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a;
      --primary:#0f766e; --primary-600:#0d9488; --ring:#ccfbf1;
      --line:#e2e8f0; --danger:#ef4444; --warn:#f59e0b; --success:#22c55e;
      --radius:14px;
      --muted:#64748b;
      --soft:#f1f5f9;
      --shadow: 0 18px 45px rgba(2, 6, 23, 0.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Prompt', system-ui, -apple-system, Segoe UI, sans-serif;
      color:var(--text); background:var(--bg);
      font-size: 12px; margin:0;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      font-weight: 400;
    }

    .container{ max-width:1200px; margin: 16px auto 120px; padding: 0 12px; }

    header.appbar{
      position:sticky; top:0; z-index:50;
      background: rgba(255,255,255,0.92); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .appbar-inner{
      max-width:1200px; margin:0 auto; padding: 12px 12px;
      display:flex; align-items:center; gap:10px;
    }
    .title{ font-weight:600; font-size: 18px; color: var(--primary); display:flex; align-items:center; gap:8px; letter-spacing:.2px; }
    .grow{flex:1}

    .btn{
      appearance:none; border:none; border-radius:10px; padding:9px 14px; cursor:pointer; font-weight:500;
      display:inline-flex; align-items:center; gap:6px; transition: all .15s;
      font-family:inherit; font-size:12px;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background:var(--primary); color:white; box-shadow: 0 6px 18px rgba(15, 118, 110, 0.18); }
    .btn-primary:hover{ background:var(--primary-600); }
    .btn-ghost{ background:transparent; color:var(--text); border:1px solid transparent; }
    .btn-ghost:hover{ background:#f1f5f9; }
    .btn-danger{ background:#fee2e2; color:#b91c1c; }
    .btn-danger:hover{ background:#fecaca; }
    .btn-icon{ padding:8px; border-radius:10px; }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius: var(--radius);
      box-shadow: 0 10px 26px rgba(0,0,0,0.05);
      overflow:hidden;
    }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:10px; padding: 12px; align-items:center;
      border-bottom:1px solid var(--line); background: #f8fafc;
    }
    .search{ position:relative; flex:1; min-width: 240px; }
    .search input{
      width:100%; padding:10px 34px 10px 36px; border:1px solid var(--line); border-radius: 12px;
      outline:none; background:#fff; font-size:13px; transition: border-color .2s;
    }
    .search input:focus{ border-color: var(--primary); box-shadow: 0 0 0 3px var(--ring); }
    .search .icon{ position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.55; font-size:16px; }
    .search .clear{ position:absolute; right:12px; top:50%; transform:translateY(-50%); opacity:.55; cursor:pointer; font-size:14px; }

    .month-filter{
      border:1px solid var(--line); border-radius:12px; padding:9px 10px; background:#fff;
      font-size:12px; cursor:pointer;
    }
    .chip{ display:inline-flex; align-items:center; padding:5px 10px; border-radius:99px; font-size:11px; background:#e0f2f1; color:#0f766e; font-weight:600; }
    .chip.vip{ background:#fef3c7; color:#92400e; }
    .chip.mini{ padding:3px 8px; font-weight:600; }
    .muted{ color:#64748b; font-weight:500; font-size:11px; }

    .table-wrap{ overflow-x:auto; -webkit-overflow-scrolling: touch; }
    table{ width:100%; border-collapse:collapse; font-size: 12px; min-width: 900px; }
    thead th{
      position:sticky; top:0; z-index:1; background:#f1f5f9; color:#475569;
      font-weight:600; text-align:left; padding:10px 12px; border-bottom:1px solid var(--line);
      white-space: nowrap; cursor:pointer; user-select:none;
    }
    thead th:hover{ background:#e2e8f0; }
    tbody td{
      padding:9px 12px; border-bottom:1px solid var(--line); vertical-align:top; color: #334155;
    }
    tbody tr:hover td{ background:#f8fafc; }

    td .cell{ display:flex; align-items:center; width:100%; gap:8px; }
    td input, td textarea{
      width:100%; border:1px solid transparent; background:transparent;
      padding:4px; font-family:inherit; font-size:inherit; color:inherit; resize:none; border-radius:8px;
    }
    td input:focus, td textarea:focus{ outline:none; }
    tr.editing td input, tr.editing td textarea{
      background:#fff; border-color: #cbd5e1; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    th.sel-col, td.sel-col{ width: 42px; text-align:center; padding-left:6px; padding-right:6px;}
    th[data-key="opd"], td[data-col="opd"]{ width: 90px; font-weight:600; color: var(--primary); }
    td[data-col="opd"]{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    th[data-key="name"], td[data-col="name"]{ width: 240px; font-weight:500; }
    th[data-key="vip"], td[data-col="vip"]{ width: 120px; text-align:center; }
    th[data-key="birthMonth"], td[data-col="birthMonth"]{ width: 90px; text-align:center; }
    th[data-key="age"], td[data-col="age"]{ width: 70px; text-align:center; }
    th[data-key="birth_th_ddmmyyyy"], td[data-col="birth_th_ddmmyyyy"]{ width: 140px; }
    th:last-child, td:last-child{ width: 200px; text-align:center; }

    .actions{ display:flex; justify-content:center; gap:6px; opacity:0.85; transition:opacity .2s; }
    tr:hover .actions{ opacity:1; }

    .skeleton{ height:12px; background:#e2e8f0; border-radius:4px; animation: pulse 1.5s infinite; }
    @keyframes pulse{ 0%{opacity:.6} 50%{opacity:.3} 100%{opacity:.6} }

    .toast-wrap{ position:fixed; right:16px; bottom:16px; z-index:100; display:flex; flex-direction:column; gap:10px; }
    .toast{
      background:#fff; border-left:4px solid var(--success); padding:12px 14px; border-radius:12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1); font-weight:600; display:flex; align-items:center; gap:10px;
      transform:translateY(20px); opacity:0; transition:all .28s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      max-width: min(360px, calc(100vw - 32px));
    }
    .toast.show{ transform:translateY(0); opacity:1; }
    .toast.error{ border-left-color:var(--danger); }
    .toast.warn{ border-left-color:var(--warn); }

    .modal {
      position: fixed; inset: 0; z-index: 60;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal.open{ display:flex; }
    .modal-backdrop{
      position:absolute; inset:0; background:rgba(0,0,0,0.45);
      backdrop-filter: blur(3px);
    }
    .modal-box {
      position: relative; width: 100%; max-width: 760px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 30px 70px rgba(0,0,0,0.25);
      padding: 16px 14px;
      max-height: 90vh;
      overflow: auto;
      animation: slideUp .18s ease;
    }
    @keyframes slideUp{ from{transform:translateY(10px); opacity:0} to{transform:translateY(0); opacity:1} }

    .modal-header{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; gap:12px; }
    .modal-title{ font-size:16px; font-weight:600; color:var(--primary); display:flex; align-items:center; gap:8px; }
    .modal-sub{ font-size:11px; color:#64748b; font-weight:500; }

    .grid{ display:grid; gap:10px; grid-template-columns: repeat(12, 1fr); }
    .col-12{ grid-column: span 12; }
    .col-6{ grid-column: span 6; }
    .col-4{ grid-column: span 4; }
    .col-3{ grid-column: span 3; }

    .field-group label{ display:block; margin-bottom:4px; font-weight:600; font-size:11px; color:#64748b; }
    .field-group input, .field-group textarea, .field-group select{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:12px;
      font-family:inherit; font-size:13px; outline:none;
    }
    .field-group input:focus, .field-group textarea:focus, .field-group select:focus{
      border-color: var(--primary); box-shadow: 0 0 0 3px var(--ring);
    }
    .field-group textarea{ resize:vertical; min-height:90px; }

    .modal-footer{ display:flex; justify-content:space-between; gap:8px; margin-top:14px; align-items:center; flex-wrap:wrap; }

    #scrollTop{
      position:fixed; right:16px; bottom:16px; width:44px; height:44px; border-radius:50%;
      background:var(--primary); color:white; border:none; cursor:pointer;
      display:flex; align-items:center; justify-content:center; font-size:20px;
      box-shadow: 0 8px 18px rgba(15, 118, 110, 0.28);
      opacity:0; pointer-events:none; transition:all .25s;
      z-index: 900;
    }
    #scrollTop.visible{ opacity:1; bottom:92px; pointer-events:auto; }

    /* ‚úÖ Gallery Styles */
    .gallery-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px;
    }
    .gallery-item {
      position: relative; aspect-ratio: 1/1; border-radius: 12px; overflow: hidden;
      border: 1px solid var(--line); background: #f1f5f9; cursor: pointer;
    }
    .gallery-item img {
      width: 100%; height: 100%; object-fit: cover; transition: transform .3s;
    }
    .gallery-item:hover img { transform: scale(1.05); }
    .gallery-item .del-btn {
      position: absolute; top: 4px; right: 4px; width: 22px; height: 22px;
      background: rgba(255,255,255,0.9); border-radius: 50%; color: var(--danger);
      display: flex; align-items: center; justify-content: center; font-size: 14px;
      cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* ‚úÖ View modern */
    .view-card{
      border:1px solid var(--line);
      border-radius:18px;
      background: radial-gradient(1200px 280px at 10% 0%, #ecfeff 0%, #ffffff 55%),
                  linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .view-top{
      display:flex; align-items:flex-start; gap:12px;
      padding:12px;
      border-radius:16px;
      background: rgba(255,255,255,.9);
      border:1px solid var(--line);
      box-shadow: 0 8px 16px rgba(0,0,0,0.04);
    }
    .badge-opd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-weight:600;
      color:#0f766e;
      background:#ecfeff;
      border:1px solid #a5f3fc;
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }
    .view-name{
      font-weight:600; font-size:15px; color:#0f172a; line-height:1.25;
    }
    .view-subline{
      margin-top:6px;
      display:flex; gap:8px; flex-wrap:wrap;
      font-weight:500; color:#475569; font-size:11px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      font-weight:500; font-size:11px;
      background:#f1f5f9; color:#334155;
      border:1px solid #e2e8f0;
    }
    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px 10px;
      margin-top:12px;
    }
    .k{
      color:var(--muted); font-weight:500; font-size:11px;
      display:flex; align-items:center; gap:6px;
    }
    .v{
      color:#0f172a; font-weight:400; font-size:12px;
      word-break: break-word;
    }
    .v.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .divider{ height:1px; background:var(--line); margin:12px 0; }

    .avatar{
      width:64px; height:64px; border-radius:18px;
      overflow:hidden;
      border:1px solid var(--line);
      background: var(--soft);
      flex-shrink:0;
      box-shadow: 0 10px 24px rgba(2,6,23,.08);
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .avatar-fallback{
      width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
      color:#94a3b8; font-size:22px;
    }

    .view-gallery{
      margin-top:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.9);
      border-radius:16px;
      padding:10px;
    }
    .view-gallery-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .view-gallery-title{
      color:#334155; font-size:12px; font-weight:500;
      display:flex; align-items:center; gap:8px;
    }
    .view-gallery-strip{
      display:flex; gap:10px;
      overflow:auto; -webkit-overflow-scrolling:touch;
      padding-bottom:2px;
    }
    .thumb{
      width:86px; height:86px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--line);
      background: #f1f5f9;
      flex:0 0 auto;
      cursor:pointer;
      position:relative;
      transition: transform .15s;
    }
    .thumb:hover{ transform: translateY(-1px); }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .thumb .tag{
      position:absolute; left:8px; bottom:8px;
      font-size:10px;
      padding:4px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.85);
      border:1px solid rgba(226,232,240,.9);
      color:#334155;
    }
    .empty-gallery{
      width:100%;
      padding:18px;
      border-radius:14px;
      border:2px dashed #e2e8f0;
      color:#94a3b8;
      text-align:center;
      background:#ffffff;
    }

    @media (max-width: 768px){
      .container{ margin-top:10px; padding:0 10px; }
      .toolbar{ gap:8px; padding:10px; }
      .search{ min-width:100%; order:2; }
      .btn{ padding:8px 10px; font-size:11px; }
      table{ min-width: 680px; }
      th[data-key="birth_th_ddmmyyyy"], td[data-col="birth_th_ddmmyyyy"]{ display:none; }
      th[data-key="profile"], td[data-col="profile"]{ display:none; }
      th[data-key="note"], td[data-col="note"]{ display:none; }
      th[data-key="facebook_name"], td[data-col="facebook_name"]{ display:none; }
      .modal-box{ border-radius:18px; padding:14px 12px; }
      .col-6,.col-4,.col-3{ grid-column: span 12; }
      .kv{ grid-template-columns: 96px 1fr; }
      .thumb{ width:78px; height:78px; }
      .avatar{ width:58px; height:58px; border-radius:16px; }
    }
  </style>
</head>

<body>
  <header class="appbar">
    <div class="appbar-inner">
      <div class="title">üìñ ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
      <div class="grow"></div>
      <button id="refreshBtn" class="btn btn-ghost">‚ü≥ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      <button id="openAddModalBtn" class="btn btn-primary">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <div class="toolbar">
        <div class="search">
          <span class="icon">üîé</span>
          <input id="searchInput" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: OPD, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ö‡∏±‡∏ï‡∏£, FB, ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà, ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå, ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏...">
          <span id="clearSearch" class="clear" style="display:none;">‚úñ</span>
        </div>

        <select id="monthFilter" class="month-filter">
          <option value="">üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="01">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option><option value="02">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option><option value="03">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
          <option value="04">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option><option value="05">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option><option value="06">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
          <option value="07">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option><option value="08">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option><option value="09">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
          <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option><option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option><option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
        </select>

        <div class="grow"></div>
        <div class="chip" id="totalChip">0 ‡∏Ñ‡∏ô</div>
        <button id="bulkDeleteBtn" class="btn btn-ghost btn-icon" style="color:var(--danger);" title="‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">üóëÔ∏è</button>
        <button id="exportBtn" class="btn btn-ghost btn-icon" title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV">üì•</button>
      </div>

      <div class="table-wrap">
        <table id="customerTable">
          <thead>
            <tr>
              <th class="sel-col"><input type="checkbox" id="selectAll"></th>
              <th data-key="opd">OPD ‚Üï</th>
              <th data-key="name">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô ‚Üï</th>
              <th data-key="vip">VIP ‚Üï</th>
              <th data-key="birthMonth">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Üï</th>
              <th data-key="age">‡∏≠‡∏≤‡∏¢‡∏∏ ‚Üï</th>
              <th data-key="birth_th_ddmmyyyy">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î(‡πÑ‡∏ó‡∏¢) ‚Üï</th>
              <th data-key="facebook_name">Facebook ‚Üï</th>
              <th data-key="profile">üìù ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‚Üï</th>
              <th data-key="note">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ‚Üï</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="11"><div style="padding:20px">
              <div class="skeleton" style="margin-bottom:10px"></div>
              <div class="skeleton" style="width:80%"></div>
            </div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="addModal" class="modal">
    <div class="modal-backdrop" onclick="closeModal('addModal')"></div>
    <div class="modal-box">
      <div class="modal-header" style="align-items: flex-start;">
        <div style="flex:1;">
          <div class="modal-title" id="formModalTitle">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</div>
          <div class="modal-sub" id="formModalSub">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô (‡∏ï‡∏≤‡∏£‡∏≤‡∏á customers)</div>

          <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">

            <div style="position:relative; width:80px; height:80px; flex-shrink:0;">
              <img id="previewProfile"
                   src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2cbdjVlIj48cGF0aCBkPSZNMTIgMTJjMi4yMSAwIDQtMS43OSA0LTRzLTEuNzktNC00LTQtNCAxLjc5LTQgNCAxLjc5IDQgNCA0em0wIDJjLTIuNjcgMC04IDEuMzQtOCA0djJoMTZ2LTJjMC0yLjY2LTUuMzMtNC04LTR6Ii8+PC9zdmc+"
                   style="width:100%; height:100%; object-fit:cover; border-radius:50%; border:2px solid #e2e8f0; background:#f1f5f9;">

              <button onclick="$('#profileInput').click()" title="‡∏≠‡∏±‡∏õ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà"
                      style="position:absolute; bottom:-5px; right:-5px; background:var(--primary); color:#fff; border:none; border-radius:50%; width:28px; height:28px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 6px rgba(0,0,0,0.2); z-index:2;">
                üì∑
              </button>

              <button onclick="openPickerGallery()" type="button" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á"
                      style="position:absolute; bottom:-5px; left:-5px; background:#fff; color:#333; border:1px solid #ddd; border-radius:50%; width:28px; height:28px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 6px rgba(0,0,0,0.1); z-index:2;">
                üìÇ
              </button>

              <input type="file" id="profileInput" accept="image/*" style="display:none" onchange="previewImage(this)">
              <input type="hidden" id="selectedGalleryUrl">
            </div>

            <div style="flex:1; padding:8px 12px; background:#f0f9ff; border-radius:12px; border:1px dashed #0ea5e9; display:flex; align-items:center; gap:10px;">
              <span style="font-size:20px;">ü™™</span>
              <div style="flex:1;">
                <div style="font-weight:600; color:#0369a1; font-size:13px;">‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏±‡∏ï‡∏£ (AI)</div>
                <div style="font-size:10px; color:#64748b;">‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
              </div>
              <input type="file" id="idCardInput" accept="image/*" style="display:none" onchange="processIDCard(this)">
              <button class="btn btn-primary" style="padding:6px 10px; font-size:11px;" onclick="$('#idCardInput').click()">üì∏ ‡∏™‡πÅ‡∏Å‡∏ô</button>
            </div>
          </div>
        </div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal('addModal')">‚úï</button>
      </div>

      <input type="hidden" id="formMode" value="add">

      <div class="grid">
        <div class="field-group col-3">
          <label>OPD (4 ‡∏´‡∏•‡∏±‡∏Å) *</label>
          <input id="f_opd" type="text" maxlength="4" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0123" style="font-family:monospace; letter-spacing:1px;">
        </div>
        <div class="field-group col-3">
          <label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (01-12)</label>
          <input id="f_birthMonth" type="text" maxlength="2" placeholder="01-12">
        </div>
        <div class="field-group col-6">
          <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏ó‡∏¢ (dd/mm/yyyy)</label>
          <input id="f_birth_th" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 05/09/2530">
        </div>

        <div class="field-group col-6">
          <label>‡∏ä‡∏∑‡πà‡∏≠ (‡∏™‡∏±‡πâ‡∏ô)</label>
          <input id="f_name" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏≠‡∏ô">
        </div>
        <div class="field-group col-6">
          <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡πÄ‡∏ï‡πá‡∏°)</label>
          <input id="f_full_name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        </div>

        <div class="field-group col-6">
          <label>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
          <input id="f_phone" type="tel" placeholder="0xx-xxx-xxxx">
        </div>
        <div class="field-group col-6">
          <label>Facebook</label>
          <input id="f_facebook_name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô FB">
        </div>

        <div class="field-group col-6">
          <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
          <input id="f_national_id" type="text" placeholder="x-xxxx-xxxxx-xx-x">
        </div>
        <div class="field-group col-6">
          <label>VIP</label>
          <select id="f_vip">
            <option value="">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
            <option value="VIP">VIP</option>
            <option value="VVIP">VVIP</option>
            <option value="Gold">Gold</option>
            <option value="Silver">Silver</option>
          </select>
        </div>

        <div class="field-group col-12">
          <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
          <input id="f_address" type="text" placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏ñ‡∏ô‡∏ô/‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
        </div>

        <div class="field-group col-12">
          <label>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏£‡∏π‡πâ)</label>
          <textarea id="f_profile" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏≠‡∏ö‡∏ô‡∏ß‡∏î‡∏´‡∏ô‡πâ‡∏≤, ‡πÅ‡∏û‡πâ‡∏¢‡∏≤..., ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ö..., ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà..."></textarea>
        </div>

        <div class="field-group col-12">
          <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <input id="f_note" type="text" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ">
        </div>
      </div>

      <div class="modal-footer">
        <div class="muted" id="formHint">‚ú® ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
        <div style="display:flex; gap:8px; width:100%; justify-content:flex-end;">
          <button class="btn btn-ghost" onclick="closeModal('addModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button id="saveCustomerBtn" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>
    </div>
  </div>

  <div id="galleryModal" class="modal">
    <div class="modal-backdrop" onclick="closeModal('galleryModal')"></div>
    <div class="modal-box">
      <div class="modal-header">
        <div>
          <div class="modal-title">üñºÔ∏è ‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û <span class="chip mini" id="g_opd_chip">OPD 0000</span></div>
          <div class="modal-sub">‡∏£‡∏π‡∏õ before/after ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡πà‡∏≤‡∏á‡πÜ</div>
        </div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal('galleryModal')">‚úï</button>
      </div>

      <div style="padding:10px; background:#f8fafc; border-radius:12px; display:flex; align-items:center; justify-content:space-between; border:1px solid #e2e8f0;">
        <span class="muted" style="font-size:11px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ)</span>
        <button class="btn btn-primary" onclick="$('#galleryInput').click()">‚òÅÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        <input type="file" id="galleryInput" multiple accept="image/*" style="display:none" onchange="uploadGalleryImages(this)">
      </div>

      <div class="gallery-grid" id="galleryGrid"></div>

      <div class="modal-footer">
        <div class="muted">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡∏¢‡∏≤‡∏¢ (‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå)</div>
        <button class="btn btn-ghost" onclick="closeModal('galleryModal')">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ VIEW MODAL: ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå + ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î + ‡∏≠‡∏≤‡∏¢‡∏∏ -->
  <div id="viewModal" class="modal">
    <div class="modal-backdrop" onclick="closeModal('viewModal')"></div>
    <div class="modal-box">
      <div class="modal-header">
        <div>
          <div class="modal-title">üëÅÔ∏è ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
          <div class="modal-sub">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÅ‡∏ï‡∏∞ ‚úèÔ∏è ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</div>
        </div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal('viewModal')">‚úï</button>
      </div>

      <div class="view-card">
        <div class="view-top">
          <div class="avatar" title="‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå">
            <img id="v_avatar" alt="profile" style="display:none;">
            <div id="v_avatar_fallback" class="avatar-fallback">üë§</div>
          </div>

          <div style="flex:1; min-width:0;">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <div class="badge-opd" id="v_opd">OPD 0000</div>
              <div class="view-name" id="v_full_name">-</div>
            </div>

            <div class="view-subline">
              <span class="pill" id="v_vip">VIP: -</span>
              <span class="pill" id="v_birth_month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: -</span>
              <span class="pill" id="v_age">‡∏≠‡∏≤‡∏¢‡∏∏: -</span>
            </div>
          </div>
        </div>

        <div class="view-gallery">
          <div class="view-gallery-head">
            <div class="view-gallery-title">üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ</div>
            <button class="btn btn-ghost btn-icon" id="v_openGalleryBtn" title="‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏π‡∏õ">üìÇ</button>
          </div>
          <div id="v_gallery_strip" class="view-gallery-strip">
            <div class="empty-gallery">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...</div>
          </div>
          <div class="muted" style="margin-top:8px;">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ (‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î üìÇ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ)</div>
        </div>

        <div class="divider"></div>

        <div class="kv">
          <div class="k">ü™™ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</div>
          <div class="v mono" id="v_national_id">-</div>

          <div class="k">üéÇ ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (‡πÑ‡∏ó‡∏¢)</div>
          <div class="v" id="v_birth_th">-</div>

          <div class="k">‚è≥ ‡∏≠‡∏≤‡∏¢‡∏∏</div>
          <div class="v" id="v_age_kv">-</div>

          <div class="k">üìû ‡πÇ‡∏ó‡∏£</div>
          <div class="v mono" id="v_phone">-</div>

          <div class="k">üìò Facebook</div>
          <div class="v" id="v_fb">-</div>

          <div class="k">üè† ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</div>
          <div class="v" id="v_address">-</div>
        </div>

        <div class="divider"></div>

        <div class="k" style="margin-bottom:6px;">üìù ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</div>
        <div class="v" id="v_profile" style="white-space:pre-wrap;">-</div>

        <div class="divider"></div>

        <div class="k" style="margin-bottom:6px;">üóíÔ∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
        <div class="v" id="v_note" style="white-space:pre-wrap;">-</div>
      </div>

      <div class="modal-footer">
        <div class="muted" id="v_hint">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>
        <div style="display:flex; gap:8px; width:100%; justify-content:flex-end;">
          <button class="btn btn-danger" id="v_deleteBtn">üóëÔ∏è ‡∏•‡∏ö</button>
          <button class="btn btn-ghost" onclick="closeModal('viewModal')">‡∏õ‡∏¥‡∏î</button>
          <button class="btn btn-primary" id="v_editBtn">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toastWrap" class="toast-wrap"></div>

  {% include 'floating_menu.html' %}

  <button id="scrollTop">‚Üë</button>

  <script>
    // =========================
    // Utilities
    // =========================
    const $ = (s) => document.querySelector(s);
    const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));
    const pad4 = (s) => String(s ?? '').trim().padStart(4,'0');
    const pad2 = (s) => String(s ?? '').trim().padStart(2,'0');
    const esc = (s) => (s ?? '').toString()
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

    const DEFAULT_AVATAR_SVG = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2cbdjVlIj48cGF0aCBkPSZNMTIgMTJjMi4yMSAwIDQtMS43OSA0LTRzLTEuNzktNC00LTQtNCAxLjc5LTQgNCAxLjc5IDQgNCA0em0wIDJjLTIuNjcgMC04IDEuMzQtOCA0djJoMTZ2LTJjMC0yLjY2LTUuMzMtNC04LTR6Ii8+PC9zdmc+';

    const showToast = (msg, type='ok') => {
      const el = document.createElement('div');
      el.className = `toast ${type==='error'?'error':type==='warn'?'warn':''} show`;
      el.innerHTML = type==='error' ? `‚ùå ${msg}` : type==='warn' ? `‚ö†Ô∏è ${msg}` : `‚úÖ ${msg}`;
      $('#toastWrap').appendChild(el);
      setTimeout(() => { el.classList.remove('show'); setTimeout(()=>el.remove(), 280); }, 3000);
    };

    function openModal(id){ $('#'+id).classList.add('open'); }
    function closeModal(id){ $('#'+id).classList.remove('open'); }

    // =========================
    // State
    // =========================
    let rawData = [];
    let viewData = [];
    let selected = new Set();
    let sortConfig = { key: 'opd', asc: true };
    let currentGalleryOpd = null;
    let isPickingMode = false;

    const tbody = $('#tbody');
    const searchInput = $('#searchInput');
    const monthFilter = $('#monthFilter');

    // =========================
    // API helpers
    // =========================
    async function apiGetCustomers(){
      const r = await fetch('/api/customers', { credentials: 'same-origin' });
      if (!r.ok) throw new Error('fetch_customers_failed');
      const data = await r.json();
      if (!Array.isArray(data)) return [];
      return data;
    }

    async function apiAddCustomerFull(payload){
      const r = await fetch('/api/add_customer_v2', {
        method:'POST',
        credentials:'same-origin',
        body: payload
      });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(j.error || 'add_failed');
      return j;
    }

    async function apiUpdateCustomerPatch(opd, patch){
      const r = await fetch('/api/update_customer_patch', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify({ opd, patch })
      });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(j.error || 'update_failed');
      return j;
    }

    async function apiDeleteCustomerAndSales(opd){
      const r = await fetch('/api/delete_customer_and_sales', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify({ opd })
      });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(j.error || 'delete_failed');
      return j;
    }

    // =========================
    // ‚úÖ Gallery Functions
    // =========================
    function openGallery(opd) {
      isPickingMode = false;
      currentGalleryOpd = opd;
      $('#g_opd_chip').textContent = `OPD ${opd}`;
      $('#galleryGrid').innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; color:#94a3b8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...</div>';
      openModal('galleryModal');
      loadGalleryImages(opd);
    }

    function openPickerGallery() {
      const opd = $('#f_opd').value.trim();
      if (!opd || opd.length !== 4) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ');

      isPickingMode = true;
      currentGalleryOpd = opd;
      $('#g_opd_chip').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ OPD ${opd}`;
      $('#galleryGrid').innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
      openModal('galleryModal');
      loadGalleryImages(opd);
    }

    async function loadGalleryImages(opd) {
      try {
        const r = await fetch(`/api/get_gallery?opd=${opd}`);
        const images = await r.json();
        renderGalleryGrid(images);
      } catch (err) {
        console.error(err);
        $('#galleryGrid').innerHTML = '<div style="grid-column:1/-1; text-align:center; color:crimson;">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
      }
    }

    function renderGalleryGrid(dataList) {
      const grid = $('#galleryGrid');
      if (!dataList || dataList.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px; border:2px dashed #e2e8f0; border-radius:12px; color:#cbd5e1;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>';
        return;
      }

      grid.innerHTML = dataList.map(item => `
        <div class="gallery-item" onclick="onGalleryItemClick('${item.image_url}')">
          <img src="${item.image_url}" loading="lazy">
          ${!isPickingMode ? `<div class="del-btn" onclick="deleteGalleryImage(${item.id}); event.stopPropagation();">√ó</div>` : ''}
        </div>
      `).join('');
    }

    function onGalleryItemClick(url) {
      if (isPickingMode) {
        $('#previewProfile').src = url;
        $('#selectedGalleryUrl').value = url;
        $('#profileInput').value = '';
        closeModal('galleryModal');
        isPickingMode = false;
      } else {
        window.open(url, '_blank');
      }
    }

    async function uploadGalleryImages(input) {
      if (!input.files || input.files.length === 0) return;

      showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...', 'warn');
      const fd = new FormData();
      fd.append('opd', currentGalleryOpd);
      for (const file of input.files) {
        fd.append('images', file);
      }

      try {
        const r = await fetch('/api/upload_gallery', { method:'POST', body: fd });
        if(!r.ok) throw new Error('Upload failed');

        showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        input.value = '';
        loadGalleryImages(currentGalleryOpd);
      } catch (err) {
        showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      }
    }

    window.deleteGalleryImage = async (id) => {
      if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ?')) return;
      try {
        await fetch('/api/delete_gallery_image', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id: id})
        });
        showToast('‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
        loadGalleryImages(currentGalleryOpd);
      } catch(err) {
        showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      }
    }

    // =========================
    // ‚úÖ Form helpers
    // =========================
    function previewImage(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            $('#previewProfile').src = e.target.result;
            $('#selectedGalleryUrl').value = '';
        }
        reader.readAsDataURL(input.files[0]);
      }
    }

    function clearForm(){
      $$('#addModal input, #addModal textarea, #addModal select').forEach(i => {
        if (i.id === 'formMode') return;
        i.value = '';
      });
      $('#previewProfile').src = DEFAULT_AVATAR_SVG;
      $('#profileInput').value = '';
      $('#selectedGalleryUrl').value = '';
    }

    function setFormMode(mode){
      $('#formMode').value = mode;
      if (mode === 'add'){
        $('#formModalTitle').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
        $('#formModalSub').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô (‡∏ï‡∏≤‡∏£‡∏≤‡∏á customers)';
        $('#f_opd').readOnly = false;
        $('#f_opd').style.background = '#fff';
      } else {
        $('#formModalTitle').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
        $('#formModalSub').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        $('#f_opd').readOnly = true;
        $('#f_opd').style.background = '#f8fafc';
      }
    }

    function openAddForm(){
      clearForm();
      setFormMode('add');
      openModal('addModal');
      setTimeout(() => $('#f_opd').focus(), 50);
    }

    function openEditForm(opd){
      const r = rawData.find(x => x.opd === opd);
      if (!r) return;

      clearForm();
      setFormMode('edit');

      $('#f_opd').value = r.opd || '';
      $('#f_birthMonth').value = r.birthMonth || '';
      $('#f_birth_th').value = r.birth_th_ddmmyyyy || '';
      $('#f_name').value = r.name || '';
      $('#f_full_name').value = r.full_name || '';
      $('#f_phone').value = r.phone || '';
      $('#f_facebook_name').value = r.facebook_name || '';
      $('#f_national_id').value = r.national_id || '';
      $('#f_vip').value = r.vip || '';
      $('#f_address').value = r.address || '';
      $('#f_profile').value = r.profile || '';
      $('#f_note').value = r.note || '';

      if (r.profile_pic_url) {
        $('#previewProfile').src = r.profile_pic_url;
      }

      openModal('addModal');
    }

    // =========================
    // ‚úÖ View helpers (Age + Profile + Gallery strip)
    // =========================
    function safeDash(v){ return (v===null || v===undefined || String(v).trim()==='') ? '-' : String(v); }

    // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏ó‡∏¢ dd/mm/yyyy (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏û.‡∏®./‡∏Ñ.‡∏®.)
    function calcAgeFromThaiDate(birthTh){
      if (!birthTh) return null;
      const s = String(birthTh).trim();
      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (!m) return null;

      let dd = parseInt(m[1], 10);
      let mm = parseInt(m[2], 10);
      let yy = parseInt(m[3], 10);

      if (!dd || !mm || !yy) return null;

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®. ‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®.
      if (yy >= 2400) yy -= 543;

      const nowY = new Date().getFullYear();
      if (yy < 1900 || yy > nowY + 1) return null;

      const today = new Date();
      let age = today.getFullYear() - yy;

      const thisYearsBirthday = new Date(today.getFullYear(), mm - 1, dd);
      if (today < thisYearsBirthday) age -= 1;

      if (age < 0 || age > 130) return null;
      return age;
    }

    function setViewAvatar(url){
      const img = $('#v_avatar');
      const fb = $('#v_avatar_fallback');
      if (url && String(url).trim() !== '') {
        img.src = url;
        img.style.display = 'block';
        fb.style.display = 'none';
        img.onerror = () => {
          img.style.display = 'none';
          fb.style.display = 'flex';
        };
      } else {
        img.style.display = 'none';
        fb.style.display = 'flex';
      }
    }

    async function loadViewGalleryStrip(opd){
      const strip = $('#v_gallery_strip');
      strip.innerHTML = '<div class="empty-gallery">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...</div>';
      try{
        const r = await fetch(`/api/get_gallery?opd=${opd}`);
        const images = await r.json();

        if (!images || images.length === 0){
          strip.innerHTML = '<div class="empty-gallery">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ</div>';
          return;
        }

        strip.innerHTML = images.slice(0, 12).map((it, idx) => `
          <div class="thumb" onclick="window.open('${it.image_url}','_blank')" title="‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÄ‡∏ï‡πá‡∏°">
            <img src="${it.image_url}" loading="lazy" alt="img-${idx+1}">
            <div class="tag">${idx+1}/${images.length}</div>
          </div>
        `).join('');

      }catch(err){
        console.error(err);
        strip.innerHTML = '<div class="empty-gallery" style="color:crimson;">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
      }
    }

    function openViewPopup(opd){
      const r = rawData.find(x => x.opd === opd);
      if (!r) return;

      $('#v_opd').textContent = `OPD ${r.opd}`;
      $('#v_full_name').textContent = safeDash(r.full_name || r.name);
      $('#v_vip').textContent = `VIP: ${safeDash(r.vip)}`;
      $('#v_birth_month').textContent = `‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: ${safeDash(r.birthMonth)}`;

      $('#v_national_id').textContent = safeDash(r.national_id);
      $('#v_birth_th').textContent = safeDash(r.birth_th_ddmmyyyy);
      $('#v_phone').textContent = safeDash(r.phone);
      $('#v_fb').textContent = safeDash(r.facebook_name);
      $('#v_address').textContent = safeDash(r.address);
      $('#v_profile').textContent = safeDash(r.profile);
      $('#v_note').textContent = safeDash(r.note);

      const age = calcAgeFromThaiDate(r.birth_th_ddmmyyyy);
      const ageText = (age === null) ? '-' : `${age} ‡∏õ‡∏µ`;
      $('#v_age').textContent = `‡∏≠‡∏≤‡∏¢‡∏∏: ${ageText}`;
      $('#v_age_kv').textContent = ageText;

      setViewAvatar(r.profile_pic_url);
      loadViewGalleryStrip(opd);

      $('#v_openGalleryBtn').onclick = () => openGallery(opd);
      $('#v_editBtn').onclick = () => { closeModal('viewModal'); openEditForm(opd); };
      $('#v_deleteBtn').onclick = () => deleteRow(opd, true);

      openModal('viewModal');
    }

    // =========================
    // Load + Render
    // =========================
    async function loadData() {
      tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding:40px; color:#94a3b8; font-weight:600;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>`;

      try{
        const data = await apiGetCustomers();
        rawData = data.map(r => ({
          ...r,
          opd: pad4(r.opd ?? ''),
          birthMonth: pad2(r.birthMonth ?? '')
        })).filter(r => r.opd && r.opd !== '0000');

        $('#totalChip').textContent = `${rawData.length} ‡∏Ñ‡∏ô`;
        render();
        showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');

      }catch(err){
        console.error("load error:", err);
        tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; color:crimson; padding:20px;">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>`;
      }
    }

    function render() {
      const q = searchInput.value.toLowerCase().trim();
      const m = monthFilter.value;

      viewData = rawData.filter(r => {
        const matchMonth = !m || (r.birthMonth === m);
        if (!q) return matchMonth;
        const text = Object.values(r).join(' ').toLowerCase();
        return matchMonth && text.includes(q);
      });

      const { key, asc } = sortConfig;
      viewData.sort((a, b) => {
        let valA = a[key] ?? '';
        let valB = b[key] ?? '';

        if (key === 'opd') { valA = parseInt(valA)||0; valB = parseInt(valB)||0; }
        if (key === 'age') {
          valA = calcAgeFromThaiDate(a.birth_th_ddmmyyyy) ?? -1;
          valB = calcAgeFromThaiDate(b.birth_th_ddmmyyyy) ?? -1;
        }

        return (valA < valB ? -1 : 1) * (asc ? 1 : -1);
      });

      if (viewData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding:30px; color:#cbd5e1;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
        $('#clearSearch').style.display = q ? 'block' : 'none';
        return;
      }

      tbody.innerHTML = viewData.map(r => {
        const vipChip = r.vip ? `<span class="chip mini vip">${esc(r.vip)}</span>` : `<span class="muted">-</span>`;
        const displayName = r.name || r.full_name || '-';

        const age = calcAgeFromThaiDate(r.birth_th_ddmmyyyy);
        const ageText = (age === null) ? '' : String(age);

        return `
        <tr data-opd="${esc(r.opd)}" class="row-tap">
          <td class="sel-col">
            <input type="checkbox" value="${esc(r.opd)}" ${selected.has(r.opd)?'checked':''}
              onchange="toggleSelect('${esc(r.opd)}'); event.stopPropagation();">
          </td>

          <td data-col="opd">${esc(r.opd)}</td>

          <td data-col="name">
            <div class="cell">
              <input data-key="name" value="${esc(displayName)}" readonly ondblclick="editRow(this); event.stopPropagation();">
            </div>
          </td>

          <td data-col="vip" style="text-align:center">
            <div class="cell" style="justify-content:center;">
              <input data-key="vip" value="${esc(r.vip)}" readonly style="text-align:center; max-width:86px;" ondblclick="editRow(this); event.stopPropagation();">
              <span>${vipChip}</span>
            </div>
          </td>

          <td data-col="birthMonth">
            <div class="cell">
              <input data-key="birthMonth" value="${esc(r.birthMonth)}" readonly style="text-align:center"
                ondblclick="editRow(this); event.stopPropagation();">
            </div>
          </td>

          <td data-col="age">
            <div class="cell" style="justify-content:center;">
              <input data-key="age" value="${esc(ageText)}" readonly style="text-align:center; max-width:60px; opacity:.95;"
                onclick="event.stopPropagation();">
            </div>
          </td>

          <td data-col="birth_th_ddmmyyyy">
            <div class="cell"><input data-key="birth_th_ddmmyyyy" value="${esc(r.birth_th_ddmmyyyy)}" readonly ondblclick="editRow(this); event.stopPropagation();"></div>
          </td>

          <td data-col="facebook_name">
            <div class="cell"><input data-key="facebook_name" value="${esc(r.facebook_name)}" readonly ondblclick="editRow(this); event.stopPropagation();"></div>
          </td>

          <td data-col="profile">
            <div class="cell"><textarea data-key="profile" readonly ondblclick="editRow(this); event.stopPropagation();">${esc(r.profile)}</textarea></div>
          </td>

          <td data-col="note">
            <div class="cell"><input data-key="note" value="${esc(r.note)}" readonly ondblclick="editRow(this); event.stopPropagation();"></div>
          </td>

          <td>
            <div class="actions">
              <button class="btn-icon btn-ghost" onclick="openGallery('${esc(r.opd)}'); event.stopPropagation();" title="‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" style="color:#0ea5e9;">üñºÔ∏è</button>
              <button class="btn-icon btn-ghost" onclick="openViewPopup('${esc(r.opd)}'); event.stopPropagation();" title="‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">üëÅÔ∏è</button>
              <button class="btn-icon btn-ghost" onclick="openEditForm('${esc(r.opd)}'); event.stopPropagation();" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
              <button class="btn-icon btn-ghost save-btn" onclick="saveRow(this); event.stopPropagation();" style="display:none; color:var(--primary);" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å">üíæ</button>
              <button class="btn-icon btn-ghost cancel-btn" onclick="cancelRow(this); event.stopPropagation();" style="display:none; color:var(--warn);" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">‚ùå</button>
              <button class="btn-icon btn-ghost" onclick="deleteRow('${esc(r.opd)}'); event.stopPropagation();" title="‡∏•‡∏ö" style="color:var(--danger);">üóëÔ∏è</button>
            </div>
          </td>
        </tr>`;
      }).join('');

      $$('#tbody tr.row-tap').forEach(tr => {
        tr.onclick = (e) => {
          const t = e.target;
          if (t.closest('button') || t.matches('input[type="checkbox"]') || t.closest('.actions')) return;
          const opd = tr.dataset.opd;
          if (opd) openViewPopup(opd);
        };
      });

      $('#clearSearch').style.display = q ? 'block' : 'none';
    }

    // =========================
    // Selection / Sorting
    // =========================
    window.toggleSelect = (opd) => {
      if (selected.has(opd)) selected.delete(opd);
      else selected.add(opd);
    };

    $('#selectAll').onchange = (e) => {
      if (e.target.checked) viewData.forEach(r => selected.add(r.opd));
      else selected.clear();
      render();
    };

    $$('th[data-key]').forEach(th => {
      th.addEventListener('click', () => {
        const k = th.dataset.key;
        if (sortConfig.key === k) sortConfig.asc = !sortConfig.asc;
        else sortConfig = { key: k, asc: true };
        render();
      });
    });

    // =========================
    // Inline Edit
    // =========================
    window.editRow = (el) => {
      const tr = el.closest('tr');
      tr.classList.add('editing');
      $$('input, textarea', tr).forEach(i => i.readOnly = false);

      const actions = tr.querySelector('.actions');
      actions.querySelectorAll('button').forEach(btn => btn.style.display = 'none');
      actions.querySelector('.save-btn').style.display = 'inline-flex';
      actions.querySelector('.cancel-btn').style.display = 'inline-flex';

      const backup = {};
      $$('[data-key]', tr).forEach(inp => backup[inp.dataset.key] = inp.value);
      tr.dataset.backup = JSON.stringify(backup);
    };

    window.cancelRow = (el) => {
      const tr = el.closest('tr');
      const backup = JSON.parse(tr.dataset.backup || '{}');
      $$('[data-key]', tr).forEach(inp => {
        const k = inp.dataset.key;
        if (backup[k] !== undefined) inp.value = backup[k];
      });

      tr.classList.remove('editing');
      $$('input, textarea', tr).forEach(i => i.readOnly = true);

      const actions = tr.querySelector('.actions');
      actions.querySelectorAll('button').forEach(btn => btn.style.display = 'inline-flex');
      actions.querySelector('.save-btn').style.display = 'none';
      actions.querySelector('.cancel-btn').style.display = 'none';
      render();
    };

    window.saveRow = async (el) => {
      const tr = el.closest('tr');
      const opd = tr.dataset.opd;

      const patch = {};
      $$('[data-key]', tr).forEach(inp => {
        if (inp.dataset.key === 'age') return; // ‚úÖ age ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ backend
        patch[inp.dataset.key] = (inp.value ?? '').trim();
      });

      if (patch.birthMonth !== undefined) patch.birthMonth = pad2(patch.birthMonth);

      tr.classList.remove('editing');
      $$('input, textarea', tr).forEach(i => i.readOnly = true);

      const actions = tr.querySelector('.actions');
      actions.querySelectorAll('button').forEach(btn => btn.style.display = 'inline-flex');
      actions.querySelector('.save-btn').style.display = 'none';
      actions.querySelector('.cancel-btn').style.display = 'none';

      Object.keys(patch).forEach(k => { if (patch[k] === '') patch[k] = null; });

      try{
        await apiUpdateCustomerPatch(opd, patch);
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        await loadData();
      }catch(err){
        console.error(err);
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        await loadData();
      }
    };

    // =========================
    // Delete
    // =========================
    window.deleteRow = async (opd, fromDetail=false) => {
      if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö OPD ${opd} ?`)) return;
      try{
        await apiDeleteCustomerAndSales(opd);
        selected.delete(opd);
        showToast('‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'warn');
        closeModal('viewModal');
        await loadData();
      }catch(err){
        showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      }
    };

    $('#bulkDeleteBtn').onclick = async () => {
      if (selected.size === 0) return showToast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'warn');
      if (!confirm(`‡∏•‡∏ö ${selected.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å?`)) return;

      try{
        const list = Array.from(selected);
        for (const opd of list){
          await apiDeleteCustomerAndSales(opd);
        }
        selected.clear();
        showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', 'warn');
        await loadData();
      }catch(err){
        showToast('‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        await loadData();
      }
    };

    // =========================
    // Add/Edit Save (‡πÉ‡∏ä‡πâ FormData + Picker)
    // =========================
    $('#openAddModalBtn').onclick = openAddForm;

    $('#saveCustomerBtn').onclick = async () => {
      const opd = pad4($('#f_opd').value.trim());
      if (!opd || opd.length !== 4) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç OPD 4 ‡∏´‡∏•‡∏±‡∏Å');

      const fd = new FormData();
      fd.append('opd', opd);
      fd.append('birthMonth', pad2($('#f_birthMonth').value.trim()));
      fd.append('birth_th_ddmmyyyy', $('#f_birth_th').value.trim());
      fd.append('name', $('#f_name').value.trim());
      fd.append('full_name', $('#f_full_name').value.trim());
      fd.append('phone', $('#f_phone').value.trim()); // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
      fd.append('facebook_name', $('#f_facebook_name').value.trim());
      fd.append('national_id', $('#f_national_id').value.trim());
      fd.append('vip', $('#f_vip').value);
      fd.append('address', $('#f_address').value.trim());
      fd.append('profile', $('#f_profile').value.trim());
      fd.append('note', $('#f_note').value.trim());

      const fileInput = $('#profileInput');
      if (fileInput.files[0]) {
        fd.append('profile_pic', fileInput.files[0]);
      }

      const galleryUrl = $('#selectedGalleryUrl').value;
      if (galleryUrl && !fileInput.files[0]) {
        fd.append('existing_profile_url', galleryUrl);
      }

      const mode = $('#formMode').value;
      try {
        if (mode === 'add') {
          await apiAddCustomerFull(fd);
          showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        } else {
          const r = await fetch('/api/update_customer_with_image', {
             method: 'POST',
             body: fd
           });
           if (!r.ok) throw new Error('Update failed');
           showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
        closeModal('addModal');
        await loadData();
      } catch (err) {
        console.error(err);
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
    };

    // =========================
    // Search / Filter / Refresh
    // =========================
    searchInput.addEventListener('input', () => render());
    $('#clearSearch').onclick = () => { searchInput.value = ''; render(); };
    monthFilter.addEventListener('change', () => render());
    $('#refreshBtn').onclick = loadData;

    $('#exportBtn').onclick = () => {
      const rows = (viewData.length ? viewData : rawData);
      const headers = ['opd','name','full_name','phone','national_id','address','facebook_name','birthMonth','birth_th_ddmmyyyy','vip','profile','note','profile_pic_url'];
      const csv = [
        headers.join(','),
        ...rows.map(r => headers.map(h => `"${String(r[h] ?? '').replace(/"/g,'""')}"`).join(','))
      ].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `customers_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    };

    window.onscroll = () => {
      if (window.scrollY > 300) $('#scrollTop').classList.add('visible');
      else $('#scrollTop').classList.remove('visible');
    };
    $('#scrollTop').onclick = () => window.scrollTo({top:0, behavior:'smooth'});

    loadData();

    // =========================
    // ‚úÖ ü™™ OCR Function (‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô)
    // =========================
    async function processIDCard(input) {
      const file = input.files[0];
      if (!file) return;

      const opd = $('#f_opd').value.trim();
      if (!opd || opd.length !== 4) {
        alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πÅ‡∏Å‡∏ô\n(‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ OPD ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°‡∏£‡∏π‡∏õ)');
        input.value = '';
        return;
      }

      showToast('1/2 ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£...', 'warn');
      const btn = input.nextElementSibling;
      const oldText = btn ? btn.innerText : '';
      if (btn) { btn.innerText = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ...'; btn.disabled = true; }

      try {
        const fd = new FormData();
        fd.append('opd', opd);
        fd.append('images', file);

        const upRes = await fetch('/api/upload_gallery', { method: 'POST', body: fd });
        const upData = await upRes.json();

        if (!upRes.ok || !upData.urls || upData.urls.length === 0) {
            throw new Error('Upload failed');
        }

        const cloudUrl = upData.urls[0];
        console.log("Uploaded ID Card:", cloudUrl);

        showToast('2/2 AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'warn');
        if (btn) btn.innerText = 'ü§ñ AI ‡∏≠‡πà‡∏≤‡∏ô...';

        const ocrRes = await fetch('/api/idcard_extract', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ image_url: cloudUrl })
        });

        const out = await ocrRes.json();
        if (!ocrRes.ok) throw new Error(out.error || 'OCR failed');

        const title = (out.title_th || '').trim();
        const first = (out.first_name_th || '').trim();
        const last  = (out.last_name_th || '').trim();
        const fullName = [title, first, last].filter(Boolean).join(' ').trim();
        if (fullName) $('#f_full_name').value = fullName;

        const birth = (out.birth_date || '').trim();
        if (birth) {
          $('#f_birth_th').value = birth;
          const parts = birth.split('/');
          if (parts.length > 1 && /^\d{2}$/.test(parts[1])) $('#f_birthMonth').value = parts[1];
        }

        const idNo = (out.id_number || '').trim();
        if (idNo) $('#f_national_id').value = idNo;

        const addr = (out.address || '').trim();
        if (addr) $('#f_address').value = addr;

        showToast('‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à + ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'ok');

      } catch (err) {
        console.error(err);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
      } finally {
        input.value = '';
        if (btn) { btn.innerText = oldText; btn.disabled = false; }
      }
    }
  </script>
</body>
</html>
