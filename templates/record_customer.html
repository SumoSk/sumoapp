<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>
  <style>
    :root{
      --bg:#f7faf9; --card:#ffffff; --muted:#6b7280; --text:#0f172a;
      --primary:#0ea5a4; --primary-600:#0c8e8d; --ring:#9fe8e7;
      --line:#e5e7eb; --danger:#ef4444; --warn:#f59e0b; --success:#22c55e;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: "Prompt","Segoe UI",system-ui,-apple-system,sans-serif;
      color:var(--text); background:var(--bg);
      font-size: 11px; /* ‚¨ÖÔ∏è ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ */
    }

    .container{ max-width:1100px; margin: 18px auto 140px auto; padding: 0 12px; }
    header.appbar{
      position:sticky; top:0; z-index:50; backdrop-filter: blur(8px);
      background: color-mix(in oklab, var(--bg) 70%, white 30%); border-bottom:1px solid var(--line);
    }
    .appbar-inner{
      max-width:1100px; margin:0 auto; padding: 8px 12px; display:flex; align-items:center; gap:8px;
    }
    .title{ font-weight:700; font-size: clamp(14px, 2vw, 17px); display:flex; align-items:center; gap:6px; }
    .grow{flex:1}
    .btn{
      appearance:none; border:none; border-radius:10px; padding:6px 9px; cursor:pointer; font-weight:600;
      display:inline-flex; align-items:center; gap:6px; transition: transform .08s ease, box-shadow .2s ease, background .2s ease;
      font-size:11px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background:var(--primary); color:white; box-shadow: 0 6px 18px rgba(14,165,164,.15);}
    .btn-primary:hover{ background:var(--primary-600); }
    .btn-ghost{ background:transparent; color:var(--text); }
    .btn-danger{ background:var(--danger); color:#fff; }
    .btn-icon{ padding:6px; border-radius:8px; }
    .btn-icon svg{ width:16px; height:16px; }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius: var(--radius);
      box-shadow: 0 8px 22px rgba(2,8,23,.05);
    }

    .toolbar{
      display:grid; grid-template-columns: 1fr auto; gap:8px; padding: 8px; align-items:center;
      border-bottom:1px solid var(--line);
    }
    .left-tools{ display:grid; grid-template-columns: 1fr 140px; gap:8px; align-items:center; }
    .search{ position:relative; }
    .search input{
      width:100%; padding:8px 30px 8px 30px; border:1px solid var(--line); border-radius: 10px;
      outline:none; background:#fff; font-size:11px;
    }
    .search input:focus{ border-color: var(--primary); box-shadow: 0 0 0 3px var(--ring); }
    .search .icon{ position:absolute; left:9px; top:50%; transform:translateY(-50%); opacity:.6; font-size:14px; }
    .search .clear{ position:absolute; right:6px; top:50%; transform:translateY(-50%); opacity:.6; cursor:pointer; font-size:14px; }
    .month-filter{ border:1px solid var(--line); border-radius:10px; padding:7px 9px; background:#fff; font-size:11px; }
    .right-tools{ display:flex; gap:6px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:3px 8px; border-radius:999px; font-size:11px; background:#ecfeff; color:#155e75; border:1px solid #cffafe; }
    .muted{ color:var(--muted); }

    .table-wrap{ overflow:auto; }
    table{ width:100%; border-collapse:separate; border-spacing:0; min-width:940px; font-size: 11px; }
    thead th{
      position:sticky; top:0; z-index:1; background:#f0fdfa; color:#0f766e;
      font-weight:700; font-size:11px; text-align:left; padding:7px 8px; border-bottom:1px solid var(--line);
      cursor: pointer; white-space: nowrap;
    }
    thead th .sort{ font-size:10px; opacity:.7; margin-left:4px; }
    tbody td{
      background:#fff; padding:6px 8px; border-bottom:1px solid var(--line); vertical-align:top;
    }
    tbody tr:hover td{ background:#fafafa; }
    td .cell{ display:flex; align-items:flex-start; gap:8px; }
    td .cell input, td .cell textarea{
      width:100%; border:none; border-bottom:1px dashed transparent; padding:3px 0;
      background:transparent; font-size:11px; color:var(--text);
    }
    td .cell textarea{ resize:vertical; line-height:1.35; }
    td .cell input[readonly], td .cell textarea[readonly]{ opacity:.95; }
    td .cell input.editing, td .cell textarea.editing{ background:#fff; border-bottom-color:#cbd5e1; outline:none; }
    .actions{ display:flex; gap:6px; flex-wrap:nowrap; }
    .sel-col{ width:34px; text-align:center; }
    /* ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */
    .col-profile{ min-width: 340px; } /* ‚¨ÖÔ∏è ‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏¢‡∏≠‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô */

    .empty{ text-align:center; padding:26px 12px; color:var(--muted); }
    .skeleton{ height:10px; width:100%; background:linear-gradient(90deg, #f1f5f9, #e2e8f0, #f1f5f9); background-size:200% 100%; animation: shimmer 1.2s infinite linear; border-radius:6px; }
    @keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .row-skeleton td{ padding:7px; }

    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:60; }
    .modal.open{ display:flex; }
    .modal .backdrop{ position:absolute; inset:0; background: rgba(15,23,42,.45); backdrop-filter: blur(2px); }
    .modal .dialog{ position:relative; width:min(560px, 94vw); background:#fff; border-radius:16px; border:1px solid var(--line); box-shadow: 0 20px 60px rgba(2,8,23,.35); overflow:hidden; font-size: 11px; }
    .dialog header{ padding:10px 12px; border-bottom:1px solid var(--line); font-weight:700; display:flex; align-items:center; justify-content:space-between; }
    .dialog .body{ padding:12px; display:grid; gap:8px; }
    .field{ display:grid; gap:4px; }
    .field label{ font-size:11px; color:#334155; }
    .field input, .field textarea{ padding:7px 9px; border:1px solid var(--line); border-radius:10px; outline:none; font-size:11px; }
    .field textarea{ resize:vertical; min-height: 90px; }
    .field input:focus, .field textarea:focus{ border-color:var(--primary); box-shadow: 0 0 0 3px var(--ring); }
    .dialog footer{ padding:10px 12px; border-top:1px solid var(--line); display:flex; gap:8px; justify-content:flex-end; }

    .toast-wrap{ position:fixed; right:12px; bottom:12px; display:grid; gap:8px; z-index:80; }
    .toast{ background:#fff; border:1px solid var(--line); border-left:5px solid var(--success); padding:7px 9px; border-radius:12px; min-width:210px; box-shadow:0 12px 30px rgba(2,8,23,.15); display:flex; align-items:flex-start; gap:8px; font-size:11px; }
    .toast.warn{ border-left-color:var(--warn); }
    .toast.error{ border-left-color:var(--danger); }

    /* Floating Toggle/Menu (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) */
    .floating-toggle{ position: fixed; bottom: env(safe-area-inset-bottom, 18px); left: 16px; width: 58px; height: 58px; border-radius: 14px; display:flex; align-items:center; justify-content:center; cursor:pointer; background:#ffffff; border:1px solid var(--line); box-shadow:0 12px 30px rgba(2,8,23,.12); z-index:70; }
    .floating-toggle img{ width:36px; height:36px; }
    .floating-menu{ position:fixed; bottom:92px; left:16px; background:#fff; border:1px solid var(--line); border-radius:16px; padding:10px; display:none; flex-direction:column; align-items:center; gap:8px; box-shadow: 0 16px 40px rgba(2,8,23,.18); z-index:70; max-height: 60vh; overflow:auto; }
    .floating-menu a img{ width:52px; height:52px; }

    /* Scroll to Top */
    .scroll-top{ position:fixed; right:16px; bottom:16px; z-index:65; width:38px; height:38px; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 24px rgba(2,8,23,.12); opacity:0; pointer-events:none; transition:.2s; }
    .scroll-top.show{ opacity:1; pointer-events:auto; }
    .scroll-top span{ font-size:16px; }
    
    @media (max-width: 768px){
      .toolbar{ grid-template-columns: 1fr; }
      .left-tools{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="appbar">
    <div class="appbar-inner">
      <div class="title">üìá ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
      <div class="grow"></div>
      <button id="openAddModalBtn" class="btn btn-primary">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
      <button id="refreshBtn" class="btn btn-ghost" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">‚ü≥ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    </div>
  </header>

  <!-- Main -->
  <div class="container">
    <div class="card">
      <!-- Toolbar -->
      <div class="toolbar">
        <div class="left-tools">
          <div class="search">
            <span class="icon">üîé</span>
            <input id="searchInput" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå / OPD / ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î">
            <span id="clearSearch" class="clear" title="‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô">‚úñ</span>
          </div>
          <select id="monthFilter" class="month-filter" title="‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î">
            <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option>01</option><option>02</option><option>03</option><option>04</option>
            <option>05</option><option>06</option><option>07</option><option>08</option>
            <option>09</option><option>10</option><option>11</option><option>12</option>
          </select>
        </div>
        <div class="right-tools">
          <div class="chip" id="totalChip">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0</div>
          <button id="bulkDeleteBtn" class="btn btn-icon" title="‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">
            <svg viewBox="0 0 24 24" fill="none"><path d="M3 6h18M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <button id="exportBtn" class="btn btn-icon" title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v12m0 0-4-4m4 4 4-4M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </div>
      </div>

      <!-- Table -->
      <div class="table-wrap">
        <table id="customerTable">
          <thead>
            <tr>
              <th class="sel-col"><input type="checkbox" id="selectAll" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"></th>
              <th data-key="opd">OPD <span class="sort">‚Üï</span></th>
              <th data-key="name">‡∏ä‡∏∑‡πà‡∏≠ <span class="sort">‚Üï</span></th>
              <th data-key="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ <span class="sort">‚Üï</span></th>
              <th data-key="birthMonth">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î <span class="sort">‚Üï</span></th>
              <th data-key="profile" class="col-profile">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå <span class="sort">‚Üï</span></th>
              <th data-key="note">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ <span class="sort">‚Üï</span></th>
              <th style="width:120px">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- Skeleton -->
            <tr class="row-skeleton"><td></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td></tr>
            <tr class="row-skeleton"><td></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td></tr>
            <tr class="row-skeleton"><td></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td></tr>
          </tbody>
        </table>
      </div>
      <!-- ‡πÑ‡∏°‡πà‡∏°‡∏µ pagination: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô -->
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-wrap" id="toastWrap"></div>

  <!-- Add Modal -->
  <div id="addModal" class="modal" aria-hidden="true">
    <div class="backdrop" data-close="modal"></div>
    <div class="dialog">
      <header>
        <span id="modalTitle">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</span>
        <button class="btn btn-icon btn-ghost" data-close="modal" title="‡∏õ‡∏¥‡∏î">
          <svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </header>
      <div class="body">
        <div class="field"><label>‡πÄ‡∏•‡∏Ç OPD (4 ‡∏´‡∏•‡∏±‡∏Å)</label><input id="f_opd" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0123" inputmode="numeric" maxlength="4"></div>
        <div class="field"><label>‡∏ä‡∏∑‡πà‡∏≠</label><input id="f_name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"></div>
        <div class="field"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input id="f_phone" type="text" placeholder="0xx-xxx-xxxx"></div>
        <div class="field"><label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label><input id="f_birthMonth" type="text" placeholder="01..12 (‡∏™‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å)"></div>
        <div class="field">
          <label>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏Ñ‡∏£ / ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)</label>
          <textarea id="f_profile" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ ‡∏Ø‡∏•‡∏Ø"></textarea>
        </div>
        <div class="field"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input id="f_note" type="text" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></div>
      </div>
      <footer>
        <button class="btn btn-ghost" data-close="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="saveCustomerBtn" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </footer>
    </div>
  </div>

  <!-- Floating toggle & menu (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) -->
  <div id="floatingToggle" class="floating-toggle" onclick="toggleFloatingMenu()">
    <img src="{{ url_for('static', filename='icon/icon_menu_toggle.png') }}" alt="menu">
  </div>
  <div id="floatingMenu" class="floating-menu">
    <a href="{{ url_for('dashboard') }}"><img src="{{ url_for('static', filename='icon/icon_dashboard.png') }}" alt="dashboard"></a>
    <a href="{{ url_for('sale_summary') }}"><img src="{{ url_for('static', filename='icon/icon_sale_summary.png') }}" alt="sale summary"></a>
    <a href="{{ url_for('record_sales') }}"><img src="{{ url_for('static', filename='icon/icon_record_sales.png') }}" alt="record sales"></a>
    <a href="{{ url_for('customer_list') }}"><img src="{{ url_for('static', filename='icon/icon_customer_list.png') }}" alt="customer list"></a>
    <a href="{{ url_for('record_customer') }}"><img src="{{ url_for('static', filename='icon/icon_customer_history.png') }}" alt="customer history"></a>
    <a href="{{ url_for('oldsaledata') }}"><img src="{{ url_for('static', filename='icon/icon_old_customers.png') }}" alt="old customers"></a>
    <a href="{{ url_for('inventory') }}"><img src="{{ url_for('static', filename='icon/icon_inventory.png') }}" alt="inventory"></a>
    <a href="#"><img src="{{ url_for('static', filename='icon/icon_staff.png') }}" alt="staff"></a>
    <a href="#"><img src="{{ url_for('static', filename='icon/icon_appointments.png') }}" alt="appointments"></a>
  </div>

  <!-- Scroll to Top -->
  <button id="scrollTop" class="scroll-top" title="‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô"><span>‚Üë</span></button>

  <script>
    // ===== Utils =====
    const $ = (q, p=document)=>p.querySelector(q);
    const $$ = (q, p=document)=>Array.from(p.querySelectorAll(q));
    const toastWrap = $('#toastWrap');
    const showToast = (msg, type='ok')=>{
      const el = document.createElement('div');
      el.className = 'toast' + (type==='warn' ? ' warn' : type==='error' ? ' error' : '');
      el.innerHTML = `<div>üí°</div><div>${msg}</div>`;
      toastWrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; }, 2200);
      setTimeout(()=>{ el.remove(); }, 2800);
    };
    const pad4 = s => String(s||'').trim().padStart(4,'0');
    const debounce = (fn,ms=250)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };
    const saveSortPref = (key,asc)=>localStorage.setItem('cust_sort', JSON.stringify({key,asc}));
    const loadSortPref = ()=>{ try{return JSON.parse(localStorage.getItem('cust_sort'))||{key:'opd',asc:true}}catch{return {key:'opd',asc:true}} };
    const toCSV = (rows)=> {
      const header = ['OPD','‡∏ä‡∏∑‡πà‡∏≠','‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£','‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î','‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']; // ‚¨ÖÔ∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ VIP ‡πÅ‡∏•‡πâ‡∏ß
      const escape = v => `"${String(v??'').replaceAll('"','""')}"`;
      const lines = [header.map(escape).join(',')];
      for(const r of rows) lines.push([r.opd,r.name,r.phone,r.birthMonth,r.profile,r.note].map(escape).join(','));
      return lines.join('\n');
    };
    const download = (filename, text)=>{
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text],{type:'text/csv;charset=utf-8;'}));
      a.download = filename; a.click(); URL.revokeObjectURL(a.href);
    };
    const normalizeMonth = m => {
      const s = String(m||'').trim();
      if(/^\d{1,2}$/.test(s)) return s.padStart(2,'0');
      const map = {'‡∏°.‡∏Ñ.':'01','‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°':'01','‡∏Å.‡∏û.':'02','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå':'02','‡∏°‡∏µ.‡∏Ñ.':'03','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°':'03','‡πÄ‡∏°.‡∏¢.':'04','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô':'04','‡∏û.‡∏Ñ.':'05','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°':'05','‡∏°‡∏¥.‡∏¢.':'06','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô':'06','‡∏Å.‡∏Ñ.':'07','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°':'07','‡∏™.‡∏Ñ.':'08','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°':'08','‡∏Å.‡∏¢.':'09','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô':'09','‡∏ï.‡∏Ñ.':'10','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°':'10','‡∏û.‡∏¢.':'11','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô':'11','‡∏ò.‡∏Ñ.':'12','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°':'12'};
      return map[s] || s;
    };
    const formatPhone = raw => {
      const d = String(raw||'').replace(/\D/g,'');
      if(d.length===10) return d.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
      if(d.length===9) return d.replace(/(\d{2})(\d{3})(\d{4})/, '$1-$2-$3');
      return raw||'';
    };

    // ===== State =====
    let rawRecords = [];
    let viewRecords = [];
    let sortState = loadSortPref();
    let selected = new Set();

    // ===== Elements =====
    const tbody = $('#tbody');
    const totalChip = $('#totalChip');
    const searchInput = $('#searchInput');
    const clearSearch = $('#clearSearch');
    const monthFilter = $('#monthFilter');
    const selectAll = $('#selectAll');
    const openAddModalBtn = $('#openAddModalBtn');
    const refreshBtn = $('#refreshBtn');
    const addModal = $('#addModal');
    const saveCustomerBtn = $('#saveCustomerBtn');
    const bulkDeleteBtn = $('#bulkDeleteBtn');
    const exportBtn = $('#exportBtn');
    const scrollTopBtn = $('#scrollTop');

    // ===== Load =====
    function skeletonOn(){
      tbody.innerHTML = `
        <tr class="row-skeleton"><td></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td></tr>
        <tr class="row-skeleton"><td></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td></tr>
        <tr class="row-skeleton"><td></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td></tr>
      `;
    }

    function loadData(){
      skeletonOn();
      fetch('/api/customers')
        .then(r=>r.json())
        .then(data=>{
          const map = new Map();
          for (const r of data||[]){
            const opd = pad4(r.opd);
            if(!opd) continue;
            if(!map.has(opd)){
              map.set(opd, {
                opd,
                name: r.name||'',
                phone: formatPhone(r.phone||''),
                birthMonth: normalizeMonth(r.birthMonth||''),
                profile: r.profile||'',
                note: r.note||'',
              });
            }
          }
          rawRecords = Array.from(map.values());
          applyPipeline();
          showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        })
        .catch(err=>{
          console.error(err);
          tbody.innerHTML = `<tr><td colspan="8"><div class="empty">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</div></td></tr>`;
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå','error');
        });
    }

    function applyPipeline(){
      const kw = searchInput.value.toLowerCase().trim();
      const m = monthFilter.value;
      viewRecords = rawRecords.filter(r=>{
        const byMonth = !m || normalizeMonth(r.birthMonth)===m;
        if(!kw) return byMonth;
        const match = (
          r.name.toLowerCase().includes(kw) ||
          r.phone.toLowerCase().includes(kw) ||
          r.opd.toLowerCase().includes(kw) ||
          String(r.note).toLowerCase().includes(kw) ||
          String(r.birthMonth).toLowerCase().includes(kw) ||
          String(r.profile).toLowerCase().includes(kw) // ‚¨ÖÔ∏è ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
        );
        return byMonth && match;
      });

      const {key, asc} = sortState;
      viewRecords.sort((a,b)=>{
        let av = String(a[key]??'').toLowerCase();
        let bv = String(b[key]??'').toLowerCase();
        const an = parseFloat(av), bn = parseFloat(bv);
        if(!isNaN(an) && !isNaN(bn)) return asc ? an - bn : bn - an;
        return asc ? av.localeCompare(bv) : bv.localeCompare(av);
      });

      renderTable(viewRecords);
      totalChip.textContent = `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${rawRecords.length}`;
      selectAll.checked = viewRecords.length>0 && viewRecords.every(r=>selected.has(r.opd));
    }

    function renderTable(rows){
      if(rows.length===0){
        tbody.innerHTML = `<tr><td colspan="8"><div class="empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div></td></tr>`;
        return;
      }
      tbody.innerHTML = '';
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.dataset.opd = r.opd;

        tr.innerHTML = `
          <td class="sel-col"><input type="checkbox" data-select-row value="${r.opd}" ${selected.has(r.opd)?'checked':''}></td>
          ${cellStaticCopy(r.opd)}
          ${cellEditable('name', r.name)}
          ${cellEditable('phone', r.phone, false, {dblTel:true, copy:true})}
          ${cellEditable('birthMonth', r.birthMonth)}
          ${cellEditable('profile', r.profile, false, {multiline:true})}
          ${cellEditable('note', r.note)}
          <td>
            <div class="actions">
              <button class="btn btn-icon" data-action="edit" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                <svg viewBox="0 0 24 24" fill="none"><path d="M4 20h4l10-10a2.828 2.828 0 1 0-4-4L4 16v4z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
              <button class="btn btn-icon btn-primary" data-action="save" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" style="display:none">
                <svg viewBox="0 0 24 24" fill="none"><path d="M4 4h16v16H4zM8 4v8h8V4" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
              </button>
              <button class="btn btn-icon btn-ghost" data-action="cancel" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" style="display:none">
                <svg viewBox="0 0 24 24" fill="none"><path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
              </button>
              <button class="btn btn-icon btn-danger" data-action="del" title="‡∏•‡∏ö">
                <svg viewBox="0 0 24 24" fill="none"><path d="M3 6h18M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    // ==== cell templates ====
    function cellStaticCopy(text){
      return `<td><div class="cell"><input value="${text}" readonly title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å OPD"></div></td>`;
    }
    function cellEditable(key, value, _unused=false, opts={}){
      const safeVal = value==null ? '' : value;
      const title = String(safeVal).replaceAll('"','&quot;');
      const isProfile = opts.multiline || key==='profile';
      const inputEl = isProfile
        ? `<textarea rows="2" data-key="${key}" readonly class="${key==='profile'?'col-profile':''}" title="${title}">${safeVal}</textarea>`
        : `<input value="${safeVal}" data-key="${key}" readonly title="${title}" ${opts.copy?'data-copy':''} ${opts.dblTel?'data-dbltel':''}>`;
      return `<td class="${key==='profile'?'col-profile':''}"><div class="cell">${inputEl}</div></td>`;
    }

    // ===== Event Delegation =====
    tbody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-action]');
      const row = e.target.closest('tr');

      // copy OPD / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÅ‡∏ö‡∏ö readonly
      const inp = e.target.closest('input[readonly]');
      if(inp){
        const needsCopy = inp.matches('[data-copy]') || inp.closest('td') === row?.children[1];
        if(needsCopy){ navigator.clipboard.writeText(inp.value); showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'); }
      }

      if(!btn || !row) return;
      const action = btn.getAttribute('data-action');
      const opd = row.dataset.opd;

      if(action==='edit'){
        setRowEditable(row, true);
      }else if(action==='cancel'){
        restoreSnapshot(row);
        setRowEditable(row, false);
      }else if(action==='save'){
        const changes = diffSnapshot(row);
        if(Object.keys(changes).length===0){ setRowEditable(row,false); return; }
        Promise.all(Object.entries(changes).map(([field,value])=> updateField(opd, field, value)))
          .then(results=>{
            if(results.every(Boolean)){
              const rec = rawRecords.find(x=>x.opd===opd);
              if(rec) Object.assign(rec, changes);
              showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OPD ${opd} ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ`);
              setRowEditable(row, false, true);
            }else{
              showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
            }
          })
          .catch(()=> showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ','error'));
      }else if(action==='del'){
        if(!confirm(`‡∏•‡∏ö OPD ${opd} ?`)) return;
        fetch('/api/delete_customer', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({opd:String(opd)})
        })
        .then(r=>r.json())
        .then(d=>{
          if(d.message==='‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'){
            rawRecords = rawRecords.filter(x=>x.opd!==opd);
            selected.delete(opd);
            applyPipeline();
            showToast(`‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OPD ${opd} ‡πÅ‡∏•‡πâ‡∏ß`,'warn');
          }else{
            showToast(`‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${d.error||'‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}`,'error');
          }
        })
        .catch(()=> showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå','error'));
      }
    });

    // select row
    tbody.addEventListener('change', (e)=>{
      const chk = e.target.closest('input[data-select-row]');
      if(!chk) return;
      const opd = chk.value;
      if(chk.checked) selected.add(opd); else selected.delete(opd);
      selectAll.checked = viewRecords.length>0 && viewRecords.every(r=>selected.has(r.opd));
    });

    // dblclick ‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ input[data-dbltel] ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á readonly)
    tbody.addEventListener('dblclick', (e)=>{
      const inp = e.target.closest('input[data-dbltel]');
      if(!inp || !inp.readOnly) return;
      const tel = inp.value.replace(/\D/g,'');
      if(tel.length>=9) window.location.href = 'tel:' + tel;
    });

    // snapshot & editing helpers
    function setRowEditable(row, editable, clearSnap=false){
      const fields = $$('input[data-key], textarea[data-key]', row);
      if(editable){
        row.dataset.snapshot = JSON.stringify(takeSnapshot(row));
      }else if(clearSnap){
        delete row.dataset.snapshot;
      }
      fields.forEach(inp=>{
        inp.readOnly = !editable;
        inp.classList.toggle('editing', editable);
      });
      row.querySelector('[data-action="edit"]').style.display = editable ? 'none' : '';
      row.querySelector('[data-action="save"]').style.display = editable ? '' : 'none';
      row.querySelector('[data-action="cancel"]').style.display = editable ? '' : 'none';
    }
    function takeSnapshot(row){
      const obj = {};
      $$('input[data-key], textarea[data-key]', row).forEach(inp=> obj[inp.dataset.key] = inp.value);
      return obj;
    }
    function restoreSnapshot(row){
      const snap = row.dataset.snapshot ? JSON.parse(row.dataset.snapshot) : null;
      if(!snap) return;
      $$('input[data-key], textarea[data-key]', row).forEach(inp=>{
        const k = inp.dataset.key;
        if(k in snap) inp.value = snap[k];
      });
    }
    function diffSnapshot(row){
      const snap = row.dataset.snapshot ? JSON.parse(row.dataset.snapshot) : null;
      const diff = {};
      $$('input[data-key], textarea[data-key]', row).forEach(inp=>{
        const k = inp.dataset.key, v = inp.value;
        if(!snap || snap[k] !== v) diff[k] = v;
      });
      return diff;
    }

    function updateField(opd, field, value){
      return fetch('/api/update_customer', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({opd:String(opd), field, value})
      })
      .then(r=>r.json())
      .then(d=>{
        if(d.message==='‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à') return true;
        showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${field}): ${d.error||'‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}`, 'error');
        return false;
      })
      .catch(()=>{ showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ','error'); return false; });
    }

    // ===== Sorting (thead) =====
    function initSortHeaders(){
      $$('#customerTable thead th[data-key]').forEach(th=>{
        const key = th.getAttribute('data-key');
        if(key === sortState.key){
          th.querySelector('.sort').textContent = sortState.asc ? 'üîº' : 'üîΩ';
        }
        th.addEventListener('click', ()=>{
          if(sortState.key===key){ sortState.asc = !sortState.asc; } else { sortState.key=key; sortState.asc=true; }
          $$('#customerTable thead th .sort').forEach(s=>s.textContent='‚Üï');
          th.querySelector('.sort').textContent = sortState.asc ? 'üîº' : 'üîΩ';
          saveSortPref(sortState.key, sortState.asc);
          applyPipeline();
        });
      });
    }

    // ===== Search/Filter/SelectAll =====
    searchInput.addEventListener('input', debounce(applyPipeline, 200));
    clearSearch.addEventListener('click', ()=>{ searchInput.value=''; applyPipeline(); });
    monthFilter.addEventListener('change', applyPipeline);
    selectAll.onchange = ()=>{
      if(selectAll.checked){ viewRecords.forEach(r=> selected.add(r.opd)); }
      else{ viewRecords.forEach(r=> selected.delete(r.opd)); }
      applyPipeline();
    };

    // ===== Bulk Delete & Export =====
    bulkDeleteBtn.onclick = ()=>{
      if(selected.size===0){ showToast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','warn'); return; }
      if(!confirm(`‡∏•‡∏ö ${selected.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å?`)) return;
      const ops = Array.from(selected);
      Promise.all(ops.map(opd => fetch('/api/delete_customer', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({opd:String(opd)})
      }).then(r=>r.json())))
      .then(results=>{
        const ok = results.filter(d=>d.message==='‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à').length;
        rawRecords = rawRecords.filter(r=>!selected.has(r.opd));
        selected.clear();
        applyPipeline();
        showToast(`‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${ok} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,'warn');
      })
      .catch(()=> showToast('‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'));
    };
    exportBtn.onclick = ()=>{
      const csv = toCSV(viewRecords);
      download(`customers_${new Date().toISOString().slice(0,10)}.csv`, csv);
      showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV ‡πÅ‡∏•‡πâ‡∏ß');
    };

    // ===== Modal Add =====
    const f_opd = $('#f_opd'), f_name = $('#f_name'), f_phone = $('#f_phone'), f_birth = $('#f_birthMonth'), f_profile = $('#f_profile'), f_note = $('#f_note');
    const addModalTitle = $('#modalTitle');
    function openModal(){
      f_opd.value=''; f_name.value=''; f_phone.value=''; f_birth.value=''; f_profile.value=''; f_note.value='';
      addModalTitle.textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
      addModal.classList.add('open'); addModal.setAttribute('aria-hidden','false');
      setTimeout(()=> f_opd.focus(), 50);
    }
    function closeModal(){
      addModal.classList.remove('open'); addModal.setAttribute('aria-hidden','true');
    }
    openAddModalBtn.onclick = openModal;
    addModal.addEventListener('click', (e)=>{ if(e.target.dataset.close==='modal') closeModal(); });
    $('[data-close="modal"]').onclick = closeModal;

    f_phone.addEventListener('blur', ()=>{ f_phone.value = formatPhone(f_phone.value); });

    saveCustomerBtn.onclick = ()=>{
      const opd = pad4(f_opd.value);
      const payload = {
        opd,
        name: f_name.value.trim(),
        phone: formatPhone(f_phone.value.trim()),
        birthMonth: normalizeMonth(f_birth.value.trim()),
        profile: f_profile.value.trim(),
        note: f_note.value.trim(),
      };
      if(!opd || opd==='0000'){ showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç OPD 4 ‡∏´‡∏•‡∏±‡∏Å','warn'); f_opd.focus(); return; }
      if(rawRecords.some(x=>x.opd===opd)){ showToast('‡∏°‡∏µ OPD ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö','warn'); return; }

      fetch('/api/add_customer', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      })
      .then(r=>r.json())
      .then(d=>{
        if(d && d.message){
          rawRecords.push(payload);
          applyPipeline();
          closeModal();
          showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ');
        }else{
          showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${d?.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}`, 'error');
        }
      })
      .catch(()=> showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå','error'));
    };

    // ===== Refresh =====
    refreshBtn.onclick = ()=>{ loadData(); };

    // ===== Floating menu toggle (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) =====
    function toggleFloatingMenu(){
      const menu = document.getElementById('floatingMenu');
      menu.style.display = (menu.style.display==='flex' ? 'none' : 'flex');
    }
    window.toggleFloatingMenu = toggleFloatingMenu;
    document.addEventListener('click', function(e){
      const toggle = document.getElementById('floatingToggle');
      const menu = document.getElementById('floatingMenu');
      if(toggle && menu && !toggle.contains(e.target) && !menu.contains(e.target)) menu.style.display='none';
    });

    // ===== Scroll Top =====
    window.addEventListener('scroll', ()=>{
      if(window.scrollY > 200) scrollTopBtn.classList.add('show'); else scrollTopBtn.classList.remove('show');
    });
    scrollTopBtn.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));

    // ===== Init =====
    (function initSortHeaders(){
      $$('#customerTable thead th[data-key]').forEach(th=>{
        const key = th.getAttribute('data-key');
        if(key === sortState.key){
          th.querySelector('.sort').textContent = sortState.asc ? 'üîº' : 'üîΩ';
        }
        th.addEventListener('click', ()=>{
          if(sortState.key===key){ sortState.asc = !sortState.asc; } else { sortState.key=key; sortState.asc=true; }
          $$('#customerTable thead th .sort').forEach(s=>s.textContent='‚Üï');
          th.querySelector('.sort').textContent = sortState.asc ? 'üîº' : 'üîΩ';
          saveSortPref(sortState.key, sortState.asc);
          applyPipeline();
        });
      });
    })();
    loadData();
  </script>
</body>
</html>
