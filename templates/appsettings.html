<!-- templates/appsettings.html  (FULL) -->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</title>

  <style>
    :root{
      --teal:#0f766e;
      --teal-600:#0d9488;
      --bg:#f7f7f7;
      --card:#ffffff;
      --muted:#6b7280;
      --line:#e5e7eb;
      --danger:#c62828;
      --shadow-soft: 0 10px 30px rgba(0,0,0,.08);
      --radius:16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Thai',sans-serif;
      margin:0;
      background: var(--bg);
      color:#111827;
      padding: 10px 10px 140px;
      font-size:12px; /* ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠: 12 ‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î */
    }

    .wrap{max-width:980px;margin:0 auto;padding:6px 6px 0;}

    .topbar{
      background: linear-gradient(135deg, rgba(15,118,110,.10), rgba(13,148,136,.06));
      border:1px solid rgba(15,118,110,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      padding:14px 14px 12px;
      margin-bottom:12px;
    }
    .title{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
    h1{font-size:16px; margin:0; letter-spacing:.2px;}
    .subtitle{color:var(--muted); font-size:12px; margin-top:6px; line-height:1.4}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      background: rgba(15,118,110,.10);
      color: var(--teal);
      font-size:12px;
      white-space:nowrap;
      border:1px solid rgba(15,118,110,.15);
    }

    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      padding: 12px;
      border:1px solid rgba(17,24,39,.06);
      margin-bottom:12px;
    }

    .tabsWrap{
      position: sticky;
      top: 8px;
      z-index: 5;
      background: rgba(247,247,247,.88);
      backdrop-filter: blur(10px);
      padding: 8px 0 10px;
      margin: -4px 0 10px;
    }
    .tabs{display:flex; gap:8px; flex-wrap:wrap;}
    .tabBtn{
      appearance:none;
      border:1px solid rgba(17,24,39,.10);
      background:#fff;
      color:#111827;
      border-radius:999px;
      padding:9px 12px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
      transition: transform .08s ease, box-shadow .12s ease, background .12s ease;
    }
    .tabBtn:active{transform: translateY(1px)}
    .tabBtn.active{
      background: linear-gradient(135deg, rgba(15,118,110,.14), rgba(13,148,136,.10));
      border-color: rgba(15,118,110,.35);
      color: var(--teal);
      box-shadow: 0 10px 22px rgba(15,118,110,.12);
      font-weight: 700;
    }

    .tag{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background: #eef1f7;
      font-size:12px;
      border: 1px solid rgba(17,24,39,.08);
    }
    .tag.old{background:#fff7d6;border-color: rgba(202,138,4,.25); color:#92400e;}
    .tag.off{background:#fdecec;border-color: rgba(198,40,40,.25); color:#8a1d1d;}
    .tag.on{background:#e9fbf7;border-color: rgba(13,148,136,.25); color:#0b5d56;}
    .muted{color:var(--muted); font-size:12px}

    h2{font-size:12px; margin: 8px 0 10px; letter-spacing:.2px;}

    .bar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin: 8px 0 10px;
    }
    .bar .grow{flex:1; min-width: 220px;}
    .bar .right{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .field{display:flex; flex-direction:column; gap:6px;}
    .field label{font-size:12px; color:var(--muted);}

    input,select,button,textarea{
      font: inherit;
      font-size:12px;
      border-radius: 12px;
      border:1px solid rgba(17,24,39,.14);
      padding: 8px 9px;
      outline:none;
      background:#fff;
      transition: box-shadow .12s ease, border-color .12s ease, transform .08s ease;
    }
    textarea{min-height:74px; resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color: rgba(13,148,136,.55);
      box-shadow: 0 0 0 4px rgba(13,148,136,.14);
    }

    .btn{
      cursor:pointer;
      border:none;
      color:#fff;
      background: linear-gradient(135deg, var(--teal), var(--teal-600));
      box-shadow: 0 10px 22px rgba(15,118,110,.18);
      font-weight:700;
      white-space:nowrap;
      padding: 8px 10px;
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{background:#111827; box-shadow: 0 10px 22px rgba(0,0,0,.16);}
    .btn.ghost{
      background:#eef7f6;
      color: var(--teal);
      border:1px solid rgba(15,118,110,.18);
      box-shadow:none;
      font-weight:700;
    }
    .btn.danger{
      background: linear-gradient(135deg, #d32f2f, #b71c1c);
      box-shadow: 0 10px 22px rgba(211,47,47,.18);
    }
    .btn.small{padding:7px 9px; font-size:12px; box-shadow:none}
    .btn.small.secondary{box-shadow:none}
    .btn.small.ghost{box-shadow:none}

    /* Lists */
    .list{
      border:1px solid rgba(17,24,39,.08);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
    }
    .rowItem{
      display:grid;
      grid-template-columns: 1.4fr .9fr .7fr auto;
      gap:10px;
      padding: 10px 10px;
      border-bottom:1px solid rgba(17,24,39,.06);
      align-items:center;
    }
    .rowItem:last-child{border-bottom:none}
    .rowMain{display:flex; flex-direction:column; gap:4px; min-width:0;}
    .nameLine{display:flex; align-items:center; gap:8px; min-width:0;}
    .nameLine b{font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .subLine{font-size:12px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .mini{font-size:12px; color:var(--muted);}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}

    @media (max-width: 780px){
      .rowItem{grid-template-columns: 1fr; gap:8px;}
      .actions{justify-content:flex-start}
    }

    /* Drawer */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      z-index: 50;
    }
    .drawer{
      position:fixed;
      top:0; right:0;
      height:100%;
      width:min(420px, 92vw);
      background:#fff;
      border-left:1px solid rgba(17,24,39,.10);
      box-shadow: -20px 0 60px rgba(0,0,0,.20);
      transform: translateX(100%);
      transition: transform .18s ease;
      z-index: 60;
      display:flex;
      flex-direction:column;
    }
    .drawer.open{transform: translateX(0)}
    .backdrop.show{display:block}
    .drawerHeader{
      padding: 12px;
      border-bottom:1px solid rgba(17,24,39,.08);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .drawerTitle{display:flex; flex-direction:column; gap:4px; min-width:0;}
    .drawerTitle b{font-size:12px}
    .drawerBody{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
    }
    .drawerFooter{
      padding: 12px;
      border-top:1px solid rgba(17,24,39,.08);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .closeBtn{
      border:1px solid rgba(17,24,39,.12);
      background:#fff;
      color:#111827;
      box-shadow:none;
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(17,24,39,.92);
      color:#fff;
      padding: 10px 12px;
      border-radius: 12px;
      font-size:12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
      display:none;
      z-index: 80;
      max-width: 92vw;
      text-align:center;
    }

    /* ===== Receipt Composer (Paper) ===== */
    .rcWrap{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:12px;
      align-items:start;
    }
    .rcStage{
      background: #fff;
      border: 1px solid rgba(17,24,39,.10);
      border-radius: 14px;
      box-shadow: var(--shadow-soft);
      padding: 12px;
    }
    .paperOuter{
      width:100%;
      display:flex;
      justify-content:center;
      padding: 8px 0;
    }
    .paper{
      width: min(600px, 90vw);
      background: #fff;
      border-radius: 10px;
      border: 1px solid rgba(17,24,39,.14);
      box-shadow: 0 12px 26px rgba(0,0,0,.10);
      position: relative;
      overflow:hidden;
      touch-action: none;
      user-select:none;
      -webkit-user-select:none;
    }
    canvas#rcCanvas{
      width:100%;
      height:100%;
      display:block;
      pointer-events:none;
    }

    .rcSide{
      background:#fff;
      border:1px solid rgba(17,24,39,.08);
      border-radius: 14px;
      box-shadow: var(--shadow-soft);
      padding: 12px;
      position: sticky;
      top: 72px;
    }
    .sep{border:none;border-top:1px solid rgba(17,24,39,.08); margin: 10px 0;}
    .rangeRow{display:flex; gap:10px; align-items:center;}
    input[type="range"]{width:100%; padding:0; border:none; box-shadow:none;}

    .miniBtnRow{display:flex; gap:8px; flex-wrap:wrap;}
    .miniBtnRow .btn{flex:1}
    .btnRow{display:flex; gap:8px; flex-wrap:wrap;}
    .btnRow .btn{flex:1}

    .noteBox{
      background: rgba(15,118,110,.06);
      border: 1px solid rgba(15,118,110,.14);
      border-radius: 12px;
      padding: 10px;
      color:#0f3d3a;
      line-height:1.4;
    }

    .selectedInfo{
      border:1px dashed rgba(15,118,110,.35);
      background: rgba(15,118,110,.06);
      border-radius: 12px;
      padding: 10px;
      line-height:1.4;
    }

    .modePill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(17,24,39,.12);
      background:#fff;
      white-space:nowrap;
    }
    .modePill.danger{
      border-color: rgba(211,47,47,.25);
      background: rgba(211,47,47,.08);
      color:#8a1d1d;
      font-weight:700;
    }

    @media (max-width: 920px){
      .rcWrap{grid-template-columns: 1fr;}
      .rcSide{position:relative; top:auto;}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="title">
        <div>
          <h1>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h1>
          <div class="subtitle">‡∏à‡∏±‡∏î‡∏´‡∏°‡∏ß‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ</div>
        </div>
        <div class="pill">üßæ ‡πÉ‡∏ä‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏¥‡∏°</div>
      </div>
    </div>

    <div class="card">
      <div class="tabsWrap">
        <div class="tabs">
          <button id="tabCats" class="tabBtn active" type="button">‡∏´‡∏°‡∏ß‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
          <button id="tabProds" class="tabBtn" type="button">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
          <button id="tabTrash" class="tabBtn" type="button">‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞ <span class="tag old">‡πÄ‡∏Å‡πà‡∏≤</span></button>
          <button id="tabRC" class="tabBtn" type="button">‡∏™‡∏£‡πâ‡∏≤‡∏áA4</button>
        </div>
      </div>

      <!-- ============ CATEGORIES ============ -->
      <div id="panelCats">
        <div class="bar">
          <div class="field grow">
            <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
            <input id="catSearch" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î..." />
          </div>
          <div class="field" style="min-width:170px;">
            <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
            <select id="catFilterActive">
              <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="true">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
              <option value="false">‡∏õ‡∏¥‡∏î</option>
            </select>
          </div>
          <div class="right">
            <button class="btn" id="btnOpenAddCat" type="button">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î</button>
          </div>
        </div>
        <div class="list" id="catsList"></div>
      </div>

      <!-- ============ PRODUCTS ============ -->
      <div id="panelProds" style="display:none;">
        <div class="bar">
          <div class="field grow">
            <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
            <input id="prodSearch" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." />
          </div>
          <div class="field" style="min-width:170px;">
            <label>‡∏´‡∏°‡∏ß‡∏î</label>
            <select id="prodFilterCat">
              <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            </select>
          </div>
          <div class="field" style="min-width:170px;">
            <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
            <select id="prodFilterActive">
              <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="true">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
              <option value="false">‡∏õ‡∏¥‡∏î</option>
            </select>
          </div>
          <div class="right">
            <button class="btn" id="btnOpenAddProd" type="button">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
          </div>
        </div>
        <div class="list" id="prodsList"></div>
      </div>

      <!-- ============ TRASH ============ -->
      <div id="panelTrash" style="display:none;">
        <div class="muted">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ‚Äú‡∏•‡∏ö‚Äù ‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (deleted_at ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á) ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ</div>
        <div class="bar">
          <div class="field grow">
            <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
            <input id="trashSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞..." />
          </div>
        </div>
        <div class="list" id="trashList"></div>
      </div>

      <!-- ============ RECEIPT COMPOSER ============ -->
      <div id="panelRC" style="display:none;">
        <div class="rcWrap">
          <div class="rcStage">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
              <div>
                <h2 style="margin:0 0 6px;">Receipt Composer (‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô/‡∏ï‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)</h2>
                <div class="muted">‡∏ô‡∏¥‡πâ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏•‡∏≤‡∏Å = ‡∏¢‡πâ‡∏≤‡∏¢ | ‡∏™‡∏≠‡∏á‡∏ô‡∏¥‡πâ‡∏ß pinch = ‡∏¢‡πà‡∏≠/‡∏Ç‡∏¢‡∏≤‡∏¢ | ‡∏™‡∏≠‡∏á‡∏ô‡∏¥‡πâ‡∏ß‡∏´‡∏°‡∏∏‡∏ô = rotate | ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå</div>
              </div>
              <div id="rcModePill" class="modePill">‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div>
            </div>

            <div class="paperOuter">
              <div class="paper" id="rcPaper">
                <canvas id="rcCanvas"></canvas>
              </div>
            </div>

            <div class="muted" style="line-height:1.4;">
              ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡πÉ‡∏™‡πà‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ PNG ‡∏à‡∏∞‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏î ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏ß ‡πÉ‡∏ä‡πâ ‚Äú‡πÑ‡∏î‡∏Ñ‡∏±‡∏ó‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏•‡πâ‡∏≠‡∏°‚Äù ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
            </div>
          </div>

          <div class="rcSide">
            <div class="grid2">
              <div class="field">
                <label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</label>
                <select id="rcPaperSize">
                  <option value="A3">A3</option>
                  <option value="A4" selected>A4</option>
                  <option value="A5">A5</option>
                </select>
              </div>
              <div class="field">
                <label>‡πÅ‡∏ô‡∏ß</label>
                <select id="rcPaperOri">
                  <option value="portrait" selected>‡∏ï‡∏±‡πâ‡∏á</option>
                  <option value="landscape">‡∏ô‡∏≠‡∏ô</option>
                </select>
              </div>
            </div>

            <div class="btnRow" style="margin-top:10px;">
              <button class="btn" id="btnRcAddImage" type="button">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ</button>
              <button class="btn secondary" id="btnRcAddText" type="button">+ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
            </div>
            <input id="rcFile" type="file" accept="image/*" multiple style="display:none;">

            <hr class="sep">

            <div id="rcSelectedBox" class="selectedInfo">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                <b>‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</b>
                <span class="muted" id="rcSelType">-</span>
              </div>
              <div class="muted" id="rcSelHint" style="margin-top:6px;">‡πÅ‡∏ï‡∏∞‡∏ö‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå</div>

              <div id="rcTextControls" style="display:none; margin-top:10px;">
                <div class="field">
                  <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label>
                  <textarea id="rcTextValue" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..."></textarea>
                </div>
                <div class="grid2">
                  <div class="field">
                    <label>‡∏Ç‡∏ô‡∏≤‡∏î</label>
                    <input id="rcFontSize" type="number" min="8" max="96" value="22">
                  </div>
                  <div class="field">
                    <label>‡∏à‡∏±‡∏î‡πÅ‡∏ô‡∏ß</label>
                    <select id="rcAlign">
                      <option value="left">‡∏ã‡πâ‡∏≤‡∏¢</option>
                      <option value="center">‡∏Å‡∏•‡∏≤‡∏á</option>
                      <option value="right">‡∏Ç‡∏ß‡∏≤</option>
                    </select>
                  </div>
                </div>
                <div class="grid2">
                  <button class="btn ghost" id="rcBold" type="button">‡∏´‡∏ô‡∏≤/‡∏õ‡∏Å‡∏ï‡∏¥</button>
                  <button class="btn ghost" id="rcColor" type="button">‡∏™‡∏µ‡∏î‡∏≥/‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô</button>
                </div>
              </div>

              <div id="rcCommonControls" style="margin-top:10px; display:none;">
                <div class="field">
                  <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∂‡∏ö (opacity)</label>
                  <div class="rangeRow">
                    <input id="rcOpacity" type="range" min="10" max="100" value="100">
                    <span class="muted" id="rcOpacityTxt">100%</span>
                  </div>
                </div>

                <div class="grid2">
                  <button class="btn ghost" id="rcBringFront" type="button">‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                  <button class="btn ghost" id="rcSendBack" type="button">‡∏•‡∏á‡∏´‡∏•‡∏±‡∏á</button>
                </div>

                <div class="grid2">
                  <button class="btn ghost" id="rcDuplicate" type="button">‡∏ó‡∏≥‡∏ã‡πâ‡∏≥</button>
                  <button class="btn danger" id="rcDelete" type="button">‡∏•‡∏ö</button>
                </div>

                <div class="btnRow" style="margin-top:8px;">
                  <button class="btn small ghost" id="rcCenter" type="button">‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á</button>
                  <button class="btn small ghost" id="rcResetTransform" type="button">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                </div>

                <div class="btnRow" style="margin-top:8px;">
                  <button class="btn danger" id="rcCutout" type="button">‚úÇÔ∏è ‡πÑ‡∏î‡∏Ñ‡∏±‡∏ó (‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏•‡πâ‡∏≠‡∏°)</button>
                </div>
              </div>
            </div>

            <hr class="sep">

            <div class="field">
              <label>‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÑ‡∏ü‡∏•‡πå</label>
              <select id="rcDpi">
                <option value="150">150 DPI (‡πÄ‡∏ö‡∏≤/‡πÄ‡∏£‡πá‡∏ß)</option>
                <option value="200" selected>200 DPI (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏µ)</option>
                <option value="300">300 DPI (‡∏Ñ‡∏°/‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà)</option>
              </select>
            </div>

            <div class="btnRow" style="margin-top:10px;">
              <button class="btn secondary" id="rcSave" type="button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ</button>
              <button class="btn" id="rcShare" type="button">‡πÅ‡∏ä‡∏£‡πå</button>
            </div>

            <div class="noteBox" style="margin-top:10px;">
              ‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏î‡∏Ñ‡∏±‡∏ó: ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏•‡πâ‡∏≠‡∏° ‚Äú‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÄ‡∏™‡∏£‡πá‡∏à‚Äù<br>
              (‡∏î‡πâ‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏à‡∏∞‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™)
            </div>
          </div>
        </div>
      </div>
    </div>

    {% include 'floating_menu.html' %}
  </div>

  <!-- Drawer + backdrop -->
  <div id="backdrop" class="backdrop"></div>
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="drawerHeader">
      <div class="drawerTitle">
        <b id="drawerHeading">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</b>
        <div class="muted" id="drawerSub">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
      </div>
      <button class="closeBtn" id="btnCloseDrawer" type="button">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="drawerBody" id="drawerBody"></div>
    <div class="drawerFooter" id="drawerFooter"></div>
  </div>

  <div id="toast" class="toast"></div>

<script>
  const $ = (id) => document.getElementById(id);

  let categories = [];
  let products = [];
  let drawerState = { type: null, mode: null, data: null };

  function toast(msg){
    const t = $('toast');
    t.textContent = msg;
    t.style.display = 'block';
    clearTimeout(toast._timer);
    toast._timer = setTimeout(()=>{ t.style.display='none'; }, 1400);
  }

  function setTab(which){
    $('tabCats').classList.toggle('active', which==='cats');
    $('tabProds').classList.toggle('active', which==='prods');
    $('tabTrash').classList.toggle('active', which==='trash');
    $('tabRC').classList.toggle('active', which==='rc');

    $('panelCats').style.display = which==='cats' ? '' : 'none';
    $('panelProds').style.display = which==='prods' ? '' : 'none';
    $('panelTrash').style.display = which==='trash' ? '' : 'none';
    $('panelRC').style.display = which==='rc' ? '' : 'none';

    if(which==='rc') requestAnimationFrame(()=>RC.draw());
  }

  $('tabCats').onclick = ()=>setTab('cats');
  $('tabProds').onclick = ()=>setTab('prods');
  $('tabTrash').onclick = ()=>setTab('trash');
  $('tabRC').onclick = ()=>setTab('rc');

  async function api(url, method='GET', body=null){
    const opt = { method, headers: {} };
    if(body){
      opt.headers['Content-Type'] = 'application/json';
      opt.body = JSON.stringify(body);
    }
    const res = await fetch(url, opt);
    const data = await res.json().catch(()=> ({}));
    if(!res.ok) throw new Error(data.error || ('HTTP ' + res.status));
    return data;
  }

  function catNameById(id){
    const c = categories.find(x=>String(x.id)===String(id));
    return c ? c.name : '-';
  }

  function money(v){
    if(v===null || v===undefined || v==='') return '-';
    const n = Number(v);
    if(Number.isNaN(n)) return String(v);
    return n.toFixed(2);
  }

  function escapeHtml(s){
    return String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#39;");
  }

  function openDrawer({type, mode, data}){
    drawerState = {type, mode, data};
    $('backdrop').classList.add('show');
    $('drawer').classList.add('open');
    $('drawer').setAttribute('aria-hidden','false');
    renderDrawer();
  }
  function closeDrawer(){
    $('backdrop').classList.remove('show');
    $('drawer').classList.remove('open');
    $('drawer').setAttribute('aria-hidden','true');
    drawerState = { type:null, mode:null, data:null };
  }
  $('backdrop').onclick = closeDrawer;
  $('btnCloseDrawer').onclick = closeDrawer;
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

  function renderDrawer(){
    const {type, mode, data} = drawerState;
    const body = $('drawerBody');
    const footer = $('drawerFooter');
    body.innerHTML = '';
    footer.innerHTML = '';

    if(type === 'cat'){
      $('drawerHeading').textContent = (mode==='add') ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏ß‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
      $('drawerSub').textContent = '‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';

      const name = (data?.name ?? '');
      const sort_order = (data?.sort_order ?? 0);
      const is_active = (data?.is_active ?? true);

      body.innerHTML = `
        <div class="field">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î</label>
          <input id="d_cat_name" value="${escapeHtml(name)}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤ / ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£" />
        </div>
        <div class="grid2">
          <div class="field">
            <label>‡∏•‡∏≥‡∏î‡∏±‡∏ö (sort_order)</label>
            <input id="d_cat_sort" type="number" value="${escapeHtml(String(sort_order))}" />
          </div>
          <div class="field">
            <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
            <select id="d_cat_active">
              <option value="true" ${is_active ? 'selected':''}>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
              <option value="false" ${!is_active ? 'selected':''}>‡∏õ‡∏¥‡∏î</option>
            </select>
          </div>
        </div>
      `;

      const btnCancel = document.createElement('button');
      btnCancel.className = 'btn ghost';
      btnCancel.type = 'button';
      btnCancel.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
      btnCancel.onclick = closeDrawer;

      const btnSave = document.createElement('button');
      btnSave.className = 'btn secondary';
      btnSave.type = 'button';
      btnSave.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      btnSave.onclick = async ()=>{
        const name2 = $('d_cat_name').value.trim();
        const sort2 = parseInt($('d_cat_sort').value || '0', 10);
        const active2 = ($('d_cat_active').value === 'true');
        if(!name2) return toast('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏Å‡πà‡∏≠‡∏ô');

        if(mode==='add'){
          await api('/api/categories','POST',{name:name2, sort_order:sort2, is_active:active2});
          toast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡πÅ‡∏•‡πâ‡∏ß');
        }else{
          await api('/api/categories','PUT',{id:data.id, name:name2, sort_order:sort2, is_active:active2});
          toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
        }
        closeDrawer();
        await loadAll();
      };

      footer.appendChild(btnCancel);
      footer.appendChild(btnSave);
      return;
    }

    if(type === 'prod'){
      $('drawerHeading').textContent = (mode==='add') ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
      $('drawerSub').textContent = '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏°‡∏ß‡∏î ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';

      const name = (data?.name ?? '');
      const category_id = (data?.category_id ?? (categories[0]?.id ?? ''));
      const default_price = (data?.default_price ?? '');
      const sort_order = (data?.sort_order ?? 0);
      const is_active = (data?.is_active ?? true);

      body.innerHTML = `
        <div class="field">
          <label>‡∏´‡∏°‡∏ß‡∏î</label>
          <select id="d_prod_cat">
            ${categories
              .slice()
              .sort((a,b)=> (a.sort_order||0)-(b.sort_order||0) || (a.name||'').localeCompare(b.name||''))
              .map(c=>`<option value="${c.id}" ${String(c.id)===String(category_id)?'selected':''}>${escapeHtml(c.name)}${c.is_active?'':' (‡∏õ‡∏¥‡∏î)'}</option>`)
              .join('')}
          </select>
        </div>

        <div class="field">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
          <input id="d_prod_name" value="${escapeHtml(name)}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à / ‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤..." />
        </div>

        <div class="grid2">
          <div class="field">
            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô</label>
            <input id="d_prod_price" type="number" step="0.01" value="${escapeHtml(String(default_price))}" placeholder="‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ" />
          </div>
          <div class="field">
            <label>‡∏•‡∏≥‡∏î‡∏±‡∏ö (sort_order)</label>
            <input id="d_prod_sort" type="number" value="${escapeHtml(String(sort_order))}" />
          </div>
        </div>

        <div class="field">
          <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
          <select id="d_prod_active">
            <option value="true" ${is_active ? 'selected':''}>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
            <option value="false" ${!is_active ? 'selected':''}>‡∏õ‡∏¥‡∏î</option>
          </select>
        </div>
      `;

      const btnCancel = document.createElement('button');
      btnCancel.className = 'btn ghost';
      btnCancel.type = 'button';
      btnCancel.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
      btnCancel.onclick = closeDrawer;

      const btnSave = document.createElement('button');
      btnSave.className = 'btn secondary';
      btnSave.type = 'button';
      btnSave.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      btnSave.onclick = async ()=>{
        const category_id2 = $('d_prod_cat').value;
        const name2 = $('d_prod_name').value.trim();
        const default_price2 = $('d_prod_price').value;
        const sort2 = parseInt($('d_prod_sort').value || '0', 10);
        const active2 = ($('d_prod_active').value === 'true');
        if(!category_id2) return toast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏Å‡πà‡∏≠‡∏ô');
        if(!name2) return toast('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô');

        if(mode==='add'){
          await api('/api/products','POST',{category_id:category_id2, name:name2, default_price:default_price2, sort_order:sort2, is_active:active2});
          toast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
        }else{
          await api('/api/products','PUT',{id:data.id, category_id:category_id2, name:name2, default_price:default_price2, sort_order:sort2, is_active:active2});
          toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
        }
        closeDrawer();
        await loadAll();
      };

      footer.appendChild(btnCancel);

      if(mode==='edit'){
        const btnTrash = document.createElement('button');
        btnTrash.className = 'btn danger';
        btnTrash.type = 'button';
        btnTrash.textContent = '‡∏•‡∏ö (‡πÑ‡∏õ‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞)';
        btnTrash.onclick = async ()=>{
          if(!confirm('‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? (‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö)')) return;
          await api('/api/products','DELETE',{id:data.id});
          toast('‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡πÅ‡∏•‡πâ‡∏ß');
          closeDrawer();
          await loadAll();
        };
        footer.appendChild(btnTrash);
      }

      footer.appendChild(btnSave);
      return;
    }

    if(type === 'trash'){
      $('drawerHeading').textContent = '‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
      $('drawerSub').textContent = '‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';

      body.innerHTML = `
        <div class="field">
          <label>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
          <input value="${escapeHtml(data?.name ?? '')}" disabled />
        </div>
        <div class="field">
          <label>‡∏´‡∏°‡∏ß‡∏î</label>
          <input value="${escapeHtml(catNameById(data?.category_id))}" disabled />
        </div>
        <div class="field">
          <label>‡∏•‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠</label>
          <input value="${escapeHtml(String(data?.deleted_at||'').replace('T',' ').replace('Z',''))}" disabled />
        </div>
      `;

      const btnCancel = document.createElement('button');
      btnCancel.className = 'btn ghost';
      btnCancel.type = 'button';
      btnCancel.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
      btnCancel.onclick = closeDrawer;

      const btnRestore = document.createElement('button');
      btnRestore.className = 'btn secondary';
      btnRestore.type = 'button';
      btnRestore.textContent = '‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô';
      btnRestore.onclick = async ()=>{
        await api('/api/products_restore','POST',{id:data.id});
        toast('‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
        closeDrawer();
        await loadAll();
      };

      footer.appendChild(btnCancel);
      footer.appendChild(btnRestore);
      return;
    }
  }

  function renderProdFilterCat(){
    const sel = $('prodFilterCat');
    const current = sel.value || 'all';
    sel.innerHTML = `<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` + categories
      .slice()
      .sort((a,b)=> (a.sort_order||0)-(b.sort_order||0) || (a.name||'').localeCompare(b.name||''))
      .map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`)
      .join('');
    sel.value = (Array.from(sel.options).some(o=>o.value===current)) ? current : 'all';
  }

  function renderCatsList(){
    const q = ($('catSearch').value || '').trim().toLowerCase();
    const f = $('catFilterActive').value;

    const list = $('catsList');
    list.innerHTML = '';

    const rows = categories
      .slice()
      .sort((a,b)=> (a.sort_order||0)-(b.sort_order||0) || (a.name||'').localeCompare(b.name||''))
      .filter(c=>{
        if(q && !String(c.name||'').toLowerCase().includes(q)) return false;
        if(f==='true' && !c.is_active) return false;
        if(f==='false' && c.is_active) return false;
        return true;
      });

    if(rows.length===0){
      list.innerHTML = `<div class="rowItem"><div class="mini">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div></div>`;
      return;
    }

    rows.forEach(c=>{
      const el = document.createElement('div');
      el.className = 'rowItem';
      el.innerHTML = `
        <div class="rowMain">
          <div class="nameLine">
            <b title="${escapeHtml(c.name)}">${escapeHtml(c.name)}</b>
            ${c.is_active ? `<span class="tag on">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>` : `<span class="tag off">‡∏õ‡∏¥‡∏î</span>`}
          </div>
          <div class="subLine">sort_order: ${escapeHtml(String(c.sort_order ?? 0))}</div>
        </div>
        <div class="mini">‡πÑ‡∏≠‡∏î‡∏µ: ${escapeHtml(String(c.id))}</div>
        <div class="mini"></div>
        <div class="actions">
          <button class="btn secondary" type="button">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </div>
      `;
      el.querySelector('button').onclick = ()=> openDrawer({type:'cat', mode:'edit', data:c});
      list.appendChild(el);
    });
  }

  function renderProdsList(){
    const q = ($('prodSearch').value || '').trim().toLowerCase();
    const cat = $('prodFilterCat').value;
    const f = $('prodFilterActive').value;

    const list = $('prodsList');
    list.innerHTML = '';

    const active = products.filter(p=> !p.deleted_at);

    const rows = active
      .slice()
      .sort((a,b)=> (a.sort_order||0)-(b.sort_order||0) || (a.name||'').localeCompare(b.name||''))
      .filter(p=>{
        if(q && !String(p.name||'').toLowerCase().includes(q)) return false;
        if(cat!=='all' && String(p.category_id)!==String(cat)) return false;
        if(f==='true' && !p.is_active) return false;
        if(f==='false' && p.is_active) return false;
        return true;
      });

    if(rows.length===0){
      list.innerHTML = `<div class="rowItem"><div class="mini">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div></div>`;
      return;
    }

    rows.forEach(p=>{
      const el = document.createElement('div');
      el.className = 'rowItem';
      el.innerHTML = `
        <div class="rowMain">
          <div class="nameLine">
            <b title="${escapeHtml(p.name)}">${escapeHtml(p.name)}</b>
            ${p.is_active ? `<span class="tag on">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>` : `<span class="tag off">‡∏õ‡∏¥‡∏î</span>`}
          </div>
          <div class="subLine">${escapeHtml(catNameById(p.category_id))} ‚Ä¢ ‡∏£‡∏≤‡∏Ñ‡∏≤: ${escapeHtml(money(p.default_price))} ‚Ä¢ sort_order: ${escapeHtml(String(p.sort_order ?? 0))}</div>
        </div>
        <div class="mini">‡∏´‡∏°‡∏ß‡∏î: ${escapeHtml(catNameById(p.category_id))}</div>
        <div class="mini">‡∏ø ${escapeHtml(money(p.default_price))}</div>
        <div class="actions">
          <button class="btn secondary" type="button">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </div>
      `;
      el.querySelector('button').onclick = ()=> openDrawer({type:'prod', mode:'edit', data:p});
      list.appendChild(el);
    });
  }

  function renderTrashList(){
    const q = ($('trashSearch').value || '').trim().toLowerCase();
    const list = $('trashList');
    list.innerHTML='';

    const trash = products
      .filter(p=> !!p.deleted_at)
      .slice()
      .sort((a,b)=> String(b.deleted_at||'').localeCompare(String(a.deleted_at||'')))
      .filter(p=>{
        if(!q) return true;
        const hay = `${p.name||''} ${catNameById(p.category_id)||''}`.toLowerCase();
        return hay.includes(q);
      });

    if(trash.length===0){
      list.innerHTML = `<div class="rowItem"><div class="mini">‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏ß‡πà‡∏≤‡∏á</div></div>`;
      return;
    }

    trash.forEach(p=>{
      const el = document.createElement('div');
      el.className = 'rowItem';
      el.innerHTML = `
        <div class="rowMain">
          <div class="nameLine">
            <b title="${escapeHtml(p.name)}">${escapeHtml(p.name)}</b>
            <span class="tag old">‡πÄ‡∏Å‡πà‡∏≤</span>
          </div>
          <div class="subLine">${escapeHtml(catNameById(p.category_id))} ‚Ä¢ ‡∏•‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${escapeHtml(String(p.deleted_at||'').replace('T',' ').replace('Z',''))}</div>
        </div>
        <div class="mini">‡∏´‡∏°‡∏ß‡∏î: ${escapeHtml(catNameById(p.category_id))}</div>
        <div class="mini">${escapeHtml(String(p.deleted_at||'').replace('T',' ').replace('Z',''))}</div>
        <div class="actions">
          <button class="btn secondary" type="button">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>
        </div>
      `;
      el.querySelector('button').onclick = ()=> openDrawer({type:'trash', mode:'edit', data:p});
      list.appendChild(el);
    });
  }

  async function loadAll(){
    categories = await api('/api/categories');
    products = await api('/api/products');
    renderProdFilterCat();
    renderCatsList();
    renderProdsList();
    renderTrashList();
  }

  // Search & filters
  $('catSearch').addEventListener('input', renderCatsList);
  $('catFilterActive').addEventListener('change', renderCatsList);

  $('prodSearch').addEventListener('input', renderProdsList);
  $('prodFilterCat').addEventListener('change', renderProdsList);
  $('prodFilterActive').addEventListener('change', renderProdsList);

  $('trashSearch').addEventListener('input', renderTrashList);

  // Add buttons
  $('btnOpenAddCat').onclick = ()=> openDrawer({type:'cat', mode:'add', data:{name:'', sort_order:0, is_active:true}});
  $('btnOpenAddProd').onclick = ()=>{
    if(!categories.length) return toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏Å‡πà‡∏≠‡∏ô');
    openDrawer({type:'prod', mode:'add', data:{category_id: categories[0].id, name:'', default_price:'', sort_order:0, is_active:true}});
  };

  // ===================== Receipt Composer =====================
  const Paper = {
    sizesMM: {
      A3: { w: 297, h: 420 },
      A4: { w: 210, h: 297 },
      A5: { w: 148, h: 210 }
    },
    getSetting(){
      const size = $('rcPaperSize').value || 'A4';
      const ori = $('rcPaperOri').value || 'portrait';
      const base = this.sizesMM[size] || this.sizesMM.A4;
      let w = base.w, h = base.h;
      if(ori === 'landscape'){ const t=w; w=h; h=t; }
      return { size, ori, mmW:w, mmH:h };
    },
    mmToIn(mm){ return mm / 25.4; },
  };

  const RC = {
    paperEl: null,
    canvas: null,
    ctx: null,

    layers: [], // bottom->top
    selectedId: null,

    pointers: new Map(), // pointerId -> {x,y}
    singleLast: null,
    gesture: null,

    mode: 'normal', // 'normal' | 'cutout'
    cutPath: [],    // points in paper coords
    cutActive: false,

    init(){
      this.paperEl = $('rcPaper');
      this.canvas = $('rcCanvas');
      this.ctx = this.canvas.getContext('2d');

      this.applyPaperAspect();
      this.resizeToPaper();

      window.addEventListener('resize', ()=>{
        this.resizeToPaper();
        this.draw();
      });

      $('rcPaperSize').addEventListener('change', ()=>{
        this.applyPaperAspect();
        this.resizeToPaper();
        this.draw();
      });
      $('rcPaperOri').addEventListener('change', ()=>{
        this.applyPaperAspect();
        this.resizeToPaper();
        this.draw();
      });

      // Paper interactions
      this.paperEl.addEventListener('pointerdown', (e)=>this.onPointerDown(e));
      this.paperEl.addEventListener('pointermove', (e)=>this.onPointerMove(e));
      this.paperEl.addEventListener('pointerup', (e)=>this.onPointerUp(e));
      this.paperEl.addEventListener('pointercancel', (e)=>this.onPointerUp(e));

      // UI actions
      $('btnRcAddImage').onclick = ()=> $('rcFile').click();
      $('rcFile').addEventListener('change', async (e)=>{
        const files = Array.from(e.target.files || []);
        if(!files.length) return;
        for(const f of files){
          await this.addImageFile(f);
        }
        e.target.value = '';
        toast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
        this.draw();
      });

      $('btnRcAddText').onclick = ()=> {
        this.addTextLayer('‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏');
        this.draw();
      };

      $('rcOpacity').addEventListener('input', ()=>{
        const l = this.getSelected();
        if(!l) return;
        l.opacity = Number($('rcOpacity').value) / 100;
        $('rcOpacityTxt').textContent = `${$('rcOpacity').value}%`;
        this.draw();
      });

      $('rcBringFront').onclick = ()=>{ this.bringFront(); this.draw(); };
      $('rcSendBack').onclick = ()=>{ this.sendBack(); this.draw(); };
      $('rcDelete').onclick = ()=>{ this.deleteSelected(); this.draw(); };
      $('rcDuplicate').onclick = ()=>{ this.duplicateSelected(); this.draw(); };
      $('rcCenter').onclick = ()=>{ const l=this.getSelected(); if(l){ l.x = this.paperEl.clientWidth/2; l.y = this.paperEl.clientHeight/2; } this.draw(); };
      $('rcResetTransform').onclick = ()=>{ const l=this.getSelected(); if(l){ l.scale=1; l.rot=0; } this.syncControlsFromLayer(); this.draw(); };

      // Text controls
      $('rcTextValue').addEventListener('input', ()=>{
        const l = this.getSelected();
        if(!l || l.type!=='text') return;
        l.text = $('rcTextValue').value;
        this.draw();
      });
      $('rcFontSize').addEventListener('input', ()=>{
        const l = this.getSelected();
        if(!l || l.type!=='text') return;
        l.fontSize = Math.max(8, Math.min(96, parseInt($('rcFontSize').value || '22', 10)));
        this.draw();
      });
      $('rcAlign').addEventListener('change', ()=>{
        const l = this.getSelected();
        if(!l || l.type!=='text') return;
        l.align = $('rcAlign').value;
        this.draw();
      });
      $('rcBold').onclick = ()=>{
        const l = this.getSelected();
        if(!l || l.type!=='text') return;
        l.bold = !l.bold;
        this.draw();
      };
      $('rcColor').onclick = ()=>{
        const l = this.getSelected();
        if(!l || l.type!=='text') return;
        l.color = (l.color === '#111827') ? '#1e40af' : '#111827';
        this.draw();
      };

      // Cutout
      $('rcCutout').onclick = ()=> this.enterCutoutMode();

      // Save/Share
      $('rcSave').onclick = async ()=>{ await this.exportAs('save'); };
      $('rcShare').onclick = async ()=>{ await this.exportAs('share'); };

      this.updateSelectedUI();
    },

    applyPaperAspect(){
      const s = Paper.getSetting();
      this.paperEl.style.aspectRatio = `${s.mmW} / ${s.mmH}`;
    },

    resizeToPaper(){
      const rect = this.paperEl.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      this.canvas.width = Math.max(1, Math.floor(rect.width * dpr));
      this.canvas.height = Math.max(1, Math.floor(rect.height * dpr));
      this.canvas.style.width = rect.width + 'px';
      this.canvas.style.height = rect.height + 'px';
      this.ctx.setTransform(1,0,0,1,0,0);
      this.ctx.scale(dpr, dpr);
    },

    // ---------- Layers ----------
    newId(){ return 'L' + Math.random().toString(16).slice(2) + Date.now().toString(16); },

    addTextLayer(text){
      const w = this.paperEl.clientWidth;
      const h = this.paperEl.clientHeight;
      const id = this.newId();
      this.layers.push({
        id,
        type:'text',
        x: w/2,
        y: h/2,
        scale: 1,
        rot: 0,
        opacity: 1,
        text: text ?? '',
        fontSize: 22,
        bold: false,
        align: 'left',
        color: '#111827'
      });
      this.select(id);
      toast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß');
    },

    async addImageFile(file){
      const img = await this.loadImage(file);
      const w = this.paperEl.clientWidth;
      const h = this.paperEl.clientHeight;

      // fit to paper (contain) at start
      const s = Math.min((w*0.6)/img.naturalWidth, (h*0.6)/img.naturalHeight);
      const id = this.newId();
      this.layers.push({
        id,
        type:'image',
        x: w/2,
        y: h/2,
        scale: s,
        rot: 0,
        opacity: 1,
        img,
        imgW: img.naturalWidth,
        imgH: img.naturalHeight
      });
      this.select(id);
    },

    loadImage(file){
      return new Promise((resolve, reject)=>{
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.decoding = 'async';
        img.onload = ()=>{
          setTimeout(()=>URL.revokeObjectURL(url), 1500);
          resolve(img);
        };
        img.onerror = reject;
        img.src = url;
      });
    },

    getSelected(){
      return this.layers.find(l=>l.id===this.selectedId) || null;
    },

    select(id){
      this.selectedId = id;
      this.updateSelectedUI();
      this.syncControlsFromLayer();
    },

    deleteSelected(){
      if(!this.selectedId) return;
      const idx = this.layers.findIndex(l=>l.id===this.selectedId);
      if(idx>=0) this.layers.splice(idx,1);
      this.selectedId = this.layers.length ? this.layers[this.layers.length-1].id : null;
      this.updateSelectedUI();
      this.syncControlsFromLayer();
      toast('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
    },

    duplicateSelected(){
      const l = this.getSelected();
      if(!l) return;
      const id = this.newId();
      const copy = structuredClone ? structuredClone(l) : JSON.parse(JSON.stringify(l));
      copy.id = id;
      copy.x += 12;
      copy.y += 12;

      // reattach img object for image layers
      if(l.type==='image'){
        copy.img = l.img;
        copy.imgW = l.imgW;
        copy.imgH = l.imgH;
      }
      this.layers.push(copy);
      this.select(id);
      toast('‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡πâ‡∏ß');
    },

    bringFront(){
      const id = this.selectedId;
      if(!id) return;
      const idx = this.layers.findIndex(l=>l.id===id);
      if(idx<0 || idx===this.layers.length-1) return;
      const [it] = this.layers.splice(idx,1);
      this.layers.push(it);
      toast('‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤');
    },

    sendBack(){
      const id = this.selectedId;
      if(!id) return;
      const idx = this.layers.findIndex(l=>l.id===id);
      if(idx<=0) return;
      const [it] = this.layers.splice(idx,1);
      this.layers.unshift(it);
      toast('‡∏•‡∏á‡∏´‡∏•‡∏±‡∏á');
    },

    // ---------- UI sync ----------
    updateSelectedUI(){
      const l = this.getSelected();
      $('rcSelType').textContent = l ? (l.type==='image' ? '‡∏£‡∏π‡∏õ' : '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°') : '-';
      $('rcSelHint').textContent = l ? `‡πÅ‡∏ï‡∏∞‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á` : '‡πÅ‡∏ï‡∏∞‡∏ö‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå';
      $('rcCommonControls').style.display = l ? '' : 'none';
      $('rcTextControls').style.display = (l && l.type==='text') ? '' : 'none';
    },

    syncControlsFromLayer(){
      const l = this.getSelected();
      if(!l) return;
      const pct = Math.round((l.opacity ?? 1) * 100);
      $('rcOpacity').value = String(pct);
      $('rcOpacityTxt').textContent = `${pct}%`;

      if(l.type==='text'){
        $('rcTextValue').value = l.text ?? '';
        $('rcFontSize').value = String(l.fontSize ?? 22);
        $('rcAlign').value = l.align ?? 'left';
      }
    },

    // ---------- Pointer + hit test ----------
    getPaperPoint(e){
      const r = this.paperEl.getBoundingClientRect();
      return { x: e.clientX - r.left, y: e.clientY - r.top };
    },

    onPointerDown(e){
      this.paperEl.setPointerCapture(e.pointerId);
      const p = this.getPaperPoint(e);
      this.pointers.set(e.pointerId, p);

      if(this.mode === 'cutout'){
        // begin / continue drawing path
        if(!this.cutActive){
          this.cutActive = true;
          this.cutPath = [p];
        }else{
          this.cutPath.push(p);
        }
        this.updateModePill();
        this.draw();
        return;
      }

      // normal mode: select layer on tap
      if(this.pointers.size === 1){
        const hit = this.hitTestTopmost(p);
        if(hit){
          this.select(hit.id);
        }else{
          this.select(null);
          this.selectedId = null;
          this.updateSelectedUI();
        }
        this.singleLast = p;
        this.gesture = null;
        this.draw();
        return;
      }

      if(this.pointers.size === 2){
        // start gesture on selected layer only
        this.startGesture();
      }
    },

    onPointerMove(e){
      if(!this.pointers.has(e.pointerId)) return;
      const p = this.getPaperPoint(e);
      this.pointers.set(e.pointerId, p);

      if(this.mode === 'cutout'){
        if(this.cutActive){
          this.cutPath.push(p);
          this.draw();
        }
        return;
      }

      const l = this.getSelected();
      if(!l) return;

      if(this.pointers.size === 1 && this.singleLast){
        const dx = p.x - this.singleLast.x;
        const dy = p.y - this.singleLast.y;
        l.x += dx;
        l.y += dy;
        this.singleLast = p;
        this.draw();
        return;
      }

      if(this.pointers.size === 2){
        this.updateGesture();
        this.syncControlsFromLayer();
        this.draw();
      }
    },

    onPointerUp(e){
      this.pointers.delete(e.pointerId);
      this.singleLast = null;
      this.gesture = null;
    },

    startGesture(){
      const l = this.getSelected();
      if(!l) return;
      const pts = Array.from(this.pointers.values());
      if(pts.length !== 2) return;

      const [p1, p2] = pts;
      const center = { x:(p1.x+p2.x)/2, y:(p1.y+p2.y)/2 };
      const dist = Math.hypot(p2.x-p1.x, p2.y-p1.y) || 1;
      const angle = Math.atan2(p2.y-p1.y, p2.x-p1.x);

      this.gesture = {
        startCenter: center,
        startDist: dist,
        startAngle: angle,
        startX: l.x,
        startY: l.y,
        startScale: l.scale,
        startRot: l.rot
      };
    },

    clamp(v,min,max){ return Math.max(min, Math.min(max, v)); },

    updateGesture(){
      const l = this.getSelected();
      if(!l) return;

      const pts = Array.from(this.pointers.values());
      if(pts.length !== 2) return;
      if(!this.gesture) this.startGesture();

      const g = this.gesture;
      const [p1, p2] = pts;
      const center = { x:(p1.x+p2.x)/2, y:(p1.y+p2.y)/2 };
      const dist = Math.hypot(p2.x-p1.x, p2.y-p1.y) || 1;
      const angle = Math.atan2(p2.y-p1.y, p2.x-p1.x);

      l.x = g.startX + (center.x - g.startCenter.x);
      l.y = g.startY + (center.y - g.startCenter.y);

      const scaleFactor = dist / g.startDist;
      l.scale = this.clamp(g.startScale * scaleFactor, 0.05, 10);

      let newRot = g.startRot + (angle - g.startAngle);
      if(newRot > Math.PI) newRot -= 2*Math.PI;
      if(newRot < -Math.PI) newRot += 2*Math.PI;
      l.rot = newRot;
    },

    // hit test topmost
    hitTestTopmost(p){
      for(let i=this.layers.length-1; i>=0; i--){
        const l = this.layers[i];
        if(this.pointInLayer(p, l)) return l;
      }
      return null;
    },

    pointInLayer(p, l){
      // inverse transform (paper point -> local)
      const dx = p.x - l.x;
      const dy = p.y - l.y;
      const cos = Math.cos(-l.rot);
      const sin = Math.sin(-l.rot);
      const rx = (dx*cos - dy*sin) / (l.scale || 1);
      const ry = (dx*sin + dy*cos) / (l.scale || 1);

      if(l.type === 'image'){
        const hw = (l.imgW || 0)/2;
        const hh = (l.imgH || 0)/2;
        return rx >= -hw && rx <= hw && ry >= -hh && ry <= hh;
      }

      if(l.type === 'text'){
        const m = this.measureTextBox(l);
        const hw = m.w/2;
        const hh = m.h/2;
        return rx >= -hw && rx <= hw && ry >= -hh && ry <= hh;
      }

      return false;
    },

    measureTextBox(l){
      const ctx = this.ctx;
      ctx.save();
      ctx.font = `${l.bold ? '700':'400'} ${l.fontSize || 22}px system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Thai',sans-serif`;
      const lines = String(l.text ?? '').split('\n');
      let maxW = 10;
      for(const line of lines){
        maxW = Math.max(maxW, ctx.measureText(line || ' ').width);
      }
      const lineH = (l.fontSize || 22) * 1.25;
      const h = Math.max(lineH, lines.length * lineH);
      ctx.restore();
      return { w: maxW, h };
    },

    // ---------- Draw ----------
    draw(){
      const ctx = this.ctx;
      const w = this.paperEl.clientWidth;
      const h = this.paperEl.clientHeight;

      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,w,h);

      // draw layers bottom->top
      for(const l of this.layers){
        ctx.save();
        ctx.globalAlpha = l.opacity ?? 1;
        ctx.translate(l.x, l.y);
        ctx.rotate(l.rot || 0);
        ctx.scale(l.scale || 1, l.scale || 1);

        if(l.type === 'image' && l.img){
          ctx.drawImage(l.img, -l.imgW/2, -l.imgH/2, l.imgW, l.imgH);
        }

        if(l.type === 'text'){
          const fontSize = l.fontSize || 22;
          ctx.font = `${l.bold ? '700':'400'} ${fontSize}px system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Thai',sans-serif`;
          ctx.fillStyle = l.color || '#111827';
          ctx.textBaseline = 'middle';

          const lines = String(l.text ?? '').split('\n');
          const lineH = fontSize * 1.25;
          const box = this.measureTextBox(l);
          // align
          let align = l.align || 'left';
          ctx.textAlign = align;

          for(let i=0;i<lines.length;i++){
            const y = (-box.h/2) + (i*lineH) + (lineH/2);
            let x = 0;
            if(align==='left') x = -box.w/2;
            if(align==='center') x = 0;
            if(align==='right') x = box.w/2;
            ctx.fillText(lines[i], x, y);
          }
        }

        // selection outline (in normal mode)
        if(this.mode==='normal' && this.selectedId === l.id){
          ctx.globalAlpha = 1;
          ctx.lineWidth = 2 / (l.scale || 1);
          ctx.setLineDash([6/(l.scale||1), 6/(l.scale||1)]);
          ctx.strokeStyle = 'rgba(13,148,136,.9)';
          if(l.type==='image'){
            ctx.strokeRect(-l.imgW/2, -l.imgH/2, l.imgW, l.imgH);
          }else if(l.type==='text'){
            const m = this.measureTextBox(l);
            ctx.strokeRect(-m.w/2, -m.h/2, m.w, m.h);
          }
        }

        ctx.restore();
      }

      // cutout overlay
      if(this.mode==='cutout'){
        ctx.save();
        ctx.globalAlpha = .95;
        // darken
        ctx.fillStyle = 'rgba(17,24,39,.10)';
        ctx.fillRect(0,0,w,h);

        // path
        if(this.cutPath.length){
          ctx.beginPath();
          ctx.moveTo(this.cutPath[0].x, this.cutPath[0].y);
          for(let i=1;i<this.cutPath.length;i++){
            ctx.lineTo(this.cutPath[i].x, this.cutPath[i].y);
          }
          ctx.strokeStyle = 'rgba(211,47,47,.95)';
          ctx.lineWidth = 3;
          ctx.setLineDash([]);
          ctx.stroke();

          // show hint circle at start
          const s = this.cutPath[0];
          ctx.fillStyle = 'rgba(211,47,47,.95)';
          ctx.beginPath();
          ctx.arc(s.x, s.y, 4, 0, Math.PI*2);
          ctx.fill();
        }

        ctx.restore();
      }
    },

    // ---------- Cutout ----------
    enterCutoutMode(){
      const l = this.getSelected();
      if(!l || l.type!=='image') return toast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏£‡∏π‡∏õ‚Äù ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏î‡∏Ñ‡∏±‡∏ó');
      this.mode = 'cutout';
      this.cutActive = false;
      this.cutPath = [];
      this.updateModePill(true);
      this.updateCutoutButtons();
      toast('‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏î‡∏Ñ‡∏±‡∏ó: ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏•‡πâ‡∏≠‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÄ‡∏™‡∏£‡πá‡∏à‚Äù');
    },

    exitCutoutMode(){
      this.mode = 'normal';
      this.cutActive = false;
      this.cutPath = [];
      this.updateModePill(false);
      this.updateCutoutButtons();
      this.draw();
    },

    updateModePill(){
      const pill = $('rcModePill');
      if(this.mode==='cutout'){
        pill.textContent = '‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏î‡∏Ñ‡∏±‡∏ó: ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏•‡πâ‡∏≠‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÄ‡∏™‡∏£‡πá‡∏à/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‚Äù';
        pill.classList.add('danger');
      }else{
        pill.textContent = '‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
        pill.classList.remove('danger');
      }
    },

    updateCutoutButtons(){
      // repurpose buttons when in cutout
      const btn = $('rcCutout');
      if(this.mode==='cutout'){
        btn.textContent = '‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏ï‡∏±‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô)';
        btn.classList.remove('danger');
        btn.classList.add('secondary');
        btn.onclick = ()=>this.finishCutout();

        // add cancel button quickly via confirm on delete? keep simple: long-press no. We'll add small confirm using toast + ESC.
        // Use rcResetTransform as "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" in cutout
        const r = $('rcResetTransform');
        r.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡∏Ñ‡∏±‡∏ó';
        r.onclick = ()=>this.exitCutoutMode();
      }else{
        btn.textContent = '‚úÇÔ∏è ‡πÑ‡∏î‡∏Ñ‡∏±‡∏ó (‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏•‡πâ‡∏≠‡∏°)';
        btn.classList.remove('secondary');
        btn.classList.add('danger');
        btn.onclick = ()=>this.enterCutoutMode();

        const r = $('rcResetTransform');
        r.textContent = '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï';
        r.onclick = ()=>{ const l=this.getSelected(); if(l){ l.scale=1; l.rot=0; } this.syncControlsFromLayer(); this.draw(); };
      }
    },

    async finishCutout(){
      const l = this.getSelected();
      if(!l || l.type!=='image') return this.exitCutoutMode();
      if(this.cutPath.length < 10) return toast('‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á)');

      // close path by connecting to start
      const path = this.cutPath.slice();
      path.push(path[0]);

      // Convert paper path -> local image coordinates
      const localPts = path.map(p=>this.paperPointToImageLocal(p, l));

      // Create mask on image native size
      const mask = document.createElement('canvas');
      mask.width = l.imgW;
      mask.height = l.imgH;
      const mctx = mask.getContext('2d');

      // draw polygon in image coords (image space origin top-left)
      mctx.clearRect(0,0,mask.width,mask.height);
      mctx.fillStyle = '#000';
      mctx.beginPath();
      const p0 = localPts[0];
      mctx.moveTo(p0.x, p0.y);
      for(let i=1;i<localPts.length;i++){
        mctx.lineTo(localPts[i].x, localPts[i].y);
      }
      mctx.closePath();
      mctx.fill();

      // Apply mask to image => output canvas
      const out = document.createElement('canvas');
      out.width = l.imgW;
      out.height = l.imgH;
      const octx = out.getContext('2d');
      octx.clearRect(0,0,out.width,out.height);

      // draw original
      octx.drawImage(l.img, 0, 0, l.imgW, l.imgH);

      // keep only where mask exists
      octx.globalCompositeOperation = 'destination-in';
      octx.drawImage(mask, 0, 0);
      octx.globalCompositeOperation = 'source-over';

      // Optional: trim transparent edges? (‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏•‡∏≤‡∏Å‡∏á‡πà‡∏≤‡∏¢)
      const trimmed = this.trimTransparent(out);
      const img = new Image();
      const url = trimmed.toDataURL('image/png');
      await new Promise((resolve,reject)=>{
        img.onload = resolve;
        img.onerror = reject;
        img.src = url;
      });

      // Replace image in layer (keep transform)
      l.img = img;
      l.imgW = img.naturalWidth;
      l.imgH = img.naturalHeight;

      // keep selection, exit cutout
      this.exitCutoutMode();
      toast('‡πÑ‡∏î‡∏Ñ‡∏±‡∏ó‡πÅ‡∏•‡πâ‡∏ß');
      this.draw();
    },

    paperPointToImageLocal(p, l){
      // paper point -> layer local (unscale/unrotate, center origin) -> image pixel coords (top-left origin)
      const dx = p.x - l.x;
      const dy = p.y - l.y;
      const cos = Math.cos(-l.rot);
      const sin = Math.sin(-l.rot);
      const rx = (dx*cos - dy*sin) / (l.scale || 1);
      const ry = (dx*sin + dy*cos) / (l.scale || 1);

      const ix = rx + (l.imgW/2);
      const iy = ry + (l.imgH/2);
      return { x: ix, y: iy };
    },

    trimTransparent(canvas){
      const ctx = canvas.getContext('2d');
      const {width:w, height:h} = canvas;
      const img = ctx.getImageData(0,0,w,h).data;

      let minX=w, minY=h, maxX=-1, maxY=-1;
      for(let y=0;y<h;y++){
        for(let x=0;x<w;x++){
          const a = img[(y*w + x)*4 + 3];
          if(a>0){
            if(x<minX) minX=x;
            if(y<minY) minY=y;
            if(x>maxX) maxX=x;
            if(y>maxY) maxY=y;
          }
        }
      }
      if(maxX<minX || maxY<minY) return canvas; // nothing

      const tw = (maxX - minX + 1);
      const th = (maxY - minY + 1);
      const out = document.createElement('canvas');
      out.width = tw;
      out.height = th;
      out.getContext('2d').drawImage(canvas, minX, minY, tw, th, 0, 0, tw, th);
      return out;
    },

    // ---------- Export ----------
    async exportAs(mode){
      const dpi = Number($('rcDpi').value || '200');
      const s = Paper.getSetting();

      const pxW = Math.round(Paper.mmToIn(s.mmW) * dpi);
      const pxH = Math.round(Paper.mmToIn(s.mmH) * dpi);

      const out = document.createElement('canvas');
      out.width = pxW;
      out.height = pxH;
      const octx = out.getContext('2d');

      // white background (‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏ô‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß)
      octx.fillStyle = '#fff';
      octx.fillRect(0,0,pxW,pxH);

      // scale from paper CSS px -> export px
      const pw = this.paperEl.clientWidth;
      const ph = this.paperEl.clientHeight;
      const rx = pxW / pw;
      const ry = pxH / ph;

      // draw all layers
      for(const l of this.layers){
        octx.save();
        octx.globalAlpha = l.opacity ?? 1;

        octx.translate(l.x * rx, l.y * ry);
        octx.rotate(l.rot || 0);

        // scale: use average to keep proportions
        const r = (rx + ry) / 2;
        octx.scale((l.scale || 1) * r, (l.scale || 1) * r);

        if(l.type==='image' && l.img){
          octx.drawImage(l.img, -l.imgW/2, -l.imgH/2, l.imgW, l.imgH);
        }

        if(l.type==='text'){
          const fontSize = (l.fontSize || 22);
          octx.font = `${l.bold ? '700':'400'} ${fontSize}px system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Thai',sans-serif`;
          octx.fillStyle = l.color || '#111827';
          octx.textBaseline = 'middle';

          const lines = String(l.text ?? '').split('\n');
          const lineH = fontSize * 1.25;

          // measure with export ctx
          const tmp = { ...l, fontSize };
          const box = this.measureTextBoxExport(octx, tmp);

          let align = l.align || 'left';
          octx.textAlign = align;

          for(let i=0;i<lines.length;i++){
            const y = (-box.h/2) + (i*lineH) + (lineH/2);
            let x = 0;
            if(align==='left') x = -box.w/2;
            if(align==='center') x = 0;
            if(align==='right') x = box.w/2;
            octx.fillText(lines[i], x, y);
          }
        }

        octx.restore();
      }

      const blob = await new Promise((resolve)=> out.toBlob(resolve, 'image/png', 1.0));
      if(!blob) return toast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

      const filename = `${s.size}_${s.ori}_${new Date().toISOString().slice(0,19).replaceAll(':','-')}.png`;
      const file = new File([blob], filename, {type:'image/png'});

      if(mode==='share'){
        try{
          if(navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share){
            await navigator.share({ files:[file], title:'Receipt', text:'‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à' });
            toast('‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß');
            return;
          }
        }catch(e){}
      }

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);

      toast(mode==='share' ? '‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏•‡∏¢‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ó‡∏ô' : '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß');
    },

    measureTextBoxExport(ctx, l){
      ctx.save();
      ctx.font = `${l.bold ? '700':'400'} ${l.fontSize || 22}px system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Thai',sans-serif`;
      const lines = String(l.text ?? '').split('\n');
      let maxW = 10;
      for(const line of lines){
        maxW = Math.max(maxW, ctx.measureText(line || ' ').width);
      }
      const lineH = (l.fontSize || 22) * 1.25;
      const h = Math.max(lineH, lines.length * lineH);
      ctx.restore();
      return { w:maxW, h };
    },
  };

  // init
  RC.init();
  RC.updateCutoutButtons();

  // load initial
  loadAll().catch(err=>{
    console.error(err);
    alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
  });
</script>
</body>
</html>
