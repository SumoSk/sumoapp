<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <title>‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå | Inventory Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #00897b;
      --primary-light: #e0f2f1;
      --primary-dark: #00695c;
      --text-main: #37474f;
      --text-light: #78909c;
      --bg-body: #f0f4f4;
      --white: #ffffff;
      --shadow-card: 0 4px 20px rgba(0,0,0,0.06);
      --radius: 16px;
      --success: #2e7d32;
      --danger: #c62828;
    }

    html { -webkit-text-size-adjust:100%; text-size-adjust:100%; box-sizing: border-box; }
    *, *:before, *:after { box-sizing: inherit; }

    body {
      font-family: 'Prompt', sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      margin: 0;
      padding: 20px;
      padding-bottom: 140px;
      font-size: 14px;
      line-height: 1.5;
    }

    h2 {
      text-align: center;
      color: var(--primary-dark);
      margin: 0 0 15px;
      font-weight: 600;
      font-size: 1.5rem;
    }

    /* --- Month Navigation --- */
    .month-nav {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }
    .nav-btn {
      background: var(--white);
      color: var(--primary);
      border: 1px solid var(--primary);
      padding: 6px 16px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 50px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .nav-btn:hover:not(:disabled) {
      background: var(--primary);
      color: var(--white);
      box-shadow: 0 4px 10px rgba(0,121,107,0.3);
    }
    .nav-btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      background: #eee;
      border-color: #ddd;
      color: #999;
    }
    .nav-btn svg { width: 16px; height: 16px; fill: currentColor; }
    
    .month-label {
        font-size: 1.1em; font-weight: 600; color: var(--primary-dark);
        min-width: 100px; text-align: center;
    }

    /* --- üìä DASHBOARD GRID LAYOUT --- */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      margin-bottom: 25px;
    }

    .dash-cat-card {
      background: var(--white);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.03);
    }

    .dash-cat-title {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 12px;
      font-size: 1.1em;
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 6px;
      display: flex; justify-content: space-between;
    }
    .dash-date-hint { font-size: 0.7em; color: #999; font-weight: 400; align-self: flex-end; }

    .dash-item-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px dashed #eee;
    }
    .dash-item-row:last-child { border-bottom: none; }

    .dash-name {
      font-weight: 500;
      color: #444;
      flex: 1;
      padding-right: 10px;
    }
    
    .dash-stats {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .dash-curr {
      font-weight: 700;
      font-size: 1.1em;
      color: var(--primary-dark);
      min-width: 40px;
      text-align: right;
    }
    .dash-trend {
      font-size: 0.85em;
      min-width: 50px;
      text-align: right;
    }

    .t-up { color: var(--success); }
    .t-down { color: var(--danger); }
    .t-flat { color: #ccc; }


    /* --- Table Styles --- */
    .table-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow-card);
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.02);
    }
    .table-wrapper { overflow-x: auto; width: 100%; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
    th {
      background: var(--primary);
      color: var(--white);
      font-weight: 500;
      white-space: nowrap;
      position: sticky; top: 0; z-index: 10;
    }
    th input[type="date"] {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.4);
      color: #fff;
      padding: 4px 8px;
      border-radius: 6px;
      font-family: inherit;
      cursor: pointer;
    }
    th input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

    td.name { text-align: left; font-weight: 500; color: var(--primary-dark); min-width: 150px; }
    
    tr.category-header { background: var(--primary-light); text-align: left; }
    tr.category-header td {
      font-weight: 600; color: var(--primary-dark);
      padding: 8px 15px; font-size: 1em; text-transform: uppercase;
      letter-spacing: 0.5px; border-top: 2px solid #fff;
    }

    td input[type="number"] {
      width: 70px; text-align: center; padding: 6px;
      border: 1px solid #ddd; border-radius: 8px;
      font-size: 14px; background: #fafafa;
    }
    td input[type="number"]:focus { outline: none; border-color: var(--primary); background: #fff; }

    .btn-single {
      background: var(--primary-light); color: var(--primary-dark);
      border: none; padding: 6px 12px; border-radius: 6px;
      font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .btn-single:hover { background: var(--primary); color: #fff; }

    /* Logic ‡∏™‡∏µ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    .latest-cell { position: relative; }
    .latest-val { font-weight: 700; font-size: 1.1em; color: #333; }
    .latest-val.val-low { color: var(--danger); }
    .diff-badge {
      display: inline-block; font-size: 0.8em; margin-left: 4px;
      padding: 1px 5px; border-radius: 4px; font-weight: 500;
    }
    .diff-up { color: var(--success); background: #e8f5e9; }
    .diff-down { color: var(--danger); background: #ffebee; }
    .diff-flat { color: #9aa0a6; background: #f1f3f4; }

    /* --- Action Bar --- */
    .btn-bar { margin-top: 25px; display: flex; justify-content: center; gap: 16px; }
    .action-btn {
      border: none; padding: 12px 24px; font-size: 15px; font-weight: 600;
      border-radius: 50px; cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; gap: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #btnAdd { background: #fff; color: var(--primary); border: 1px solid var(--primary); }
    #btnAdd:hover { background: #f0fdfc; transform: translateY(-2px); }
    #btnSaveAll { background: linear-gradient(135deg, #00897b, #004d40); color: #fff; }
    #btnSaveAll:hover { box-shadow: 0 6px 15px rgba(0,137,123,0.4); transform: translateY(-2px); }

    /* --- Popup & Menu --- */
    #popupForm {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
      display: none; justify-content: center; align-items: center; z-index: 9999;
    }
    .form-box {
      background: #fff; padding: 25px; border-radius: 20px;
      width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    }
    .form-box h3 { text-align: center; color: var(--primary); margin-bottom: 15px; }
    .form-box input { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; }
    .popup-actions { display: flex; gap: 10px; margin-top: 10px; }
    .popup-actions button { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .submit-btn { background: var(--primary); color: #fff; }
    .cancel-btn { background: #f5f5f5; color: #666; }

    

  </style>
</head>
<body>
<!-- ‚úÖ floating menu -->
{% include 'floating_menu.html' %}
  <h2>üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</h2>

  <div class="month-nav">
    <button class="nav-btn" id="btnPrev" type="button">
      <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
      ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    </button>
    <div class="month-label" id="monthLabel">loading...</div>
    <button class="nav-btn" id="btnNext" type="button">
      ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
      <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
    </button>
  </div>

  <div id="dashboardGrid" class="dashboard-grid">
     </div>

  <div class="table-card">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr id="tableHeader"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <div class="btn-bar">
    <button class="action-btn" id="btnAdd" type="button">
      <span style="font-size:1.2em">Ôºã</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    </button>
    <button class="action-btn" id="btnSaveAll" type="button">
      <span style="font-size:1.2em">üíæ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    </button>
  </div>

  <div id="popupForm">
    <div class="form-box">
      <h3>‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÉ‡∏´‡∏°‡πà</h3>
      <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</label>
      <input type="text" id="newName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Syringe 20ml" />
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
      <input type="number" id="newQty" min="0" placeholder="0" inputmode="numeric" />
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö</label>
      <input type="date" id="newDate" />
      <div class="popup-actions">
        <button class="cancel-btn" id="popupCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="submit-btn" id="popupSubmit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    
    // ===== 1. CATEGORIES (UPDATED) =====
    // ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á "B12" ‡πÅ‡∏•‡∏∞ "b12" ‡πÅ‡∏•‡∏∞ "‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏¥‡∏ß" ‡∏ó‡∏±‡πâ‡∏á‡∏°‡∏µ/‡πÑ‡∏°‡πà‡∏°‡∏µ #‡πÄ‡∏Ç‡πá‡∏°
    const categories = {
      "üíâ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏â‡∏µ‡∏î/‡πÄ‡∏à‡∏≤‡∏∞": [
        "Syringe 10","Syringe 5","Syringe 3","Syringe 1",
        "‡πÄ‡∏Ç‡πá‡∏° 32","‡πÄ‡∏Ç‡πá‡∏° 30","‡πÄ‡∏Ç‡πá‡∏° 24","‡πÄ‡∏Ç‡πá‡∏° 18Gx1","‡πÄ‡∏Ç‡πá‡∏° 18Gx1 1/2",
        "Cannula","Medicut","‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠ 24","‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠ 25","Set IV","‡∏´‡∏•‡∏≠‡∏î PRR"
      ],
      "üíß ‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠ / ‡∏¢‡∏≤ / ‡∏™‡∏Å‡∏¥‡∏ô‡πÅ‡∏Ñ‡∏£‡πå": [
        "Nss 1000 ML","Nss 100 ML","Nss 5 ML","SWI 5 ML","Milky","B100","‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏ã‡∏µ","‡∏ä‡∏≤‡πÅ‡∏ô‡∏• #‡πÄ‡∏Ç‡πá‡∏°","‡∏¢‡∏≤‡∏ô‡∏µ‡∏î‡∏â‡∏µ‡∏î‡∏™‡∏¥‡∏ß #‡πÄ‡∏Ç‡πá‡∏°","‡∏ó‡∏£‡∏≤‡∏ô‡∏™‡∏°‡∏¥‡∏ô #‡πÄ‡∏Ç‡πá‡∏°","‡πÄ‡∏°‡πÇ‡∏™‡∏ß‡∏¥‡πâ‡∏á",
        // ‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏î‡∏±‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå)
        "b12", "B12", "B 12", 
        "‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏¥‡∏ß", "‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏¥‡∏ß #‡πÄ‡∏Ç‡πá‡∏°", "‡∏≠‡∏™‡∏¥‡∏ï‡∏¥‡∏ô",
        // ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡∏≤‡∏ó‡∏≤
        "‡∏¢‡∏≤‡∏ä‡∏≤ (‡∏Ñ‡∏£‡∏µ‡∏°)","‡∏¢‡∏≤‡∏ó‡∏≤‡∏ù‡πâ‡∏≤","‡∏¢‡∏≤‡∏ó‡∏≤‡∏™‡∏¥‡∏ß","‡∏≠‡∏∞‡πÇ‡∏•‡πÄ‡∏à‡∏•","Scrub","‡∏ó‡∏£‡∏≤‡∏ô‡∏™‡∏°‡∏¥‡∏ô"
      ],
      "üß§ ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á": [
        "‡∏ñ‡∏∏‡∏á‡∏°‡∏∑‡∏≠ S","‡∏™‡∏≥‡∏•‡∏µ‡∏Å‡πâ‡∏≠‡∏ô","‡∏™‡∏≥‡∏•‡∏µ‡πÅ‡∏ú‡πà‡∏ô","Swabs","‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå","‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡∏û‡∏≠‡∏£‡πå ‡πÄ‡∏ó‡∏õ‡∏Ç‡∏∏‡πà‡∏ô IV"
      ]
    };

    const fixedItemList = Object.values(categories).flat();
    
    // Variables
    let allData = [];
    let allDates = [];
    let uniqueMonths = [];
    let currentMonthIdx = 0;
    let groupedData = {};

    // Helpers
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const escapeHtml = s => String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
    
    const todayIso = () => {
        const d = new Date();
        const offset = d.getTimezoneOffset() * 60000;
        return (new Date(d - offset)).toISOString().slice(0, 10);
    };

    const monthOf = d => d.slice(0,7); 

    function formatDateTH(dateStr){
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString('th-TH', { day:'2-digit', month:'2-digit', year:'2-digit' });
    }
    
    function formatMonthYearTH(ym) {
        if(!ym) return "";
        const [y, m] = ym.split('-');
        const thMonths = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
        return `${thMonths[parseInt(m)-1]} ${parseInt(y)+543}`;
    }

    function buildGrouped(){
      groupedData = {};
      for (const row of allData) {
        (groupedData[row.item_name] ??= {})[row.date] = Number(row.quantity||0);
      }
    }

    function computeCalendars(){
      const dateSet = new Set(allData.map(d => d.date));
      allDates = Array.from(dateSet).sort((a,b) => new Date(b) - new Date(a));
      const monthSet = new Set(allDates.map(d => monthOf(d)));
      uniqueMonths = Array.from(monthSet).sort((a,b) => a < b ? 1 : (a > b ? -1 : 0));
      if (uniqueMonths.length === 0) uniqueMonths = [todayIso().slice(0,7)];
      currentMonthIdx = 0;
    }

    function getSelectedMonth(){ return uniqueMonths[currentMonthIdx]; }
    function getFilteredDates(){
      const ym = getSelectedMonth();
      const dates = allDates.filter(d => d.startsWith(ym)).sort();
      return dates.slice(-3); // Show last 3 days
    }
    function defaultInputDateForMonth(){
      const ym = getSelectedMonth();
      const dates = allDates.filter(d => d.startsWith(ym)).sort();
      if (dates.length) return dates[dates.length - 1];
      return todayIso();
    }
    function lowThresholdFor(name){
      if(name.includes("Syringe")) return 20;
      if(name.includes("‡πÄ‡∏Ç‡πá‡∏°")) return 20;
      if(name.includes("Nss")) return 5;
      return 10;
    }

    // ===== üìä DASHBOARD GRID RENDER (LATEST DAY) =====
    function renderDashboard() {
        const grid = $('#dashboardGrid');
        if(!grid) return;
        grid.innerHTML = ''; // Clear

        // Get Latest date in current view (Rightmost column)
        const filteredDates = getFilteredDates();
        if (filteredDates.length === 0) {
             grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#aaa;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
             return;
        }
        
        const latestDate = filteredDates[filteredDates.length - 1];
        // Find previous date (for comparison)
        const prevDate = filteredDates.length >= 2 ? filteredDates[filteredDates.length - 2] : null;

        const displayDateTH = formatDateTH(latestDate);

        // Prepare Display Map (Combine Categories + Others)
        const allKnownItems = new Set(fixedItemList);
        const dataItems = new Set(Object.keys(groupedData));
        const uncategorized = Array.from(dataItems).filter(x => !allKnownItems.has(x)).sort();
        
        const displayMap = { ...categories };
        if(uncategorized.length > 0) displayMap["üì¶ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Others)"] = uncategorized;

        // Render Cards
        let hasContent = false;

        Object.entries(displayMap).forEach(([catName, items]) => {
            // Filter items that have usage > 0 in latest or prev date
            const activeItems = items.filter(name => {
                // Show if it has data today OR it is a fixed item
                return groupedData[name] !== undefined; 
            });

            if(activeItems.length === 0) return;
            hasContent = true;

            const card = document.createElement('div');
            card.className = 'dash-cat-card';
            
            let itemRowsHtml = '';
            activeItems.forEach(name => {
                const curr = Number((groupedData[name]?.[latestDate] ?? 0).toFixed(2));
                const prev = Number((groupedData[name]?.[prevDate] ?? 0).toFixed(2));
                const diff = Number((curr - prev).toFixed(2));
                
                let trendHtml = `<span class="dash-trend t-flat">-</span>`;
                if(prevDate) {
                    if(diff > 0) trendHtml = `<span class="dash-trend t-up">‚ñ≤${diff}</span>`;
                    else if(diff < 0) trendHtml = `<span class="dash-trend t-down">‚ñº${Math.abs(diff)}</span>`;
                    else trendHtml = `<span class="dash-trend t-flat">0</span>`;
                }

                // Show only if value exists or fixed item
                itemRowsHtml += `
                    <div class="dash-item-row">
                        <div class="dash-name">${escapeHtml(name)}</div>
                        <div class="dash-stats">
                            <span class="dash-curr">${curr.toLocaleString()}</span>
                            ${trendHtml}
                        </div>
                    </div>
                `;
            });

            card.innerHTML = `
                <div class="dash-cat-title">
                    ${escapeHtml(catName)}
                    <span class="dash-date-hint">${displayDateTH}</span>
                </div>
                ${itemRowsHtml}
            `;
            grid.appendChild(card);
        });

        if(!hasContent) {
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#aaa; padding:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>';
        }
    }

    // ===== Fetch =====
    async function fetchData(){
      try{
        // One-time fetch (Backend handles full data)
        const res = await fetch('/api/inventory');
        if (!res.ok) throw new Error('Network err');
        const rawData = await res.json();

        allData = (Array.isArray(rawData) ? rawData : []).map(r => {
            let dStr = r.date ? String(r.date) : todayIso();
            if (dStr.includes('T')) dStr = dStr.split('T')[0];
            return { item_name: (r.item_name||'').trim(), date: dStr.substring(0, 10), quantity: Number(r.quantity ?? 0) };
        });
      }catch(e){ console.error(e); allData = []; }
      
      computeCalendars();
      buildGrouped();
      renderTable(); // Render Table first to get dates
      renderDashboard(); // Render Grid Dashboard using dates from table logic
      updateNavButtons();
    }

    // ===== Render Table =====
    function renderTable(){
      const headerRow = $('#tableHeader');
      const tbody = $('#tableBody');
      const label = $('#monthLabel');
      
      if(label) label.textContent = formatMonthYearTH(getSelectedMonth());

      if (!headerRow || !tbody) return;
      const filteredDates = getFilteredDates();
      const inputDateDefault = defaultInputDateForMonth();

      headerRow.innerHTML =
        `<th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>` +
        filteredDates.map(d => `<th>${formatDateTH(d)}</th>`).join('') +
        `<th><input type="date" id="inputDate" value="${inputDateDefault}"></th>
         <th style="width:80px">Action</th>`;

      tbody.innerHTML = '';
      const allKnownItems = new Set(fixedItemList);
      const dataItems = new Set(Object.keys(groupedData));
      const uncategorized = Array.from(dataItems).filter(x => !allKnownItems.has(x)).sort();
      const displayMap = { ...categories };
      if(uncategorized.length > 0) displayMap["üì¶ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Others)"] = uncategorized;

      Object.entries(displayMap).forEach(([catName, items]) => {
          const validItems = items.filter(name => fixedItemList.includes(name) || groupedData[name]);
          if(validItems.length === 0) return;

          const catTr = document.createElement('tr');
          catTr.className = 'category-header';
          catTr.innerHTML = `<td colspan="${filteredDates.length + 3}">${escapeHtml(catName)}</td>`;
          tbody.appendChild(catTr);

          validItems.forEach((name) => {
              const vals = filteredDates.map(d => groupedData[name]?.[d]);
              const cells = [];
              for (let i=0; i<filteredDates.length; i++){
                  const v = vals[i];
                  const isLatest = (i === filteredDates.length - 1);
                  if (!isLatest){
                      cells.push(`<td>${Number.isFinite(v) ? v : '-'}</td>`);
                  } else {
                      const prev = vals.length >= 2 ? vals[filteredDates.length - 2] : undefined;
                      let diffHtml = `<span class="diff-badge diff-flat">-</span>`;
                      if (Number.isFinite(v) && Number.isFinite(prev)){
                          const diff = Number((v - prev).toFixed(2));
                          if(diff > 0) diffHtml = `<span class="diff-badge diff-up">‚ñ≤${diff}</span>`;
                          else if(diff < 0) diffHtml = `<span class="diff-badge diff-down">‚ñº${Math.abs(diff)}</span>`;
                          else diffHtml = `<span class="diff-badge diff-flat">0</span>`;
                      }
                      const thr = lowThresholdFor(name);
                      const isLow = (Number.isFinite(v) && v < thr);
                      const valClass = isLow ? 'val-low' : '';
                      const vText = Number.isFinite(v) ? v : '-';
                      cells.push(`<td class="latest-cell"><span class="latest-val ${valClass}">${vText}</span>${diffHtml}</td>`);
                  }
              }
              const tr = document.createElement('tr');
              tr.innerHTML = `<td class="name">${escapeHtml(name)}</td>` + cells.join('') +
                  `<td><input type="number" min="0" step="1" inputmode="numeric" data-item="${escapeHtml(name)}"></td>` +
                  `<td><button class="btn-single" type="button" data-item="${escapeHtml(name)}">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></td>`;
              tbody.appendChild(tr);
          });
      });
    }

    function updateNavButtons(){
      const prev = $('#btnPrev'), next = $('#btnNext');
      if (prev) prev.disabled = currentMonthIdx >= (uniqueMonths.length - 1);
      if (next) next.disabled = currentMonthIdx <= 0;
    }

    // ===== Save & Events =====
    function isDuplicateEntry(itemName, date, qty){
       return allData.some(entry => entry.item_name === itemName && entry.date === date && Number(entry.quantity) === Number(qty));
    }
    async function saveData(payload){
      try{
        const res = await fetch('/api/save_inventory', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        if(!res.ok) throw new Error('bad status');
        await res.json();
        const btn = $('#btnSaveAll'); const oldText = btn.innerHTML;
        btn.innerHTML = '‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'; btn.style.background = '#43a047';
        setTimeout(() => { btn.innerHTML = oldText; btn.style.background = ''; }, 2000);
        await fetchData();
      }catch(e){ alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
    }

    $('#tableBody')?.addEventListener('click', (e) => {
      const btn = e.target.closest('.btn-single');
      if (!btn) return;
      const itemName = btn.dataset.item;
      const tr = btn.closest('tr');
      const inputEl = tr ? tr.querySelector('input[type="number"]') : null;
      const inputDate = $('#inputDate')?.value || '';
      const qtyStr = inputEl?.value?.trim();
      if (!inputDate || !qtyStr){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
      const nQty = Number(qtyStr);
      if (Number.isNaN(nQty) || nQty < 0){ alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
      if (isDuplicateEntry(itemName, inputDate, nQty)){ if(!confirm(`‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡πâ‡∏≥?`)) return; }
      saveData([{ item_name:itemName, date:inputDate, quantity:nQty }]);
      inputEl.value = '';
    });

    $('#btnSaveAll')?.addEventListener('click', () => {
      const inputDate = $('#inputDate')?.value || '';
      if (!inputDate){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'); return; }
      const payload = []; const duplicateList = [];
      $$('#tableBody input[type="number"]').forEach(input => {
        const val = input.value.trim(); if (val === '') return;
        const name = input.dataset.item; const qty = Number(val);
        if (Number.isNaN(qty) || qty < 0) return;
        if (isDuplicateEntry(name, inputDate, qty)) duplicateList.push(name);
        else payload.push({ item_name:name, date:inputDate, quantity:qty });
      });
      if (duplicateList.length){ if(!confirm(`‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥ ${duplicateList.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return; }
      if (!payload.length && !duplicateList.length){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà'); return; }
      if(payload.length) saveData(payload);
    });

    const popup = $('#popupForm');
    $('#btnAdd')?.addEventListener('click', () => {
       $('#newName').value = ''; $('#newQty').value = ''; $('#newDate').value = $('#inputDate')?.value || todayIso();
       popup.style.display = 'flex'; setTimeout(() => $('#newName').focus(), 50);
    });
    const hidePopup = () => popup.style.display = 'none';
    $('#popupCancel')?.addEventListener('click', hidePopup);
    popup.addEventListener('click', e => { if(e.target === popup) hidePopup(); });
    $('#popupSubmit')?.addEventListener('click', () => {
       const name = $('#newName').value.trim(); const qty = Number($('#newQty').value); const date = $('#newDate').value;
       if(!name || !date || qty < 0) { alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö'); return; }
       saveData([{ item_name:name, date, quantity:qty }]); hidePopup();
    });

    $('#btnPrev')?.addEventListener('click', () => {
      if(currentMonthIdx < uniqueMonths.length - 1){ currentMonthIdx++; renderTable(); renderDashboard(); updateNavButtons(); }
    });
    $('#btnNext')?.addEventListener('click', () => {
      if(currentMonthIdx > 0){ currentMonthIdx--; renderTable(); renderDashboard(); updateNavButtons(); }
    });

    

    fetchData();
  });
  </script>
</body>
</html>