<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <title>‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</title>

  <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå: ‡πÇ‡∏´‡∏•‡∏î‡∏ô‡∏¥‡πà‡∏á ‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡πâ‡∏á -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">

  <style>
    html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }
    body{
      font-family:'Prompt',sans-serif;
      background:#f4f4f4;
      padding:20px; padding-bottom:120px;
      font-size:13px; line-height:1.45;
      margin:0;
    }
    h2{ text-align:center; color:#00695c; margin:0 0 14px; }

    /* Month nav */
    .month-nav{
      display:flex; justify-content:center; gap:10px; margin-bottom:16px; flex-wrap:wrap;
    }
    .nav-btn{
      background:#009688; color:#fff; border:none;
      padding:8px 16px; font-size:15px; border-radius:8px;
      display:flex; align-items:center; gap:8px; cursor:pointer;
      transition:background .2s ease;
    }
    .nav-btn:hover{ background:#00796b; }
    .nav-btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .nav-btn svg{ width:20px; height:20px; fill:currentColor; }

    /* Table */
    table{ border-collapse:collapse; width:100%; background:#fff; box-shadow:0 0 10px rgba(0,0,0,.05); }
    th,td{ border:1px solid #ccc; padding:6px 8px; text-align:center; }
    th{
      background:#e0f2f1; color:#00695c; position:sticky; top:0; z-index:1;
    }
    td.name{ font-weight:600; text-align:left; }
    td input[type="number"]{
      width:90px; min-width:70px; box-sizing:border-box;
      padding:4px; font-size:14px; text-align:center;
    }

    /* ‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î + diff ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
    .latest-cell .latest-val{ font-weight:600; }
    .latest-cell .val-low{ color:#c62828; }           /* ‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå ‚Üí ‡πÅ‡∏î‡∏á */
    .latest-cell .diff-up{ color:#2e7d32; font-weight:600; }   /* ‚ñ≤ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ‚Üí ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
    .latest-cell .diff-down{ color:#c62828; font-weight:600; } /* ‚ñº ‡∏•‡∏î‡∏•‡∏á ‚Üí ‡πÅ‡∏î‡∏á */
    .latest-cell .diff-flat{ color:#555; }                      /* (0) ‡∏´‡∏£‡∏∑‡∏≠ (‚Äî) ‚Üí ‡πÄ‡∏ó‡∏≤ */
    .latest-cell .sep{ display:inline-block; width:4px; }       /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡∏≠‡∏∂‡∏î‡∏≠‡∏±‡∏î */

    .btn-bar{ margin-top:20px; text-align:center; }
    .btn-bar .action-btn{
      padding:10px 20px; font-size:15px; border:none; border-radius:8px;
      cursor:pointer; background:#00796b; color:#fff; margin:0 10px;
      transition:background .2s ease;
    }
    .btn-bar .action-btn:hover{ background:#004d40; }

    /* Popup (Add Item) */
    #popupForm{
      position:fixed; inset:0; background:rgba(0,0,0,.5);
      display:none; justify-content:center; align-items:center; z-index:9999;
    }
    #popupForm .form-box{
      background:#fff; padding:20px 30px; border-radius:12px;
      max-width:400px; width:100%; box-shadow:0 8px 30px rgba(0,0,0,.2); position:relative;
    }
    #popupForm h3{ margin:0 0 10px; color:#00695c; text-align:center; }
    #popupForm label{ display:block; margin:10px 0 4px; font-weight:600; }
    #popupForm input{ width:100%; padding:8px; font-size:15px; border-radius:6px; border:1px solid #ccc; }
    #popupForm .popup-actions{ display:flex; justify-content:space-between; margin-top:18px; gap:10px; }
    #popupForm button{ padding:8px 16px; font-size:15px; border:none; border-radius:6px; cursor:pointer; }
    .submit-btn{ background:#00796b; color:#fff; }
    .cancel-btn{ background:#ccc; color:#000; }

    /* Single save btn in table */
    .btn-single{
      padding:6px 12px; font-size:14px; background:#009688; color:#fff;
      border:none; border-radius:8px; cursor:pointer; transition:background .2s ease;
    }
    .btn-single:hover{ background:#00796b; }

    /* Floating menu */
    .floating-toggle{
      position:fixed; bottom:18px; left:50%; transform:translateX(-50%);
      background:rgba(0,128,128,0); width:58px; height:58px; border-radius:50%;
      box-shadow:0 4px 16px rgba(0,0,0,.1);
      display:flex; justify-content:center; align-items:center;
      z-index:1000; cursor:pointer;
    }
    .floating-toggle img{ width:60px; height:60px; }
    .floating-menu{
      position:fixed; bottom:90px; left:50%; transform:translateX(-50%);
      background:#fff; border-radius:16px; padding:10px; display:none;
      flex-direction:column; align-items:center; gap:10px; box-shadow:0 6px 20px rgba(0,0,0,.2);
      z-index:999; max-height:60vh; overflow-y:auto;
    }
    .floating-menu a img{ width:52px; height:52px; }
  </style>
</head>
<body>

  <h2>‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</h2>

  <!-- Month Nav (SVG icons: ‡πÑ‡∏°‡πà‡∏û‡∏∂‡πà‡∏á‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å) -->
  <div class="month-nav">
    <button class="nav-btn" id="btnPrev" type="button" aria-label="‡∏î‡∏π‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
      ‡∏î‡∏π‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    </button>
    <button class="nav-btn" id="btnNext" type="button" aria-label="‡∏î‡∏π‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">
      ‡∏î‡∏π‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
    </button>
  </div>

  <table>
    <thead>
      <tr id="tableHeader"></tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div class="btn-bar">
    <button class="action-btn" id="btnAdd" type="button">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÉ‡∏´‡∏°‡πà</button>
    <button class="action-btn" id="btnSaveAll" type="button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>

  <!-- Popup Form -->
  <div id="popupForm" role="dialog" aria-modal="true" aria-labelledby="addTitle">
    <div class="form-box" id="popupBox">
      <h3 id="addTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÉ‡∏´‡∏°‡πà</h3>
      <label for="newName">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</label>
      <input type="text" id="newName" />
      <label for="newQty">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
      <input type="number" id="newQty" min="0" step="1" inputmode="numeric" />
      <label for="newDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" id="newDate" />
      <div class="popup-actions">
        <button class="submit-btn" id="popupSubmit" type="button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="cancel-btn" id="popupCancel" type="button">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- Floating menu -->
  <div id="floatingToggle" class="floating-toggle">
    <img src="{{ url_for('static', filename='icon/icon_menu_toggle.png') }}" alt="menu">
  </div>
  <div id="floatingMenu" class="floating-menu">
  <a href="{{ url_for('dashboard') }}"><img src="{{ url_for('static', filename='icon/icon_dashboard.png') }}"></a>
  <a href="{{ url_for('sale_summary') }}"><img src="{{ url_for('static', filename='icon/icon_sale_summary.png') }}"></a>
  <a href="{{ url_for('crm') }}"><img src="{{ url_for('static', filename='icon/icon_crm.png') }}"></a>
  <a href="{{ url_for('record_sales') }}"><img src="{{ url_for('static', filename='icon/icon_record_sales.png') }}"></a>
  <a href="{{ url_for('customer_list') }}"><img src="{{ url_for('static', filename='icon/icon_customer_list.png') }}"></a>
  <a href="{{ url_for('record_customer') }}"><img src="{{ url_for('static', filename='icon/icon_customer_history.png') }}"></a>
  <a href="{{ url_for('oldsaledata') }}"><img src="{{ url_for('static', filename='icon/icon_old_customers.png') }}"></a>
  <a href="{{ url_for('inventory') }}"><img src="{{ url_for('static', filename='icon/icon_inventory.png') }}"></a>
  <a href="#"><img src="{{ url_for('static', filename='icon/icon_staff.png') }}"></a>
  <a href="{{ url_for('appointments') }}"><img src="{{ url_for('static', filename='icon/icon_appointments.png') }}"></a>
</div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ===== Fixed list & State =====
    const fixedItemList = [
      "Syringe 10","Syringe 5","Syringe 3","Syringe 1",
      "‡πÄ‡∏Ç‡πá‡∏° 32","‡πÄ‡∏Ç‡πá‡∏° 30","‡πÄ‡∏Ç‡πá‡∏° 24","‡πÄ‡∏Ç‡πá‡∏° 18Gx1","‡πÄ‡∏Ç‡πá‡∏° 18Gx1 1/2",
      "Cannula","Medicut","‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠ 24","‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠ 25","Set IV","‡∏´‡∏•‡∏≠‡∏î PRR",
      "Nss 1000 ML","Nss 100 ML","Nss 5 ML","SWI 5 ML","‡∏ñ‡∏∏‡∏á‡∏°‡∏∑‡∏≠ S",
      "‡∏™‡∏≥‡∏•‡∏µ‡∏Å‡πâ‡∏≠‡∏ô","‡∏™‡∏≥‡∏•‡∏µ‡πÅ‡∏ú‡πà‡∏ô","‡∏¢‡∏≤‡∏ä‡∏≤ (‡∏Ñ‡∏£‡∏µ‡∏°)","Swabs","‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå",
      "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ù‡πâ‡∏≤","‡∏¢‡∏≤‡∏ó‡∏≤‡∏™‡∏¥‡∏ß","‡∏≠‡∏∞‡πÇ‡∏•‡πÄ‡∏à‡∏•","Scrub","Milky"
    ];

    let sortedItemList = [...fixedItemList];
    let allData = [];          // [{ item_name, date, quantity }]
    let allDates = [];         // unique dates (YYYY-MM-DD) desc
    let uniqueMonths = [];     // ['YYYY-MM'] desc
    let currentMonthIdx = 0;   // index in uniqueMonths
    let groupedData = {};      // { item_name: { 'YYYY-MM-DD': qty } }

    // ===== Helpers =====
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const escapeHtml = s => String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
    const todayIso = () => new Date().toISOString().slice(0,10);
    const monthOf = d => d.slice(0,7); // 'YYYY-MM'

    function formatDateTH(dateStr){
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString('th-TH', { day:'2-digit', month:'2-digit', year:'2-digit' });
    }

    function buildGrouped(){
      groupedData = {};
      for (const row of allData) {
        (groupedData[row.item_name] ??= {})[row.date] = Number(row.quantity||0);
      }
    }

    function extendWithNewItems(){
      const allItems = new Set(allData.map(d => d.item_name));
      const extra = Array.from(allItems).filter(n => !fixedItemList.includes(n));
      extra.sort((a,b) => a.localeCompare(b, 'th'));
      sortedItemList = [...fixedItemList, ...extra];
    }

    function computeCalendars(){
      const dateSet = new Set(allData.map(d => d.date));
      allDates = Array.from(dateSet).sort((a,b) => new Date(b) - new Date(a));

      const monthSet = new Set(allDates.map(d => monthOf(d)));
      uniqueMonths = Array.from(monthSet).sort((a,b) => a < b ? 1 : (a > b ? -1 : 0)); // desc

      if (uniqueMonths.length === 0) {
        const t = todayIso().slice(0,7);
        uniqueMonths = [t];
      }
      currentMonthIdx = 0; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠
    }

    function getSelectedMonth(){ return uniqueMonths[currentMonthIdx]; }
    function getFilteredDates(){
      const ym = getSelectedMonth();
      const dates = allDates.filter(d => d.startsWith(ym)).sort(); // asc
      return dates.slice(-3); // 3 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡πâ‡∏ô (‡∏ã‡πâ‡∏≤‡∏¢->‡∏Ç‡∏ß‡∏≤)
    }

    function defaultInputDateForMonth(){
      const ym = getSelectedMonth();
      const dates = allDates.filter(d => d.startsWith(ym)).sort();
      if (dates.length) return dates[dates.length - 1]; // ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      return ym + '-01';
    }

    // ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏Ç‡∏≠‡∏á "‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î" ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß (1-based)
    function lowThresholdForIndex(idx1){
      if (idx1>=1 && idx1<=10) return 30;
      if (idx1>=11 && idx1<=14) return 10;
      if (idx1===18) return 10;
      if (idx1===20) return 2;
      return null;
    }

    // ===== Fetch & Init =====
    async function fetchData(){
      try{
        const res = await fetch('/api/inventory', { headers:{ 'Accept':'application/json' }});
        if (!res.ok) throw new Error('bad status');
        allData = await res.json();
        // normalize
        allData = (Array.isArray(allData) ? allData : []).map(r => ({
          item_name: r.item_name ?? '',
          date: r.date ?? todayIso(),
          quantity: Number(r.quantity ?? 0)
        }));
      }catch(e){
        allData = [];
      }
      computeCalendars();
      buildGrouped();
      extendWithNewItems();
      renderTable();
      updateNavButtons();
    }

    // ===== Rendering =====
    function renderTable(){
      const headerRow = $('#tableHeader');
      const tbody = $('#tableBody');
      if (!headerRow || !tbody) return;

      const filteredDates = getFilteredDates();
      const inputDateDefault = defaultInputDateForMonth();

      headerRow.innerHTML =
        `<th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</th>` +
        filteredDates.map(d => `<th>${formatDateTH(d)}</th>`).join('') +
        `<th><input type="date" id="inputDate" value="${inputDateDefault}"></th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>`;

      tbody.innerHTML = '';
      sortedItemList.forEach((name, idx) => {
        const vals = filteredDates.map(d => groupedData[name]?.[d]);
        const cells = [];

        // ‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        for (let i=0;i<filteredDates.length;i++){
          const v = vals[i];
          const isLatest = (i === filteredDates.length - 1);
          if (!isLatest){
            cells.push(`<td>${Number.isFinite(v) ? v : '-'}</td>`);
          } else {
            // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤ + diff (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
            const prev = vals.length>=2 ? vals[filteredDates.length - 2] : undefined;
            let diffHtml = `<span class="diff-flat">(‚Äî)</span>`;
            if (Number.isFinite(v) && Number.isFinite(prev)){
              const diff = v - prev;
              diffHtml =
                diff > 0 ? `<span class="diff-up">(‚ñ≤ ${diff})</span>` :
                diff < 0 ? `<span class="diff-down">(‚ñº ${Math.abs(diff)})</span>` :
                           `<span class="diff-flat">(0)</span>`;
            } else if (Number.isFinite(v) && !Number.isFinite(prev)){
              // ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
              diffHtml = `<span class="diff-flat">(‚Äî)</span>`;
            }

            // ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏Ç‡∏≠‡∏á "‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î" ‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß
            const idx1 = idx + 1;
            const thr = lowThresholdForIndex(idx1);
            const valClass = (Number.isFinite(v) && thr !== null && v < thr) ? 'val-low' : '';
            const vText = Number.isFinite(v) ? v : '-';

            cells.push(
              `<td class="latest-cell"><span class="latest-val ${valClass}">${vText}</span><span class="sep"></span>${diffHtml}</td>`
            );
          }
        }

        const tr = document.createElement('tr');
        tr.innerHTML =
          `<td>${idx+1}</td>` +
          `<td class="name">${escapeHtml(name)}</td>` +
          cells.join('') +
          `<td><input type="number" min="0" step="1" inputmode="numeric" data-item="${escapeHtml(name)}"></td>` +
          `<td><button class="btn-single" type="button" data-item="${escapeHtml(name)}">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function updateNavButtons(){
      const prev = $('#btnPrev'), next = $('#btnNext');
      // ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å uniqueMonths (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà->‡πÄ‡∏Å‡πà‡∏≤)
      if (prev) prev.disabled = currentMonthIdx >= (uniqueMonths.length - 1);
      if (next) next.disabled = currentMonthIdx <= 0;
    }

    // ===== Save logic =====
    function isDuplicateEntry(itemName, date, qty){
      return allData.some(entry => entry.item_name === itemName && entry.date === date && Number(entry.quantity) === Number(qty));
    }

    async function saveData(payload){
      try{
        const res = await fetch('/api/save_inventory', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('bad status');
        await res.json();
        alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        await fetchData(); // refresh table + state
      }catch(e){
        alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
      }
    }

    // ===== Events =====
    // Month nav
    $('#btnPrev')?.addEventListener('click', () => {
      if (currentMonthIdx < uniqueMonths.length - 1){
        currentMonthIdx++;
        renderTable();
        updateNavButtons();
      }
    });
    $('#btnNext')?.addEventListener('click', () => {
      if (currentMonthIdx > 0){
        currentMonthIdx--;
        renderTable();
        updateNavButtons();
      }
    });

    // Single row save (event delegation)
    $('#tableBody')?.addEventListener('click', (e) => {
      const btn = e.target.closest('.btn-single');
      if (!btn) return;
      const itemName = btn.dataset.item;
      const inputDateEl = $('#inputDate');
      const inputEl = $('#tableBody').querySelector(`input[data-item="${CSS.escape(itemName)}"]`);
      const inputDate = inputDateEl?.value || '';
      const qtyStr = inputEl?.value?.trim();

      if (!inputDate || !qtyStr){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
      const nQty = Number(qtyStr);
      if (Number.isNaN(nQty) || nQty < 0){ alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }

      if (isDuplicateEntry(itemName, inputDate, nQty)){
        alert(`‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥:\n‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå: ${itemName}\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${inputDate}\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${nQty}`);
        return;
      }
      saveData([{ item_name:itemName, date:inputDate, quantity:nQty }]);
    });

    // Save all
    $('#btnSaveAll')?.addEventListener('click', () => {
      const inputDate = $('#inputDate')?.value || '';
      if (!inputDate){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'); return; }

      const payload = [];
      const duplicateList = [];

      $$('#tableBody input[type="number"]').forEach(input => {
        const val = input.value.trim();
        if (val === '') return;
        const name = input.dataset.item;
        const qty = Number(val);
        if (Number.isNaN(qty) || qty < 0) return;

        if (isDuplicateEntry(name, inputDate, qty)){
          duplicateList.push(`- ${name} | ${inputDate} | ${qty}`);
        }else{
          payload.push({ item_name:name, date:inputDate, quantity:qty });
        }
      });

      if (duplicateList.length){
        alert(`‚ö†Ô∏è ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥ ${duplicateList.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:\n\n${duplicateList.join('\n')}`);
      }
      if (!payload.length){
        alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        return;
      }
      saveData(payload);
    });

    // Popup (Add item)
    const popup = $('#popupForm');
    function showAddPopup(){
      $('#newName').value = '';
      $('#newQty').value = '';
      $('#newDate').value = $('#inputDate')?.value || todayIso();
      popup.style.display = 'flex';
      setTimeout(() => $('#newName')?.focus(), 10);
    }
    function hideAddPopup(){ popup.style.display = 'none'; }

    $('#btnAdd')?.addEventListener('click', showAddPopup);
    $('#popupCancel')?.addEventListener('click', hideAddPopup);
    $('#popupSubmit')?.addEventListener('click', () => {
      const name = $('#newName').value.trim();
      const qty = Number($('#newQty').value);
      const date = $('#newDate').value;

      if (!name || !Number.isFinite(qty) || qty < 0 || !date){
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return;
      }
      if (isDuplicateEntry(name, date, qty)){
        alert('‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏ä‡∏∑‡πà‡∏≠, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô)');
        return;
      }
      saveData([{ item_name:name, date, quantity:qty }]);
      hideAddPopup();
    });
    // ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
    $('#popupForm')?.addEventListener('click', (e) => { if (e.target === e.currentTarget) hideAddPopup(); });
    // ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ ESC
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideAddPopup(); });

    // Floating menu
    const floatingToggle = $('#floatingToggle');
    const floatingMenu = $('#floatingMenu');
    function toggleFloatingMenu(){
      if (!floatingMenu) return;
      floatingMenu.style.display = (floatingMenu.style.display === 'flex') ? 'none' : 'flex';
    }
    floatingToggle?.addEventListener('click', (e) => { e.stopPropagation(); toggleFloatingMenu(); });
    document.addEventListener('click', (e) => {
      if (!floatingToggle || !floatingMenu) return;
      if (!floatingToggle.contains(e.target) && !floatingMenu.contains(e.target)){
        floatingMenu.style.display = 'none';
      }
    });

    // Start
    fetchData();
  });
  </script>
</body>
</html>
