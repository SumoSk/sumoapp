<!-- customer_modal.html -->
<style>
  #customer-modal {
    position: fixed; inset: 0;
    background: rgba(0,0,0,.45);
    display: none; align-items: center; justify-content: center;
    z-index: 1100;
  }
  #customer-modal .panel {
    position: relative;
    width: min(900px, 92vw);
    max-height: 88vh; overflow: auto;
    background: #fff; border-radius: 14px;
    padding: 16px 18px 22px;
    box-shadow: 0 12px 34px rgba(0,0,0,.25);
  }
</style>

<div id="customer-modal">
  <div class="panel">
    <div id="modal-content"></div>
  </div>
</div>

<script>
(function () {
  // ===== Helpers =====
  window.formatDate ||= function (d) {
    if (!d) return '-';
    const x = new Date(d); if (isNaN(x)) return d;
    const dd = String(x.getDate()).padStart(2,'0');
    const mm = String(x.getMonth()+1).padStart(2,'0');
    const yy = x.getFullYear();
    return `${dd}/${mm}/${yy}`;
  };
  window.escapeHTML ||= (s)=>String(s||'')
    .replaceAll('&','&amp;').replaceAll('<','&lt;')
    .replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');

  function showModal(){ document.getElementById('customer-modal').style.display='flex'; }
  function hideModal(){ document.getElementById('customer-modal').style.display='none'; }
  window.closeCustomerModal = hideModal;
  document.getElementById('customer-modal').addEventListener('click', e=>{
    const panel=document.querySelector('#customer-modal .panel');
    if(!panel.contains(e.target)) hideModal();
  });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') hideModal(); });

  // === สะดวกเวลา map คีย์ ===
  function buildKey(name, phone){ return `${name||''}|${phone||''}`; }

  // === Hook: ให้ element ที่มี class="customer-link" กดแล้วเปิด modal ได้ ===
  document.addEventListener('click', function(e){
    const el = e.target.closest('.customer-link');
    if(!el) return;
    const name = el.getAttribute('data-name') || el.textContent.trim();
    const phone = el.getAttribute('data-phone') || '';
    openCustomerModal(buildKey(name, phone));
  });

  // === ฟังก์ชันหลัก ===
  window.openCustomerModal = function(key) {
    const recs = (window.allCustomerRecords||[]).filter(r => `${r.name}|${r.phone||''}` === key);
    if(!recs.length) return;

    const first = recs[0];
    const customer = { name:first.name, phone:first.phone||'-', opd:first.opd||'-' };

    const latestRecord = recs.reduce((latest,r)=> 
      new Date(r.date) > new Date(latest.date)? r:latest, recs[0]);

    const lastDate = new Date(latestRecord.date);
    const today = new Date();
    const daysAbsent = Math.floor((today - lastDate)/(1000*60*60*24));

    const totalVisits = recs.length;
    const paidRecords = recs.filter(r => parseFloat(r.amount||0) > 0);
    const paidVisits = paidRecords.length;
    const totalAmount = paidRecords.reduce((s,r)=>s+parseFloat(r.amount||0),0);
    const average = paidVisits>0 ? Math.round(totalAmount/paidVisits) : 0;

    const allItems = {};
    recs.forEach(r => {
      (r.items||[]).forEach(item=>{
        let name = item;
        const m = item.match(/\((.*?)\)/); name = m? m[1] : item.split(" - ")[0];
        const q = item.match(/- (\d+) ชิ้น/); const qty = q? parseInt(q[1]) : 1;
        allItems[name] = (allItems[name]||0) + qty;
      });
    });

    const categoryMap = {
      "โบทอค":["Aestox 50 u","Aestox 100 u","Allergan 50 u","Allergan 100 u","เฉพาะจุด","แบ่งไว้แล้ว","Nabota"],
      "ฟิลเลอร์":["Neuramis สีดำ","Neuramis สีทอง","E.P.T.Q ระบุสีด้วย","Restylane ระบุสีด้วย"],
      "งานผิว":["Meso Chanel","P - Cell","Aquatic","Hestina","Exosome","Rejuran","Belotero Revive","Sculptra","Juvelook","Aesthefill","Mesowink","AlphaArbutin","PRP","Biocollagen","Transamine"],
      "ดริปผิว":["Snow White","Super Aurawhite","Vitamin Mix","Brain Booster","Energy Booster"],
      "ทรีทเม้นท์":["ทรีทเมนต์หน้าใส","ทรีทเมนต์สิว","ทรีทเมนต์ฝ้า"],
      "Fat/Hifu":["Bromi","Sisi","HIFU","HIFU แถม"],
      "อื่นๆ":["ยาฉีดสลายฝ้า","ครีมทาฝ้า","ยาทานฝ้า","ไหมลิฟท์กรอบหน้า","ไหม PDO","ไหม Collagen","จ่ายเงิน/จองสินค้า"],
      "โปรโมชั่น/อีเว้นพิเศษ":["สลายฟิลเลอร์","ไหม PDO","ปั่น RF","ไหมลิฟท์กรอบหน้า","ผลักวิตามิน"]
    };

    const categorizedItems = {};
    for (const [cat, names] of Object.entries(categoryMap)) {
      names.forEach(n => {
        if (allItems[n]) {
          (categorizedItems[cat] ||= []).push(`${n} : ${allItems[n]}`);
          delete allItems[n];
        }
      });
    }
    if (Object.keys(allItems).length) {
      (categorizedItems["อื่นๆ"] ||= []);
      for (const [n,q] of Object.entries(allItems)) categorizedItems["อื่นๆ"].push(`${n} : ${q}`);
    }

    const itemSummary = Object.entries(categorizedItems)
      .map(([cat,items])=>`<div style="margin-bottom:6px;"><strong>${cat}</strong>: ${items.join(" | ")}</div>`).join("");

    const historyHtml = recs
      .slice().sort((a,b)=>b.date.localeCompare(a.date))
      .map(r=>{
        const items = (r.items||[]).map(item=>{
          const m = item.match(/\((.*?)\)/);
          const name = m? m[1] : item.split(" - ")[0];
          const q = item.match(/- (\d+) ชิ้น/); const qty = q? parseInt(q[1]) : 1;
          return `<li>${escapeHTML(name)} : ${qty}</li>`;
        }).join("");
        const noteText = r.note ? `<div style="margin-top:2px; font-style:italic; color:#444;">📝 หมายเหตุ: ${escapeHTML(r.note)}</div>` : "";
        return `
          <div style="margin-bottom:16px;">
            <div style="margin-bottom:4px;font-weight:bold;">📅 ${formatDate(r.date)}</div>
            <ul style="padding-left:16px;margin:0;">${items}</ul>
            <div style="margin-top:4px;color:#00796b;">💵 ยอด: ${parseFloat(r.amount||0).toLocaleString()} บาท</div>
            ${noteText}
            <hr style="margin: 10px auto; border: 0; border-top: 1px dashed #999; width: 60%;">
          </div>`;
      }).join("");

    const daysAbsentText = `<span style="color:red;">(ไม่ได้มาแล้ว: ${daysAbsent} วัน)</span>`;

    document.getElementById("modal-content").innerHTML = `
      <div style="position:absolute; top:10px; right:10px; display:flex; gap:10px;">
        <button onclick="closeCustomerModal()" title="ปิดหน้าต่าง" style="background:white; border:none; border-radius:50%; width:36px; height:36px; box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer; display:flex; align-items:center; justify-content:center;">❌</button>
      </div>

      <h3 style="font-size:18px;margin-bottom:4px;">📇 ${escapeHTML(customer.name)}</h3>
      <div>🆔 <strong>OPD:</strong> ${escapeHTML(customer.opd)}</div>
      <div>📞 <strong>เบอร์:</strong> ${escapeHTML(customer.phone)}</div>
      <div>📅 <strong>วันล่าสุด:</strong> ${formatDate(latestRecord.date)} ${daysAbsentText}</div>
      <div style="color:#00796b;"><strong>💰 ยอดรวม:</strong> ${totalAmount.toLocaleString()} บาท</div>
      <div>🔁 มาใช้บริการ: ${totalVisits} ครั้ง (${paidVisits} ครั้งจ่ายเงิน)</div>
      <div>💳 <strong>เฉลี่ยต่อครั้ง:</strong> ${Math.round(average).toLocaleString()} บาท</div>

      <hr style="margin: 16px auto 8px; border: 0; border-top: 1px solid #ccc; width: 60%;">
      <div style="font-weight:bold;">📦 สรุปรายการซื้อทั้งหมด:</div>
      <div style="margin:6px 0 12px;">${itemSummary}</div>
      <hr style="margin: 16px auto 8px; border: 0; border-top: 1px solid #ccc; width: 60%;">
      <div style="font-weight:bold;margin-bottom:6px;">🛍️ ประวัติการซื้อย้อนหลัง:</div>
      ${historyHtml}
      <div style="margin-top:10px;font-weight:bold;color:#b8860b;">💰 รวมทั้งหมด: ${totalAmount.toLocaleString()} บาท</div>`;
    showModal();
  };
})();
</script>
