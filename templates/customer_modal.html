<!-- customer_modal.html -->
<style>
  #customer-modal {
    position: fixed; inset: 0;
    background: rgba(0,0,0,.45);
    display: none; align-items: center; justify-content: center;
    z-index: 1100;
  }
  #customer-modal .panel {
    position: relative;
    width: min(900px, 92vw);
    max-height: 88vh; overflow: auto;
    background: #fff; border-radius: 14px;
    padding: 16px 18px 22px;
    box-shadow: 0 12px 34px rgba(0,0,0,.25);
  }
</style>

<div id="customer-modal">
  <div class="panel">
    <div id="modal-content"></div>
  </div>
</div>

<script>
(function () {
  // ===== Helpers =====
  window.formatDate ||= function (d) {
    if (!d) return '-';
    const x = new Date(d); if (isNaN(x)) return d;
    const dd = String(x.getDate()).padStart(2,'0');
    const mm = String(x.getMonth()+1).padStart(2,'0');
    const yy = x.getFullYear();
    return `${dd}/${mm}/${yy}`;
  };
  window.escapeHTML ||= (s)=>String(s||'')
    .replaceAll('&','&amp;').replaceAll('<','&lt;')
    .replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');

  function showModal(){ document.getElementById('customer-modal').style.display='flex'; }
  function hideModal(){ document.getElementById('customer-modal').style.display='none'; }
  window.closeCustomerModal = hideModal;
  document.getElementById('customer-modal').addEventListener('click', e=>{
    const panel=document.querySelector('#customer-modal .panel');
    if(!panel.contains(e.target)) hideModal();
  });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') hideModal(); });

  // === à¸ªà¸°à¸”à¸§à¸à¹€à¸§à¸¥à¸² map à¸„à¸µà¸¢à¹Œ ===
  function buildKey(name, phone){ return `${name||''}|${phone||''}`; }

  // === Hook: à¹ƒà¸«à¹‰ element à¸—à¸µà¹ˆà¸¡à¸µ class="customer-link" à¸à¸”à¹à¸¥à¹‰à¸§à¹€à¸›à¸´à¸” modal à¹„à¸”à¹‰ ===
  document.addEventListener('click', function(e){
    const el = e.target.closest('.customer-link');
    if(!el) return;
    const name = el.getAttribute('data-name') || el.textContent.trim();
    const phone = el.getAttribute('data-phone') || '';
    openCustomerModal(buildKey(name, phone));
  });

  // === à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸«à¸¥à¸±à¸ ===
  window.openCustomerModal = function(key) {
    const recs = (window.allCustomerRecords||[]).filter(r => `${r.name}|${r.phone||''}` === key);
    if(!recs.length) return;

    const first = recs[0];
    const customer = { name:first.name, phone:first.phone||'-', opd:first.opd||'-' };

    const latestRecord = recs.reduce((latest,r)=> 
      new Date(r.date) > new Date(latest.date)? r:latest, recs[0]);

    const lastDate = new Date(latestRecord.date);
    const today = new Date();
    const daysAbsent = Math.floor((today - lastDate)/(1000*60*60*24));

    const totalVisits = recs.length;
    const paidRecords = recs.filter(r => parseFloat(r.amount||0) > 0);
    const paidVisits = paidRecords.length;
    const totalAmount = paidRecords.reduce((s,r)=>s+parseFloat(r.amount||0),0);
    const average = paidVisits>0 ? Math.round(totalAmount/paidVisits) : 0;

    const allItems = {};
    recs.forEach(r => {
      (r.items||[]).forEach(item=>{
        let name = item;
        const m = item.match(/\((.*?)\)/); name = m? m[1] : item.split(" - ")[0];
        const q = item.match(/- (\d+) à¸Šà¸´à¹‰à¸™/); const qty = q? parseInt(q[1]) : 1;
        allItems[name] = (allItems[name]||0) + qty;
      });
    });

    const categoryMap = {
      "à¹‚à¸šà¸—à¸­à¸„":["Aestox 50 u","Aestox 100 u","Allergan 50 u","Allergan 100 u","à¹€à¸‰à¸à¸²à¸°à¸ˆà¸¸à¸”","à¹à¸šà¹ˆà¸‡à¹„à¸§à¹‰à¹à¸¥à¹‰à¸§","Nabota"],
      "à¸Ÿà¸´à¸¥à¹€à¸¥à¸­à¸£à¹Œ":["Neuramis à¸ªà¸µà¸”à¸³","Neuramis à¸ªà¸µà¸—à¸­à¸‡","E.P.T.Q à¸£à¸°à¸šà¸¸à¸ªà¸µà¸”à¹‰à¸§à¸¢","Restylane à¸£à¸°à¸šà¸¸à¸ªà¸µà¸”à¹‰à¸§à¸¢"],
      "à¸‡à¸²à¸™à¸œà¸´à¸§":["Meso Chanel","P - Cell","Aquatic","Hestina","Exosome","Rejuran","Belotero Revive","Sculptra","Juvelook","Aesthefill","Mesowink","AlphaArbutin","PRP","Biocollagen","Transamine"],
      "à¸”à¸£à¸´à¸›à¸œà¸´à¸§":["Snow White","Super Aurawhite","Vitamin Mix","Brain Booster","Energy Booster"],
      "à¸—à¸£à¸µà¸—à¹€à¸¡à¹‰à¸™à¸—à¹Œ":["à¸—à¸£à¸µà¸—à¹€à¸¡à¸™à¸•à¹Œà¸«à¸™à¹‰à¸²à¹ƒà¸ª","à¸—à¸£à¸µà¸—à¹€à¸¡à¸™à¸•à¹Œà¸ªà¸´à¸§","à¸—à¸£à¸µà¸—à¹€à¸¡à¸™à¸•à¹Œà¸à¹‰à¸²"],
      "Fat/Hifu":["Bromi","Sisi","HIFU","HIFU à¹à¸–à¸¡"],
      "à¸­à¸·à¹ˆà¸™à¹†":["à¸¢à¸²à¸‰à¸µà¸”à¸ªà¸¥à¸²à¸¢à¸à¹‰à¸²","à¸„à¸£à¸µà¸¡à¸—à¸²à¸à¹‰à¸²","à¸¢à¸²à¸—à¸²à¸™à¸à¹‰à¸²","à¹„à¸«à¸¡à¸¥à¸´à¸Ÿà¸—à¹Œà¸à¸£à¸­à¸šà¸«à¸™à¹‰à¸²","à¹„à¸«à¸¡ PDO","à¹„à¸«à¸¡ Collagen","à¸ˆà¹ˆà¸²à¸¢à¹€à¸‡à¸´à¸™/à¸ˆà¸­à¸‡à¸ªà¸´à¸™à¸„à¹‰à¸²"],
      "à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™/à¸­à¸µà¹€à¸§à¹‰à¸™à¸à¸´à¹€à¸¨à¸©":["à¸ªà¸¥à¸²à¸¢à¸Ÿà¸´à¸¥à¹€à¸¥à¸­à¸£à¹Œ","à¹„à¸«à¸¡ PDO","à¸›à¸±à¹ˆà¸™ RF","à¹„à¸«à¸¡à¸¥à¸´à¸Ÿà¸—à¹Œà¸à¸£à¸­à¸šà¸«à¸™à¹‰à¸²","à¸œà¸¥à¸±à¸à¸§à¸´à¸•à¸²à¸¡à¸´à¸™"]
    };

    const categorizedItems = {};
    for (const [cat, names] of Object.entries(categoryMap)) {
      names.forEach(n => {
        if (allItems[n]) {
          (categorizedItems[cat] ||= []).push(`${n} : ${allItems[n]}`);
          delete allItems[n];
        }
      });
    }
    if (Object.keys(allItems).length) {
      (categorizedItems["à¸­à¸·à¹ˆà¸™à¹†"] ||= []);
      for (const [n,q] of Object.entries(allItems)) categorizedItems["à¸­à¸·à¹ˆà¸™à¹†"].push(`${n} : ${q}`);
    }

    const itemSummary = Object.entries(categorizedItems)
      .map(([cat,items])=>`<div style="margin-bottom:6px;"><strong>${cat}</strong>: ${items.join(" | ")}</div>`).join("");

    const historyHtml = recs
      .slice().sort((a,b)=>b.date.localeCompare(a.date))
      .map(r=>{
        const items = (r.items||[]).map(item=>{
          const m = item.match(/\((.*?)\)/);
          const name = m? m[1] : item.split(" - ")[0];
          const q = item.match(/- (\d+) à¸Šà¸´à¹‰à¸™/); const qty = q? parseInt(q[1]) : 1;
          return `<li>${escapeHTML(name)} : ${qty}</li>`;
        }).join("");
        const noteText = r.note ? `<div style="margin-top:2px; font-style:italic; color:#444;">ğŸ“ à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸: ${escapeHTML(r.note)}</div>` : "";
        return `
          <div style="margin-bottom:16px;">
            <div style="margin-bottom:4px;font-weight:bold;">ğŸ“… ${formatDate(r.date)}</div>
            <ul style="padding-left:16px;margin:0;">${items}</ul>
            <div style="margin-top:4px;color:#00796b;">ğŸ’µ à¸¢à¸­à¸”: ${parseFloat(r.amount||0).toLocaleString()} à¸šà¸²à¸—</div>
            ${noteText}
            <hr style="margin: 10px auto; border: 0; border-top: 1px dashed #999; width: 60%;">
          </div>`;
      }).join("");

    const daysAbsentText = `<span style="color:red;">(à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸¡à¸²à¹à¸¥à¹‰à¸§: ${daysAbsent} à¸§à¸±à¸™)</span>`;

    document.getElementById("modal-content").innerHTML = `
      <div style="position:absolute; top:10px; right:10px; display:flex; gap:10px;">
        <button onclick="closeCustomerModal()" title="à¸›à¸´à¸”à¸«à¸™à¹‰à¸²à¸•à¹ˆà¸²à¸‡" style="background:white; border:none; border-radius:50%; width:36px; height:36px; box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer; display:flex; align-items:center; justify-content:center;">âŒ</button>
      </div>

      <h3 style="font-size:18px;margin-bottom:4px;">ğŸ“‡ ${escapeHTML(customer.name)}</h3>
      <div>ğŸ†” <strong>OPD:</strong> ${escapeHTML(customer.opd)}</div>
      <div>ğŸ“ <strong>à¹€à¸šà¸­à¸£à¹Œ:</strong> ${escapeHTML(customer.phone)}</div>
      <div>ğŸ“… <strong>à¸§à¸±à¸™à¸¥à¹ˆà¸²à¸ªà¸¸à¸”:</strong> ${formatDate(latestRecord.date)} ${daysAbsentText}</div>
      <div style="color:#00796b;"><strong>ğŸ’° à¸¢à¸­à¸”à¸£à¸§à¸¡:</strong> ${totalAmount.toLocaleString()} à¸šà¸²à¸—</div>
      <div>ğŸ” à¸¡à¸²à¹ƒà¸Šà¹‰à¸šà¸£à¸´à¸à¸²à¸£: ${totalVisits} à¸„à¸£à¸±à¹‰à¸‡ (${paidVisits} à¸„à¸£à¸±à¹‰à¸‡à¸ˆà¹ˆà¸²à¸¢à¹€à¸‡à¸´à¸™)</div>
      <div>ğŸ’³ <strong>à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¸•à¹ˆà¸­à¸„à¸£à¸±à¹‰à¸‡:</strong> ${Math.round(average).toLocaleString()} à¸šà¸²à¸—</div>

      <hr style="margin: 16px auto 8px; border: 0; border-top: 1px solid #ccc; width: 60%;">
      <div style="font-weight:bold;">ğŸ“¦ à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¸à¸²à¸£à¸‹à¸·à¹‰à¸­à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”:</div>
      <div style="margin:6px 0 12px;">${itemSummary}</div>
      <hr style="margin: 16px auto 8px; border: 0; border-top: 1px solid #ccc; width: 60%;">
      <div style="font-weight:bold;margin-bottom:6px;">ğŸ›ï¸ à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸‹à¸·à¹‰à¸­à¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡:</div>
      ${historyHtml}
      <div style="margin-top:10px;font-weight:bold;color:#b8860b;">ğŸ’° à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”: ${totalAmount.toLocaleString()} à¸šà¸²à¸—</div>`;
    showModal();
  };
})();
</script>
