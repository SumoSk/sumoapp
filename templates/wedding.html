<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wedding Guest Check‚ÄëIn (Realtime)</title>
  <!-- Tailwind CSS CDN (no build step) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    .seat-badge { @apply inline-flex items-center justify-center w-7 h-7 rounded-full text-xs font-semibold; }
  </style>
</head>
<body class="min-h-full bg-gray-50 text-gray-900">
  <div class="max-w-7xl mx-auto px-3 py-6">
    <header class="mb-6">
      <h1 class="text-2xl md:text-3xl font-bold">üíç Wedding Guest Check‚ÄëIn ‚Äî Realtime</h1>
      <p class="text-sm text-gray-600">‡πÇ‡∏ï‡πä‡∏∞‡∏•‡∏∞ 10 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á ‚Ä¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå ‚Ä¢ ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï</p>
    </header>

    <!-- CONFIG PANEL -->
    <section class="mb-6 p-4 rounded-2xl bg-white shadow-sm border">
      <details open>
        <summary class="cursor-pointer font-semibold">üîß ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)</summary>
        <div class="mt-3 grid md:grid-cols-3 gap-3">
          <label class="block">
            <span class="text-sm font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏ï‡πä‡∏∞ (TABLE_COUNT)</span>
            <input id="tableCountInput" type="number" min="1" value="12" class="mt-1 w-full rounded-xl border px-3 py-2" />
          </label>
          <label class="block">
            <span class="text-sm font-medium">‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå (EVENT_ID)</span>
            <input id="eventIdInput" type="text" value="wedding001" class="mt-1 w-full rounded-xl border px-3 py-2" />
          </label>
          <div class="flex items-end gap-3">
            <button id="applyConfigBtn" class="rounded-xl px-4 py-2 border bg-gray-100 hover:bg-gray-200">Apply</button>
            <button id="seedDemoBtn" class="rounded-xl px-4 py-2 border bg-gray-100 hover:bg-gray-200">Seed Demo Guests</button>
          </div>
        </div>
        <p class="mt-3 text-xs text-gray-500">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô <code>EVENT_ID</code> ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô namespace ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
      </details>
    </section>

    <!-- CHECK-IN PANEL -->
    <section class="mb-6 grid lg:grid-cols-3 gap-6">
      <div class="lg:col-span-1 p-4 rounded-2xl bg-white shadow-sm border">
        <h2 class="text-lg font-semibold mb-3">üßæ ‡πÄ‡∏ä‡πá‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏Ç‡∏Å</h2>
        <div class="space-y-3">
          <label class="block">
            <span class="text-sm">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏Ç‡∏Å</span>
            <input id="searchInput" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏¥‡∏ä‡∏≤‡∏ç ‡∏´‡∏£‡∏∑‡∏≠ GUEST-001" class="mt-1 w-full rounded-xl border px-3 py-2" />
          </label>
          <div class="flex gap-2">
            <button id="searchBtn" class="rounded-xl px-4 py-2 bg-black text-white hover:opacity-90">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            <button id="clearSearchBtn" class="rounded-xl px-4 py-2 border">‡∏•‡πâ‡∏≤‡∏á</button>
          </div>

          <div id="resultCard" class="hidden mt-3 p-3 rounded-xl border">
            <div class="flex justify-between items-start gap-2">
              <div>
                <div class="font-semibold" id="rName">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏Ç‡∏Å</div>
                <div class="text-xs text-gray-500" id="rId">ID</div>
                <div class="text-sm mt-1" id="rStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: -</div>
                <div class="text-sm" id="rSeat">‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á: -</div>
              </div>
              <div class="flex flex-col gap-2">
                <button id="checkinBtn" class="rounded-lg px-3 py-2 bg-emerald-600 text-white hover:bg-emerald-700">‡πÄ‡∏ä‡πá‡∏Å‡∏≠‡∏¥‡∏ô</button>
                <button id="undoCheckinBtn" class="rounded-lg px-3 py-2 bg-amber-600 text-white hover:bg-amber-700">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏ä‡πá‡∏Å‡∏≠‡∏¥‡∏ô</button>
              </div>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2">
              <input id="manualTable" type="number" min="1" class="rounded-lg border px-2 py-1" placeholder="‡πÇ‡∏ï‡πä‡∏∞ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)" />
              <input id="manualSeat" type="number" min="1" max="10" class="rounded-lg border px-2 py-1" placeholder="‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á (1-10)" />
              <button id="assignSeatBtn" class="col-span-2 rounded-lg px-3 py-2 border">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏ï‡πä‡∏∞/‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</button>
            </div>
          </div>

          <details class="mt-4">
            <summary class="font-medium cursor-pointer">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡∏Å (Walk‚Äëin)</summary>
            <div class="mt-2 grid grid-cols-2 gap-2">
              <input id="newName" class="rounded-lg border px-2 py-1" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏Ç‡∏Å" />
              <input id="newId" class="rounded-lg border px-2 py-1" placeholder="‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏Ç‡∏Å (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ)" />
              <button id="addGuestBtn" class="col-span-2 rounded-lg px-3 py-2 bg-blue-600 text-white hover:bg-blue-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡∏Å</button>
            </div>
          </details>
        </div>
      </div>

      <!-- DASHBOARD -->
      <div class="lg:col-span-2 p-4 rounded-2xl bg-white shadow-sm border">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">üìä ‡πÅ‡∏ú‡∏á‡πÇ‡∏ï‡πä‡∏∞ (Realtime)</h2>
          <div class="text-sm text-gray-600">‡∏£‡∏ß‡∏°: <span id="totalGuests">0</span> ‡∏Ñ‡∏ô ‚Ä¢ ‡πÄ‡∏ä‡πá‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß: <span id="checkedInCount">0</span> ‡∏Ñ‡∏ô</div>
        </div>
        <div id="tablesGrid" class="mt-3 grid md:grid-cols-2 xl:grid-cols-3 gap-3"></div>
      </div>
    </section>

    <footer class="mt-8 text-center text-xs text-gray-500">
      ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ Firebase Firestore & Tailwind ‚Ä¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Real‚Äëtime ‚Ä¢ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏•‡∏∞ 10 ‡∏Ñ‡∏ô
    </footer>
  </div>

  <!-- Firebase v10 (Modular SDK) -->
  <script type="module">
    // 1) ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ config ‡∏Ç‡∏≠‡∏á Firebase ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ñ‡∏∏‡∏ì (‡∏à‡∏≤‡∏Å Firebase Console > Project settings > SDK setup)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
    };

    // 2) ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å UI ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
    let TABLE_COUNT = 12; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏ï‡πä‡∏∞
    let EVENT_ID = 'wedding001'; // namespace ‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô

    // --- Firebase imports ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, onSnapshot, query, where, serverTimestamp, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Collections
    const guestsCol = () => collection(db, 'events', EVENT_ID, 'guests');

    // --- DOM helpers ---
    const $ = (id) => document.getElementById(id);
    const toast = (msg) => {
      const el = document.createElement('div');
      el.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-black text-white text-sm px-3 py-2 rounded-xl shadow';
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1800);
    };

    // --- Config UI ---
    const applyConfig = () => {
      TABLE_COUNT = Math.max(1, parseInt($("tableCountInput").value || '1', 10));
      EVENT_ID = $("eventIdInput").value.trim() || 'wedding001';
      renderTablesSkeleton();
      attachRealtime();
      toast('Applied settings');
    };

    $("applyConfigBtn").addEventListener('click', applyConfig);

    // --- Seed demo data ---
    $("seedDemoBtn").addEventListener('click', async () => {
      if (!confirm('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡πÇ‡∏°‡πà 30 ‡∏Ñ‡∏ô‡πÑ‡∏´‡∏°?')) return;
      const names = Array.from({length: 30}, (_,i) => `‡πÅ‡∏Ç‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${i+1}`);
      let t = 1, s = 1;
      for (const name of names) {
        const id = `GUEST-${String(Math.floor(Math.random()*999999)).padStart(6,'0')}`;
        await setDoc(doc(guestsCol(), id), {
          name, guestId: id, status: 'invited', tableNo: t, seatNo: s, createdAt: serverTimestamp(), checkedInAt: null
        });
        s++; if (s>10){ s=1; t++; if (t>TABLE_COUNT) t=1; }
      }
      toast('Seeded demo guests');
    });

    // --- Render tables ---
    const tablesGrid = $("tablesGrid");
    const renderTablesSkeleton = () => {
      tablesGrid.innerHTML = '';
      for (let i=1; i<=TABLE_COUNT; i++) {
        const card = document.createElement('div');
        card.className = 'border rounded-2xl p-3';
        card.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">‡πÇ‡∏ï‡πä‡∏∞ ${i}</div>
            <div class="text-xs text-gray-500">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á: <span id="remain-${i}">10</span>/10</div>
          </div>
          <ol id="seats-${i}" class="grid grid-cols-5 gap-2"></ol>
        `;
        tablesGrid.appendChild(card);
        const ol = card.querySelector(`#seats-${i}`);
        for (let seat=1; seat<=10; seat++) {
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="p-2 border rounded-xl h-full">
              <div class="seat-badge bg-gray-100">${seat}</div>
              <div class="mt-1 text-xs" id="seatname-${i}-${seat}">‡∏ß‡πà‡∏≤‡∏á</div>
              <div class="text-[10px] text-gray-500" id="seatstatus-${i}-${seat}"></div>
            </div>
          `;
          ol.appendChild(li);
        }
      }
    };

    renderTablesSkeleton();

    // --- Realtime subscription ---
    let unsubscribe = null;
    const attachRealtime = () => {
      if (unsubscribe) unsubscribe();
      // Listen to all guests of this EVENT_ID; filter client-side.
      unsubscribe = onSnapshot(guestsCol(), (snap) => {
        // Reset counts
        const counts = Array.from({length: TABLE_COUNT+1}, () => ({ used: 0 }));
        let total = 0, checkedIn = 0;
        // Clear seats
        for (let t=1; t<=TABLE_COUNT; t++){
          for (let s=1; s<=10; s++){
            const nameEl = $("seatname-"+t+"-"+s);
            const stEl = $("seatstatus-"+t+"-"+s);
            if (nameEl) nameEl.textContent = '‡∏ß‡πà‡∏≤‡∏á';
            if (stEl) stEl.textContent = '';
          }
        }
        // Fill
        snap.forEach(docSnap => {
          const g = docSnap.data();
          if (!g || g.tableNo == null || g.seatNo == null) return;
          if (g.tableNo < 1 || g.tableNo > TABLE_COUNT) return;
          const nameEl = $("seatname-"+g.tableNo+"-"+g.seatNo);
          const stEl = $("seatstatus-"+g.tableNo+"-"+g.seatNo);
          if (nameEl) nameEl.textContent = g.name || g.guestId;
          if (stEl) stEl.textContent = (g.status === 'checked-in') ? '‡πÄ‡∏ä‡πá‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Å‡∏≠‡∏¥‡∏ô';
          counts[g.tableNo].used++;
          total++;
          if (g.status === 'checked-in') checkedIn++;
        });
        for (let t=1; t<=TABLE_COUNT; t++){
          const remainEl = $("remain-"+t);
          if (remainEl) remainEl.textContent = String(10 - (counts[t].used||0));
        }
        $("totalGuests").textContent = String(total);
        $("checkedInCount").textContent = String(checkedIn);
      });
    };

    attachRealtime();

    // --- Search ---
    let currentGuestDocRef = null;
    const showResult = (g, ref) => {
      $("resultCard").classList.remove('hidden');
      $("rName").textContent = g.name || '-';
      $("rId").textContent = g.guestId || ref.id;
      $("rStatus").textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + (g.status || 'invited');
      $("rSeat").textContent = '‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á: ' + (g.tableNo ? `‡πÇ‡∏ï‡πä‡∏∞ ${g.tableNo} / ‡∏ó‡∏µ‡πà ${g.seatNo||'-'}` : '-');
      currentGuestDocRef = ref;
    };

    $("searchBtn").addEventListener('click', async () => {
      const term = $("searchInput").value.trim();
      if (!term) return toast('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
      // Try by exact guestId first
      let ref = doc(guestsCol(), term);
      let snap = await getDoc(ref);
      if (snap.exists()) return showResult(snap.data(), ref);
      // fallback: scan all (small data)
      const all = await getDocs(guestsCol());
      const found = all.docs.find(d => (d.data().name||'').includes(term));
      if (found) return showResult(found.data(), found.ref);
      toast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏Ç‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
    });

    $("clearSearchBtn").addEventListener('click', () => {
      $("resultCard").classList.add('hidden');
      $("searchInput").value = '';
      currentGuestDocRef = null;
    });

    // --- Add Guest (walk-in) ---
    $("addGuestBtn").addEventListener('click', async () => {
      const name = $("newName").value.trim();
      let id = $("newId").value.trim();
      if (!name) return toast('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏Ç‡∏Å');
      if (!id) id = 'GUEST-' + Math.random().toString(36).slice(2,8).toUpperCase();
      const ref = doc(guestsCol(), id);
      await setDoc(ref, { name, guestId: id, status: 'invited', tableNo: null, seatNo: null, createdAt: serverTimestamp(), checkedInAt: null });
      toast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
      $("newName").value = ''; $("newId").value='';
      showResult({ name, guestId: id, status: 'invited', tableNo: null, seatNo: null }, ref);
    });

    // --- Seat assignment helpers ---
    async function findFirstAvailableSeat(tx) {
      // Simple client-side scan under transaction: get all guests then compute availability
      const all = await getDocs(guestsCol());
      const used = new Map(); // key `${t}-${s}`
      all.forEach(d => {
        const g = d.data();
        if (g.tableNo && g.seatNo) used.set(`${g.tableNo}-${g.seatNo}`, true);
      });
      for (let t=1; t<=TABLE_COUNT; t++){
        let count = 0;
        for (let s=1; s<=10; s++){
          if (!used.has(`${t}-${s}`)) return { t, s };
          count++;
        }
      }
      return null; // full
    }

    async function assignSeatTransaction(guestRef, preferredTable=null, preferredSeat=null) {
      return await runTransaction(db, async (tx) => {
        const guestSnap = await tx.get(guestRef);
        if (!guestSnap.exists()) throw new Error('Guest not found');
        const g = guestSnap.data();

        // If already has seat, keep (unless admin provides a new seat)
        let targetTable = g.tableNo ?? null;
        let targetSeat = g.seatNo ?? null;

        if (preferredTable) targetTable = preferredTable;
        if (preferredSeat) targetSeat = preferredSeat;

        if (!targetTable || !targetSeat) {
          const spot = await findFirstAvailableSeat(tx);
          if (!spot) throw new Error('‡∏ó‡∏∏‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß');
          targetTable = targetTable || spot.t;
          targetSeat = targetSeat || spot.s;
        }

        // Validate chosen seat is free
        const all = await getDocs(guestsCol());
        const clash = all.docs.find(d => {
          const x = d.data();
          return x.tableNo === targetTable && x.seatNo === targetSeat && d.id !== guestRef.id;
        });
        if (clash) throw new Error(`‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á (‡πÇ‡∏ï‡πä‡∏∞ ${targetTable} / ‡∏ó‡∏µ‡πà ${targetSeat})`);

        tx.update(guestRef, { tableNo: targetTable, seatNo: targetSeat });
        return { tableNo: targetTable, seatNo: targetSeat };
      });
    }

    // --- Actions on current guest ---
    $("assignSeatBtn").addEventListener('click', async () => {
      if (!currentGuestDocRef) return toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏Ç‡∏Å');
      const t = parseInt($("manualTable").value || '0', 10) || null;
      const s = parseInt($("manualSeat").value || '0', 10) || null;
      try {
        const seat = await assignSeatTransaction(currentGuestDocRef, t, s);
        toast(`‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß: ‡πÇ‡∏ï‡πä‡∏∞ ${seat.tableNo} / ‡∏ó‡∏µ‡πà ${seat.seatNo}`);
      } catch(e){ toast(e.message); }
    });

    $("checkinBtn").addEventListener('click', async () => {
      if (!currentGuestDocRef) return toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏Ç‡∏Å');
      try {
        // Ensure seat exists
        const seat = await assignSeatTransaction(currentGuestDocRef);
        await updateDoc(currentGuestDocRef, { status: 'checked-in', checkedInAt: serverTimestamp() });
        toast(`‡πÄ‡∏ä‡πá‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Ä¢ ‡πÇ‡∏ï‡πä‡∏∞ ${seat.tableNo} / ‡∏ó‡∏µ‡πà ${seat.seatNo}`);
      } catch(e){ toast(e.message); }
    });

    $("undoCheckinBtn").addEventListener('click', async () => {
      if (!currentGuestDocRef) return toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏Ç‡∏Å');
      await updateDoc(currentGuestDocRef, { status: 'invited', checkedInAt: null });
      toast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏ä‡πá‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
    });

    // --- Init from controls
    // (Keep defaults rendered; admin can Apply later)
  </script>
</body>
</html>
