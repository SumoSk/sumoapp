<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>{% block title %}CRM ‚Äî Sales Pitch{% endblock %}</title>

  {% block head %}
  <style>
    :root{
      --bg:#f7faf9; --card:#ffffff; --muted:#6b7280; --text:#0f172a;
      --primary:#0ea5a4; --primary-600:#0c8e8d; --ring:#9fe8e7;
      --line:#e5e7eb; --danger:#ef4444; --warn:#f59e0b; --success:#22c55e;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Prompt','Segoe UI',system-ui,-apple-system,sans-serif;
      color:var(--text); background:var(--bg);
      font-size: 12px; margin:0;
    }
    .container{ max-width:1180px; margin:18px auto 100px; padding:0 12px; }
    .appbar{
      position:sticky; top:0; z-index:40; backdrop-filter: blur(8px);
      background: color-mix(in oklab, var(--bg) 70%, white 30%); border-bottom:1px solid var(--line);
    }
    .appbar-inner{ max-width:1180px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:10px; }
    .title{ font-weight:800; font-size: clamp(16px,2.2vw,20px); display:flex; align-items:center; gap:8px; }

    .btn{
      appearance:none; border:none; border-radius:10px; padding:7px 10px; cursor:pointer; font-weight:700;
      display:inline-flex; align-items:center; gap:6px; transition:.15s; font-size:12px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background:var(--primary); color:#fff; box-shadow:0 6px 18px rgba(14,165,164,.15); }
    .btn-primary:hover{ background:var(--primary-600); }
    .btn-ghost{ background:#fff; color:var(--text); border:1px solid var(--line); }
    .btn-danger{ background:var(--danger); color:#fff; }
    .btn-icon{ padding:6px; border-radius:8px; }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius: var(--radius);
      box-shadow: 0 8px 22px rgba(2,8,23,.05);
    }
    .section{ margin-top:14px; }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px; padding:10px; border-bottom:1px solid var(--line); align-items:center;
    }

    .field{ display:grid; gap:4px; }
    .input, select, textarea{
      width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:10px; outline:none; font-size:12px; background:#fff;
    }
    .input:focus, select:focus, textarea:focus{ border-color:var(--primary); box-shadow:0 0 0 3px var(--ring); }

    /* ===== New Plan Table ===== */
    .plan-header{ padding:10px 12px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:10px; justify-content:space-between; }
    .plan-title{ font-weight:800; font-size:14px; }
    .plan-sub{ color:#64748b; font-weight:500; }
    .plan-actions{ display:flex; gap:8px; align-items:center; }

    .table-wrap{ overflow:auto; }
    table{ width:100%; border-collapse:separate; border-spacing:0; min-width:980px; }
    thead th{
      position:sticky; top:0; z-index:1; background:#f0fdfa; color:#0f766e;
      font-weight:800; font-size:12px; text-align:left; padding:8px 10px; border-bottom:1px solid var(--line); white-space:nowrap;
    }
    tbody td{ background:#fff; padding:8px 10px; border-bottom:1px solid var(--line); vertical-align:top; }
    tbody tr:hover td{ background:#fafafa; }
    .row-actions{ display:flex; gap:6px; }

    .badge{
      display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px;
      font-size:11px; background:#ecfeff; color:#155e75; border:1px solid #a5f3fc;
    }
    .kpis{ display:flex; gap:8px; flex-wrap:wrap; }

    .toast-wrap{ position:fixed; right:12px; bottom:12px; display:grid; gap:8px; z-index:80; }
    .toast{ background:#fff; border:1px solid var(--line); border-left:5px solid var(--success); padding:8px 10px; border-radius:12px; min-width:220px; box-shadow:0 12px 30px rgba(2,8,23,.15); display:flex; gap:8px; font-size:12px; }
    .toast.warn{ border-left-color:var(--warn); }
    .toast.error{ border-left-color:var(--danger); }

    /* ===== History Section ===== */
    .history-toolbar{ padding:10px; display:flex; flex-wrap:wrap; gap:8px; border-bottom:1px solid var(--line); align-items:center; }
    .day-card{ border-top:1px solid var(--line); }
    .day-head{
      padding:10px 12px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; background:#fff;
    }
    .day-head:hover{ background:#f8fafc; }
    .day-title{ font-weight:800; }
    .day-meta{ color:#64748b; display:flex; gap:8px; align-items:center; }
    .day-body{ padding:6px 12px 12px; display:none; }
    .day-body.open{ display:block; }
    .history-row{ display:grid; grid-template-columns: 78px 1fr 1.1fr 1fr 2fr 0.8fr; gap:8px; padding:8px 0; border-bottom:1px dashed var(--line); }
    .history-head{ font-weight:700; color:#0f766e; }
    .outcome-badge{ padding:2px 6px; border-radius:999px; font-size:11px; border:1px solid #e2e8f0; background:#f8fafc; }

    @media (max-width: 820px){
      .history-row{ grid-template-columns: 66px 1fr 1fr; }
      .hide-sm{ display:none; }
      table{ min-width:860px; }
    }
  </style>
  {% endblock %}
</head>
<body>

{% block content %}

  <!-- Appbar -->
  <div class="appbar">
    <div class="appbar-inner">
      <div class="title">üéß Sales Pitch</div>
      <div class="kpis">
        <div class="badge">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <span id="kpiToday">0</span></div>
        <div class="badge">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ: <span id="kpiWeek">0</span></div>
        <div class="badge">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <span id="kpiMonth">0</span></div>
      </div>
      <div style="flex:1"></div>
      <button id="newPlanBtn" class="btn btn-primary">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
    </div>
  </div>

  <div class="container">

    <!-- ===== Section 1: New Plan / Create ===== -->
    <div class="section card" id="newPlanCard" style="display:none;">
      <div class="plan-header">
        <div>
          <div class="plan-title" id="planTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£ Sale Pitch ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‚Äî</div>
          <div class="plan-sub">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‚Äù</div>
        </div>
        <div class="plan-actions">
          <label class="field" style="min-width: 180px;">
            <span style="font-weight:700;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
            <input id="planDate" type="date" class="input">
          </label>
          <button id="addRowBtn" class="btn btn-ghost">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
          <button id="saveAllBtn" class="btn btn-primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
      </div>

      <div class="toolbar" style="gap:14px;">
        <div class="badge">Draft ‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
        <button id="clearDraftBtn" class="btn btn-ghost">‡∏•‡πâ‡∏≤‡∏á Draft</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:48px;">#</th>
              <th style="min-width: 280px;">‡∏ä‡∏∑‡πà‡∏≠ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)</th>
              <th class="hide-sm">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</th>
              <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
              <th class="hide-sm">‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</th>
              <th class="hide-sm" style="width:120px;">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
              <th style="width:68px;">‡∏•‡∏ö</th>
            </tr>
          </thead>
          <tbody id="planTbody">
            <!-- dynamic rows -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- ===== Section 2: History ===== -->
    <div class="section card">
      <div class="history-toolbar">
        <div class="field">
          <span style="font-weight:700;">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
          <div style="display:flex; gap:6px;">
            <input type="date" id="histFrom" class="input">
            <input type="date" id="histTo" class="input">
          </div>
        </div>
        <div class="field" style="min-width:200px;">
          <span style="font-weight:700;">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span>
          <input type="text" id="histQ" class="input" placeholder="‡∏ä‡∏∑‡πà‡∏≠ / ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô / ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå">
        </div>
        <div class="field" style="min-width:200px;">
          <span style="font-weight:700;">Outcome</span>
          <select id="histOutcome"></select>
        </div>
        <div class="field" style="min-width:160px;">
          <span style="font-weight:700;">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</span>
          <select id="histChannel"></select>
        </div>
        <div style="display:flex; gap:8px; align-items:flex-end; margin-left:auto;">
          <button id="reloadHistoryBtn" class="btn btn-ghost">‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î</button>
          <button id="toggleAllBtn" class="btn btn-ghost">‡∏Å‡∏≤‡∏á/‡∏û‡∏±‡∏ö ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          <button id="exportCsvBtn" class="btn btn-ghost">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
        </div>
      </div>

      <div id="historyWrap">
        <!-- dynamic day cards -->
      </div>
    </div>

  </div>

  <!-- Toast -->
  <div class="toast-wrap" id="toastWrap"></div>

  <datalist id="customerList"><!-- options injected --></datalist>

  <script>
    // ========= Utils =========
    const $ = (q, p=document)=>p.querySelector(q);
    const $$ = (q, p=document)=>Array.from(p.querySelectorAll(q));
    const toastWrap = $('#toastWrap');
    const showToast = (msg, type='ok')=>{
      const el = document.createElement('div');
      el.className = 'toast' + (type==='warn' ? ' warn' : type==='error' ? ' error' : '');
      el.innerHTML = `<div>üí°</div><div>${msg}</div>`;
      toastWrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; }, 2200);
      setTimeout(()=>{ el.remove(); }, 2800);
    };

    const fmtThaiDate = (iso)=> {
      try{
        const d = new Date(iso);
        return d.toLocaleDateString('th-TH', { year:'numeric', month:'long', day:'numeric' });
      }catch{ return iso; }
    };
    const todayISO = ()=> new Date().toISOString().slice(0,10);

    const debounce = (fn,ms=300)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };
    const pad4 = s => String(s||'').trim().padStart(4,'0');

    // ========= Data (customers + enums) =========
    const OUTCOMES = [
      '‡∏™‡∏ô‡πÉ‡∏à‡πÇ‡∏≠‡∏ô‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏±‡∏î‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
      '‡∏™‡∏ô‡πÉ‡∏à‡πÇ‡∏≠‡∏ô‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ô‡∏±‡∏î‡∏ß‡∏±‡∏ô',
      '‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠',
      '‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ',
      '‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡πÑ‡∏°‡πà‡∏ö‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•',
      '‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á',
      '‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÇ‡∏õ‡∏£‡∏≠‡∏∑‡πà‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤',
      '‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß',
      '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏¥‡∏î',
      '‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢',
      '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á',
    ];
    const CHANNELS = ['call','line','visit','facebook','instagram','other'];

    let customers = [];           // raw list
    let customerIndex = new Map();// key (display) -> {opd,name,phone}
    let customerByOPD = new Map();// opd -> customer

    // ========= Elements =========
    const newPlanBtn = $('#newPlanBtn');
    const newPlanCard = $('#newPlanCard');
    const planDate = $('#planDate');
    const planTitle = $('#planTitle');
    const planTbody = $('#planTbody');
    const addRowBtn = $('#addRowBtn');
    const saveAllBtn = $('#saveAllBtn');
    const clearDraftBtn = $('#clearDraftBtn');

    const histFrom = $('#histFrom'), histTo = $('#histTo'), histQ = $('#histQ'), histOutcome = $('#histOutcome'), histChannel = $('#histChannel');
    const historyWrap = $('#historyWrap');
    const reloadHistoryBtn = $('#reloadHistoryBtn');
    const toggleAllBtn = $('#toggleAllBtn');
    const exportCsvBtn = $('#exportCsvBtn');

    // KPI placeholders
    const kpiToday = $('#kpiToday'), kpiWeek = $('#kpiWeek'), kpiMonth = $('#kpiMonth');

    // ========= Draft LocalStorage =========
    const DRAFT_KEY = 'crm_pitch_draft_v1';
    const loadDraft = ()=>{
      try{ return JSON.parse(localStorage.getItem(DRAFT_KEY)) || null; }catch{return null;}
    };
    const saveDraft = debounce(()=>{
      const draft = {
        date: planDate.value || todayISO(),
        rows: getRowsPayload(true) // include invalid for restore
      };
      localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
    }, 300);
    const clearDraft = ()=> localStorage.removeItem(DRAFT_KEY);

    // ========= Init =========
    (async function init(){
      // fill selects
      histOutcome.innerHTML = ['','(‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)', ...OUTCOMES].map((v,i)=> i===0 ? `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` : `<option>${v}</option>`).join('');
      histChannel.innerHTML = ['‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', ...CHANNELS].map((c,i)=> `<option value="${i===0?'':c}">${i===0?'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î':c}</option>`).join('');

      // history default range: last 14 days
      const to = todayISO();
      const from = new Date(Date.now() - 13*24*3600*1000).toISOString().slice(0,10);
      histFrom.value = from;
      histTo.value = to;

      await loadCustomers();
      buildCustomerDatalist();

      // restore draft if any
      const draft = loadDraft();
      newPlanCard.style.display = 'block';
      planDate.value = draft?.date || todayISO();
      updatePlanTitle();
      if(draft?.rows?.length){
        draft.rows.forEach(addRowFromDraft);
      }else{
        addEmptyRow();
      }

      // initial history
      await reloadHistory();

      // KPIs (optional quick calc from history loaded)
      updateKPIsFromHistoryCache();
    })();

    async function loadCustomers(){
      try{
        const res = await fetch('/api/customers');
        const data = await res.json();
        customers = Array.isArray(data) ? data : [];
        customers.forEach(c=>{
          const opd = pad4(c.opd);
          const phone = String(c.phone||'');
          const name = String(c.name||'').trim();
          const label = name ? `${name} ‚Äî ${opd}${phone?` / ${phone}`:''}` : opd;
          customerIndex.set(label, {opd, name, phone});
          customerByOPD.set(opd, {opd, name, phone});
        });
      }catch{
        showToast('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
      }
    }
    function buildCustomerDatalist(){
      const dl = $('#customerList');
      dl.innerHTML = Array.from(customerIndex.keys()).sort((a,b)=>a.localeCompare(b,'th')).map(k=> `<option value="${k}"></option>`).join('');
    }

    function updatePlanTitle(){
      const d = planDate.value || todayISO();
      planTitle.textContent = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£ Sale Pitch ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${fmtThaiDate(d)}`;
    }

    // ========= Plan Rows =========
    function addEmptyRow(){
      const idx = planTbody.children.length + 1;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="text-align:center; color:#64748b;">${idx}</td>
        <td>
          <input class="input input-cust" list="customerList" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ / OPD / ‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">
          <div class="cust-meta" style="font-size:11px; color:#64748b; margin-top:4px;"></div>
        </td>
        <td class="hide-sm"><input class="input input-promo" placeholder="‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠"></td>
        <td>
          <select class="input sel-outcome">
            ${OUTCOMES.map(o=> `<option>${o}</option>`).join('')}
          </select>
        </td>
        <td class="hide-sm"><input class="input input-note" placeholder="‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></td>
        <td class="hide-sm">
          <select class="input sel-channel">
            ${CHANNELS.map(c=> `<option value="${c}">${c}</option>`).join('')}
          </select>
        </td>
        <td>
          <div class="row-actions">
            <button class="btn btn-icon btn-ghost" title="‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß" data-row-del>üóëÔ∏è</button>
          </div>
        </td>
      `;
      planTbody.appendChild(tr);

      // events
      const custInput = tr.querySelector('.input-cust');
      const meta = tr.querySelector('.cust-meta');
      custInput.addEventListener('change', ()=>{
        const picked = customerIndex.get(custInput.value.trim());
        if(picked){
          meta.textContent = `OPD ${picked.opd}${picked.phone?` ‚Ä¢ ${picked.phone}`:''}`;
          tr.dataset.opd = picked.opd;
          custInput.classList.remove('invalid');
        }else{
          meta.textContent = '';
          tr.dataset.opd = '';
          custInput.classList.add('invalid');
        }
        saveDraft();
      });
      $$('.input, select', tr).forEach(el=> el.addEventListener('input', saveDraft));

      tr.querySelector('[data-row-del]').addEventListener('click', ()=>{
        tr.remove();
        reindexRows();
        saveDraft();
        if(!planTbody.children.length) addEmptyRow();
      });
    }

    function addRowFromDraft(row){
      addEmptyRow();
      const tr = planTbody.lastElementChild;
      const custInput = tr.querySelector('.input-cust');
      const meta = tr.querySelector('.cust-meta');
      // attempt to map back
      if(row.opd && customerByOPD.has(row.opd)){
        const c = customerByOPD.get(row.opd);
        const label = `${c.name||c.opd} ‚Äî ${c.opd}${c.phone?` / ${c.phone}`:''}`;
        custInput.value = label;
        tr.dataset.opd = c.opd;
        meta.textContent = `OPD ${c.opd}${c.phone?` ‚Ä¢ ${c.phone}`:''}`;
      }else if(row.customer_label){
        custInput.value = row.customer_label;
        const picked = customerIndex.get(row.customer_label);
        if(picked){
          tr.dataset.opd = picked.opd;
          meta.textContent = `OPD ${picked.opd}${picked.phone?` ‚Ä¢ ${picked.phone}`:''}`;
        }
      }
      tr.querySelector('.input-promo').value = row.promotion||'';
      tr.querySelector('.sel-outcome').value = row.outcome||OUTCOMES[0];
      tr.querySelector('.input-note').value = row.content||'';
      tr.querySelector('.sel-channel').value = row.channel||'call';
    }

    function reindexRows(){
      $$('#planTbody > tr').forEach((tr,i)=> tr.firstElementChild.textContent = String(i+1));
    }

    function getRowsPayload(includeInvalid=false){
      const date = planDate.value || todayISO();
      const rows = [];
      $$('#planTbody > tr').forEach(tr=>{
        const opd = tr.dataset.opd || '';
        const customer_label = tr.querySelector('.input-cust').value.trim();
        const promotion = tr.querySelector('.input-promo')?.value.trim() || '';
        const outcome = tr.querySelector('.sel-outcome')?.value || '';
        const content = tr.querySelector('.input-note')?.value.trim() || '';
        const channel = tr.querySelector('.sel-channel')?.value || 'call';
        const valid = !!opd && !!outcome;
        if(valid || includeInvalid){
          rows.push({ date, opd, promotion, outcome, content, channel, customer_label });
        }
      });
      return rows;
    }

    // ========= Events: Plan section =========
    newPlanBtn.addEventListener('click', ()=>{
      newPlanCard.style.display = 'block';
      if(!planDate.value) planDate.value = todayISO();
      updatePlanTitle();
      showToast('‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà');
    });
    planDate.addEventListener('change', ()=>{ updatePlanTitle(); saveDraft(); });

    addRowBtn.addEventListener('click', ()=>{ addEmptyRow(); });

    clearDraftBtn.addEventListener('click', ()=>{
      if(confirm('‡∏•‡πâ‡∏≤‡∏á Draft ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){
        clearDraft();
        planTbody.innerHTML = '';
        addEmptyRow();
        showToast('‡∏•‡πâ‡∏≤‡∏á Draft ‡πÅ‡∏•‡πâ‡∏ß','warn');
      }
    });

    saveAllBtn.addEventListener('click', async ()=>{
      const rows = getRowsPayload();
      if(!rows.length){ showToast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å','warn'); return; }

      // validate
      const invalids = rows.filter(r=> !r.opd || !r.outcome);
      if(invalids.length){
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô OPD ‡πÉ‡∏ï‡πâ‡∏ä‡πà‡∏≠‡∏á) ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå','warn');
        // highlight invalid inputs
        $$('#planTbody > tr').forEach(tr=>{
          const custInput = tr.querySelector('.input-cust');
          if(!tr.dataset.opd) custInput.classList.add('invalid');
        });
        return;
      }

      saveAllBtn.disabled = true; saveAllBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      try{
        const res = await fetch('/api/add_pitches_bulk', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(rows.map(r=>({
            date: r.date,
            opd: r.opd,
            promotion: r.promotion,
            outcome: r.outcome,
            content: r.content,
            channel: r.channel
          })))
        });
        const d = await res.json();
        if(res.ok){
          showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${d.inserted||rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚úÖ`);
          // clear success rows; keep failed if any
          planTbody.innerHTML = '';
          addEmptyRow();
          clearDraft();
          // refresh history + KPI
          await reloadHistory();
          updateKPIsFromHistoryCache();
        }else{
          showToast(d.error||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
        }
      }catch(e){
        showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ','error');
      }finally{
        saveAllBtn.disabled = false; saveAllBtn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
      }
    });

    // ========= History =========
    let historyCache = []; // flat list of items within range

    async function reloadHistory(){
      const from = histFrom.value || todayISO();
      const to = histTo.value || todayISO();
      const q = (histQ.value||'').trim();
      const outcome = histOutcome.value || '';
      const channel = histChannel.value || '';

      historyWrap.innerHTML = '<div style="padding:12px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
      try{
        const url = new URL('/api/pitches_by_date', window.location.origin);
        url.searchParams.set('from', from);
        url.searchParams.set('to', to);
        if(q) url.searchParams.set('q', q);
        if(outcome) url.searchParams.set('outcome', outcome);
        if(channel) url.searchParams.set('channel', channel);

        const res = await fetch(url);
        const list = await res.json();
        if(!Array.isArray(list)) throw new Error('invalid');
        historyCache = list;

        // group by date (YYYY-MM-DD)
        const groups = new Map();
        for(const x of list){
          const d = (x.created_at||x.date||'').slice(0,10);
          if(!groups.has(d)) groups.set(d, []);
          groups.get(d).push(x);
        }
        // sort day desc
        const days = Array.from(groups.keys()).sort((a,b)=> b.localeCompare(a));
        // render
        const frag = document.createDocumentFragment();
        days.forEach(day=>{
          const items = groups.get(day).sort((a,b)=> (b.created_at||'').localeCompare(a.created_at||''));
          const card = renderDayCard(day, items);
          frag.appendChild(card);
        });
        historyWrap.innerHTML = '';
        historyWrap.appendChild(frag);
        if(!days.length){
          historyWrap.innerHTML = '<div style="padding:12px; color:#64748b;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</div>';
        }
      }catch{
        historyWrap.innerHTML = '<div style="padding:12px; color:#b91c1c;">‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API /api/pitches_by_date)</div>';
      }
    }

    function renderDayCard(dayISO, items){
      const div = document.createElement('div');
      div.className = 'day-card';
      const total = items.length;
      const opened = (dayISO === todayISO()); // today open by default
      div.innerHTML = `
        <div class="day-head" data-toggle>
          <div class="day-title">${fmtThaiDate(dayISO)}</div>
          <div class="day-meta">
            <span class="badge">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total}</span>
          </div>
        </div>
        <div class="day-body ${opened?'open':''}">
          <div class="history-row history-head">
            <div>‡πÄ‡∏ß‡∏•‡∏≤</div><div>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div><div class="hide-sm">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</div><div>Outcome</div><div class="hide-sm">‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</div><div class="hide-sm">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</div>
          </div>
          ${items.map(x=>{
            const time = (x.created_at||'').slice(11,16);
            const opd = pad4(x.opd||'');
            const name = x.customer_name || (customerByOPD.get(opd)?.name) || opd;
            const promo = x.promotion || '';
            const outcome = x.outcome || '';
            const content = (x.content||'').replace(/</g,'&lt;');
            const channel = x.channel || '';
            return `
              <div class="history-row">
                <div>${time||'-'}</div>
                <div>${name} <span style="color:#64748b;">‚Ä¢ OPD ${opd}</span></div>
                <div class="hide-sm">${promo||'‚Äî'}</div>
                <div><span class="outcome-badge">${outcome||'-'}</span></div>
                <div class="hide-sm">${content||'‚Äî'}</div>
                <div class="hide-sm">${channel||'-'}</div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      div.querySelector('[data-toggle]').addEventListener('click', ()=>{
        div.querySelector('.day-body').classList.toggle('open');
      });
      return div;
    }

    // history controls
    reloadHistoryBtn.addEventListener('click', reloadHistory);
    histFrom.addEventListener('change', reloadHistory);
    histTo.addEventListener('change', reloadHistory);
    histQ.addEventListener('input', debounce(reloadHistory, 400));
    histOutcome.addEventListener('change', reloadHistory);
    histChannel.addEventListener('change', reloadHistory);

    toggleAllBtn.addEventListener('click', ()=>{
      $$('#historyWrap .day-body').forEach(b=> b.classList.toggle('open'));
    });

    exportCsvBtn.addEventListener('click', ()=>{
      if(!historyCache.length){ showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å','warn'); return; }
      const header = ['date','time','opd','name','promotion','outcome','content','channel'];
      const lines = [header.join(',')];
      for(const x of historyCache){
        const d = (x.created_at||x.date||'').slice(0,10);
        const t = (x.created_at||'').slice(11,19);
        const opd = pad4(x.opd||'');
        const name = (x.customer_name || customerByOPD.get(opd)?.name || '').replaceAll('"','""');
        const promo = String(x.promotion||'').replaceAll('"','""');
        const outcome = String(x.outcome||'').replaceAll('"','""');
        const content = String(x.content||'').replaceAll('"','""');
        const channel = String(x.channel||'').replaceAll('"','""');
        const esc = v=> `"${v}"`;
        lines.push([d,t,opd,name,promo,outcome,content,channel].map(esc).join(','));
      }
      const csv = lines.join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
      a.download = `pitches_${histFrom.value||''}_${histTo.value||''}.csv`;
      a.click(); URL.revokeObjectURL(a.href);
      showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV ‡πÅ‡∏•‡πâ‡∏ß');
    });

    // ========= KPIs (basic from history cache) =========
    function updateKPIsFromHistoryCache(){
      const today = todayISO();
      const now = new Date();
      const startOfWeek = new Date(now); // assume Mon as start? use 7-day window instead for simplicity
      const dow = now.getDay(); // 0 Sun..6 Sat
      const diffToMon = (dow + 6) % 7;
      startOfWeek.setDate(now.getDate() - diffToMon);
      const sow = startOfWeek.toISOString().slice(0,10);
      const som = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0,10);

      let t=0,w=0,m=0;
      for(const x of historyCache){
        const d = (x.created_at||x.date||'').slice(0,10);
        if(d===today) t++;
        if(d>=sow) w++;
        if(d>=som) m++;
      }
      kpiToday.textContent = t;
      kpiWeek.textContent = w;
      kpiMonth.textContent = m;
    }
  </script>

{% endblock %}

  {# ‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡πâ‡∏≤‡∏¢ <body> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô #}
  {% include "floating_menu.html" %}
</body>
</html>
