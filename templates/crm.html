<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>{% block title %}CRM ‚Äî Customer Intelligence{% endblock %}</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700;800&display=swap" rel="stylesheet">

  {% block head %}
  <style>
    :root{
      --bg:#f7faf9; --card:#ffffff; --muted:#6b7280; --text:#0f172a;
      --primary:#0ea5a4; --primary-600:#0c8e8d; --ring:#9fe8e7;
      --line:#e5e7eb; --danger:#ef4444; --warn:#f59e0b; --success:#22c55e;
      --radius:16px;
      --shadow: 0 10px 28px rgba(2,8,23,.06);
      --shadow-2: 0 18px 46px rgba(2,8,23,.12);
      --appbar-h:60px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Prompt','Segoe UI',sans-serif;
      margin:0;
      color:var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, rgba(14,165,164,.12), transparent 60%),
                  radial-gradient(900px 500px at 110% 0%, rgba(245,158,11,.10), transparent 50%),
                  var(--bg);
      font-size:12px;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    /* ===== Appbar ===== */
    .appbar{
      position:sticky; top:0; z-index:70;
      backdrop-filter: blur(10px);
      background: color-mix(in oklab, var(--bg) 72%, white 28%);
      border-bottom:1px solid var(--line);
    }
    .appbar-inner{
      max-width:1360px;
      margin:0 auto;
      padding:10px 14px 12px;
      min-height:var(--appbar-h);
      display:flex; align-items:center; gap:10px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
      font-size: clamp(16px, 2.4vw, 22px);
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .brand small{
      font-weight:700;
      color:var(--muted);
      font-size:12px;
    }
    .spacer{flex:1}

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow: 0 6px 18px rgba(2,8,23,.04);
      white-space:nowrap;
      font-weight:700;
    }
    .pill strong{font-weight:900}
    .pill .dot{width:8px;height:8px;border-radius:999px;background:var(--primary);}

    /* ===== Top tabs (4 tabs on top) ===== */
    /* 1. ‡πÅ‡∏Å‡πâ‡∏ó‡∏µ‡πà .tabs-wrap ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö 4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
.tabs-wrap {
    width: 100%;
    display: grid;
    /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö 4 ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏™‡∏°‡∏≠ */
    grid-template-columns: repeat(4, minmax(0, 1fr)) !important; 
    gap: 10px;
    margin-top: 6px;
}

/* 2. ‡πÅ‡∏Å‡πâ‡∏ó‡∏µ‡πà .tab-btn ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡πâ‡∏ß */
.tab-btn {
    width: 100%;
    border: 1px solid var(--line);
    background: #fff;
    border-radius: 16px;
    padding: 10px 4px; /* ‡∏•‡∏î padding ‡∏Ç‡πâ‡∏≤‡∏á‡πÜ ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center; /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
    gap: 10px;
    transition: .15s;
    user-select: none;
    box-shadow: 0 6px 18px rgba(2, 8, 23, .04);
}

/* 3. ‡∏•‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Media Query ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
@media (max-width: 1080px) {
    /* ‡∏•‡∏ö .tabs-wrap ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
    .tabs-wrap { grid-template-columns: repeat(4, minmax(0, 1fr)) !important; } 
}
@media (max-width: 520px) {
    /* ‡∏•‡∏ö .tabs-wrap ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
    .tabs-wrap { grid-template-columns: repeat(4, minmax(0, 1fr)) !important; }
    
    /* ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏°‡∏≤‡∏Å ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏≠ */
    .tab-left b { font-size: 10px !important; }
}

    /* ===== Layout ===== */
    .shell{
      max-width:1360px;
      margin:14px auto 110px;
      padding:0 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      align-items:start;
    }

    /* ===== Main ===== */
    .main{ display:grid; gap:14px; }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff, #fbfbfb);
      flex-wrap:wrap;
    }
    .card-title{
      font-weight:900;
      font-size:14px;
      display:flex; align-items:center; gap:8px;
    }
    .card-sub{
      color:var(--muted);
      font-size:11px;
      margin-top:3px;
    }
    .card-body{ padding:12px 14px; }

    /* ===== Buttons / Inputs ===== */
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      transition:.15s;
    }
    .btn:hover{ box-shadow:0 0 0 3px var(--ring); }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      border-color:transparent;
      background:var(--primary);
      color:#fff;
      box-shadow: 0 12px 28px rgba(14,165,164,.22);
    }
    .btn-primary:hover{ background:var(--primary-600); }
    .btn-danger{
      border-color:transparent;
      background: color-mix(in oklab, var(--danger) 88%, #fff 12%);
      color:#fff;
    }
    .btn-ghost{ background:transparent; }
    .btn-icon{ padding:8px; border-radius:12px; }
    .btn:focus-visible, .input:focus-visible, select:focus-visible, textarea:focus-visible, .tab-btn:focus-visible{
      outline:none; box-shadow:0 0 0 3px var(--ring);
    }

    .grid{ display:grid; gap:10px; }
    .grid.kpis{ grid-template-columns: repeat(4, minmax(0,1fr)); }
    .kpi{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      background: linear-gradient(180deg, #fff, #fbfbfb);
      display:flex; flex-direction:column; gap:6px;
      min-height:74px;
    }
    .kpi .label{ color:var(--muted); font-weight:800; font-size:11px; }
    .kpi .value{ font-weight:1000; font-size:18px; letter-spacing:.2px; }
    .kpi .hint{ color:var(--muted); font-size:10px; }

    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:end;
    }
    .field{ display:grid; gap:4px; }
    .field label{ font-weight:900; font-size:11px; color:#334155; }
    .input, select, textarea{
      width:100%;
      padding:9px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      font-size:12px;
      outline:none;
    }
    textarea{ min-height:80px; resize:vertical; }
    .invalid{ border-color: var(--danger) !important; box-shadow: 0 0 0 3px color-mix(in oklab, var(--danger) 18%, transparent 82%); }

    /* ===== Table ===== */
    .table-wrap{ overflow:auto; border-radius:14px; border:1px solid var(--line); }
    table{ width:100%; border-collapse:separate; border-spacing:0; min-width:980px; background:#fff; }
    thead th{
      position:sticky; top:0; z-index:1;
      background: #f0fdfa;
      color:#0f766e;
      font-weight:1000;
      font-size:11px;
      text-align:left;
      padding:9px 10px;
      border-bottom:1px solid var(--line);
      white-space:nowrap;
    }
    tbody td{
      padding:9px 10px;
      border-bottom:1px solid color-mix(in oklab, var(--line) 85%, #fff 15%);
      vertical-align:top;
      font-size:12px;
    }
    tbody tr:hover td{ background:#fbfbfb; }
    .right{text-align:right}

    /* ===== Badges ===== */
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      border-radius:999px;
      border:1px solid var(--line);
      padding:3px 8px;
      font-weight:1000;
      font-size:11px;
      background:#fff;
      white-space:nowrap;
    }
    .b-green{ background: color-mix(in oklab, var(--success) 10%, #fff 90%); border-color: color-mix(in oklab, var(--success) 30%, var(--line) 70%); color:#065f46; }
    .b-amber{ background: color-mix(in oklab, var(--warn) 12%, #fff 88%); border-color: color-mix(in oklab, var(--warn) 35%, var(--line) 65%); color:#92400e; }
    .b-red{ background: color-mix(in oklab, var(--danger) 10%, #fff 90%); border-color: color-mix(in oklab, var(--danger) 30%, var(--line) 70%); color:#7f1d1d; }
    .b-slate{ background:#f1f5f9; border-color:#e2e8f0; color:#334155; }
    .mono{ font-variant-numeric: tabular-nums; font-feature-settings:"tnum"; }

    .link{
      color:var(--primary-600);
      font-weight:1000;
      cursor:pointer;
      text-decoration:none;
    }
    .link:hover{ text-decoration:underline; }

    /* ===== Plan rows ===== */
    .plan-rows{ display:grid; gap:10px; }
    .plan-row{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px;
      background:#fff;
      display:grid;
      gap:10px;
      grid-template-columns: 1.2fr 1fr 1fr .9fr auto;
      align-items:start;
    }
    .plan-row .meta{ font-size:10px; color:var(--muted); margin-top:4px; }
    .plan-row .row-actions{ display:flex; gap:8px; justify-content:flex-end; align-items:center; }

    /* ===== Sticky action bar ===== */
    .actionbar{
      position:sticky;
      bottom:12px;
      z-index:60;
      display:flex;
      justify-content:center;
      pointer-events:none;
    }
    .actionbar-inner{
      pointer-events:auto;
      width:min(920px, 100%);
      background: color-mix(in oklab, white 82%, var(--bg) 18%);
      border:1px solid var(--line);
      box-shadow: var(--shadow-2);
      border-radius:999px;
      padding:10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .actionbar-left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .actionbar-right{ display:flex; align-items:center; gap:8px; }

    /* ===== Toast ===== */
    .toast-wrap{
      position:fixed; right:12px; bottom:12px;
      display:grid; gap:8px; z-index:200;
    }
    .toast{
      background:#fff;
      border:1px solid var(--line);
      border-left:5px solid var(--success);
      padding:9px 10px;
      border-radius:14px;
      min-width:240px;
      box-shadow: 0 14px 36px rgba(2,8,23,.16);
      display:flex; gap:8px; font-size:12px;
    }
    .toast.warn{ border-left-color:var(--warn); }
    .toast.error{ border-left-color:var(--danger); }

    /* ===== Modal ===== */
    #customer-modal{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background:rgba(2,8,23,.48);
      z-index:300;
    }
    #customer-modal .panel{
      width:min(980px, 94vw);
      max-height:86vh;
      overflow:auto;
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: 0 26px 72px rgba(2,8,23,.36);
      position:relative;
    }
    .modal-head{
      position:sticky; top:0; z-index:2;
      background: linear-gradient(180deg, #fff, #fbfbfb);
      border-bottom:1px solid var(--line);
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .modal-title{ font-weight:1000; font-size:15px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .modal-tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .modal-tab{
      border:1px solid var(--line);
      background:#fff;
      padding:7px 10px;
      border-radius:999px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      font-size:11px;
    }
    .modal-tab.active{
      border-color:transparent;
      background: color-mix(in oklab, var(--primary) 18%, #fff 82%);
      box-shadow: 0 10px 22px rgba(14,165,164,.18);
    }
    .modal-body{ padding:12px 14px; }
    .mini-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    .mini{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      background:#fff;
    }
    .mini .k{ color:var(--muted); font-weight:900; font-size:11px; }
    .mini .v{ font-weight:1000; font-size:16px; margin-top:6px; }
    .mini .s{ color:var(--muted); font-size:10px; margin-top:4px; }

    /* ===== History summary (per page) ===== */
    .hist-summary{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .hist-summary-left{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pager{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pager .mono{ font-weight:1000; }

    /* ===== Responsive ===== */
    @media (max-width: 1080px){
      .grid.kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .plan-row{ grid-template-columns: 1fr; }
      .mini-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      table{ min-width:980px; }
      .tabs-wrap{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 520px){
      .grid.kpis{ grid-template-columns: 1fr; }
      .actionbar-inner{ border-radius:18px; }
      .mini-grid{ grid-template-columns: 1fr; }
      .tabs-wrap{ grid-template-columns: 1fr; }
    }
  </style>
  {% endblock %}
</head>

<body>
{% block content %}

  <div class="appbar">
    <div class="appbar-inner">
      <div class="brand"> Sales Pitch</small></div>

      <div class="pill" title="‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î">
        <span class="dot"></span> <span id="lastSyncText">Sync: ‚Äî</span>
      </div>

      <div class="spacer"></div>

      <button class="btn btn-ghost" id="btnRefreshAll" type="button">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>

      <!-- ‚úÖ 4 ‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô (‡πÅ‡∏ó‡∏ô sidebar) -->
      <div class="tabs-wrap" id="topTabs">
    <button class="tab-btn active" data-view="plan" type="button">
        <div class="tab-left"><b>üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£</b></div>
        </button>

    <button class="tab-btn" data-view="dashboard" type="button">
        <div class="tab-left"><b>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</b></div>
        </button>

    <button class="tab-btn" data-view="customers" type="button">
        <div class="tab-left"><b>üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</b></div>
        </button>

    <button class="tab-btn" data-view="history" type="button">
        <div class="tab-left"><b>üï∞Ô∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£</b></div>
        </button>
</div>

  <div class="shell">
    <main class="main">

      <!-- ===================== CALL LOG (was PLAN) ===================== -->
      <section class="card" data-view-panel="plan">
        <div class="card-head">
          <div>
            <div class="card-title">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£</div>
                      </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <div class="badge b-slate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span class="mono" id="planTitleDate">‚Äî</span></div>
            <button class="btn" id="btnClearDraft" type="button">üßπ ‡∏•‡πâ‡∏≤‡∏á Draft</button>
          </div>
        </div>

        <div class="card-body">
          <div class="filters">
            <div class="field" style="min-width:200px;">
              <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
              <input class="input" type="date" id="planDate">
            </div>
            <div class="field" style="min-width:260px;">
              <label>‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</label>
              <input class="input" type="text" id="planDefaultPromo" placeholder=>
            </div>
            <div class="field" style="min-width:260px;">
              <label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</label>
              <select class="input" id="planDefaultChannel"></select>
            </div>
            <div style="display:flex; gap:8px; align-items:flex-end;">
              <button class="btn" id="btnAddRow" type="button">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
              <button class="btn btn-primary" id="btnSaveBulk" type="button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
          </div>

          <div style="height:12px;"></div>

          <datalist id="customerList"></datalist>
          <div class="plan-rows" id="planRows"></div>

          <!-- ‚úÖ TODAY SUMMARY (‡πÉ‡∏ï‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£) -->
          <div style="height:14px;"></div>

          <section class="card" style="box-shadow:none;">
            <div class="card-head">
              <div>
                <div class="card-title">üßæ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                <span class="badge b-slate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span class="mono" id="todaySummaryDate">‚Äî</span></span>
                <button class="btn" id="btnReloadTodaySummary" type="button">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
              </div>
            </div>

            <div class="card-body">
              <div class="grid kpis" style="grid-template-columns: repeat(4, minmax(0,1fr));" id="todayKpis"></div>

              <div style="height:12px;"></div>

              <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="card" style="box-shadow:none;">
                  <div class="card-head">
                    
                  </div>
                  <div class="card-body" id="todayStats"></div>
                </div>

                <div class="card" style="box-shadow:none;">
                  <div class="card-head">
                    
                  </div>
                  <div class="card-body" id="todayPromoTop"></div>
                </div>
              </div>

              <div style="height:12px;"></div>

              <div class="table-wrap">
                <table style="min-width:980px;">
                  <thead>
                    <tr>
                      <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                      <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                      <th>‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</th>
                      <th>Outcome</th>
                      <th>‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</th>
                      <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                    </tr>
                  </thead>
                  <tbody id="todaySummaryTbody"></tbody>
                </table>
              </div>
            </div>
          </section>
          <!-- ‚úÖ /TODAY SUMMARY -->

          <div class="actionbar">
            <div class="actionbar-inner">
              <div class="actionbar-left">
                <span class="badge b-slate">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: <span class="mono" id="planCount">0</span></span>
                <span class="badge b-slate">Valid: <span class="mono" id="planValid">0</span></span>
                <span class="badge b-slate">Draft: <span class="mono" id="planDraftStatus">‚Äî</span></span>
              </div>
              <div class="actionbar-right">
                <button class="btn" id="btnAddRow2" type="button">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
                <button class="btn btn-primary" id="btnSaveBulk2" type="button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- ===================== SUMMARY (was DASHBOARD) ===================== -->
      <section class="card" data-view-panel="dashboard" style="display:none;">
        <div class="card-head">
          <div>
            <div class="card-title">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            <div class="card-sub">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å: /api/customers + /api/pitches_by_date + /api/reccord_sale</div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <div class="badge b-slate">‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì: <span class="mono" id="dashRange">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span></div>
            <button class="btn" id="btnExportCustomersCsv" type="button">üì¶ Export ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ CSV</button>
          </div>
        </div>

        <div class="card-body">
          <div class="grid kpis">
            <div class="kpi">
              <div class="label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
              <div class="value mono" id="kpiCustomers">0</div>
              <div class="hint">‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å /api/customers (OPD)</div>
            </div>
            <div class="kpi">
              <div class="label">‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£/‡∏û‡∏¥‡∏ï‡∏ä‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
              <div class="value mono" id="kpiPitches">0</div>
              <div class="hint">‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å /api/pitches_by_date</div>
            </div>
            <div class="kpi">
              <div class="label">‡∏™‡∏ô‡πÉ‡∏à (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</div>
              <div class="value mono" id="kpiInterested">0</div>
              <div class="hint">Outcome ‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‚Äú‡∏™‡∏ô‡πÉ‡∏à‚Äù</div>
            </div>
            <div class="kpi">
              <div class="label">Conversion Score</div>
              <div class="value mono" id="kpiConvScore">‚Äî</div>
              <div class="hint">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ô‡πÉ‡∏à + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà + recency</div>
            </div>
          </div>

          <div style="height:12px;"></div>

          <div class="filters">
            <div class="field" style="min-width:180px;">
              <label>‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (History/Pitch)</label>
              <div style="display:flex; gap:8px;">
                <input class="input" type="date" id="dashFrom">
                <input class="input" type="date" id="dashTo">
              </div>
            </div>
            <div class="field" style="min-width:220px;">
              <label>Filter: Segment</label>
              <select id="dashSegment" class="input">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="VIP">VIP (‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á)</option>
                <option value="ACTIVE">Active (‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏™‡∏ô‡πÉ‡∏à)</option>
                <option value="WARM">Warm (‡∏û‡∏≠‡∏°‡∏µ‡∏´‡∏ß‡∏±‡∏á)</option>
                <option value="COLD">Cold (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡∏á)</option>
                <option value="STOP">Stop (‡∏Ñ‡∏ß‡∏£‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏≤‡∏°)</option>
              </select>
            </div>
            <div class="field" style="min-width:240px;">
              <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠/OPD/‡πÄ‡∏ö‡∏≠‡∏£‡πå)</label>
              <input class="input" id="dashQ" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0123 / ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ / 08x">
            </div>
            <div style="display:flex; gap:8px; align-items:flex-end;">
              <button class="btn" id="btnApplyDash" type="button">‚úÖ ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
              <button class="btn btn-ghost" id="btnResetDash" type="button">‚Ü©Ô∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
            </div>
          </div>

          <div style="height:12px;"></div>

          <div class="grid" style="grid-template-columns: 1.4fr 1fr; align-items:start;">
            <div class="card" style="box-shadow:none;">
              <div class="card-head">
                <div class="card-title">üìà Outcome Distribution</div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <span class="badge b-slate">Top 8</span>
                </div>
              </div>
              <div class="card-body">
                <canvas id="chartOutcomes" height="120"></canvas>
              </div>
            </div>

            <div class="card" style="box-shadow:none;">
              <div class="card-head">
                <div class="card-title">üî• Follow-up Funnel</div>
                <div class="card-sub">‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° ‚Äú‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‚Äù (Priority Score)</div>
              </div>
              <div class="card-body">
                <canvas id="chartFunnel" height="120"></canvas>
                <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                  <span class="badge b-green">Hot</span>
                  <span class="badge b-amber">Warm</span>
                  <span class="badge b-slate">Cold</span>
                  <span class="badge b-red">Stop</span>
                </div>
              </div>
            </div>
          </div>

          <div style="height:12px;"></div>

          <div class="card" style="box-shadow:none;">
            <div class="card-head">
              <div class="card-title">üéØ Top Priority (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÇ‡∏ó‡∏£‡∏Å‡πà‡∏≠‡∏ô)</div>
              <div class="card-sub">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å: Recency + Interest signal + Call attempts + Purchase value</div>
            </div>
            <div class="card-body">
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                      <th>Segment</th>
                      <th class="right">Priority</th>
                      <th class="right">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ß‡∏°</th>
                      <th class="right">‡πÇ‡∏ó‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                      <th>Outcome ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                      <th class="right">‡πÇ‡∏ó‡∏£‡πÅ‡∏•‡πâ‡∏ß</th>
                      <th>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</th>
                    </tr>
                  </thead>
                  <tbody id="dashTopTbody"></tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- ===================== CUSTOMERS ===================== -->
      <section class="card" data-view-panel="customers" style="display:none;">
        <div class="card-head">
          <div>
            <div class="card-title">üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Pitch ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</div>
            <div class="card-sub">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: Pitch ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÉ‡∏´‡∏°‡πà ‚Üí ‡πÄ‡∏Å‡πà‡∏≤ (‡∏Å‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå)</div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn" id="btnExportCustomersCsv2" type="button">üì¶ Export CSV</button>
          </div>
        </div>

        <div class="card-body">
          <div class="filters">
            <div class="field" style="min-width:240px;">
              <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
              <input class="input" id="custQ" placeholder="‡∏ä‡∏∑‡πà‡∏≠/OPD/‡πÄ‡∏ö‡∏≠‡∏£‡πå">
            </div>
            <div class="field" style="min-width:210px;">
              <label>Segment</label>
              <select class="input" id="custSegment">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="VIP">VIP</option>
                <option value="ACTIVE">Active</option>
                <option value="WARM">Warm</option>
                <option value="COLD">Cold</option>
                <option value="STOP">Stop</option>
              </select>
            </div>
            <div class="field" style="min-width:210px;">
              <label>‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°</label>
              <select class="input" id="custSort">
                <option value="last_pitch_desc">Pitch ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÉ‡∏´‡∏°‡πà ‚Üí ‡πÄ‡∏Å‡πà‡∏≤</option>
                <option value="priority_desc">Priority ‡∏°‡∏≤‡∏Å ‚Üí ‡∏ô‡πâ‡∏≠‡∏¢</option>
                <option value="value_desc">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠ ‡∏°‡∏≤‡∏Å ‚Üí ‡∏ô‡πâ‡∏≠‡∏¢</option>
                <option value="attempts_desc">‡πÇ‡∏ó‡∏£‡πÅ‡∏•‡πâ‡∏ß ‡∏°‡∏≤‡∏Å ‚Üí ‡∏ô‡πâ‡∏≠‡∏¢</option>
              </select>
            </div>
            <div class="field" style="min-width:210px;">
              <label>‡πÅ‡∏™‡∏î‡∏á</label>
              <select class="input" id="custLimit">
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
                <option value="999999">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              </select>
            </div>
            <div style="display:flex; gap:8px; align-items:flex-end;">
              <button class="btn" id="btnApplyCustomers" type="button">‚úÖ ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
              <button class="btn btn-ghost" id="btnResetCustomers" type="button">‚Ü©Ô∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
            </div>
          </div>

          <div style="height:12px;"></div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                  <th>Segment</th>
                  <th class="right">Priority</th>
                  <th class="right">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ß‡∏°</th>
                  <th class="right">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
                  <th class="right">‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ã‡∏∑‡πâ‡∏≠</th>
                  <th class="right">Pitch ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                  <th>Outcome ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                  <th class="right">‡πÇ‡∏ó‡∏£‡πÅ‡∏•‡πâ‡∏ß</th>
                </tr>
              </thead>
              <tbody id="custTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ===================== HISTORY ===================== -->
      <section class="card" data-view-panel="history" style="display:none;">
        <div class="card-head">
          <div>
            <div class="card-title">üï∞Ô∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£</div>
            <div class="card-sub">‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô, ‡πÇ‡∏ó‡∏£‡∏Å‡∏µ‡πà‡∏Ñ‡∏ô, ‡∏™‡∏ô‡πÉ‡∏à‡∏Å‡∏µ‡πà‡∏Ñ‡∏ô ‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏•‡πÅ‡∏Ñ‡∏õ‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏î‡πâ)</div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn" id="btnExportHistoryCsv" type="button">üì§ Export History CSV</button>
          </div>
        </div>

        <div class="card-body">
          <div class="filters">
            <div class="field" style="min-width:180px;">
              <label>‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <div style="display:flex; gap:8px;">
                <input class="input" type="date" id="histFrom">
                <input class="input" type="date" id="histTo">
              </div>
            </div>
            <div class="field" style="min-width:240px;">
              <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠/‡πÇ‡∏õ‡∏£/‡πÇ‡∏ô‡πâ‡∏ï)</label>
              <input class="input" id="histQ" placeholder="‡πÄ‡∏ä‡πà‡∏ô Exosome / ‡∏ô‡∏±‡∏î / ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢">
            </div>
            <div class="field" style="min-width:240px;">
              <label>Outcome</label>
              <select class="input" id="histOutcome"></select>
            </div>
            <div class="field" style="min-width:180px;">
              <label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</label>
              <select class="input" id="histChannel"></select>
            </div>
            <div style="display:flex; gap:8px; align-items:flex-end;">
              <button class="btn" id="btnLoadHistory" type="button">üîé ‡πÇ‡∏´‡∏•‡∏î</button>
              <button class="btn btn-ghost" id="btnResetHistory" type="button">‚Ü©Ô∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
            </div>
          </div>

          <div style="height:12px;"></div>

          <!-- ‚úÖ summary ‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ -->
          <div class="hist-summary">
            <div class="hist-summary-left">
              <span class="badge b-slate">‡∏ä‡πà‡∏ß‡∏á: <span class="mono" id="histSummaryRange">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span></span>
              <span class="badge b-slate">‡πÇ‡∏ó‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span class="mono" id="histSummaryCalls">0</span></span>
              <span class="badge b-slate">‡∏™‡∏ô‡πÉ‡∏à: <span class="mono" id="histSummaryInterested">0</span></span>
              <span class="badge b-slate">‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏ó‡∏£: <span class="mono" id="histSummaryUnique">0</span></span>
            </div>
            <div class="pager">
              <button class="btn" id="btnHistPrev" type="button">‚¨ÖÔ∏è ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
              <span class="badge b-slate">‡∏´‡∏ô‡πâ‡∏≤ <span class="mono" id="histPageNow">1</span>/<span class="mono" id="histPageTotal">1</span></span>
              <button class="btn" id="btnHistNext" type="button">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button>
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                  <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                  <th>‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</th>
                  <th>Outcome</th>
                  <th>‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</th>
                  <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                  <th class="right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody id="histTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- ===== Toast ===== -->
  <div class="toast-wrap" id="toastWrap"></div>

  <!-- ===== Customer Modal ===== -->
  <div id="customer-modal" aria-hidden="true">
    <div class="panel" id="customer-modal-box" role="dialog" aria-modal="true" tabindex="-1">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">üìá ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <div class="modal-tabs" id="modalTabs">
            <button class="modal-tab active" data-tab="overview" type="button">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
            <button class="modal-tab" data-tab="pitches" type="button">Sale Pitch</button>
            <button class="modal-tab" data-tab="buys" type="button">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ã‡∏∑‡πâ‡∏≠</button>
          </div>
          <button class="btn btn-icon" id="btnModalSaveImg" type="button" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ">üíæ</button>
          <button class="btn btn-icon" id="btnModalClose" type="button" title="‡∏õ‡∏¥‡∏î">‚ùå</button>
        </div>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    // ===================== Utils =====================
    const $ = (q, p=document)=>p.querySelector(q);
    const $$ = (q, p=document)=>Array.from(p.querySelectorAll(q));
    const toastWrap = $('#toastWrap');

    const showToast = (msg, type='ok')=>{
      const el = document.createElement('div');
      el.className = 'toast' + (type==='warn' ? ' warn' : type==='error' ? ' error' : '');
      el.innerHTML = `<div>üí°</div><div>${msg}</div>`;
      toastWrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; }, 2400);
      setTimeout(()=>{ el.remove(); }, 3100);
    };

    const esc = s => String(s||'')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#039;");

    const pad4 = s => String(s ?? '').trim().padStart(4,'0');

    const todayISO = ()=> new Date().toISOString().slice(0,10);

    const fmtShortDate = (iso)=>{
      if(!iso) return '-';
      try{
        const d = new Date(iso);
        if(isNaN(d)) return String(iso).slice(0,10);
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yy = String(d.getFullYear()).slice(-2);
        return `${dd}-${mm}-${yy}`;
      }catch{ return String(iso).slice(0,10); }
    };

    const fmtMoney = (n)=>{
      const x = Math.round(Number(n||0));
      return x.toLocaleString();
    };

    const debounce = (fn, ms=300)=>{
      let t;
      return (...a)=>{
        clearTimeout(t);
        t = setTimeout(()=> fn(...a), ms);
      };
    };

    function daysBetween(aISO, bISO){
      const a = new Date(String(aISO||'').slice(0,10));
      const b = new Date(String(bISO||'').slice(0,10));
      if(isNaN(a)||isNaN(b)) return null;
      return Math.floor((b-a)/(1000*60*60*24));
    }

    function nowStamp(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }

    // ===================== Data / Enums =====================
    const OUTCOMES = [
      '‡∏™‡∏ô‡πÉ‡∏à‡πÇ‡∏≠‡∏ô‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏±‡∏î‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
      '‡∏™‡∏ô‡πÉ‡∏à‡πÇ‡∏≠‡∏ô‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ô‡∏±‡∏î‡∏ß‡∏±‡∏ô',
      '‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠',
      '‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ',
      '‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡πÑ‡∏°‡πà‡∏ö‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•',
      '‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á',
      '‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÇ‡∏õ‡∏£‡∏≠‡∏∑‡πà‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤',
      '‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß',
      '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏¥‡∏î',
      '‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢',
      '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á',
    ];
    const CHANNELS = ['call','line','visit','facebook','instagram','other'];

    const isInterested = (outcome)=> /^‡∏™‡∏ô‡πÉ‡∏à/.test(String(outcome||'').trim());
    const isHardReject = (outcome)=> /^‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à/.test(String(outcome||'').trim()) || /‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤/.test(String(outcome||''));

    // ===================== Global state =====================
    let customers = [];                // from /api/customers
    let pitches = [];                  // from /api/pitches_by_date (filtered by range)
    let records = [];                  // from /api/reccord_sale
    let customerIndex = new Map();     // label -> {opd,name,phone}
    let customerByOPD = new Map();     // opd -> {opd,name,phone}
    let recordsByOPD = new Map();      // opd -> [record_sale]
    let pitchesByOPD = new Map();      // opd -> [pitches]
    let analytics = [];                // computed customers analytics objects

    let chartOutcomes = null;
    let chartFunnel = null;

    // History paging
    const HIST_PAGE_SIZE = 50;
    let historyAll = [];
    let histPage = 1;

    // ===================== Elements =====================
    const lastSyncText = $('#lastSyncText');

    

    // Dashboard
    const kpiCustomers = $('#kpiCustomers');
    const kpiPitches = $('#kpiPitches');
    const kpiInterested = $('#kpiInterested');
    const kpiConvScore = $('#kpiConvScore');
    const dashFrom = $('#dashFrom');
    const dashTo = $('#dashTo');
    const dashSegment = $('#dashSegment');
    const dashQ = $('#dashQ');
    const btnApplyDash = $('#btnApplyDash');
    const btnResetDash = $('#btnResetDash');
    const dashRange = $('#dashRange');
    const dashTopTbody = $('#dashTopTbody');
    const btnExportCustomersCsv = $('#btnExportCustomersCsv');

    // Plan
    const planDate = $('#planDate');
    const planTitleDate = $('#planTitleDate');
    const planDefaultPromo = $('#planDefaultPromo');
    const planDefaultChannel = $('#planDefaultChannel');
    const planRows = $('#planRows');
    const planCount = $('#planCount');
    const planValid = $('#planValid');
    const planDraftStatus = $('#planDraftStatus');
    const btnAddRow = $('#btnAddRow');
    const btnAddRow2 = $('#btnAddRow2');
    const btnSaveBulk = $('#btnSaveBulk');
    const btnSaveBulk2 = $('#btnSaveBulk2');
    const btnClearDraft = $('#btnClearDraft');
    const dlCustomers = $('#customerList');

    // ‚úÖ Today summary elements (added)
    const todaySummaryDate = $('#todaySummaryDate');
    const btnReloadTodaySummary = $('#btnReloadTodaySummary');
    const todayKpis = $('#todayKpis');
    const todayStats = $('#todayStats');
    const todayPromoTop = $('#todayPromoTop');
    const todaySummaryTbody = $('#todaySummaryTbody');

    // Customers view
    const custQ = $('#custQ');
    const custSegment = $('#custSegment');
    const custSort = $('#custSort');
    const custLimit = $('#custLimit');
    const btnApplyCustomers = $('#btnApplyCustomers');
    const btnResetCustomers = $('#btnResetCustomers');
    const custTbody = $('#custTbody');
    const btnExportCustomersCsv2 = $('#btnExportCustomersCsv2');

    // History view
    const histFrom = $('#histFrom');
    const histTo = $('#histTo');
    const histQ = $('#histQ');
    const histOutcome = $('#histOutcome');
    const histChannel = $('#histChannel');
    const btnLoadHistory = $('#btnLoadHistory');
    const btnResetHistory = $('#btnResetHistory');
    const histTbody = $('#histTbody');
    const btnExportHistoryCsv = $('#btnExportHistoryCsv');

    const histSummaryRange = $('#histSummaryRange');
    const histSummaryCalls = $('#histSummaryCalls');
    const histSummaryInterested = $('#histSummaryInterested');
    const histSummaryUnique = $('#histSummaryUnique');
    const btnHistPrev = $('#btnHistPrev');
    const btnHistNext = $('#btnHistNext');
    const histPageNow = $('#histPageNow');
    const histPageTotal = $('#histPageTotal');

    // Modal
    const customerModal = $('#customer-modal');
    const customerModalBox = $('#customer-modal-box');
    const modalTitle = $('#modalTitle');
    const modalBody = $('#modalBody');
    const modalTabs = $('#modalTabs');
    const btnModalClose = $('#btnModalClose');
    const btnModalSaveImg = $('#btnModalSaveImg');

    // ===================== Draft (Plan) =====================
    const DRAFT_KEY = 'crm_intel_plan_draft_v3';
    const loadDraft = ()=>{ try{ return JSON.parse(localStorage.getItem(DRAFT_KEY))||null; }catch{return null;} };
    const saveDraft = debounce(()=>{
      const draft = {
        date: planDate.value || todayISO(),
        defaultPromo: planDefaultPromo.value || '',
        defaultChannel: planDefaultChannel.value || 'call',
        rows: getPlanRowsPayload(true)
      };
      localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
      planDraftStatus.textContent = `saved ${nowStamp()}`;
    }, 250);
    const clearDraft = ()=> localStorage.removeItem(DRAFT_KEY);

    // ===================== Fetch helpers =====================
    async function fetchJSON(url, opt){
      const res = await fetch(url, opt);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    // ===================== Index builders =====================
    function buildCustomerIndexes(){
      customerIndex = new Map();
      customerByOPD = new Map();
      for(const c of customers){
        const opd = pad4(c?.opd);
        const phone = String(c?.phone ?? '');
        const name = String(c?.name ?? '').trim();
        const label = name ? `${name} ‚Äî ${opd}${phone?` / ${phone}`:''}` : opd;
        if(label) customerIndex.set(label, {opd, name, phone});
        if(opd) customerByOPD.set(opd, {opd, name, phone});
      }
      const keys = Array.from(customerIndex.keys()).sort((a,b)=> a.localeCompare(b,'th'));
      dlCustomers.innerHTML = keys.map(k=> `<option value="${esc(k)}"></option>`).join('');
    }

    function buildRecordsIndex(){
      recordsByOPD = new Map();
      for(const r of records){
        const opd = pad4(r?.opd);
        if(!opd) continue;
        if(!recordsByOPD.has(opd)) recordsByOPD.set(opd, []);
        recordsByOPD.get(opd).push(r);
      }
      for(const [opd, list] of recordsByOPD.entries()){
        list.sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')));
      }
    }

    function buildPitchesIndex(){
      pitchesByOPD = new Map();
      for(const p of pitches){
        const opd = pad4(p?.opd);
        if(!opd) continue;
        if(!pitchesByOPD.has(opd)) pitchesByOPD.set(opd, []);
        pitchesByOPD.get(opd).push(p);
      }
      for(const [opd, list] of pitchesByOPD.entries()){
        list.sort((a,b)=> String(b.created_at||b.date||'').localeCompare(String(a.created_at||a.date||'')));
      }
    }

    // ===================== Scoring & Segmentation =====================
    const VIP_THRESHOLD = 15000;
    function calcCustomerAnalytics(opd){
      const cust = customerByOPD.get(opd) || {opd, name:opd, phone:''};
      const pitchList = pitchesByOPD.get(opd) || [];
      const recList = recordsByOPD.get(opd) || [];

      const paid = recList.filter(r=> Number(r.amount||0) > 0);
      const totalAmount = paid.reduce((s,r)=> s + Number(r.amount||0), 0);
      const paidVisits = paid.length;
      const avgAmount = paidVisits ? totalAmount/paidVisits : 0;
      const lastBuyDate = recList[0]?.date ? String(recList[0].date).slice(0,10) : '';

      const attempts = pitchList.length;
      const lastPitch = pitchList[0] || null;
      const lastPitchDate = lastPitch ? String(lastPitch.created_at||lastPitch.date||'').slice(0,10) : '';
      const lastOutcome = lastPitch?.outcome || '';
      const everInterested = pitchList.some(p=> isInterested(p.outcome));
      const lastInterestedDate = (()=> {
        const f = pitchList.find(p=> isInterested(p.outcome));
        return f ? String(f.created_at||f.date||'').slice(0,10) : '';
      })();

      const daysSincePitch = lastPitchDate ? daysBetween(lastPitchDate, todayISO()) : null;
      const daysSinceBuy = lastBuyDate ? daysBetween(lastBuyDate, todayISO()) : null;

      let sInterest = 0;
      if(everInterested) sInterest += 18;
      if(isInterested(lastOutcome)) sInterest += 22;
      if(isHardReject(lastOutcome)) sInterest = Math.min(sInterest, 8);

      let sRecency = 0;
      if(daysSincePitch === null) sRecency = 8;
      else{
        if(daysSincePitch < 2) sRecency = 2;
        else if(daysSincePitch < 7) sRecency = 10;
        else if(daysSincePitch <= 21) sRecency = 20;
        else if(daysSincePitch <= 45) sRecency = 14;
        else sRecency = 8;
      }

      let sAttempts = 0;
      if(attempts === 0) sAttempts = 10;
      else if(attempts === 1) sAttempts = 15;
      else if(attempts === 2) sAttempts = 12;
      else if(attempts === 3) sAttempts = 7;
      else sAttempts = 4;

      let sValue = 0;
      if(totalAmount <= 0) sValue = 4;
      else{
        const x = Math.log10(totalAmount + 1);
        sValue = Math.max(6, Math.min(25, Math.round((x - 3) * 12 + 10)));
      }

      let priority = sInterest + sRecency + sAttempts + sValue;
      priority = Math.max(0, Math.min(100, Math.round(priority)));

      const stopByReject = isHardReject(lastOutcome);
      const stopByAttempts = (!everInterested && attempts >= 3);

      let segment = 'COLD';
      if(totalAmount >= VIP_THRESHOLD) segment = 'VIP';
      if(stopByReject || stopByAttempts) segment = 'STOP';
      else if(isInterested(lastOutcome) || (everInterested && attempts < 3)) segment = 'ACTIVE';
      else if(attempts < 3) segment = 'WARM';

      let recommend = '‡πÇ‡∏ó‡∏£‡∏ï‡∏≤‡∏°';
      if(segment === 'STOP') recommend = '‡∏û‡∏±‡∏Å/‡∏´‡∏¢‡∏∏‡∏î';
      else if(segment === 'VIP') recommend = 'VIP follow-up';
      else if(priority >= 70) recommend = '‡πÇ‡∏ó‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
      else if(priority >= 50) recommend = '‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠';
      else recommend = '‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏ó‡∏£';

      let bucket = 'Cold';
      if(segment === 'STOP') bucket = 'Stop';
      else if(priority >= 70) bucket = 'Hot';
      else if(priority >= 50) bucket = 'Warm';
      else bucket = 'Cold';

      return {
        opd,
        name: cust.name || opd,
        phone: cust.phone || '',
        totalAmount,
        paidVisits,
        avgAmount,
        lastBuyDate,
        attempts,
        lastPitchDate,
        lastOutcome,
        everInterested,
        lastInterestedDate,
        daysSincePitch,
        daysSinceBuy,
        priority,
        segment,
        bucket,
        recommend
      };
    }

    function rebuildAnalytics(){
      const opds = new Set();
      for(const c of customers) opds.add(pad4(c?.opd));
      for(const p of pitches) opds.add(pad4(p?.opd));
      for(const r of records) opds.add(pad4(r?.opd));

      analytics = Array.from(opds)
        .filter(Boolean)
        .map(opd => calcCustomerAnalytics(opd));

      analytics.sort((a,b)=> (b.priority - a.priority) || (b.totalAmount - a.totalAmount) || (String(b.lastPitchDate||'').localeCompare(a.lastPitchDate||'')));
    }

    // ===================== Charts =====================
    function buildOutcomeChart(list){
      const freq = new Map();
      for(const p of list){
        const k = String(p.outcome||'').trim() || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)';
        freq.set(k, (freq.get(k)||0) + 1);
      }
      const arr = Array.from(freq.entries()).sort((a,b)=> b[1]-a[1]).slice(0,8);
      const labels = arr.map(x=> x[0]);
      const data = arr.map(x=> x[1]);

      const ctx = document.getElementById('chartOutcomes').getContext('2d');
      if(chartOutcomes) chartOutcomes.destroy();
      chartOutcomes = new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{ label:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', data }] },
        options:{
          responsive:true,
          plugins:{ legend:{ display:false } },
          scales:{
            x:{ ticks:{ maxRotation:0, minRotation:0 } },
            y:{ beginAtZero:true }
          }
        }
      });
    }

    function buildFunnelChart(listAnalytics){
      const buckets = {Hot:0, Warm:0, Cold:0, Stop:0};
      for(const a of listAnalytics){
        buckets[a.bucket] = (buckets[a.bucket]||0) + 1;
      }
      const labels = ['Hot','Warm','Cold','Stop'];
      const data = labels.map(k=> buckets[k]||0);

      const ctx = document.getElementById('chartFunnel').getContext('2d');
      if(chartFunnel) chartFunnel.destroy();
      chartFunnel = new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{ label:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', data }] },
        options:{
          responsive:true,
          plugins:{ legend:{ display:false } },
          scales:{ y:{ beginAtZero:true } }
        }
      });
    }

    // ===================== Rendering =====================
    function segBadge(seg){
      if(seg==='VIP') return `<span class="badge b-green">VIP</span>`;
      if(seg==='ACTIVE') return `<span class="badge b-green">ACTIVE</span>`;
      if(seg==='WARM') return `<span class="badge b-amber">WARM</span>`;
      if(seg==='COLD') return `<span class="badge b-slate">COLD</span>`;
      return `<span class="badge b-red">STOP</span>`;
    }

    function renderRecommend(a){
      if(a.segment==='STOP') return `<span class="badge b-red">‡∏û‡∏±‡∏Å/‡∏´‡∏¢‡∏∏‡∏î</span>`;
      if(a.segment==='VIP') return `<span class="badge b-green">VIP follow-up</span>`;
      if(a.bucket==='Hot') return `<span class="badge b-green">‡πÇ‡∏ó‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>`;
      if(a.bucket==='Warm') return `<span class="badge b-amber">‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠</span>`;
      return `<span class="badge b-slate">‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏ó‡∏£</span>`;
    }

    function filterAnalyticsForDash(list){
      const q = (dashQ.value||'').trim().toLowerCase();
      const seg = dashSegment.value || '';
      let out = list;

      if(seg) out = out.filter(a=> a.segment === seg);
      if(q){
        out = out.filter(a=>{
          return (
            String(a.opd).toLowerCase().includes(q) ||
            String(a.name||'').toLowerCase().includes(q) ||
            String(a.phone||'').toLowerCase().includes(q)
          );
        });
      }
      return out;
    }

    function renderDashboard(){
      
      kpiCustomers.textContent = analytics.length.toString();
      kpiPitches.textContent = pitches.length.toString();
      kpiInterested.textContent = pitches.filter(p=> isInterested(p.outcome)).length.toString();

      const total = pitches.length || 1;
      const interested = pitches.filter(p=> isInterested(p.outcome)).length;
      const rate = interested / total;
      const avgPriority = analytics.length ? analytics.reduce((s,a)=>s+a.priority,0)/analytics.length : 0;
      const conv = Math.round(rate*60 + avgPriority*0.4);
      kpiConvScore.textContent = `${Math.max(0, Math.min(100, conv))}`;

      const f = dashFrom.value || '';
      const t = dashTo.value || '';
      dashRange.textContent = (f||t) ? `${f||'‚Äî'} ‡∏ñ‡∏∂‡∏á ${t||'‚Äî'}` : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';

      buildOutcomeChart(pitches);
      buildFunnelChart(analytics);

      const filtered = filterAnalyticsForDash(analytics);
      const top = filtered.slice(0, 30);

      dashTopTbody.innerHTML = top.map((a, i)=>`
        <tr>
          <td class="mono">${i+1}</td>
          <td>
            <a class="link" data-open-profile="${esc(a.opd)}">${esc(a.name)}</a>
            <div style="color:#64748b; font-size:10px; margin-top:3px;">OPD <span class="mono">${esc(a.opd)}</span>${a.phone?` ‚Ä¢ ${esc(a.phone)}`:''}</div>
          </td>
          <td>${segBadge(a.segment)}</td>
          <td class="right mono"><strong>${a.priority}</strong></td>
          <td class="right mono">${fmtMoney(a.totalAmount)}</td>
          <td class="right mono">${a.lastPitchDate ? fmtShortDate(a.lastPitchDate) : '-'}</td>
          <td>${a.lastOutcome ? `<span class="badge b-slate">${esc(a.lastOutcome)}</span>` : '-'}</td>
          <td class="right mono">${a.attempts}</td>
          <td>${renderRecommend(a)}</td>
        </tr>
      `).join('') || `<tr><td colspan="9" style="padding:14px; color:#64748b;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</td></tr>`;
    }

    function renderCustomersTable(){
      let list = [...analytics];

      const q = (custQ.value||'').trim().toLowerCase();
      const seg = custSegment.value || '';
      const sort = custSort.value || 'last_pitch_desc';
      const limit = parseInt(custLimit.value||'50', 10);

      if(seg) list = list.filter(a=> a.segment === seg);

      if(q){
        list = list.filter(a=>
          String(a.opd).toLowerCase().includes(q) ||
          String(a.name||'').toLowerCase().includes(q) ||
          String(a.phone||'').toLowerCase().includes(q)
        );
      }

      if(sort==='priority_desc') list.sort((a,b)=> (b.priority-a.priority) || (b.totalAmount-a.totalAmount));
      if(sort==='value_desc') list.sort((a,b)=> (b.totalAmount-a.totalAmount) || (b.priority-a.priority));
      if(sort==='last_pitch_desc') list.sort((a,b)=> String(b.lastPitchDate||'').localeCompare(a.lastPitchDate||''));
      if(sort==='attempts_desc') list.sort((a,b)=> (b.attempts-a.attempts) || (b.priority-a.priority));

      const shown = list.slice(0, limit);

      custTbody.innerHTML = shown.map((a,i)=>`
        <tr>
          <td class="mono">${i+1}</td>
          <td>
            <a class="link" data-open-profile="${esc(a.opd)}">${esc(a.name)}</a>
            <div style="color:#64748b; font-size:10px; margin-top:3px;">OPD <span class="mono">${esc(a.opd)}</span>${a.phone?` ‚Ä¢ ${esc(a.phone)}`:''}</div>
          </td>
          <td>${segBadge(a.segment)}</td>
          <td class="right mono"><strong>${a.priority}</strong></td>
          <td class="right mono">${fmtMoney(a.totalAmount)}</td>
          <td class="right mono">${fmtMoney(a.avgAmount)}</td>
          <td class="right mono">${a.lastBuyDate ? fmtShortDate(a.lastBuyDate) : '-'}</td>
          <td class="right mono">${a.lastPitchDate ? fmtShortDate(a.lastPitchDate) : '-'}</td>
          <td>${a.lastOutcome ? `<span class="badge b-slate">${esc(a.lastOutcome)}</span>` : '-'}</td>
          <td class="right mono">${a.attempts}</td>
        </tr>
      `).join('') || `<tr><td colspan="10" style="padding:14px; color:#64748b;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>`;
    }

    function renderHistorySummary(){
      const from = (histFrom.value||'').trim();
      const to = (histTo.value||'').trim();
      histSummaryRange.textContent = (from||to) ? `${from||'‚Äî'} ‡∏ñ‡∏∂‡∏á ${to||'‚Äî'}` : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';

      const calls = historyAll.length;
      const interested = historyAll.filter(p=> isInterested(p.outcome)).length;

      const uniq = new Set(historyAll.map(p=> pad4(p.opd||''))).size;

      histSummaryCalls.textContent = String(calls);
      histSummaryInterested.textContent = String(interested);
      histSummaryUnique.textContent = String(uniq);

      const totalPages = Math.max(1, Math.ceil(calls / HIST_PAGE_SIZE));
      histPage = Math.min(histPage, totalPages);
      histPageNow.textContent = String(histPage);
      histPageTotal.textContent = String(totalPages);

      btnHistPrev.disabled = histPage <= 1;
      btnHistNext.disabled = histPage >= totalPages;
    }

    function renderHistoryTablePaged(){
      renderHistorySummary();
      const start = (histPage - 1) * HIST_PAGE_SIZE;
      const pageItems = historyAll.slice(start, start + HIST_PAGE_SIZE);
      renderHistoryTable(pageItems);
    }

    function renderHistoryTable(list){
      histTbody.innerHTML = list.map(p=>{
        const d = String(p.created_at||p.date||'').slice(0,10);
        const t = String(p.created_at||'').slice(11,16) || '-';
        const opd = pad4(p.opd||'');
        const name = p.customer_name || customerByOPD.get(opd)?.name || opd;
        const promo = p.promotion || '';
        const outcome = p.outcome || '';
        const content = p.content || '';
        const channel = p.channel || '';
        const id = p.id || `${p.created_at||''}|${opd}`;

        return `
          <tr data-rowid="${esc(id)}">
            <td class="mono">${fmtShortDate(d)}</td>
            <td class="mono">${esc(t)}</td>
            <td>
              <a class="link" data-open-profile="${esc(opd)}">${esc(name)}</a>
              <div style="color:#64748b; font-size:10px; margin-top:3px;">OPD <span class="mono">${esc(opd)}</span></div>
            </td>
            <td>${esc(promo)}</td>
            <td><span class="badge b-slate">${esc(outcome)}</span></td>
            <td>${esc(content)}</td>
            <td><span class="badge b-slate">${esc(channel||'-')}</span></td>
            <td class="right">
              <button class="btn btn-icon" type="button" data-edit="${esc(id)}" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
              <button class="btn btn-icon" type="button" data-del="${esc(id)}" title="‡∏•‡∏ö">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      }).join('') || `<tr><td colspan="8" style="padding:14px; color:#64748b;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    }

    // ===================== ‚úÖ Today Summary (added) =====================
    function kpiBox(label, value, hint=''){
      return `
        <div class="kpi">
          <div class="label">${esc(label)}</div>
          <div class="value mono">${esc(value)}</div>
          <div class="hint">${esc(hint)}</div>
        </div>
      `;
    }

    function renderFreqBadges(mapObj, limit=8){
      const arr = Array.from(mapObj.entries()).sort((a,b)=> b[1]-a[1]).slice(0, limit);
      if(!arr.length) return `<span style="color:#64748b;">-</span>`;
      return arr.map(([k,v])=> `<span class="badge b-slate">${esc(k)} <span class="mono">${v}</span></span>`).join(' ');
    }

    async function loadTodaySummary(){
      const d = planDate.value || todayISO();
      todaySummaryDate.textContent = fmtShortDate(d);

      try{
        const url = new URL('/api/pitches_by_date', window.location.origin);
        url.searchParams.set('from', d);
        url.searchParams.set('to', d);

        const list = await fetchJSON(url).catch(()=>[]);
        const rows = Array.isArray(list) ? list : [];
        rows.sort((a,b)=> String(b.created_at||b.date||'').localeCompare(String(a.created_at||a.date||'')));

        const total = rows.length;
        const interested = rows.filter(r=> isInterested(r.outcome)).length;
        const hardReject = rows.filter(r=> isHardReject(r.outcome)).length;

        const noPickup = rows.filter(r=> {
          const o = String(r.outcome||'');
          return o.includes('‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢') || o.includes('‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á');
        }).length;

        const uniq = new Set(rows.map(r=> pad4(r.opd||''))).size;

        const freqOutcome = new Map();
        const freqChannel = new Map();
        const freqPromo = new Map();

        for(const r of rows){
          const o = String(r.outcome||'(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)').trim() || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)';
          const ch = String(r.channel||'(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)').trim() || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)';
          const pr = String(r.promotion||'(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)').trim() || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)';
          freqOutcome.set(o, (freqOutcome.get(o)||0) + 1);
          freqChannel.set(ch, (freqChannel.get(ch)||0) + 1);
          freqPromo.set(pr, (freqPromo.get(pr)||0) + 1);
        }

        const topOutcome = Array.from(freqOutcome.entries()).sort((a,b)=> b[1]-a[1])[0]?.[0] || '-';
        const topChannel = Array.from(freqChannel.entries()).sort((a,b)=> b[1]-a[1])[0]?.[0] || '-';

        todayKpis.innerHTML =
          kpiBox('‡πÇ‡∏ó‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)', total, ) +
          kpiBox('‡∏™‡∏ô‡πÉ‡∏à', interested, ) +
          kpiBox('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò/‡∏Ñ‡∏ß‡∏£‡∏´‡∏¢‡∏∏‡∏î', hardReject, ) +
          kpiBox('‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢/‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á', noPickup, );

                

        todaySummaryTbody.innerHTML = rows.map(r=>{
          const t = String(r.created_at||'').slice(11,16) || '-';
          const opd = pad4(r.opd||'');
          const name = r.customer_name || customerByOPD.get(opd)?.name || opd;
          const promo = r.promotion || '';
          const outcome = r.outcome || '';
          const content = r.content || '';
          const channel = r.channel || '';

          return `
            <tr>
              <td class="mono">${esc(t)}</td>
              <td>
                <a class="link" data-open-profile="${esc(opd)}">${esc(name)}</a>
                <div style="color:#64748b; font-size:10px; margin-top:3px;">OPD <span class="mono">${esc(opd)}</span></div>
              </td>
              <td>${esc(promo)}</td>
              <td><span class="badge b-slate">${esc(outcome)}</span></td>
              <td>${esc(content)}</td>
              <td><span class="badge b-slate">${esc(channel||'-')}</span></td>
            </tr>
          `;
        }).join('') || `<tr><td colspan="6" style="padding:14px; color:#64748b;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>`;

      }catch(e){
        console.error(e);
        todayKpis.innerHTML = '';
        todayStats.innerHTML = `<span style="color:#ef4444;">‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`;
        todayPromoTop.innerHTML = '';
        todaySummaryTbody.innerHTML = `<tr><td colspan="6" style="padding:14px; color:#64748b;">-</td></tr>`;
        showToast('‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
      }
    }
    // ===================== /Today Summary =====================

    // ===================== History edit/delete =====================
    async function deletePitch(id){
      if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      try{
        const res = await fetch(`/api/delete_pitch?id=${encodeURIComponent(id)}`, { method:'DELETE' });
        if(!res.ok) throw 0;
        showToast('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
        await reloadAllData(false);
        await loadHistoryFromFilters();
        await loadTodaySummary(); // ‚úÖ refresh summary
      }catch{
        showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
      }
    }

    async function editPitchInline(id){
      const p = pitches.find(x => String(x.id||`${x.created_at||''}|${pad4(x.opd||'')}`) === String(id))
              || historyAll.find(x => String(x.id||`${x.created_at||''}|${pad4(x.opd||'')}`) === String(id));
      if(!p){ showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ','warn'); return; }

      const promotion = prompt('‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô', p.promotion||'') ?? null;
      if(promotion===null) return;
      const outcome = prompt('Outcome', p.outcome||'') ?? null;
      if(outcome===null) return;
      const content = prompt('‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå', p.content||'') ?? null;
      if(content===null) return;
      const channel = prompt('‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á (call/line/visit/facebook/instagram/other)', p.channel||'call') ?? null;
      if(channel===null) return;

      try{
        const res = await fetch('/api/update_pitch', {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id, promotion, outcome, content, channel })
        });
        if(!res.ok) throw 0;
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
        await reloadAllData(false);
        await loadHistoryFromFilters();
        await loadTodaySummary(); // ‚úÖ refresh summary
      }catch{
        showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
      }
    }

    // ===================== Plan UI =====================
    function initPlanDefaults(){
      planDefaultChannel.innerHTML = CHANNELS.map(c=> `<option value="${c}">${c}</option>`).join('');
    }

    function createPlanRow(row = {}){
      const el = document.createElement('div');
      el.className = 'plan-row';
      el.dataset.opd = row.opd || '';

      const defaultPromo = planDefaultPromo.value || '';
      const defaultChannel = planDefaultChannel.value || 'call';

      el.innerHTML = `
        <div>
          <div class="field">
            <label>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</label>
            <input class="input" data-cust list="customerList" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ / OPD / ‡πÄ‡∏ö‡∏≠‡∏£‡πå" value="${esc(row.customer_label||'')}">
            <div class="meta" data-meta>‚Äî</div>
          </div>
        </div>

        <div>
          <div class="field">
            <label>‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</label>
            <input class="input" data-promo placeholder="${esc(row.promotion ?? defaultPromo)}">
          </div>
        </div>

        <div>
          <div class="field">
            <label>Outcome</label>
            <select class="input" data-outcome>
              ${OUTCOMES.map(o=> `<option ${o===(row.outcome||OUTCOMES[0])?'selected':''}>${esc(o)}</option>`).join('')}
            </select>
          </div>
        </div>

        <div>
          <div class="field">
            <label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</label>
            <select class="input" data-channel>
              ${CHANNELS.map(c=> `<option value="${c}" ${(row.channel||defaultChannel)===c?'selected':''}>${c}</option>`).join('')}
            </select>
            <label style="margin-top:8px;">‡πÇ‡∏ô‡πâ‡∏ï</label>
            <input class="input" data-note placeholder="‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" value="${esc(row.content||'')}">
          </div>
        </div>

        <div class="row-actions">
          <button class="btn btn-icon" type="button" data-open-profile title="‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå">üìá</button>
          <button class="btn btn-icon btn-danger" type="button" data-del-row title="‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß">üóëÔ∏è</button>
        </div>
      `;

      const meta = el.querySelector('[data-meta]');
      if(row.opd){
        const c = customerByOPD.get(pad4(row.opd));
        meta.textContent = c ? `OPD ${pad4(c.opd)}${c.phone?` ‚Ä¢ ${c.phone}`:''}` : `OPD ${pad4(row.opd)}`;
      }
      return el;
    }

    function refreshPlanCounters(){
      const payload = getPlanRowsPayload(true);
      const valid = payload.filter(x=> x.opd && x.outcome).length;
      planCount.textContent = payload.length.toString();
      planValid.textContent = valid.toString();
      
    }

    function getPlanRowsPayload(includeInvalid=false){
      const date = planDate.value || todayISO();
      const rows = [];
      $$('#planRows .plan-row').forEach(rowEl=>{
        const opd = rowEl.dataset.opd || '';
        const customer_label = rowEl.querySelector('[data-cust]')?.value?.trim() || '';
        const promotion = rowEl.querySelector('[data-promo]')?.value?.trim() || '';
        const outcome = rowEl.querySelector('[data-outcome]')?.value || '';
        const content = rowEl.querySelector('[data-note]')?.value?.trim() || '';
        const channel = rowEl.querySelector('[data-channel]')?.value || 'call';
        const valid = !!opd && !!outcome;
        if(valid || includeInvalid){
          rows.push({ date, opd, promotion, outcome, content, channel, customer_label });
        }
      });
      return rows;
    }

    function addPlanRow(row={}){
      const el = createPlanRow(row);
      planRows.appendChild(el);
      refreshPlanCounters();
      saveDraft();
    }

    function restorePlanDraft(){
      initPlanDefaults();
      const d = loadDraft();
      planDate.value = d?.date || todayISO();
      planDefaultPromo.value = d?.defaultPromo || '';
      planDefaultChannel.value = d?.defaultChannel || 'call';
      planTitleDate.textContent = fmtShortDate(planDate.value);

      planRows.innerHTML = '';
      if(d?.rows?.length){
        for(const r of d.rows) addPlanRow(r);
      }else{
        addPlanRow({});
      }
      planDraftStatus.textContent = d ? 'restored' : '‚Äî';
      refreshPlanCounters();
    }

    async function saveBulkPitches(){
      const rows = getPlanRowsPayload(true);

      const invalid = rows.filter(r=> !r.opd);
      if(invalid.length){
        showToast('‡∏°‡∏µ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (OPD ‡∏ß‡πà‡∏≤‡∏á)','warn');
        $$('#planRows .plan-row').forEach(rowEl=>{
          const custInput = rowEl.querySelector('[data-cust]');
          if(!rowEl.dataset.opd) custInput.classList.add('invalid');
          else custInput.classList.remove('invalid');
        });
        return;
      }

      const payload = rows
        .filter(r=> r.opd && r.outcome)
        .map(r=>({ date:r.date, opd:r.opd, promotion:r.promotion, outcome:r.outcome, content:r.content, channel:r.channel }));

      if(!payload.length){
        showToast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ valid ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å','warn');
        return;
      }

      if(!confirm(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${payload.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`)){
        showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        return;
      }

      btnSaveBulk.disabled = true; btnSaveBulk2.disabled = true;
      btnSaveBulk.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      btnSaveBulk2.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      try{
        const res = await fetch('/api/add_pitches_bulk', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const d = await res.json().catch(()=> ({}));
        if(!res.ok) throw new Error(d.error||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

        showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${d.inserted||payload.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚úÖ`);

        planRows.innerHTML = '';
        addPlanRow({});
        clearDraft();
        planDraftStatus.textContent = 'cleared';

        await reloadAllData(false);
        await loadTodaySummary(); // ‚úÖ refresh today summary
      }catch(e){
        showToast(String(e.message||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'), 'error');
      }finally{
        btnSaveBulk.disabled = false; btnSaveBulk2.disabled = false;
        btnSaveBulk.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
        btnSaveBulk2.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      }
    }

    // Plan event delegation
    planRows.addEventListener('input', ()=>{
      refreshPlanCounters();
      saveDraft();
    });

    planRows.addEventListener('change', (e)=>{
      const rowEl = e.target.closest('.plan-row');
      if(!rowEl) return;

      if(e.target.matches('[data-cust]')){
        const v = (e.target.value||'').trim();
        const picked = customerIndex.get(v);
        const meta = rowEl.querySelector('[data-meta]');
        if(picked){
          rowEl.dataset.opd = picked.opd;
          meta.textContent = `OPD ${picked.opd}${picked.phone?` ‚Ä¢ ${picked.phone}`:''}`;
          e.target.classList.remove('invalid');
        }else{
          rowEl.dataset.opd = '';
          meta.textContent = '‚Äî';
          e.target.classList.add('invalid');
        }
        refreshPlanCounters();
        saveDraft();
      }
    });

    planRows.addEventListener('click', (e)=>{
      const rowEl = e.target.closest('.plan-row');
      if(!rowEl) return;

      const del = e.target.closest('[data-del-row]');
      if(del){
        rowEl.remove();
        if(!$('#planRows .plan-row')) addPlanRow({});
        refreshPlanCounters();
        saveDraft();
        return;
      }

      const open = e.target.closest('[data-open-profile]');
      if(open){
        const opd = rowEl.dataset.opd || '';
        if(!opd){ showToast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤','warn'); return; }
        openCustomerModal(opd);
        return;
      }
    });

    // ===================== History loader from filters (paged) =====================
    async function loadHistoryFromFilters(){
      const from = (histFrom.value||'').trim();
      const to = (histTo.value||'').trim();
      const q = (histQ.value||'').trim();
      const outcome = histOutcome.value || '';
      const channel = histChannel.value || '';

      try{
        const url = new URL('/api/pitches_by_date', window.location.origin);
        if(!from && !to){
          url.searchParams.set('from', '1970-01-01');
          url.searchParams.set('to', '9999-12-31');
        }else{
          if(from) url.searchParams.set('from', from);
          if(to) url.searchParams.set('to', to);
        }
        if(q) url.searchParams.set('q', q);
        if(outcome) url.searchParams.set('outcome', outcome);
        if(channel) url.searchParams.set('channel', channel);

        const list = await fetchJSON(url);
        historyAll = Array.isArray(list)?list:[];
        historyAll.sort((a,b)=> String(b.created_at||b.date||'').localeCompare(String(a.created_at||a.date||'')));

        histPage = 1;
        renderHistoryTablePaged();
        
      }catch{
        historyAll = [];
        histPage = 1;
        renderHistoryTablePaged();
        showToast('‡πÇ‡∏´‡∏•‡∏î ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£ ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
      }
    }

    btnHistPrev.addEventListener('click', ()=>{
      histPage = Math.max(1, histPage - 1);
      renderHistoryTablePaged();
      window.scrollTo({ top: 0, behavior:'smooth' });
    });
    btnHistNext.addEventListener('click', ()=>{
      const totalPages = Math.max(1, Math.ceil(historyAll.length / HIST_PAGE_SIZE));
      histPage = Math.min(totalPages, histPage + 1);
      renderHistoryTablePaged();
      window.scrollTo({ top: 0, behavior:'smooth' });
    });

    // ===================== Export CSV =====================
    function exportCustomersCSV(list){
      const header = ['opd','name','phone','segment','priority','bucket','recommend','attempts','lastPitchDate','lastOutcome','totalAmount','paidVisits','avgAmount','lastBuyDate'];
      const lines = [header.join(',')];
      for(const a of list){
        const row = [
          a.opd, a.name, a.phone, a.segment, a.priority, a.bucket, a.recommend,
          a.attempts, a.lastPitchDate, a.lastOutcome, Math.round(a.totalAmount),
          a.paidVisits, Math.round(a.avgAmount), a.lastBuyDate
        ].map(v=> `"${String(v??'').replaceAll('"','""')}"`);
        lines.push(row.join(','));
      }
      const csv = lines.join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8;'}));
      a.download = `customers_${todayISO()}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
      showToast('Export ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ CSV ‡πÅ‡∏•‡πâ‡∏ß');
    }

    function exportHistoryCSVFromTable(){
      const rows = $$('#histTbody tr');
      if(!rows.length){ showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ export','warn'); return; }
      const header = ['date','time','opd','name','promotion','outcome','content','channel'];
      const lines = [header.join(',')];

      rows.forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        if(tds.length < 8) return;
        const date = tds[0].innerText.trim();
        const time = tds[1].innerText.trim();
        const nameCell = tds[2].innerText.trim();
        const promo = tds[3].innerText.trim();
        const outcome = tds[4].innerText.trim();
        const content = tds[5].innerText.trim();
        const channel = tds[6].innerText.trim();
        const m = nameCell.match(/OPD\s*(\d{4})/);
        const opd = m ? m[1] : '';
        const name = nameCell.split('\n')[0] || '';

        const row = [date,time,opd,name,promo,outcome,content,channel].map(v=> `"${String(v).replaceAll('"','""')}"`);
        lines.push(row.join(','));
      });

      const csv = lines.join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
      a.download = `history_${todayISO()}_page${histPage}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
      showToast('Export History (‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ) CSV ‡πÅ‡∏•‡πâ‡∏ß');
    }

    // ===================== Modal (Customer Profile) =====================
    let lastFocusEl = null;
    let currentModalOPD = null;
    let currentModalTab = 'overview';

    function showCustomerModal(){
      lastFocusEl = document.activeElement;
      customerModal.style.display = 'flex';
      customerModal.setAttribute('aria-hidden','false');
      customerModalBox.focus();
    }
    function hideCustomerModal(){
      customerModal.style.display = 'none';
      customerModal.setAttribute('aria-hidden','true');
      if(lastFocusEl && typeof lastFocusEl.focus === 'function') lastFocusEl.focus();
    }

    btnModalClose.addEventListener('click', hideCustomerModal);
    customerModal.addEventListener('click', (e)=>{
      if(e.target === customerModal) hideCustomerModal();
    });
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape') hideCustomerModal();
    });

    modalTabs.addEventListener('click', (e)=>{
      const btn = e.target.closest('.modal-tab[data-tab]');
      if(!btn) return;
      currentModalTab = btn.dataset.tab;
      $$('#modalTabs .modal-tab').forEach(x=> x.classList.toggle('active', x===btn));
      renderCustomerModal(currentModalOPD);
    });

    async function saveModalAsImage(){
      if(typeof html2canvas === 'undefined'){
        alert('‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î html2canvas');
        return;
      }
      const canvas = await html2canvas(customerModalBox);
      const link = document.createElement('a');
      link.download = `customer_${currentModalOPD||'unknown'}_${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }
    btnModalSaveImg.addEventListener('click', saveModalAsImage);

    async function openCustomerModal(opd){
      currentModalOPD = pad4(opd);
      currentModalTab = 'overview';
      $$('#modalTabs .modal-tab').forEach(x=> x.classList.toggle('active', x.dataset.tab==='overview'));
      await renderCustomerModal(currentModalOPD);
      showCustomerModal();
    }

   

    async function renderCustomerModal(opd){
      const a = analytics.find(x=> x.opd === opd) || calcCustomerAnalytics(opd);
      const pitchList = pitchesByOPD.get(opd) || [];
      const recList = recordsByOPD.get(opd) || [];

      modalTitle.innerHTML = `üìá ${esc(a.name)} <span class="badge b-slate">OPD <span class="mono">${esc(a.opd)}</span></span>`;

      if(currentModalTab === 'overview'){
        const daysPitch = a.daysSincePitch===null ? '-' : `${a.daysSincePitch} ‡∏ß‡∏±‡∏ô`;
        const daysBuy = a.daysSinceBuy===null ? '-' : `${a.daysSinceBuy} ‡∏ß‡∏±‡∏ô`;
        modalBody.innerHTML = `
          <div class="mini-grid">
            <div class="mini">
              <div class="k">Priority</div>
              <div class="v mono">${a.priority}</div>
              <div class="s">${renderRecommend(a)}</div>
            </div>
            <div class="mini">
              <div class="k">Segment</div>
              <div class="v">${segBadge(a.segment)}</div>
              <div class="s">Bucket: <b>${esc(a.bucket)}</b></div>
            </div>
            <div class="mini">
              <div class="k">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ß‡∏°</div>
              <div class="v mono">${fmtMoney(a.totalAmount)} ‡∏ö‡∏≤‡∏ó</div>
              <div class="s">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏Ñ‡∏£‡∏±‡πâ‡∏á ${fmtMoney(a.avgAmount)} ‚Ä¢ ${a.paidVisits} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</div>
            </div>
            <div class="mini">
              <div class="k">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
              <div class="v mono">${a.lastPitchDate ? fmtShortDate(a.lastPitchDate) : '-'}</div>
              <div class="s">‡πÇ‡∏ó‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${daysPitch} ‚Ä¢ ‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${daysBuy}</div>
            </div>
          </div>

          <div style="height:12px;"></div>

          <div class="card" style="box-shadow:none;">
            <div class="card-head">
              <div class="card-title">üßæ ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                ${a.phone ? `<span class="badge b-slate">üìû ${esc(a.phone)}</span>` : `<span class="badge b-slate">üìû ‚Äî</span>`}
                <span class="badge b-slate">‡πÇ‡∏ó‡∏£‡πÅ‡∏•‡πâ‡∏ß <span class="mono">${a.attempts}</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                ${a.everInterested ? `<span class="badge b-green">‡πÄ‡∏Ñ‡∏¢‡∏™‡∏ô‡πÉ‡∏à</span>` : `<span class="badge b-slate">‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡∏ô‡πÉ‡∏à</span>`}
              </div>
            </div>
            <div class="card-body">
              <div style="color:#334155; font-weight:900; margin-bottom:6px;">Outcome ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
              <div>${a.lastOutcome ? `<span class="badge b-slate">${esc(a.lastOutcome)}</span>` : `<span style="color:#64748b;">-</span>`}</div>

              <div style="height:10px;"></div>
              <div style="color:#334155; font-weight:900; margin-bottom:6px;">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ Next step</div>
              <div style="color:#0f172a;">
                ${a.segment==='STOP'
                  ? '‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (Hard reject/‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÅ‡∏•‡πâ‡∏ß) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡∏°'
                  : a.segment==='VIP'
                    ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á: ‡πÇ‡∏ó‡∏£/‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏ö‡∏ö personal + offer ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠'
                    : a.bucket==='Hot'
                      ? '‡πÇ‡∏ó‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏î‡∏µ + recency ‡πÄ‡∏´‡∏°‡∏≤‡∏∞'
                      : a.bucket==='Warm'
                        ? '‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠: ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏õ‡∏¥‡∏î'
                        : '‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏ó‡∏£: ‡∏à‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏á'}
              </div>
            </div>
          </div>
        `;
        return;
      }

      if(currentModalTab === 'pitches'){
        const rows = pitchList.slice(0, 30).map(p=>{
          const d = String(p.created_at||p.date||'').slice(0,10);
          const promo = p.promotion || '-';
          const out = p.outcome || '-';
          const note = p.content || '';
          const ch = p.channel || '-';
          return `
            <tr>
              <td class="mono">${fmtShortDate(d)}</td>
              <td>${esc(promo)}</td>
              <td><span class="badge b-slate">${esc(out)}</span></td>
              <td>${esc(note)}</td>
              <td><span class="badge b-slate">${esc(ch)}</span></td>
            </tr>
          `;
        }).join('') || `<tr><td colspan="5" style="padding:12px; color:#64748b;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Sale Pitch</td></tr>`;

        modalBody.innerHTML = `
          <div class="card" style="box-shadow:none;">
            <div class="card-head">
              <div class="card-title">üó£Ô∏è Sale Pitch ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <span class="badge b-slate">‡πÅ‡∏™‡∏î‡∏á 30 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                <button class="btn" type="button" id="btnCopyLastPromo">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-wrap">
                <table style="min-width:920px;">
                  <thead>
                    <tr>
                      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                      <th>‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</th>
                      <th>Outcome</th>
                      <th>‡πÇ‡∏ô‡πâ‡∏ï</th>
                      <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                    </tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>
            </div>
          </div>
        `;

        // copy promo to plan default
        setTimeout(()=>{
          const btn = $('#btnCopyLastPromo');
          if(!btn) return;
          btn.addEventListener('click', ()=>{
            const last = pitchList[0];
            if(!last || !last.promotion){ showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î','warn'); return; }
            planDefaultPromo.value = last.promotion;
            saveDraft();
            showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà Plan ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
          });
        }, 0);
        return;
      }

      // buys tab
      const paid = recList.filter(r=> Number(r.amount||0) > 0);
      const sum = paid.reduce((s,r)=> s + Number(r.amount||0), 0);

      const itemCounts = new Map();
      for(const r of recList){
        for(const item of (r.items||[])){
          let name = item;
          const m = item.match(/\((.*?)\)/);
          if(m) name = m[1];
          else name = item.split(' - ')[0];
          const qtyMatch = item.match(/- (\d+)\s*‡∏ä‡∏¥‡πâ‡∏ô/);
          const qty = qtyMatch ? parseInt(qtyMatch[1],10) : 1;
          itemCounts.set(name, (itemCounts.get(name)||0) + qty);
        }
      }
      const topItems = Array.from(itemCounts.entries()).sort((a,b)=> b[1]-a[1]).slice(0,10);

      const historyHtml = recList.slice(0, 30).map(r=>{
        const d = String(r.date||'').slice(0,10);
        const amount = Number(r.amount||0);
        const items = (r.items||[]).slice(0, 8).map(x=> `‚Ä¢ ${esc(x)}`).join('<br>');
        const note = r.note ? `<div style="margin-top:6px; color:#334155; font-size:11px;"><b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b> ${esc(r.note)}</div>` : '';
        return `
          <div style="border:1px solid var(--line); border-radius:16px; padding:10px 12px; background:#fff; margin-bottom:10px;">
            <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <div style="font-weight:1000;">üìÖ ${fmtShortDate(d)}</div>
              <div class="badge b-slate">üíµ ${fmtMoney(amount)} ‡∏ö‡∏≤‡∏ó</div>
            </div>
            <div style="margin-top:8px; color:#475569; font-size:11px; line-height:1.55;">
              ${items || '<span style="color:#94a3b8;">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)</span>'}
            </div>
            ${note}
          </div>
        `;
      }).join('') || `<div style="padding:12px; color:#64748b;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ã‡∏∑‡πâ‡∏≠</div>`;

      modalBody.innerHTML = `
        <div class="mini-grid">
          <div class="mini">
            <div class="k">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ß‡∏°</div>
            <div class="v mono">${fmtMoney(sum)} ‡∏ö‡∏≤‡∏ó</div>
            <div class="s">‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ amount &gt; 0</div>
          </div>
          <div class="mini">
            <div class="k">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•</div>
            <div class="v mono">${recList.length}</div>
            <div class="s">‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á ${paid.length}</div>
          </div>
          <div class="mini">
            <div class="k">‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
            <div class="v mono">${a.lastBuyDate ? fmtShortDate(a.lastBuyDate) : '-'}</div>
            <div class="s">‡∏´‡πà‡∏≤‡∏á ${a.daysSinceBuy===null?'-':a.daysSinceBuy+' ‡∏ß‡∏±‡∏ô'}</div>
          </div>
          <div class="mini">
            <div class="k">Top Items</div>
            <div class="v" style="font-size:12px; margin-top:10px;">
              ${topItems.length ? topItems.map(([n,q])=> `<div>${esc(n)} <span class="badge b-slate mono">${q}</span></div>`).join('') : '<span style="color:#64748b;">-</span>'}
            </div>
            <div class="s">10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å</div>
          </div>
        </div>

        <div style="height:12px;"></div>

        <div class="card" style="box-shadow:none;">
          <div class="card-head">
            <div class="card-title">üõçÔ∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</div>
            <div class="card-sub">‡πÅ‡∏™‡∏î‡∏á 30 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          </div>
          <div class="card-body">
            ${historyHtml}
          </div>
        </div>
      `;
    }

    // ===================== View switch (top tabs) =====================
    function showView(view){
      $$('[data-view-panel]').forEach(p=>{
        p.style.display = (p.dataset.viewPanel === view) ? '' : 'none';
      });
      $$('#topTabs .tab-btn').forEach(b=> b.classList.toggle('active', b.dataset.view === view));
      if(view === 'plan') restorePlanDraft();
      if(view === 'history') renderHistoryTablePaged();

      // ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ plan ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      if(view === 'plan') loadTodaySummary();
    }

    topTabs.addEventListener('click', (e)=>{
      const btn = e.target.closest('.tab-btn[data-view]');
      if(!btn) return;
      showView(btn.dataset.view);
    });

    // ===================== Main reload =====================
    async function reloadAllData(resetDashDates=true){
      try{
        lastSyncText.textContent = `Sync: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...`;
        if(resetDashDates){
          dashFrom.value = '';
          dashTo.value = '';
        }

        customers = await fetchJSON('/api/customers').catch(()=>[]);
        records = await fetchJSON('/api/reccord_sale').catch(()=>[]);
        await loadPitchesForDashboard();

        buildCustomerIndexes();
        buildRecordsIndex();
        buildPitchesIndex();
        rebuildAnalytics();

        
        
        
        lastSyncText.textContent = `Sync: ${nowStamp()}`;

        renderDashboard();
        renderCustomersTable();

      }catch(e){
        console.error(e);
        showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
        lastSyncText.textContent = `Sync: error`;
      }
    }

    async function loadPitchesForDashboard(){
      const from = (dashFrom.value||'').trim();
      const to = (dashTo.value||'').trim();
      const url = new URL('/api/pitches_by_date', window.location.origin);
      if(!from && !to){
        url.searchParams.set('from','1970-01-01');
        url.searchParams.set('to','9999-12-31');
      }else{
        if(from) url.searchParams.set('from', from);
        if(to) url.searchParams.set('to', to);
      }
      const list = await fetchJSON(url).catch(()=>[]);
      pitches = Array.isArray(list) ? list : [];
    }

    // ===================== Dashboard filters =====================
    btnApplyDash.addEventListener('click', async ()=>{
      await loadPitchesForDashboard();
      buildPitchesIndex();
      rebuildAnalytics();
      renderDashboard();
      renderCustomersTable();
      showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
    });

    btnResetDash.addEventListener('click', async ()=>{
      dashFrom.value = ''; dashTo.value = '';
      dashSegment.value = ''; dashQ.value = '';
      await reloadAllData(false);
      showToast('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡πâ‡∏ß');
    });

    // ===================== Customers filters =====================
    btnApplyCustomers.addEventListener('click', ()=>{
      renderCustomersTable();
      showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
    });

    btnResetCustomers.addEventListener('click', ()=>{
      custQ.value=''; custSegment.value=''; custSort.value='last_pitch_desc'; custLimit.value='50';
      renderCustomersTable();
      showToast('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
    });

    custQ.addEventListener('input', debounce(renderCustomersTable, 250));
    dashQ.addEventListener('input', debounce(()=>{ renderDashboard(); }, 250));

    // ===================== History controls =====================
    histOutcome.innerHTML = [`<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`, ...OUTCOMES.map(o=>`<option>${esc(o)}</option>`)].join('');
    histChannel.innerHTML = [`<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`, ...CHANNELS.map(c=> `<option value="${c}">${c}</option>`)].join('');

    btnLoadHistory.addEventListener('click', loadHistoryFromFilters);
    btnResetHistory.addEventListener('click', ()=>{
      histFrom.value=''; histTo.value=''; histQ.value=''; histOutcome.value=''; histChannel.value='';
      loadHistoryFromFilters();
      showToast('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£ ‡πÅ‡∏•‡πâ‡∏ß');
    });

    histQ.addEventListener('input', debounce(loadHistoryFromFilters, 350));
    histOutcome.addEventListener('change', loadHistoryFromFilters);
    histChannel.addEventListener('change', loadHistoryFromFilters);
    histFrom.addEventListener('change', loadHistoryFromFilters);
    histTo.addEventListener('change', loadHistoryFromFilters);

    // History table actions
    histTbody.addEventListener('click', (e)=>{
      const del = e.target.closest('[data-del]');
      if(del) return deletePitch(del.dataset.del);
      const ed = e.target.closest('[data-edit]');
      if(ed) return editPitchInline(ed.dataset.edit);
    });

    // ===================== Export buttons =====================
    btnExportCustomersCsv.addEventListener('click', ()=> exportCustomersCSV(filterAnalyticsForDash(analytics)));
    btnExportCustomersCsv2.addEventListener('click', ()=> exportCustomersCSV(analytics));
    btnExportHistoryCsv.addEventListener('click', exportHistoryCSVFromTable);

    // ===================== Plan controls =====================
    planDate.addEventListener('change', ()=>{
      planTitleDate.textContent = fmtShortDate(planDate.value);
      saveDraft();
      loadTodaySummary(); // ‚úÖ update summary when date changes
    });
    planDefaultPromo.addEventListener('input', saveDraft);
    planDefaultChannel.addEventListener('change', saveDraft);

    btnAddRow.addEventListener('click', ()=> addPlanRow({ promotion: planDefaultPromo.value || '', channel: planDefaultChannel.value || 'call' }));
    btnAddRow2.addEventListener('click', ()=> addPlanRow({ promotion: planDefaultPromo.value || '', channel: planDefaultChannel.value || 'call' }));
    btnSaveBulk.addEventListener('click', saveBulkPitches);
    btnSaveBulk2.addEventListener('click', saveBulkPitches);

    btnClearDraft.addEventListener('click', ()=>{
      if(!confirm('‡∏•‡πâ‡∏≤‡∏á Draft ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;
      clearDraft();
      planRows.innerHTML = '';
      addPlanRow({});
      planDraftStatus.textContent = 'cleared';
      showToast('‡∏•‡πâ‡∏≤‡∏á Draft ‡πÅ‡∏•‡πâ‡∏ß','warn');
    });

    // ‚úÖ Manual reload today summary
    btnReloadTodaySummary.addEventListener('click', loadTodaySummary);

    // ===================== Global click: open profile links =====================
    document.addEventListener('click', (e)=>{
      const a = e.target.closest('[data-open-profile]');
      if(a){
        const opd = a.getAttribute('data-open-profile');
        if(opd) openCustomerModal(opd);
      }
    });

    // ===================== Refresh all =====================
    btnRefreshAll.addEventListener('click', async ()=>{
      await reloadAllData(false);
      await loadTodaySummary(); // ‚úÖ refresh summary
      showToast('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
    });

    // ===================== Init =====================
    (async function init(){
      initPlanDefaults();

      planDate.value = todayISO();
      planTitleDate.textContent = fmtShortDate(planDate.value);

      custSort.value = 'last_pitch_desc';

      await reloadAllData(true);

      histFrom.value = '';
      histTo.value = '';
      await loadHistoryFromFilters();

      showView('plan');
      restorePlanDraft();

      await loadTodaySummary(); // ‚úÖ initial load
    })();
  </script>

{% endblock %}
{% include "floating_menu.html" %}
</body>
</html>
