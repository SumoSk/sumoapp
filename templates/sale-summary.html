<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="format-detection" content="telephone=no">
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</title>

  <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå: ‡πÄ‡∏£‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î + ‡∏Å‡∏±‡∏ô‡πÄ‡∏î‡πâ‡∏á + subset ‡πÑ‡∏ó‡∏¢ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap&subset=thai" rel="stylesheet" />

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{ 
      --primary: #00897b; 
      --primary-dark: #00695c; 
      --accent: #f9a825; /* ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏á‡∏¥‡∏ô */
      --bg-soft: #f4f7f6;
      --text-main: #374151;
      --text-light: #6b7280;
      --white: #ffffff;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --radius: 16px;
    }

    html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }
    body{
      font-family:'Prompt','Segoe UI',Tahoma,sans-serif;
      margin:0; background: var(--bg-soft); padding:10px;
      font-size:12px; line-height:1.6; color: var(--text-main);
    }
    h2{ text-align:center; color:var(--primary); font-size:18px; margin:0 0 15px; font-weight: 600; }

    /* Container */
    .container{ 
      max-width:1000px; margin:20px auto; 
      background:var(--white); border-radius:var(--radius); 
      padding:20px; box-shadow:var(--shadow-md); 
    }

    /* Month nav */
    .month-nav{ display:flex; gap:8px; align-items:center; justify-content:center; margin-bottom:20px; flex-wrap:wrap; }
    .month-btn{ 
      background:var(--white); color:var(--text-main); border:1px solid #e5e7eb; 
      border-radius:20px; padding:6px 14px; cursor:pointer; 
      transition: all 0.2s; font-weight: 500; font-size: 0.9rem;
      box-shadow: var(--shadow-sm);
    }
    .month-btn:hover{ background: #f9fafb; border-color: var(--primary); color: var(--primary); }
    .month-btn:active{ transform: scale(0.98); }
    .month-btn.primary-action{ background: var(--primary); color: white; border:none; }
    .month-btn:disabled{ opacity:.5; cursor:not-allowed; }
    #monthPicker{ position:absolute; left:-9999px; width:0; height:0; }
    .current-range{ font-size:12px; color:var(--primary); padding:4px 12px; background:#e0f2f1; border-radius:20px; font-weight: 600;}

    /* Table Styling */
    table{ width:100%; border-collapse:collapse; margin-top:15px; font-size:11.5px; table-layout:auto; }
    thead th{ 
      position:sticky; top:0; background:#f8fafc; color: var(--text-light);
      font-weight: 600; padding: 12px 8px; border-bottom: 2px solid #e2e8f0; z-index:1; text-align: left;
    }
    th, td{ padding:10px 8px; white-space:normal; word-break:break-word; border-bottom: 1px solid #f1f5f9; border-left: none; border-right: none;}
    
    /* ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÅ‡∏Ç‡πá‡∏á‡πÜ ‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å */
    td { border: none; border-bottom: 1px solid #f0f0f0; }

    thead th:nth-child(4), tbody td:nth-child(4){ width:45%; } /* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
    
    tbody tr{ transition: background 0.1s; }
    tbody tr:hover{ background: #f9fafb; }

    .day-header td{ 
      background: #e0f2f1; color: var(--primary-dark); 
      padding: 8px 12px; border-radius: 8px; font-weight:600; font-size: 13px;
    }
    .day-total td{ 
      background: #fff8e1; color: #b45309; 
      font-weight:bold; text-align:right; border-bottom: 2px solid #fef3c7;
    }

    /* Month Summary & Grid */
    .month-summary{ 
      text-align:center; font-size:16px; font-weight: 600; 
      color:var(--primary-dark); margin-bottom: 5px; 
    }
    .compare{ text-align:center; font-size:12px; margin-bottom: 15px; opacity: 0.8; }

    /* New Summary Card Grid Layout */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    .stat-card {
        background: #fff;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 15px;
        box-shadow: var(--shadow-sm);
        border-left: 4px solid var(--primary);
    }
    .stat-card.promo { border-left-color: #ec4899; } /* ‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô */
    .stat-card h4 { margin: 0 0 8px 0; font-size: 13px; color: #666; display: flex; align-items: center; gap: 5px; }
    .stat-card ul { padding-left: 20px; margin: 0; color: #444; font-size: 11.5px; }
    .stat-card li { margin-bottom: 4px; }
    .stat-card .total-highlight { font-size: 14px; font-weight: bold; color: var(--primary); margin-bottom: 8px; display: block; }
    
    .btn{ 
      display:inline-flex; align-items: center; justify-content: center; gap: 5px;
      padding:8px 16px; background:var(--primary); color:#fff; 
      border:none; border-radius:8px; cursor:pointer; text-decoration:none; 
      font-size:12px; font-weight: 500; box-shadow: 0 4px 6px -1px rgba(0, 137, 123, 0.4);
      transition: transform 0.2s;
    }
    .btn:active { transform: scale(0.96); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; box-shadow: none; background: #9ca3af; }

    /* Floating toggle/menu */
    .floating-toggle{ position:fixed; bottom:env(safe-area-inset-bottom, 20px); left:50%; transform:translateX(-50%); background:rgba(0,0,0,0); width:64px; height:64px; border-radius:50%; display:flex; justify-content:center; align-items:center; z-index:1000; cursor:pointer; transition: transform 0.2s; }
    .floating-toggle:active { transform: translateX(-50%) scale(0.9); }
    .floating-menu{ position:fixed; bottom:100px; left:50%; transform:translateX(-50%); background:rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius:24px; padding:15px; display:none; flex-direction:column; align-items:center; gap:12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index:999; max-height:60vh; overflow-y:auto; border: 1px solid rgba(255,255,255,0.5); }
    .floating-menu a img{ width:48px; height:48px; transition: transform 0.2s; }
    .floating-menu a:hover img { transform: scale(1.1); }

    /* Search */
    .search-wrap{ position:fixed; bottom:130px; left:50%; transform:translateX(-50%); z-index:1001; display:flex; align-items:center; gap:8px; width:90%; max-width:600px; justify-content:center; pointer-events:none; }
    .search-fab{ pointer-events:auto; display:flex; align-items:center; justify-content:center; width:50px; height:50px; border-radius:50%; background:var(--primary); box-shadow:0 8px 20px rgba(0,137,123,0.3); border:none; cursor:pointer; transition: transform 0.2s; }
    .search-fab:active { transform: scale(0.9); }
    .search-fab img{ width:24px; height:24px; filter:invert(100%); }
    .search-panel{ pointer-events:auto; display:flex; align-items:center; gap:6px; background:#fff; border-radius:30px; padding:6px 12px; box-shadow:0 8px 30px rgba(0,0,0,.15); width:0; max-width:0; overflow:hidden; transition:all .3s ease; opacity:0; }
    .search-wrap.open .search-panel{ max-width:600px; width:calc(100% - 80px); opacity:1; padding:8px 16px; }
    .search-panel input{ width:100%; border:none; outline:none; background:transparent; font-size:14px; color:#333; }
    .search-close{ border:none; background:#f3f4f6; border-radius:50%; width:32px; height:32px; cursor:pointer; display:flex; align-items:center; justify-content:center; color: #666; font-size: 20px;}

    /* Global shrink switch */
    :root{ --shrink:.95; }
    body{ font-size: calc(12px * var(--shrink)); }
    
    /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ Prompt */
    * { font-family: 'Prompt', sans-serif !important; -webkit-font-smoothing: antialiased; }
  </style>
</head>
<body>

  <!-- Floating Search -->
  <div class="search-wrap" id="searchWrap" aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
    <button class="search-fab" id="searchFab" title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
      <img alt="search" src="https://cdn-icons-png.flaticon.com/512/622/622669.png" />
    </button>
    <div class="search-panel" id="searchPanel" role="search">
      <input type="text" id="searchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô..." aria-label="‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" />
      <button class="search-close" id="searchCloseBtn" title="‡∏õ‡∏¥‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" aria-label="‡∏õ‡∏¥‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"></button>
    </div>
  </div>

  <div class="container">
    <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>

    <!-- ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
    <div class="month-nav">
      <button id="btnPrev" class="month-btn" type="button" title="‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤">‚Üê ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
      <button id="btnPick" class="month-btn" type="button" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
      <button id="btnClear" class="month-btn ghost" type="button" title="‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á">‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á</button>
      <button id="btnNext" class="month-btn" type="button" title="‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
      <span id="rangeBadge" class="current-range" style="display:none;"></span>
      <input type="month" id="monthPicker" />
    </div>

    <div id="reviewSection">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    <div style="text-align:center; margin-top:8px;">
      <button id="downloadExcelBtn" class="btn" type="button" style="background:#00796b;" disabled>‚¨áÔ∏è ‡πÇ‡∏´‡∏•‡∏î Excel</button>
    </div>
  </div>

  <!-- Floating toggle/menu (Jinja URLs) -->
  <div id="floatingToggle" class="floating-toggle">
    <img src="{{ url_for('static', filename='icon/icon_menu_toggle.png') }}" alt="menu" style="width:60px;height:60px;" />
  </div>
  <div id="floatingMenu" class="floating-menu" aria-hidden="true">
    <a href="{{ url_for('dashboard') }}"><img src="{{ url_for('static', filename='icon/icon_dashboard.png') }}" alt="Dashboard"></a>
    <a href="{{ url_for('sale_summary') }}"><img src="{{ url_for('static', filename='icon/icon_sale_summary.png') }}" alt="Sale summary"></a>
    <a href="{{ url_for('crm') }}"><img src="{{ url_for('static', filename='icon/icon_crm.png') }}" alt="CRM"></a>
    <a href="{{ url_for('record_sales') }}"><img src="{{ url_for('static', filename='icon/icon_record_sales.png') }}" alt="Record sales"></a>
    <a href="{{ url_for('customer_list') }}"><img src="{{ url_for('static', filename='icon/icon_customer_list.png') }}" alt="Customer list"></a>
    <a href="{{ url_for('record_customer') }}"><img src="{{ url_for('static', filename='icon/icon_customer_history.png') }}" alt="Record customer"></a>
    <a href="{{ url_for('oldsaledata') }}"><img src="{{ url_for('static', filename='icon/icon_old_customers.png') }}" alt="Old customers"></a>
    <a href="{{ url_for('inventory') }}"><img src="{{ url_for('static', filename='icon/icon_inventory.png') }}" alt="Inventory"></a>
    <a href="{{ url_for('staff') }}"><img src="{{ url_for('static', filename='icon/icon_staff.png') }}" alt="Staff"></a>
    <a href="{{ url_for('appointments') }}"><img src="{{ url_for('static', filename='icon/icon_appointments.png') }}" alt="Appointments"></a>
  </div>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <!-- Modal ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
  <div id="customer-modal" style="display:none;position:fixed;inset:0;background-color:rgba(0,0,0,.5);z-index:9999;justify-content:center;align-items:center;">
    <div id="customer-modal-box" style="background:#fff;padding:16px;border-radius:16px;width:100%;max-width:360px;box-sizing:border-box;margin:auto;max-height:90vh;overflow:auto;position:relative;font-size:13.5px;">
      <button id="closeCustomerModalBtn" type="button" style="position:absolute;top:10px;right:14px;font-size:20px;border:none;background:none;cursor:pointer;z-index:3;" aria-label="‡∏õ‡∏¥‡∏î">&times;</button>
      <div id="modal-content"></div>
    </div>
  </div>

  <!-- Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ -->
  <div id="month-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:10000;justify-content:center;align-items:center;">
    <div id="month-modal-box" style="background:#fff;padding:16px;border-radius:12px;width:100%;max-width:340px;box-sizing:border-box;position:relative;">
      <button type="button" id="monthCloseBtn" aria-label="‡∏õ‡∏¥‡∏î" style="position:absolute;top:8px;right:10px;border:none;background:none;font-size:20px;cursor:pointer;">&times;</button>
      <div style="font-weight:600;margin-bottom:12px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <div style="display:flex;gap:8px;align-items:center;">
          <label for="monthStart" style="white-space:nowrap;width:74px;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</label>
          <input type="month" id="monthStart" style="flex:1;" />
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <label for="monthEnd" style="white-space:nowrap;width:74px;">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
          <input type="month" id="monthEnd" style="flex:1;" />
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
        <button type="button" class="btn" id="monthCancelBtn" style="background:#78909c;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="btn" id="monthOkBtn">‡∏ï‡∏Å‡∏•‡∏á</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ===== Helpers =====
    const subOptionsMap = {
      "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": ["Aestox 50 u", "Aestox 100 u", "Allergan 50 u", "Allergan 100 u"],
      "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥", "Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á", "E.P.T.Q", "Restylane", "Ex-Filler"],
      "Fat/Hifu": ["Bromi", "Sisi", "HIFU", "HIFU ‡πÅ‡∏ñ‡∏°"],
      "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": ["Meso Chanel", "P - Cell", "Aquatic", "Hestina", "Exosome", "Rejuran", "Belotero Revive", "Sculptra", "Juvelook", "Aesthefill"],
      "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster"],
      "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": ["‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤", "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤", "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÑ‡∏´‡∏° PDO", "‡πÑ‡∏´‡∏° Collagen", "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô/‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"],
      "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": ["‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤"]
    };
    subOptionsMap["‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©"] = [...new Set(Object.values(subOptionsMap).flat())];

    const thaiMonthsFull = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô","‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];

    const ITEM_RE = /^(.*?)\s*(?:\((.*?)\))?\s*-\s*(\d+)\s*‡∏ä‡∏¥‡πâ‡∏ô(?:\s*[xX*]\s*([\d,.\s]+)(?:\s*(?:‡∏ö‡∏≤‡∏ó|‡∏ø))?)?/;
    function parseCurrency(v){
      if (v == null) return 0;
      if (typeof v === 'number') return isFinite(v) ? v : 0;
      const s = String(v).replace(/[^\d.-]/g,'');
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }
    function parseLine(itemText){
      const m = itemText.match(ITEM_RE);
      if(!m) return null;
      return { main:(m[1]||'').trim(), sub:(m[2]||'').trim(), qty:parseInt(m[3],10)||0, price:parseCurrency(m[4]) };
    }
    function formatDate(dateStr){ if(!dateStr) return ''; const [y,m,d] = dateStr.split('-'); return `${d}/${m}/${y.slice(-2)}`; }
    function monthLabel(ym){ const [y,m]=ym.split('-').map(n=>parseInt(n,10)); return `${thaiMonthsFull[m-1]} ${y}`; }
    function daysInMonth(year, month){ return new Date(year, month, 0).getDate(); }
    function daysToCompareForMonth(year, month){ const now=new Date(); const isCurrent=(now.getFullYear()===year && (now.getMonth()+1)===month); const lastDay=daysInMonth(year,month); return isCurrent? Math.min(now.getDate(), lastDay) : lastDay; }
    function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
    function escapeHtml(str){ return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }
    function escapeAttr(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;'); }

        // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏ß‡∏•‡∏≤ escape
    const esc = escapeHtml;

    // OPD ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å
    function pad4(s){
      return String(s || '').replace(/\D/g, '').padStart(4, '0');
    }

    // ‡∏Ñ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏¥‡∏• ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ amount ‡∏Å‡πá‡πÄ‡∏î‡∏≤‡∏à‡∏≤‡∏Å items
    function recordAmount(r){
      const a = parseCurrency(r.amount);
      if (!isNaN(a) && a > 0) return a;

      let sum = 0;
      (r.items || []).forEach(text => {
        const p = parseLine(text);
        if (!p) return;
        sum += (p.qty || 0) * (p.price || 0);
      });
      return sum;
    }

    // ===== State =====
    let allCustomerRecords = [];
    let groupedByMonth = {};
    let monthsSorted = [];
    let selectedMonth = null; // 'YYYY-MM'
    let rangeStart = null;    // 'YYYY-MM'
    let rangeEnd = null;      // 'YYYY-MM'
    let chartInstance = null;

    const isRangeActive = () => !!(rangeStart && rangeEnd);

    // ===== Fetch & Init =====
    fetch('/api/sales')
      .then(res=>res.json())
      .then(data=>{
        if(!data || data.length===0){ document.getElementById('reviewSection').textContent='‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢'; return; }
        const records = data.map(rec => ({ ...rec, items: typeof rec.items === 'string' ? JSON.parse(rec.items) : (rec.items||[]) }));
        saveAllRecords(records);
        setupMonthState();
        renderView();
        updateMonthButtons();
        document.getElementById('downloadExcelBtn').disabled = false;
      })
      .catch(err=>{ console.error(err); document.getElementById('reviewSection').textContent='‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; });

    function saveAllRecords(records){
      allCustomerRecords = records;

      groupedByMonth = {};
      records.forEach(rec=>{
        const d = rec.date && /^\d{4}-\d{2}-\d{2}$/.test(rec.date) ? rec.date : null;
        if(!d) return;
        const month = d.slice(0,7);
        (groupedByMonth[month] ??= []).push({
          ...rec,
          amount: parseCurrency(rec.amount),
          items: Array.isArray(rec.items) ? rec.items : []
        });
      });

      monthsSorted = Object.keys(groupedByMonth).sort((a,b)=>{
        const [ay, am] = a.split('-').map(Number);
        const [by, bm] = b.split('-').map(Number);
        return ay === by ? am - bm : ay - by;
      });
    }

    function setupMonthState(){
      selectedMonth = monthsSorted[monthsSorted.length-1] || null;
      rangeStart = null; rangeEnd = null;
      updateRangeBadge();
    }

    function updateRangeBadge(){
      const badge = document.getElementById('rangeBadge');
      if (isRangeActive()){
        badge.style.display = 'inline-block';
        badge.textContent = `${monthLabel(rangeStart)} ‚Äì ${monthLabel(rangeEnd)}`;
      } else {
        badge.style.display = 'none';
        badge.textContent = '';
      }
    }

    // ===== Rendering switch =====
    function renderView(){
      if (isRangeActive()) renderSelectedRange(); else renderSelectedMonth();
      const input = document.getElementById('searchInput');
      if (input){ input.value=''; onSearch(); }
      toggleSearch(false);
    }

    function destroyChart(){
      if (chartInstance && typeof chartInstance.destroy === 'function') {
        try{ chartInstance.destroy(); }catch{}
        chartInstance = null;
      }
    }

    // ===== Rendering: Range =====
    function renderSelectedRange(){
      const reviewSection = document.getElementById('reviewSection');
      reviewSection.innerHTML = '';

      const monthsInRange = monthsSorted.filter(m=> m >= rangeStart && m <= rangeEnd);
      if (monthsInRange.length === 0){ reviewSection.innerHTML = '<div style="text-align:center;padding:20px;color:#888;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>'; return; }
      const recs = monthsInRange.flatMap(m=> groupedByMonth[m] || []);
      const total = recs.reduce((s,r)=> s + parseCurrency(r.amount), 0);

      // Header
      const summaryRow = document.createElement('div');
      summaryRow.className='month-summary';
      summaryRow.innerHTML = `<div>${monthLabel(rangeStart)} ‚Äì ${monthLabel(rangeEnd)}</div><div style="font-size:24px; color:var(--primary); margin-top:4px;">‡∏ø${total.toLocaleString()}</div>`;
      reviewSection.appendChild(summaryRow);

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á Grid ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î
      const itemSummary = {}; const itemTotal = {}; const promoItemSummary = {}; const promoItemTotal = {};
      let normalAmount = 0, promoAmount = 0;
      recs.forEach(rec=>{
        (rec.items||[]).forEach(text=>{
          const p=parseLine(text); if(!p) return;
          const value=(p.qty||0)*(p.price||0);
          if(p.main==='‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©'){
            const key=p.sub||p.main; promoItemSummary[key]=(promoItemSummary[key]||0)+p.qty; promoItemTotal[key]=(promoItemTotal[key]||0)+value;
            promoAmount += value;
          } else {
            const key=p.sub||p.main; itemSummary[key]=(itemSummary[key]||0)+p.qty; itemTotal[key]=(itemTotal[key]||0)+value;
            normalAmount += value;
          }
        });
      });

      // Payment summary
      const paymentMap = {};
      recs.forEach(r=>{ const key = (r.payment || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').trim(); paymentMap[key] = (paymentMap[key]||0) + parseCurrency(r.amount); });

      const gridDiv = document.createElement('div');
      gridDiv.className = 'summary-grid';
      
      // Helper ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î
      function createStatCard(title, icon, qtyMap, totalMap, totalVal, isPromo){
        const totalQty = Object.values(qtyMap).reduce((a,b)=>a+b,0);
        const keys = Object.keys(qtyMap).sort((a,b)=> (totalMap[b]||0)-(totalMap[a]||0)).slice(0, 5); // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà Top 5
        let listHtml = keys.map(name=> `<li><span style="float:right; font-weight:bold;">${totalMap[name].toLocaleString()}</span>${name} (${qtyMap[name]})</li>`).join('');
        if(!listHtml) listHtml = '<li style="color:#aaa;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>';
        
        return `
          <div class="stat-card ${isPromo?'promo':''}">
            <h4>${icon} ${title}</h4>
            <span class="total-highlight">‡∏£‡∏ß‡∏° ${totalVal.toLocaleString()} ‡∏ö‡∏≤‡∏ó (${totalQty} ‡∏ä‡∏¥‡πâ‡∏ô)</span>
            <ul>${listHtml}</ul>
            ${Object.keys(qtyMap).length > 5 ? `<div style="text-align:center; margin-top:5px; font-size:10px; color:#888;">...‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ...</div>` : ''}
          </div>
        `;
      }

      const paymentHtml = `
          <div class="stat-card" style="border-left-color: #fbc02d;">
            <h4>üí≥ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h4>
            <span class="total-highlight">‡∏£‡∏ß‡∏° ${total.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
            <ul>
              ${Object.entries(paymentMap).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<li><span style="float:right; font-weight:bold;">${v.toLocaleString()}</span>${k}</li>`).join('')}
            </ul>
          </div>`;

      gridDiv.innerHTML = `
        ${createStatCard('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', '‚≠ê', itemSummary, itemTotal, normalAmount, false)}
        ${createStatCard('‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô', 'üéÅ', promoItemSummary, promoItemTotal, promoAmount, true)}
        ${paymentHtml}
      `;
      reviewSection.appendChild(gridDiv);

      // Chart
      const canvasContainer = document.createElement('div'); canvasContainer.style.marginTop='30px'; canvasContainer.style.height='250px';
      const canvas = document.createElement('canvas'); canvas.id='salesChart'; canvasContainer.appendChild(canvas); reviewSection.appendChild(canvasContainer);
      
      // Table Wrapper (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô)
      const tableWrapper = document.createElement('div');
      tableWrapper.style.marginTop = '20px';
      tableWrapper.innerHTML = '<h3 style="font-size:16px; color:#555; margin-bottom:10px;">üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏¥‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>';
      
      const table = document.createElement('table');
      table.innerHTML = `<thead><tr><th style="width:30px;">#</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏¢‡∏≠‡∏î (‡∏ö‡∏≤‡∏ó)</th></tr></thead><tbody></tbody>`;
      const tbody = table.querySelector('tbody');
      const sortedRecs = recs.slice().sort((a,b)=> new Date(b.date) - new Date(a.date));

      let currentDate = ''; let subIndex = 1; let dailyTotal = 0;
      function pushDayHeader(dateStr){ const tr=document.createElement('tr'); tr.className='day-header'; const td=document.createElement('td'); td.colSpan=5; td.textContent=`üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr}`; tr.appendChild(td); tbody.appendChild(tr); }
      function pushDayTotal(){ const tr=document.createElement('tr'); tr.className='day-total'; const td=document.createElement('td'); td.colSpan=5; td.innerHTML=`‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î ${dailyTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`; tr.appendChild(td); tbody.appendChild(tr); }

      sortedRecs.forEach(r=>{
        const formattedDate = formatDate(r.date);
        if(formattedDate !== currentDate){ if(currentDate !== '') pushDayTotal(); currentDate = formattedDate; subIndex = 1; dailyTotal = 0; pushDayHeader(formattedDate); }
        const rowTotal = parseCurrency(r.amount); dailyTotal += rowTotal;
        const tr = buildRow(r, subIndex++); tbody.appendChild(tr);
      });
      if(currentDate !== '') pushDayTotal();
      
      tableWrapper.appendChild(table);
      reviewSection.appendChild(tableWrapper);

      // Draw Chart
      destroyChart();
      const ctx = canvas.getContext('2d');
      if(ctx){
        const monthTotals = monthsInRange.map(m=> ({ m, total: (groupedByMonth[m]||[]).reduce((s,r)=> s + parseCurrency(r.amount), 0) }));
        chartInstance = new Chart(ctx, {
          type:'bar',
          data:{ 
            labels: monthTotals.map(x=> monthLabel(x.m)), 
            datasets:[{ 
              label:'‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢', 
              data: monthTotals.map(x=> x.total),
              backgroundColor: '#00897b',
              borderRadius: 4
            }] 
          },
          options:{ 
            responsive:true, maintainAspectRatio:false, 
            plugins:{ legend:{ display:false } }, 
            scales:{ y:{ grid:{borderDash:[4,4]}, ticks:{ precision:0 } }, x:{ grid:{display:false} } } 
          }
        });
      }
    }

    // ===== Rendering: Month =====
    function renderSelectedMonth(){
      const reviewSection = document.getElementById('reviewSection');
      reviewSection.innerHTML = '';
      if(!selectedMonth || !groupedByMonth[selectedMonth]){ reviewSection.innerHTML = '<div style="text-align:center;padding:20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>'; return; }

      const recs = groupedByMonth[selectedMonth].slice();
      const total = recs.reduce((sum, r)=> sum + parseCurrency(r.amount), 0);

      const [y,m] = selectedMonth.split('-').map(n=>parseInt(n,10));
      
      // Header Style ‡πÉ‡∏´‡∏°‡πà
      const headerDiv = document.createElement('div');
      headerDiv.style.textAlign = 'center';
      headerDiv.innerHTML = `
        <div style="font-size:16px; color:#555;">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${thaiMonthsFull[m-1]} ${y}</div>
        <div style="font-size:32px; font-weight:bold; color:var(--primary); margin:5px 0;">‡∏ø${total.toLocaleString()}</div>
      `;
      reviewSection.appendChild(headerDiv);

      // Compare text
      const prevMonthDate = new Date(y, m-2, 1);
      const prevMonth = `${prevMonthDate.getFullYear()}-${String(prevMonthDate.getMonth()+1).padStart(2,'0')}`;
      const limitDayCurr = daysToCompareForMonth(y, m);
      const currToDateTotal = recs.filter(r=> (parseInt((r.date ? r.date.split('-')[2] : '0'))||0) <= limitDayCurr).reduce((s,r)=> s+parseCurrency(r.amount), 0);
      const prevRecs = groupedByMonth[prevMonth] || [];
      const [py, pm] = prevMonth.split('-').map(n=>parseInt(n,10));
      const limitDayPrev = (pm && py) ? Math.min(limitDayCurr, daysInMonth(py, pm)) : 0;
      const prevToDateTotal = prevRecs.filter(r=> (parseInt((r.date ? r.date.split('-')[2] : '0'))||0) <= limitDayPrev).reduce((s,r)=> s+parseCurrency(r.amount), 0);
      const diff = currToDateTotal - prevToDateTotal;
      
      const compareDiv = document.createElement('div'); 
      compareDiv.className='compare'; 
      compareDiv.innerHTML = diff>0 ? `üìà ‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô <span style="color:green;font-weight:bold;">+${diff.toLocaleString()}</span> ‡∏ö‡∏≤‡∏ó (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1-${limitDayCurr})` 
        : diff<0 ? `üìâ ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô <span style="color:red;font-weight:bold;">${diff.toLocaleString()}</span> ‡∏ö‡∏≤‡∏ó (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1-${limitDayCurr})` 
        : `üìä ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤`;
      reviewSection.appendChild(compareDiv);

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á Grid Cards (Code ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Range ‡πÅ‡∏ï‡πà Reuse logic)
      const itemSummary = {}; const itemTotal = {}; const promoItemSummary = {}; const promoItemTotal = {};
      let normalAmount = 0, promoAmount = 0;
      recs.forEach(rec=>{
        (rec.items||[]).forEach(text=>{
          const p=parseLine(text); if(!p) return; const value=(p.qty||0)*(p.price||0);
          if(p.main==='‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©'){ const key=p.sub||p.main; promoItemSummary[key]=(promoItemSummary[key]||0)+p.qty; promoItemTotal[key]=(promoItemTotal[key]||0)+value; promoAmount+=value;}
          else { const key=p.sub||p.main; itemSummary[key]=(itemSummary[key]||0)+p.qty; itemTotal[key]=(itemTotal[key]||0)+value; normalAmount+=value; }
        });
      });

      const paymentMap = {};
      recs.forEach(r=>{ const key = (r.payment || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').trim(); paymentMap[key] = (paymentMap[key]||0) + parseCurrency(r.amount); });

      const gridDiv = document.createElement('div');
      gridDiv.className = 'summary-grid';

       // Helper ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î (‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÅ‡∏ï‡πà‡∏£‡∏ß‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏ô scope ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
       function createStatCard(title, icon, qtyMap, totalMap, totalVal, isPromo){
        const totalQty = Object.values(qtyMap).reduce((a,b)=>a+b,0);
        const keys = Object.keys(qtyMap).sort((a,b)=> (totalMap[b]||0)-(totalMap[a]||0)).slice(0, 5);
        let listHtml = keys.map(name=> `<li><span style="float:right; font-weight:bold;">${totalMap[name].toLocaleString()}</span>${name} (${qtyMap[name]})</li>`).join('');
        if(!listHtml) listHtml = '<li style="color:#aaa;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>';
        
        return `
          <div class="stat-card ${isPromo?'promo':''}">
            <h4>${icon} ${title}</h4>
            <span class="total-highlight">‡∏£‡∏ß‡∏° ${totalVal.toLocaleString()} ‡∏ö‡∏≤‡∏ó (${totalQty} ‡∏ä‡∏¥‡πâ‡∏ô)</span>
            <ul>${listHtml}</ul>
            ${Object.keys(qtyMap).length > 5 ? `<div style="text-align:center; margin-top:5px; font-size:10px; color:#888;">...‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ...</div>` : ''}
          </div>
        `;
      }

      const paymentHtml = `
          <div class="stat-card" style="border-left-color: #fbc02d;">
            <h4>üí≥ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h4>
            <span class="total-highlight">‡∏£‡∏ß‡∏° ${total.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
            <ul>
              ${Object.entries(paymentMap).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<li><span style="float:right; font-weight:bold;">${v.toLocaleString()}</span>${k}</li>`).join('')}
            </ul>
          </div>`;

      gridDiv.innerHTML = `
        ${createStatCard('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', '‚≠ê', itemSummary, itemTotal, normalAmount, false)}
        ${createStatCard('‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô', 'üéÅ', promoItemSummary, promoItemTotal, promoAmount, true)}
        ${paymentHtml}
      `;
      reviewSection.appendChild(gridDiv);

      // Chart Bar (Small)
      const canvasContainer = document.createElement('div'); canvasContainer.style.marginTop='30px'; canvasContainer.style.height='200px';
      const canvas = document.createElement('canvas'); canvas.id='salesChart'; canvasContainer.appendChild(canvas); reviewSection.appendChild(canvasContainer);
      const ctx = canvas.getContext('2d'); destroyChart();
      if(ctx){
        chartInstance = new Chart(ctx, {
          type:'bar',
          data:{ labels: [thaiMonthsFull[m-1]], datasets:[{ label:'‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°', data: [total], backgroundColor:'#00897b', borderRadius:4 }] },
          options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ grid:{borderDash:[4,4]}, ticks:{ precision:0 } }, x:{grid:{display:false}} } }
        });
      }

      // Table Wrapper
      const tableWrapper = document.createElement('div');
      tableWrapper.style.marginTop = '20px';
      tableWrapper.innerHTML = '<h3 style="font-size:16px; color:#555; margin-bottom:10px;">üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏¥‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>';

      const table = document.createElement('table');
      table.innerHTML = `<thead><tr><th style="width:30px;">#</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏¢‡∏≠‡∏î (‡∏ö‡∏≤‡∏ó)</th></tr></thead><tbody></tbody>`;
      const tbody = table.querySelector('tbody');

      const sortedRecs = recs.sort((a,b)=> new Date(b.date) - new Date(a.date));
      let currentDate = ''; let subIndex = 1; let dailyTotal = 0;
      function pushDayHeader(dateStr){ const tr=document.createElement('tr'); tr.className='day-header'; const td=document.createElement('td'); td.colSpan=5; td.textContent=`üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr}`; tr.appendChild(td); tbody.appendChild(tr); }
      function pushDayTotal(){ const tr=document.createElement('tr'); tr.className='day-total'; const td=document.createElement('td'); td.colSpan=5; td.innerHTML=`‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î ${dailyTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`; tr.appendChild(td); tbody.appendChild(tr); }

      sortedRecs.forEach(r=>{
        const formattedDate = formatDate(r.date);
        if(formattedDate !== currentDate){ if(currentDate !== '') pushDayTotal(); currentDate = formattedDate; subIndex = 1; dailyTotal = 0; pushDayHeader(formattedDate); }
        const rowTotal = parseCurrency(r.amount); dailyTotal += rowTotal;
        const tr = buildRow(r, subIndex++); tbody.appendChild(tr);
      });
      if(currentDate !== '') pushDayTotal();
      
      tableWrapper.appendChild(table);
      reviewSection.appendChild(tableWrapper);
    }

    // ===== Rendering: Month =====
    function renderSelectedMonth(){
      const reviewSection = document.getElementById('reviewSection');
      reviewSection.innerHTML = '';
      if(!selectedMonth || !groupedByMonth[selectedMonth]){ reviewSection.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å'; return; }

      const recs = groupedByMonth[selectedMonth].slice();
      const total = recs.reduce((sum, r)=> sum + parseCurrency(r.amount), 0);

      const itemSummary = {}; const itemTotal = {}; const promoItemSummary = {}; const promoItemTotal = {};
      recs.forEach(rec=>{
        (rec.items||[]).forEach(text=>{
          const p=parseLine(text); if(!p) return; const value=(p.qty||0)*(p.price||0);
          if(p.main==='‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©'){ const key=p.sub||p.main; promoItemSummary[key]=(promoItemSummary[key]||0)+p.qty; promoItemTotal[key]=(promoItemTotal[key]||0)+value; }
          else { const key=p.sub||p.main; itemSummary[key]=(itemSummary[key]||0)+p.qty; itemTotal[key]=(itemTotal[key]||0)+value; }
        });
      });

      const [y,m] = selectedMonth.split('-').map(n=>parseInt(n,10));
      const monthIndex = m-1;
      const summaryRow = document.createElement('div'); summaryRow.className='month-summary'; summaryRow.textContent = `üìÜ ${thaiMonthsFull[monthIndex]} ${y} ‚Äî ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ${total.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

      const prevMonthDate = new Date(y, m-2, 1);
      const prevMonth = `${prevMonthDate.getFullYear()}-${String(prevMonthDate.getMonth()+1).padStart(2,'0')}`;
      const limitDayCurr = daysToCompareForMonth(y, m);
      const currToDateTotal = recs.filter(r=> (parseInt((r.date ? r.date.split('-')[2] : '0'))||0) <= limitDayCurr).reduce((s,r)=> s+parseCurrency(r.amount), 0);

      const prevRecs = groupedByMonth[prevMonth] || [];
      const [py, pm] = prevMonth.split('-').map(n=>parseInt(n,10));
      const limitDayPrev = (pm && py) ? Math.min(limitDayCurr, daysInMonth(py, pm)) : 0;
      const prevToDateTotal = prevRecs.filter(r=> (parseInt((r.date ? r.date.split('-')[2] : '0'))||0) <= limitDayPrev).reduce((s,r)=> s+parseCurrency(r.amount), 0);
      const diff = currToDateTotal - prevToDateTotal;

      const compareDiv = document.createElement('div'); compareDiv.className='compare'; compareDiv.style.color = diff>0 ? 'green' : diff<0 ? 'crimson' : '#555';
      compareDiv.textContent = diff>0 ? `üìà ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${limitDayCurr}: ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ${diff.toLocaleString()} ‡∏ö‡∏≤‡∏ó` : diff<0 ? `üìâ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${limitDayCurr}: ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ${Math.abs(diff).toLocaleString()} ‡∏ö‡∏≤‡∏ó` : `üìä ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${limitDayCurr}: ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤`;

      const monthWrap = document.createElement('div'); monthWrap.appendChild(summaryRow); monthWrap.appendChild(compareDiv); document.getElementById('reviewSection').appendChild(monthWrap);

      // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
      const table = document.createElement('table');
      table.innerHTML = `<thead><tr><th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏¢‡∏≠‡∏î</th></tr></thead><tbody></tbody>`;
      const tbody = table.querySelector('tbody');

      const sortedRecs = recs.sort((a,b)=> new Date(b.date) - new Date(a.date));
      let currentDate = ''; let subIndex = 1; let dailyTotal = 0;

      function pushDayHeader(dateStr){ const tr=document.createElement('tr'); tr.className='day-header'; const td=document.createElement('td'); td.colSpan=5; td.textContent=`üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr}`; tr.appendChild(td); tbody.appendChild(tr); }
      function pushDayTotal(){ const tr=document.createElement('tr'); tr.className='day-total'; const td=document.createElement('td'); td.colSpan=5; td.innerHTML=`üíµ ${dailyTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`; tr.appendChild(td); tbody.appendChild(tr); }

      sortedRecs.forEach(r=>{
        const formattedDate = formatDate(r.date);
        if(formattedDate !== currentDate){ if(currentDate !== '') pushDayTotal(); currentDate = formattedDate; subIndex = 1; dailyTotal = 0; pushDayHeader(formattedDate); }
        const rowTotal = parseCurrency(r.amount); dailyTotal += rowTotal;
        const tr = buildRow(r, subIndex++); tbody.appendChild(tr);
      });
      if(currentDate !== '') pushDayTotal();

      document.getElementById('reviewSection').appendChild(table);

      // ‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏°‡∏ß‡∏î + ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
      function renderItemSummary(title, qtyMap, totalMap, totalFromItems){
        const totalQty = Object.values(qtyMap).reduce((a,b)=>a+b,0);
        const keys = Object.keys(qtyMap).sort((a,b)=> (totalMap[b]||0)-(totalMap[a]||0));
        let html = `<div style="margin-bottom:10px;"><strong>${title} ${totalQty.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô, ‡∏£‡∏ß‡∏° ${totalFromItems.toLocaleString()} ‡∏ö‡∏≤‡∏ó</strong><ul style="padding-left:20px; margin:5px 0;">`;
        keys.forEach(name=>{ const qty = qtyMap[name]||0; const itemTotal = totalMap[name]||0; html += `<li>${name} ‚Äî ${qty} ‡∏ä‡∏¥‡πâ‡∏ô, ${itemTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó</li>`; });
        html += '</ul></div>';
        return html;
      }
      let normalAmount = 0, promoAmount = 0;
      recs.forEach(rec=>{
        (rec.items||[]).forEach(text=>{
          const p=parseLine(text); if(!p) return; const value=(p.qty||0)*(p.price||0);
          if(p.main==='‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©') promoAmount += value; else normalAmount += value;
        });
      });
      const summaryDiv = document.createElement('div'); summaryDiv.className='summary-card';
      const summaryHTML = `${renderItemSummary('‚≠ê ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', itemSummary, itemTotal, normalAmount)}${renderItemSummary('üéÅ ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô', promoItemSummary, promoItemTotal, promoAmount)}`;

      const paymentMap = {};
      recs.forEach(r=>{
        const key = (r.payment || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').trim();
        paymentMap[key] = (paymentMap[key]||0) + parseCurrency(r.amount);
      });
      const paymentHtml = `<div style="margin-top:10px;">
        <strong>üí≥ ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</strong>
        <ul style="padding-left:20px; margin:6px 0;">
          ${Object.entries(paymentMap).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<li>${k} ‚Äî ${v.toLocaleString()} ‡∏ö‡∏≤‡∏ó</li>`).join('')}
        </ul>
      </div>`;

      /* ‚ú® ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°/‡∏û‡∏±‡∏ö-‡∏Å‡∏≤‡∏á: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏•‡∏¢ */
      summaryDiv.innerHTML = `${summaryHTML}${paymentHtml}`;
      document.getElementById('reviewSection').appendChild(summaryDiv);

      // Chart
      const canvasContainer = document.createElement('div'); canvasContainer.style.marginTop='30px'; canvasContainer.style.height='220px';
      const canvas = document.createElement('canvas'); canvas.id='salesChart'; canvasContainer.appendChild(canvas); document.getElementById('reviewSection').appendChild(canvasContainer);
      const ctx = canvas.getContext('2d'); destroyChart();
      if(ctx){
        chartInstance = new Chart(ctx, {
          type:'bar',
          data:{ labels: [selectedMonth], datasets:[{ label:'‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)', data: [total] }] },
          options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'top' } }, layout:{ padding:{ bottom:10 } }, scales:{ y:{ ticks:{ precision:0 } } } }
        });
      }
    }

    // ===== Row builder =====
    function buildRow(r, subIndex){
      const tr = document.createElement('tr');

      const tdIndex = document.createElement('td');
      tdIndex.textContent = subIndex;
      tr.appendChild(tdIndex);

      const tdName = document.createElement('td');
      tdName.innerHTML = `
        <div>
          <strong class="open-customer" 
            style="cursor:pointer;color:#008080;" 
            data-key="${encodeURIComponent((r.name||'')+'|'+(r.phone||''))}">
            ${escapeHtml(r.name||'')}
          </strong>
          <div style="font-size:10px;color:#777;">${escapeHtml(r.opd||'-')}</div>
        </div>`;
      tr.appendChild(tdName);

      const tdPhone = document.createElement('td');
      const phoneSafe = escapeAttr(r.phone || '');
      tdPhone.innerHTML = `<span style="cursor:pointer;color:#0288d1;"
        onclick="if(this.dataset.showing==='true'){this.innerText='üìû';this.dataset.showing='false';}else{this.innerText='${phoneSafe}';this.dataset.showing='true';}"
        oncontextmenu="navigator.clipboard?.writeText('${phoneSafe}'); event.preventDefault(); this.title='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';"
        title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô, ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å"
        data-showing='false'>üìû</span>`;
      tr.appendChild(tdPhone);

      /* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà */
      const itemsUl = (r.items||[]).map(item=>{
        const m = item.match(/^(.*?) ?(?:\((.*?)\))? - (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
        if(m){ const main=m[1], sub=m[2], qty=m[3];
          return `<li>${sub? `${escapeHtml(main)} (${escapeHtml(sub)}` : escapeHtml(main)}${sub?')':''} - ${qty} ‡∏ä‡∏¥‡πâ‡∏ô</li>`;
        }
        return `<li>${escapeHtml(item)}</li>`;
      }).join('');
      const tdItems = document.createElement('td');
      tdItems.innerHTML = `<ul style='margin:0; padding-left:16px;'>${itemsUl}</ul>`;
      tr.appendChild(tdItems);

      /* ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ + ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ï‡πâ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠) */
      const tdAmt = document.createElement('td');
      const amt = parseCurrency(r.amount);
      tdAmt.innerHTML = `
        <div>${amt.toLocaleString()} ‡∏ö‡∏≤‡∏ó${r.payment ? ` (${r.payment})` : ''}</div>
        ${
          r.note && String(r.note).trim()
            ? `<div style="color:#888; font-size:10px; margin-top:4px;">üìù ${escapeHtml(r.note)}</div>`
            : ''
        }`;
      tr.appendChild(tdAmt);

      return tr;
    }

    // ===== Month Nav =====
    function updateMonthButtons(){
      const idx = monthsSorted.indexOf(selectedMonth);
      const disabled = isRangeActive();
      const btnPrev = document.getElementById('btnPrev');
      const btnNext = document.getElementById('btnNext');
      if (btnPrev) btnPrev.disabled = disabled || (idx <= 0);
      if (btnNext) btnNext.disabled = disabled || (idx >= monthsSorted.length-1);
    }

    document.getElementById('btnPrev')?.addEventListener('click', ()=>{ const idx=monthsSorted.indexOf(selectedMonth); if(idx>0){ selectedMonth = monthsSorted[idx-1]; renderView(); updateMonthButtons(); }});
    document.getElementById('btnNext')?.addEventListener('click', ()=>{ const idx=monthsSorted.indexOf(selectedMonth); if(idx<monthsSorted.length-1){ selectedMonth = monthsSorted[idx+1]; renderView(); updateMonthButtons(); }});
    document.getElementById('btnPick')?.addEventListener('click', ()=>{ openMonthModal(); });
    document.getElementById('btnClear')?.addEventListener('click', ()=>{ setupMonthState(); renderView(); updateMonthButtons(); });

    // ===== Search logic =====
    const onSearch = debounce(()=>{
      const val = (document.getElementById('searchInput').value||'').trim().toLowerCase();
      const tbody = document.querySelector('table tbody');
      if (!tbody) return;
      let currentHeader = null;
      let currentHasVisible = false;

      [...tbody.children].forEach(row=>{
        if(row.classList.contains('day-header')){
          if(currentHeader && !currentHasVisible){
            currentHeader.style.display = 'none';
            if(currentHeader._totalRow) currentHeader._totalRow.style.display = 'none';
          }
          currentHeader = row;
          currentHeader.style.display = '';
          currentHasVisible = false;
          return;
        }
        if(row.classList.contains('day-total')){
          if(currentHeader) currentHeader._totalRow = row;
          row.style.display = currentHasVisible ? '' : 'none';
          return;
        }
        const text = row.textContent.toLowerCase();
        const show = text.includes(val);
        row.style.display = show ? '' : 'none';
        if(show) currentHasVisible = true;
      });

      if(currentHeader && !currentHasVisible){
        currentHeader.style.display = 'none';
        if(currentHeader._totalRow) currentHeader._totalRow.style.display = 'none';
      }
    }, 200);
    document.getElementById('searchInput')?.addEventListener('input', onSearch);

    // ===== Floating Search toggle =====
    const wrap = document.getElementById('searchWrap');
    const fab = document.getElementById('searchFab');
    const panel = document.getElementById('searchPanel');
    const closeBtn = document.getElementById('searchCloseBtn');
    function toggleSearch(open){
      if(!wrap) return;
      if(open){
        wrap.classList.add('open');
        setTimeout(()=> document.getElementById('searchInput')?.focus(), 10);
      }else{
        wrap.classList.remove('open');
      }
    }
    fab?.addEventListener('click', (e)=>{ e.stopPropagation(); toggleSearch(true); });
    closeBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); document.getElementById('searchInput').value=''; onSearch(); toggleSearch(false); });
    document.addEventListener('click', (e)=>{
      if(!wrap.classList.contains('open')) return;
      const t = e.target;
      if(!(wrap.contains(t))) toggleSearch(false);
    });
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && wrap.classList.contains('open')){ document.getElementById('searchInput').value=''; onSearch(); toggleSearch(false); }
    });

    // ===== Floating Menu =====
    const floatingToggle = document.getElementById('floatingToggle');
    const floatingMenu = document.getElementById('floatingMenu');
    floatingToggle?.addEventListener('click', (e)=>{ e.stopPropagation(); if(!floatingMenu) return; floatingMenu.style.display = (floatingMenu.style.display==='flex') ? 'none':'flex'; });
    document.addEventListener('click', (e)=>{ if(!floatingToggle || !floatingMenu) return; if(!floatingToggle.contains(e.target) && !floatingMenu.contains(e.target)) floatingMenu.style.display='none'; });

    // ===== Customer Modal =====
    document.addEventListener('click', (e)=>{
      const el = e.target.closest?.('.open-customer');
      if(!el) return;
      const key = decodeURIComponent(el.dataset.key || '');
      openCustomerModal(key);
    });
    document.getElementById('closeCustomerModalBtn')?.addEventListener('click', closeCustomerModal);
    document.getElementById('customer-modal')?.addEventListener('click', (e)=>{ if(e.target && e.target.id === 'customer-modal') closeCustomerModal(); });






    async function openCustomerModal(key){
      const records = allCustomerRecords.filter(r=> `${r.name}|${r.phone}` === key);
      if(records.length===0) return;

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ö‡∏¥‡∏•‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
      records.sort((a,b)=> b.date.localeCompare(a.date));

      const first = records[0];
      const customer = {
        name: first.name,
        phone: first.phone || '-',
        opd: pad4(first.opd || '-')
      };

      const lastDateStr = (records[0].date || '').slice(0,10);
      const lastDate = new Date(lastDateStr);
      const today = new Date();
      const daysAbsent = isNaN(lastDate) ? 0 : Math.floor((today - lastDate) / (1000*60*60*24));

      const paidRecords = records.filter(r => recordAmount(r) > 0);
      const paidVisits = paidRecords.length;
      const totalAmount = paidRecords.reduce((s,r)=> s + recordAmount(r), 0);
      const average = paidVisits > 0 ? Math.round(totalAmount/paidVisits) : 0;

      // ‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î (Logic ‡πÄ‡∏î‡∏¥‡∏°)
      const allItems = {};
      records.forEach(r=>{
        (r.items || []).forEach(item=>{
          let name = item;
          const m = item.match(/\((.*?)\)/);
          if (m) name = m[1]; else name = item.split(' - ')[0];
          const qtyMatch = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
          const qty = qtyMatch ? parseInt(qtyMatch[1],10) : 1;
          allItems[name] = (allItems[name] || 0) + qty;
        });
      });
      const categorizedItems = {};
      for(const [cat, names] of Object.entries(subOptionsMap)){
        names.forEach(n=>{
          if(allItems[n]){ (categorizedItems[cat] ??= []).push(`${esc(n)} <span style="color:#aaa;font-size:0.9em;">x${allItems[n]}</span>`); delete allItems[n]; }
        });
      }
      if(Object.keys(allItems).length){
        (categorizedItems['‡∏≠‡∏∑‡πà‡∏ô‡πÜ'] ??= []).push(...Object.entries(allItems).map(([n,q])=>`${esc(n)} <span style="color:#aaa;font-size:0.9em;">x${q}</span>`));
      }
      
      // Render ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö Tags ‡∏™‡∏ß‡∏¢‡πÜ
      const itemSummary = Object.entries(categorizedItems).map(([cat, items])=>`
        <div style="margin-bottom:8px;">
          <div style="font-weight:600; font-size:12px; color:#555; margin-bottom:2px;">${esc(cat)}</div>
          <div style="line-height:1.6;">${items.map(i=> `<span style="display:inline-block; background:#f0fdf4; border:1px solid #dcfce7; color:#166534; padding:2px 8px; border-radius:12px; margin-right:4px; font-size:11px;">${i}</span>`).join('')}</div>
        </div>
      `).join('');

      // ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (Modern Timeline Style)
      const historyHtml = records.map(r=>{
        const itemsHtml = (r.items||[]).map(item=>{
            let name = item;
            const m = item.match(/\((.*?)\)/);
            if (m) name = m[1]; else name = item.split(' - ')[0];
            const qtyMatch=item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
            const qty = qtyMatch ? parseInt(qtyMatch[1],10) : 1;
            return `<div style="display:flex; justify-content:space-between; color:#444;"><span>${esc(name)}</span><span style="color:#888;">x${qty}</span></div>`;
        }).join('');
        
        return `
          <div style="position:relative; padding-left:15px; margin-bottom:15px; border-left:2px solid #e0e0e0;">
            <div style="position:absolute; left:-5px; top:0; width:8px; height:8px; border-radius:50%; background:#00897b;"></div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                <span style="font-weight:600; color:#333;">${formatDate((r.date || '').slice(0,10))}</span>
                <span style="font-weight:bold; color:#00897b;">‡∏ø${Math.round(recordAmount(r)).toLocaleString()}</span>
            </div>
            <div style="background:#f9fafb; padding:8px; border-radius:8px; font-size:11.5px;">
                ${itemsHtml}
                ${r.note ? `<div style="margin-top:6px; padding-top:6px; border-top:1px dashed #ddd; color:#d97706; font-style:italic;">üìù ${esc(r.note)}</div>` : ''}
            </div>
          </div>`;
      }).join('');

      // Sale Pitch Fetching...
      let pitchSectionHtml = '<div style="color:#999;font-style:italic;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
      // ... (‡∏™‡πà‡∏ß‡∏ô Fetch Pitch ‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Style HTML ‡∏ï‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•) ...
      // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏û‡∏•‡∏≠‡∏¢‡πÉ‡∏™‡πà Placeholder ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡∏ã‡∏π‡πÇ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏û‡∏•‡∏≠‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ó‡∏£‡∏Å‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡πÜ ‡∏Ñ‡πà‡∏∞
      // (‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡∏π‡πÇ‡∏°‡πà‡∏°‡∏µ fetch ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ copy logic fetch ‡∏°‡∏≤‡πÉ‡∏™‡πà ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô HTML render ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ)
      /* Style ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pitch:
         <div style="background:#fff3e0; border-left:3px solid #ff9800; padding:8px; border-radius:4px; margin-bottom:6px;">
            <div style="font-weight:600; color:#e65100;">${d} - ${esc(p.promotion)}</div>
            <div style="color:#555;">${esc(p.outcome)}</div>
         </div>
      */
     
     // ‡∏î‡∏∂‡∏á Pitch ‡∏à‡∏£‡∏¥‡∏á (‡∏Ç‡∏≠‡πÉ‡∏™‡πà‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡πÉ‡∏´‡πâ Code ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
     try{
        const opdClean = (customer.opd || '').replace(/\D/g,'');
        if (opdClean){
             const res = await fetch(`/api/pitches?opd=${encodeURIComponent(opdClean)}`);
             if(res.ok){
                 const pitches = await res.json() || [];
                 if(pitches.length){
                    pitches.sort((a,b)=> String(b.created_at||'').localeCompare(String(a.created_at||'')));
                    pitchSectionHtml = pitches.map(p => `
                        <div style="background:#fff7ed; border:1px solid #ffedd5; padding:8px; border-radius:8px; margin-bottom:6px;">
                            <div style="font-size:11px; color:#9a3412; font-weight:600;">${formatDate(String(p.created_at || p.date).slice(0,10))} ‚Äî ${esc(p.promotion)}</div>
                            <div style="color:#555;">${esc(p.outcome)}</div>
                        </div>
                    `).join('');
                 } else { pitchSectionHtml = '<div style="color:#ccc; font-style:italic;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Sale Pitch</div>'; }
             }
        }
     } catch(e){ pitchSectionHtml = '<div style="color:red;">‡πÇ‡∏´‡∏•‡∏î Pitch ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>'; }


      const modal = document.getElementById('modal-content');
      // Save Button Logic (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
      const box = document.getElementById('customer-modal-box');
      if (box && !box.querySelector('#modal-save-controls')) {
        const controls = document.createElement('div');
        controls.id = 'modal-save-controls';
        controls.style.cssText='position:absolute;top:15px;left:15px;z-index:10;';
        controls.innerHTML = `<button onclick="saveModalAsImage()" style="background:#fff; border:none; width:32px; height:32px; border-radius:50%; box-shadow:0 2px 8px rgba(0,0,0,0.15); cursor:pointer; color:#555;">üíæ</button>`;
        box.appendChild(controls);
      }

      // HTML ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô Modal (‡∏à‡∏±‡∏î Layout ‡πÉ‡∏´‡∏°‡πà)
      modal.innerHTML = `
        <div style="text-align:center; padding-bottom:15px; margin-bottom:15px; border-bottom:1px solid #eee;">
            <div style="width:60px; height:60px; background:#e0f2f1; color:#00897b; border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:24px;">üë§</div>
            <h3 style="margin:0; font-size:18px; color:#333;">${esc(customer.name)}</h3>
            <div style="color:#666; font-size:13px; margin-top:4px;">OPD: ${esc(customer.opd)} | üìû ${esc(customer.phone)}</div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
                <div style="background:#f9fafb; padding:8px; border-radius:8px;">
                    <div style="font-size:11px; color:#888;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    <div style="font-size:16px; font-weight:bold; color:#00897b;">‡∏ø${Math.round(totalAmount).toLocaleString()}</div>
                </div>
                <div style="background:#fff0f0; padding:8px; border-radius:8px;">
                    <div style="font-size:11px; color:#888;">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏ô‡∏≤‡∏ô</div>
                    <div style="font-size:16px; font-weight:bold; color:#e53935;">${daysAbsent} ‡∏ß‡∏±‡∏ô</div>
                </div>
            </div>
        </div>

        <div style="margin-bottom:20px;">
            <div style="font-weight:600; font-size:14px; margin-bottom:10px; color:#333;">üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡πà‡∏≠‡∏¢</div>
            ${itemSummary || '<div style="color:#ccc;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>'}
        </div>

        <div style="margin-bottom:20px;">
             <div style="font-weight:600; font-size:14px; margin-bottom:10px; color:#333;">üó£Ô∏è Sale Pitch ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
             ${pitchSectionHtml}
        </div>

        <div>
            <div style="font-weight:600; font-size:14px; margin-bottom:15px; color:#333;">üõçÔ∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ (${records.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div>
            ${historyHtml}
        </div>
      `;

      document.getElementById('customer-modal').style.display='flex';
    }






    function closeCustomerModal(){ const m = document.getElementById('customer-modal'); if (m) m.style.display='none'; }
    function saveModalAsImage(){
      const node = document.getElementById('modal-content');
      if(!node){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô modal'); return; }
      html2canvas(node, { scale:2 }).then(canvas=>{
        const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if(isIOS){
          const previewArea = document.createElement('div');
          previewArea.style.marginTop='20px';
          previewArea.id='modalImagePreview';
          previewArea.innerHTML = `<div style="font-weight:bold; margin-bottom:6px;">‡πÅ‡∏ï‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ</div><img src="${dataUrl}" style="width:100%; border:1px solid #ccc; border-radius:12px;" />`;
          const existing = document.getElementById('modalImagePreview'); if(existing) existing.remove();
          node.appendChild(previewArea);
        } else {
          const link = document.createElement('a'); link.download='customer-info.jpg'; link.href = dataUrl; link.click();
        }
      }).catch(err=>{ console.error('‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', err); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'); });
    }

    // ===== Excel Export =====
    document.getElementById('downloadExcelBtn')?.addEventListener('click', downloadExcel);
    function downloadExcel(){
      const allMonths = isRangeActive()
        ? monthsSorted.filter(m=> m >= rangeStart && m <= rangeEnd)
        : (selectedMonth ? [selectedMonth] : []);
      const recs = allMonths.flatMap(m=> groupedByMonth[m] || []);
      if(!recs.length){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î'); return; }

      const filename = isRangeActive ? `‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢_${rangeStart}_‡∏ñ‡∏∂‡∏á_${rangeEnd}.xlsx` : `‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢_${selectedMonth||'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}.xlsx`;

      const sortedRecs = recs.slice().sort((a,b)=> new Date(b.date) - new Date(a.date));
      const ws_data = [];
      let currentDate = '';
      let dailyTotal = 0;

      sortedRecs.forEach(r=>{
        const formattedDate = formatDate(r.date);
        const items = (r.items||[]).map(item=>{
          const m = item.match(/^(.*?) ?(?:\((.*?)\))? - (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
          if(m){ const main=m[1], sub=m[2], qty=m[3]; return sub? `${main} (${sub}) - ${qty} ‡∏ä‡∏¥‡πâ‡∏ô` : `${main} - ${qty} ‡∏ä‡∏¥‡πâ‡∏ô`; }
          return item;
        }).join('\n');

        if(formattedDate !== currentDate){
          if(currentDate !== ''){ ws_data.push(['','','','‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô', dailyTotal, '']); ws_data.push([]); }
          currentDate = formattedDate; dailyTotal = 0; ws_data.push([`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formattedDate}`]); ws_data.push(['OPD','‡∏ä‡∏∑‡πà‡∏≠','‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','‡∏¢‡∏≠‡∏î (‡∏ö‡∏≤‡∏ó)','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']);
        }
        dailyTotal += parseCurrency(r.amount);
        ws_data.push([ r.opd||'', r.name, r.phone||'', items, parseCurrency(r.amount), r.note||'' ]);
      });
      if(currentDate !== '') ws_data.push(['','','','‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô', dailyTotal, '']);

      const worksheet = XLSX.utils.aoa_to_sheet(ws_data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô');
      XLSX.writeFile(workbook, filename);
    }

    // ===== Month Range Modal =====
    function openMonthModal(){
      const mm = document.getElementById('month-modal');
      const inputStart = document.getElementById('monthStart');
      const inputEnd = document.getElementById('monthEnd');
      if (inputStart) inputStart.value = rangeStart || selectedMonth || '';
      if (inputEnd)   inputEnd.value   = rangeEnd || selectedMonth || '';
      if (mm) mm.style.display = 'flex';
    }
    function closeMonthModal(){ const m = document.getElementById('month-modal'); if (m) m.style.display = 'none'; }
    function confirmMonthModal(){
      let s = (document.getElementById('monthStart').value||'').trim();
      let e = (document.getElementById('monthEnd').value||'').trim();
      if(!s && !e){ closeMonthModal(); return; }
      if(s && !e) e = s; if(e && !s) s = e;
      if (s > e){ const t=s; s=e; e=t; }
      rangeStart = s; rangeEnd = e; selectedMonth = s;
      updateRangeBadge();
      renderView();
      updateMonthButtons();
      closeMonthModal();
    }
    document.getElementById('month-modal')?.addEventListener('click', (e)=>{ if (e.target && e.target.id === 'month-modal') closeMonthModal(); });
    document.getElementById('month-modal-box')?.addEventListener('click', (e)=>{ e.stopPropagation(); });
    document.getElementById('monthCloseBtn')?.addEventListener('click', closeMonthModal);
    document.getElementById('monthCancelBtn')?.addEventListener('click', closeMonthModal);
    document.getElementById('monthOkBtn')?.addEventListener('click', confirmMonthModal);

    // ESC ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å modal
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        closeCustomerModal();
        closeMonthModal();
        if(document.getElementById('searchWrap').classList.contains('open')){ document.getElementById('searchInput').value=''; onSearch(); toggleSearch(false); }
      }
    });

    // expose
    window.openMonthModal = openMonthModal;
    window.closeMonthModal = closeMonthModal;
    window.confirmMonthModal = confirmMonthModal;
  });
  </script>
</body>
</html>
