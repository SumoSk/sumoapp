<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --teal:#00796b; --muted:#555; }
    body { font-family: 'Prompt','Segoe UI',sans-serif; margin:0; background:#f7f7f7; padding:10px; font-size:11px; }

    /* Floating search */
    .search-container { position:fixed; bottom:120px; left:50%; transform:translateX(-50%); width:90%; max-width:600px; background:rgb(235,255,245); border-radius:20px; padding:6px 8px; box-shadow:0 4px 12px rgba(0,0,0,.1); z-index:999; }
    .search-container input { width:100%; padding:6px 10px 6px 28px; font-size:11px; border:none; border-radius:30px; background:#fff url('https://cdn-icons-png.flaticon.com/512/622/622669.png') no-repeat 8px center/14px; color:#222; outline:none; }

    /* Container */
    .container { max-width:1000px; margin:20px auto; background:#fff; border-radius:12px; padding:15px; box-shadow:0 2px 10px rgba(0,0,0,.05); }
    h2 { text-align:center; color:var(--teal); font-size:14px; margin:0; }

    /* Table */
    table { width:100%; border-collapse:collapse; margin-top:8px; font-size:11px; }
    thead th { position:sticky; top:0; background:#f0f0f0; z-index:1; }
    th, td { border:1px solid #ccc; padding:3px; }
    tbody tr:nth-child(even) { background:#fafafa; }
    .day-header td { background:#eef; font-weight:bold; }
    .day-total td { background:#e0f7fa; font-weight:bold; text-align:right; }

    /* Summary row (month) */
    .month-summary { text-align:center; font-size:12px; color:#0d47a1; padding:4px 0; background:#e3f2fd; border-radius:6px; }
    .compare { text-align:center; margin-top:2px; font-size:11px; }

    /* Toggle summary */
    .summary-card { margin-top:12px; padding:8px; background:#f6f6f6; border:1px solid #ddd; border-radius:8px; font-size:11px; line-height:1.4em; }
    .btn { display:inline-block; padding:5px 10px; background:#43a047; color:#fff; border:none; border-radius:6px; cursor:pointer; text-decoration:none; font-size:11px; }

    /* Floating toggle/menu ‚Äî ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏î‡∏¥‡∏° */
    .floating-toggle { position:fixed; bottom:env(safe-area-inset-bottom, 18px); left:50%; transform:translateX(-50%); background:rgba(0,0,0,0); width:58px; height:58px; border-radius:50%; display:flex; justify-content:center; align-items:center; z-index:1000; cursor:pointer; }
    .floating-menu { position:fixed; bottom:90px; left:50%; transform:translateX(-50%); background:#fff; border-radius:16px; padding:10px; display:none; flex-direction:column; align-items:center; gap:10px; box-shadow:0 6px 20px rgba(0,0,0,.2); z-index:999; max-height:60vh; overflow-y:auto; }
    .floating-menu a img { width:52px; height:52px; }
  </style>
</head>
<body>

  <div class="search-container">
    <input type="text" id="searchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô..." />
  </div>

  <div class="container">
    <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
    <div id="reviewSection">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    <div style="text-align:center; margin-top:8px;">
      <button id="downloadExcelBtn" class="btn" style="background:#00796b;">‚¨áÔ∏è ‡πÇ‡∏´‡∏•‡∏î Excel</button>
    </div>
  </div>

  <!-- Floating toggle/menu (Jinja URLs ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -->
  <div id="floatingToggle" class="floating-toggle">
    <img src="{{ url_for('static', filename='icon/icon_menu_toggle.png') }}" alt="menu" style="width:60px;height:60px;" />
  </div>
  <div id="floatingMenu" class="floating-menu">
    <a href="{{ url_for('dashboard') }}"><img src="{{ url_for('static', filename='icon/icon_dashboard.png') }}" alt="dashboard" /></a>
    <a href="{{ url_for('sale_summary') }}"><img src="{{ url_for('static', filename='icon/icon_sale_summary.png') }}" alt="sale" /></a>
    <a href="{{ url_for('record_sales') }}"><img src="{{ url_for('static', filename='icon/icon_record_sales.png') }}" alt="record" /></a>
    <a href="{{ url_for('customer_list') }}"><img src="{{ url_for('static', filename='icon/icon_customer_list.png') }}" alt="customers" /></a>
    <a href="{{ url_for('record_customer') }}"><img src="{{ url_for('static', filename='icon/icon_customer_history.png') }}" alt="history" /></a>
    <a href="{{ url_for('oldsaledata') }}"><img src="{{ url_for('static', filename='icon/icon_old_customers.png') }}" alt="old" /></a>
    <a href="{{ url_for('inventory') }}"><img src="{{ url_for('static', filename='icon/icon_inventory.png') }}" alt="inventory" /></a>
  </div>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
  // ===== Config & Helpers =====
  const subOptionsMap = {
    "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": ["Aestox 50 u", "Aestox 100 u", "Allergan 50 u", "Allergan 100 u"],
    "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥", "Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á", "E.P.T.Q ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢", "Restylane ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢"],
    "Fat/Hifu": ["Bromi", "Sisi", "HIFU", "HIFU ‡πÅ‡∏ñ‡∏°"],
    "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": ["Meso Chanel", "P - Cell", "Aquatic", "Hestina", "Exosome", "Rejuran", "Belotero Revive", "Sculptra", "Juvelook", "Aesthefill"],
    "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster"],
    "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": ["‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤", "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤", "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÑ‡∏´‡∏° PDO", "‡πÑ‡∏´‡∏° Collagen", "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô/‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"],
    "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": ["‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤"]
  };
  subOptionsMap["‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©"] = [...new Set(Object.values(subOptionsMap).flat())];

  const thaiMonthsFull = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô","‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];

  function formatDate(dateStr){ if(!dateStr) return ''; const [y,m,d] = dateStr.split('-'); return `${d}/${m}/${y.slice(-2)}`; }
  function daysInMonth(year, month){ return new Date(year, month, 0).getDate(); }
  function daysToCompareForMonth(year, month){ const now=new Date(); const isCurrent=(now.getFullYear()===year && (now.getMonth()+1)===month); const lastDay=daysInMonth(year,month); return isCurrent? Math.min(now.getDate(), lastDay) : lastDay; }
  function parseLine(itemText){ const m=itemText.match(/^(.*?) ?(?:\((.*?)\))? - (\d+) ‡∏ä‡∏¥‡πâ‡∏ô(?: x (\d+) ‡∏ö‡∏≤‡∏ó)?/); if(!m) return null; return { main:(m[1]||'').trim(), sub:(m[2]||'').trim(), qty:parseInt(m[3],10)||0, price:parseInt(m[4],10)||0 }; }
  function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

  // ===== State =====
  let allCustomerRecords = [];
  let allSalesRecords = [];

  // ===== Fetch & Render =====
  fetch('/api/sales')
    .then(res=>res.json())
    .then(data=>{
      if(!data || data.length===0){ document.getElementById('reviewSection').textContent='‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢'; return; }
      const records = data.map(rec => ({ ...rec, items: typeof rec.items === 'string' ? JSON.parse(rec.items) : rec.items }));
      saveAllRecords(records);
    })
    .catch(err=>{ console.error(err); document.getElementById('reviewSection').textContent='‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; });

  function saveAllRecords(records){
    allCustomerRecords = records;
    allSalesRecords = records;

    const reviewSection = document.getElementById('reviewSection');
    reviewSection.innerHTML = '';

    // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    const groupedByMonth = {};
    const chartData = [];

    records.forEach(rec=>{
      const month = rec.date?.slice(0,7);
      if(!groupedByMonth[month]) groupedByMonth[month] = [];
      groupedByMonth[month].push(rec);
    });

    const sortedMonths = Object.keys(groupedByMonth).sort((a,b)=> new Date(b+'-01') - new Date(a+'-01'));

    sortedMonths.forEach(month=>{
      const recs = groupedByMonth[month];
      const total = recs.reduce((sum, r)=> sum + (parseFloat(r.amount)||0), 0);
      chartData.push({ month, total });

      // ‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ (qty/amount)
      const itemSummary = {}; const itemTotal = {}; const promoItemSummary = {}; const promoItemTotal = {};
      recs.forEach(rec=>{
        (rec.items||[]).forEach(text=>{ const p=parseLine(text); if(!p) return; const value=p.qty*p.price; if(p.main==='‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©'){ const key=p.sub||p.main; promoItemSummary[key]=(promoItemSummary[key]||0)+p.qty; promoItemTotal[key]=(promoItemTotal[key]||0)+value; } else { const key=p.sub||p.main; itemSummary[key]=(itemSummary[key]||0)+p.qty; itemTotal[key]=(itemTotal[key]||0)+value; } });
      });

      // Header ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô + ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö MTD
      const [y,m] = month.split('-').map(n=>parseInt(n,10));
      const monthIndex = m-1;
      const summaryRow = document.createElement('div'); summaryRow.className='month-summary'; summaryRow.textContent = `üìÜ ${thaiMonthsFull[monthIndex]} ${y} ‚Äî ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ${total.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

      const prevMonthDate = new Date(y, m-2, 1);
      const prevMonth = `${prevMonthDate.getFullYear()}-${String(prevMonthDate.getMonth()+1).padStart(2,'0')}`;
      const limitDayCurr = daysToCompareForMonth(y, m);
      const currToDateTotal = recs.filter(r=> (parseInt(r.date?.split('-')[2])||0) <= limitDayCurr).reduce((s,r)=> s+(parseFloat(r.amount)||0), 0);
      const prevRecs = groupedByMonth[prevMonth] || [];
      const [py, pm] = prevMonth.split('-').map(n=>parseInt(n,10));
      const limitDayPrev = pm ? daysToCompareForMonth(py, pm) : 0;
      const prevToDateTotal = prevRecs.filter(r=> (parseInt(r.date?.split('-')[2])||0) <= limitDayPrev).reduce((s,r)=> s+(parseFloat(r.amount)||0), 0);
      const diff = currToDateTotal - prevToDateTotal;

      const compareDiv = document.createElement('div'); compareDiv.className='compare'; compareDiv.style.color = diff>0 ? 'green' : diff<0 ? 'crimson' : '#555';
      compareDiv.textContent = diff>0 ? `üìà ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${limitDayCurr}: ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ${diff.toLocaleString()} ‡∏ö‡∏≤‡∏ó` : diff<0 ? `üìâ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${limitDayCurr}: ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ${Math.abs(diff).toLocaleString()} ‡∏ö‡∏≤‡∏ó` : `üìä ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${limitDayCurr}: ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤`;

      const monthWrap = document.createElement('div'); monthWrap.appendChild(summaryRow); monthWrap.appendChild(compareDiv); reviewSection.appendChild(monthWrap);

      // ===== ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô =====
      const table = document.createElement('table');
      table.innerHTML = `<thead><tr><th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏¢‡∏≠‡∏î</th></tr></thead><tbody></tbody>`;
      const tbody = table.querySelector('tbody');

      const sortedRecs = recs.slice().sort((a,b)=> new Date(b.date) - new Date(a.date));
      let currentDate = ''; let subIndex = 1; let dailyTotal = 0;

      function pushDayHeader(dateStr){ const tr=document.createElement('tr'); tr.className='day-header'; const td=document.createElement('td'); td.colSpan=5; td.textContent=`üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr}`; tr.appendChild(td); tbody.appendChild(tr); }
      function pushDayTotal(){ const tr=document.createElement('tr'); tr.className='day-total'; const td=document.createElement('td'); td.colSpan=5; td.innerHTML=`üíµ ${dailyTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`; tr.appendChild(td); tbody.appendChild(tr); }

      sortedRecs.forEach(r=>{
        const formattedDate = formatDate(r.date);
        if(formattedDate !== currentDate){ if(currentDate !== '') pushDayTotal(); currentDate = formattedDate; subIndex = 1; dailyTotal = 0; pushDayHeader(formattedDate); }
        const rowTotal = parseFloat(r.amount)||0; dailyTotal += rowTotal;

        // ‚úÖ ‡πÉ‡∏ä‡πâ buildRow ‡∏ï‡∏≤‡∏°‡∏™‡πÄ‡∏õ‡∏Å (‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° + OPD ‡πÉ‡∏ï‡πâ‡∏ä‡∏∑‡πà‡∏≠ + ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢)
        const tr = buildRow(r, subIndex++);
        tbody.appendChild(tr);
      });
      if(currentDate !== '') pushDayTotal();

      reviewSection.appendChild(table);

      // ===== ‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏°‡∏ß‡∏î =====
      function renderItemSummary(title, qtyMap, totalMap, totalFromItems){
        const totalQty = Object.values(qtyMap).reduce((a,b)=>a+b,0);
        const keys = Object.keys(qtyMap).sort((a,b)=> (totalMap[b]||0)-(totalMap[a]||0));
        let html = `<div style="margin-bottom:10px;"><strong>${title} ${totalQty.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô, ‡∏£‡∏ß‡∏° ${totalFromItems.toLocaleString()} ‡∏ö‡∏≤‡∏ó</strong><ul style="padding-left:20px; margin:5px 0;">`;
        keys.forEach(name=>{ const qty = qtyMap[name]||0; const itemTotal = totalMap[name]||0; html += `<li>${name} ‚Äî ${qty} ‡∏ä‡∏¥‡πâ‡∏ô, ${itemTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó</li>`; });
        html += '</ul></div>';
        return html;
      }
      let normalAmount = 0, promoAmount = 0;
      recs.forEach(rec=>{ (rec.items||[]).forEach(text=>{ const p=parseLine(text); if(!p) return; const value=p.qty*p.price; if(p.main==='‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©') promoAmount += value; else normalAmount += value; }); });

      const summaryDiv = document.createElement('div'); summaryDiv.className='summary-card';
      const summaryHTML = `${renderItemSummary('‚≠ê ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', itemSummary, itemTotal, normalAmount)}${renderItemSummary('üéÅ ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô', promoItemSummary, promoItemTotal, promoAmount)}`;
      summaryDiv.innerHTML = `<button class="btn" id="toggleSummaryBtn" aria-expanded="false">üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</button><div id="summaryContent" style="display:none;">${summaryHTML}</div>`;
      reviewSection.appendChild(summaryDiv);
    });

    // ===== Chart =====
    const canvasContainer = document.createElement('div'); canvasContainer.style.marginTop='30px'; canvasContainer.style.height='280px';
    const canvas = document.createElement('canvas'); canvas.id='salesChart'; canvasContainer.appendChild(canvas); reviewSection.appendChild(canvasContainer);

    chartData.sort((a,b)=> a.month.localeCompare(b.month));
    const ctx = canvas.getContext('2d');
    if(ctx){ new Chart(ctx, { type:'bar', data:{ labels: chartData.map(d=>d.month), datasets:[{ label:'‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)', data: chartData.map(d=>d.total) }] }, options:{ responsive:true, maintainAspectRatio:false } }); }
  }

  // ===== ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß (‡∏ï‡∏≤‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á) =====
  function buildRow(r, subIndex){
    const tr = document.createElement('tr');

    const tdIndex = document.createElement('td');
    tdIndex.textContent = subIndex;
    tr.appendChild(tdIndex);

    const tdName = document.createElement('td');
    tdName.innerHTML = `<div><strong class="open-customer" style="cursor:pointer;color:#0277bd;" data-key="${encodeURIComponent(r.name+'|'+(r.phone||''))}">${escapeHtml(r.name||'')}</strong><div style=\"font-size:10px;color:#777;\">OPD: ${escapeHtml(r.opd||'-')}</div></div>`;
    tr.appendChild(tdName);

    const tdPhone = document.createElement('td');
    tdPhone.innerHTML = `<span style=\"cursor:pointer;color:#0288d1;\" onclick=\"if(this.dataset.showing==='true'){this.innerText='üìû';this.dataset.showing='false';}else{this.innerText='${(r.phone||'').replace(/\"/g,'&quot;')}';this.dataset.showing='true';}\" data-showing='false'>üìû</span>`;
    tr.appendChild(tdPhone);

    // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö bullet
    const itemsUl = (r.items||[]).map(item=>{
      const m = item.match(/^(.*?) ?(?:\((.*?)\))? - (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
      if(m){ const main=m[1], sub=m[2], qty=m[3]; return `<li>${sub? `${escapeHtml(main)} (${escapeHtml(sub)}` : escapeHtml(main)}${sub?')':''} - ${qty} ‡∏ä‡∏¥‡πâ‡∏ô</li>`; }
      return `<li>${escapeHtml(item)}</li>`;
    }).join('');

    const tdItems = document.createElement('td');
    tdItems.innerHTML = `<ul style='margin:0; padding-left:16px;'>${itemsUl}</ul>`;
    tr.appendChild(tdItems);

    const tdAmt = document.createElement('td');
    tdAmt.textContent = `${r.amount} ‡∏ö‡∏≤‡∏ó (${r.payment||''})`;
    tr.appendChild(tdAmt);

    return tr;
  }

  // ===== Events =====
  document.getElementById('downloadExcelBtn').addEventListener('click', downloadExcel);

  const onSearch = debounce(()=>{
    const val = (document.getElementById('searchInput').value||'').trim().toLowerCase();
    document.querySelectorAll('table tbody tr').forEach(row=>{
      if(row.classList.contains('day-header') || row.classList.contains('day-total')){ row.style.display=''; return; }
      const text = row.textContent.toLowerCase(); row.style.display = text.includes(val) ? '' : 'none';
    });
  }, 200);
  document.getElementById('searchInput').addEventListener('input', onSearch);

  document.addEventListener('click', (e)=>{
    const el = e.target.closest('.open-customer'); if(!el) return; const key = decodeURIComponent(el.dataset.key || ''); openCustomerModal(key);
  });

  document.addEventListener('click', (e)=>{ if(e.target && e.target.id === 'toggleSummaryBtn'){ const content=document.getElementById('summaryContent'); const expanded=content.style.display==='block'; content.style.display= expanded? 'none':'block'; e.target.setAttribute('aria-expanded', (!expanded).toString()); } });

  document.getElementById('floatingToggle').addEventListener('click', (e)=>{ e.stopPropagation(); const menu=document.getElementById('floatingMenu'); menu.style.display = (menu.style.display==='flex') ? 'none':'flex'; });
  document.addEventListener('click', (e)=>{ const toggle=document.getElementById('floatingToggle'); const menu=document.getElementById('floatingMenu'); if(!toggle.contains(e.target) && !menu.contains(e.target)) menu.style.display='none'; });

  // ===== Modal functions =====
  function openCustomerModal(key){
    const records = allCustomerRecords.filter(r=> `${r.name}|${r.phone}` === key);
    if(records.length===0) return;

    const first = records[0];
    const customer = { name:first.name, phone:first.phone||'-', opd:first.opd||'-' };

    const latestRecord = records.reduce((latest, r)=> new Date(r.date) > new Date(latest.date) ? r : latest, records[0]);
    const lastDate = new Date(latestRecord.date);
    const today = new Date();
    const daysAbsent = Math.floor( (today - lastDate) / (1000*60*60*24) );

    const paidRecords = records.filter(r=> parseFloat(r.amount||0) > 0);
    const paidVisits = paidRecords.length;
    const totalAmount = paidRecords.reduce((s,r)=> s + parseFloat(r.amount||0), 0);
    const average = paidVisits>0 ? Math.round(totalAmount/paidVisits) : 0;

    const allItems = {};
    records.forEach(r=>{ (r.items||[]).forEach(item=>{ let name=item; const m=item.match(/\((.*?)\)/); if(m){ name=m[1]; } else { name=item.split(' - ')[0]; } const qtyMatch=item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/); const qty= qtyMatch? parseInt(qtyMatch[1],10) : 1; allItems[name]=(allItems[name]||0)+qty; }); });

    const categorizedItems = {};
    for(const [cat, names] of Object.entries(subOptionsMap)){
      names.forEach(n=>{ if(allItems[n]){ if(!categorizedItems[cat]) categorizedItems[cat]=[]; categorizedItems[cat].push(`${n} : ${allItems[n]}`); delete allItems[n]; } });
    }
    if(Object.keys(allItems).length){ categorizedItems['‡∏≠‡∏∑‡πà‡∏ô‡πÜ'] = Object.entries(allItems).map(([n,q])=>`${n} : ${q}`); }

    const itemSummary = Object.entries(categorizedItems).map(([cat, items])=> `<div style="margin-bottom:6px;"><strong>${cat}</strong>: ${items.join(' | ')}</div>`).join('');

    const historyHtml = records.sort((a,b)=> b.date.localeCompare(a.date)).map(r=>{
      const itemsHtml = (r.items||[]).map(item=>{ let name=item; const m=item.match(/\((.*?)\)/); if(m){ name=m[1]; } else { name=item.split(' - ')[0]; } const qtyMatch=item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/); const qty = qtyMatch? parseInt(qtyMatch[1],10) : 1; return `<li>${name} : ${qty}</li>`; }).join('');
      const noteText = r.note ? `<div style=\"margin-top:2px; font-style:italic; color:#444;\">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${escapeHtml(r.note)}</div>` : '';
      return `<div style=\"margin-bottom:16px;\"><div style=\"margin-bottom:4px;font-weight:bold;\">üìÖ ${formatDate(r.date)}</div><ul style=\"padding-left:16px;margin:0;\">${itemsHtml}</ul><div style=\"margin-top:4px;color:#00796b;\">üíµ ‡∏¢‡∏≠‡∏î: ${(parseFloat(r.amount||0)).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>${noteText}<hr style=\"margin: 10px auto; border: 0; border-top: 1px dashed #999; width: 60%;\"></div>`; }).join('');

    const modal = document.getElementById('modal-content');
    modal.innerHTML = '';

    const controls = document.createElement('div'); controls.style.position='absolute'; controls.style.top='10px'; controls.style.right='46px'; controls.style.display='flex'; controls.style.gap='10px';
    const saveBtn = document.createElement('button'); saveBtn.title='‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'; saveBtn.style.cssText='background:white; border:none; border-radius:50%; width:36px; height:36px; box-shadow:0 2px 6px rgba(0,0,0,.15); cursor:pointer; display:flex; align-items:center; justify-content:center;'; saveBtn.textContent='üíæ'; saveBtn.addEventListener('click', saveModalAsImage);
    controls.appendChild(saveBtn); document.getElementById('customer-modal-box').appendChild(controls);

    const title = document.createElement('h3'); title.style.fontSize='18px'; title.style.marginBottom='4px'; title.textContent = `üìá ${customer.name}`;
    const d1 = document.createElement('div'); d1.innerHTML = `üÜî <strong>OPD:</strong> ${escapeHtml(customer.opd)}`;
    const d2 = document.createElement('div'); d2.innerHTML = `üìû <strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå:</strong> ${escapeHtml(customer.phone)}`;
    const d3 = document.createElement('div'); d3.innerHTML = `üìÖ <strong>‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${formatDate(latestRecord.date)} <span style="color:red;">(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß: ${daysAbsent} ‡∏ß‡∏±‡∏ô)</span>`;
    const d4 = document.createElement('div'); d4.style.color='#00796b'; d4.innerHTML = `<strong>üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</strong> ${totalAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

    const d5 = document.createElement('div'); d5.innerHTML = `üîÅ ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£: ${records.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${paidVisits} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô)`;
    const d6 = document.createElement('div'); d6.innerHTML = `üí≥ <strong>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á:</strong> ${Math.round(average).toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

    const hr1 = document.createElement('hr'); hr1.style.cssText='margin:16px auto 8px; border:0; border-top:1px solid #ccc; width:60%';
    const sumTitle = document.createElement('div'); sumTitle.style.fontWeight='bold'; sumTitle.textContent = 'üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:';
    const sumDiv = document.createElement('div'); sumDiv.style.margin='6px 0 12px'; sumDiv.innerHTML = itemSummary;

    const hr2 = document.createElement('hr'); hr2.style.cssText='margin:16px auto 8px; border:0; border-top:1px solid #ccc; width:60%';
    const histTitle = document.createElement('div'); histTitle.style.fontWeight='bold'; histTitle.style.marginBottom='6px'; histTitle.textContent='üõçÔ∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á:';

    const histWrap = document.createElement('div'); histWrap.innerHTML = historyHtml;
    const totalWrap = document.createElement('div'); totalWrap.style.cssText='margin-top:10px;font-weight:bold;color:#b8860b;'; totalWrap.textContent = `üí∞ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

    modal.appendChild(title); modal.appendChild(d1); modal.appendChild(d2); modal.appendChild(d3); modal.appendChild(d4); modal.appendChild(d5); modal.appendChild(d6);
    modal.appendChild(hr1); modal.appendChild(sumTitle); modal.appendChild(sumDiv);
    modal.appendChild(hr2); modal.appendChild(histTitle); modal.appendChild(histWrap); modal.appendChild(totalWrap);

    document.getElementById('customer-modal').style.display='flex';
  }

  function closeCustomerModal(){
    document.getElementById('customer-modal').style.display='none';
    const box = document.getElementById('customer-modal-box');
    [...box.querySelectorAll('div')].forEach(div=>{ if(div.style && div.style.position==='absolute' && div.style.top==='10px') div.remove(); });
  }

  function saveModalAsImage(){
    const node = document.getElementById('modal-content');
    if(!node){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô modal'); return; }
    html2canvas(node, { scale:2 }).then(canvas=>{
      const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      if(isIOS){
        const previewArea = document.createElement('div');
        previewArea.style.marginTop='20px';
        previewArea.id='modalImagePreview';
        previewArea.innerHTML = `<div style="font-weight:bold; margin-bottom:6px;">‡πÅ‡∏ï‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ</div><img src="${dataUrl}" style="width:100%; border:1px solid #ccc; border-radius:12px;" />`;
        const existing = document.getElementById('modalImagePreview'); if(existing) existing.remove();
        node.appendChild(previewArea);
      } else {
        const link = document.createElement('a'); link.download='customer-info.jpg'; link.href = dataUrl; link.click();
      }
    }).catch(err=>{ console.error('‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', err); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'); });
  }

  function escapeHtml(str){ return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

  // ===== Excel Export =====
  function downloadExcel(){
    if(!allSalesRecords || allSalesRecords.length===0){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î'); return; }
    const sortedRecs = allSalesRecords.slice().sort((a,b)=> new Date(b.date) - new Date(a.date));

    const ws_data = [];
    let currentDate = '';
    let dailyTotal = 0;

    sortedRecs.forEach(r=>{
      const formattedDate = formatDate(r.date);
      const items = (r.items||[]).map(item=>{
        const m = item.match(/^(.*?) ?(?:\((.*?)\))? - (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
        if(m){ const main=m[1], sub=m[2], qty=m[3]; return sub? `${main} (${sub}) - ${qty} ‡∏ä‡∏¥‡πâ‡∏ô` : `${main} - ${qty} ‡∏ä‡∏¥‡πâ‡∏ô`; }
        return item;
      }).join('\n');

      if(formattedDate !== currentDate){
        if(currentDate !== ''){ ws_data.push(['','','','‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô', dailyTotal, '']); ws_data.push([]); }
        currentDate = formattedDate; dailyTotal = 0; ws_data.push([`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formattedDate}`]); ws_data.push(['OPD','‡∏ä‡∏∑‡πà‡∏≠','‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','‡∏¢‡∏≠‡∏î (‡∏ö‡∏≤‡∏ó)','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']);
      }
      dailyTotal += parseFloat(r.amount)||0;
      ws_data.push([ r.opd||'', r.name, r.phone||'', items, parseFloat(r.amount)||0, r.note||'' ]);
    });
    if(currentDate !== '') ws_data.push(['','','','‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô', dailyTotal, '']);

    const worksheet = XLSX.utils.aoa_to_sheet(ws_data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô');
    XLSX.writeFile(workbook, '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô.xlsx');
  }
</script>

<!-- Modal ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
<div id="customer-modal" style="display:none;position:fixed;inset:0;background-color:rgba(0,0,0,.5);z-index:9999;justify-content:center;align-items:center;">
  <div id="customer-modal-box" style="background:#fff;padding:16px;border-radius:16px;width:100%;max-width:360px;box-sizing:border-box;margin:auto;max-height:90vh;overflow:auto;position:relative;font-size:13.5px;">
    <button id="closeCustomerModalBtn" style="position:absolute;top:10px;right:14px;font-size:20px;border:none;background:none;cursor:pointer;" aria-label="‡∏õ‡∏¥‡∏î">&times;</button>
    <div id="modal-content"></div>
  </div>
</div>

</body>
</html>
