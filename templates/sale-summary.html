<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="format-detection" content="telephone=no">
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</title>

  <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå: ‡πÄ‡∏£‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î + ‡∏Å‡∏±‡∏ô‡πÄ‡∏î‡πâ‡∏á + subset ‡πÑ‡∏ó‡∏¢ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap&subset=thai" rel="stylesheet" />

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary: #00897b;
      --primary-dark: #00695c;
      --accent: #f9a825; /* ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏á‡∏¥‡∏ô */
      --bg-soft: #f4f7f6;
      --text-main: #374151;
      --text-light: #6b7280;
      --white: #ffffff;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --radius: 16px;
    }

    html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }
    body{
      font-family:'Prompt','Segoe UI',Tahoma,sans-serif;
      margin:0; background: var(--bg-soft); padding:10px;
      font-size:12px; line-height:1.6; color: var(--text-main);
    }
    h2{ text-align:center; color:var(--primary); font-size:18px; margin:0 0 15px; font-weight: 600; }

    /* Container */
    .container{
      max-width:1000px; margin:20px auto;
      background:var(--white); border-radius:var(--radius);
      padding:20px; box-shadow:var(--shadow-md);
    }

    /* Month nav */
    .month-nav{ display:flex; gap:8px; align-items:center; justify-content:center; margin-bottom:20px; flex-wrap:wrap; }
    .month-btn{
      background:var(--white); color:var(--text-main); border:1px solid #e5e7eb;
      border-radius:20px; padding:6px 14px; cursor:pointer;
      transition: all 0.2s; font-weight: 500; font-size: 0.9rem;
      box-shadow: var(--shadow-sm);
    }
    .month-btn:hover{ background: #f9fafb; border-color: var(--primary); color: var(--primary); }
    .month-btn:active{ transform: scale(0.98); }
    .month-btn.primary-action{ background: var(--primary); color: white; border:none; }
    .month-btn:disabled{ opacity:.5; cursor:not-allowed; }
    #monthPicker{ position:absolute; left:-9999px; width:0; height:0; }
    .current-range{ font-size:12px; color:var(--primary); padding:4px 12px; background:#e0f2f1; border-radius:20px; font-weight: 600;}
    .month-btn.ghost{ background:#fff; }

    /* Table Styling */
    table{ width:100%; border-collapse:collapse; margin-top:15px; font-size:11.5px; table-layout:auto; }
    thead th{
      position:sticky; top:0; background:#f8fafc; color: var(--text-light);
      font-weight: 600; padding: 12px 8px; border-bottom: 2px solid #e2e8f0; z-index:1; text-align: left;
    }
    th, td{ padding:10px 8px; white-space:normal; word-break:break-word; border-bottom: 1px solid #f1f5f9; border-left: none; border-right: none;}

    /* ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÅ‡∏Ç‡πá‡∏á‡πÜ ‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å */
    td { border: none; border-bottom: 1px solid #f0f0f0; }

    thead th:nth-child(4), tbody td:nth-child(4){ width:45%; } /* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */

    tbody tr{ transition: background 0.1s; }
    tbody tr:hover{ background: #f9fafb; }

    .day-header td{
      background: #e0f2f1; color: var(--primary-dark);
      padding: 8px 12px; border-radius: 8px; font-weight:600; font-size: 13px;
    }
    .day-total td{
      background: #fff8e1; color: #b45309;
      font-weight:bold; text-align:right; border-bottom: 2px solid #fef3c7;
    }

    /* Month Summary */
    .month-summary{
      text-align:center; font-size:16px; font-weight: 600;
      color:var(--primary-dark); margin-bottom: 5px;
    }
    .compare{ text-align:center; font-size:12px; margin-bottom: 15px; opacity: 0.8; }

    .btn{
      display:inline-flex; align-items: center; justify-content: center; gap: 5px;
      padding:8px 16px; background:var(--primary); color:#fff;
      border:none; border-radius:8px; cursor:pointer; text-decoration:none;
      font-size:12px; font-weight: 500; box-shadow: 0 4px 6px -1px rgba(0, 137, 123, 0.4);
      transition: transform 0.2s;
    }
    .btn:active { transform: scale(0.96); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; box-shadow: none; background: #9ca3af; }

    
    /* Search (‡∏°‡∏µ‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ô error ‡∏ñ‡πâ‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÉ‡∏™‡πà UI ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤) */
    .search-wrap{ position:fixed; bottom:130px; left:50%; transform:translateX(-50%); z-index:1001; display:flex; align-items:center; gap:8px; width:90%; max-width:600px; justify-content:center; pointer-events:none; }
    .search-fab{ pointer-events:auto; display:flex; align-items:center; justify-content:center; width:50px; height:50px; border-radius:50%; background:var(--primary); box-shadow:0 8px 20px rgba(0,137,123,0.3); border:none; cursor:pointer; transition: transform 0.2s; }
    .search-fab:active { transform: scale(0.9); }
    .search-fab img{ width:24px; height:24px; filter:invert(100%); }
    .search-panel{ pointer-events:auto; display:flex; align-items:center; gap:6px; background:#fff; border-radius:30px; padding:6px 12px; box-shadow:0 8px 30px rgba(0,0,0,.15); width:0; max-width:0; overflow:hidden; transition:all .3s ease; opacity:0; }
    .search-wrap.open .search-panel{ max-width:600px; width:calc(100% - 80px); opacity:1; padding:8px 16px; }
    .search-panel input{ width:100%; border:none; outline:none; background:transparent; font-size:14px; color:#333; }
    .search-close{ border:none; background:#f3f4f6; border-radius:50%; width:32px; height:32px; cursor:pointer; display:flex; align-items:center; justify-content:center; color: #666; font-size: 20px;}

    /* Global shrink switch */
    :root{ --shrink:.95; }
    body{ font-size: calc(12px * var(--shrink)); }

    /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ Prompt */
    * { font-family: 'Prompt', sans-serif !important; -webkit-font-smoothing: antialiased; }

    /* ===== Mobile Compact Mode: ‡∏¢‡πà‡∏≠‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ===== */
    @media (max-width: 600px) {
      :root { --shrink: 0.6; }
      body { padding: 4px; }
      .container { padding: 10px; border-radius: 12px; margin: 5px auto; }
      h2 { font-size: 16px; margin-bottom: 10px; }
      .month-btn { padding: 4px 10px; font-size: 10px; }
      .month-nav { gap: 5px; margin-bottom: 10px; }
      table { margin-top: 10px; }
      th, td { padding: 6px 3px; font-size: 11px; }
      thead th:nth-child(1) { width: 20px; }
      .day-header td { padding: 4px 8px; font-size: 11.5px; }
       }

    /* ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ */
    thead { display: none !important; }

    /* ===============================
       Customer Profile Modal (NEW)
       =============================== */
    #customer-modal{
      display:none;
      position:fixed;
      inset:0;
      background-color:rgba(0,0,0,0.5);
      z-index:9999;
      justify-content:center;
      align-items:center;
      padding: 16px;
    }
    #customer-modal-box{
      width:auto;
      max-width: 90vw;
      max-height: 90vh;
      font-size: 13.5px;
      padding: 16px;
      border-radius: 16px;
      overflow:auto;
      background: white;
      box-sizing: border-box;
      position:relative;
    }
    #customer-modal-box .close-x{
      position:absolute;
      top:10px;
      right:14px;
      font-size:20px;
      border:none;
      background:none;
      cursor:pointer;
    }

    /* Header */
    .profile-header{
      display:flex;
      align-items:center;
      gap:15px;
      margin-bottom: 15px;
      background:#f8fafc;
      padding: 15px;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }
    .profile-img-box{
      width:70px;
      height:70px;
      border-radius:50%;
      overflow:hidden;
      border:3px solid white;
      box-shadow:0 4px 10px rgba(0,0,0,0.1);
      background-color:#e2e8f0;
      flex-shrink:0;
      cursor: zoom-in;
    }
    .profile-img-box img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .profile-info{ flex:1; }
    .profile-info h3{
      margin:0 0 4px 0;
      font-size:18px;
      color:#0f766e;
    }
    .profile-badges{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#e0f2f1;
      color:#004d40;
      font-size:12px;
    }
    .badge-vip{
      background-color:#fef3c7;
      color:#92400e;
      font-size:10px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #fcd34d;
    }
    .profile-actions{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn-mini{
      border:none;
      padding:6px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:12px;
      background:#009688;
      color:#fff;
    }
    .btn-mini.secondary{
      background:#eceff1;
      color:#37474f;
    }
    .btn-mini:hover{ opacity:.92; }

    /* Summary grid */
    .profile-summary-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      font-size:12px;
      margin-bottom:15px;
    }
    .profile-summary-box{
      padding:8px;
      border-radius:8px;
    }
    .profile-summary-box.total{ background:#e0f2f1; color:#00695c; }
    .profile-summary-box.avg{ background:#f1f8e9; color:#33691e; }
    .profile-summary-box.visits{ background:#fff3e0; color:#e65100; }
    .profile-summary-box.last{ background:#ffebee; color:#c62828; }

    /* Image Viewer */
    .img-viewer{
      display:none;
      position:fixed;
      inset:0;
      z-index:20000;
      background:rgba(0,0,0,.75);
      justify-content:center;
      align-items:center;
      padding:16px;
    }
    .img-viewer__panel{
      width:min(92vw,720px);
      max-height:92vh;
      background:transparent;
      position:relative;
    }
    .img-viewer__img{
      width:100%;
      height:auto;
      max-height:92vh;
      object-fit:contain;
      border-radius:14px;
      background:#111;
      box-shadow:0 16px 50px rgba(0,0,0,.35);
    }
    .img-viewer__close{
      position:absolute;
      top:-10px;
      right:-10px;
      width:40px;
      height:40px;
      border:none;
      border-radius:50%;
      cursor:pointer;
      font-size:18px;
      background:#fff;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
    }

    @media (max-width: 480px){
      #customer-modal-box{ max-width:94vw; padding:12px; }
      .profile-info h3{ font-size:16px; }
    }
  </style>
</head>
<body>
<!-- ‚úÖ floating menu -->
{% include 'floating_menu.html' %}
  <div class="container">
    <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>

    <!-- ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
    <div class="month-nav">
      <button id="btnPrev" class="month-btn" type="button" title="‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤">‚Üê ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
      <button id="btnPick" class="month-btn" type="button" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
      <button id="btnClear" class="month-btn ghost" type="button" title="‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á">‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á</button>
      <button id="btnNext" class="month-btn" type="button" title="‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
      <span id="rangeBadge" class="current-range" style="display:none;"></span>
      <input type="month" id="monthPicker" />
    </div>

    <div id="reviewSection">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    <div style="text-align:center; margin-top:8px;">
      <button id="downloadExcelBtn" class="btn" type="button" style="background:#00796b;" disabled>‚¨áÔ∏è ‡πÇ‡∏´‡∏•‡∏î Excel</button>
    </div>
  </div>

  

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <!-- ===== Customer Modal (NEW) ===== -->
  <div id="customer-modal">
    <div id="customer-modal-box">
      <button class="close-x" type="button" onclick="closeCustomerModal()" aria-label="‡∏õ‡∏¥‡∏î">&times;</button>
      <div id="modal-content"></div>
    </div>
  </div>

  <!-- ===== Image Viewer (NEW) ===== -->
  <div id="imgViewer" class="img-viewer" onclick="closeImgViewer()">
    <div class="img-viewer__panel" onclick="event.stopPropagation()">
      <button class="img-viewer__close" type="button" onclick="closeImgViewer()">‚úï</button>
      <img id="imgViewerImg" class="img-viewer__img" src="" alt="Profile Large">
    </div>
  </div>

  <!-- hidden file input (NEW) -->
  <input id="profileUploadInput" type="file" accept="image/*" style="display:none;">

  <!-- Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ -->
  <div id="month-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:10000;justify-content:center;align-items:center;">
    <div id="month-modal-box" style="background:#fff;padding:16px;border-radius:12px;width:100%;max-width:340px;box-sizing:border-box;position:relative;">
      <button type="button" id="monthCloseBtn" aria-label="‡∏õ‡∏¥‡∏î" style="position:absolute;top:8px;right:10px;border:none;background:none;font-size:20px;cursor:pointer;">&times;</button>
      <div style="font-weight:600;margin-bottom:12px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <div style="display:flex;gap:8px;align-items:center;">
          <label for="monthStart" style="white-space:nowrap;width:74px;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</label>
          <input type="month" id="monthStart" style="flex:1;" />
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <label for="monthEnd" style="white-space:nowrap;width:74px;">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
          <input type="month" id="monthEnd" style="flex:1;" />
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
        <button type="button" class="btn" id="monthCancelBtn" style="background:#78909c;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="btn" id="monthOkBtn">‡∏ï‡∏Å‡∏•‡∏á</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ===== Helpers =====
    const subOptionsMap = {
      "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": ["Aestox 50 u", "Aestox 100 u", "Allergan 50 u", "Allergan 100 u"],
      "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥", "Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á", "E.P.T.Q", "Restylane", "Ex-Filler"],
      "Fat/Hifu": ["Bromi", "Sisi", "HIFU", "HIFU ‡πÅ‡∏ñ‡∏°"],
      "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": ["Meso Chanel", "P - Cell", "Aquatic", "Hestina", "Exosome", "Rejuran", "Belotero Revive", "Sculptra", "Juvelook", "Aesthefill"],
      "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster"],
      "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": ["‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤", "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤", "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÑ‡∏´‡∏° PDO", "‡πÑ‡∏´‡∏° Collagen", "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô/‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"],
      "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": ["‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤"]
    };
    subOptionsMap["‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©"] = [...new Set(Object.values(subOptionsMap).flat())];

    const thaiMonthsFull = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô","‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];

    const ITEM_RE = /^(.*?)\s*(?:\((.*?)\))?\s*-\s*(\d+)\s*‡∏ä‡∏¥‡πâ‡∏ô(?:\s*[xX*]\s*([\d,.\s]+)(?:\s*(?:‡∏ö‡∏≤‡∏ó|‡∏ø))?)?/;

    function parseCurrency(v){
      if (v == null) return 0;
      if (typeof v === 'number') return isFinite(v) ? v : 0;
      const s = String(v).replace(/[^\d.-]/g,'');
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }
    function parseLine(itemText){
      const m = itemText.match(ITEM_RE);
      if(!m) return null;
      return { main:(m[1]||'').trim(), sub:(m[2]||'').trim(), qty:parseInt(m[3],10)||0, price:parseCurrency(m[4]) };
    }
    function formatDate(dateStr){ if(!dateStr) return ''; const [y,m,d] = dateStr.split('-'); return `${d}/${m}/${y.slice(-2)}`; }
    function monthLabel(ym){ const [y,m]=ym.split('-').map(n=>parseInt(n,10)); return `${thaiMonthsFull[m-1]} ${y}`; }
    function daysInMonth(year, month){ return new Date(year, month, 0).getDate(); }
    function daysToCompareForMonth(year, month){
      const now=new Date();
      const isCurrent=(now.getFullYear()===year && (now.getMonth()+1)===month);
      const lastDay=daysInMonth(year,month);
      return isCurrent? Math.min(now.getDate(), lastDay) : lastDay;
    }
    function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }
    function escapeAttr(str){
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/\"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
    const esc = escapeHtml;

    function pad4(s){
      return String(s || '').replace(/\D/g, '').padStart(4, '0');
    }

    function recordAmount(r){
      const a = parseCurrency(r.amount);
      if (!isNaN(a) && a > 0) return a;

      let sum = 0;
      (r.items || []).forEach(text => {
        const p = parseLine(text);
        if (!p) return;
        sum += (p.qty || 0) * (p.price || 0);
      });
      return sum;
    }

    // ===== State =====
    let allCustomerRecords = [];
    let groupedByMonth = {};
    let monthsSorted = [];
    let selectedMonth = null; // 'YYYY-MM'
    let rangeStart = null;    // 'YYYY-MM'
    let rangeEnd = null;      // 'YYYY-MM'
    let chartInstance = null;

    const isRangeActive = () => !!(rangeStart && rangeEnd);

    // ===== Profile endpoint probing (NEW) =====
    const PROFILE_LIST_ENDPOINTS = [
      '/api/customers',
      '/api/customer_list',
      '/api/customer',
      '/api/customers/list'
    ];
    const PROFILE_UPLOAD_ENDPOINTS = [
      '/api/customer/profile_pic',
      '/api/upload_profile_pic',
      '/api/customer/upload_profile_pic',
      '/api/customers/profile_pic',
      '/api/profile_pic'
    ];

    let ACTIVE_PROFILE_LIST_ENDPOINT = null;
    let ACTIVE_PROFILE_UPLOAD_ENDPOINT = null;

    async function tryFetchJson(endpoints, options){
      for (const url of endpoints){
        try{
          const res = await fetch(url, options);
          if(!res.ok) continue;
          const data = await res.json().catch(()=>null);
          if(data == null) continue;
          return { url, data };
        }catch(e){
          // continue probing
        }
      }
      return { url:null, data:null };
    }

    // ===== Fetch & Init =====
    fetch('/api/sales')
      .then(res=>res.json())
      .then(async (data)=>{
        if(!data || data.length===0){
          document.getElementById('reviewSection').textContent='‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢';
          return;
        }
        const records = data.map(rec => ({
          ...rec,
          items: typeof rec.items === 'string' ? JSON.parse(rec.items) : (rec.items||[])
        }));
        saveAllRecords(records);

        // ‡πÇ‡∏´‡∏•‡∏î map ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á DB (NEW: probe endpoints)
        await loadCustomerProfiles();

        setupMonthState();
        renderView();
        updateMonthButtons();
        document.getElementById('downloadExcelBtn').disabled = false;
      })
      .catch(err=>{
        console.error(err);
        document.getElementById('reviewSection').textContent='‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      });

    function saveAllRecords(records){
      allCustomerRecords = records;
      window.allCustomerRecords = allCustomerRecords;

      groupedByMonth = {};
      records.forEach(rec=>{
        const d = rec.date && /^\d{4}-\d{2}-\d{2}$/.test(rec.date) ? rec.date : null;
        if(!d) return;
        const month = d.slice(0,7);
        (groupedByMonth[month] ??= []).push({
          ...rec,
          amount: parseCurrency(rec.amount),
          items: Array.isArray(rec.items) ? rec.items : []
        });
      });

      monthsSorted = Object.keys(groupedByMonth).sort((a,b)=>{
        const [ay, am] = a.split('-').map(Number);
        const [by, bm] = b.split('-').map(Number);
        return ay === by ? am - bm : ay - by;
      });
    }

    function setupMonthState(){
      selectedMonth = monthsSorted[monthsSorted.length-1] || null;
      rangeStart = null; rangeEnd = null;
      updateRangeBadge();
    }

    function updateRangeBadge(){
      const badge = document.getElementById('rangeBadge');
      if (isRangeActive()){
        badge.style.display = 'inline-block';
        badge.textContent = `${monthLabel(rangeStart)} ‚Äì ${monthLabel(rangeEnd)}`;
      } else {
        badge.style.display = 'none';
        badge.textContent = '';
      }
    }

    // ===== Rendering switch =====
    function renderView(){
      if (isRangeActive()) renderSelectedRange();
      else renderSelectedMonth();

      // (‡∏Å‡∏±‡∏ô error ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ UI search ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
      const input = document.getElementById('searchInput');
      if (input){ input.value=''; onSearch(); }
      toggleSearch(false);
    }

    function destroyChart(){
      if (chartInstance && typeof chartInstance.destroy === 'function') {
        try{ chartInstance.destroy(); }catch{}
        chartInstance = null;
      }
    }

    // ===== Rendering: Range =====
    function renderSelectedRange(){
      const reviewSection = document.getElementById('reviewSection');
      reviewSection.innerHTML = '';

      const monthsInRange = monthsSorted.filter(m=> m >= rangeStart && m <= rangeEnd);
      if (monthsInRange.length === 0){
        reviewSection.innerHTML = '<div style="text-align:center;padding:20px;color:#888;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>';
        return;
      }

      const recs = monthsInRange.flatMap(m=> groupedByMonth[m] || []);
      const total = recs.reduce((s,r)=> s + parseCurrency(r.amount), 0);

      // Header
      const summaryRow = document.createElement('div');
      summaryRow.className='month-summary';
      summaryRow.innerHTML = `
        <div>${monthLabel(rangeStart)} ‚Äì ${monthLabel(rangeEnd)}</div>
        <div style="font-size:24px; color:var(--primary); margin-top:4px;">‡∏ø${total.toLocaleString()}</div>
      `;
      reviewSection.appendChild(summaryRow);

      // Table Wrapper
      const tableWrapper = document.createElement('div');
      tableWrapper.style.marginTop = '18px';
      tableWrapper.innerHTML = '<h3 style="font-size:16px; color:#555; margin-bottom:10px;">üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏¥‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>';

      const table = document.createElement('table');
      table.innerHTML = `<tbody></tbody>`;
      const tbody = table.querySelector('tbody');
      const sortedRecs = recs.slice().sort((a,b)=> new Date(b.date) - new Date(a.date));

      let currentDate = ''; let subIndex = 1; let dailyTotal = 0;
      function pushDayHeader(dateStr){
        const tr=document.createElement('tr'); tr.className='day-header';
        const td=document.createElement('td'); td.colSpan=5; td.textContent=`üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr}`;
        tr.appendChild(td); tbody.appendChild(tr);
      }
      function pushDayTotal(){
        const tr=document.createElement('tr'); tr.className='day-total';
        const td=document.createElement('td'); td.colSpan=5; td.innerHTML=`‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î ${dailyTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
        tr.appendChild(td); tbody.appendChild(tr);
      }

      sortedRecs.forEach(r=>{
        const formattedDate = formatDate(r.date);
        if(formattedDate !== currentDate){
          if(currentDate !== '') pushDayTotal();
          currentDate = formattedDate; subIndex = 1; dailyTotal = 0;
          pushDayHeader(formattedDate);
        }
        const rowTotal = parseCurrency(r.amount); dailyTotal += rowTotal;
        const tr = buildRow(r, subIndex++); tbody.appendChild(tr);
      });
      if(currentDate !== '') pushDayTotal();

      tableWrapper.appendChild(table);
      reviewSection.appendChild(tableWrapper);

      // Chart
      const canvasContainer = document.createElement('div');
      canvasContainer.style.marginTop='24px';
      canvasContainer.style.height='260px';
      canvasContainer.innerHTML = `<h3 style="font-size:16px; color:#555; margin:0 0 10px;">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>`;
      const canvas = document.createElement('canvas');
      canvas.id='salesChart';
      canvasContainer.appendChild(canvas);
      reviewSection.appendChild(canvasContainer);

      // Draw Chart
      destroyChart();
      const ctx = canvas.getContext('2d');
      if(ctx){
        const monthTotals = monthsInRange.map(m=> ({
          m,
          total: (groupedByMonth[m]||[]).reduce((s,r)=> s + parseCurrency(r.amount), 0)
        }));
        chartInstance = new Chart(ctx, {
          type:'bar',
          data:{
            labels: monthTotals.map(x=> monthLabel(x.m)),
            datasets:[{
              label:'‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢',
              data: monthTotals.map(x=> x.total),
              backgroundColor: '#00897b',
              borderRadius: 4
            }]
          },
          options:{
            responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{ display:false } },
            scales:{ y:{ grid:{borderDash:[4,4]}, ticks:{ precision:0 } }, x:{ grid:{display:false} } }
          }
        });
      }
    }

    // ===== Rendering: Month (KEEP ONLY THIS ONE) =====
    function renderSelectedMonth(){
      const reviewSection = document.getElementById('reviewSection');
      reviewSection.innerHTML = '';
      if(!selectedMonth || !groupedByMonth[selectedMonth]){
        reviewSection.innerHTML = '<div style="text-align:center;padding:20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
        return;
      }

      const recs = groupedByMonth[selectedMonth].slice();
      const total = recs.reduce((sum, r)=> sum + parseCurrency(r.amount), 0);

      const [y,m] = selectedMonth.split('-').map(n=>parseInt(n,10));

      // Header
      const headerDiv = document.createElement('div');
      headerDiv.style.textAlign = 'center';
      headerDiv.innerHTML = `
        <div style="font-size:16px; color:#555;">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${thaiMonthsFull[m-1]} ${y}</div>
        <div style="font-size:32px; font-weight:bold; color:var(--primary); margin:5px 0;">‡∏ø${total.toLocaleString()}</div>
      `;
      reviewSection.appendChild(headerDiv);

      // Compare text
      const prevMonthDate = new Date(y, m-2, 1);
      const prevMonth = `${prevMonthDate.getFullYear()}-${String(prevMonthDate.getMonth()+1).padStart(2,'0')}`;
      const limitDayCurr = daysToCompareForMonth(y, m);
      const currToDateTotal = recs
        .filter(r=> (parseInt((r.date ? r.date.split('-')[2] : '0'))||0) <= limitDayCurr)
        .reduce((s,r)=> s+parseCurrency(r.amount), 0);

      const prevRecs = groupedByMonth[prevMonth] || [];
      const [py, pm] = prevMonth.split('-').map(n=>parseInt(n,10));
      const limitDayPrev = (pm && py) ? Math.min(limitDayCurr, daysInMonth(py, pm)) : 0;
      const prevToDateTotal = prevRecs
        .filter(r=> (parseInt((r.date ? r.date.split('-')[2] : '0'))||0) <= limitDayPrev)
        .reduce((s,r)=> s+parseCurrency(r.amount), 0);

      const diff = currToDateTotal - prevToDateTotal;

      const compareDiv = document.createElement('div');
      compareDiv.className='compare';
      compareDiv.innerHTML = diff>0
        ? `üìà ‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô <span style="color:green;font-weight:bold;">+${diff.toLocaleString()}</span> ‡∏ö‡∏≤‡∏ó (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1-${limitDayCurr})`
        : diff<0
          ? `üìâ ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô <span style="color:red;font-weight:bold;">${diff.toLocaleString()}</span> ‡∏ö‡∏≤‡∏ó (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1-${limitDayCurr})`
          : `üìä ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤`;
      reviewSection.appendChild(compareDiv);

      // Table Wrapper
      const tableWrapper = document.createElement('div');
      tableWrapper.style.marginTop = '10px';
      tableWrapper.innerHTML = '<h3 style="font-size:16px; color:#555; margin-bottom:10px;">üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏¥‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>';

      const table = document.createElement('table');
      table.innerHTML = `<tbody></tbody>`;
      const tbody = table.querySelector('tbody');

      const sortedRecs = recs.slice().sort((a,b)=> new Date(b.date) - new Date(a.date));
      let currentDate = ''; let subIndex = 1; let dailyTotal = 0;

      function pushDayHeader(dateStr){
        const tr=document.createElement('tr'); tr.className='day-header';
        const td=document.createElement('td'); td.colSpan=5; td.textContent=`üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr}`;
        tr.appendChild(td); tbody.appendChild(tr);
      }
      function pushDayTotal(){
        const tr=document.createElement('tr'); tr.className='day-total';
        const td=document.createElement('td'); td.colSpan=5; td.innerHTML=`‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î ${dailyTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
        tr.appendChild(td); tbody.appendChild(tr);
      }

      sortedRecs.forEach(r=>{
        const formattedDate = formatDate(r.date);
        if(formattedDate !== currentDate){
          if(currentDate !== '') pushDayTotal();
          currentDate = formattedDate; subIndex = 1; dailyTotal = 0;
          pushDayHeader(formattedDate);
        }
        const rowTotal = parseCurrency(r.amount); dailyTotal += rowTotal;
        const tr = buildRow(r, subIndex++); tbody.appendChild(tr);
      });
      if(currentDate !== '') pushDayTotal();

      tableWrapper.appendChild(table);
      reviewSection.appendChild(tableWrapper);

      // Chart
      const canvasContainer = document.createElement('div');
      canvasContainer.style.marginTop='24px';
      canvasContainer.style.height='220px';
      canvasContainer.innerHTML = `<h3 style="font-size:16px; color:#555; margin:0 0 10px;">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>`;
      const canvas = document.createElement('canvas');
      canvas.id='salesChart';
      canvasContainer.appendChild(canvas);
      reviewSection.appendChild(canvasContainer);

      const ctx = canvas.getContext('2d');
      destroyChart();
      if(ctx){
        chartInstance = new Chart(ctx, {
          type:'bar',
          data:{ labels: [thaiMonthsFull[m-1]], datasets:[{ label:'‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°', data: [total], backgroundColor:'#00897b', borderRadius:4 }] },
          options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ grid:{borderDash:[4,4]}, ticks:{ precision:0 } }, x:{grid:{display:false}} } }
        });
      }
    }

    // ===== Row builder =====
    function buildRow(r, subIndex){
      const tr = document.createElement('tr');

      const tdIndex = document.createElement('td');
      tdIndex.textContent = subIndex;
      tr.appendChild(tdIndex);

      const tdName = document.createElement('td');
      tdName.innerHTML = `
        <div>
          <strong class="open-customer"
            style="cursor:pointer;color:#008080;"
            data-key="${encodeURIComponent((r.name||'')+'|'+(r.phone||''))}">
            ${escapeHtml(r.name||'')}
          </strong>
          <div style="font-size:10px;color:#777;">${escapeHtml(r.opd||'-')}</div>
        </div>`;
      tr.appendChild(tdName);

      const tdPhone = document.createElement('td');
      const phoneSafe = escapeAttr(r.phone || '');
      tdPhone.innerHTML = `<span style="cursor:pointer;color:#0288d1;"
        onclick="if(this.dataset.showing==='true'){this.innerText='üìû';this.dataset.showing='false';}else{this.innerText='${phoneSafe}';this.dataset.showing='true';}"
        oncontextmenu="navigator.clipboard?.writeText('${phoneSafe}'); event.preventDefault(); this.title='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';"
        title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô, ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å"
        data-showing='false'>üìû</span>`;
      tr.appendChild(tdPhone);

      const itemsUl = (r.items||[]).map(item=>{
        const m = String(item).match(/^(.*?) ?(?:\((.*?)\))? - (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
        if(m){
          const main=m[1], sub=m[2], qty=m[3];
          return `<li>${sub ? `${escapeHtml(main)} (${escapeHtml(sub)})` : escapeHtml(main)} - ${qty} ‡∏ä‡∏¥‡πâ‡∏ô</li>`;
        }
        return `<li>${escapeHtml(item)}</li>`;
      }).join('');

      const tdItems = document.createElement('td');
      tdItems.innerHTML = `<ul style='margin:0; padding-left:16px;'>${itemsUl}</ul>`;
      tr.appendChild(tdItems);

      const tdAmt = document.createElement('td');
      const amt = parseCurrency(r.amount);
      tdAmt.innerHTML = `
        <div>${amt.toLocaleString()} ‡∏ö‡∏≤‡∏ó${r.payment ? ` (${escapeHtml(r.payment)})` : ''}</div>
        ${
          r.note && String(r.note).trim()
            ? `<div style="color:#888; font-size:10px; margin-top:4px;">üìù ${escapeHtml(r.note)}</div>`
            : ''
        }`;
      tr.appendChild(tdAmt);

      return tr;
    }

    // ===== Month Nav =====
    function updateMonthButtons(){
      const idx = monthsSorted.indexOf(selectedMonth);
      const disabled = isRangeActive();
      const btnPrev = document.getElementById('btnPrev');
      const btnNext = document.getElementById('btnNext');
      if (btnPrev) btnPrev.disabled = disabled || (idx <= 0);
      if (btnNext) btnNext.disabled = disabled || (idx >= monthsSorted.length-1);
    }

    document.getElementById('btnPrev')?.addEventListener('click', ()=>{
      const idx=monthsSorted.indexOf(selectedMonth);
      if(idx>0){ selectedMonth = monthsSorted[idx-1]; renderView(); updateMonthButtons(); }
    });
    document.getElementById('btnNext')?.addEventListener('click', ()=>{
      const idx=monthsSorted.indexOf(selectedMonth);
      if(idx<monthsSorted.length-1){ selectedMonth = monthsSorted[idx+1]; renderView(); updateMonthButtons(); }
    });
    document.getElementById('btnPick')?.addEventListener('click', ()=>{ openMonthModal(); });
    document.getElementById('btnClear')?.addEventListener('click', ()=>{ setupMonthState(); renderView(); updateMonthButtons(); });

    // ===== Search logic (‡∏ñ‡πâ‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏°‡∏µ input) =====
    const onSearch = debounce(()=>{
      const input = document.getElementById('searchInput');
      if(!input) return;
      const val = (input.value||'').trim().toLowerCase();
      const tbody = document.querySelector('table tbody');
      if (!tbody) return;

      let currentHeader = null;
      let currentHasVisible = false;

      [...tbody.children].forEach(row=>{
        if(row.classList.contains('day-header')){
          if(currentHeader && !currentHasVisible){
            currentHeader.style.display = 'none';
            if(currentHeader._totalRow) currentHeader._totalRow.style.display = 'none';
          }
          currentHeader = row;
          currentHeader.style.display = '';
          currentHasVisible = false;
          return;
        }
        if(row.classList.contains('day-total')){
          if(currentHeader) currentHeader._totalRow = row;
          row.style.display = currentHasVisible ? '' : 'none';
          return;
        }
        const text = row.textContent.toLowerCase();
        const show = text.includes(val);
        row.style.display = show ? '' : 'none';
        if(show) currentHasVisible = true;
      });

      if(currentHeader && !currentHasVisible){
        currentHeader.style.display = 'none';
        if(currentHeader._totalRow) currentHeader._totalRow.style.display = 'none';
      }
    }, 200);

    // ===== Floating Search toggle (‡∏Å‡∏±‡∏ô error ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ UI) =====
    const wrap = document.getElementById('searchWrap');
    const fab = document.getElementById('searchFab');
    const panel = document.getElementById('searchPanel');
    const closeBtn = document.getElementById('searchCloseBtn');
    function toggleSearch(open){
      if(!wrap) return;
      if(open){
        wrap.classList.add('open');
        setTimeout(()=> document.getElementById('searchInput')?.focus(), 10);
      }else{
        wrap.classList.remove('open');
      }
    }
    fab?.addEventListener('click', (e)=>{ e.stopPropagation(); toggleSearch(true); });
    closeBtn?.addEventListener('click', (e)=>{
      e.stopPropagation();
      const si = document.getElementById('searchInput');
      if(si) si.value='';
      onSearch();
      toggleSearch(false);
    });
    document.addEventListener('click', (e)=>{
      if(!wrap || !wrap.classList.contains('open')) return;
      const t = e.target;
      if(!(wrap.contains(t))) toggleSearch(false);
    });


    // ===============================
    // Customer Popup Module (NEW)
    // ===============================
    window.customerProfileMap = window.customerProfileMap || {};
    window.allCustomerRecords = window.allCustomerRecords || [];

    function closeCustomerModal(){
      const m = document.getElementById("customer-modal");
      if(m) m.style.display = "none";
    }
    window.closeCustomerModal = closeCustomerModal;

    // ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á
    (function bindCustomerModalCloseOnOutside(){
      const modal = document.getElementById("customer-modal");
      const box = document.getElementById("customer-modal-box");
      if(modal && box){
        modal.addEventListener("click", e => {
          if(!box.contains(e.target)) closeCustomerModal();
        });
      }
    })();

    // Image Viewer
    function openImgViewer(src){
      const m = document.getElementById('imgViewer');
      const img = document.getElementById('imgViewerImg');
      if(!m || !img) return;
      img.src = src || '';
      m.style.display = 'flex';
    }
    function closeImgViewer(){
      const m = document.getElementById('imgViewer');
      const img = document.getElementById('imgViewerImg');
      if(!m || !img) return;
      m.style.display = 'none';
      img.src = '';
    }
    window.openImgViewer = openImgViewer;
    window.closeImgViewer = closeImgViewer;

    // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (map ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á DB) + ‡∏•‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡∏´‡∏•‡∏≤‡∏¢ endpoint
    async function loadCustomerProfiles(){
      try{
        const { url, data } = await tryFetchJson(PROFILE_LIST_ENDPOINTS, { credentials:'same-origin' });
        if(!url || !data) return;

        ACTIVE_PROFILE_LIST_ENDPOINT = url;

        const map = {};
        (data || []).forEach(c=>{
          const opd = pad4(c.opd);
          if(!opd) return;
          map[opd] = {
            opd,
            full_name: c.full_name || c.name || '',
            vip: c.vip || c.vip_level || '',
            profile_pic_url: c.profile_pic_url || c.profile_pic || c.pic_url || ''
          };
        });
        window.customerProfileMap = map;
      }catch(e){
        console.warn('loadCustomerProfiles failed:', e);
      }
    }
    window.loadCustomerProfiles = loadCustomerProfiles;

    // Upload Profile Pic (‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢ endpoint)
    let _pendingUploadOPD = null;

    function _validateImageFile(file){
      if(!file) return { ok:false, msg:'‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå' };
      const okTypes = ['image/jpeg','image/png','image/webp'];
      if(!okTypes.includes(file.type)) return { ok:false, msg:'‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô jpg/png/webp ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô' };
      const MAX_MB = 6;
      if(file.size > MAX_MB * 1024 * 1024) return { ok:false, msg:`‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${MAX_MB}MB` };
      return { ok:true };
    }

    async function _readErrorMessage(res){
      try{
        const ct = (res.headers.get('content-type') || '').toLowerCase();
        if(ct.includes('application/json')){
          const j = await res.json().catch(()=> ({}));
          return j.error || j.message || JSON.stringify(j);
        }
        const t = await res.text().catch(()=> '');
        const s = (t || '').trim();
        if (s.startsWith('<!doctype html') || s.startsWith('<html') || ct.includes('text/html')) {
          return `HTTP ${res.status} ${res.statusText || ''}`.trim();
        }
        return s || `HTTP ${res.status}`;
      }catch{
        return `HTTP ${res.status}`;
      }
    }

    function _extractProfilePicUrl(data){
      if(!data) return '';
      return data.profile_pic_url || data.url || data.secure_url || data.path || data.profile_pic || '';
    }

    async function uploadProfilePic(opd, file){
      const opd4 = pad4(opd);

      const fd = new FormData();
      fd.append('opd', opd4);
      // ‡πÅ‡∏ô‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ: ‡∏™‡πà‡∏á‡∏´‡∏•‡∏≤‡∏¢ key ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ backend ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠
      fd.append('file', file);
      fd.append('profile_pic', file);
      fd.append('profile_pic_file', file);
      fd.append('image', file);
      fd.append('avatar', file);

      const endpoints = [
        '/api/update_customer_with_image',
        '/api/customer/profile_pic',
      ];

      async function fetchPicUrlFromCustomers(opdKey){
        const res = await fetch('/api/customers', { credentials:'same-origin' });
        if(!res.ok) return null;
        const list = await res.json().catch(()=>[]);
        const found = (list || []).find(c => pad4(c.opd) === opdKey);
        return found?.profile_pic_url || found?.profile_pic || found?.avatar_url || null;
      }

      let lastErr = null;

      for (const url of endpoints) {
        try {
          const res = await fetch(url, { method:'POST', credentials:'same-origin', body: fd });

          // ‡∏ñ‡πâ‡∏≤ 404 = ‡πÑ‡∏°‡πà‡∏°‡∏µ route ‚Üí ‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
          if (res.status === 404) {
            lastErr = new Error(`Not Found: ${url}`);
            continue;
          }

          if (!res.ok) {
            const msg = await _readErrorMessage(res);
            lastErr = new Error(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${url} ‚Üí ${msg}`);
            continue;
          }

          const data = await res.json().catch(()=> ({}));

          const picUrl =
            data.profile_pic_url ||
            data.url ||
            data.secure_url ||
            data.path ||
            data.profile_pic ||
            data.avatar_url ||
            (data.customer && (data.customer.profile_pic_url || data.customer.profile_pic || data.customer.avatar_url));

          if (picUrl) return picUrl;

          // ‚úÖ ‡∏ñ‡πâ‡∏≤ upload ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô url ‚Üí ‡πÑ‡∏õ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å /api/customers (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ)
          const fetchedUrl = await fetchPicUrlFromCustomers(opd4);
          if (fetchedUrl) return fetchedUrl;

          lastErr = new Error(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${url} ‡πÅ‡∏ï‡πà response ‡πÑ‡∏°‡πà‡∏°‡∏µ url`);
          continue;

        } catch (e) {
          lastErr = e;
          continue;
        }
      }

      throw lastErr || new Error('Upload failed: no valid endpoint');
    }

    // ===============================
    // ‚úÖ FIX: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏Å‡∏î‡πÑ‡∏î‡πâ (ADD THESE)
    // ===============================
    function pickProfileImage(opd){
      const input = document.getElementById('profileUploadInput');
      if(!input) return;
      _pendingUploadOPD = opd;
      input.value = '';     // reset ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ
      input.click();
    }
    window.pickProfileImage = pickProfileImage;

    document.getElementById('profileUploadInput')?.addEventListener('change', async function(e){
      const file = e.target.files?.[0];
      if(!file) return;

      const check = _validateImageFile(file);
      if(!check.ok){
        alert(check.msg);
        return;
      }

      if(!_pendingUploadOPD){
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö OPD ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î');
        return;
      }

      try{
        const url = await uploadProfilePic(_pendingUploadOPD, file);

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡πÉ‡∏ô modal ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        const img = document.getElementById('modalProfileImg');
        if(img){
          img.src = url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
        }

        // reload profile map ‡πÉ‡∏´‡∏°‡πà
        await loadCustomerProfiles();

        alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }catch(err){
        console.error(err);
        alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err?.message || err));
      }finally{
        _pendingUploadOPD = null;
        e.target.value = '';
      }
    });

    function openCustomerModal(key){
      const [name, phone = ''] = String(key).split('|');
      const norm = s => (s || '').trim().toLowerCase();

      const records = (window.allCustomerRecords || []).filter(r =>
        norm(r.name) === norm(name) &&
        norm(r.phone || '') === norm(phone)
      );

      if(!records.length){
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ');
        return;
      }

      records.sort((a,b)=> (b.date || '').localeCompare(a.date || ''));

      const first = records[0];
      const opd4 = pad4(first.opd);

      const profileData = (window.customerProfileMap || {})[opd4] || {};
      const fallbackPic =
        'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzZiNzI4MCI+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==';

      const hasProfilePic = !!(profileData.profile_pic_url && String(profileData.profile_pic_url).trim());
      const profilePic = hasProfilePic ? profileData.profile_pic_url : fallbackPic;

      const missingPicNote = '';

      const vipBadge = profileData.vip ? `<span class="badge-vip">VIP: ${esc(profileData.vip)}</span>` : '';
      const realName = profileData.full_name || first.name || '';

      const lastDateStr = (records[0].date || '').slice(0,10);
      const today = new Date();
      const lastDate = new Date(lastDateStr);
      const daysAbsent = isNaN(lastDate) ? 0 : Math.floor((today - lastDate) / (1000*60*60*24));

      const paidRecords = records.filter(r => recordAmount(r) > 0);
      const paidVisits = paidRecords.length;
      const totalAmount = paidRecords.reduce((s,r)=> s + recordAmount(r), 0);
      const average = paidVisits ? Math.round(totalAmount / paidVisits) : 0;

      const allItems = {};
      records.forEach(r=>{
        (r.items || []).forEach(item=>{
          const m = String(item).match(/\((.*?)\)/);
          const itemName = m ? m[1] : String(item).split(' - ')[0];
          const q = String(item).match(/- (\d+)\s*‡∏ä‡∏¥‡πâ‡∏ô/);
          const qty = q ? parseInt(q[1],10) : 1;
          allItems[itemName] = (allItems[itemName] || 0) + qty;
        });
      });

      const itemSummary = Object.entries(allItems)
        .sort((a,b)=> b[1]-a[1])
        .map(([n,q])=> `‚Ä¢ ${esc(n)} : ${q}`)
        .join('<br>') || '-';

      const historyHtml = records.map(r=>{
        const items = (r.items || []).map(item=>{
          const m = String(item).match(/\((.*?)\)/);
          const itemName = m ? m[1] : String(item).split(' - ')[0];
          const q = String(item).match(/- (\d+)\s*‡∏ä‡∏¥‡πâ‡∏ô/);
          const qty = q ? parseInt(q[1],10) : 1;
          return `<li>${esc(itemName)} : ${qty}</li>`;
        }).join('');

        const noteText = r.note
          ? `<div style="font-size:11px; margin-top:2px; font-style:italic; color:#444;">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${esc(r.note)}</div>`
          : '';

        return `
          <div style="margin-bottom:14px;">
            <div style="font-weight:600; font-size:12px;">üìÖ ${formatDate((r.date || '').slice(0,10))}</div>
            <ul style="padding-left:16px; margin:0; font-size:11px;">${items}</ul>
            <div style="margin-top:4px; color:#0a645a; font-size:11px;">üíµ ${Math.round(recordAmount(r)).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
            ${noteText}
            <hr style="margin:8px auto; border:0; border-top:1px dashed #ddd; width:60%;">
          </div>
        `;
      }).join('');

      document.getElementById("modal-content").innerHTML = `
        <div class="profile-header">
          <div class="profile-img-box" onclick="openImgViewer('${profilePic}')">
            <img id="modalProfileImg" src="${profilePic}" alt="Profile">
          </div>

          <div class="profile-info">
            <h3>${esc(realName)}</h3>
            <div class="profile-badges">
              <span class="badge">OPD: ${esc(opd4)}</span>
              ${vipBadge}
            </div>
            <div style="font-size:12px; margin-top:4px; color:#555;">üìû ${esc(first.phone || '-')}</div>
            ${missingPicNote}

            <div class="profile-actions">
              <button class="btn-mini" type="button" onclick="pickProfileImage('${esc(opd4)}')">üì∑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ</button>
              <button class="btn-mini secondary" type="button" onclick="openImgViewer('${profilePic}')">üîç ‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà</button>
            </div>
          </div>
        </div>

        <div class="profile-summary-grid">
          <div class="profile-summary-box total">üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <strong>${Math.round(totalAmount).toLocaleString()}</strong></div>
          <div class="profile-summary-box avg">üí≥ ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: <strong>${average.toLocaleString()}</strong></div>
          <div class="profile-summary-box visits">üîÅ ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£: <strong>${records.length}</strong> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
          <div class="profile-summary-box last">üìÖ ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${formatDate(lastDateStr)}<br><span style="color:red;">(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß: ${daysAbsent} ‡∏ß‡∏±‡∏ô)</span></div>
        </div>

        <hr style="margin:14px 0; border:0; border-top:1px solid #ccc;">

        <div style="font-weight:600; font-size:13px; margin-bottom:6px; color:#00796b;">üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</div>
        <div style="font-size:11px; background:#f9f9f9; padding:10px; border-radius:8px;">${itemSummary}</div>

        <hr style="margin:14px 0; border:0; border-top:1px solid #ccc;">

        <div style="font-weight:600; font-size:13px; margin-bottom:6px; color:#00796b;">üßæ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á:</div>
        <div style="max-height: 300px; overflow-y: auto;">
          ${historyHtml}
        </div>
      `;

      const modal = document.getElementById("customer-modal");
      if(modal) modal.style.display = 'flex';
    }
    window.openCustomerModal = openCustomerModal;

    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î popup
    document.addEventListener('click', (e)=>{
      const el = e.target.closest?.('.open-customer');
      if(!el) return;
      const key = decodeURIComponent(el.dataset.key || '');
      openCustomerModal(key);
    });

    // ===== Excel Export =====
    document.getElementById('downloadExcelBtn')?.addEventListener('click', downloadExcel);

    function downloadExcel(){
      const allMonths = isRangeActive()
        ? monthsSorted.filter(m=> m >= rangeStart && m <= rangeEnd)
        : (selectedMonth ? [selectedMonth] : []);

      const recs = allMonths.flatMap(m=> groupedByMonth[m] || []);
      if(!recs.length){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î'); return; }

      const filename = isRangeActive()
        ? `‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢_${rangeStart}_‡∏ñ‡∏∂‡∏á_${rangeEnd}.xlsx`
        : `‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢_${selectedMonth||'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}.xlsx`;

      const sortedRecs = recs.slice().sort((a,b)=> new Date(b.date) - new Date(a.date));
      const ws_data = [];
      let currentDate = '';
      let dailyTotal = 0;

      sortedRecs.forEach(r=>{
        const formattedDate = formatDate(r.date);
        const items = (r.items||[]).map(item=>{
          const m = String(item).match(/^(.*?) ?(?:\((.*?)\))? - (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
          if(m){
            const main=m[1], sub=m[2], qty=m[3];
            return sub? `${main} (${sub}) - ${qty} ‡∏ä‡∏¥‡πâ‡∏ô` : `${main} - ${qty} ‡∏ä‡∏¥‡πâ‡∏ô`;
          }
          return String(item);
        }).join('\n');

        if(formattedDate !== currentDate){
          if(currentDate !== ''){
            ws_data.push(['','','','‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô', dailyTotal, '']);
            ws_data.push([]);
          }
          currentDate = formattedDate;
          dailyTotal = 0;
          ws_data.push([`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formattedDate}`]);
          ws_data.push(['OPD','‡∏ä‡∏∑‡πà‡∏≠','‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','‡∏¢‡∏≠‡∏î (‡∏ö‡∏≤‡∏ó)','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']);
        }
        dailyTotal += parseCurrency(r.amount);
        ws_data.push([ r.opd||'', r.name, r.phone||'', items, parseCurrency(r.amount), r.note||'' ]);
      });

      if(currentDate !== '') ws_data.push(['','','','‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô', dailyTotal, '']);

      const worksheet = XLSX.utils.aoa_to_sheet(ws_data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô');
      XLSX.writeFile(workbook, filename);
    }

    // ===== Month Range Modal =====
    function openMonthModal(){
      const mm = document.getElementById('month-modal');
      const inputStart = document.getElementById('monthStart');
      const inputEnd = document.getElementById('monthEnd');
      if (inputStart) inputStart.value = rangeStart || selectedMonth || '';
      if (inputEnd)   inputEnd.value   = rangeEnd || selectedMonth || '';
      if (mm) mm.style.display = 'flex';
    }
    function closeMonthModal(){
      const m = document.getElementById('month-modal');
      if (m) m.style.display = 'none';
    }
    function confirmMonthModal(){
      let s = (document.getElementById('monthStart').value||'').trim();
      let e = (document.getElementById('monthEnd').value||'').trim();
      if(!s && !e){ closeMonthModal(); return; }
      if(s && !e) e = s;
      if(e && !s) s = e;
      if (s > e){ const t=s; s=e; e=t; }
      rangeStart = s; rangeEnd = e; selectedMonth = s;
      updateRangeBadge();
      renderView();
      updateMonthButtons();
      closeMonthModal();
    }
    document.getElementById('month-modal')?.addEventListener('click', (e)=>{ if (e.target && e.target.id === 'month-modal') closeMonthModal(); });
    document.getElementById('month-modal-box')?.addEventListener('click', (e)=>{ e.stopPropagation(); });
    document.getElementById('monthCloseBtn')?.addEventListener('click', closeMonthModal);
    document.getElementById('monthCancelBtn')?.addEventListener('click', closeMonthModal);
    document.getElementById('monthOkBtn')?.addEventListener('click', confirmMonthModal);

    // ESC ‡∏õ‡∏¥‡∏î modal
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        closeCustomerModal();
        closeMonthModal();
        closeImgViewer();
      }
    });

    // expose
    window.openMonthModal = openMonthModal;
    window.closeMonthModal = closeMonthModal;
    window.confirmMonthModal = confirmMonthModal;
  });
  </script>
</body>
</html>
