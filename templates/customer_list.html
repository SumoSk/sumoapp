<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>{% block title %}App{% endblock %}</title>
  {% block head %}{% endblock %}

  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --teal:#0f766e; --teal-600:#0d9488; --teal-700:#0f766e;
      --bg:#f6fbfa; --card:#ffffff;
      --muted:#64748b; --text:#0f172a;
      --line:#e5e7eb; --soft:#f8fafc;
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --shadow: 0 10px 28px rgba(2,8,23,.08);
      --shadow2: 0 14px 34px rgba(2,8,23,.12);
      --radius: 16px;
      --radius2: 14px;
      --pad: 14px;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Prompt','Segoe UI',sans-serif;
      margin:0;
      background: radial-gradient(1100px 600px at 10% -10%, #dff7f4 0%, transparent 60%),
                  radial-gradient(900px 500px at 110% 0%, #e7fbf8 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
      padding:12px 12px 120px;
    }
    .wrap{max-width:1280px;margin:14px auto}

    /* Top bar */
    .topbar{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      padding:14px 14px;
      background: linear-gradient(135deg, #ffffff 0%, #fbfffe 55%, #f3fffd 100%);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index: 20;
      backdrop-filter: blur(6px);
    }
    .brand{
      display:grid;gap:2px;
    }
    .brand .title{
      font-size:18px;font-weight:900;color:#064e3b;letter-spacing:.2px;
      margin:0;
    }
    .brand .sub{
      font-size:12px;color:var(--muted);
    }
    .actions{
      display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end;
    }
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 12px;border-radius:12px;
      border:1px solid #cfe7e5;background:#fff;color:#0b7660;
      cursor:pointer;font-weight:800;font-size:12px;
      box-shadow: 0 4px 14px rgba(2,8,23,.06);
      transition: transform .08s ease, box-shadow .08s ease;
    }
    .btn:hover{box-shadow: 0 10px 22px rgba(2,8,23,.10)}
    .btn:active{transform: translateY(1px)}
    .btn-primary{border-color:transparent;background:var(--teal-600);color:#fff}
    .btn-ghost{background:#f1f5f9;border-color:#e5e7eb;color:#0f172a}
    .btn-link{border:none;background:transparent;color:#0b7660;font-weight:900;cursor:pointer;padding:8px 10px;box-shadow:none}
    .icon-btn{border:1px solid #d1d5db;background:#fff;border-radius:10px;cursor:pointer;font-size:13px;padding:6px 10px}
    .icon-btn:hover{background:#f8fafc}

    /* Layout grid */
    .grid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:12px;
      margin-top:12px;
      align-items:start;
    }
    @media (max-width: 1024px){
      .grid{grid-template-columns:1fr}
      .topbar{position:relative; top:auto}
    }

    /* Cards */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 14px;
      background: linear-gradient(180deg, #f6fffe 0%, #ffffff 70%);
      border-bottom:1px solid var(--line);
    }
    .card .hd .h1{
      margin:0;font-size:14px;font-weight:900;color:#064e3b;
    }
    .card .hd .hint{
      font-size:12px;color:var(--muted);
    }
    .card .bd{padding:14px}

    /* KPI */
    .kpis{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 1024px){
      .kpis{grid-template-columns: repeat(3, minmax(0, 1fr))}
    }
    @media (max-width: 640px){
      .kpis{grid-template-columns: repeat(2, minmax(0, 1fr))}
    }
    .kpi{
      background: linear-gradient(180deg, #ffffff 0%, #fbfffe 100%);
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:12px 12px;
      display:grid;gap:6px;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .08s ease;
    }
    .kpi:hover{box-shadow: var(--shadow2)}
    .kpi:active{transform: translateY(1px)}
    .kpi .k{font-size:12px;color:var(--muted);font-weight:700}
    .kpi .v{font-size:18px;font-weight:900;color:#0f172a;line-height:1}
    .kpi .s{font-size:11px;color:#0b7660;font-weight:800}

    /* Filters */
    details.filters{border:1px solid var(--line);border-radius:var(--radius);background:#fff;box-shadow: var(--shadow)}
    details.filters summary{
      list-style:none;cursor:pointer;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 14px;
      font-weight:900;color:#064e3b;
      background: linear-gradient(180deg, #f6fffe 0%, #ffffff 70%);
      border-bottom:1px solid var(--line);
    }
    details.filters summary::-webkit-details-marker{display:none}
    .flt-wrap{padding:14px;display:grid;gap:12px}
    .flt-block{
      border:1px solid var(--line);border-radius:var(--radius2);
      background: linear-gradient(180deg, #fcfffe 0%, #ffffff 70%);
      padding:12px;
    }
    .flt-title{font-weight:900;color:#0b3d35;margin-bottom:10px;font-size:13px}
    label{display:block;font-size:12px;color:#334155;margin:2px 0 6px;font-weight:700}
    .ipt{
      width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:12px;background:#fff;font-size:12px
    }

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      padding:8px 12px;border:1px solid #a7e1da;border-radius:999px;
      background:#fff;color:#0b7660;font-size:12px;cursor:pointer;font-weight:900;
      transition: transform .08s ease, box-shadow .08s ease;
    }
    .chip:hover{box-shadow: 0 10px 22px rgba(2,8,23,.10)}
    .chip:active{transform: translateY(1px)}
    .chip.active{background:#0b7660;color:#fff;border-color:#0b7660}

    .applied-banner{
      margin-top:10px;font-size:12px;color:#0b3d35;background:#ecfdf5;border:1px solid #a7f3d0;
      padding:8px 10px;border-radius:12px;display:none;font-weight:800
    }

    /* Tables */
    .table-card{padding:0}
    .table-wrap{padding:14px}
    table{width:100%;border-collapse:separate;border-spacing:0;background:#fff}
    th,td{border-bottom:1px solid var(--line);padding:10px 10px;font-size:12px;vertical-align:top}
    thead th{
      position:sticky; top:0; z-index: 5;
      background:#f8fafc;
      border-bottom:1px solid var(--line);
      font-weight:900;color:#0f172a;
      text-align:left;
    }
    tbody tr:hover{background:#f8fffe}
    tbody tr:nth-child(even){background:#fcfcfc}
    a.link{color:#0d9488;text-decoration:none;font-weight:900;cursor:pointer}
    a.link:hover{text-decoration:underline}

    /* Badges */
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;font-size:11px;font-weight:900;
      border:1px solid var(--line); background:#fff;
      white-space:nowrap;
    }
    .b-ok{border-color:#bbf7d0;background:#ecfdf5;color:#065f46}
    .b-warn{border-color:#fde68a;background:#fffbeb;color:#92400e}
    .b-bad{border-color:#fecaca;background:#fef2f2;color:#991b1b}
    .b-gray{border-color:#e5e7eb;background:#f3f4f6;color:#374151}

    /* Right column sections */
    .right{
      display:grid;
      gap:12px;
    }
    .split2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 900px){
      .split2{grid-template-columns:1fr}
    }

    /* Range modal + modals (‡∏Ñ‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡πÄ‡∏î‡∏¥‡∏°) */
    #customer-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9999;align-items:center;justify-content:center}
    #customer-modal .box{background:#fff;border-radius:16px;max-width:92vw;max-height:90vh;overflow:auto;padding:18px;position:relative;box-shadow:0 12px 34px rgba(0,0,0,.22)}
    #customer-modal .close{position:absolute;right:10px;top:10px;width:38px;height:38px;border:none;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.16);cursor:pointer;background:#fff}

    .range-modal { position: fixed; inset: 0; z-index: 1200; display: none; }
    .range-modal__backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.45); }
    .range-modal__panel {
      position: absolute; left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      width: min(92vw, 420px);
      background: #fff;
      border-radius: 14px;
      box-shadow:0 12px 30px rgba(0,0,0,.18);
      overflow: hidden;
      display: flex; flex-direction: column;
    }
    .range-modal__header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 14px; background: #e0f2f1; font-weight: 900; color: #004d40;
    }
    .range-modal__close {
      background: transparent; border: none; font-size: 18px;
      cursor: pointer; color: #004d40;
    }
    .range-modal__body { display: grid; gap: 12px; padding: 14px; }
    .range-modal__body label { display: grid; gap: 6px; font-size: 12px; color: #335; font-weight:800;}
    .range-modal__body input[type="date"]{
      -webkit-appearance: none; appearance: none;
      width: 100%; padding: 10px 12px; font-size: 12px;
      border: 1px solid #cfe7e5; border-radius: 12px; background: #fff;
    }
    .range-modal__footer {
      display: flex; justify-content: flex-end; gap: 8px; padding: 12px 14px;
      border-top: 1px solid #eee;
    }
    .btn-primary, .btn-secondary {
      border: none; padding: 10px 12px; border-radius: 12px; font-size: 12px; cursor: pointer; font-weight:900;
    }
    .btn-primary { background: #009688; color: #fff; }
    .btn-primary:hover { background: #00796b; }
    .btn-secondary { background: #eceff1; color: #37474f; }
    .btn-secondary:hover { background: #e0e3e6; }

    /* Profile editor */
    .profile-editor{
      width:100%; min-height:38px; resize:vertical;
      border:1px solid #e5e7eb; border-radius:12px; padding:8px 10px; font-size:11px;
      background:#fff;
    }
    .profile-editor.saving{ opacity:.7; }
    .profile-editor.saved{ border-color:#22c55e; box-shadow:0 0 0 2px rgba(34,197,94,.15); }
    .profile-editor.error{ border-color:#ef4444; box-shadow:0 0 0 2px rgba(239,68,68,.15); }

    /* Toast + Loading */
    .toast-wrap{
      position: fixed;
      right: 12px;
      bottom: 16px;
      display: grid;
      gap: 8px;
      z-index: 20000;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      background:#0f172a;
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      box-shadow:0 12px 30px rgba(2,8,23,.25);
      font-size:12px;
      max-width:min(360px, calc(100vw - 24px));
      font-weight:800;
    }
    .toast.ok{ background:#065f46; }
    .toast.warn{ background:#92400e; }
    .toast.err{ background:#991b1b; }

    .loading{
      position: fixed; inset: 0;
      background: rgba(255,255,255,.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 18000;
      backdrop-filter: blur(2px);
    }
    .loading .box{
      background:#fff;border:1px solid #e5e7eb;border-radius:16px;
      padding:12px 14px;
      box-shadow:0 12px 30px rgba(2,8,23,.12);
      font-size:12px;color:#0f172a;font-weight:900;
    }

    /* Keep your font size override as-is (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏Å "‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ü‡πâ‡∏≠‡∏ô‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô") */
    body { font-size: 10px; }
    th, td { font-size: 10px; }
    #finalCustTable th, #finalCustTable td { font-size: 10px; }
    .profile-editor { font-size: 8px; }
    .sub-muted { font-size: 8px; }
    .chip { font-size: 10px; }
    .ipt { font-size: 10px; }
    #finalCustTable th:nth-child(12),
    #finalCustTable td:nth-child(12) {
      font-size: 8px;
      line-height: 1.25;
      color: #334155;
      white-space: normal;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- TOP BAR -->
    <div class="topbar">
      <div class="brand">
        <p class="title">Customer Insight Dashboard</p>
        <div class="sub">
          ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ RFM, ABC, Recency, Spend Bands ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" id="btnApply">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button class="btn btn-ghost" id="btnExportCsv" type="button">Export CSV</button>
        <button class="btn" id="openCustomRange" type="button">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô</button>
      </div>
    </div>

    <!-- KPI ROW -->
    <div class="kpis" aria-label="KPI summary">
      <div class="kpi" id="kpiCustomers" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á)">
        <div class="k">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        <div class="v" id="kpiCustomersV">-</div>
        <div class="s" id="kpiCustomersS">‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
      </div>
      <div class="kpi" id="kpiRevenue" title="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á">
        <div class="k">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div>
        <div class="v" id="kpiRevenueV">-</div>
        <div class="s" id="kpiRevenueS">‡∏ö‡∏≤‡∏ó</div>
      </div>
      <div class="kpi" id="kpiAov" title="Average Order Value ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏•">
        <div class="k">AOV ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏•</div>
        <div class="v" id="kpiAovV">-</div>
        <div class="s" id="kpiAovS">‡∏ö‡∏≤‡∏ó/‡∏ö‡∏¥‡∏•</div>
      </div>
      <div class="kpi" id="kpiRisk" title="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 90 ‡∏ß‡∏±‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á)">
        <div class="k">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏´‡∏≤‡∏¢ (90+ ‡∏ß‡∏±‡∏ô)</div>
        <div class="v" id="kpiRiskV">-</div>
        <div class="s" id="kpiRiskS">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div>
      </div>
      <div class="kpi" id="kpiAClass" title="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô A (ABC) (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á)">
        <div class="k">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô A</div>
        <div class="v" id="kpiAClassV">-</div>
        <div class="s" id="kpiAClassS">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div>
      </div>
    </div>

    <!-- MAIN GRID -->
    <div class="grid">

      <!-- LEFT: FILTERS -->
      <div>
        <details class="filters" open>
          <summary>
            <span>‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå</span>
            <span class="sub-muted">‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á</span>
          </summary>

          <div class="flt-wrap">

            <!-- Hidden inputs still required by logic -->
            <input type="date" id="startDate" class="ipt" style="display:none"/>
            <input type="date" id="endDate" class="ipt" style="display:none"/>

            <div class="flt-block">
              <div class="flt-title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (Quick)</div>
              <div class="chips" style="margin-bottom:10px">
                <span class="chip" data-range="thisMonth">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
                <span class="chip" data-range="2m">2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                <span class="chip" data-range="3m">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                <span class="chip" data-range="6m">6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                <span class="chip" data-range="thisYear">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</span>
                <span class="chip" data-range="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
              </div>
              <div class="flt-title" style="margin-top:8px">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤ (Recency quick)</div>
              <div class="chips">
                <span class="chip" data-range="abs:0-30">0‚Äì30</span>
                <span class="chip" data-range="abs:31-60">31‚Äì60</span>
                <span class="chip" data-range="abs:61-90">61‚Äì90</span>
                <span class="chip" data-range="abs:90-180">90‚Äì180</span>
                <span class="chip" data-range="abs:181-365">181‚Äì365</span>
                <span class="chip" data-range="abs:365+">1 ‡∏õ‡∏µ+</span>
              </div>

              <div style="margin-top:12px">
                <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ä‡∏∑‡πà‡∏≠/OPD)</label>
                <input type="text" id="qSearch" class="ipt" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á">
              </div>

              <div id="appliedBanner" class="applied-banner"></div>
            </div>

            <div class="flt-block">
              <div class="flt-title">‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á)</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <div>
                  <label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ö‡∏≤‡∏ó)</label>
                  <input type="number" id="minTotal" class="ipt" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
                </div>
                <div>
                  <label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ö‡∏≤‡∏ó)</label>
                  <input type="number" id="maxTotal" class="ipt" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
                </div>

                <div>
                  <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label>
                  <input type="number" id="minVisits" class="ipt" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
                </div>
                <div>
                  <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</label>
                  <input type="number" id="maxVisits" class="ipt" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
                </div>

                <div>
                  <label>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ (‡∏ß‡∏±‡∏ô)</label>
                  <input type="number" id="minAbsent" class="ipt" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
                </div>
                <div>
                  <label>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô (‡∏ß‡∏±‡∏ô)</label>
                  <input type="number" id="maxAbsent" class="ipt" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
                </div>

                <div>
                  <label>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏• ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ö‡∏≤‡∏ó)</label>
                  <input type="number" id="minAvg" class="ipt" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
                </div>
                <div>
                  <label>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏• ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ö‡∏≤‡∏ó)</label>
                  <input type="number" id="maxAvg" class="ipt" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
                </div>
              </div>

              <div style="margin-top:10px">
                <label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                <input type="text" id="customerName" class="ipt" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠ (‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)">
              </div>

              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap">
                <button type="button" id="btnRunAdv" class="btn btn-primary">‡∏Å‡∏£‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</button>
                <button type="button" id="btnResetAdv" class="btn">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤</button>
              </div>
              <div id="filterResults" class="sub-muted" style="margin-top:8px;"></div>
            </div>

            <div class="flt-block">
              <div class="flt-title">‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
              <div style="display:flex;justify-content:flex-end">
                <button class="btn" id="btnAddProduct" type="button">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
              </div>
              <div id="productListContainer" style="display:flex;flex-direction:column;gap:8px;margin-top:10px"></div>
            </div>

          </div>
        </details>
      </div>

      <!-- RIGHT: CONTENT -->
      <div class="right">

        <div class="split2">
          <div class="card table-card">
            <div class="hd">
              <p class="h1">RFM Segments</p>
              <div class="hint sub-muted">‡∏Ñ‡∏•‡∏¥‡∏Å üëÅ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div>
            </div>
            <div class="table-wrap">
              <table id="rfmTable">
                <thead>
                  <tr>
                    <th>‡∏Å‡∏•‡∏∏‡πà‡∏° (‡πÑ‡∏ó‡∏¢)</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>%</th><th>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏•</th><th>Recency ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th style="width:64px"></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="card table-card">
            <div class="hd">
              <p class="h1">ABC / Pareto</p>
              <div class="hint sub-muted">A = ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏Å</div>
            </div>
            <div class="table-wrap">
              <table id="abcTable">
                <thead>
                  <tr><th>‡∏ä‡∏±‡πâ‡∏ô</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>% ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>% ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th style="width:64px"></th></tr>
                </thead>
                <tbody></tbody>
              </table>
              <div id="abcWho" class="sub-muted" style="margin-top:10px"></div>
            </div>
          </div>
        </div>

        <div class="split2">
          <div class="card table-card">
            <div class="hd">
              <p class="h1">Recency Distribution</p>
              <div class="hint sub-muted">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
            </div>
            <div class="table-wrap">
              <table id="recencyTable">
                <thead>
                  <tr>
                    <th>‡∏ä‡πà‡∏ß‡∏á (‡∏ß‡∏±‡∏ô)</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>%</th><th>AOV ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th style="width:64px"></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="card table-card">
            <div class="hd">
              <p class="h1">Spend Bands</p>
              <div class="hint sub-muted">‡∏ä‡πà‡∏ß‡∏á AOV ‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•</div>
            </div>
            <div class="table-wrap">
              <table id="spendBandTable">
                <thead>
                  <tr>
                    <th>‡∏ä‡πà‡∏ß‡∏á AOV</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>%</th><th>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏Ñ‡∏ô</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th style="width:64px"></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card table-card" id="finalSection">
          <div class="hd">
            <p class="h1">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
            <div class="hint sub-muted">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á | ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
          </div>
          <div class="table-wrap">
            <table id="finalCustTable">
              <thead>
                <tr>
                  <th data-sort="num">#</th>
                  <th data-sort="str">OPD</th>
                  <th data-sort="str">‡∏ä‡∏∑‡πà‡∏≠</th>
                  <th data-sort="num">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
                  <th data-sort="num">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏•</th>
                  <th data-sort="num">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                  <th data-sort="num">‡∏ö‡∏¥‡∏•‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</th>
                  <th data-sort="num">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤ (‡∏ß‡∏±‡∏ô)</th>
                  <th data-sort="str">RFM</th>
                  <th data-sort="str">ABC</th>
                  <th data-sort="num">Pitch ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ß‡∏±‡∏ô)</th>
                  <th data-sort="str">Outcome ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                  <th data-sort="str">Profile</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- Loading -->
  <div class="loading" id="loadingOverlay">
    <div class="box">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>
  </div>

  <!-- Toast -->
  <div class="toast-wrap" id="toastWrap"></div>

  <!-- Customer modal -->
  <div id="customer-modal">
    <div class="box" onclick="event.stopPropagation();">
      <button class="close" onclick="closeCustomerModal()">‚úñ</button>
      <div id="modal-content"></div>
    </div>
  </div>

  <!-- Pitch modal -->
  <div id="pitch-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:10000; align-items:center; justify-content:center">
    <div class="box" style="background:#fff;border-radius:16px;max-width:92vw;max-height:90vh;overflow:auto;padding:18px;position:relative;box-shadow:0 12px 34px rgba(0,0,0,.22)">
      <button class="close" onclick="closePitchModal()" style="position:absolute;right:10px;top:10px;width:38px;height:38px;border:none;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.16);cursor:pointer;background:#fff">‚úñ</button>
      <div id="pitch-modal-content"></div>
    </div>
  </div>

  <!-- Range modal -->
  <div id="rangeModal" class="range-modal" style="display:none;">
    <div class="range-modal__backdrop" onclick="closeRangeModal()"></div>
    <div class="range-modal__panel">
      <div class="range-modal__header">
        <div>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
        <button class="range-modal__close" onclick="closeRangeModal()">‚úï</button>
      </div>
      <div class="range-modal__body">
        <label>‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <input type="date" id="rangeStartModal"></label>
        <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <input type="date" id="rangeEndModal"></label>
      </div>
      <div class="range-modal__footer">
        <button class="btn-secondary" onclick="closeRangeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn-primary" onclick="applyRangeFromModal()">‡∏ï‡∏Å‡∏•‡∏á</button>
      </div>
    </div>
  </div>

  <script>
    /* ==========================
       ‚úÖ ‡πÇ‡∏Ñ‡πâ‡∏î Logic ‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå)
       + ‡πÄ‡∏û‡∏¥‡πà‡∏° updateKpis + KPI click actions
       ========================== */

    const state = {
      allSales: [],
      allCustomerRecords: [],
      filtered: [],
      endAnchorDate: null,
      customersMap: new Map(),
      selectedKeys: null,
      appliedNote: '',
      reconApplySpecial: null,

      profileByOpd: new Map(),
      pitchSummaryCache: new Map(),
      pitchSummaryFetchedAt: 0,
      pitchSummaryTTLms: 5 * 60 * 1000,

      rfmByKey: new Map(),
      abcByKey: new Map(),

      finalRows: [],
      finalSort: {col:6, dir:-1},
      lastHydrateToken: 0,
    };

    function showLoading(on){
      const el = document.getElementById('loadingOverlay');
      if(!el) return;
      el.style.display = on ? 'flex' : 'none';
    }
    function toast(msg, type='ok', ms=2200){
      const wrap = document.getElementById('toastWrap');
      if(!wrap) return;
      const t = document.createElement('div');
      t.className = 'toast ' + (type||'ok');
      t.textContent = msg;
      wrap.appendChild(t);
      setTimeout(()=>{ t.style.opacity='0.1'; }, Math.max(0, ms-400));
      setTimeout(()=>{ t.remove(); }, ms);
    }

    const pad4 = s => String(s||'').replace(/\D/g,'').padStart(4,'0');
    const esc = v => (v==null?'':String(v)).replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[m]));
    const onlyDigits = s => String(s||'').replace(/\D/g,'');
    const normPhone = s => { let d=onlyDigits(s); if(d.startsWith('66') && d.length>=11) d='0'+d.slice(-9); return d; };

    function ymdLocal(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }
    function parseYmdLocal(s){
      const m = String(s||'').match(/^(\d{4})-(\d{2})-(\d{2})/);
      if(!m) return null;
      const y = +m[1], mo = +m[2], d = +m[3];
      const dt = new Date(y, mo-1, d);
      return isNaN(dt) ? null : dt;
    }
    const formatDate = d => { if(!d) return ''; const [y,m,dd]=d.split('-'); return `${dd}/${m}/${y.slice(-2)}`; };

    const quantile = (arr,q) => {
      if(!arr.length) return 0;
      const a=[...arr].sort((x,y)=>x-y);
      const pos=(a.length-1)*q, b=Math.floor(pos), r=pos-b;
      return a[b] + (a[b+1]!==undefined? r*(a[b+1]-a[b]) : 0);
    };
    const varGold = () => '#b8860b';

    function parseItemNames(s){
      const m = String(s).match(/^(.*?) ?(?:\((.*?)\))? - /);
      if(!m) return {main:String(s).split(' - ')[0].trim(), sub:''};
      return {main:(m[1]||'').trim(), sub:(m[2]||'').trim()};
    }
    function keyForCustomer(rec){
      const opd = pad4(rec.opd||'');
      if(/^\d{4}$/.test(opd) && opd!=='0000') return 'OPD:'+opd;
      return 'NP:'+ (rec.name||'').trim().toLowerCase() + '|' + normPhone(rec.phone||'');
    }
    function keyNamePhone(v){ return `${v.name}|${v.phone||''}`; }

    function recordAmount(r){
      const a = parseFloat(r.amount);
      if(!isNaN(a)) return a;
      let sum=0; (r.items||[]).forEach(s=>{
        const m = String(s).match(/ - (\d+(?:\.\d+)?) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+(?:\.\d+)?) ‡∏ö‡∏≤‡∏ó$/);
        if(m){ sum += parseFloat(m[1])*parseFloat(m[2]); }
      });
      return sum;
    }

    const productCategories = {
      "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": ["Aestox 50 u", "Aestox 100 u", "Allergan 50 u", "Allergan 100 u", "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î", "‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß", "Nabota"],
      "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥", "Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á", "E.P.T.Q ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢", "Restylane ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢"],
      "Fat/Hifu": ["Bromi", "Sisi", "HIFU", "HIFU ‡πÅ‡∏ñ‡∏°"],
      "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": [
        "Meso Chanel", "P - Cell", "Aquatic", "Hestina", "Exosome", "Rejuran",
        "Belotero Revive", "Sculptra", "Juvelook", "Aesthefill",
        "PRP", "Mesowink", "‡∏™‡∏∞‡∏Å‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "Alphaarbutin", "Transamine", "Biocollagen"
      ],
      "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster"],
      "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": ["‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤", "‡∏ú‡∏•‡∏±‡∏Å‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô", "‡∏õ‡∏±‡πà‡∏ô RF", "‡∏Å‡∏î‡∏™‡∏¥‡∏ß", "subcision‡∏™‡∏¥‡∏ß"],
      "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": [
        "‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤", "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤",
        "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÑ‡∏´‡∏° PDO", "‡πÑ‡∏´‡∏° Collagen",
        "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô/‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏™‡∏•‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå", "PRP‡∏ú‡∏°", "‡∏à‡∏µ‡πâ‡πÑ‡∏ù"
      ],
      "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©": []
    };

    async function loadAllSales(){
      const r = await fetch('/api/sales');
      if(!r.ok) throw new Error('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      state.allSales = await r.json() || [];
      state.allSales.forEach(rec=>{
        if(rec.item && !rec.items){
          try{ rec.items = JSON.parse(rec.item); }catch(e){ rec.items=[]; }
        }
      });
      state.allCustomerRecords = state.allSales.slice();
    }
    async function loadAllProfiles(){
      try{
        const r = await fetch('/api/customers');
        const arr = await r.json();
        state.profileByOpd = new Map((arr||[]).map(c => [pad4(c.opd||''), c.profile || '']));
      }catch(e){
        state.profileByOpd = new Map();
      }
    }

    function runWithConcurrency(items, worker, limit=8){
      let i = 0, inFlight = 0;
      return new Promise(resolve=>{
        function next(){
          while(inFlight < limit && i < items.length){
            const idx = i++; inFlight++;
            Promise.resolve(worker(items[idx], idx))
              .finally(()=>{
                inFlight--;
                if(i < items.length) next();
                else if(inFlight===0) resolve();
              });
          }
        }
        next();
      });
    }

    async function fetchAllPitchesForOPD(opd){
      try{
        const r = await fetch(`/api/pitches?opd=${encodeURIComponent(opd)}`);
        if(!r.ok) return [];
        const arr = await r.json();
        return Array.isArray(arr) ? arr : [];
      }catch{
        return [];
      }
    }

    async function fetchPitchSummaryBatch(opds){
      const now = Date.now();
      const fresh = (now - state.pitchSummaryFetchedAt) < state.pitchSummaryTTLms;
      if(fresh){
        const missing = opds.filter(opd => !state.pitchSummaryCache.has(opd));
        if(missing.length === 0) return;
      }

      try{
        const r = await fetch('/api/pitches/summary', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ opds })
        });
        if(r.ok){
          const data = await r.json() || {};
          for(const opd of opds){
            const v = data[opd];
            if(v && typeof v === 'object'){
              state.pitchSummaryCache.set(opd, {
                latest: v.latest || null,
                count: Number.isFinite(v.count) ? v.count : 0
              });
            }else{
              state.pitchSummaryCache.set(opd, { latest: null, count: 0 });
            }
          }
          state.pitchSummaryFetchedAt = Date.now();
          return;
        }
      }catch(e){}

      await runWithConcurrency(opds, async (opd)=>{
        const rows = await fetchAllPitchesForOPD(opd);
        const count = rows.length;
        rows.sort((a,b)=> String(b.created_at||'').localeCompare(String(a.created_at||'')));
        const top = rows[0] || null;
        const latest = top ? { created_at: top.created_at, content: top.content, outcome: top.outcome || '' } : null;
        state.pitchSummaryCache.set(opd, { latest, count });
      }, 8);
      state.pitchSummaryFetchedAt = Date.now();
    }

    function applyRange(){
      const s = document.getElementById('startDate').value || '2000-01-01';
      const e = document.getElementById('endDate').value || ymdLocal(new Date());

      const sD = parseYmdLocal(s) || new Date(2000,0,1);
      const eD = parseYmdLocal(e) || new Date();
      state.endAnchorDate = eD;

      state.filtered = state.allSales.filter(r=>{
        const ds = String(r.date||'').slice(0,10);
        const d = parseYmdLocal(ds);
        if(!d) return false;
        return d>=sD && d<=eD;
      });

      state.customersMap = new Map();
      for(const r of state.filtered){
        const k = keyForCustomer(r);
        if(!state.customersMap.has(k)){
          state.customersMap.set(k, { key:k, name:r.name||'-', phone:r.phone||'', opd:pad4(r.opd||''), bills:[] });
        }
        state.customersMap.get(k).bills.push(r);
      }

      for(const v of state.customersMap.values()){
        v.bills.sort((a,b)=> String(a.date||'').localeCompare(String(b.date||'')));
        v.first = v.bills[0]?.date?.slice(0,10) || '';
        v.last  = v.bills[v.bills.length-1]?.date?.slice(0,10) || '';
        v.revenue = v.bills.reduce((s,x)=> s + recordAmount(x), 0);
        v.aov = v.bills.length ? v.revenue / v.bills.length : 0;

        const lastDt = parseYmdLocal(v.last);
        v.recency = lastDt ? Math.floor((state.endAnchorDate - lastDt)/(1000*60*60*24)) : 9999;

        v.maxBill = v.bills.reduce((m,x)=> Math.max(m, recordAmount(x)||0 ), 0);
      }

      if(state.appliedNote && typeof state.reconApplySpecial === 'function'){
        state.reconApplySpecial();
      }

      renderAll();
    }

    function addProductSelect(){
      const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.gap='8px'; wrap.style.alignItems='center'; wrap.style.flexWrap='wrap';
      const selCat = document.createElement('select'); selCat.className='ipt'; selCat.style.width='160px';
      selCat.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>` + Object.keys(productCategories).map(c=>`<option value="${c}">${c}</option>`).join('');
      const selSub = document.createElement('select'); selSub.className='ipt'; selSub.style.width='220px';
      selSub.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</option>`;
      selCat.addEventListener('change', ()=>{
        const subs = productCategories[selCat.value] || [];
        selSub.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</option>` + subs.map(x=>`<option value="${x}">${x}</option>`).join('');
      });
      const btnX = document.createElement('button'); btnX.type='button'; btnX.className='btn btn-ghost'; btnX.textContent='‡∏•‡∏ö'; btnX.onclick=()=>wrap.remove();
      wrap.appendChild(selCat); wrap.appendChild(selSub); wrap.appendChild(btnX);
      document.getElementById('productListContainer').appendChild(wrap);
    }
    function getSelectedProductConditions(){
      return [...document.querySelectorAll('#productListContainer > div')].map(r=>{
        const sels = r.querySelectorAll('select'); return {cat:sels[0]?.value||'', sub:sels[1]?.value||''};
      }).filter(x=>x.cat);
    }
    function customerMatchesProducts(v){
      const conds = getSelectedProductConditions(); if(!conds.length) return true;
      for(const b of v.bills){
        for(const s of (b.items||[])){
          const {main, sub} = parseItemNames(s);
          for(const c of conds){ if(c.cat===main && (!c.sub || c.sub===sub)) return true; }
        }
      }
      return false;
    }
    function nameLike(v, q){ if(!q) return true; return (v.name||'').toLowerCase().includes(q.toLowerCase().trim()); }

    function filterGeneral(){
      const minT = parseFloat(document.getElementById('minTotal').value||''), maxT = parseFloat(document.getElementById('maxTotal').value||'');
      const minV = parseInt(document.getElementById('minVisits').value||''), maxV = parseInt(document.getElementById('maxVisits').value||'');
      const minA = parseInt(document.getElementById('minAbsent').value||''), maxA = parseInt(document.getElementById('maxAbsent').value||'');
      const minAvg = parseFloat(document.getElementById('minAvg').value||''), maxAvg = parseFloat(document.getElementById('maxAvg').value||'');
      const nameQ = document.getElementById('customerName').value||'';

      const keys=[];
      for(const [k,v] of state.customersMap){
        if(!customerMatchesProducts(v)) continue;
        if(!nameLike(v,nameQ)) continue;
        const visits=v.bills.length;
        if(!isNaN(minT) && v.revenue<minT) continue;
        if(!isNaN(maxT) && v.revenue>maxT) continue;
        if(!isNaN(minV) && visits<minV) continue;
        if(!isNaN(maxV) && visits>maxV) continue;
        if(!isNaN(minA) && v.recency<minA) continue;
        if(!isNaN(maxA) && v.recency>maxA) continue;
        if(!isNaN(minAvg) && v.aov<minAvg) continue;
        if(!isNaN(maxAvg) && v.aov>maxAvg) continue;
        keys.push(k);
      }

      state.selectedKeys = new Set(keys);
      state.appliedNote = '‚Äî ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á';
      state.reconApplySpecial = ()=>{ filterGeneral(); };
      updateAppliedBanner();
      document.getElementById('filterResults').textContent = `‡∏Ñ‡∏±‡∏î‡πÑ‡∏î‡πâ ${keys.length} ‡∏£‡∏≤‡∏¢ ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${state.customersMap.size} ‡∏£‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å`;
      renderAll();
      scrollToFinal();
    }
    function resetFilters(){
      document.getElementById('productListContainer').innerHTML='';
      ['minTotal','maxTotal','minVisits','maxVisits','minAbsent','maxAbsent','minAvg','maxAvg','customerName'].forEach(id=> document.getElementById(id).value='');
      state.selectedKeys=null; document.getElementById('filterResults').textContent='';
      state.appliedNote='';
      state.reconApplySpecial=null;
      updateAppliedBanner();
      renderAll();
    }

    function currentCustomers(){
      if(!state.selectedKeys) return state.customersMap;
      const m=new Map();
      for(const k of state.selectedKeys){ if(state.customersMap.has(k)) m.set(k, state.customersMap.get(k)); }
      return m;
    }

    function computeRFM(){
      state.rfmByKey.clear();
      const entries=[];
      for(const v of currentCustomers().values()){
        entries.push({v, R:v.recency, F:v.bills.length, M:v.revenue});
      }
      if(!entries.length) return {summary:[]};

      const cut = arr => [quantile(arr,.2),quantile(arr,.4),quantile(arr,.6),quantile(arr,.8)];
      const [r1,r2,r3,r4] = cut(entries.map(x=>x.R));
      const [f1,f2,f3,f4] = cut(entries.map(x=>x.F));
      const [m1,m2,m3,m4] = cut(entries.map(x=>x.M));

      const score=(v,b1,b2,b3,b4,rev=false)=>rev?(v<=b1?5:v<=b2?4:v<=b3?3:v<=b4?2:1):(v>b4?5:v>b3?4:v>b2?3:v>b1?2:1);
      const rename = seg => ({'Champions':'‡πÅ‡∏ä‡∏°‡∏õ‡πå (‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)','Loyal':'‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥','Potential':'‡∏°‡∏µ‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û','At Risk':'‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏´‡∏≤‡∏¢','Hibernating':'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û'})[seg] || seg;

      const segMap = {};
      for(const x of entries){
        const Rs=score(x.R,r1,r2,r3,r4,true), Fs=score(x.F,f1,f2,f3,f4,false), Ms=score(x.M,m1,m2,m3,m4,false);
        let k='Hibernating';
        if(Rs>=4 && Fs>=4 && Ms>=4) k='Champions';
        else if(Rs>=4 && (Fs>=3 || Ms>=3)) k='Loyal';
        else if(Rs>=3 && Fs>=3 && Ms>=2) k='Potential';
        else if(Rs<=2 && (Fs>=3 || Ms>=3)) k='At Risk';

        const th = rename(k);
        state.rfmByKey.set(x.v.key, th);

        if(!segMap[k]) segMap[k]={n:0,aov:[],rec:[], revSum:0};
        segMap[k].n++; segMap[k].aov.push(x.v.aov||0); segMap[k].rec.push(x.R); segMap[k].revSum += x.v.revenue||0;
      }

      const total=entries.length;
      const summary = Object.entries(segMap).map(([k,g])=>({
        seg:k, segTH:rename(k), n:g.n, pct:g.n*100/total,
        aov:(g.aov.reduce((a,b)=>a+b,0)/g.aov.length)||0,
        rec:(g.rec.reduce((a,b)=>a+b,0)/g.rec.length)||0,
        rev:g.revSum||0
      })).sort((a,b)=> b.n-a.n);

      return {summary};
    }

    function renderRFM(){
      const {summary} = computeRFM();
      const tbody = document.querySelector('#rfmTable tbody');
      tbody.innerHTML = summary.map(r=>`
        <tr>
          <td>${esc(r.segTH)}</td>
          <td>${r.n.toLocaleString()}</td>
          <td>${r.pct.toFixed(1)}%</td>
          <td>${Math.round(r.aov).toLocaleString()}</td>
          <td>${Math.round(r.rec)}</td>
          <td>${Math.round(r.rev).toLocaleString()}</td>
          <td style="text-align:center"><button class="icon-btn" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠" onclick="applyRFM('${esc(r.segTH)}')">üëÅ</button></td>
        </tr>
      `).join('') || `<tr><td colspan="7" class="sub-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    }

    function computeABC(){
      state.abcByKey.clear();
      const list = [...currentCustomers().values()].map(v=>({key:v.key, v, rev:v.revenue})).sort((a,b)=> b.rev-a.rev);
      const total = list.reduce((s,x)=> s+x.rev, 0) || 1;
      let cum = 0;
      const tagged = list.map(x=>{ cum += x.rev; return {...x, cumPct: cum/total}; });

      const A = tagged.filter(x=> x.cumPct<=0.8);
      const B = tagged.filter(x=> x.cumPct>0.8 && x.cumPct<=0.95);
      const C = tagged.filter(x=> x.cumPct>0.95);

      A.forEach(x=> state.abcByKey.set(x.key,'A'));
      B.forEach(x=> state.abcByKey.set(x.key,'B'));
      C.forEach(x=> state.abcByKey.set(x.key,'C'));

      const pct = n => tagged.length? (n*100/tagged.length).toFixed(1)+'%':'-';
      const pctRev = v => total? (v*100/total).toFixed(1)+'%':'-';
      const revA = A.reduce((s,x)=>s+x.rev,0), revB=B.reduce((s,x)=>s+x.rev,0), revC=C.reduce((s,x)=>s+x.rev,0);

      document.querySelector('#abcTable tbody').innerHTML = `
        <tr><td>A</td><td>${A.length.toLocaleString()}</td><td>${pct(A.length)}</td><td>${pctRev(revA)}</td><td>${Math.round(revA).toLocaleString()}</td><td style="text-align:center"><button class="icon-btn" onclick="applyABC('A')">üëÅ</button></td></tr>
        <tr><td>B</td><td>${B.length.toLocaleString()}</td><td>${pct(B.length)}</td><td>${pctRev(revB)}</td><td>${Math.round(revB).toLocaleString()}</td><td style="text-align:center"><button class="icon-btn" onclick="applyABC('B')">üëÅ</button></td></tr>
        <tr><td>C</td><td>${C.length.toLocaleString()}</td><td>${pct(C.length)}</td><td>${pctRev(revC)}</td><td>${Math.round(revC).toLocaleString()}</td><td style="text-align:center"><button class="icon-btn" onclick="applyABC('C')">üëÅ</button></td></tr>
      `;

      const topA = A.slice(0,10).map(x=>{
        const v=x.v; const key=keyNamePhone(v);
        return `<a class="link" href="javascript:;" onclick="openCustomerModal('${esc(key)}');event.stopPropagation();">${esc(v.name)}</a>`;
      }).join(', ');
      document.getElementById('abcWho').innerHTML = topA ? `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡πâ‡∏ô A: ${topA}` : '‚Äî';

      return {A, B, C, totalRevenue: total, revA, revB, revC};
    }

    const recencyBuckets = [
      {label:'0‚Äì30', min:0, max:30},
      {label:'31‚Äì60', min:31, max:60},
      {label:'61‚Äì90', min:61, max:90},
      {label:'90‚Äì180', min:90, max:180},
      {label:'181‚Äì365', min:181, max:365},
      {label:'365 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ', min:365, max:Infinity}
    ];
    function renderRecencyDistribution(){
      const cust = [...currentCustomers().values()];
      const totalN = cust.length||1;
      const rows = recencyBuckets.map(b=>{
        const inBucket = cust.filter(v=> v.recency>=b.min && v.recency<=b.max);
        const n = inBucket.length;
        const pct = (n*100/totalN).toFixed(1);
        const avgAOV = n? Math.round(inBucket.reduce((s,x)=>s+(x.aov||0),0)/n) : 0;
        const sumRev = Math.round(inBucket.reduce((s,x)=>s+(x.revenue||0),0));
        return {b, n, pct, avgAOV, sumRev};
      });

      const tb = document.querySelector('#recencyTable tbody');
      tb.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.b.label}</td>
          <td>${r.n.toLocaleString()}</td>
          <td>${r.pct}%</td>
          <td>${r.avgAOV.toLocaleString()}</td>
          <td>${r.sumRev.toLocaleString()}</td>
          <td style="text-align:center">
            <button class="icon-btn" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠" onclick='applyRecency(${JSON.stringify(r.b.min)},${JSON.stringify(r.b.max)},"${r.b.label}")'>üëÅ</button>
          </td>
        </tr>
      `).join('') || `<tr><td colspan="6" class="sub-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    }

    const spendBands = [
      {label:'0‚Äì2,000', min:0, max:2000},
      {label:'2,001‚Äì5,000', min:2001, max:5000},
      {label:'5,001‚Äì10,000', min:5001, max:10000},
      {label:'10,001‚Äì15,000', min:10001, max:15000},
      {label:'15,001‚Äì20,000', min:15001, max:20000},
      {label:'‚â• 20,001', min:20001, max:Infinity}
    ];
    function renderSpendBands(){
      const cust = [...currentCustomers().values()];
      const totalN = cust.length||1;
      const rows = spendBands.map(b=>{
        const inBand = cust.filter(v=> v.aov>=b.min && v.aov<=b.max);
        const n = inBand.length;
        const pct = (n*100/totalN).toFixed(1);
        const avgPerPerson = n? Math.round(inBand.reduce((s,x)=>s+(x.aov||0),0)/n) : 0;
        const sumRev = Math.round(inBand.reduce((s,x)=>s+(x.revenue||0),0));
        return {b,n,pct,avgPerPerson,sumRev};
      });
      const tb = document.querySelector('#spendBandTable tbody');
      tb.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.b.label}</td>
          <td>${r.n.toLocaleString()}</td>
          <td>${r.pct}%</td>
          <td>${r.avgPerPerson.toLocaleString()}</td>
          <td>${r.sumRev.toLocaleString()}</td>
          <td style="text-align:center"><button class="icon-btn" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠" onclick="applySpend(${r.b.min}, ${r.b.max}, '${r.b.label}')">üëÅ</button></td>
        </tr>
      `).join('') || `<tr><td colspan="6" class="sub-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    }

    const today = () => new Date();
    const daysSince = (iso) => {
      if(!iso) return Number.POSITIVE_INFINITY;
      const d = new Date(iso);
      const t = today();
      return Math.floor((t - d)/(1000*60*60*24));
    };

    function buildFinalRows(){
      const m=currentCustomers();
      state.finalRows = [...m.values()].map(v=>{
        const visits=v.bills.length, total=v.revenue, avg=visits? Math.round(total/visits):0;

        let recColor='#6b7280';
        if(v.recency<30) recColor='green';
        else if(v.recency<=90) recColor='orange';
        else recColor='crimson';

        let totColor='#6b7280', totExtra='', totIcon='';
        if(total<50000) totColor='crimson';
        else if(total<=99999) totColor='green';
        else if(total<=200000) totColor='goldenrod';
        else { totColor='#8B6508'; totExtra='font-weight:bold;'; totIcon=' üíé'; }

        let avgColor='#6b7280';
        if(avg<3000) avgColor='crimson';
        else if(avg<=9999) avgColor='green';
        else avgColor=varGold();

        const sum = state.pitchSummaryCache.get(v.opd) || { latest:null, count:0 };
        const latest = sum.latest;
        const pitchCount = sum.count || 0;

        const days = latest ? daysSince(latest.created_at) : Number.POSITIVE_INFINITY;
        const outcomeStr = latest ? `${latest.content||'-'}${latest.outcome? ' ‚Äî '+latest.outcome : ''}` : '';

        return {
          v, visits, avg, total, maxBill:Math.round(v.maxBill||0),
          recency:v.recency, recColor, totColor, totExtra, totIcon, avgColor,
          rfm: state.rfmByKey.get(v.key) || '-', abc: state.abcByKey.get(v.key) || '-',
          lastPitchDays: isFinite(days)? days : null,
          lastOutcomeStr: outcomeStr,
          pitchCount,
          profile: state.profileByOpd.get(v.opd) || ''
        };
      });
    }

    function renderFinalTable(){
      const col = state.finalSort.col, dir = state.finalSort.dir;
      const val = (r,idx) => {
        switch(idx){
          case 1: return r.v.opd||'';
          case 2: return (r.v.name||'').toLowerCase();
          case 3: return r.visits||0;
          case 4: return r.avg||0;
          case 5: return r.total||0;
          case 6: return r.maxBill||0;
          case 7: return r.recency||0;
          case 8: return (r.rfm||'').toLowerCase();
          case 9: return (r.abc||'').toLowerCase();
          case 10: return (r.lastPitchDays!=null? r.lastPitchDays : Number.POSITIVE_INFINITY);
          case 11: return (r.lastOutcomeStr||'').toLowerCase();
          case 12: return (r.profile||'').toLowerCase();
          default: return 0;
        }
      };

      state.finalRows.sort((a,b)=>{
        const A=val(a,col), B=val(b,col);
        let cmp = 0;
        if(typeof A==='number' && typeof B==='number') cmp = (A-B);
        else cmp = (A>B?1:A<B?-1:0);

        if(cmp===0){
          const ao = (a.v.opd||''); const bo = (b.v.opd||'');
          if(ao!==bo) return (ao>bo?1:-1);
          const an = (a.v.name||'').toLowerCase(); const bn = (b.v.name||'').toLowerCase();
          if(an!==bn) return (an>bn?1:-1);
          return 0;
        }
        return cmp*dir;
      });

      const tb = document.querySelector('#finalCustTable tbody');
      tb.innerHTML = state.finalRows.map((r,i)=>{
        const key = keyNamePhone(r.v);

        const pitchText = (r.lastPitchDays==null) ? '‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢' : `${r.lastPitchDays} ‡∏ß‡∏±‡∏ô`;
        const latest = (state.pitchSummaryCache.get(r.v.opd)||{}).latest;
        const dd = latest ? String(latest.created_at||'').slice(0,10) : '';
        const pitchTitle = latest
          ? `Pitch ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${formatDate(dd)} ‚Ä¢ ${latest.content||''}${latest.outcome? ' ‚Äî '+latest.outcome : ''} ‚Ä¢ ‡∏£‡∏ß‡∏° ${r.pitchCount||0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`
          : `‚Äî ‚Ä¢ ‡∏£‡∏ß‡∏° ${r.pitchCount||0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;

        // UI badge ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RFM/ABC ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏¢‡∏∏‡πà‡∏á‡∏ï‡∏£‡∏£‡∏Å‡∏∞ (‡πÅ‡∏Ñ‡πà display)
        const rfmBadge = (() => {
          const s = String(r.rfm||'');
          if(s.includes('‡πÅ‡∏ä‡∏°‡∏õ‡πå')) return `<span class="badge b-ok">üèÜ ${esc(s)}</span>`;
          if(s.includes('‡∏õ‡∏£‡∏∞‡∏à‡∏≥')) return `<span class="badge b-ok">üíö ${esc(s)}</span>`;
          if(s.includes('‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á')) return `<span class="badge b-warn">‚ö†Ô∏è ${esc(s)}</span>`;
          if(s.includes('‡πÑ‡∏°‡πà‡∏°‡∏µ')) return `<span class="badge b-gray">ü™µ ${esc(s)}</span>`;
          return `<span class="badge b-gray">${esc(s||'-')}</span>`;
        })();
        const abcBadge = (() => {
          const s = String(r.abc||'-').toUpperCase();
          if(s==='A') return `<span class="badge b-ok">A</span>`;
          if(s==='B') return `<span class="badge b-warn">B</span>`;
          if(s==='C') return `<span class="badge b-gray">C</span>`;
          return `<span class="badge b-gray">-</span>`;
        })();

        return `<tr data-opd="${esc(r.v.opd)}">
          <td>${i+1}</td>
          <td>${esc(r.v.opd)}</td>
          <td><a class="link" href="javascript:;" onclick="openCustomerModal('${esc(key)}');event.stopPropagation();">${esc(r.v.name)}</a></td>
          <td>${r.visits}</td>
          <td style="color:${r.avgColor}">${r.avg.toLocaleString()}</td>
          <td style="color:${r.totColor}; ${r.totExtra}">${Math.round(r.total).toLocaleString()}${r.totIcon}</td>
          <td>${r.maxBill.toLocaleString()}</td>
          <td style="color:${r.recColor}">${r.recency}</td>
          <td>${rfmBadge}</td>
          <td>${abcBadge}</td>
          <td class="lp-cell" title="${esc(pitchTitle)}">${esc(pitchText)}</td>
          <td class="lp-outcome">${esc(r.lastOutcomeStr || '‚Äî')}</td>
          <td>
            <textarea class="profile-editor" data-opd="${esc(r.v.opd)}" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‚Ä¶">${esc(r.profile || '')}</textarea>
          </td>
        </tr>`;
      }).join('') || `<tr><td colspan="13" class="sub-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>`;
    }

    /* KPI update (‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏Ñ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå) */
    function updateKpis(){
      const cust = [...currentCustomers().values()];
      const nCust = cust.length;
      const rev = Math.round(cust.reduce((s,v)=> s+(v.revenue||0), 0));
      const bills = cust.reduce((s,v)=> s+(v.bills?.length||0), 0);
      const aov = bills ? Math.round(rev / bills) : 0;

      const risk = cust.filter(v => (v.recency||0) >= 90).length;

      // ‡∏ô‡∏±‡∏ö A-class ‡∏à‡∏≤‡∏Å abcByKey
      let aCount = 0;
      for(const v of cust){
        if(state.abcByKey.get(v.key) === 'A') aCount++;
      }

      const setTxt = (id, val) => { const el=document.getElementById(id); if(el) el.textContent = val; };
      setTxt('kpiCustomersV', nCust.toLocaleString());
      setTxt('kpiRevenueV', rev.toLocaleString());
      setTxt('kpiAovV', aov.toLocaleString());
      setTxt('kpiRiskV', risk.toLocaleString());
      setTxt('kpiAClassV', aCount.toLocaleString());
    }

    async function hydratePitchSummaryForCurrentRows(){
      const token = ++state.lastHydrateToken;

      const opds = [...new Set([...currentCustomers().values()].map(v=>v.opd).filter(Boolean))];
      if(!opds.length) return;

      buildFinalRows();
      renderFinalTable();

      await fetchPitchSummaryBatch(opds);
      if(token !== state.lastHydrateToken) return;

      buildFinalRows();
      renderFinalTable();
    }

    function renderAll(){
      renderRFM();
      const abcRes = computeABC();
      renderRecencyDistribution();
      renderSpendBands();

      updateAppliedBanner();
      updateKpis();

      hydratePitchSummaryForCurrentRows().catch(()=>{});
    }

    function setSelectedByPredicate(pred){
      const keys=[];
      for(const [k,v] of state.customersMap){ if(pred(v)) keys.push(k); }
      state.selectedKeys = new Set(keys);
      renderAll();
      scrollToFinal();
    }
    function scrollToFinal(){
      const el = document.getElementById('finalSection');
      if(el && el.scrollIntoView) el.scrollIntoView({behavior:'smooth', block:'start'});
    }
    function updateAppliedBanner(){
      const b = document.getElementById('appliedBanner');
      if(state.appliedNote){ b.textContent = state.appliedNote; b.style.display='block'; }
      else { b.textContent=''; b.style.display='none'; }
    }

    function applyRecency(min,max,label){
      state.appliedNote = `‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°: Recency ${label} ‡∏ß‡∏±‡∏ô`;
      state.selectedKeys = null;
      const pred = v => v.recency>=min && v.recency<=max;
      state.reconApplySpecial = ()=> setSelectedByPredicate(pred);
      setSelectedByPredicate(pred);
    }
    function applyABC(cls){
      state.appliedNote = `‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°: ABC ‡∏ä‡∏±‡πâ‡∏ô ${cls}`;
      state.selectedKeys = null;
      computeABC();
      const pred = v => (state.abcByKey.get(v.key) === cls);
      state.reconApplySpecial = ()=> { computeABC(); setSelectedByPredicate(pred); };
      setSelectedByPredicate(pred);
    }
    function applyRFM(segTH){
      state.appliedNote = `‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°: RFM: ${segTH}`;
      state.selectedKeys = null;
      computeRFM();
      const pred = v => (state.rfmByKey.get(v.key) === segTH);
      state.reconApplySpecial = ()=> { computeRFM(); setSelectedByPredicate(pred); };
      setSelectedByPredicate(pred);
    }
    function applySpend(min,max,label){
      state.appliedNote = `‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°: AOV ${label}`;
      state.selectedKeys = null;
      const pred = v => v.aov>=min && v.aov<=max;
      state.reconApplySpecial = ()=> setSelectedByPredicate(pred);
      setSelectedByPredicate(pred);
    }

    function setQuickRange(preset){
      const end = new Date();
      let start = new Date(2000,0,1);
      if(preset==='thisMonth'){ start = new Date(end.getFullYear(), end.getMonth(), 1);
      }else if(preset==='2m'){ start = new Date(end.getFullYear(), end.getMonth()-1, 1);
      }else if(preset==='3m'){ start = new Date(end.getFullYear(), end.getMonth()-2, 1);
      }else if(preset==='6m'){ start = new Date(end.getFullYear(), end.getMonth()-5, 1);
      }else if(preset==='thisYear'){ start = new Date(end.getFullYear(), 0, 1);
      }else if(preset==='all'){ start = new Date(2000,0,1); }
      document.getElementById('startDate').value = ymdLocal(start);
      document.getElementById('endDate').value   = ymdLocal(end);
    }

    function applyAbsentChip(range){
      let min=0, max=Infinity, label=range;
      if(range.includes('+')){
        min=parseInt(range); max=Infinity;
        label = (min===365? '1 ‡∏õ‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ' : `${min}+`);
      } else {
        const [a,b]=range.split('-');
        min=parseInt(a); max=parseInt(b);
        label=`${a}‚Äì${b}`;
      }

      state.appliedNote = `‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤ ${label} ‡∏ß‡∏±‡∏ô`;
      const pred = v => v.recency>=min && v.recency<=max;
      state.reconApplySpecial = ()=> {
        state.appliedNote = `‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤ ${label} ‡∏ß‡∏±‡∏ô`;
        setSelectedByPredicate(pred);
      };

      setQuickRange('all');
      applyRange();
      setSelectedByPredicate(pred);
    }

    /* Range modal hooks */
    function openRangeModal(){
      const s = document.getElementById('startDate').value;
      const e = document.getElementById('endDate').value;
      document.getElementById('rangeStartModal').value = s || '';
      document.getElementById('rangeEndModal').value = e || '';
      document.getElementById('rangeModal').style.display = 'block';
    }
    function closeRangeModal(){ document.getElementById('rangeModal').style.display = 'none'; }
    function applyRangeFromModal(){
      const s = document.getElementById('rangeStartModal').value;
      const e = document.getElementById('rangeEndModal').value;
      if(!s || !e){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'); return; }
      if(parseYmdLocal(s) > parseYmdLocal(e)){ alert('‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'); return; }
      document.getElementById('startDate').value = s;
      document.getElementById('endDate').value = e;
      closeRangeModal();
      state.appliedNote=''; state.reconApplySpecial=null;
      state.selectedKeys=null;
      applyRange();
    }

    /* Table sort click */
    document.addEventListener('click', (e)=>{
      const th = e.target.closest('#finalCustTable thead th');
      if(!th) return;
      const idx = Array.from(th.parentNode.children).indexOf(th);
      if(idx===0) return;
      state.finalSort.dir = (state.finalSort.col===idx? -state.finalSort.dir : 1);
      state.finalSort.col = idx;
      renderFinalTable();
    });

    /* Click pitch cell to open history */
    document.addEventListener('click', (e)=>{
      const cell = e.target.closest('#finalCustTable td.lp-cell');
      if(!cell) return;
      const tr = cell.closest('tr');
      if(!tr) return;
      const opd = tr.getAttribute('data-opd') || '';
      const nameCell = tr.querySelector('td:nth-child(3)');
      const displayName = nameCell ? nameCell.textContent.trim() : opd;
      if(!opd){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö OPD ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'); return; }
      openPitchModalForOPD(opd, displayName);
    });

    /* Search */
    document.addEventListener('input', (e)=>{
      if(e.target && e.target.id==='qSearch'){
        const val = e.target.value.trim().toLowerCase();
        ['finalCustTable','rfmTable','abcTable','recencyTable','spendBandTable'].forEach(id=>{
          document.querySelectorAll(`#${id} tbody tr`).forEach(tr=>{
            const txt = tr.textContent.toLowerCase();
            tr.style.display = txt.includes(val)? '' : 'none';
          });
        });
      }
    });

    /* Profile autosave */
    async function saveProfile(opd, value){
      try{
        const r = await fetch('/api/update_customer', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({opd:String(opd), field:'profile', value})
        });
        const d = await r.json();
        return !!d.message;
      }catch{ return false; }
    }
    const profileDebounce = new Map();
    function scheduleProfileSave(opd, ta){
      clearTimeout(profileDebounce.get(opd));
      profileDebounce.set(opd, setTimeout(()=> doProfileSave(opd, ta), 800));
    }
    async function doProfileSave(opd, ta){
      const value = ta.value;
      ta.classList.remove('saved','error');
      ta.classList.add('saving');
      const ok = await saveProfile(opd, value);
      ta.classList.remove('saving');
      if(ok){
        ta.classList.add('saved');
        state.profileByOpd.set(opd, value);
        const rowObj = state.finalRows.find(r => r.v.opd === opd);
        if(rowObj) rowObj.profile = value;
        toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß', 'ok');
        setTimeout(()=> ta.classList.remove('saved'), 1200);
      }else{
        ta.classList.add('error');
        toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'err');
        setTimeout(()=> ta.classList.remove('error'), 1500);
      }
    }
    document.addEventListener('input', (e)=>{
      const ta = e.target && e.target.classList && e.target.classList.contains('profile-editor') ? e.target : null;
      if(!ta) return;
      const opd = ta.getAttribute('data-opd');
      if(!opd) return;
      scheduleProfileSave(opd, ta);
    });
    document.addEventListener('blur', async (e)=>{
      const ta = e.target && e.target.classList && e.target.classList.contains('profile-editor') ? e.target : null;
      if(!ta) return;
      const opd = ta.getAttribute('data-opd');
      if(!opd) return;
      clearTimeout(profileDebounce.get(opd));
      await doProfileSave(opd, ta);
    }, true);

    /* KPI click actions */
    document.getElementById('kpiCustomers')?.addEventListener('click', ()=> scrollToFinal());
    document.getElementById('kpiRisk')?.addEventListener('click', ()=> applyRecency(90, Infinity, '90+'));
    document.getElementById('kpiAClass')?.addEventListener('click', ()=> applyABC('A'));

    /* Buttons */
    document.getElementById('btnApply').addEventListener('click', async ()=>{
      showLoading(true);
      try{ applyRange(); }
      finally{ setTimeout(()=>showLoading(false), 150); }
    });
    document.getElementById('openCustomRange').addEventListener('click', openRangeModal);
    document.getElementById('btnAddProduct').addEventListener('click', addProductSelect);
    document.getElementById('btnRunAdv').addEventListener('click', filterGeneral);
    document.getElementById('btnResetAdv').addEventListener('click', resetFilters);

    /* Chips */
    document.querySelectorAll('.chip[data-range]').forEach(chip=>{
      chip.addEventListener('click', ()=>{
        document.querySelectorAll('.chip[data-range]').forEach(c=>c.classList.remove('active'));
        chip.classList.add('active');
        const preset = chip.getAttribute('data-range');
        state.appliedNote=''; state.reconApplySpecial=null;
        state.selectedKeys=null;
        if(preset.startsWith('abs:')){
          applyAbsentChip(preset.replace('abs:',''));
        }else{
          setQuickRange(preset);
          applyRange();
        }
      });
    });

    /* Export CSV */
    function exportFinalCsv(){
      if(!state.finalRows.length){
        toast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ export', 'warn');
        return;
      }
      const header = ['OPD','‡∏ä‡∏∑‡πà‡∏≠','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á','‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏•','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°','‡∏ö‡∏¥‡∏•‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î','‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤(‡∏ß‡∏±‡∏ô)','RFM','ABC','Pitch‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î(‡∏ß‡∏±‡∏ô)','Outcome‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î','Profile'];
      const lines = [header];

      for(const r of state.finalRows){
        lines.push([
          r.v.opd||'',
          r.v.name||'',
          r.visits||0,
          r.avg||0,
          Math.round(r.total||0),
          r.maxBill||0,
          r.recency||0,
          r.rfm||'',
          r.abc||'',
          (r.lastPitchDays==null?'‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢':r.lastPitchDays),
          r.lastOutcomeStr||'',
          (r.profile||'').replace(/\r?\n/g,' ')
        ]);
      }

      const csv = lines.map(row => row.map(cell=>{
        const s = String(cell ?? '');
        if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      }).join(',')).join('\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `customers_${ymdLocal(new Date())}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast('Export CSV ‡πÅ‡∏•‡πâ‡∏ß', 'ok');
    }
    document.getElementById('btnExportCsv').addEventListener('click', exportFinalCsv);

    /* Modals */
    function closeCustomerModal(){ document.getElementById('customer-modal').style.display='none'; }
    document.getElementById('customer-modal').addEventListener('click', (e)=>{
      const box = document.querySelector('#customer-modal .box');
      if(box && !box.contains(e.target)) closeCustomerModal();
    });

    function closePitchModal(){
      const m = document.getElementById('pitch-modal');
      if(m) m.style.display='none';
    }
    document.getElementById('pitch-modal')?.addEventListener('click', (e)=>{
      const box = e.target.closest('.box');
      if(!box) closePitchModal();
    });

    function fmtDateTime(iso){
      if(!iso) return '';
      const d = new Date(iso);
      if(isNaN(d)) return iso;
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
      return `${dd}/${m}/${String(y).slice(-2)} ${hh}:${mm}`;
    }

    async function openPitchModalForOPD(opd, displayName){
      try{
        const r = await fetch(`/api/pitches?opd=${encodeURIComponent(opd)}`);
        if(!r.ok){ alert('‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Pitch ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); return; }
        const rows = await r.json() || [];
        const count = rows.length;

        rows.sort((a,b)=> String(b.created_at||'').localeCompare(String(a.created_at||'')));

        const table = rows.map((p,idx)=>`
          <tr>
            <td>${idx+1}</td>
            <td>${fmtDateTime(p.created_at||'')}</td>
            <td>${esc(p.channel||'-')}</td>
            <td>${esc(p.promotion||'-')}</td>
            <td>${esc(p.outcome||'-')}</td>
            <td>${esc(p.content||'-')}</td>
            <td>${esc(p.author||'-')}</td>
          </tr>
        `).join('') || `<tr><td colspan="7" class="sub-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ Pitch</td></tr>`;

        const html = `
          <div style="margin-bottom:10px">
            <div style="font-size:16px;font-weight:900;color:#064e3b">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ Pitch ‚Äî ${esc(displayName||opd)}</div>
            <div class="sub-muted">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <b>${count.toLocaleString()}</b> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
          </div>
          <table style="width:100%; border-collapse:collapse; background:#fff">
            <thead>
              <tr>
                <th style="width:48px">#</th>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                <th>‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</th>
                <th>Outcome</th>
                <th>Comment</th>
                <th>‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
              </tr>
            </thead>
            <tbody>${table}</tbody>
          </table>
        `;
        document.getElementById('pitch-modal-content').innerHTML = html;
        document.getElementById('pitch-modal').style.display='flex';
      }catch(e){
        console.error(e);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Pitch');
      }
    }

    /* Customer modal (‡∏¢‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ) */
    async function openCustomerModal(key) {
      let cust = state.customersMap.get(key);

      if (!cust) {
        const [name, phone = ''] = String(key).split('|');
        const norm = s => (s || '').trim().toLowerCase();

        const recs = state.allSales.filter(r =>
          norm(r.name) === norm(name) &&
          norm(r.phone || '') === norm(phone)
        );

        if (!recs.length) return;

        cust = {
          key,
          name: recs[0].name,
          phone: recs[0].phone || '',
          opd: pad4(recs[0].opd || ''),
          bills: recs.slice()
        };
      }

      const records = cust.bills.slice().sort((a, b) => String(b.date||'').localeCompare(String(a.date||'')));

      const customer = {
        name: cust.name,
        phone: cust.phone || '-',
        opd: cust.opd || '-'
      };

      const latestRecord = records[0];
      const lastDateStr = (latestRecord?.date || '').slice(0, 10);

      const baseDate = state.endAnchorDate || new Date();
      const lastDate = parseYmdLocal(lastDateStr);
      const daysAbsent = !lastDate ? 0 : Math.floor((baseDate - lastDate) / (1000 * 60 * 60 * 24));

      const totalVisits = records.length;

      const paidRecords = records.filter(r => recordAmount(r) > 0);
      const paidVisits = paidRecords.length;
      const totalAmount = paidRecords.reduce((s, r) => s + recordAmount(r), 0);
      const average = paidVisits > 0 ? Math.round(totalAmount / paidVisits) : 0;

      const allItems = {};
      records.forEach(r => {
        (r.items || []).forEach(item => {
          let name = item;
          const m = item.match(/\((.*?)\)/);
          name = m ? m[1] : item.split(" - ")[0];

          const q = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
          const qty = q ? parseInt(q[1]) : 1;

          allItems[name] = (allItems[name] || 0) + qty;
        });
      });

      const categoryMap = {
        "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": ["Aestox 50 u","Aestox 100 u","Allergan 50 u","Allergan 100 u","‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î","‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß","Nabota"],
        "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥","Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á","E.P.T.Q ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢","Restylane ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢"],
        "Fat/Hifu": ["Bromi","Sisi","HIFU","HIFU ‡πÅ‡∏ñ‡∏°"],
        "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": [
          "Meso Chanel","P - Cell","Aquatic","Hestina","Exosome","Rejuran",
          "Belotero Revive","Sculptra","Juvelook","Aesthefill","PRP","Mesowink",
          "‡∏™‡∏∞‡∏Å‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™","Alphaarbutin","Transamine","Biocollagen"
        ],
        "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White","Super Aurawhite","Vitamin Mix","Brain Booster","Energy Booster"],
        "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": [
          "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™","‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß","‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤",
          "‡∏ú‡∏•‡∏±‡∏Å‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô","‡∏õ‡∏±‡πà‡∏ô RF","‡∏Å‡∏î‡∏™‡∏¥‡∏ß","subcision‡∏™‡∏¥‡∏ß"
        ],
        "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": [
          "‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤","‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤","‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤",
          "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤","‡πÑ‡∏´‡∏° PDO","‡πÑ‡∏´‡∏° Collagen",
          "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô/‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤","‡∏™‡∏•‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå","PRP‡∏ú‡∏°","‡∏à‡∏µ‡πâ‡πÑ‡∏ù"
        ],
        "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©": []
      };

      const categorizedItems = {};
      for (const [cat, names] of Object.entries(categoryMap)) {
        names.forEach(n => {
          if (allItems[n]) {
            (categorizedItems[cat] ||= []).push(`${n} : ${allItems[n]}`);
            delete allItems[n];
          }
        });
      }
      if (Object.keys(allItems).length) {
        (categorizedItems["‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] ||= []).push(
          ...Object.entries(allItems).map(([n, q]) => `${n} : ${q}`)
        );
      }

      const itemSummary = Object.entries(categorizedItems)
        .map(([cat, items]) => `
          <div style="margin-bottom:6px;">
            <strong>${cat}</strong>: ${items.join(" | ")}
          </div>
        `).join("");

      const historyHtml = records.map(r => {
        const items = (r.items || []).map(item => {
          const m = item.match(/\((.*?)\)/);
          const name = m ? m[1] : item.split(" - ")[0];
          const q = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
          const qty = q ? parseInt(q[1]) : 1;
          return `<li>${esc(name)} : ${qty}</li>`;
        }).join("");

        const noteText = r.note
          ? `<div style="font-size:11px; margin-top:2px; font-style:italic; color:#444;">
               üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${esc(r.note)}
             </div>`
          : "";

        return `
          <div style="margin-bottom:14px;">
            <div style="font-weight:900; font-size:12px;color:#064e3b">
              üìÖ ${formatDate((r.date || '').slice(0,10))}
            </div>
            <ul style="padding-left:16px; margin:6px 0 0; font-size:11px;">${items}</ul>
            <div style="margin-top:6px; color:#0a645a; font-size:11px;font-weight:900">
              üíµ ${Math.round(recordAmount(r)).toLocaleString()} ‡∏ö‡∏≤‡∏ó
            </div>
            ${noteText}
            <hr style="margin:10px auto; border:0; border-top:1px dashed #ddd; width:70%;">
          </div>
        `;
      }).join("");

      let pitchSectionHtml = '';
      try {
        const opd = customer.opd && customer.opd !== '-' ? customer.opd : '';
        if (opd) {
          const res = await fetch(`/api/pitches?opd=${encodeURIComponent(opd)}`);
          if (res.ok) {
            const pitches = await res.json() || [];
            if (pitches.length) {
              pitches.sort((a,b)=> String(b.created_at||'').localeCompare(String(a.created_at||'')));
              pitchSectionHtml = pitches.map(p=>{
                const d = fmtDateTime(p.created_at).split(" ")[0];
                return `
                  <div style="padding:4px 0; font-size:11px; color:#374151;">
                    ${d} ‚Ä¢ ${esc(p.promotion || '-')} ‚Ä¢ <b>${esc(p.outcome || '-')}</b>
                  </div>`;
              }).join("");
            } else {
              pitchSectionHtml = `<div class="sub-muted" style="font-size:11px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sale Pitch</div>`;
            }
          } else {
            pitchSectionHtml = `<div class="sub-muted" style="font-size:11px;">‡πÇ‡∏´‡∏•‡∏î Sale Pitch ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`;
          }
        }
      } catch(e){
        pitchSectionHtml = `<div class="sub-muted" style="font-size:11px;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>`;
      }

      const daysAbsentText = `<span style="color:#ef4444;font-weight:900;">(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß: ${daysAbsent} ‡∏ß‡∏±‡∏ô)</span>`;

      document.getElementById("modal-content").innerHTML = `
        <h3 style="font-size:16px; margin:0 0 6px;color:#064e3b;font-weight:900;">üìá ${esc(customer.name)}</h3>
        <div style="font-size:12px;">üÜî OPD: <b>${esc(customer.opd)}</b></div>
        <div style="font-size:12px;">üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${esc(customer.phone)}</div>
        <div style="font-size:12px;">üìÖ ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${formatDate(lastDateStr)} ${daysAbsentText}</div>
        <div style="font-size:12px; color:#00796b;font-weight:900;margin-top:6px;">
          üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${Math.round(totalAmount).toLocaleString()} ‡∏ö‡∏≤‡∏ó
        </div>
        <div style="font-size:12px;">üîÅ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ${totalVisits} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${paidVisits} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô)</div>
        <div style="font-size:12px;">üí≥ ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ${average.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>

        <hr style="margin:14px 0; border:0; border-top:1px solid #e5e7eb;">

        <div style="font-weight:900; font-size:13px; margin-bottom:8px;color:#064e3b;">üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        <div style="font-size:11px;">${itemSummary || '-'}</div>

        <hr style="margin:14px 0; border:0; border-top:1px solid #e5e7eb;">

        <div style="font-weight:900; font-size:13px; margin-bottom:6px;color:#064e3b;">üó£Ô∏è Sale Pitch (‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô)</div>
        ${pitchSectionHtml}

        <hr style="margin:14px 0; border:0; border-top:1px solid #e5e7eb;">

        <div style="font-weight:900; font-size:13px; margin-bottom:8px;color:#064e3b;">üßæ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</div>
        ${historyHtml}
      `;

      document.getElementById("customer-modal").style.display = 'flex';
    }

    /* Range chip UI uses same data-range hooks */
    document.getElementById('openCustomRange')?.addEventListener('click', openRangeModal);

    /* Init */
    (async function init(){
      showLoading(true);
      try{
        await Promise.all([loadAllSales(), loadAllProfiles()]);
        // default active "all"
        document.querySelectorAll('.chip[data-range]').forEach(c=>c.classList.remove('active'));
        const allChip = document.querySelector('.chip[data-range="all"]');
        if(allChip) allChip.classList.add('active');
        setQuickRange('all');
        applyRange();
        toast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'ok');
      }catch(e){
        console.error(e);
        alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }finally{
        showLoading(false);
      }
    })();

    /* ==========================
       NOTE: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô global ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å HTML
       ========================== */
    window.openCustomerModal = openCustomerModal;
    window.closeCustomerModal = closeCustomerModal;
    window.openPitchModalForOPD = openPitchModalForOPD;
    window.closePitchModal = closePitchModal;
    window.openRangeModal = openRangeModal;
    window.closeRangeModal = closeRangeModal;
    window.applyRangeFromModal = applyRangeFromModal;
    window.applyRecency = applyRecency;
    window.applyABC = applyABC;
    window.applyRFM = applyRFM;
    window.applySpend = applySpend;
  </script>

  {% include "floating_menu.html" %}
</body>
</html>
