<!DOCTYPE html>
<html lang="th">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    
#customer-modal {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 9999;
  background-color: rgba(0, 0, 0, 0.4);
   align-items: center;
  justify-content: center;
}

#customer-modal .modal-box {
  background: white;
  padding: 24px;
  border-radius: 16px;
  max-width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 8px 30px rgba(0,0,0,0.2);
}

.modal-box {
  font-size: 13px; /* ‚úÖ ‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤ default ‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
  line-height: 1.6;
  font-family: 'Prompt', sans-serif;
}
.modal-box h3 {
  font-size: 16px;
  margin-bottom: 8px;
}
.modal-box strong {
  color: #444;
}
.modal-box ul {
  padding-left: 18px;
  margin-bottom: 8px;
}
    td.note-col,
td.keyword-col {
  font-size: 12px;        /* ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥ */
  color: #444;            /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏° ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
  line-height: 1.4em;     /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏û‡∏≠‡∏î‡∏µ */
}
    
    body {
  font-family: 'Prompt', 'Segoe UI', sans-serif;
      margin: 0;
      background-color: white;
      padding: 10px;
       padding-bottom: 120px;
    }
    .menu-bar {
      display: flex;
      justify-content: space-around;
      background-color: white;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      position: sticky;  /* ‚úÖ ‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
  top: 0;
  z-index: 1000;      /* ‚úÖ ‡∏ã‡πâ‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô */
    }
    .menu-bar a {
      text-decoration: none;
      font-weight: bold;
      color: teal;
    }
    .search-container {
   position: fixed;
  bottom: 120px; /* ‚úÖ ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏ô floating-dock */
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 600px;
  background: rgb(235, 255, 245); /* ‚úÖ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏õ‡∏£‡πà‡∏á */

  border-radius: 20px;
  padding: 12px 14px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  z-index: 999;
    }
    .search-container label {
      font-weight: bold;
      font-size: 14px;
      display: block;
      margin-bottom: 8px;
      text-align: center;
    }
    .search-container input {
      width: 100%;
  padding: 10px 16px 10px 40px;
  font-size: 12px;
  border: none;
  border-radius: 30px;
  background-color: rgb(255, 255, 255); /* ‚úÖ ‡πÇ‡∏õ‡∏£‡πà‡∏á‡∏ô‡∏¥‡∏î‡πÜ */
  background-image: url('https://cdn-icons-png.flaticon.com/512/622/622669.png');
  background-size: 18px;
  background-repeat: no-repeat;
  background-position: 12px center;
  box-sizing: border-box;
  color: #222;
  outline: none;
    }
    table {
      width: 95%;
      margin: 20px auto;
      border-collapse: collapse;
      background-color: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    th, td {
      border: 1px solid #eee;
      padding: 10px;
      text-align: left;
      font-size: 12px;
      vertical-align: top;
    }
    th {
      background-color: #e0f7fa;
      color: #00796b;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tr:hover {
      background-color: #e0f2f1;
    }
 
    .details ul {
      padding-left: 20px;
      margin: 0;
    }
    .show-btn {
      padding: 5px 10px;
      background-color: #0288d1;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }
    #export-btn {
      display: block;
      margin: 20px auto;
      background-color: #4caf50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 10px;
      font-weight: bold;
      cursor: pointer;
    }
    .phone-toggle {
  padding: 4px 8px;
  border-radius: 8px;
  background-color: #e3f2fd;
  font-weight: bold;
}
.details {
  display: flex;
  justify-content: flex-start;
  padding: 0;
  margin: 0;
  background: none;
  border: none;
}
.detail-bar {
  display: inline-block;
  padding: 1px 1px;
  margin: 0px 0 0 0;
  background-color: #e3f2fd;
  color: #0277bd;
  border-radius: 14px;
  font-size: 10px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s ease;
}
.detail-bar:hover {
  background-color: #bbdefb;
}
    .floating-dock {
  position: fixed;
  bottom: env(safe-area-inset-bottom, 16px); /* ‚úÖ ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡πÅ‡∏ñ‡∏ö‡∏î‡∏≥ */
  left: 50%;
  transform: translateX(-50%);
  background: white;
  border-radius: 16px;
  padding: 6px 6px env(safe-area-inset-bottom, 16px); /* ‚úÖ ‡πÄ‡∏ß‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ */
  display: flex;
  gap: 6px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  z-index: 1000;
  max-width: 95vw;
}

.icon-button {
  width: 64px;                 /* ‚úÖ ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏ô‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡πÑ‡∏î‡πâ */
  height: 64px;
  padding: 4px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s ease;
  text-decoration: none;
  flex: 0 0 auto;              /* ‚úÖ ‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏î ‡πÑ‡∏°‡πà‡∏´‡∏î */
}

.icon-button img {
  width: 60px;
  height: 60px;
  object-fit: contain;
}


.icon-button:hover {
  transform: scale(1.1);
}

@media (max-width: 768px) {
  .icon-button {
    width: 48px;
    height: 48px;
  }

  .icon-button img {
    width: 48px;
    height: 48px;
  }
}

@media (max-width: 1024px) {
  .floating-dock {
    position: fixed;
    bottom: 0;
    padding-bottom: env(safe-area-inset-bottom); /* ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö iPhone/iPad ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏ñ‡∏ö‡∏•‡πà‡∏≤‡∏á */
  }
}

  </style>
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
</head>
<body>
 
  <div class="search-container">
        <input type="text" id="searchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô...">
  </div>

  <table>
    <thead>
      <tr>
        <th onclick="sortTable(0)">‡∏•‡∏≥‡∏î‡∏±‡∏ö ‚¨ç</th>
        <th onclick="sortTable(1)">OPD ‚¨ç</th>
        <th onclick="sortTable(2)">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‚¨ç</th>
        <th onclick="sortTable(3)">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‚¨ç</th>
        <th onclick="sortTable(4)">‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‚¨ç</th>
        <th onclick="sortTable(5)">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó) ‚¨ç</th>
        <th onclick="sortTable(6)">‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å ‚¨ç</th>
        <th onclick="sortTable(7)">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ‚¨ç</th>
        <th onclick="sortTable(8)">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ã‡∏∑‡πâ‡∏≠ ‚¨ç</th>
        
      </tr>
    </thead>
    <tbody id="customer-table-body"></tbody>
  </table>

  <button id="export-btn">üßæ Export ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Excel</button>

  <script>
    let customers = [];
   fetch("/api/sales")
    .then(res => res.json())
    .then(records => {
      const customerMap = {};
      records.forEach(rec => {
        const key = `${rec.name}|${rec.phone}`;
        if (!customerMap[key]) {
          customerMap[key] = {
            name: rec.name,
            phone: rec.phone || '-',
            opd: rec.opd || '',
            total: 0,
            lastDate: rec.date,
              note: rec.note || '', // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            history: []
          };
        }
        customerMap[key].total += parseFloat(rec.amount) || 0;
        customerMap[key].history.push({
          date: rec.date,
          items: rec.items,
          amount: rec.amount,
          payment: rec.payment,
          note: rec.note
        });
        if (rec.date > customerMap[key].lastDate) {
          customerMap[key].note = rec.note || ''; // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å record ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
          customerMap[key].lastDate = rec.date;
        }
      });

      customers = Object.values(customerMap).sort((a, b) => parseInt(a.opd) - parseInt(b.opd));
      const tableBody = document.getElementById('customer-table-body');

      customers.forEach((c, i) => {
        const row = document.createElement('tr');
        const detailsId = `details-${i}`;
        const daysAbsent = calcDaysAbsent(c.lastDate);
        const keywords = extractKeywordsFromHistory(c.history); // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${c.opd}</td>
          <td>
  <span class="detail-bar" style="cursor:pointer;" onclick="openCustomerModal(${i})">${c.name}</span>
</td>
          <td>
  <span class="phone-toggle" style="color: #0288d1; cursor: pointer;" data-phone="${c.phone}" onclick="togglePhone(this)">üìû</span>
</td>

          <td>${formatDate(c.lastDate)}</td>
          <td>${c.total.toLocaleString()}</td>
          <td>${daysAbsent}</td>
           <td class="note-col">${c.note || '-'}</td>
          <td class="keyword-col">${keywords || '-'}</td>
          
        `;
        tableBody.appendChild(row);

       
      });

      // Enable export
      document.getElementById('export-btn').addEventListener('click', () => {
        const data = customers.map(c => ({
          ‡∏ä‡∏∑‡πà‡∏≠: c.name,
          OPD: c.opd,
          ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: c.phone,
          '‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠': formatDate(c.lastDate),
          '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)': c.total
        }));
        const sheet = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, sheet, '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
        XLSX.writeFile(wb, '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î.xlsx');
      });
    })
    .catch(err => {
      console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Supabase ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤");
    });

  function toggleDetails(id) {
  const container = document.getElementById(id);
  const content = container.querySelector(".detail-content");
  const isVisible = content.style.display === 'block';
  content.style.display = isVisible ? 'none' : 'block';
}

  function generateHistoryHTML(history, customerName) {
    const grouped = {};
    const itemSummary = {};
    const itemTotal = {};
    let grandTotal = 0;

    history.forEach(h => {
      if (!grouped[h.date]) grouped[h.date] = [];
      grouped[h.date].push(h);
      grandTotal += parseFloat(h.amount) || 0;

      (h.items || []).forEach(itemStr => {
        const match = itemStr.match(/^(.*?) ?(?:\((.*?)\))? - (\d+) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+)/);
        if (match) {
          const sub = match[2] || match[1];
          const qty = parseInt(match[3]);
          const price = parseInt(match[4]);
          itemSummary[sub] = (itemSummary[sub] || 0) + qty;
          itemTotal[sub] = (itemTotal[sub] || 0) + qty * price;
        }
      });
    });

    const dailyHTML = Object.entries(grouped).sort(([d1], [d2]) => new Date(d2) - new Date(d1)).map(([date, list]) => {
      const itemsHTML = list.map(h => `
        <ul>
          ${h.items.map(item => `<li>${item}</li>`).join('')}
          <li><strong>‡∏¢‡∏≠‡∏î:</strong> ${h.amount} ‡∏ö‡∏≤‡∏ó (${h.payment})</li>
          ${h.note ? `<li><em>üìù ${h.note}</em></li>` : ''}
        </ul>
      `).join('');
      return `<strong>üìÖ ${formatDate(date)}</strong>${itemsHTML}`;
    }).join('<hr>');

    const summaryHTML = Object.entries(itemSummary)
      .map(([sub]) => `‚Ä¢ ${sub} ‚Äî ${itemSummary[sub]} ‡∏ä‡∏¥‡πâ‡∏ô = ${itemTotal[sub].toLocaleString()} ‡∏ö‡∏≤‡∏ó`)
      .join('<br>');

    return `
      <div class="detail-capture">
        ${dailyHTML}
        <hr>
        <strong>üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong><br>
        ${summaryHTML}<br><br>
        <strong>üí∞ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${grandTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó
      </div>
      <br>
      <button onclick="downloadCustomerImage(this, '${customerName}')" class="show-btn">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ (JPEG)</button>
    `;
  }

  function formatDate(d) {
    if (!d) return '';
    const [y, m, day] = d.split('-');
    return `${day}/${m}/${y.slice(-2)}`;
  }

  function downloadCustomerImage(button, customerName) {
    const container = button.previousElementSibling;
    html2canvas(container).then(canvas => {
      const link = document.createElement("a");
      link.download = `${customerName}-details.jpeg`;
      link.href = canvas.toDataURL("image/jpeg");
      link.click();
    });
  }





  document.getElementById('searchInput').addEventListener('input', function () {
  const val = this.value.trim().toLowerCase();
  const rows = document.querySelectorAll('#customer-table-body tr');

  for (let i = 0; i < rows.length; i += 2) {
    const row = rows[i];
    const detailRow = rows[i + 1];

    const opd = (row.children[1]?.textContent || "").toLowerCase();
    const name = (row.children[2]?.textContent || "").toLowerCase();
    const phone = (row.children[3]?.textContent || "").toLowerCase();
    const note = (row.children[7]?.textContent || "").toLowerCase();
    const keywords = (row.children[8]?.textContent || "").toLowerCase();

    const matched = opd.includes(val) || name.includes(val) || phone.includes(val) || note.includes(val) || keywords.includes(val);

    if (matched) {
      row.style.display = '';
      detailRow.style.display = '';
      const detailDiv = detailRow.querySelector('.details');
          } else {
      row.style.display = 'none';
      detailRow.style.display = 'none';
    }
  }
});









  let sortState = {};
  function sortTable(colIndex) {
  const tbody = document.getElementById("customer-table-body");
  const rows = Array.from(tbody.rows).filter((_, i) => i % 2 === 0);
  const detailRows = Array.from(tbody.rows).filter((_, i) => i % 2 !== 0);

  const key = `col-${colIndex}`;
  sortState[key] = !sortState[key];
  const direction = sortState[key] ? 1 : -1;

  const sorted = rows.map((row, i) => {
    const cellText = row.cells[colIndex].textContent.trim();
    const isDateCol = (colIndex === 4);
    const numericText = cellText.replace(/,/g, '');
    const value = isDateCol
      ? parseThaiDate(cellText)
      : (isNaN(numericText) ? cellText.toLowerCase() : parseFloat(numericText));
    return { row, detailRow: detailRows[i], value };
  }).sort((a, b) => (a.value > b.value ? 1 : a.value < b.value ? -1 : 0) * direction);

  tbody.innerHTML = '';
  sorted.forEach(({ row, detailRow }) => {
    tbody.appendChild(row);
    tbody.appendChild(detailRow);
  });
}


  function calcDaysAbsent(lastDateStr) {
    const today = new Date();
    const lastDate = new Date(lastDateStr);
    const diffTime = today - lastDate;
    return Math.floor(diffTime / (1000 * 60 * 60 * 24));
  }

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° parseThaiDate ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    function parseThaiDate(dateStr) {
      const parts = dateStr.split('/');
      if (parts.length !== 3) return new Date(0);
      const [d, m, y] = parts;
      const fullYear = parseInt(y) < 50 ? 2000 + parseInt(y) : 1900 + parseInt(y);
      return new Date(fullYear, parseInt(m) - 1, parseInt(d));
    }
    function extractKeywordsFromHistory(history) {
  const keywordSet = new Set();
  const commonKeywords = [
    "Aestox", "Allergan", "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î", "‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß",
    "Neuramis", "E.P.T.Q", "Restylane",
    "Bromi", "Sisi", "HIFU", "HIFU ‡πÅ‡∏ñ‡∏°",
    "Meso Chanel", "P - Cell", "Aquatic", "Hestina", "Exosome", "Rejuran",
    "Belotero Revive", "Sculptra", "Juvelook", "Aesthefill", 
    "PRP", "Mesowink", "‡∏™‡∏∞‡∏Å‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "Alphaarbutin", "Transamine",
    "Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster",
    "‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "‡∏™‡∏¥‡∏ß", "‡∏ù‡πâ‡∏≤", "‡∏ú‡∏•‡∏±‡∏Å‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô", "‡∏õ‡∏±‡πà‡∏ô RF", "‡∏Å‡∏î‡∏™‡∏¥‡∏ß", "subcision‡∏™‡∏¥‡∏ß",
    "‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤", "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤", 
    "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÑ‡∏´‡∏° PDO", "‡πÑ‡∏´‡∏° Collagen", 
    "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô", "‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏™‡∏•‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå", "PRP‡∏ú‡∏°", "‡∏à‡∏µ‡πâ‡πÑ‡∏ù"
  ];

  history.forEach(h => {
    (h.items || []).forEach(itemStr => {
      commonKeywords.forEach(keyword => {
        if (itemStr.toLowerCase().includes(keyword.toLowerCase())) {
          keywordSet.add(keyword);
        }
      });
    });
  });

  return Array.from(keywordSet).join(', ');
}

function togglePhone(el) {
  if (el.dataset.showing === "true") {
    el.innerText = "üìû";
    el.dataset.showing = "false";
  } else {
    el.innerText = el.dataset.phone;
    el.dataset.showing = "true";
  }
}
window.openCustomerModal = function(index) {
  const customer = customers[index];
  const modal = document.getElementById("customer-modal");
  const content = document.getElementById("modal-content");
  const daysAbsent = calcDaysAbsent(customer.lastDate);
const visitCount = customer.history.length;
const avgAmount = visitCount > 0 ? Math.round(customer.total / visitCount) : 0;


content.innerHTML = `
   <h3 style="font-size:18px;margin-bottom:6px;">üìá ${customer.name}</h3>
  <div style="font-size:13px; line-height: 1.5;">
    <div><strong>OPD:</strong> ${customer.opd}</div>
    <div><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå:</strong> ${customer.phone}</div>
    <div><strong>‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${formatDate(customer.lastDate)} 
      <span style="color:gray;font-weight:normal;">(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß: ${daysAbsent} ‡∏ß‡∏±‡∏ô)</span>
    </div>
    <div><strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</strong> ${customer.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
    <div><strong>‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</strong> ${visitCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
    <div><strong>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á:</strong> ${avgAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
  </div>
  <hr style="margin:12px 0;">
  ${generateHistoryHTML(customer.history, customer.name)}
`;

  modal.style.display = "flex";
}

function closeCustomerModal() {
  document.getElementById("customer-modal").style.display = "none";
}
  </script>
  <div class="floating-dock">
  <a href="{{ url_for('dashboard') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_dashboard.png') }}">
  </a>
  <a href="{{ url_for('sale_summary') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_sale_summary.png') }}">
  </a>
  <a href="{{ url_for('record_sales') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_record_sales.png') }}">
  </a>
    <a href="{{ url_for('customer_list') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_customer_list.png') }}">
  </a>
  <a href="{{ url_for('record_customer') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_customer_history.png') }}">
  </a>
  <a href="{{ url_for('oldsaledata') }}" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_old_customers.png') }}">
  </a>
  <a href="#" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_staff.png') }}">
  </a>
  <a href="#" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_inventory.png') }}">
  </a>
  <a href="#" class="icon-button">
    <img src="{{ url_for('static', filename='icon/icon_appointments.png') }}">
  </a>
</div>
<div id="customer-modal">
  <div class="modal-box">
    <button onclick="closeCustomerModal()" style="position:absolute;top:10px;right:14px;font-size:20px;">√ó</button>
    <div id="modal-content"></div>
  </div>
</div>
</div>
</body>
</html>
