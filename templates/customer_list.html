<!DOCTYPE html>
<html lang="th">
<head>
   <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>{% block title %}App{% endblock %}</title>
  {% block head %}{% endblock %}

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>

  <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --teal:#0f766e; --teal-600:#0d9488;
      --bg:#f7faf9;   --card:#ffffff;
      --muted:#6b7280; --line:#e5e7eb;
      --chip:#eef7f6; --danger:#c62828; --amber:#92400e; --gold:#b8860b;
    }
    *{box-sizing:border-box}
    body{font-family:'Prompt','Segoe UI',sans-serif;margin:0;background:var(--bg);color:#0f172a;padding:10px 10px 120px}
    .container{max-width:1280px;margin:16px auto;background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(2,8,23,.06);padding:14px}

    .headline{font-size:18px;font-weight:800;color:#0b7660;margin:0 0 8px}
    .sub-muted{color:#6b7280;font-size:12px;margin-top:-2px}

    .section{margin:14px 0 18px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}

    label{display:block;font-size:12px;color:#334155;margin:2px 0 4px}
    .ipt{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;font-size:14px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 12px;border-radius:10px;border:1px solid #a7e1da;background:#fff;color:#0b7660;cursor:pointer;font-weight:700}
    .btn-primary{border-color:transparent;background:var(--teal-600);color:#fff}
    .btn-ghost{background:#f1f5f9;border-color:#e5e7eb;color:#0f172a}
    .btn-link{border:none;background:transparent;color:#0b7660;font-weight:700;cursor:pointer}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{padding:8px 12px;border:1px solid #a7e1da;border-radius:999px;background:#fff;color:#0b7660;font-size:12px;cursor:pointer}
    .chip.active{background:#0b7660;color:#fff}
    .icon-btn{border:1px solid #d1d5db;background:#fff;border-radius:8px;cursor:pointer;font-size:13px;padding:4px 8px}
    .icon-btn:hover{background:#f8fafc}

    .applied-banner{margin-top:6px;font-size:12px;color:#0b3d35;background:#ecfdf5;border:1px solid #a7f3d0;padding:6px 8px;border-radius:8px;display:none}

    table{width:100%;border-collapse:collapse;background:#fff;margin-top:8px}
    th,td{border:1px solid var(--line);padding:8px;font-size:13px;vertical-align:top}
    thead tr{background:#f8fafc}
    tbody tr:nth-child(even){background:#fcfcfc}
    a.link{color:#0d9488;text-decoration:none;font-weight:700;cursor:pointer}
    a.link:hover{text-decoration:underline}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;margin:2px;border:1px solid #e5e7eb}
    .tag-green{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .tag-amber{background:#fffbeb;color:#92400e;border-color:#fde68a}
    .tag-red{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    .tag-gray{background:#f3f4f6;color:#374151;border-color:#e5e7eb}

    .mini-kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin:6px 0 4px}
    .mini{border:1px solid var(--line);border-radius:10px;padding:8px 10px}
    .mini .k{font-size:12px;color:#64748b}
    .mini .v{font-size:18px;font-weight:800;margin-top:4px}
    .bar{height:8px;border-radius:6px;background:#eef2ff;overflow:hidden}
    .bar > i{display:block;height:100%;background:#0ea5e9}

    .filter-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .filter-block{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fcfffe}
    .filter-block .title{font-weight:800;color:#0b3d35;margin-bottom:8px}
    .filter-row{display:grid;grid-template-columns:repeat(12,1fr);gap:8px}
    .full{grid-column:1/-1}
    .span3{grid-column:span 3}.span4{grid-column:span 4}.span5{grid-column:span 5}.span6{grid-column:span 6}.span2{grid-column:span 2}.span8{grid-column:span 8}

    #customer-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:9999;align-items:center;justify-content:center}
    #customer-modal .box{background:#fff;border-radius:16px;max-width:92vw;max-height:90vh;overflow:auto;padding:18px;position:relative;box-shadow:0 8px 30px rgba(0,0,0,.2)}
    #customer-modal .close{position:absolute;right:10px;top:10px;width:36px;height:36px;border:none;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.15);cursor:pointer;background:#fff}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    .range-modal { position: fixed; inset: 0; z-index: 1200; display: none; }
    .range-modal__backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.45); }
    .range-modal__panel {
      position: absolute; left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      width: min(92vw, 420px);
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      overflow: hidden;
      display: flex; flex-direction: column;
    }
    .range-modal__header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 14px; background: #e0f2f1; font-weight: 600; color: #004d40;
    }
    .range-modal__close {
      background: transparent; border: none; font-size: 18px;
      cursor: pointer; color: #004d40;
    }
    .range-modal__body { display: grid; gap: 12px; padding: 14px; }
    .range-modal__body label { display: grid; gap: 6px; font-size: 13px; color: #335; }
    .range-modal__body input[type="date"]{
      -webkit-appearance: none; appearance: none;
      width: 100%; padding: 8px 10px; font-size: 14px;
      border: 1px solid #cfe7e5; border-radius: 10px; background: #fff;
    }
    .range-modal__footer {
      display: flex; justify-content: flex-end; gap: 8px; padding: 12px 14px;
      border-top: 1px solid #eee;
    }
    .btn-primary, .btn-secondary {
      border: none; padding: 8px 14px; border-radius: 10px; font-size: 13px; cursor: pointer;
    }
    .btn-primary { background: #009688; color: #fff; }
    .btn-primary:hover { background: #00796b; }
    .btn-secondary { background: #eceff1; color: #37474f; }
    .btn-secondary:hover { background: #e0e3e6; }

    /* ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå editor */
    .profile-editor{
      width:100%; min-height:36px; resize:vertical;
      border:1px solid #e5e7eb; border-radius:8px; padding:6px 8px; font-size:12px;
      background:#fff;
    }
    .profile-editor.saving{ opacity:.7; }
    .profile-editor.saved{ border-color:#22c55e; box-shadow:0 0 0 2px rgba(34,197,94,.15); }
    .profile-editor.error{ border-color:#ef4444; box-shadow:0 0 0 2px rgba(239,68,68,.15); }

    @media (max-width:1000px){
      .mini-kpi{grid-template-columns:repeat(3,1fr)}
      .filter-grid{grid-template-columns:repeat(6,1fr)}
      .span6{grid-column:span 6}.span5{grid-column:span 6}.span4{grid-column:span 6}.span3{grid-column:span 6}.span2{grid-column:span 3}.span8{grid-column:span 6}
      .grid-2{grid-template-columns:1fr}
    }
    @media (max-width:640px){
      .mini-kpi{grid-template-columns:repeat(2,1fr)}
      .filter-grid{grid-template-columns:repeat(2,1fr)}
      .span6,.span5,.span4,.span3,.span8{grid-column:1/-1}
      .span2{grid-column:span 1}
    }
    /* === Font size overrides (‡∏ß‡∏≤‡∏á‡∏ó‡πâ‡∏≤‡∏¢ <style> ‡πÄ‡∏î‡∏¥‡∏°) === */
body { font-size: 10px; }                /* ‡∏ê‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤: ‡∏•‡∏≠‡∏á 14‚Äì15px */
th, td { font-size: 10px; }              /* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç/‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
#finalCustTable th, 
#finalCustTable td { font-size: 10px; }  /* ‡πÄ‡∏ô‡πâ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏µ‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏Å‡∏±‡∏ô‡πÇ‡∏î‡∏ô‡∏ó‡∏±‡∏ö */

.profile-editor { font-size: 8px; }     /* ‡∏Å‡∏•‡πà‡∏≠‡∏á Profile ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô */
.sub-muted { font-size: 8px; }          /* ‡∏ï‡∏±‡∏ß‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏¢‡πà‡∏≠‡∏¢ (‡πÄ‡∏î‡∏¥‡∏° 12px) */
.chip { font-size: 10px; }               /* ‡∏ä‡∏¥‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á/‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå */
.ipt { font-size: 10px; }                /* ‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï‡∏ï‡πà‡∏≤‡∏á ‡πÜ */

/* ‡∏ñ‡πâ‡∏≤ Outcome ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 12 */
#finalCustTable th:nth-child(12),
#finalCustTable td:nth-child(12) {
  font-size: 8px;
  line-height: 1.25;
  color: #334155;
  white-space: normal;
}
  </style>
</head>
<body>
  <div class="container">    
    <!-- ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏£‡∏ß‡∏° (‡∏¢‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -->
    <div class="section card">
      <div class="headline">‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>
      <div class="filter-grid">
        <div class="filter-block span5">
          <div class="title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤</div>
          <div class="filter-row">
            <input type="date" id="startDate" class="ipt" style="display:none"/>
            <input type="date" id="endDate" class="ipt" style="display:none"/>
            <div class="full chips" style="margin-top:6px">
              <span class="chip" id="openCustomRange">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</span>
              <span class="chip" data-range="thisMonth">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
              <span class="chip" data-range="2m">2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
              <span class="chip" data-range="3m">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
              <span class="chip" data-range="6m">6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
              <span class="chip" data-range="thisYear">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</span>
              <span class="chip" data-range="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
            </div>
            <div class="full chips" style="margin-top:6px">
              <span class="chip" data-range="abs:0-30">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤ 0‚Äì30</span>
              <span class="chip" data-range="abs:31-60">31‚Äì60</span>
              <span class="chip" data-range="abs:61-90">61‚Äì90</span>
              <span class="chip" data-range="abs:90-180">90‚Äì180</span>
              <span class="chip" data-range="abs:181-365">181‚Äì365</span>
              <span class="chip" data-range="abs:365+">1 ‡∏õ‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ</span>
            </div>
            <div class="full">
              <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ä‡∏∑‡πà‡∏≠/OPD)</label>
              <input type="text" id="qSearch" class="ipt" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á"/>
            </div>
            <div class="full" style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
              <button class="btn btn-primary" id="btnApply">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
          </div>
        </div>

        <div class="filter-block span4">
          <div class="title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
          <div class="filter-row">
            <div class="span6">
              <label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ö‡∏≤‡∏ó)</label>
              <input type="number" id="minTotal" class="ipt" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
            </div>
            <div class="span6">
              <label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ö‡∏≤‡∏ó)</label>
              <input type="number" id="maxTotal" class="ipt" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
            </div>

            <div class="span6">
              <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label>
              <input type="number" id="minVisits" class="ipt" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
            </div>
            <div class="span6">
              <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</label>
              <input type="number" id="maxVisits" class="ipt" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
            </div>

            <div class="span6">
              <label>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ (‡∏ß‡∏±‡∏ô)</label>
              <input type="number" id="minAbsent" class="ipt" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
            </div>
            <div class="span6">
              <label>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô (‡∏ß‡∏±‡∏ô)</label>
              <input type="number" id="maxAbsent" class="ipt" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
            </div>

            <div class="span6">
              <label>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏• ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ö‡∏≤‡∏ó)</label>
              <input type="number" id="minAvg" class="ipt" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
            </div>
            <div class="span6">
              <label>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏• ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ö‡∏≤‡∏ó)</label>
              <input type="number" id="maxAvg" class="ipt" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
            </div>

            <div class="full">
              <label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
              <input type="text" id="customerName" class="ipt" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠ (‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)">
            </div>

            <div class="full" style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
              <button type="button" id="btnRunAdv" class="btn btn-primary">‡∏Å‡∏£‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</button>
              <button type="button" id="btnResetAdv" class="btn">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤</button>
            </div>
            <div id="filterResults" class="full sub-muted" style="margin-top:4px;"></div>
          </div>
        </div>

        <div class="filter-block span3">
          <div class="title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
          <div class="filter-row">
            <div class="full">
              <button class="btn" id="btnAddProduct" type="button">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            </div>
            <div id="productListContainer" class="full" style="display:flex;flex-direction:column;gap:6px"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 3) RFM & ABC -->
    <div class="section" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="card">
        <div class="headline">RFM Segments</div>
        <div class="sub-muted" style="margin-bottom:6px">
          RFM = Recency (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏î‡πÉ‡∏´‡∏°‡πà), Frequency (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà), Monetary (‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤)
        </div>
        <table id="rfmTable">
          <thead>
            <tr>
              <th>‡∏Å‡∏•‡∏∏‡πà‡∏° (‡πÑ‡∏ó‡∏¢)</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>%</th><th>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏•</th><th>Recency ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ß‡∏±‡∏ô)</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th><th style="width:64px"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <div class="headline">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (ABC / Pareto)</div>
        <div class="sub-muted" style="margin-bottom:6px">
          ‡πÅ‡∏ö‡πà‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: ‡∏ä‡∏±‡πâ‡∏ô A ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢ B ‡πÅ‡∏•‡∏∞ C
        </div>
        <table id="abcTable">
          <thead><tr><th>‡∏ä‡∏±‡πâ‡∏ô</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>% ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>% ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th><th style="width:64px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <div id="abcWho" class="sub-muted" style="margin-top:6px"></div>
      </div>
    </div>

    <!-- 4) ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏¢‡πà‡∏≠‡∏¢ 2 ‡πÉ‡∏ö -->
    <div class="section grid-2">
      <div class="card">
        <div class="headline">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤ (Recency Distribution)</div>
        <div class="sub-muted">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</div>
        <table id="recencyTable">
          <thead>
            <tr>
              <th>‡∏ä‡πà‡∏ß‡∏á (‡∏ß‡∏±‡∏ô)</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>%</th><th>AOV ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ö‡∏≤‡∏ó/‡∏ö‡∏¥‡∏•)</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th><th style="width:64px"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <div class="headline">Average Spend per Customer (Spend Bands)</div>
        <div class="sub-muted">‡πÅ‡∏à‡∏Å‡πÅ‡∏à‡∏á‡∏ï‡∏≤‡∏° AOV ‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô: 0‚Äì2,000 | 2,001‚Äì5,000 | 5,001‚Äì10,000 | 10,001‚Äì15,000 | 15,001‚Äì20,000 | ‚â•20,001</div>
        <table id="spendBandTable">
          <thead>
            <tr>
              <th>‡∏ä‡πà‡∏ß‡∏á AOV (‡∏ö‡∏≤‡∏ó/‡∏ö‡∏¥‡∏•)</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>%</th><th>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏Ñ‡∏ô (‡∏ö‡∏≤‡∏ó)</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th><th style="width:64px"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- 5) ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå -->
    <div class="section card">
      <div class="headline">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå</div>
      <div class="sub-muted">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á</div>
      <div id="appliedBanner" class="applied-banner"></div>
      <table id="finalCustTable">
        <thead>
          <tr>
            <th data-sort="num">#</th>
            <th data-sort="str">OPD</th>
            <th data-sort="str">‡∏ä‡∏∑‡πà‡∏≠</th>
            <th data-sort="num">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
            <th data-sort="num">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏•</th>
            <th data-sort="num">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
            <th data-sort="num">‡∏ö‡∏¥‡∏•‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</th>
            <th data-sort="num">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤ (‡∏ß‡∏±‡∏ô)</th>
            <th data-sort="str">RFM ‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
            <th data-sort="str">‡∏ä‡∏±‡πâ‡∏ô (ABC)</th>
            <th data-sort="num">Sale Pitch (‡∏ß‡∏±‡∏ô)</th>
            <th data-sort="str">Outcome (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</th>
            <!-- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà: Profile (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ) -->
            <th data-sort="str">Profile</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <!-- ‡πÇ‡∏°‡∏î‡∏±‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
  <div id="customer-modal">
    <div class="box" onclick="event.stopPropagation();">
      <button class="close" onclick="closeCustomerModal()">‚úñ</button>
      <div id="modal-content"></div>
    </div>
  </div>

  <!-- Modal: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á -->
  <div id="rangeModal" class="range-modal" style="display:none;">
    <div class="range-modal__backdrop" onclick="closeRangeModal()"></div>
    <div class="range-modal__panel">
      <div class="range-modal__header">
        <div>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
        <button class="range-modal__close" onclick="closeRangeModal()">‚úï</button>
      </div>
      <div class="range-modal__body">
        <label>‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <input type="date" id="rangeStartModal"></label>
        <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <input type="date" id="rangeEndModal"></label>
      </div>
      <div class="range-modal__footer">
        <button class="btn-secondary" onclick="closeRangeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn-primary" onclick="applyRangeFromModal()">‡∏ï‡∏Å‡∏•‡∏á</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ===== */
    const productCategories = {
      "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": ["Aestox 50 u", "Aestox 100 u", "Allergan 50 u", "Allergan 100 u", "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î", "‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß", "Nabota"],
      "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥", "Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á", "E.P.T.Q ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢", "Restylane ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢"],
      "Fat/Hifu": ["Bromi", "Sisi", "HIFU", "HIFU ‡πÅ‡∏ñ‡∏°"],
      "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": [
        "Meso Chanel", "P - Cell", "Aquatic", "Hestina", "Exosome", "Rejuran",
        "Belotero Revive", "Sculptra", "Juvelook", "Aesthefill",
        "PRP", "Mesowink", "‡∏™‡∏∞‡∏Å‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "Alphaarbutin", "Transamine", "Biocollagen"
      ],
      "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster"],
      "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": ["‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤", "‡∏ú‡∏•‡∏±‡∏Å‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô", "‡∏õ‡∏±‡πà‡∏ô RF", "‡∏Å‡∏î‡∏™‡∏¥‡∏ß", "subcision‡∏™‡∏¥‡∏ß"],
      "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": [
        "‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤", "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤",
        "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÑ‡∏´‡∏° PDO", "‡πÑ‡∏´‡∏° Collagen",
        "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô/‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏™‡∏•‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå", "PRP‡∏ú‡∏°", "‡∏à‡∏µ‡πâ‡πÑ‡∏ù"
      ],
      "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©": []
    };

    let allSales = [];
    let allCustomerRecords = [];
    let filtered = [];
    let endAnchorDate = null;
    let customersMap = new Map();
    let selectedKeys = null;
    let appliedNote = '';

    // ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å customers
    let profileByOpd = new Map();

    const pad4 = s => String(s||'').replace(/\D/g,'').padStart(4,'0');
    const esc = v => (v==null?'':String(v)).replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[m]));
    const onlyDigits = s => String(s||'').replace(/\D/g,'');
    const normPhone = s => { let d=onlyDigits(s); if(d.startsWith('66') && d.length>=11) d='0'+d.slice(-9); return d; };
    const ymd = d => (typeof d==='string'? d.slice(0,10): new Date(d).toISOString().slice(0,10));
    const formatDate = d => { if(!d) return ''; const [y,m,dd]=d.split('-'); return `${dd}/${m}/${y.slice(-2)}`; }
    const quantile = (arr,q) => { if(!arr.length) return 0; const a=[...arr].sort((x,y)=>x-y); const pos=(a.length-1)*q, b=Math.floor(pos), r=pos-b; return a[b] + (a[b+1]!==undefined? r*(a[b+1]-a[b]) : 0); };
    const varGold = () => '#b8860b';

    function parseItemNames(s){
      const m = String(s).match(/^(.*?) ?(?:\((.*?)\))? - /);
      if(!m) return {main:String(s).split(' - ')[0].trim(), sub:''};
      return {main:(m[1]||'').trim(), sub:(m[2]||'').trim()};
    }
    function keyForCustomer(rec){
      const opd = pad4(rec.opd||'');
      if(/^\d{4}$/.test(opd) && opd!=='0000') return 'OPD:'+opd;
      return 'NP:'+ (rec.name||'').trim().toLowerCase() + '|' + normPhone(rec.phone||'');
    }
    function keyNamePhone(v){ return `${v.name}|${v.phone||''}`; }
    function recordAmount(r){
      const a = parseFloat(r.amount);
      if(!isNaN(a)) return a;
      let sum=0; (r.items||[]).forEach(s=>{
        const m = String(s).match(/ - (\d+(?:\.\d+)?) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+(?:\.\d+)?) ‡∏ö‡∏≤‡∏ó$/);
        if(m){ sum += parseFloat(m[1])*parseFloat(m[2]); }
      });
      return sum;
    }

    /* ===== ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ===== */
    async function loadAllSales(){
      const r = await fetch('/api/sales');
      if(!r.ok) throw new Error('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      allSales = await r.json() || [];
      allSales.forEach(rec=>{
        if(rec.item && !rec.items){
          try{ rec.items = JSON.parse(rec.item); }catch(e){ rec.items=[]; }
        }
      });
      allCustomerRecords = allSales.slice();
    }
    async function loadAllProfiles(){
      try{
        const r = await fetch('/api/customers');
        const arr = await r.json();
        profileByOpd = new Map((arr||[]).map(c => [pad4(c.opd||''), c.profile || '']));
      }catch(e){
        profileByOpd = new Map();
      }
    }

    /* ===== ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ===== */
    function applyRange(){
      const s = document.getElementById('startDate').value || '2000-01-01';
      const e = document.getElementById('endDate').value || new Date().toISOString().slice(0,10);
      const sD = new Date(s), eD = new Date(e);
      endAnchorDate = eD;

      filtered = allSales.filter(r=>{
        const d = new Date((r.date||'').slice(0,10));
        return d>=sD && d<=eD;
      });

      customersMap = new Map();
      for(const r of filtered){
        const k = keyForCustomer(r);
        if(!customersMap.has(k)){
          customersMap.set(k, { key:k, name:r.name||'-', phone:r.phone||'', opd:pad4(r.opd||''), bills:[] });
        }
        customersMap.get(k).bills.push(r);
      }
      for(const v of customersMap.values()){
        v.bills.sort((a,b)=> a.date.localeCompare(b.date));
        v.first = v.bills[0]?.date?.slice(0,10) || '';
        v.last  = v.bills[v.bills.length-1]?.date?.slice(0,10) || '';
        v.revenue = v.bills.reduce((s,x)=> s + recordAmount(x), 0);
        v.aov = v.bills.length ? v.revenue / v.bills.length : 0;
        v.recency = v.last ? Math.floor((endAnchorDate - new Date(v.last))/(1000*60*60*24)) : 9999;
        v.maxBill = v.bills.reduce((m,x)=> Math.max(m, recordAmount(x)||0 ), 0);
      }

      if(appliedNote && typeof reconApplySpecial === 'function'){
        reconApplySpecial();
      }

      renderAll();
    }

    /* ===== ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå ===== */
    function addProductSelect(){
      const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.gap='6px'; wrap.style.alignItems='center';
      const selCat = document.createElement('select'); selCat.className='ipt'; selCat.style.width='180px';
      selCat.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>` + Object.keys(productCategories).map(c=>`<option value="${c}">${c}</option>`).join('');
      const selSub = document.createElement('select'); selSub.className='ipt'; selSub.style.width='240px';
      selSub.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</option>`;
      selCat.addEventListener('change', ()=>{
        const subs = productCategories[selCat.value] || [];
        selSub.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</option>` + subs.map(x=>`<option value="${x}">${x}</option>`).join('');
      });
      const btnX = document.createElement('button'); btnX.type='button'; btnX.className='btn btn-ghost'; btnX.textContent='‡∏•‡∏ö'; btnX.onclick=()=>wrap.remove();
      wrap.appendChild(selCat); wrap.appendChild(selSub); wrap.appendChild(btnX);
      document.getElementById('productListContainer').appendChild(wrap);
    }
    function getSelectedProductConditions(){
      return [...document.querySelectorAll('#productListContainer > div')].map(r=>{
        const sels = r.querySelectorAll('select'); return {cat:sels[0]?.value||'', sub:sels[1]?.value||''};
      }).filter(x=>x.cat);
    }
    function customerMatchesProducts(v){
      const conds = getSelectedProductConditions(); if(!conds.length) return true;
      for(const b of v.bills){
        for(const s of (b.items||[])){
          const {main, sub} = parseItemNames(s);
          for(const c of conds){ if(c.cat===main && (!c.sub || c.sub===sub)) return true; }
        }
      }
      return false;
    }
    function nameLike(v, q){ if(!q) return true; return (v.name||'').toLowerCase().includes(q.toLowerCase().trim()); }

    function filterGeneral(){
      const minT = parseFloat(document.getElementById('minTotal').value||''), maxT = parseFloat(document.getElementById('maxTotal').value||'');
      const minV = parseInt(document.getElementById('minVisits').value||''), maxV = parseInt(document.getElementById('maxVisits').value||'');
      const minA = parseInt(document.getElementById('minAbsent').value||''), maxA = parseInt(document.getElementById('maxAbsent').value||'');
      const minAvg = parseFloat(document.getElementById('minAvg').value||''), maxAvg = parseFloat(document.getElementById('maxAvg').value||'');
      const nameQ = document.getElementById('customerName').value||'';

      const keys=[];
      for(const [k,v] of customersMap){
        if(!customerMatchesProducts(v)) continue;
        if(!nameLike(v,nameQ)) continue;
        const visits=v.bills.length;
        if(!isNaN(minT) && v.revenue<minT) continue;
        if(!isNaN(maxT) && v.revenue>maxT) continue;
        if(!isNaN(minV) && visits<minV) continue;
        if(!isNaN(maxV) && visits>maxV) continue;
        if(!isNaN(minA) && v.recency<minA) continue;
        if(!isNaN(maxA) && v.recency>maxA) continue;
        if(!isNaN(minAvg) && v.aov<minAvg) continue;
        if(!isNaN(maxAvg) && v.aov>maxAvg) continue;
        keys.push(k);
      }
      selectedKeys = new Set(keys);
      appliedNote = '‚Äî ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á';
      reconApplySpecial = ()=>{ filterGeneral(); };
      updateAppliedBanner();
      document.getElementById('filterResults').textContent = `‡∏Ñ‡∏±‡∏î‡πÑ‡∏î‡πâ ${keys.length} ‡∏£‡∏≤‡∏¢ ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${customersMap.size} ‡∏£‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å`;
      renderAll();
      scrollToFinal();
    }
    function resetFilters(){
      document.getElementById('productListContainer').innerHTML='';
      ['minTotal','maxTotal','minVisits','maxVisits','minAbsent','maxAbsent','minAvg','maxAvg','customerName'].forEach(id=> document.getElementById(id).value='');
      selectedKeys=null; document.getElementById('filterResults').textContent='';
      appliedNote='';
      reconApplySpecial=null;
      updateAppliedBanner();
      renderAll();
    }

    function currentRecords(){ return selectedKeys? filtered.filter(r=> selectedKeys.has(keyForCustomer(r))) : filtered; }
    function currentCustomers(){
      if(!selectedKeys) return customersMap;
      const m=new Map(); for(const k of selectedKeys){ if(customersMap.has(k)) m.set(k, customersMap.get(k)); }
      return m;
    }

    /* ===== RFM ===== */
    let rfmByKey = new Map();
    function computeRFM(){
      rfmByKey.clear();
      const entries=[];
      for(const v of currentCustomers().values()){
        entries.push({v, R:v.recency, F:v.bills.length, M:v.revenue});
      }
      if(!entries.length) return {summary:[]};
      const cut = arr => [quantile(arr,.2),quantile(arr,.4),quantile(arr,.6),quantile(arr,.8)];
      const [r1,r2,r3,r4] = cut(entries.map(x=>x.R));
      const [f1,f2,f3,f4] = cut(entries.map(x=>x.F));
      const [m1,m2,m3,m4] = cut(entries.map(x=>x.M));
      const score=(v,b1,b2,b3,b4,rev=false)=>rev?(v<=b1?5:v<=b2?4:v<=b3?3:v<=b4?2:1):(v>b4?5:v>b3?4:v>b2?3:v>b1?2:1);
      const rename = seg => ({'Champions':'‡πÅ‡∏ä‡∏°‡∏õ‡πå (‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)','Loyal':'‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥','Potential':'‡∏°‡∏µ‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û','At Risk':'‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏´‡∏≤‡∏¢','Hibernating':'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û'})[seg] || seg;

      const segMap = {};
      for(const x of entries){
        const Rs=score(x.R,r1,r2,r3,r4,true), Fs=score(x.F,f1,f2,f3,f4,false), Ms=score(x.M,m1,m2,m3,m4,false);
        let k='Hibernating';
        if(Rs>=4 && Fs>=4 && Ms>=4) k='Champions';
        else if(Rs>=4 && (Fs>=3 || Ms>=3)) k='Loyal';
        else if(Rs>=3 && Fs>=3 && Ms>=2) k='Potential';
        else if(Rs<=2 && (Fs>=3 || Ms>=3)) k='At Risk';
        const th = rename(k);
        rfmByKey.set(x.v.key, th);
        if(!segMap[k]) segMap[k]={n:0,aov:[],rec:[], revSum:0};
        segMap[k].n++; segMap[k].aov.push(x.v.aov||0); segMap[k].rec.push(x.R); segMap[k].revSum += x.v.revenue||0;
      }
      const total=entries.length;
      const summary = Object.entries(segMap).map(([k,g])=>({
        seg:k, segTH:rename(k), n:g.n, pct:g.n*100/total,
        aov:(g.aov.reduce((a,b)=>a+b,0)/g.aov.length)||0,
        rec:(g.rec.reduce((a,b)=>a+b,0)/g.rec.length)||0,
        rev:g.revSum||0
      })).sort((a,b)=> b.n-a.n);
      return {summary};
    }
    function renderRFM(){
      const {summary} = computeRFM();
      const tbody = document.querySelector('#rfmTable tbody');
      tbody.innerHTML = summary.map(r=>`
        <tr>
          <td>${esc(r.segTH)}</td>
          <td>${r.n.toLocaleString()}</td>
          <td>${r.pct.toFixed(1)}%</td>
          <td>${Math.round(r.aov).toLocaleString()}</td>
          <td>${Math.round(r.rec)}</td>
          <td>${Math.round(r.rev).toLocaleString()}</td>
          <td style="text-align:center"><button class="icon-btn" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠" onclick="applyRFM('${esc(r.segTH)}')">üëÅ</button></td>
        </tr>
      `).join('') || `<tr><td colspan="7" class="sub-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    }

    /* ===== ABC ===== */
    let abcByKey = new Map();
    function computeABC(){
      abcByKey.clear();
      const list = [...currentCustomers().values()].map(v=>({key:v.key, v, rev:v.revenue})).sort((a,b)=> b.rev-a.rev);
      const total = list.reduce((s,x)=> s+x.rev, 0) || 1;
      let cum = 0;
      const tagged = list.map(x=>{ cum += x.rev; return {...x, cumPct: cum/total}; });
      const A = tagged.filter(x=> x.cumPct<=0.8);
      const B = tagged.filter(x=> x.cumPct>0.8 && x.cumPct<=0.95);
      const C = tagged.filter(x=> x.cumPct>0.95);
      A.forEach(x=> abcByKey.set(x.key,'A'));
      B.forEach(x=> abcByKey.set(x.key,'B'));
      C.forEach(x=> abcByKey.set(x.key,'C'));

      const pct = n => tagged.length? (n*100/tagged.length).toFixed(1)+'%':'-';
      const pctRev = v => total? (v*100/total).toFixed(1)+'%':'-';
      const revA = A.reduce((s,x)=>s+x.rev,0), revB=B.reduce((s,x)=>s+x.rev,0), revC=C.reduce((s,x)=>s+x.rev,0);

      document.querySelector('#abcTable tbody').innerHTML = `
        <tr><td>A</td><td>${A.length.toLocaleString()}</td><td>${pct(A.length)}</td><td>${pctRev(revA)}</td><td>${Math.round(revA).toLocaleString()}</td><td style="text-align:center"><button class="icon-btn" onclick="applyABC('A')">üëÅ</button></td></tr>
        <tr><td>B</td><td>${B.length.toLocaleString()}</td><td>${pct(B.length)}</td><td>${pctRev(revB)}</td><td>${Math.round(revB).toLocaleString()}</td><td style="text-align:center"><button class="icon-btn" onclick="applyABC('B')">üëÅ</button></td></tr>
        <tr><td>C</td><td>${C.length.toLocaleString()}</td><td>${pct(C.length)}</td><td>${pctRev(revC)}</td><td>${Math.round(revC).toLocaleString()}</td><td style="text-align:center"><button class="icon-btn" onclick="applyABC('C')">üëÅ</button></td></tr>
      `;

      const topA = A.slice(0,10).map(x=>{
        const v=x.v; const key=keyNamePhone(v);
        return `<a class="link" href="javascript:;" onclick="openCustomerModal('${esc(key)}');event.stopPropagation();">${esc(v.name)}</a>`;
      }).join(', ');
      document.getElementById('abcWho').innerHTML = topA ? `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡πâ‡∏ô A: ${topA}` : '‚Äî';
    }

    /* ===== Recency Distribution ===== */
    const recencyBuckets = [
      {label:'0‚Äì30', min:0, max:30},
      {label:'31‚Äì60', min:31, max:60},
      {label:'61‚Äì90', min:61, max:90},
      {label:'90‚Äì180', min:90, max:180},
      {label:'181‚Äì365', min:181, max:365},
      {label:'365 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ', min:365, max:Infinity}
    ];
    function renderRecencyDistribution(){
      const cust = [...currentCustomers().values()];
      const totalN = cust.length||1;
      const rows = recencyBuckets.map(b=>{
        const inBucket = cust.filter(v=> v.recency>=b.min && v.recency<=b.max);
        const n = inBucket.length;
        const pct = (n*100/totalN).toFixed(1);
        const avgAOV = n? Math.round(inBucket.reduce((s,x)=>s+(x.aov||0),0)/n) : 0;
        const sumRev = Math.round(inBucket.reduce((s,x)=>s+(x.revenue||0),0));
        return {b, n, pct, avgAOV, sumRev, inBucket};
      });

      const tb = document.querySelector('#recencyTable tbody');
      tb.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.b.label}</td>
          <td>${r.n.toLocaleString()}</td>
          <td>${r.pct}%</td>
          <td>${r.avgAOV.toLocaleString()}</td>
          <td>${r.sumRev.toLocaleString()}</td>
          <td style="text-align:center">
            <button class="icon-btn" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠" onclick='applyRecency(${JSON.stringify(r.b.min)},${JSON.stringify(r.b.max)},"${r.b.label}")'>üëÅ</button>
          </td>
        </tr>
      `).join('') || `<tr><td colspan="6" class="sub-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    }

    /* ===== Spend Bands (AOV) ===== */
    const spendBands = [
      {label:'0‚Äì2,000', min:0, max:2000},
      {label:'2,001‚Äì5,000', min:2001, max:5000},
      {label:'5,001‚Äì10,000', min:5001, max:10000},
      {label:'10,001‚Äì15,000', min:10001, max:15000},
      {label:'15,001‚Äì20,000', min:15001, max:20000},
      {label:'‚â• 20,001', min:20001, max:Infinity}
    ];
    function renderSpendBands(){
      const cust = [...currentCustomers().values()];
      const totalN = cust.length||1;
      const rows = spendBands.map(b=>{
        const inBand = cust.filter(v=> v.aov>=b.min && v.aov<=b.max);
        const n = inBand.length;
        const pct = (n*100/totalN).toFixed(1);
        const avgPerPerson = n? Math.round(inBand.reduce((s,x)=>s+(x.aov||0),0)/n) : 0;
        const sumRev = Math.round(inBand.reduce((s,x)=>s+(x.revenue||0),0));
        return {b,n,pct,avgPerPerson,sumRev};
      });
      const tb = document.querySelector('#spendBandTable tbody');
      tb.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.b.label}</td>
          <td>${r.n.toLocaleString()}</td>
          <td>${r.pct}%</td>
          <td>${r.avgPerPerson.toLocaleString()}</td>
          <td>${r.sumRev.toLocaleString()}</td>
          <td style="text-align:center"><button class="icon-btn" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠" onclick="applySpend(${r.b.min}, ${r.b.max}, '${r.b.label}')">üëÅ</button></td>
        </tr>
      `).join('') || `<tr><td colspan="6" class="sub-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    }

    /* ===== Pitch ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î + ‡πÅ‡∏ñ‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ===== */
    let finalRows = [];
    let finalSort = {col:6, dir:-1}; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà "‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°" ‡∏°‡∏≤‡∏Å -> ‡∏ô‡πâ‡∏≠‡∏¢
    const pitchCache = new Map();    // opd -> {created_at, content, outcome}

    function buildFinalRows(){
      const m=currentCustomers();
      finalRows = [...m.values()].map(v=>{
        const visits=v.bills.length, total=v.revenue, avg=visits? Math.round(total/visits):0;
        let recColor='#6b7280'; if(v.recency<30) recColor='green'; else if(v.recency<=90) recColor='orange'; else recColor='crimson';
        let totColor='#6b7280', totExtra='', totIcon='';
        if(total<50000) totColor='crimson';
        else if(total<=99999) totColor='green';
        else if(total<=200000) totColor='goldenrod';
        else { totColor='#8B6508'; totExtra='font-weight:bold;'; totIcon=' üíé'; }
        let avgColor='#6b7280'; if(avg<3000) avgColor='crimson'; else if(avg<=9999) avgColor='green'; else avgColor=varGold();

        const latest = pitchCache.get(v.opd);
        const days = latest ? daysSince(latest.created_at) : Number.POSITIVE_INFINITY;
        const outcomeStr = latest ? `${latest.content||'-'}${latest.outcome? ' ‚Äî '+latest.outcome : ''}` : '';

        return {
          v, visits, avg, total, maxBill:Math.round(v.maxBill||0),
          recency:v.recency, recColor, totColor, totExtra, totIcon, avgColor,
          rfm: rfmByKey.get(v.key) || '-', abc: abcByKey.get(v.key) || '-',
          lastPitchDays: isFinite(days)? days : null,
          lastOutcomeStr: outcomeStr,
          profile: profileByOpd.get(v.opd) || ''
        };
      });
    }

    function renderFinalTable(){
      const col = finalSort.col, dir = finalSort.dir;
      const val = (r,idx) => {
        switch(idx){
          case 1: return r.v.opd||'';
          case 2: return (r.v.name||'').toLowerCase();
          case 3: return r.visits||0;
          case 4: return r.avg||0;
          case 5: return r.total||0;
          case 6: return r.maxBill||0;
          case 7: return r.recency||0;
          case 8: return (r.rfm||'').toLowerCase();
          case 9: return (r.abc||'').toLowerCase();
          case 10: return (r.lastPitchDays!=null? r.lastPitchDays : Number.POSITIVE_INFINITY);
          case 11: return (r.lastOutcomeStr||'').toLowerCase();
          case 12: return (r.profile||'').toLowerCase();
          default: return 0;
        }
      };
      finalRows.sort((a,b)=>{
        const A=val(a,col), B=val(b,col);
        if(typeof A==='number' && typeof B==='number') return (A-B)*dir;
        return (A>B?1:A<B?-1:0)*dir;
      });

      const tb = document.querySelector('#finalCustTable tbody');
      tb.innerHTML = finalRows.map((r,i)=>{
        const key = keyNamePhone(r.v);
        const pitchText = (r.lastPitchDays==null) ? '‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢' : `${r.lastPitchDays} ‡∏ß‡∏±‡∏ô`;
        const pitchTitle = (()=> {
          const p = pitchCache.get(r.v.opd);
          if(!p) return '‚Äî';
          const d = String(p.created_at||'').slice(0,10);
          return `Pitch ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${formatDate(d)} ‚Ä¢ ${p.content||''}${p.outcome? ' ‚Äî '+p.outcome : ''}`;
        })();

        return `<tr data-opd="${esc(r.v.opd)}">
          <td>${i+1}</td>
          <td>${esc(r.v.opd)}</td>
          <td><a class="link" href="javascript:;" onclick="openCustomerModal('${esc(key)}');event.stopPropagation();">${esc(r.v.name)}</a></td>
          <td>${r.visits}</td>
          <td style="color:${r.avgColor}">${r.avg.toLocaleString()}</td>
          <td style="color:${r.totColor}; ${r.totExtra}">${Math.round(r.total).toLocaleString()}${r.totIcon}</td>
          <td>${r.maxBill.toLocaleString()}</td>
          <td style="color:${r.recColor}">${r.recency}</td>
          <td>${esc(r.rfm)}</td>
          <td>${esc(r.abc)}</td>
          <td class="lp-cell" title="${esc(pitchTitle)}">${esc(pitchText)}</td>
          <td class="lp-outcome">${esc(r.lastOutcomeStr || '‚Äî')}</td>
          <td>
            <textarea class="profile-editor" data-opd="${esc(r.v.opd)}" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‚Ä¶">${esc(r.profile || '')}</textarea>
          </td>
        </tr>`;
      }).join('') || `<tr><td colspan="13" class="sub-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>`;

      hydrateLatestPitchesForVisibleRows();
    }

    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á
    document.addEventListener('click', (e)=>{
      const th = e.target.closest('#finalCustTable thead th');
      if(!th) return;
      const idx = Array.from(th.parentNode.children).indexOf(th);
      if(idx===0) return;
      finalSort.dir = (finalSort.col===idx? -finalSort.dir : 1);
      finalSort.col = idx;
      renderFinalTable();
    });

    /* ===== Pitch ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ï‡πà‡∏≠ OPD) ===== */
    const today = () => new Date();
    const daysSince = (iso) => {
      if(!iso) return Number.POSITIVE_INFINITY;
      const d = new Date(iso);
      const t = today();
      return Math.floor((t - d)/(1000*60*60*24));
    };

    async function fetchLatestPitch(opd){
      try{
        const r = await fetch(`/api/pitches?opd=${encodeURIComponent(opd)}`);
        if(!r.ok) return null;
        const arr = await r.json();
        const row = Array.isArray(arr) && arr.length ? arr[0] : null; // ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        return row ? {created_at: row.created_at, content: row.content, outcome: row.outcome || ''} : null;
      }catch{ return null; }
    }

    async function hydrateLatestPitchesForVisibleRows(){
      const rows = Array.from(document.querySelectorAll('#finalCustTable tbody tr[data-opd]'));
      const opds = [...new Set(rows.map(tr => tr.getAttribute('data-opd')).filter(Boolean))];

      const targets = opds.filter(opd => !pitchCache.has(opd));
      for(const opd of targets){
        const latest = await fetchLatestPitch(opd);
        pitchCache.set(opd, latest || null);

        const rowObj = finalRows.find(r => r.v.opd === opd);
        if(rowObj){
          if(latest){
            rowObj.lastPitchDays = daysSince(latest.created_at);
            rowObj.lastOutcomeStr = `${latest.content||'-'}${latest.outcome? ' ‚Äî '+latest.outcome : ''}`;
          }else{
            rowObj.lastPitchDays = null;
            rowObj.lastOutcomeStr = '';
          }
        }

        const tr = document.querySelector(`#finalCustTable tbody tr[data-opd="${CSS.escape(opd)}"]`);
        if(tr){
          const cellDays = tr.querySelector('.lp-cell');
          const cellOutcome = tr.querySelector('.lp-outcome');
          if(latest){
            const dd = String(latest.created_at||'').slice(0,10);
            const title = `Pitch ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${formatDate(dd)} ‚Ä¢ ${latest.content||''}${latest.outcome? ' ‚Äî '+latest.outcome : ''}`;
            cellDays.textContent = `${daysSince(latest.created_at)} ‡∏ß‡∏±‡∏ô`;
            cellDays.title = title;
            cellOutcome.textContent = `${latest.content||'-'}${latest.outcome? ' ‚Äî '+latest.outcome : ''}`;
          }else{
            cellDays.textContent = '‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢';
            cellDays.title = '‚Äî';
            cellOutcome.textContent = '‚Äî';
          }
        }
      }
    }

    /* ===== ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Profile inline ===== */
    async function saveProfile(opd, value){
      try{
        const r = await fetch('/api/update_customer', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({opd:String(opd), field:'profile', value})
        });
        const d = await r.json();
        return !!d.message;
      }catch{ return false; }
    }
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠ blur (‡∏à‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢ capture ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ blur bubble)
    document.addEventListener('blur', async (e)=>{
      const ta = e.target && e.target.classList && e.target.classList.contains('profile-editor') ? e.target : null;
      if(!ta) return;
      const opd = ta.getAttribute('data-opd');
      const value = ta.value;
      ta.classList.remove('saved','error');
      ta.classList.add('saving');
      const ok = await saveProfile(opd, value);
      ta.classList.remove('saving');
      if(ok){
        ta.classList.add('saved');
        profileByOpd.set(opd, value);
        const rowObj = finalRows.find(r => r.v.opd === opd);
        if(rowObj) rowObj.profile = value;
        setTimeout(()=> ta.classList.remove('saved'), 1200);
      }else{
        ta.classList.add('error');
        setTimeout(()=> ta.classList.remove('error'), 1500);
      }
    }, true);

    /* ===== ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á) ===== */
    document.addEventListener('input', (e)=>{
      if(e.target && e.target.id==='qSearch'){
        const val = e.target.value.trim().toLowerCase();
        ['finalCustTable','rfmTable','abcTable','recencyTable','spendBandTable'].forEach(id=>{
          document.querySelectorAll(`#${id} tbody tr`).forEach(tr=>{
            const txt = tr.textContent.toLowerCase(); tr.style.display = txt.includes(val)? '' : 'none';
          });
        });
      }
    });

    /* ===== ‡πÇ‡∏°‡∏î‡∏±‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== */
    function openCustomerModal(key) {
      const records = allCustomerRecords.filter(r => `${r.name}|${r.phone||''}` === key);
      if(!records.length) return;

      const first = records[0];
      const customer = { name:first.name, phone:first.phone||'-', opd:first.opd||'-' };

      const latestRecord = records.reduce((latest,r)=> new Date(r.date) > new Date(latest.date)? r:latest, records[0]);

      const lastDate = new Date(latestRecord.date);
      const todayD = new Date();
      const daysAbsent = Math.floor((todayD - lastDate)/(1000*60*60*24));

      const totalVisits = records.length;
      const paidRecords = records.filter(r => parseFloat(r.amount||0) > 0);
      const paidVisits = paidRecords.length;
      const totalAmount = paidRecords.reduce((s,r)=>s+parseFloat(r.amount||0),0);
      const average = paidVisits>0 ? Math.round(totalAmount/paidVisits) : 0;

      const allItems = {};
      records.forEach(r => {
        (r.items||[]).forEach(item=>{
          let name = item;
          const m = item.match(/\((.*?)\)/); name = m? m[1] : item.split(" - ")[0];
          const q = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/); const qty = q? parseInt(q[1]) : 1;
          allItems[name] = (allItems[name]||0) + qty;
        });
      });

      const categoryMap = {
        "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": ["Aestox 50 u","Aestox 100 u","Allergan 50 u","Allergan 100 u","‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î","‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß","Nabota"],
        "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥","Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á","E.P.T.Q ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢","Restylane ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢"],
        "Fat/Hifu": ["Bromi","Sisi","HIFU","HIFU ‡πÅ‡∏ñ‡∏°"],
        "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": ["Meso Chanel","P - Cell","Aquatic","Hestina","Exosome","Rejuran","Belotero Revive","Sculptra","Juvelook","Aesthefill","PRP","Mesowink","‡∏™‡∏∞‡∏Å‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™","Alphaarbutin","Transamine","Biocollagen"],
        "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White","Super Aurawhite","Vitamin Mix","Brain Booster","Energy Booster"],
        "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": ["‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™","‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß","‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤","‡∏ú‡∏•‡∏±‡∏Å‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô","‡∏õ‡∏±‡πà‡∏ô RF","‡∏Å‡∏î‡∏™‡∏¥‡∏ß","subcision‡∏™‡∏¥‡∏ß"],
        "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": ["‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤","‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤","‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤","‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤","‡πÑ‡∏´‡∏° PDO","‡πÑ‡∏´‡∏° Collagen","‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô/‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤","‡∏™‡∏•‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå","PRP‡∏ú‡∏°","‡∏à‡∏µ‡πâ‡πÑ‡∏ù"],
        "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©": []
      };

      const categorizedItems = {};
      for (const [cat, names] of Object.entries(categoryMap)) {
        names.forEach(n => {
          if (allItems[n]) {
            (categorizedItems[cat] ||= []).push(`${n} : ${allItems[n]}`);
            delete allItems[n];
          }
        });
      }
      if (Object.keys(allItems).length) categorizedItems["‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] =
        Object.entries(allItems).map(([n,q])=>`${n} : ${q}`);

      const itemSummary = Object.entries(categorizedItems)
        .map(([cat,items])=>`<div style="margin-bottom:6px;"><strong>${cat}</strong>: ${items.join(" | ")}</div>`).join("");

      const historyHtml = records.sort((a,b)=>b.date.localeCompare(a.date)).map(r=>{
        const items = (r.items||[]).map(item=>{
          const m = item.match(/\((.*?)\)/);
          const name = m? m[1] : item.split(" - ")[0];
          const q = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/); const qty = q? parseInt(q[1]) : 1;
          return `<li>${esc(name)} : ${qty}</li>`;
        }).join("");
        const noteText = r.note ? `<div style="margin-top:2px; font-style:italic; color:#444;">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${esc(r.note)}</div>` : "";
        return `
          <div style="margin-bottom:16px;">
            <div style="margin-bottom:4px;font-weight:bold;">üìÖ ${formatDate((r.date||'').slice(0,10))}</div>
            <ul style="padding-left:16px;margin:0;">${items}</ul>
            <div style="margin-top:4px;color:#00796b;">üíµ ‡∏¢‡∏≠‡∏î: ${parseFloat(r.amount||0).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
            ${noteText}
            <hr style="margin: 10px auto; border: 0; border-top: 1px dashed #999; width: 60%;">
          </div>`;
      }).join("");

      const daysAbsentText = `<span style="color:red;">(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß: ${daysAbsent} ‡∏ß‡∏±‡∏ô)</span>`;

      document.getElementById("modal-content").innerHTML = `
        <h3 style="font-size:18px;margin-bottom:4px;">üìá ${esc(customer.name)}</h3>
        <div>üÜî <strong>OPD:</strong> ${esc(customer.opd)}</div>
        <div>üìû <strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå:</strong> ${esc(customer.phone)}</div>
        <div>üìÖ <strong>‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${formatDate((latestRecord.date||'').slice(0,10))} ${daysAbsentText}</div>
        <div style="color:#00796b;"><strong>üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</strong> ${Math.round(totalAmount).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
        <div>üîÅ ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£: ${totalVisits} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${paidVisits} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô)</div>
        <div>üí≥ <strong>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á:</strong> ${Math.round(average).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>

        <hr style="margin: 16px auto 8px; border: 0; border-top: 1px solid #ccc; width: 60%;">
        <div style="font-weight:bold;">üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</div>
        <div style="margin:6px 0 12px;">${itemSummary || '-'}</div>
        <hr style="margin: 16px auto 8px; border: 0; border-top: 1px solid #ccc; width: 60%;">
        <div style="font-weight:bold;margin-bottom:6px;">üõçÔ∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á:</div>
        ${historyHtml}
        <div style="margin-top:10px;font-weight:bold;color:${varGold()};">üí∞ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${Math.round(totalAmount).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>`;
      document.getElementById("customer-modal").style.display='flex';
    }
    function closeCustomerModal(){ document.getElementById('customer-modal').style.display='none'; }
    document.getElementById('customer-modal').addEventListener('click', (e)=>{
      const box = document.querySelector('#customer-modal .box');
      if(box && !box.contains(e.target)) closeCustomerModal();
    });

    /* ===== ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡πà‡∏≠‡∏¢ ===== */
    function setSelectedByPredicate(pred){
      const keys=[];
      for(const [k,v] of customersMap){ if(pred(v)) keys.push(k); }
      selectedKeys = new Set(keys);
      renderAll();
      scrollToFinal();
    }
    function scrollToFinal(){
      const el = document.getElementById('finalCustTable');
      if(el && el.scrollIntoView) el.scrollIntoView({behavior:'smooth', block:'start'});
    }
    function updateAppliedBanner(){
      const b = document.getElementById('appliedBanner');
      if(appliedNote){ b.textContent = appliedNote; b.style.display='block'; }
      else { b.textContent=''; b.style.display='none'; }
    }

    function applyRecency(min,max,label){
      appliedNote = `‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°: Recency ${label} ‡∏ß‡∏±‡∏ô`;
      updateAppliedBanner();
      selectedKeys = null;
      const pred = v => v.recency>=min && v.recency<=max;
      reconApplySpecial = ()=> setSelectedByPredicate(pred);
      setSelectedByPredicate(pred);
    }
    function applyABC(cls){
      appliedNote = `‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°: ABC ‡∏ä‡∏±‡πâ‡∏ô ${cls}`;
      updateAppliedBanner();
      selectedKeys = null;
      computeABC();
      const pred = v => (abcByKey.get(v.key) === cls);
      reconApplySpecial = ()=> { computeABC(); setSelectedByPredicate(pred); };
      setSelectedByPredicate(pred);
    }
    function applyRFM(segTH){
      appliedNote = `‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°: RFM: ${segTH}`;
      updateAppliedBanner();
      selectedKeys = null;
      computeRFM();
      const pred = v => (rfmByKey.get(v.key) === segTH);
      reconApplySpecial = ()=> { computeRFM(); setSelectedByPredicate(pred); };
      setSelectedByPredicate(pred);
    }
    function applySpend(min,max,label){
      appliedNote = `‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°: AOV ${label}`;
      updateAppliedBanner();
      selectedKeys = null;
      const pred = v => v.aov>=min && v.aov<=max;
      reconApplySpecial = ()=> setSelectedByPredicate(pred);
      setSelectedByPredicate(pred);
    }

    function renderAll(){
      renderRFM();
      computeABC();
      renderRecencyDistribution();
      renderSpendBands();
      buildFinalRows();
      renderFinalTable();
    }

    function setQuickRange(preset){
      const end = new Date();
      let start = new Date('2000-01-01');
      if(preset==='thisMonth'){ start = new Date(end.getFullYear(), end.getMonth(), 1);
      }else if(preset==='2m'){ start = new Date(end.getFullYear(), end.getMonth()-1, 1);
      }else if(preset==='3m'){ start = new Date(end.getFullYear(), end.getMonth()-2, 1);
      }else if(preset==='6m'){ start = new Date(end.getFullYear(), end.getMonth()-5, 1);
      }else if(preset==='thisYear'){ start = new Date(end.getFullYear(), 0, 1);
      }else if(preset==='all'){ start = new Date('2000-01-01'); }
      document.getElementById('startDate').value = ymd(start);
      document.getElementById('endDate').value   = ymd(end);
    }

    let reconApplySpecial = null;

    function applyAbsentChip(range){
      let min=0, max=Infinity, label=range;
      if(range.includes('+')){ 
        min=parseInt(range); max=Infinity; 
        label = (min===365? '1 ‡∏õ‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ' : `${min}+`); 
      } else { 
        const [a,b]=range.split('-'); 
        min=parseInt(a); max=parseInt(b); 
        label=`${a}‚Äì${b}`; 
      }

      appliedNote = `‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤ ${label} ‡∏ß‡∏±‡∏ô`;
      updateAppliedBanner();

      const pred = v => v.recency>=min && v.recency<=max;
      reconApplySpecial = ()=> {
        appliedNote = `‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤ ${label} ‡∏ß‡∏±‡∏ô`;
        updateAppliedBanner();
        setSelectedByPredicate(pred);
      };

      setQuickRange('all');
      applyRange();
      setSelectedByPredicate(pred);
    }

    function openRangeModal(){
      const s = document.getElementById('startDate').value;
      const e = document.getElementById('endDate').value;
      document.getElementById('rangeStartModal').value = s || '';
      document.getElementById('rangeEndModal').value = e || '';
      document.getElementById('rangeModal').style.display = 'block';
    }
    function closeRangeModal(){ document.getElementById('rangeModal').style.display = 'none'; }
    function applyRangeFromModal(){
      const s = document.getElementById('rangeStartModal').value;
      const e = document.getElementById('rangeEndModal').value;
      if(!s || !e){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'); return; }
      if(new Date(s) > new Date(e)){ alert('‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'); return; }
      document.getElementById('startDate').value = s;
      document.getElementById('endDate').value = e;
      closeRangeModal();
      appliedNote=''; reconApplySpecial=null; updateAppliedBanner();
      selectedKeys=null;
      applyRange();
    }

    document.getElementById('btnApply').addEventListener('click', applyRange);
    document.querySelectorAll('.chip[data-range]').forEach(chip=>{
      chip.addEventListener('click', ()=>{
        document.querySelectorAll('.chip[data-range]').forEach(c=>c.classList.remove('active'));
        chip.classList.add('active');
        const preset = chip.getAttribute('data-range');
        appliedNote=''; reconApplySpecial=null; updateAppliedBanner();
        selectedKeys=null;
        if(preset.startsWith('abs:')){
          applyAbsentChip(preset.replace('abs:',''));
        }else{
          setQuickRange(preset); applyRange();
        }
      });
    });
    document.getElementById('openCustomRange').addEventListener('click', openRangeModal);
    document.getElementById('btnAddProduct').addEventListener('click', addProductSelect);
    document.getElementById('btnRunAdv').addEventListener('click', filterGeneral);
    document.getElementById('btnResetAdv').addEventListener('click', resetFilters);

    // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏£‡∏Å
    (async function init(){
      try{
        await Promise.all([loadAllSales(), loadAllProfiles()]);
        document.querySelector('.chip[data-range="all"]').classList.add('active');
        setQuickRange('all');
        applyRange();
      }catch(e){
        console.error(e); alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
    })();
  </script>
  {% include "floating_menu.html" %}
</body>
</html>
