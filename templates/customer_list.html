<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f7f7f7;
      margin: 0;
      padding: 10px;
    }
    .menu-bar {
      display: flex;
      justify-content: space-around;
      background-color: white;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    .menu-bar a {
      text-decoration: none;
      font-weight: bold;
      color: teal;
    }
    .search-container {
      max-width: 95%;
      margin: 0 auto 20px auto;
      background-color: white;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }
    .search-container label {
      font-weight: bold;
      font-size: 18px;
      display: block;
      margin-bottom: 10px;
      text-align: center;
    }
    .search-container input {
      width: 100%;
      padding: 10px 40px 10px 40px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 30px;
      background-color: #f1f1f1;
      background-image: url('https://cdn-icons-png.flaticon.com/512/622/622669.png');
      background-size: 18px;
      background-repeat: no-repeat;
      background-position: 12px center;
      box-sizing: border-box;
    }
    table {
      width: 95%;
      margin: 20px auto;
      border-collapse: collapse;
      background-color: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    th, td {
      border: 1px solid #eee;
      padding: 10px;
      text-align: left;
      font-size: 14px;
      vertical-align: top;
    }
    th {
      background-color: #e0f7fa;
      color: #00796b;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tr:hover {
      background-color: #e0f2f1;
    }
    .details {
      display: none;
      background-color: #f1f1f1;
      padding: 10px 15px;
      border-radius: 8px;
      margin: 10px 0;
    }
    .details ul {
      padding-left: 20px;
      margin: 0;
    }
    .show-btn {
      padding: 5px 10px;
      background-color: #0288d1;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    #export-btn {
      display: block;
      margin: 20px auto;
      background-color: #4caf50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="menu-bar">
        <a href="{{ url_for('dashboard') }}">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
      <a href="{{ url_for('sale_summary') }}">1. ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</a>
      <a href="{{ url_for('record_sales') }}">2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</a>
      <a href="{{ url_for('record_customer') }}">3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</a>
      <a href="{{ url_for('customer_list') }}">4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
      <a href="{{ url_for('oldsaledata') }}">5. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤</a>
    </div>

  <div class="search-container">
    <label for="searchInput">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ä‡∏∑‡πà‡∏≠ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå / OPD</label>
    <input type="text" id="searchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô...">
  </div>

  <table>
    <thead>
      <tr>
        <th onclick="sortTable(0)">‡∏•‡∏≥‡∏î‡∏±‡∏ö ‚¨ç</th>
        <th onclick="sortTable(1)">‡πÄ‡∏•‡∏Ç OPD ‚¨ç</th>
        <th onclick="sortTable(2)">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‚¨ç</th>
        <th onclick="sortTable(3)">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‚¨ç</th>
        <th onclick="sortTable(4)">‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠ ‚¨ç</th>
        <th onclick="sortTable(5)">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó) ‚¨ç</th>
        <th onclick="sortTable(6)">‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å (‡∏ß‡∏±‡∏ô) ‚¨ç</th>
        <th onclick="sortTable(7)">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ‚¨ç</th>
        <th onclick="sortTable(8)">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ã‡∏∑‡πâ‡∏≠ ‚¨ç</th>
        <th>‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th>
      </tr>
    </thead>
    <tbody id="customer-table-body"></tbody>
  </table>

  <button id="export-btn">üßæ Export ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Excel</button>

  <script>
   fetch("/api/sales")
    .then(res => res.json())
    .then(records => {
      const customerMap = {};
      records.forEach(rec => {
        const key = `${rec.name}|${rec.phone}`;
        if (!customerMap[key]) {
          customerMap[key] = {
            name: rec.name,
            phone: rec.phone || '-',
            opd: rec.opd || '',
            total: 0,
            lastDate: rec.date,
              note: rec.note || '', // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            history: []
          };
        }
        customerMap[key].total += parseFloat(rec.amount) || 0;
        customerMap[key].history.push({
          date: rec.date,
          items: rec.items,
          amount: rec.amount,
          payment: rec.payment,
          note: rec.note
        });
        if (rec.date > customerMap[key].lastDate) {
          customerMap[key].note = rec.note || ''; // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å record ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
          customerMap[key].lastDate = rec.date;
        }
      });

      const customers = Object.values(customerMap).sort((a, b) => parseInt(a.opd) - parseInt(b.opd));
      const tableBody = document.getElementById('customer-table-body');

      customers.forEach((c, i) => {
        const row = document.createElement('tr');
        const detailsId = `details-${i}`;
        const daysAbsent = calcDaysAbsent(c.lastDate);
        const keywords = extractKeywordsFromHistory(c.history); // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${c.opd}</td>
          <td>${c.name}</td>
          <td>${c.phone}</td>
          <td>${formatDate(c.lastDate)}</td>
          <td>${c.total.toLocaleString()}</td>
          <td>${daysAbsent}</td>
           <td>${c.note || '-'}</td> <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
           <td>${keywords || '-'}</td>
          <td><button class="show-btn" onclick="toggleDetails('${detailsId}')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></td>
        `;
        tableBody.appendChild(row);

        const detailsRow = document.createElement('tr');
        const detailCell = document.createElement('td');
        detailCell.colSpan = 8;
        detailCell.innerHTML = `
          <div class="details" id="${detailsId}">
            ${generateHistoryHTML(c.history, c.name)}
          </div>
        `;
        detailsRow.appendChild(detailCell);
        tableBody.appendChild(detailsRow);
      });

      // Enable export
      document.getElementById('export-btn').addEventListener('click', () => {
        const data = customers.map(c => ({
          ‡∏ä‡∏∑‡πà‡∏≠: c.name,
          OPD: c.opd,
          ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: c.phone,
          '‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠': formatDate(c.lastDate),
          '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)': c.total
        }));
        const sheet = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, sheet, '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
        XLSX.writeFile(wb, '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î.xlsx');
      });
    })
    .catch(err => {
      console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Supabase ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤");
    });

  function toggleDetails(id) {
  const el = document.getElementById(id);
  if (el.style.display === 'block') {
    el.style.display = 'none';
  } else {
    el.style.display = 'block';
  }
}

  function generateHistoryHTML(history, customerName) {
    const grouped = {};
    const itemSummary = {};
    const itemTotal = {};
    let grandTotal = 0;

    history.forEach(h => {
      if (!grouped[h.date]) grouped[h.date] = [];
      grouped[h.date].push(h);
      grandTotal += parseFloat(h.amount) || 0;

      (h.items || []).forEach(itemStr => {
        const match = itemStr.match(/^(.*?) ?(?:\((.*?)\))? - (\d+) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+)/);
        if (match) {
          const sub = match[2] || match[1];
          const qty = parseInt(match[3]);
          const price = parseInt(match[4]);
          itemSummary[sub] = (itemSummary[sub] || 0) + qty;
          itemTotal[sub] = (itemTotal[sub] || 0) + qty * price;
        }
      });
    });

    const dailyHTML = Object.entries(grouped).sort(([d1], [d2]) => new Date(d2) - new Date(d1)).map(([date, list]) => {
      const itemsHTML = list.map(h => `
        <ul>
          ${h.items.map(item => `<li>${item}</li>`).join('')}
          <li><strong>‡∏¢‡∏≠‡∏î:</strong> ${h.amount} ‡∏ö‡∏≤‡∏ó (${h.payment})</li>
          ${h.note ? `<li><em>üìù ${h.note}</em></li>` : ''}
        </ul>
      `).join('');
      return `<strong>üìÖ ${formatDate(date)}</strong>${itemsHTML}`;
    }).join('<hr>');

    const summaryHTML = Object.entries(itemSummary)
      .map(([sub]) => `‚Ä¢ ${sub} ‚Äî ${itemSummary[sub]} ‡∏ä‡∏¥‡πâ‡∏ô = ${itemTotal[sub].toLocaleString()} ‡∏ö‡∏≤‡∏ó`)
      .join('<br>');

    return `
      <div class="detail-capture">
        ${dailyHTML}
        <hr>
        <strong>üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong><br>
        ${summaryHTML}<br><br>
        <strong>üí∞ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${grandTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó
      </div>
      <br>
      <button onclick="downloadCustomerImage(this, '${customerName}')" class="show-btn">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ (JPEG)</button>
    `;
  }

  function formatDate(d) {
    if (!d) return '';
    const [y, m, day] = d.split('-');
    return `${day}/${m}/${y.slice(-2)}`;
  }

  function downloadCustomerImage(button, customerName) {
    const container = button.previousElementSibling;
    html2canvas(container).then(canvas => {
      const link = document.createElement("a");
      link.download = `${customerName}-details.jpeg`;
      link.href = canvas.toDataURL("image/jpeg");
      link.click();
    });
  }





  document.getElementById('searchInput').addEventListener('input', function () {
  const val = this.value.trim().toLowerCase();
  const rows = document.querySelectorAll('#customer-table-body tr');

  for (let i = 0; i < rows.length; i += 2) {
    const row = rows[i];
    const detailRow = rows[i + 1];

    const opd = (row.children[1]?.textContent || "").toLowerCase();
    const name = (row.children[2]?.textContent || "").toLowerCase();
    const phone = (row.children[3]?.textContent || "").toLowerCase();
    const note = (row.children[7]?.textContent || "").toLowerCase();
    const keywords = (row.children[8]?.textContent || "").toLowerCase();

    const matched = opd.includes(val) || name.includes(val) || phone.includes(val) || note.includes(val) || keywords.includes(val);

    if (matched) {
      row.style.display = '';
      detailRow.style.display = '';
      const detailDiv = detailRow.querySelector('.details');
      if (detailDiv) detailDiv.style.display = 'none';
    } else {
      row.style.display = 'none';
      detailRow.style.display = 'none';
    }
  }
});









  let sortState = {};
  function sortTable(colIndex) {
  const tbody = document.getElementById("customer-table-body");
  const rows = Array.from(tbody.rows).filter((_, i) => i % 2 === 0);
  const detailRows = Array.from(tbody.rows).filter((_, i) => i % 2 !== 0);

  const key = `col-${colIndex}`;
  sortState[key] = !sortState[key];
  const direction = sortState[key] ? 1 : -1;

  const sorted = rows.map((row, i) => {
    const cellText = row.cells[colIndex].textContent.trim();
    const isDateCol = (colIndex === 4);
    const numericText = cellText.replace(/,/g, '');
    const value = isDateCol
      ? parseThaiDate(cellText)
      : (isNaN(numericText) ? cellText.toLowerCase() : parseFloat(numericText));
    return { row, detailRow: detailRows[i], value };
  }).sort((a, b) => (a.value > b.value ? 1 : a.value < b.value ? -1 : 0) * direction);

  tbody.innerHTML = '';
  sorted.forEach(({ row, detailRow }) => {
    tbody.appendChild(row);
    tbody.appendChild(detailRow);
  });
}


  function calcDaysAbsent(lastDateStr) {
    const today = new Date();
    const lastDate = new Date(lastDateStr);
    const diffTime = today - lastDate;
    return Math.floor(diffTime / (1000 * 60 * 60 * 24));
  }

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° parseThaiDate ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    function parseThaiDate(dateStr) {
      const parts = dateStr.split('/');
      if (parts.length !== 3) return new Date(0);
      const [d, m, y] = parts;
      const fullYear = parseInt(y) < 50 ? 2000 + parseInt(y) : 1900 + parseInt(y);
      return new Date(fullYear, parseInt(m) - 1, parseInt(d));
    }
    function extractKeywordsFromHistory(history) {
  const keywordSet = new Set();
  const commonKeywords = [
    "Aestox", "Allergan", "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î", "‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß",
    "Neuramis", "E.P.T.Q", "Restylane",
    "Bromi", "Sisi", "HIFU", "HIFU ‡πÅ‡∏ñ‡∏°",
    "Meso Chanel", "P - Cell", "Aquatic", "Hestina", "Exosome", "Rejuran",
    "Belotero Revive", "Sculptra", "Juvelook", "Aesthefill", 
    "PRP", "Mesowink", "‡∏™‡∏∞‡∏Å‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "Alphaarbutin", "Transamine",
    "Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster",
    "‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "‡∏™‡∏¥‡∏ß", "‡∏ù‡πâ‡∏≤", "‡∏ú‡∏•‡∏±‡∏Å‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô", "‡∏õ‡∏±‡πà‡∏ô RF", "‡∏Å‡∏î‡∏™‡∏¥‡∏ß", "subcision‡∏™‡∏¥‡∏ß",
    "‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤", "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤", 
    "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÑ‡∏´‡∏° PDO", "‡πÑ‡∏´‡∏° Collagen", 
    "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô", "‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏™‡∏•‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå", "PRP‡∏ú‡∏°", "‡∏à‡∏µ‡πâ‡πÑ‡∏ù"
  ];

  history.forEach(h => {
    (h.items || []).forEach(itemStr => {
      commonKeywords.forEach(keyword => {
        if (itemStr.toLowerCase().includes(keyword.toLowerCase())) {
          keywordSet.add(keyword);
        }
      });
    });
  });

  return Array.from(keywordSet).join(', ');
}

  </script>
</body>
</html>
