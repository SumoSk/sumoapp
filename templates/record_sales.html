<!DOCTYPE html>
<html lang="th">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta charset="UTF-8" />
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</title>

  <style>
    :root{
      --teal:#0f766e;
      --teal-600:#0d9488;
      --bg:#f7f7f7;
      --card:#ffffff;
      --muted:#6b7280;
      --line:#e5e7eb;
      --chip:#eef7f6;
      --danger:#c62828;
      --shadow: 0 20px 60px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background-color: var(--bg); padding: 10px 10px 140px; color:#111827 }
    h2 { text-align: center; color: var(--teal); font-size: 20px; margin: 10px 0 0 }
    .container { max-width: 880px; margin: 20px auto; background: var(--card); border-radius: 14px; padding: 22px; box-shadow: 0 6px 22px rgba(2,8,23,.06) }
    .section-title{display:flex;align-items:center;gap:8px;margin:8px 0 6px;font-weight:800;color:#0b7660}
    .section-sub{margin:0 0 10px;color:var(--muted);font-size:12px}

    .field-row{display:grid;grid-template-columns:180px 1fr;gap:12px;align-items:center;margin:8px 0}
    .field-row label{font-weight:700;font-size:14px;margin:0}
    input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; background:#fff; font-size:14px }
    input:focus, select:focus, textarea:focus{ outline: 2px solid #94d3ce; border-color: #94d3ce }
    .muted{ color: var(--muted); font-size:12px }
    .pill{background:var(--chip); border:1px solid #cfe9e6; color:#0b7660; padding:4px 8px; border-radius:999px; font-size:12px; display:inline-flex; align-items:center; gap:6px }
    .row{display:flex;gap:8px;align-items:center}
    .nowrap{flex-wrap:nowrap}
    .grow{flex:1; min-width:0}

    .btn { display:inline-flex; gap:8px; align-items:center; justify-content:center; padding: 10px 12px; border-radius: 10px; border:none; cursor:pointer; font-weight:700; font-size:14px }
    .btn-primary{ background: var(--teal-600); color:#fff }
    .btn-save{ background:#43a047; color:#fff; padding:12px 18px }
    .btn-ghost{ background:#f1f5f9 }
    .btn-danger{ background: var(--danger); color:#fff }
    .btn-outline{ background:#fff; color:#0b7660; border:1px solid #a7e1da }
    .btn:disabled{ opacity:.55; cursor:not-allowed }

    .item-row { display: grid; grid-template-columns: 1.2fr 1.2fr .7fr .6fr auto; gap: 10px; margin-top: 10px; align-items: center }
    .item-row.single{grid-template-columns: 1.2fr 1.2fr .7fr .6fr auto}
    .item-actions{display:flex;justify-content:flex-end}

    .edit-panel {background:#f9fbfb;border:1px solid #e0efef;border-radius:14px;padding:16px;margin-top:16px}
    .chips{ margin-top:8px }
    .chip{display:inline-block;padding:6px 10px;border-radius:20px;border:1px solid #cde;cursor:pointer;background:#fff;margin:4px 6px 0 0;font-size:13px}
    .chip.active{background:#0b7660;color:#fff;border-color:#0b7660}
    .card{border:1px solid var(--line);padding:12px;border-radius:12px;margin:8px 0;display:flex;justify-content:space-between;gap:12px}
    .card .left{min-width:0}
    #editRecordList .card{ font-size:14px; }
    #editRecordList .card .left strong{ font-size:14px; font-weight:700; }
    #editRecordList .items-list{ font-size:14px; margin:4px 0 0; padding-left:18px; }
    #editRecordList .items-list li{ margin:0; line-height:1.35; }
    #editRecordList .total-line{ margin-top:6px; font-weight:700; color:#0b7660; font-size:14px; }
    #editRecordList .actions .btn{ font-size:13px; padding:8px 12px; }

    table{ width:100%; border-collapse: collapse; margin-top:8px }
    th, td{ border:1px solid var(--line); padding:8px; font-size:13px; vertical-align:top }
    thead tr{ background:#f8fafc }
    .actions{ display:flex; gap:6px; justify-content:center }

    .toggle{
      position: relative; display: inline-grid; grid-template-columns: 1fr 1fr;
      align-items:center; width: 160px; height: 38px; border:1px solid #a7e1da;
      border-radius: 999px; background: transparent; overflow:hidden; user-select:none;
    }
    .toggle span{
      text-align:center; font-weight:700; font-size:14px; z-index:2;
      color:#0b7660; padding:0 4px;
    }
    .toggle .knob{
      position:absolute; top:2px; bottom:2px; width: calc(50% - 4px);
      background: rgba(13,148,136,.18); border:1px solid rgba(13,148,136,.35);
      border-radius: 999px; z-index:1; transition: transform .18s ease;
      transform: translateX(2px);
    }
    .toggle[data-side="right"] .knob{ transform: translateX(calc(100% + 2px)); }
    .toggle input{ display:none }
    .toggle[data-side="left"] span:first-child{ color:#064e3b; font-weight:800 }
    .toggle[data-side="right"] span:last-child{ color:#064e3b; font-weight:800 }

    .amount-row input{ flex:1; min-width:0 }
    .amount-row .toggle{ flex: none; }

    .center-actions{ display:flex; justify-content:center; gap:10px; margin-top:12px; flex-wrap:wrap }
    .center-actions .btn{ min-width:180px }

    .lock-badge{ cursor:pointer; }
    .lock-badge:focus{ outline:2px solid #94d3ce; }

    @media (max-width:700px){
      .field-row{grid-template-columns:130px 1fr}
      .item-row, .item-row.single{grid-template-columns:1fr}
      .item-actions{justify-content:flex-start}
      .toggle{ width: 150px; height: 36px }
    }

    .diag-panel{background:#f7fffb;border:1px solid #bfeee3;border-radius:14px;padding:16px;margin-top:20px}
    .diag-title{font-weight:800;color:#0b7660;margin:0 0 10px}
    .chip-btn{border:1px solid #a7e1da;background:#fff;color:#0b7660;border-radius:999px;padding:8px 12px;font-size:12px;font-weight:700;cursor:pointer}
    .chip-btn:hover{background:#eaf9f6}
    #diag-count{margin-left:8px;color:#0b7660;font-size:12px}
    #diag-results{width:100%;border-collapse:collapse;margin-top:10px}
    #diag-results th,#diag-results td{border:1px solid var(--line);padding:8px;font-size:12px}
    #diag-results thead tr{background:#f0fdfa}

    /* =========================
       TAB BAR
       ========================= */
    .tab-bar{
      display:flex;
      gap:8px;
      margin: 12px 0 8px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .tab-btn{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid #a7e1da;
      background:#fff;
      font-weight:900;
      cursor:pointer;
      color:#0b7660;
      font-size:13px;
      -webkit-tap-highlight-color: transparent;
    }
    .tab-btn.active{
      background: var(--teal-600);
      color:#fff;
      border-color: var(--teal-600);
    }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    /* =========================
       POPUP: ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Ñ‡∏™ + QR)
       ========================= */
    .paycase-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2400;
      padding:14px;
    }
    .paycase-box{
      width: 860px;
      max-width: 100%;
      max-height: 92vh;
      overflow:auto;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .paycase-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding-bottom:12px;
      border-bottom:1px solid var(--line);
    }
    .paycase-title{
      margin:0;
      font-weight:1000;
      font-size:18px;
      color:#0b7660;
      letter-spacing:.2px;
    }
    .paycase-sub{
      margin:6px 0 0;
      color: var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .paycase-close{
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .paycase-grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:12px;
      margin-top:14px;
      align-items:start;
    }
    @media (max-width:900px){
      .paycase-grid{ grid-template-columns: 1fr; }
    }
    .paycase-card{
      border:1px solid var(--line);
      border-radius:16px;
      background: linear-gradient(180deg, #ffffff 0%, #fbfbfb 100%);
      padding:14px;
    }
    .paycase-card h4{
      margin:0 0 10px;
      font-size:14px;
      font-weight:1000;
      color:#0b7660;
      display:flex;
      align-items:center;
      gap:8px;
    }
    /* ‡∏ó‡∏≥‡∏´‡∏±‡∏ß‡∏ö‡∏¥‡∏•‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô */
.bill-field{
  border:1px solid var(--line);
  border-radius:12px;
  padding:8px 10px;          /* ‡πÄ‡∏î‡∏¥‡∏° 10px 12px */
  background:#fff;
}
.bill-field .k{
  font-size:10px;            /* ‡πÄ‡∏î‡∏¥‡∏° 11px */
  color:var(--muted);
  font-weight:900;
}
.bill-field .v{
  margin-top:4px;            /* ‡πÄ‡∏î‡∏¥‡∏° 6px */
  font-size:13px;            /* ‡πÄ‡∏î‡∏¥‡∏° 14px */
  font-weight:900;
  color:#111827;
}

/* ‡∏•‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 2 ‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
.bill-head{
  display:grid;
  grid-template-columns: 1fr 1fr; /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 2 ‡∏ä‡πà‡∏≠‡∏á */
  gap:8px;                        /* ‡πÄ‡∏î‡∏¥‡∏° 10px */
}


    .warn{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #fecaca;
      background:#fff7f7;
      color:#991b1b;
      font-size:12px;
      font-weight:800;
      display:none;
    }

    .paycase-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
      background:#fff;
    }
    .paycase-table th, .paycase-table td{
      border:1px solid var(--line);
      padding:8px;
      vertical-align:top;
    }
    .paycase-table th{
      background:#f8fafc;
      text-align:center;
      font-weight:1000;
    }

    .sumline{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid var(--line);
      font-weight:1000;
    }
    .sumline .label{ color:#111827; }
    .sumline .value{ color:#0b7660; font-size:16px; }

    .qr-wrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      margin-top:12px;
    }
    .qr-img{
      width: 320px;
      max-width: 90%;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
      padding:10px;
    }
    .qr-hint{
      text-align:center;
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }
    .paycase-actions{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:14px;
      padding-top:12px;
      border-top:1px solid var(--line);
    }

    /* =========================
       POPUP: ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏ä‡∏±‡πâ‡∏ô 1 ‡πÄ‡∏î‡∏¥‡∏°)
       ========================= */
    .modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2500;
      padding:14px;
    }
    .modal-box{
      background:#fff;
      width:760px;
      max-width:100%;
      max-height:92vh;
      overflow:auto;
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      padding:18px;
    }
    .modal-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      padding-bottom:10px; border-bottom:1px solid var(--line);
    }
    .modal-title{font-weight:900;color:#0b7660;font-size:18px;margin:0}
    .modal-sub{margin:4px 0 0;color:var(--muted);font-size:12px}
    .modal-close{
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
    }
    .mini-grid{
      display:grid; gap:10px; margin-top:12px;
      grid-template-columns:1fr 1fr;
    }
    .mini-grid .field{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:#fbfbfb;
    }
    .mini-grid .field b{display:block;margin-bottom:4px;color:#0b7660}
    .mini-grid .field .v{font-size:14px}
    .mini-grid .field input{
      margin-top:6px;
      background:#fff;
    }
    @media (max-width:700px){
      .mini-grid{grid-template-columns:1fr}
    }
    .modal-actions{
      display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
      margin-top:14px;
    }

    /* =========================
       POPUP: ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏ä‡∏±‡πâ‡∏ô 2)
       ========================= */
    .receipt-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:3000;
      padding:14px;
    }
    .receipt-box{
      background:#fff;
      width:820px;
      max-width:100%;
      max-height:92vh;
      overflow:auto;
      border-radius:16px;
      padding:22px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      font-size:8px;
    }
    .receipt-header{
      text-align:center;
      margin-bottom:12px;
    }
    .receipt-header h2{
      margin:0;
      font-size:20px;
      font-weight:900;
      color:#111827;
    }
    .receipt-subtitle{
      margin-top:4px;
      font-weight:800;
      color:#111827;
      font-size:13px;
    }
    .receipt-clinic{
      margin-top:6px;
      font-weight:900;
      color:#0b7660;
      font-size:14px;
    }
    .receipt-small{
      font-size:11px;
      color:#374151;
      line-height:1.45;
      margin-top:6px;
    }
    .receipt-section{ margin-top:8px; }
    .receipt-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:8px;
    }
    .receipt-table th,
    .receipt-table td{
      border:1px solid #d1d5db;
      padding:6px 8px;
      vertical-align:top;
    }
    .receipt-table th{
      background:#f3f4f6;
      text-align:center;
    }
    .receipt-total{
      text-align:right;
      margin-top:10px;
      font-weight:900;
      font-size:15px;
    }
    .fineprint{
      margin-top:14px;
      font-size:10px;
      line-height:1.5;
      color:#111827;
    }

   @media print{
  body{ padding:0 !important; background:#fff !important; }

  /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô */
  body *{ visibility:hidden !important; }

  /* ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à */
  #receiptOverlay, #receiptOverlay *{ visibility:visible !important; }

  /* ‡∏ó‡∏≥ overlay ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©" ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà popup */
  #receiptOverlay{
    position: static !important;
    inset: auto !important;
    background:#fff !important;
    display:block !important;
    padding:0 !important;
  }

  /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô */
  .receipt-box{
    width: 190mm !important;
    max-height: none !important;
    overflow: visible !important;
    box-shadow:none !important;
    border-radius:0 !important;
    margin: 0 auto !important;
    padding: 12mm !important;      /* ‡∏Ç‡∏≠‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
  }

  /* ‡πÑ‡∏°‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏∏‡πà‡∏° */
  .receipt-actions, .sig-actions{ display:none !important; }

  /* ‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á/‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ */
  table, tr, td, th{ page-break-inside: avoid !important; }
  .sig-wrap, .fineprint{ page-break-inside: avoid !important; }
}



    /* ====== Signature Pad ====== */
    .sig-wrap{
      margin-top: 18px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      background:#fafafa;
    }
    .sig-grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:14px;
    }
    .sig-card{
      background:#fff;
      padding:12px;
      box-shadow:0 8px 18px rgba(2,8,23,.05);
    }
    .sig-label{
      font-size:4x;
      color:#0b7660;
      font-weight:600;
      margin-bottom:6px;
    }
    .sig-pad{
  width:100%;
  height:60px; /* ‚úÖ ‡πÄ‡∏î‡∏¥‡∏° 140px -> ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á */
  border-radius:10px;
  background:#fff;
  touch-action:none;
}
    .sig-actions{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:8px;
      margin-top:8px;
    }
    .sig-btn{
  border:1px solid #d1d5db;
  background:#fff;

  border-radius:6px;     /* ‚¨ÖÔ∏è ‡∏°‡∏∏‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
  padding:2px 6px;       /* ‚¨ÖÔ∏è ‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏•‡∏á‡∏°‡∏≤‡∏Å */
  font-size:4px;        /* ‚¨ÖÔ∏è ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
  font-weight:700;

  line-height:1.2;
  cursor:pointer;
}
    .sig-btn:hover{ background:#f3f4f6; }

    .sig-under{
      margin-top:8px;
      font-size:12px;
      font-weight:800;
      color:#111827;
      border-top:1px solid #d1d5db;
      padding-top:6px;
      min-height:18px;
      text-align:center;
    }

    @media (max-width:700px){
      .sig-grid{ grid-template-columns: 1fr; }
    }
    @media print{
      .sig-wrap{ border:none !important; background:#fff !important; padding:0 !important; }
      .sig-card{ box-shadow:none !important; border:1px solid #111 !important; }
      .sig-under{ border-top:1px solid #111 !important; }
    }

    /* ===== ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≠‡∏ô capture ‡∏£‡∏π‡∏õ ===== */
.capture-mode .receipt-actions,
.capture-mode .sig-actions,
.capture-mode button {
  display: none !important;
}

/* ‚úÖ ‡∏ï‡∏≠‡∏ô capture ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à "‡∏¢‡∏∑‡∏î‡πÄ‡∏ï‡πá‡∏°" ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô */
.capture-mode .receipt-box{
  max-height: none !important;
  overflow: visible !important;
}
.capture-mode #receiptOverlay{
  overflow: visible !important;
}

/* ‚úÖ ‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à */
#receiptOverlay .receipt-table th{
  font-size:10px !important;
}
#receiptOverlay .receipt-table td{
  font-size:10px !important;  /* ‡∏õ‡∏£‡∏±‡∏ö 9-11 ‡πÑ‡∏î‡πâ */
  padding:4px 6px !important; /* ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏•‡∏á */
}

/* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö 4 ‡πÑ‡∏°‡πà‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
#tab-settings .edit-panel{
  max-width: 760px;
  margin: 0 auto;
}

/* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á label ‡πÉ‡∏ô field-row ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏ö 4 ‡πÉ‡∏´‡πâ‡∏ô‡∏∏‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
#tab-settings .field-row{
  grid-template-columns: 120px 1fr;
}

/* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
@media (max-width:700px){
  #tab-settings .field-row{
    grid-template-columns: 1fr;
  }
}

#tab-settings .btn-danger{
  width: auto;
  min-width: 260px;
}

@media print{
  #receipt_patient_info{
    border: 1px solid #111 !important;
    border-radius: 0 !important;
    resize: none !important;
  }
}



/* ===== Receipt: patient info textarea (no box, seamless) ===== */
#receiptOverlay #receipt_patient_info{
  border: none !important;          /* ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏≠‡∏ö */
  border-radius: 0 !important;
  outline: none !important;
  background: transparent !important; /* ‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô */
  box-shadow: none !important;

  padding: 0 !important;            /* ‡πÑ‡∏°‡πà‡∏î‡∏±‡∏ô‡∏Ç‡∏≠‡∏ö */
  margin-top: 4px;

  font-size: 8px !important;        /* ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏•‡∏á */
  line-height: 1.3 !important;
  resize: none !important;

  height: auto !important;
  min-height: 32px;
}

/* ‡∏Å‡∏±‡∏ô focus ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏£‡∏≠‡∏ö */
#receiptOverlay #receipt_patient_info:focus{
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
}

/* ‡πÄ‡∏ß‡∏•‡∏≤ print ‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥ */
@media print{
  #receiptOverlay #receipt_patient_info{
    border: none !important;
    background: transparent !important;
  }
}




/* ===== Signature name input (no border, printable) ===== */
.sig-under-input{
  width: 100%;
  border: none !important;
  outline: none !important;
  background: transparent !important;
  box-shadow: none !important;

  text-align: center;
  font-size: 8px;
  font-weight: 700;
  color: #111;

  padding: 2px 0;
}

/* ‡∏Å‡∏±‡∏ô focus ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö */
.sig-under-input:focus{
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
}

/* print: ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ */
@media print{
  .sig-under-input{
    border: none !important;
    background: transparent !important;
  }
}

  </style>
</head>

<body>
   <!-- ‚úÖ floating menu -->
{% include 'floating_menu.html' %}
  <div class="container">
    <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>

    <!-- =========================
         TAB BAR
         ========================= -->
    <div class="tab-bar" role="tablist" aria-label="‡πÅ‡∏ñ‡∏ö‡∏á‡∏≤‡∏ô">
      <button type="button" class="tab-btn active" role="tab" aria-selected="true"
              onclick="switchTab('tab-sale', this)">1) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
      <button type="button" class="tab-btn" role="tab" aria-selected="false"
              onclick="switchTab('tab-opd', this)">2) ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö OPD</button>
      <button type="button" class="tab-btn" role="tab" aria-selected="false"
              onclick="switchTab('tab-ar', this)">3) ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</button>
      <button type="button" class="tab-btn" role="tab" aria-selected="false"
        onclick="switchTab('tab-settings', this)">4) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
    </div>

    <!-- =========================
         TAB 1: DAILY SALES
         ========================= -->
    <div id="tab-sale" class="tab-content active" role="tabpanel" aria-label="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô">
      <form id="saleForm" onsubmit="return false;">
        <input type="hidden" id="currentId" value="">

        <div class="section-title">üßæ ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>

        <div class="field-row">
          <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input type="date" id="date" name="date">
        </div>

        <div class="field-row">
          <label for="opd">‡πÄ‡∏•‡∏Ç OPD</label>
          <div class="row nowrap">
            <input
              type="text" id="opd" name="opd" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç OPD 4 ‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô 0001"
              inputmode="numeric" maxlength="4" pattern="\d{4}"
              oninput="onOPDInput(this);" class="grow">
            <span class="pill">‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å</span>
          </div>
        </div>

        <div class="field-row">
          <label for="name">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô-‡∏à‡∏£‡∏¥‡∏á</label>
          <div class="row nowrap">
            <input type="text" id="name" name="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ö‡∏ß‡πå - ‡πÄ‡∏°‡∏•‡∏î‡∏≤" disabled class="grow">
            <span id="lockNameBadge" class="pill lock-badge" style="display:none;"
                  role="button" tabindex="0" aria-label="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå"
                  onclick="unlockNamePhone()">üîí ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å</span>
          </div>
        </div>

        <div class="field-row">
          <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
          <div class="row nowrap">
            <input type="tel" id="phone" name="phone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0912345678" disabled class="grow">
            <span id="lockPhoneBadge" class="pill lock-badge" style="display:none;"
                  role="button" tabindex="0" aria-label="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå"
                  onclick="unlockNamePhone()">üîí ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å</span>
          </div>
        </div>

        <div class="section-title">üß¥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>
        <div class="muted" id="catalogHint" style="margin-top:-2px;display:none;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</div>
        <div id="itemList"></div>
        <div class="row" style="margin-top:8px">
          <button type="button" class="btn btn-outline" onclick="addItemRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        </div>

        <div class="field-row">
          <label>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</label>
          <div class="row nowrap">
            <div id="sumToggle" class="toggle" role="switch" aria-checked="false" tabindex="0" data-side="left"
                 onclick="toggleSum()" onkeydown="toggleSumKey(event)">
              <span>‡∏õ‡∏¥‡∏î</span><span>‡πÄ‡∏õ‡∏¥‡∏î</span>
              <div class="knob"></div>
              <input type="hidden" id="sumHidden" value="‡∏õ‡∏¥‡∏î">
            </div>
          </div>
        </div>

        <div class="field-row">
          <label for="amount">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</label>
          <div class="row nowrap amount-row">
            <input type="number" id="amount" name="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)" step="1" min="0" class="grow">
            <div id="payToggle" class="toggle" role="switch" aria-checked="true" tabindex="0" data-side="left"
                 onclick="togglePayment()" onkeydown="togglePaymentKey(event)">
              <span>‡πÇ‡∏≠‡∏ô</span><span>‡∏™‡∏î</span>
              <div class="knob"></div>
              <input type="hidden" id="paymentHidden" value="‡πÇ‡∏≠‡∏ô">
            </div>
          </div>
        </div>

        <div class="field-row">
          <label for="note">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <textarea id="note" name="note" rows="2" placeholder=""></textarea>
        </div>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Ñ‡∏™ + QR) / ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°: ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à -->
        <div class="center-actions">
          <button type="button" id="btnPayCase" class="btn btn-primary" onclick="openCasePaymentPopup()" disabled>
            ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
          </button>

          <button type="button" id="btnPayReceipt" class="btn btn-outline" onclick="openPayPopup()" disabled>
            ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
          </button>

          <button type="button" id="btnReview" class="btn btn-outline" onclick="reviewForm()" disabled>
            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
          </button>

          <button type="button" class="btn btn-ghost" onclick="clearForm()">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
        </div>

        
      </form>

      <div id="reviewSection" style="margin-top:16px;">
        <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
      </div>
      <div class="center-actions">
        <button class="btn btn-save" id="btnSaveAll" onclick="saveAllRecords()" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
    </div>

    <!-- =========================
         TAB 2: OPD EDIT + DIAGNOSTICS
         ========================= -->
    <div id="tab-opd" class="tab-content" role="tabpanel" aria-label="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö OPD">
      <div id="editSection" class="edit-panel">
        <div class="section-title">üõ†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°</div>
        <p class="section-sub">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏Ç OPD (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å) ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
        <div class="field-row">
          <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ OPD</label>
          <div class="row nowrap">
            <input type="text" id="editOPD" class="grow"
                   placeholder="‡πÄ‡∏ä‡πà‡∏ô 0007"
                   inputmode="numeric" pattern="\d{4}" maxlength="4"
                   oninput="digitsOnly(this)">
            <button type="button" class="btn btn-outline" onclick="loadDatesByOPD()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
          </div>
        </div>
        <div id="editDateButtons" class="chips" style="margin-top:12px;"></div>
        <div id="editRecordList" style="margin-top:12px;"></div>
      </div>

      <div class="diag-panel">
        <div class="diag-title">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ <span id="diag-count"></span></div>
        <div class="chips" style="gap:8px; flex-wrap:wrap;">
          <button class="chip-btn" onclick="runDiag('missingPhone')">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</button>
          <button class="chip-btn" onclick="runDiag('nameDifferentOPD')">‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥ (‡∏ï‡πà‡∏≤‡∏á OPD)</button>
          <button class="chip-btn" onclick="runDiag('phoneDifferentName')">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ã‡πâ‡∏≥ (‡∏ï‡πà‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠)</button>
          <button class="chip-btn" onclick="runDiag('opdDifferentNamePhone')">OPD ‡∏ã‡πâ‡∏≥ (‡∏ï‡πà‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå)</button>
          <button class="chip-btn" onclick="runDiag('invalidPhone')">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å</button>
          <button class="chip-btn" onclick="runDiag('invalidOPD')">OPD ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å</button>
          <button class="chip-btn" onclick="runDiag('splitGroups')">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏ï‡∏Å (name+phone+opd ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)</button>
          <button class="chip-btn" onclick="runDiag('sameNameMultiPhones')">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå/‡∏ß‡πà‡∏≤‡∏á</button>
        </div>

        <table id="diag-results" style="display:none;">
          <thead><tr id="diag-head"></tr></thead>
          <tbody id="diag-body"></tbody>
        </table>
      </div>
    </div>

    <!-- =========================
         TAB 3: ACCOUNTS RECEIVABLE (MOCKUP)
         ========================= -->
    <div id="tab-ar" class="tab-content" role="tabpanel" aria-label="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞">
      <div class="edit-panel" style="margin-top:0;">
        <div class="section-title">üìå ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (Mockup)</div>
        <p class="section-sub">‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</p>

        <div class="center-actions" style="justify-content:flex-start;">
          <button type="button" class="btn btn-outline" onclick="alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏£‡∏∞‡∏ö‡∏ö: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞')">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</button>
          <button type="button" class="btn btn-ghost" onclick="alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏£‡∏∞‡∏ö‡∏ö: ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤')">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏Å‡∏£‡∏≠‡∏á</button>
        </div>

        <table style="margin-top:12px;">
          <thead>
            <tr>
              <th style="width:70px;">OPD</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠</th>
              <th style="width:120px;">‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
              <th style="width:120px;">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</th>
              <th style="width:120px;">‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á</th>
              <th style="width:90px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th style="width:140px;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>0007</td>
              <td>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ A</td>
              <td style="text-align:right;">5,000</td>
              <td style="text-align:right;">2,000</td>
              <td style="text-align:right;font-weight:900;color:#b91c1c;">3,000</td>
              <td style="text-align:center;">‡∏Ñ‡πâ‡∏≤‡∏á</td>
              <td style="text-align:center;">
                <button class="btn btn-outline" onclick="alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏£‡∏∞‡∏ö‡∏ö: ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î')">‡∏î‡∏π</button>
                <button class="btn btn-primary" onclick="alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏£‡∏∞‡∏ö‡∏ö: ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö')">‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö</button>
              </td>
            </tr>
            <tr>
              <td>0012</td>
              <td>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ B</td>
              <td style="text-align:right;">3,500</td>
              <td style="text-align:right;">0</td>
              <td style="text-align:right;font-weight:900;color:#b91c1c;">3,500</td>
              <td style="text-align:center;">‡∏Ñ‡πâ‡∏≤‡∏á</td>
              <td style="text-align:center;">
                <button class="btn btn-outline" onclick="alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏£‡∏∞‡∏ö‡∏ö: ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î')">‡∏î‡∏π</button>
                <button class="btn btn-primary" onclick="alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏£‡∏∞‡∏ö‡∏ö: ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö')">‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö</button>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="muted" style="margin-top:10px;">
          ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á: ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° API + ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äú‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞/‡∏°‡∏±‡∏î‡∏à‡∏≥/‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‚Äù
        </div>
      </div>
    </div>
  </div>
<!-- =========================
     TAB 4: SETTINGS (REBUILD DISPLAY RECEIPTS)
     ========================= -->
<div id="tab-settings" class="tab-content" role="tabpanel" aria-label="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à">
  <div class="edit-panel" style="margin-top:0;">
    <div class="section-title">üß© ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (Display Number)</div>
    <p class="section-sub">
      ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏î‡∏á‡∏à‡∏∞ ‚Äú‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡∏°‡πà‚Äù ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ issued ‡πÉ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (RB-YYYY-XXXX)
    </p>

    <div class="field-row">
      <label for="rebuildYear">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</label>
      <select id="rebuildYear"></select>
    </div>

    <div class="center-actions" style="justify-content:flex-start;">
      <button type="button" class="btn btn-danger" onclick="rebuildDisplayReceipts()">
        ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡∏°‡πà (Rebuild Display)
      </button>
    </div>

    <div class="muted" style="margin-top:10px;">
      ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏•‡∏Ç RC (Original) ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏∞‡∏ó‡∏ö ‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
    </div>
    <div class="edit-panel" style="margin-top:14px;">
    <div class="section-title">üßæ ‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div>
<p class="section-sub">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å ‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ/OPD ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°</p>

    <div class="field-row">
      <label for="slipOPD">OPD</label>
      <input type="text" id="slipOPD" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0007" inputmode="numeric" maxlength="4" oninput="digitsOnly(this)">
    </div>

    <div class="field-row">
      <label>‡∏ß‡∏±‡∏ô / ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô / ‡∏õ‡∏µ</label>
      <div class="row nowrap">
        <select id="slipDay" class="grow"></select>
        <select id="slipMonth" class="grow"></select>
        <select id="slipYear" class="grow"></select>
       <button type="button" class="btn btn-outline" onclick="searchReceipts()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>

      </div>
    </div>

    <div id="slipResult" style="margin-top:12px;"></div>
  </div>
  </div>
</div>
  


  <!-- =========================
       POPUP: ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ + QR)  ‚úÖ ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏á API
       ========================= -->
  <div id="payCaseOverlay" class="paycase-overlay" aria-hidden="true">
    <div class="paycase-box" role="dialog" aria-modal="true" aria-label="‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô">
      <div class="paycase-head">
        <div>
          <div class="paycase-title">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
          <div class="paycase-sub">
            
          </div>
        </div>
        <button class="paycase-close" onclick="closeCasePaymentPopup()">‚úï</button>
      </div>

      <div class="paycase-grid">
        <div class="paycase-card">
          <h4>üßæ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•</h4>

          <div class="bill-head">
  <div class="bill-field">
    <div class="k">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</div>

    <div class="v" id="pc_name">-</div>
  </div>

  <div class="bill-field">
    <div class="k">OPD</div>
    <div class="v" id="pc_opd">-</div>
  </div>
</div>


          <div class="warn" id="pc_warn"></div>

          <h4 style="margin-top:14px;">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ <span class="muted" id="pc_itemCount"></span></h4>

          <div id="pc_tableWrap"></div>

          <div class="sumline">
            <div class="label">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
            <div class="value" id="pc_total">0</div>
          </div>
          
        </div>

        <div class="paycase-card">
          <h4>üí≥ ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h4>

          <div class="qr-wrap">
            <img class="qr-img" src="{{ url_for('static', filename='icon/bank.png') }}" alt="QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô">

            
          </div>

          <div class="paycase-actions">
            <button class="btn btn-outline" onclick="closeCasePaymentPopup()">‡∏õ‡∏¥‡∏î</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================
       POPUP ‡∏ä‡∏±‡πâ‡∏ô 1: ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÄ‡∏î‡∏¥‡∏°)
       ========================= -->
  <div id="payOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" aria-label="‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à">
      <div class="modal-head">
        <div>
          <div class="modal-title">‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div>
          <div class="modal-sub">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå</div>
        </div>
        <button class="modal-close" onclick="closePayPopup()">‚úï</button>
      </div>

      <div class="mini-grid">
        <div class="field">
          <b>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</b>
          <div class="v" id="pay_name">-</div>
          <div class="muted" id="pay_phone">-</div>
        </div>
        <div class="field">
          <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</b>
          <div class="v" id="pay_date">-</div>
          <div class="muted" id="pay_method">-</div>
        </div>
        <div class="field">
          <b>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</b>
          <div class="v" id="pay_total" style="font-weight:900;font-size:18px;color:#0b7660">0</div>
          <div class="muted">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á ‚Äú‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‚Äù</div>
        </div>

        <div class="field" style="grid-column:1/-1;">
          <b>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà)</b>
<textarea
  id="pay_note_input"
  rows="3"
  placeholder="‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤
‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤"
  style="width:100%;margin-top:6px;border:1px solid #d1d5db;border-radius:10px;padding:8px;font-size:14px;resize:vertical;"
></textarea>
        </div>
      </div>

      <div class="field" style="margin-top:6px;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fbfbfb;">
        <b style="display:block;color:#0b7660;margin-bottom:6px;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ï‡πâ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</b>
        <div class="row" style="flex-wrap:wrap;gap:10px;">
          <div class="grow">
            <label class="muted">1) ‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏≠‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</label>
            <input id="sig_authorized" type="text" value="‡∏û‡∏ç.‡∏õ‡∏¥‡∏¢‡∏∞‡∏é‡∏≤ ‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡∏´‡∏•‡∏ß‡∏á" readonly>

          </div>
          <div class="grow">
            <label class="muted">2) ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
            <input id="sig_customer" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£">
          </div>
          <div class="grow">
            <label class="muted">3) ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</label>
            <input id="sig_receiver" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô">
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closePayPopup()">‡∏Å‡∏•‡∏±‡∏ö</button>
        <button class="btn btn-primary" onclick="openReceiptFromPay()">‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°</button>
      </div>
    </div>
  </div>

  <!-- =========================
       POPUP ‡∏ä‡∏±‡πâ‡∏ô 2: ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°
       ========================= -->
  <div id="receiptOverlay" class="receipt-overlay" aria-hidden="true">
    <div class="receipt-box">
      <div class="receipt-header">
        <h2>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô)</h2>
        <div class="receipt-subtitle">‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</div>
        <div class="receipt-clinic">‡∏´‡∏°‡∏≠‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏°‡∏µ‡πà ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏° ‡∏•‡∏≥‡∏û‡∏π‡∏ô ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï 5110100116</div>
        <div class="receipt-small">
          ‡∏û‡∏ç.‡∏õ‡∏¥‡∏¢‡∏∞‡∏é‡∏≤ ‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡∏´‡∏•‡∏ß‡∏á ‡∏ß.51308<br>
          186/4 ‡∏°.5 ‡∏ï.‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏¢‡∏≠‡∏á ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏•‡∏≥‡∏û‡∏π‡∏ô 51000<br>
          ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå 0614296596
        </div>
        <div style="margin-top:10px; font-size:8px; font-weight:900; color:#111827;">
  ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: <span id="receiptNo">-</span>
  </div>

      </div>

      <div id="receiptContent"></div>

      <div class="fineprint">
        <b>‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</b><br>
        (1) ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏à‡πá‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏î‡πâ<br>
        (2) ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏¥‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£ ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡πÑ‡∏°‡πà‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏´‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏•‡∏á‡πÑ‡∏ß‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏°‡∏Ñ‡∏ß‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏≠‡∏±‡∏ô‡∏≠‡∏≤‡∏à‡∏Å‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡πÅ‡∏Å‡πà‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ß‡πà‡∏≤‡∏´‡∏≤‡∏Å‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
      </div>
      <div class="fineprint" style="margin-top:14px;">
        <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b><br>
        ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πà‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ
      </div>

      <div class="sig-wrap">
        <div class="sig-grid">
          <div class="sig-card">
            <div class="sig-label">1) ‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏≠‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</div>
            <canvas id="sigPad_authorized" class="sig-pad"></canvas>
            <div class="sig-actions">
              <button type="button" class="sig-btn" onclick="clearSig('authorized')">‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
            <input  class="sig-under-input"  id="sigUnder_authorized"  type="text"  value="‡∏û‡∏ç.‡∏õ‡∏¥‡∏¢‡∏∞‡∏é‡∏≤ ‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡∏´‡∏•‡∏ß‡∏á"  readonly>
          </div>

          <div class="sig-card">
            <div class="sig-label">2) ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
            <canvas id="sigPad_customer" class="sig-pad"></canvas>
            <div class="sig-actions">
              <button type="button" class="sig-btn" onclick="clearSig('customer')">‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
            <input  class="sig-under-input"  id="sigUnder_customer"  type="text"  placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠">
          </div>

          <div class="sig-card">
            <div class="sig-label">3) ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>
            <canvas id="sigPad_receiver" class="sig-pad"></canvas>
            <div class="sig-actions">
              <button type="button" class="sig-btn" onclick="clearSig('receiver')">‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
            <input   class="sig-under-input"  id="sigUnder_receiver"  type="text"  placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠">
          </div>
        </div>
      </div>

      

      <div class="receipt-actions" style="display:flex;justify-content:center;gap:10px;margin-top:14px;flex-wrap:wrap;">
  <button class="btn btn-outline" onclick="closeReceipt()">‡∏õ‡∏¥‡∏î</button>
  <button class="btn btn-outline" onclick="saveReceiptImage()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û</button>
  <button class="btn btn-primary" onclick="window.print()">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // =========================
    // Tabs
    // =========================
    function switchTab(id, btn){
      document.querySelectorAll('.tab-btn').forEach(b=>{
        b.classList.remove('active');
        b.setAttribute('aria-selected','false');
      });
      document.querySelectorAll('.tab-content').forEach(t=> t.classList.remove('active'));

      const panel = document.getElementById(id);
      if(panel) panel.classList.add('active');

      if(btn){
        btn.classList.add('active');
        btn.setAttribute('aria-selected','true');
      }

      const container = document.querySelector('.container');
      if(container) container.scrollIntoView({behavior:'smooth', block:'start'});
    }

    // =========================
    // Helpers
    // =========================
    function safe(v){
      const map = {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
      return (v==null?'':String(v)).replace(/[&<>"']/g, s=>map[s]);
    }
    function nl2brSafe(text){
      return safe(text).replace(/\n/g, "<br>");
    }
    function formatDate(dateStr){
      if(!dateStr) return '';
      const [y,m,d] = dateStr.split('-');
      return `${d}/${m}/${y}`;
    }

    // =========================
    // ‚úÖ Product Catalog from Supabase: /api/products_map
    // =========================
    const PROMO_CAT_NAME = '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©';
    let subOptionsMap = {};

    async function loadCatalog(){
      const hint = document.getElementById('catalogHint');
      if(hint) hint.style.display = 'block';

      const res = await fetch('/api/products_map');
      const data = await res.json().catch(()=> ({}));
      if(!res.ok) throw new Error(data.error || '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

      subOptionsMap = data.map || {};
      if(!subOptionsMap['‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©']){
        subOptionsMap['‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©'] = [];
      }

      refreshAllItemMainSelects();
      if(hint) hint.style.display = 'none';
    }

    function mainCategoryKeys(){
      const keys = Object.keys(subOptionsMap || {}).filter(k => k !== PROMO_CAT_NAME);
      return [...keys, PROMO_CAT_NAME].filter(Boolean);
    }

    function buildMainOptionsHTML(){
      const keys = mainCategoryKeys();
      if(!keys.length){
        return `<option value="">-- (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤) --</option>`;
      }
      return `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å --</option>` +
        keys.map(k=>`<option value="${safe(k)}">${safe(k)}</option>`).join('');
    }

    function updateSubOptions(itemSelect, subSelect){
      const selectedCatName = itemSelect.value || '';
      let options = (subOptionsMap && subOptionsMap[selectedCatName]) ? subOptionsMap[selectedCatName] : [];

      if(selectedCatName === PROMO_CAT_NAME){
        options = Object.entries(subOptionsMap || {})
          .filter(([k]) => k !== PROMO_CAT_NAME)
          .flatMap(([_, arr]) => arr || []);
      }

      const uniqNames = [];
      const seen = new Set();

      (options || []).forEach(o=>{
        const n = String((typeof o === 'string') ? o : (o?.name || '')).trim();
        if(!n) return;
        if(seen.has(n)) return;
        seen.add(n);
        uniqNames.push(n);
      });

      subSelect.innerHTML =
        '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>' +
        uniqNames.map(n => `<option value="${safe(n)}">${safe(n)}</option>`).join('');

      subSelect.value = '';
    }

    function refreshAllItemMainSelects(){
      document.querySelectorAll('select[name="item[]"]').forEach(sel=>{
        const prev = sel.value;
        sel.innerHTML = buildMainOptionsHTML();
        if(prev && mainCategoryKeys().includes(prev)){
          sel.value = prev;
          const subSel = sel.nextElementSibling;
          if(subSel && subSel.tagName === 'SELECT'){
            updateSubOptions(sel, subSel);
          }
        }
      });
    }

    // =========================
    // ---------- State ----------
    // =========================
    let records = [];
    let customerMap = {};
    let currentEditId = null;
    let editDataByOPD = [];
    let manualUnlockNamePhone = false;
    let lastOPDForLock = '';
    let allSales = null;

    // ---------- Prefill customers ----------
    fetch('/api/customers').then(r=>r.json()).then(data=>{
      (data||[]).forEach(c=>{
        if(c.opd){ customerMap[c.opd] = {name:c.name||'', phone:c.phone||''}; }
      });
    }).catch(()=>{});

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', async () => {
      try{
        await loadCatalog();
      }catch(e){
        console.error(e);
        alert(e.message || '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }

      initFirstRow();
      initDateToday();

      const ipt = document.getElementById('editOPD');
      if (ipt) {
        ipt.addEventListener('keydown', (e)=>{
          if (e.key === 'Enter') { e.preventDefault(); loadDatesByOPD(); }
        });
      }

      ['lockNameBadge','lockPhoneBadge'].forEach(id=>{
        const el = document.getElementById(id);
        if(el){
          el.addEventListener('keydown', (e)=>{
            if(e.key==='Enter' || e.key===' '){ e.preventDefault(); unlockNamePhone(); }
          });
        }
      });
  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  const amt = document.getElementById('amount');
  if (amt) {
    amt.addEventListener('input', refreshActionButtonsState);
    amt.addEventListener('change', refreshActionButtonsState);
  }

      recalcAmount();
      refreshActionButtonsState();
    });

    initRebuildYearDropdown();
function initRebuildYearDropdown(){
  const sel = document.getElementById('rebuildYear');
  if(!sel) return;

  const y = new Date().getFullYear();
  const years = [];
  for(let i=y-3; i<=y+1; i++) years.push(i);

  sel.innerHTML = years.map(v=>`<option value="${v}">${v}</option>`).join('');
  sel.value = String(y);
}


async function rebuildDisplayReceipts(){
  const sel = document.getElementById('rebuildYear');
  const year = Number(sel?.value || 0);
  if(!year) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ');

  if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ ${year}?`)) return;

  try{
    const res = await fetch('/api/rebuild_display_receipts', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ year })
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok || data.success !== true){
      throw new Error(data.error || '‡∏à‡∏±‡∏î‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
    alert(`‚úÖ ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${data.count || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
  }catch(e){
    console.error(e);
    alert(`‚ùå ${e.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`);
  }
}


    // =========================
    // ---------- UI helpers ----------
    // =========================
    function digitsOnly(el){ el.value = (el.value || '').replace(/\D/g,'').slice(0,4); }
    function isValidOPD(opd){ return /^\d{4}$/.test(opd||''); }

    function unlockNamePhone(){
      manualUnlockNamePhone = true;
      const nameEl  = document.getElementById('name');
      const phoneEl = document.getElementById('phone');
      const lockName  = document.getElementById('lockNameBadge');
      const lockPhone = document.getElementById('lockPhoneBadge');
      nameEl.disabled = false; phoneEl.disabled = false;
      nameEl.readOnly = false; phoneEl.readOnly = false;
      lockName.style.display = 'none'; lockPhone.style.display = 'none';
      setTimeout(()=> nameEl.focus(), 0);
    }

    function onOPDInput(el){
      digitsOnly(el);
      document.getElementById('btnReview').disabled = !isValidOPD(el.value);

      const nameEl = document.getElementById('name');
      const phoneEl = document.getElementById('phone');
      const lockName = document.getElementById('lockNameBadge');
      const lockPhone = document.getElementById('lockPhoneBadge');

      if(!isValidOPD(el.value)){
        manualUnlockNamePhone = false;
        lastOPDForLock = '';
        nameEl.value=''; phoneEl.value='';
        nameEl.disabled = true; phoneEl.disabled = true;
        nameEl.readOnly = false; phoneEl.readOnly = false;
        lockName.style.display='none'; lockPhone.style.display='none';
        refreshActionButtonsState();
        return;
      }

      const opd = el.value;
      if(opd !== lastOPDForLock){
        manualUnlockNamePhone = false;
        lastOPDForLock = opd;
      }

      const c = customerMap[opd];
      if(c && !manualUnlockNamePhone){
        nameEl.value = c.name||''; phoneEl.value = c.phone||'';
        nameEl.disabled = true; phoneEl.disabled = true;
        nameEl.readOnly = true; phoneEl.readOnly = true;
        lockName.style.display='inline-flex'; lockPhone.style.display='inline-flex';
      }else{
        nameEl.disabled = false; phoneEl.disabled = false;
        nameEl.readOnly = false; phoneEl.readOnly = false;
        lockName.style.display='none'; lockPhone.style.display='none';
        if(c && manualUnlockNamePhone && !nameEl.value && !phoneEl.value){
          nameEl.value = c.name || '';
          phoneEl.value = c.phone || '';
        }
      }
      refreshActionButtonsState();
    }

    /* ----- Toggle utilities ----- */
    function setToggle(el, side){
      el.setAttribute('data-side', side);
      el.setAttribute('aria-checked', side==='right' ? 'true':'false');
    }

    function getPayment(){ return document.getElementById('paymentHidden').value || '‡πÇ‡∏≠‡∏ô'; }
    function setPayment(val){
      const toggle = document.getElementById('payToggle');
      const hidden = document.getElementById('paymentHidden');
      if(val === '‡∏™‡∏î'){ setToggle(toggle, 'right'); hidden.value = '‡∏™‡∏î'; }
      else { setToggle(toggle, 'left'); hidden.value = '‡πÇ‡∏≠‡∏ô'; }
      refreshActionButtonsState();
    }
    function togglePayment(){ setPayment(getPayment() === '‡πÇ‡∏≠‡∏ô' ? '‡∏™‡∏î' : '‡πÇ‡∏≠‡∏ô'); }
    function togglePaymentKey(e){
      if([' ','Enter','ArrowLeft','ArrowRight'].includes(e.key)){
        e.preventDefault();
        if(e.key==='ArrowLeft'){ setPayment('‡πÇ‡∏≠‡∏ô'); }
        else if(e.key==='ArrowRight'){ setPayment('‡∏™‡∏î'); }
        else { togglePayment(); }
      }
    }

    function getSumState(){ return document.getElementById('sumHidden').value || '‡∏õ‡∏¥‡∏î'; }
    function setSumState(val){
      const toggle = document.getElementById('sumToggle');
      const hidden = document.getElementById('sumHidden');
      if(val === '‡πÄ‡∏õ‡∏¥‡∏î'){ setToggle(toggle, 'right'); hidden.value = '‡πÄ‡∏õ‡∏¥‡∏î'; recalcAmount(); }
      else { setToggle(toggle, 'left'); hidden.value = '‡∏õ‡∏¥‡∏î'; }
      refreshActionButtonsState();
    }
    function toggleSum(){ setSumState(getSumState() === '‡πÄ‡∏õ‡∏¥‡∏î' ? '‡∏õ‡∏¥‡∏î' : '‡πÄ‡∏õ‡∏¥‡∏î'); }
    function toggleSumKey(e){
      if([' ','Enter','ArrowLeft','ArrowRight'].includes(e.key)){
        e.preventDefault();
        if(e.key==='ArrowLeft'){ setSumState('‡∏õ‡∏¥‡∏î'); }
        else if(e.key==='ArrowRight'){ setSumState('‡πÄ‡∏õ‡∏¥‡∏î'); }
        else { toggleSum(); }
      }
    }

    // =========================
    // Items
    // =========================
    function makeItemRow(){
      const row = document.createElement('div');
      row.className = 'item-row single';
      row.innerHTML = `
        <select name="item[]">
          ${buildMainOptionsHTML()}
        </select>
        <select name="subitem[]"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option></select>
        <input type="number" name="price[]" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" step="1" min="0">
        <input type="number" name="qty[]" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" step="1" min="1" value="1">
        <div class="item-actions">
          <button type="button" class="btn btn-ghost">‡∏•‡∏ö</button>
        </div>
      `;

      const mainSel = row.querySelector('select[name="item[]"]');
      const subSel  = row.querySelector('select[name="subitem[]"]');
      const priceEl = row.querySelector('input[name="price[]"]');
      const qtyEl   = row.querySelector('input[name="qty[]"]');
      const delBtn  = row.querySelector('.item-actions button');

      mainSel.addEventListener('change', ()=>{
        updateSubOptions(mainSel, subSel);
        recalcAmount();
        refreshActionButtonsState();
      });

      subSel.addEventListener('change', ()=>{
        refreshActionButtonsState();
      });

      priceEl.addEventListener('input', ()=> { recalcAmount(); refreshActionButtonsState(); });
      qtyEl.addEventListener('input', ()=> { recalcAmount(); refreshActionButtonsState(); });

      delBtn.addEventListener('click', ()=> removeItemRow(delBtn));
      return row;
    }

    function initFirstRow(){
      const list = document.getElementById('itemList');
      list.innerHTML = '';
      list.appendChild(makeItemRow());
      setPayment('‡πÇ‡∏≠‡∏ô');
      setSumState('‡∏õ‡∏¥‡∏î');
      refreshActionButtonsState();
    }

    function addItemRow(){
      const list = document.getElementById('itemList');
      list.appendChild(makeItemRow());
      refreshActionButtonsState();
    }

    function removeItemRow(btn){
      const row = btn.closest('.item-row');
      const list = document.getElementById('itemList');
      if(list.children.length>1){
        row.remove();
        recalcAmount();
      }
      refreshActionButtonsState();
    }

    function initDateToday(){
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      document.getElementById('date').value = `${d.getFullYear()}-${mm}-${dd}`;
    }

    // =========================
    // ‚úÖ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‚Äù ‡πÅ‡∏•‡∏∞ ‚Äú‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‚Äù
    // - OPD ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á 4 ‡∏´‡∏•‡∏±‡∏Å
    // - amount > 0
    // - ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å main ‡πÅ‡∏•‡πâ‡∏ß)
    // =========================
    function hasAtLeastOneMainSelected(){
      const mains = Array.from(document.querySelectorAll('select[name="item[]"]'));
      return mains.some(sel => String(sel.value || '').trim() !== '');
    }

    function refreshActionButtonsState(){
      const opdVal = (document.getElementById('opd').value||'').trim();
      const amount = Number(document.getElementById('amount').value||0);

      const ok = isValidOPD(opdVal)
        && Number.isFinite(amount)
        && amount > 0
        && hasAtLeastOneMainSelected();

      document.getElementById('btnPayCase').disabled = !ok;
      document.getElementById('btnPayReceipt').disabled = !ok;
    }

    // =========================
    // Auto-sum
    // =========================
    function recalcAmount(){
      if(getSumState() !== '‡πÄ‡∏õ‡∏¥‡∏î') return;
      const prices = document.querySelectorAll('input[name="price[]"]');
      const qtys   = document.querySelectorAll('input[name="qty[]"]');
      let total = 0;
      for(let i=0;i<prices.length;i++){
        const p = Number(prices[i].value==='' ? 0 : prices[i].value);
        const q = Number(qtys[i].value||0);
        total += p*q;
      }
      document.getElementById('amount').value = (Number.isInteger(total)? total : Math.round(total));
      refreshActionButtonsState();
    }

    function clearForm(){
      document.getElementById('saleForm').reset();
      initDateToday();
      initFirstRow();
      manualUnlockNamePhone = false;
      lastOPDForLock = '';
      onOPDInput(document.getElementById('opd'));
      document.getElementById('btnReview').disabled = true;
      recalcAmount();
      refreshActionButtonsState();
    }

    // =========================
    // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° (main+sub+qty+price)
    // =========================
    function collectItemsFromForm(){
      const itemNames = document.querySelectorAll('select[name="item[]"]');
      const itemSubs  = document.querySelectorAll('select[name="subitem[]"]');
      const itemPrices= document.querySelectorAll('input[name="price[]"]');
      const itemQtys  = document.querySelectorAll('input[name="qty[]"]');

      const items = [];
      for(let i=0;i<itemNames.length;i++){
        const main = (itemNames[i].value||'').trim();
        if(!main) continue;

        const sub  = (itemSubs[i].value||'').trim();
        const qty  = Math.max(1, Math.floor(Number(itemQtys[i].value||1) || 1));
        const price = Math.max(0, Math.floor(Number(itemPrices[i].value||0) || 0));

        const label = sub ? `${main} (${sub})` : main;
        items.push({ label, qty, price });
      }
      return items;
    }

    // =========================
    // ‚úÖ ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£ ‚Äú‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏¢‡∏≠‡∏î‚Äù ‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤ (‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á popup ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô + ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à)
    // =========================
    function distributeMixedAmount(amount, items){
  const amt = Math.max(0, Math.floor(Number(amount||0) || 0));

  // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° out ‡πÅ‡∏ö‡∏ö‡∏£‡∏±‡∏Å‡∏©‡∏≤ label/qty/price
  const baseItems = (items||[]).map(it=>({
    label: it.label,
    qty: Math.max(1, Math.floor(Number(it.qty||1) || 1)),
    price: Math.max(0, Math.floor(Number(it.price||0) || 0)),
  }));

  // 1) fixed price ‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô
  let fixedTotal = 0;
  const fixedLines = [];
  const zeroIdx = [];

  baseItems.forEach((it, idx)=>{
    if(it.price > 0){
      const lineTotal = it.price * it.qty;
      fixedTotal += lineTotal;
      fixedLines.push({
        label: it.label,
        qty: it.qty,
        unit: it.price,       // ‚úÖ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô ‚Äú‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‚Äù
        lineTotal: lineTotal,
        isFixed: true
      });
    }else{
      zeroIdx.push(idx);
    }
  });

  let remaining = amt - fixedTotal;
  let warn = '';
  if(remaining < 0){
    remaining = 0;
    warn = '‡∏û‡∏ö‡∏¢‡∏≠‡∏î ‚Äú‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‚Äù ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ';
  }

  // 2) ‡πÅ‡∏à‡∏Å remaining ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏∏‡πà‡∏° price=0 ‡πÅ‡∏ö‡∏ö ‚Äú‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‚Äù (proportional by qty)
  //    ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° (‡∏ö‡∏≤‡∏ó) ‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏±‡∏î‡∏•‡∏á + ‡πÅ‡∏à‡∏Å‡πÄ‡∏®‡∏© 1 ‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡∏•‡∏∞‡∏Å‡πâ‡∏≠‡∏ô
  const allocTotals = new Array(baseItems.length).fill(0);

  if(zeroIdx.length > 0){
    const totalQty = zeroIdx.reduce((s, idx)=> s + baseItems[idx].qty, 0) || 1;

    const tmp = zeroIdx.map(idx=>{
      const raw = remaining * (baseItems[idx].qty / totalQty);
      const base = Math.floor(raw);
      return { idx, base, frac: raw - base };
    });

    let used = tmp.reduce((s,x)=> s + x.base, 0);
    let rem = remaining - used;

    // ‡πÅ‡∏à‡∏Å‡πÄ‡∏®‡∏©‡πÉ‡∏´‡πâ frac ‡∏°‡∏≤‡∏Å‡∏Å‡πà‡∏≠‡∏ô
    tmp.sort((a,b)=> b.frac - a.frac);
    for(let i=0; i<tmp.length && rem>0; i++, rem--){
      tmp[i].base += 1;
    }

    tmp.forEach(x=>{
      allocTotals[x.idx] = x.base; // ‚úÖ lineTotal (‡∏ö‡∏≤‡∏ó) ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô ‡πÜ
    });
  }

  // 3) ‡πÅ‡∏ï‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ price=0 ‡πÉ‡∏´‡πâ ‚Äú‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‚Äù ‡πÅ‡∏•‡∏∞ ‚Äú‡∏Ñ‡∏π‡∏ì‡∏•‡∏á‡∏ï‡∏±‡∏ß‚Äù
  //    ‡∏ñ‡πâ‡∏≤ lineTotal ‡∏´‡∏≤‡∏£ qty ‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ï‡∏±‡∏ß -> ‡πÅ‡∏ï‡∏Å‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î: (qty-rem)*baseUnit ‡πÅ‡∏•‡∏∞ rem*(baseUnit+1)
  const splitLines = [];
  zeroIdx.forEach(idx=>{
    const it = baseItems[idx];
    const lineTotal = Math.max(0, Math.floor(Number(allocTotals[idx]||0) || 0));
    const q = it.qty;

    const baseUnit = Math.floor(lineTotal / q);
    const rem = lineTotal - (baseUnit * q); // 0..q-1

    const qtyBase = q - rem; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏Ñ‡∏≤ baseUnit
    if(qtyBase > 0){
      splitLines.push({
        label: it.label,
        qty: qtyBase,
        unit: baseUnit,
        lineTotal: baseUnit * qtyBase,
        isFixed: false
      });
    }
    if(rem > 0){
      splitLines.push({
        label: it.label,
        qty: rem,
        unit: baseUnit + 1,
        lineTotal: (baseUnit + 1) * rem,
        isFixed: false
      });
    }
  });

  const lines = [...fixedLines, ...splitLines];
  const sum = lines.reduce((s,x)=> s + (Number(x.lineTotal)||0), 0);

  return { lines, fixedTotal, remaining, total: sum, warn };
}


    // =========================
    // ‚úÖ Popup: ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ + QR)  (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏á API)
    // =========================
    function openCasePaymentPopup(){
      const opdVal = (document.getElementById('opd').value||'').trim();
      if(!isValidOPD(opdVal)) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');

      const amount = Math.floor(Number(document.getElementById('amount').value||0));
      if(!Number.isFinite(amount) || amount<=0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó) ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

      const items = collectItemsFromForm();
      if(items.length===0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

      const date = (document.getElementById('date').value||'').slice(0,10);
      const method = getPayment();

      // ‡∏´‡∏±‡∏ß‡∏ö‡∏¥‡∏•
      document.getElementById('pc_name').textContent = document.getElementById('name').value || '-';
document.getElementById('pc_opd').textContent = opdVal;

      // ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏¢‡∏≠‡∏î
      const dist = distributeMixedAmount(amount, items);

      // warning
      const warnEl = document.getElementById('pc_warn');
      if(dist.warn){
        warnEl.style.display = 'block';
        warnEl.textContent = dist.warn;
      }else{
        warnEl.style.display = 'none';
        warnEl.textContent = '';
      }

      // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      document.getElementById('pc_itemCount').textContent = `(${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;

      // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      const tableHtml = `
        <table class="paycase-table">
          <thead>
            <tr>
              <th style="width:60px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th style="width:90px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô</th>
              <th style="width:140px;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</th>
            </tr>
          </thead>
          <tbody>
            ${dist.lines.map((r, idx)=>`
              <tr>
                <td style="text-align:center;">${idx+1}</td>
                <td>${safe(r.label)}</td>
                <td style="text-align:center;">${r.qty}</td>
                <td style="text-align:right;">${Math.floor(r.lineTotal).toLocaleString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('pc_tableWrap').innerHTML = tableHtml;

      // ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°/‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞
      document.getElementById('pc_total').textContent = `${Math.floor(amount).toLocaleString()} ‡∏ö‡∏≤‡∏ó`;


      const ov = document.getElementById('payCaseOverlay');
      ov.style.display = 'flex';
      ov.setAttribute('aria-hidden','false');
    }

    function closeCasePaymentPopup(){
      const ov = document.getElementById('payCaseOverlay');
      ov.style.display = 'none';
      ov.setAttribute('aria-hidden','true');
    }

    // =========================
    // Review / Save (‡πÄ‡∏î‡∏¥‡∏°)
    // =========================
    function reviewForm(){
      const opdVal = (document.getElementById('opd').value||'').trim();
      if(!isValidOPD(opdVal)){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }

      const date = (document.getElementById('date').value||'').slice(0,10);
      const opd  = opdVal;
      const name = document.getElementById('name').value||'';
      const phone = document.getElementById('phone').value||'';
      const amount = document.getElementById('amount').value||'';
      const payment = getPayment();
      const note = document.getElementById('note').value||'';

      const { rows, linesForSave } = collectItemsForReceiptAndSave();
      if(rows.length===0){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); return; }

      const rec = { date, opd, name, phone, amount, payment, note, items: linesForSave };
      if(currentEditId){ rec.id = currentEditId; }

      records.push(rec);
      renderReviewSection();
      validateSaveAllReady();

      const keepDate = date; const keepOPD = opd;
      document.getElementById('saleForm').reset();
      document.getElementById('date').value = keepDate;
      document.getElementById('opd').value = keepOPD;
      onOPDInput(document.getElementById('opd'));
      initFirstRow();
      currentEditId = null;
      document.getElementById('currentId').value = '';
      recalcAmount();
      refreshActionButtonsState();
    }

    function renderReviewSection(){
      const section = document.getElementById('reviewSection');
      section.innerHTML = '<h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>';

      const grouped = {};
      records.forEach((r,idx)=>{ const d=r.date||''; (grouped[d]||(grouped[d]=[])).push({...r, _idx: idx}); });

      Object.entries(grouped).sort(([a],[b])=> new Date(b)-new Date(a)).forEach(([date, list])=>{
        const dayTotal = list.reduce((s,r)=> s + (parseFloat(r.amount)||0), 0);
        const container = document.createElement('div'); container.style.marginBottom='24px';
        const header = document.createElement('h4'); header.textContent = `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDate(date)} ‚Äî ‡∏£‡∏ß‡∏° ${dayTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`; container.appendChild(header);

        const stripPrice = (s) => String(s).replace(/ - \d+(?:\.\d+)? ‡∏ä‡∏¥‡πâ‡∏ô x \d+(?:\.\d+)? ‡∏ö‡∏≤‡∏ó$/, '');

        const rowsHtml = list.map((r,i)=>{
          const itemsHtml = (r.items||[]).map(x=>`<li>${safe(stripPrice(x))}</li>`).join('');
          return `<tr>
            <td>${i+1}</td>
            <td><div><strong>${safe(r.name||'-')}</strong></div><div class="muted">OPD: ${safe(r.opd)}</div></td>
            <td>${safe(r.phone||'-')}</td>
            <td><ul style='margin:0;padding-left:16px;'>${itemsHtml || '<span class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>'}</ul></td>
            <td>${safe(r.amount||0)} ‡∏ö‡∏≤‡∏ó (${safe(r.payment)})${r.note?`<div class='muted'>üìù ${safe(r.note)}</div>`:''}</td>
            <td style="text-align:center;">
              <div class="actions">
                <button type="button" class="btn btn-primary"
                  onclick="editRecordFromObject(records[${r._idx}]); currentEditId = records[${r._idx}].id || null; document.getElementById('currentId').value=currentEditId||'';">
                  ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteRecord(${r._idx})">‡∏•‡∏ö</button>
              </div>
            </td>
          </tr>`;
        }).join('');

        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr>
              <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠</th>
              <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
              <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th>‡∏¢‡∏≠‡∏î</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>`;
        container.appendChild(table);
        section.appendChild(container);
      });
    }

    function deleteRecord(idx){
      if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?')) return;
      records.splice(idx,1);
      renderReviewSection();
      validateSaveAllReady();
    }

    function validateSaveAllReady(){
      const ok = records.length>0 && records.every(r=> isValidOPD(r.opd));
      document.getElementById('btnSaveAll').disabled = !ok;
    }

    function saveAllRecords(){
      if(records.length===0) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß');
      if(!records.every(r=> isValidOPD(r.opd))){
        alert('‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà OPD ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        return;
      }
      if(!confirm('‚ú® ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')) return;
      fetch('/api/save_sales', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(records)
      })
      .then(r=>r.json())
      .then(data=>{
        if(data && (data.message||'').includes('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')){
          alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ${data.updated||0} / ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ${data.inserted||0}`);
          records = []; renderReviewSection(); validateSaveAllReady();
          clearForm();
          allSales = null;
        }else{
          alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
      })
      .catch(err=>{ console.error(err); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'); });
    }

    function deleteRecordFromSupabase(id){
      if(!id) return;
      if(!confirm('‚ùå ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      fetch('/api/delete_sales_record', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({id})
      })
      .then(r=>r.json()).then(()=>{
        alert('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        loadDatesByOPD();
        allSales = null;
      })
      .catch(()=> alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
    }

    // =========================
    // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
    // - linesForSave ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö ‚Äúqty ‡∏ä‡∏¥‡πâ‡∏ô x price ‡∏ö‡∏≤‡∏ó‚Äù ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å (price=0 ‡πÑ‡∏î‡πâ)
    // =========================
    function collectItemsForReceiptAndSave(){
      const items = collectItemsFromForm();
      if(items.length===0){
        return { rows: [], linesForSave: [] };
      }

      const rows = items.map(it=>({ label: it.label, qty: it.qty, price: it.price }));
      const linesForSave = items.map(it => `${it.label} - ${it.qty} ‡∏ä‡∏¥‡πâ‡∏ô x ${Math.floor(it.price||0)} ‡∏ö‡∏≤‡∏ó`);
      return { rows, linesForSave };
    }

    // =========================
    // Popup ‡∏ä‡∏±‡πâ‡∏ô 1: ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
    // =========================
    function openPayPopup(){
      const opdVal = (document.getElementById('opd').value||'').trim();
      if(!isValidOPD(opdVal)) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');

      const total = Math.floor(Number(document.getElementById('amount').value||0));
      if(!Number.isFinite(total) || total<=0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó) ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

      const { rows } = collectItemsForReceiptAndSave();
      if(rows.length===0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

      const date = (document.getElementById('date').value||'').slice(0,10);
      document.getElementById('pay_name').textContent  = document.getElementById('name').value || '-';
      document.getElementById('pay_phone').textContent = (document.getElementById('phone').value || '-');
      document.getElementById('pay_date').textContent  = formatDate(date);
      document.getElementById('pay_method').textContent= `‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢: ${getPayment()}`;
      document.getElementById('pay_total').textContent = `${Math.floor(total).toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

      // default ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ï‡πâ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
      const name = document.getElementById('name').value || '';
      const a = document.getElementById('sig_authorized');
      const c = document.getElementById('sig_customer');
      const r = document.getElementById('sig_receiver');
      if(a){  a.value = '‡∏û‡∏ç.‡∏õ‡∏¥‡∏¢‡∏∞‡∏é‡∏≤ ‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡∏´‡∏•‡∏ß‡∏á';  a.readOnly = true;}
      if(c && !c.value) c.value = name;
      if(r && !r.value) r.value = '';

      const ov = document.getElementById('payOverlay');
      ov.style.display='flex';
      ov.setAttribute('aria-hidden','false');
    }

    function closePayPopup(){
      const ov = document.getElementById('payOverlay');
      ov.style.display='none';
      ov.setAttribute('aria-hidden','true');
    }

    function applySigNamesToReceipt(){
  const a = (document.getElementById('sig_authorized')?.value || '').trim();
  const c = (document.getElementById('sig_customer')?.value || '').trim();
  const r = (document.getElementById('sig_receiver')?.value || '').trim();

  const ua = document.getElementById('sigUnder_authorized');
  const uc = document.getElementById('sigUnder_customer');
  const ur = document.getElementById('sigUnder_receiver');

  if(ua) ua.value = a;
  if(uc) uc.value = c;
  if(ur) ur.value = r;
}

    // =========================
    // ‚úÖ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°: ‡πÉ‡∏ä‡πâ ‚Äú‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏¢‡∏≠‡∏î‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‚Äù ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô popup ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
    // =========================
    function buildReceiptRowsMixed(total, rows){
      const dateStr = formatDate((document.getElementById('date').value||'').slice(0,10));
      const dist = distributeMixedAmount(total, rows);

      let tbody = '';
      dist.lines.forEach((r, idx)=>{
        const qty = Math.max(1, Math.floor(Number(r.qty||1) || 1));
        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô (‡∏õ‡∏±‡∏î‡∏•‡∏á) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        const unit = Number.isFinite(r.unit) ? r.unit : (qty ? Math.floor(r.lineTotal / qty) : Math.floor(r.lineTotal));


        tbody += `
          <tr>
            <td style="text-align:center;">${idx+1}</td>
            <td>${safe(r.label)}</td>
            <td style="text-align:center;">${qty}</td>
            <td style="text-align:right;">${unit.toLocaleString()}</td>
            <td style="text-align:right;">${Math.floor(r.lineTotal).toLocaleString()}</td>
            <td style="text-align:center;">${safe(dateStr)}</td>
            <td style="text-align:center;">${safe(dateStr)}</td>
          </tr>
        `;
      });

      return { tbody, sum: dist.total, warn: dist.warn };
    }


async function issueReceiptFromForm(){
  const opd = (document.getElementById('opd').value||'').trim();
  const date = (document.getElementById('date').value||'').slice(0,10);
  const amount = Math.floor(Number(document.getElementById('amount').value||0));
  const payment_method = getPayment();

  if(!isValidOPD(opd)) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  if(!date) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
  if(!Number.isFinite(amount) || amount<=0) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

  // ‡πÉ‡∏ä‡πâ items ‡πÅ‡∏ö‡∏ö list of dict ‡∏ï‡∏≤‡∏°‡∏™‡πÄ‡∏õ‡∏Ñ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà string)
  const items = collectItemsFromForm(); // [{label, qty, price}]
  if(!items.length) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

  const payload = { date, opd, amount, payment_method, items };

  const res = await fetch('/api/sales_issue_receipt', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });

  const data = await res.json().catch(()=> ({}));
  if(!res.ok || !data || data.success !== true){
    throw new Error(data.error || '‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
  return data; // {success, orig_no, disp_no, id}
}




    async function openReceiptFromPay(){
  const btn = document.querySelector('#payOverlay .btn.btn-primary');
  if(btn) btn.disabled = true;

  try{
    const issued = await issueReceiptFromForm();
    const dispNo = (issued.disp_no || '').trim();
    const origNo = (issued.orig_no || '').trim();
    const showNo = (dispNo)
      ? dispNo
      : (origNo ? origNo.replace(/^RC-/, 'RB-') : '-');

    const receiptNoEl = document.getElementById('receiptNo');
    if(receiptNoEl) receiptNoEl.textContent = showNo;

    const total = Math.floor(Number(document.getElementById('amount').value || 0));

    // ‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
    const { rows } = collectItemsForReceiptAndSave();
    if(!rows.length) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
    const { tbody, sum } = buildReceiptRowsMixed(total, rows);

    // ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ (‡πÄ‡∏≠‡∏≤‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å popup ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÅ‡∏ï‡πà‡∏ö‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ)
    const patientInfo = (document.getElementById('pay_note_input')?.value || '').trim();

    document.getElementById('receiptContent').innerHTML = `
      <table class="receipt-table">
        <thead>
          <tr>
            <th colspan="7" style="text-align:center; font-weight:900;">
              ‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå
            </th>
          </tr>
          <tr>
            <th style="width:60px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
            <th style="width:70px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            <th style="width:130px;">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ö‡∏≤‡∏ó)</th>
            <th style="width:120px;">‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡∏ö‡∏≤‡∏ó)</th>
            <th style="width:130px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
            <th style="width:130px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody>${tbody}</tbody>
      </table>

      <div class="receipt-total">
        ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô ${sum.toLocaleString()} ‡∏ö‡∏≤‡∏ó
      </div>

      <div class="receipt-section">
        <b>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà):</b><br>
        <textarea id="receipt_patient_info" rows="2"
          placeholder="‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤&#10;‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤"
        >${safe(patientInfo)}</textarea>
      </div>
    `;

    closePayPopup();
    const ov = document.getElementById('receiptOverlay');
    ov.style.display = 'flex';
    ov.setAttribute('aria-hidden','false');

    applySigNamesToReceipt();
    requestAnimationFrame(() => initAllSigPads());

  }catch(err){
    console.error(err);
    alert(err.message || '‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }finally{
    if(btn) btn.disabled = false;
  }
}



    function closeReceipt(){
      const ov = document.getElementById('receiptOverlay');
      ov.style.display='none';
      ov.setAttribute('aria-hidden','true');
    }

    // =========================
    // Edit old records (‡πÄ‡∏î‡∏¥‡∏°)
    // =========================
    function loadDatesByOPD(){
      const raw = (document.getElementById('editOPD').value||'').trim();
      if(!isValidOPD(raw)) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
      const opd = raw;

      const list = document.getElementById('editRecordList');
      const dateBtns = document.getElementById('editDateButtons');
      dateBtns.innerHTML = '';
      list.innerHTML = '<div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>';

      fetch(`/api/sales?opd=${encodeURIComponent(opd)}`)
        .then(r=> r.ok ? r.json() : Promise.reject())
        .then(data=>{
          editDataByOPD = data || [];
          if(editDataByOPD.length===0){
            dateBtns.innerHTML = '';
            list.innerHTML = '<div class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á OPD ‡∏ô‡∏µ‡πâ</div>';
            return;
          }
          const dates = [...new Set(editDataByOPD.map(r=> (r.date||'').slice(0,10)))]
            .sort((a,b)=> new Date(b)-new Date(a));

          dateBtns.innerHTML = 'üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:<br>' + dates.map((d,i)=>(
            `<span class="chip ${i===0?'active':''}" data-date="${d}" onclick="selectEditDateChip(this)">${formatDate(d)}</span>`
          )).join('');
          showEditList(dates[0]);
        })
        .catch(()=> { list.innerHTML = '<div class="muted">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>'; });
    }

    function loadDatesByOPDFor(opd){
      const list = document.getElementById('editRecordList');
      const dateBtns = document.getElementById('editDateButtons');
      document.getElementById('editOPD').value = opd;
      dateBtns.innerHTML = '';
      list.innerHTML = '<div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>';
      return fetch(`/api/sales?opd=${encodeURIComponent(opd)}`)
        .then(r=> r.ok ? r.json() : Promise.reject())
        .then(data=>{
          editDataByOPD = data || [];
          if(editDataByOPD.length===0){
            dateBtns.innerHTML = '';
            list.innerHTML = '<div class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á OPD ‡∏ô‡∏µ‡πâ</div>';
            return;
          }
          const dates = [...new Set(editDataByOPD.map(r=> (r.date||'').slice(0,10)))]
            .sort((a,b)=> new Date(b)-new Date(a));

          dateBtns.innerHTML = 'üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:<br>' + dates.map((d,i)=>(
            `<span class="chip ${i===0?'active':''}" data-date="${d}" onclick="selectEditDateChip(this)">${formatDate(d)}</span>`
          )).join('');
          showEditList(dates[0]);
        })
        .catch(()=> { list.innerHTML = '<div class="muted">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>'; });
    }

    function selectEditDateChip(el){
      document.querySelectorAll('#editDateButtons .chip').forEach(c=> c.classList.remove('active'));
      el.classList.add('active');
      showEditList(el.getAttribute('data-date'));
    }

    function showEditList(date){
      const list = document.getElementById('editRecordList');
      const rows = editDataByOPD.filter(r => (r.date||'').slice(0,10) === date);
      if(rows.length === 0){
        list.innerHTML = '<div class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
        return;
      }

      const stripPrice = (s) => String(s).replace(/ - \d+(?:\.\d+)? ‡∏ä‡∏¥‡πâ‡∏ô x \d+(?:\.\d+)? ‡∏ö‡∏≤‡∏ó$/, '');
      const sumFromItems = (items=[]) => items.reduce((acc, line)=>{
        const m = String(line).match(/ - (\d+(?:\.\d+)?) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+(?:\.\d+)?) ‡∏ö‡∏≤‡∏ó$/);
        if(!m) return acc;
        const qty = parseFloat(m[1]||'0');
        const price = parseFloat(m[2]||'0');
        return acc + (qty*price);
      }, 0);

      const html = rows.map(r => {
        const items = Array.isArray(r.items) ? r.items : [];
        const cleanList = items.length
          ? `<ul class="items-list">${items.map(x => `<li>${safe(stripPrice(x))}</li>`).join('')}</ul>`
          : '<div class="muted">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>';

        const total = (r.amount != null && r.amount !== '') ? Number(r.amount) : sumFromItems(items);
        const totalStr = Number.isFinite(total) ? total.toLocaleString() : '0';

        return `
          <div class="card">
            <div class="left">
              <div><strong>${safe(r.name || '-')}</strong></div>
              ${cleanList}
              <div class="total-line">‡∏£‡∏ß‡∏°: ${totalStr} ‡∏ö‡∏≤‡∏ó</div>
            </div>
            <div class="actions">
              <button type="button" class="btn btn-primary" onclick="editSelectedRecordById('${r.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button type="button" class="btn btn-danger" onclick="deleteRecordFromSupabase('${r.id}')">‡∏•‡∏ö</button>
            </div>
          </div>
        `;
      }).join('');

      list.innerHTML = html;
    }

    function findRecordInEditCacheById(id){
      return (editDataByOPD || []).find(x => String(x.id) === String(id)) || null;
    }

    function editSelectedRecordById(id){
      const rec = findRecordInEditCacheById(id);
      if(!rec) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');

      currentEditId = rec.id || null;
      document.getElementById('currentId').value = currentEditId || '';
      editRecordFromObject(rec);

      records = [];
      renderReviewSection();

      const btnSale = document.querySelector('.tab-btn');
      switchTab('tab-sale', btnSale);

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function editRecordFromObject(rec){
      document.getElementById('date').value = (rec.date||'').slice(0,10);

      const opdEl = document.getElementById('opd');
      opdEl.value = (rec.opd||'').slice(0,4);
      onOPDInput(opdEl);

      if(!customerMap[opdEl.value]){
        document.getElementById('name').value = rec.name || '';
        document.getElementById('phone').value = rec.phone || '';
      }

      document.getElementById('amount').value = rec.amount || '';
      setPayment(rec.payment === '‡∏™‡∏î' ? '‡∏™‡∏î' : '‡πÇ‡∏≠‡∏ô');
      setSumState('‡∏õ‡∏¥‡∏î');
      document.getElementById('note').value = rec.note || '';

      const list = document.getElementById('itemList');
      list.innerHTML = '';
      if((rec.items||[]).length === 0){
        list.appendChild(makeItemRow());
      }else{
        (rec.items||[]).forEach(line => {
          const row = makeItemRow();
          const m = String(line).match(/^(.*?) ?(?:\((.*?)\))? - (\d+(?:\.\d+)?) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+(?:\.\d+)?) ‡∏ö‡∏≤‡∏ó/);
          const itemSel = row.querySelector('select[name="item[]"]');
          const subSel  = row.querySelector('select[name="subitem[]"]');
          if(m){
            const main = (m[1]||'').trim();
            const sub = (m[2]||'').trim();
            const qty = m[3]||'';
            const price = m[4]||'';

            if(mainCategoryKeys().includes(main)){
              itemSel.value = main;
              updateSubOptions(itemSel, subSel);
              const allSubOptions = Array.from(subSel.options).map(o=>o.value);
              if(allSubOptions.includes(sub)){
                subSel.value = sub;
              }
            }

            row.querySelector('input[name="qty[]"]').value = qty;
            row.querySelector('input[name="price[]"]').value = price;
          }else{
            const plain = String(line).trim();
            const main = plain.split('(')[0].split('-')[0].trim();
            if(mainCategoryKeys().includes(main)){
              itemSel.value = main;
              updateSubOptions(itemSel, subSel);
            }
          }
          list.appendChild(row);
        });
      }
      recalcAmount();
      refreshActionButtonsState();
    }

    // =========================
    // Diagnostics (‡πÄ‡∏î‡∏¥‡∏°)
    // =========================
    const normName = s => String(s||'').trim().toLowerCase().replace(/\s+/g,' ');
    const onlyDigits = s => String(s||'').replace(/\D/g,'');
    const normPhone = s => {
      let d = onlyDigits(s);
      if(d.startsWith('66') && d.length>=11) d = '0' + d.slice(-9);
      return d;
    };
    const normOPD = s => String(s||'').trim().padStart(4,'0');
    const isValidPhone = p => { const d = normPhone(p); return d.length===9 || d.length===10; };
    const isValidOPDVal = o => /^\d{4}$/.test(String(o||'').trim());

    async function ensureAllSales(){
      if(allSales) return allSales;
      const r = await fetch('/api/sales');
      const data = await r.json().catch(()=>[]);
      allSales = data || [];
      return allSales;
    }

    async function runDiag(type){
      await ensureAllSales();
      const rows = diagCompute(type);
      renderDiag(type, rows);
    }

    function diagCompute(type){
      const out = [];
      const byName = new Map();
      const byPhone = new Map();
      const byOPD = new Map();
      const byTripletNorm = new Map();

      (allSales||[]).forEach(r=>{
        const nameN = normName(r.name);
        const phoneN = normPhone(r.phone);
        const opdN = normOPD(r.opd);

        if(!byName.has(nameN)) byName.set(nameN,{opds:new Set(),phones:new Set(),rows:[]});
        byName.get(nameN).opds.add(opdN); byName.get(nameN).phones.add(phoneN||''); byName.get(nameN).rows.push(r);

        if(phoneN){
          if(!byPhone.has(phoneN)) byPhone.set(phoneN,{names:new Set(),opds:new Set(),rows:[]});
          byPhone.get(phoneN).names.add(nameN); byPhone.get(phoneN).opds.add(opdN); byPhone.get(phoneN).rows.push(r);
        }

        if(!byOPD.has(opdN)) byOPD.set(opdN,{names:new Set(),phones:new Set(),rows:[]});
        byOPD.get(opdN).names.add(nameN); byOPD.get(opdN).phones.add(phoneN||''); byOPD.get(opdN).rows.push(r);

        const tripKey = `${nameN}|${phoneN}|${opdN}`;
        if(!byTripletNorm.has(tripKey)) byTripletNorm.set(tripKey,{rawKeys:new Set(),rows:[]});
        byTripletNorm.get(tripKey).rawKeys.add(`${(r.name||'').trim()}|${(r.phone||'').trim()}`);
        byTripletNorm.get(tripKey).rows.push(r);
      });

      switch(type){
        case 'missingPhone': {
          (allSales||[]).forEach(r=>{
            const d = normPhone(r.phone);
            if(!d){ out.push({id:r.id, name:r.name||'-',opd:normOPD(r.opd),phone:'-',date:r.date}); }
          });
          break;
        }
        case 'nameDifferentOPD': {
          byName.forEach((v)=>{
            const opds = Array.from(v.opds).filter(x=>x!=='0000' && x!=='');
            if(new Set(opds).size>1){
              out.push({
                name: v.rows[0]?.name || '-',
                opds: Array.from(new Set(opds)),
                phones: Array.from(v.phones).filter(Boolean),
                count: v.rows.length
              });
            }
          });
          break;
        }
        case 'phoneDifferentName': {
          byPhone.forEach((v, phoneN)=>{
            if(!phoneN) return;
            if(v.names.size>1){
              out.push({
                phone: phoneN,
                names: Array.from(v.names).map(n=>v.rows.find(r=>normName(r.name)===n)?.name || n),
                opds: Array.from(v.opds),
                count: v.rows.length
              });
            }
          });
          break;
        }
        case 'opdDifferentNamePhone': {
          byOPD.forEach((v, opdN)=>{
            if(v.names.size>1 || (v.phones.size>1 && !v.phones.has(''))){
              out.push({
                opd: opdN,
                names: Array.from(v.names).map(n=>v.rows.find(r=>normName(r.name)===n)?.name || n),
                phones: Array.from(v.phones),
                count: v.rows.length
              });
            }
          });
          break;
        }
        case 'invalidPhone': {
          (allSales||[]).forEach(r=>{
            const d = normPhone(r.phone);
            if(d && !isValidPhone(d)){
              out.push({id:r.id, name:r.name||'-',opd:normOPD(r.opd),phone:r.phone||'-',date:r.date});
            }
          });
          break;
        }
        case 'invalidOPD': {
          (allSales||[]).forEach(r=>{
            if(!isValidOPDVal(String(r.opd||''))){
              out.push({id:r.id, name:r.name||'-',opd:String(r.opd||''),norm: normOPD(r.opd),phone:r.phone||'-',date:r.date});
            }
          });
          break;
        }
        case 'splitGroups': {
          byTripletNorm.forEach((v, k)=>{
            if(v.rawKeys.size>1){
              const [nameN, phoneN, opdN] = k.split('|');
              out.push({
                name: v.rows[0]?.name || nameN,
                opd: opdN,
                phone: v.rows[0]?.phone || phoneN,
                variants: Array.from(v.rawKeys),
                count: v.rows.length
              });
            }
          });
          break;
        }
        case 'sameNameMultiPhones': {
          byName.forEach((v)=>{
            const phones = Array.from(v.phones);
            const nonEmpty = phones.filter(p=>p);
            if(nonEmpty.length>1 || (nonEmpty.length>=1 && phones.includes(''))){
              out.push({
                name: v.rows[0]?.name || '-',
                phones: phones,
                opds: Array.from(v.opds),
                count: v.rows.length
              });
            }
          });
          break;
        }
      }
      return out;
    }

    function renderDiag(type, rows){
      const head = document.getElementById('diag-head');
      const body = document.getElementById('diag-body');
      const counter = document.getElementById('diag-count');

      const headersByType = {
        missingPhone: ['‡∏ä‡∏∑‡πà‡∏≠','OPD','‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£'],
        nameDifferentOPD: ['‡∏ä‡∏∑‡πà‡∏≠','OPDs','‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ö','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'],
        phoneDifferentName: ['‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏û‡∏ö','OPDs','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'],
        opdDifferentNamePhone: ['OPD','‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏û‡∏ö','‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ö','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'],
        invalidPhone: ['‡∏ä‡∏∑‡πà‡∏≠','OPD','‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£'],
        invalidOPD: ['‡∏ä‡∏∑‡πà‡∏≠','OPD (‡πÄ‡∏î‡∏¥‡∏°)','OPD ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î','‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£'],
        splitGroups: ['‡∏ä‡∏∑‡πà‡∏≠','OPD','‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏û‡∏ö (name|phone)','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'],
        sameNameMultiPhones: ['‡∏ä‡∏∑‡πà‡∏≠','‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î','OPDs','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç']
      };

      const cols = headersByType[type] || ['‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'];
      head.innerHTML = cols.map(c=>`<th>${c}</th>`).join('');

      body.innerHTML = rows.map(r=>{
        switch(type){
          case 'missingPhone': {
            return `<tr>
              <td>${safe(r.name)}</td>
              <td>${safe(r.opd)}</td>
              <td style="color:#b91c1c">-</td>
              <td>${formatDate((r.date||'').slice(0,10))}</td>
              <td><button class="btn btn-outline" onclick="editFromDiag('${r.opd}','${r.id||''}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button></td>
            </tr>`;
          }
          case 'nameDifferentOPD': {
            const opds = (r.opds||[]).map(o=>`<button class="btn btn-outline" onclick="goEditByOPD('${o}')">OPD ${o}</button>`).join(' ');
            return `<tr>
              <td>${safe(r.name)}</td>
              <td>${safe((r.opds||[]).join(', '))}</td>
              <td>${safe((r.phones||[]).join(', ')||'-')}</td>
              <td>${r.count}</td>
              <td>${opds||'-'}</td>
            </tr>`;
          }
          case 'phoneDifferentName': {
            const opds = (r.opds||[]).map(o=>`<button class="btn btn-outline" onclick="goEditByOPD('${o}')">OPD ${o}</button>`).join(' ');
            return `<tr>
              <td>${safe(r.phone)}</td>
              <td>${safe((r.names||[]).join(', '))}</td>
              <td>${safe((r.opds||[]).join(', '))}</td>
              <td>${r.count}</td>
              <td>${opds||'-'}</td>
            </tr>`;
          }
          case 'opdDifferentNamePhone': {
            return `<tr>
              <td>${safe(r.opd)}</td>
              <td>${safe((r.names||[]).join(', '))}</td>
              <td>${safe((r.phones||[]).join(', '))}</td>
              <td>${r.count}</td>
              <td><button class="btn btn-outline" onclick="goEditByOPD('${r.opd}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç OPD ${safe(r.opd)}</button></td>
            </tr>`;
          }
          case 'invalidPhone': {
            return `<tr>
              <td>${safe(r.name)}</td>
              <td>${safe(r.opd)}</td>
              <td style="color:#b91c1c">${safe(r.phone)}</td>
              <td>${formatDate((r.date||'').slice(0,10))}</td>
              <td><button class="btn btn-outline" onclick="editFromDiag('${r.opd}','${r.id||''}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button></td>
            </tr>`;
          }
          case 'invalidOPD': {
            return `<tr>
              <td>${safe(r.name)}</td>
              <td style="color:#b91c1c">${safe(r.opd)}</td>
              <td>${safe(r.norm)}</td>
              <td>${safe(r.phone)}</td>
              <td>${formatDate((r.date||'').slice(0,10))}</td>
              <td><button class="btn btn-outline" onclick="goEditByOPD('${r.norm}')">‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î OPD ${safe(r.norm)}</button></td>
            </tr>`;
          }
          case 'splitGroups': {
            return `<tr>
              <td>${safe(r.name)}</td>
              <td>${safe(r.opd)}</td>
              <td>${safe(r.phone)}</td>
              <td>${safe((r.variants||[]).join(' | '))}</td>
              <td>${r.count}</td>
              <td><button class="btn btn-outline" onclick="goEditByOPD('${r.opd}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç OPD ${safe(r.opd)}</button></td>
            </tr>`;
          }
          case 'sameNameMultiPhones': {
            const opds = (r.opds||[]).map(o=>`<button class="btn btn-outline" onclick="goEditByOPD('${o}')">OPD ${o}</button>`).join(' ');
            return `<tr>
              <td>${safe(r.name)}</td>
              <td>${safe((r.phones||[]).map(p=>p||'(‡∏ß‡πà‡∏≤‡∏á)').join(', '))}</td>
              <td>${safe((r.opds||[]).join(', '))}</td>
              <td>${r.count}</td>
              <td>${opds||'-'}</td>
            </tr>`;
          }
          default: return `<tr><td>‚Äî</td></tr>`;
        }
      }).join('');

      document.getElementById('diag-results').style.display = 'table';
      counter.textContent = rows.length ? `‡∏û‡∏ö ${rows.length} ‡πÄ‡∏Ñ‡∏™` : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
      document.getElementById('diag-results').scrollIntoView({behavior:'smooth', block:'start'});
    }

    function goEditByOPD(opd){
      if(!isValidOPD(opd)) { alert('OPD ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ'); return; }
      const btnTab2 = document.querySelectorAll('.tab-btn')[1];
      switchTab('tab-opd', btnTab2);

      loadDatesByOPDFor(opd).then(()=>{
        const top = document.getElementById('editSection').offsetTop;
        window.scrollTo({ top: Math.max(0, top - 10), behavior: 'smooth' });
      });
    }

    function editFromDiag(opd, id){
      if(!isValidOPD(opd)) { alert('OPD ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å'); return; }
      const btnTab2 = document.querySelectorAll('.tab-btn')[1];
      switchTab('tab-opd', btnTab2);

      loadDatesByOPDFor(opd).then(()=>{
        if(id){ editSelectedRecordById(id); }
        const top = document.getElementById('editSection').offsetTop;
        window.scrollTo({ top: Math.max(0, top - 10), behavior: 'smooth' });
      });
    }

    // ‡∏õ‡∏¥‡∏î popup ‡∏î‡πâ‡∏ß‡∏¢ ESC
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        if(document.getElementById('receiptOverlay').style.display==='flex') closeReceipt();
        else if(document.getElementById('payOverlay').style.display==='flex') closePayPopup();
        else if(document.getElementById('payCaseOverlay').style.display==='flex') closeCasePaymentPopup();
      }
    });

    // =========================
    // Signature Pads (3 ‡∏ä‡πà‡∏≠‡∏á)
    // =========================
    const sigState = {
      authorized: { drawing:false, last:null },
      customer:   { drawing:false, last:null },
      receiver:   { drawing:false, last:null }
    };

    function resizeSigCanvas(canvas, ctx){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      if(rect.width === 0 || rect.height === 0) return;

      canvas.width  = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);

      ctx.setTransform(dpr,0,0,dpr,0,0);

      ctx.save();
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,rect.width,rect.height);
      ctx.restore();
    }

    function setupSigPad(key){
      const canvas = document.getElementById(`sigPad_${key}`);
      if(!canvas) return;

      const ctx = canvas.getContext('2d');
      ctx.lineWidth = 2.2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      resizeSigCanvas(canvas, ctx);

      if(canvas.dataset.bound === '1') return;
      canvas.dataset.bound = '1';

      function getPos(e){
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
      }

      function start(e){
        e.preventDefault();
        sigState[key].drawing = true;
        sigState[key].last = getPos(e);
      }
      function move(e){
        if(!sigState[key].drawing) return;
        e.preventDefault();
        const p = getPos(e);
        const last = sigState[key].last;
        ctx.beginPath();
        ctx.moveTo(last.x, last.y);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        sigState[key].last = p;
      }
      function end(){
        sigState[key].drawing = false;
        sigState[key].last = null;
      }

      canvas.addEventListener('mousedown', start);
      window.addEventListener('mousemove', move);
      window.addEventListener('mouseup', end);

      canvas.addEventListener('touchstart', start, {passive:false});
      canvas.addEventListener('touchmove', move, {passive:false});
      canvas.addEventListener('touchend', end);

      window.addEventListener('resize', ()=> resizeSigCanvas(canvas, ctx));
    }

    function clearSig(key){
      const canvas = document.getElementById(`sigPad_${key}`);
      if(!canvas) return;
      const ctx = canvas.getContext('2d');

      ctx.setTransform(1,0,0,1,0,0);
      ctx.clearRect(0,0,canvas.width,canvas.height);

      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      const dpr = window.devicePixelRatio || 1;
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }

    function initAllSigPads(){
      setupSigPad('authorized');
      setupSigPad('customer');
      setupSigPad('receiver');
    }

async function saveReceiptImage(){
  const overlay = document.getElementById('receiptOverlay');
  const box = overlay?.querySelector('.receipt-box');
  if(!box) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û');

  // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤
  const prev = {
    ovOverflow: overlay.style.overflow,
    boxMaxH: box.style.maxHeight,
    boxOverflow: box.style.overflow,
    boxHeight: box.style.height
  };

  try{
    overlay.classList.add('capture-mode');

    // ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏∑‡∏î‡πÄ‡∏ï‡πá‡∏° ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô
    overlay.style.overflow = 'visible';
    box.style.maxHeight = 'none';
    box.style.overflow = 'visible';
    box.style.height = 'auto';

    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ DOM/‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ô‡∏¥‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô
    if(document.fonts && document.fonts.ready) await document.fonts.ready;
    await new Promise(r => setTimeout(r, 80));

    const fullW = box.scrollWidth;
    const fullH = box.scrollHeight;

    const canvas = await html2canvas(box, {
      backgroundColor: '#ffffff',
      scale: Math.max(2, window.devicePixelRatio || 1),
      useCORS: true,

      // ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á element
      width: fullW,
      height: fullH,
      windowWidth: fullW,
      windowHeight: fullH,

      // ‚úÖ ‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á scroll ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤
      scrollX: 0,
      scrollY: 0
    });

    const dataUrl = canvas.toDataURL('image/png');

    const opd  = (document.getElementById('opd')?.value || '0000').trim();
    const date = (document.getElementById('date')?.value || '').trim();
    const fileName = `receipt_${opd}_${date || 'date'}.png`;

    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    a.remove();

  }catch(err){
    console.error(err);
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }finally{
    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°
    overlay.classList.remove('capture-mode');
    overlay.style.overflow = prev.ovOverflow;
    box.style.maxHeight = prev.boxMaxH;
    box.style.overflow = prev.boxOverflow;
    box.style.height = prev.boxHeight;
  }
}

// =========================
// TAB4: Slip Viewer (filter ‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ/OPD)
// ‡πÉ‡∏ä‡πâ /api/sales (‡∏î‡∏∂‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
// =========================
document.addEventListener('DOMContentLoaded', () => {
  initSlipFilters();
});

function initSlipFilters(){
  const dSel = document.getElementById('slipDay');
  const mSel = document.getElementById('slipMonth');
  const ySel = document.getElementById('slipYear');
  if(!dSel || !mSel || !ySel) return;

  // ‡∏ß‡∏±‡∏ô
  let dOpt = `<option value="">‡∏ß‡∏±‡∏ô (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>`;
  for(let d=1; d<=31; d++){
    dOpt += `<option value="${String(d).padStart(2,'0')}">${d}</option>`;
  }
  dSel.innerHTML = dOpt;

  // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  let mOpt = `<option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>`;
  for(let m=1; m<=12; m++){
    const mm = String(m).padStart(2,'0');
    mOpt += `<option value="${mm}">${m}</option>`;
  }
  mSel.innerHTML = mOpt;

  // ‡∏õ‡∏µ (‡πÉ‡∏ä‡πâ‡πÅ‡∏ô‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö rebuildYear)
  const y = new Date().getFullYear();
  let yOpt = `<option value="">‡∏õ‡∏µ (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>`;
  for(let i=y-3; i<=y+1; i++){
    yOpt += `<option value="${i}">${i}</option>`;
  }
  ySel.innerHTML = yOpt;
  ySel.value = String(y);
}

async function searchReceipts(){
  const result = document.getElementById('slipResult');
  if(!result) return;

  const opdRaw = (document.getElementById('slipOPD')?.value || '').trim();
  const day  = (document.getElementById('slipDay')?.value || '').trim();
  const month= (document.getElementById('slipMonth')?.value || '').trim();
  const year = (document.getElementById('slipYear')?.value || '').trim();

  if(opdRaw && !/^\d{4}$/.test(opdRaw)){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏ä‡πà‡∏ô 0007)');
    return;
  }

  result.innerHTML = `<div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‚Ä¶</div>`;

  try{
    const rows = await ensureAllSales();

    const filtered = (rows || []).filter(r => {
      const d = String((r.date||'')).slice(0,10);
      const [yy, mm, dd] = d.split('-');

      if(opdRaw && String(r.opd||'').trim().padStart(4,'0') !== opdRaw) return false;
      if(year && yy !== year) return false;
      if(month && mm !== month) return false;
      if(day && dd !== day) return false;
      return true;
    })
    .sort((a,b)=> new Date((b.date||'').slice(0,10)) - new Date((a.date||'').slice(0,10)));

    if(filtered.length === 0){
      result.innerHTML = `<div class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</div>`;
      return;
    }

    result.innerHTML = filtered.map(r=>{
      const date = formatDate(String(r.date||'').slice(0,10));
      const opd  = String(r.opd||'').trim().padStart(4,'0');
      const name = r.name || '-';
      const amount = Number(r.amount||0);
      const amtStr = Number.isFinite(amount) ? amount.toLocaleString() : '0';

      const dispNo = (r.disp_no || r.display_no || '').trim();
      const origNo = (r.orig_no || '').trim();
      const shownNo = dispNo || origNo || '-';

      return `
        <div class="card">
          <div class="left">
            <div><strong>${safe(name)}</strong> <span class="muted">OPD: ${safe(opd)}</span></div>
            <div class="muted">üìÖ ${safe(date)} ‚Ä¢ üí∞ ${safe(amtStr)} ‡∏ö‡∏≤‡∏ó ‚Ä¢ üßæ ${safe(shownNo)}</div>
          </div>
          <div class="actions">
            <button type="button" class="btn btn-primary" onclick="openReceiptFromRecord('${r.id}')">‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
          </div>
        </div>
      `;
    }).join('');

  }catch(err){
    console.error(err);
    result.innerHTML = `<div class="muted">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`;
    alert(err.message || '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
}


function findAnySaleById(id){
  return (allSales || []).find(x => String(x.id) === String(id)) || null;
}

function parseItemsStringToRows(items){
  // items ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô array of string: "label - qty ‡∏ä‡∏¥‡πâ‡∏ô x price ‡∏ö‡∏≤‡∏ó"
  const out = [];
  (Array.isArray(items) ? items : []).forEach(line=>{
    const m = String(line).match(/^(.*?) ?(?:\((.*?)\))? - (\d+(?:\.\d+)?) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+(?:\.\d+)?) ‡∏ö‡∏≤‡∏ó/);
    if(m){
      const main = (m[1]||'').trim();
      const sub  = (m[2]||'').trim();
      const qty  = Math.max(1, Math.floor(Number(m[3]||1)));
      const price= Math.max(0, Math.floor(Number(m[4]||0)));
      const label = sub ? `${main} (${sub})` : main;
      out.push({ label, qty, price });
    }else{
      // ‡∏ñ‡πâ‡∏≤ format ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡∏Å‡πá‡∏¢‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ 1 ‡∏ä‡∏¥‡πâ‡∏ô ‡∏£‡∏≤‡∏Ñ‡∏≤ 0
      const label = String(line||'').trim();
      if(label) out.push({ label, qty:1, price:0 });
    }
  });
  return out;
}

function buildReceiptRowsMixedFromDate(total, rows, dateISO){
  const dateStr = formatDate(String(dateISO||'').slice(0,10));
  const dist = distributeMixedAmount(total, rows);

  let tbody = '';
  dist.lines.forEach((r, idx)=>{
    const qty = Math.max(1, Math.floor(Number(r.qty||1) || 1));
    const unit = Number.isFinite(r.unit) ? r.unit : (qty ? Math.floor(r.lineTotal / qty) : Math.floor(r.lineTotal));

    tbody += `
      <tr>
        <td style="text-align:center;">${idx+1}</td>
        <td>${safe(r.label)}</td>
        <td style="text-align:center;">${qty}</td>
        <td style="text-align:right;">${unit.toLocaleString()}</td>
        <td style="text-align:right;">${Math.floor(r.lineTotal).toLocaleString()}</td>
        <td style="text-align:center;">${safe(dateStr)}</td>
        <td style="text-align:center;">${safe(dateStr)}</td>
      </tr>
    `;
  });

  return { tbody, sum: dist.total, warn: dist.warn };
}

function openReceiptFromRecord(id){
  const rec = findAnySaleById(id);
  if(!rec) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ');

  const total = Math.floor(Number(rec.amount||0));
  const rows = parseItemsStringToRows(rec.items || []);
  if(!rows.length) return alert('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î items');

  const dispNo = (rec.disp_no || rec.display_no || '').trim();
  const origNo = (rec.orig_no || '').trim();
  const showNo = dispNo ? dispNo : (origNo ? origNo.replace(/^RC-/, 'RB-') : '-');

  const receiptNoEl = document.getElementById('receiptNo');
  if(receiptNoEl) receiptNoEl.textContent = showNo;

  // ‚úÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á record
  const { tbody, sum } = buildReceiptRowsMixedFromDate(total, rows, rec.date);

  document.getElementById('receiptContent').innerHTML = `
    <table class="receipt-table">
      <thead>
        <tr>
          <th colspan="7" style="text-align:center; font-weight:900;">
            ‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå
          </th>
        </tr>
        <tr>
          <th style="width:60px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
          <th style="width:70px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th style="width:130px;">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ö‡∏≤‡∏ó)</th>
          <th style="width:120px;">‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡∏ö‡∏≤‡∏ó)</th>
          <th style="width:130px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
          <th style="width:130px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody>${tbody}</tbody>
    </table>

    <div class="receipt-total">
      ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô ${sum.toLocaleString()} ‡∏ö‡∏≤‡∏ó
    </div>

    <div class="receipt-section">
      <b>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà):</b><br>
      <textarea id="receipt_patient_info" rows="2"
        placeholder="‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤&#10;‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤"
      ></textarea>
    </div>
  `;

  const ov = document.getElementById('receiptOverlay');
  ov.style.display = 'flex';
  ov.setAttribute('aria-hidden','false');

  applySigNamesToReceipt();
  requestAnimationFrame(() => initAllSigPads());
}



document.addEventListener('DOMContentLoaded', () => {
  const ipt = document.getElementById('slipOPD');
  if(ipt){
    ipt.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); searchReceipts(); }
    });
  }
});

  </script>


</body>
</html>
