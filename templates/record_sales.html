<!DOCTYPE html>
<html lang="th">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta charset="UTF-8" />
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</title>

  <style>
    :root{
      --teal:#0f766e;
      --teal-600:#0d9488;
      --bg:#f7f7f7;
      --card:#ffffff;
      --muted:#6b7280;
      --line:#e5e7eb;
      --chip:#eef7f6;
      --danger:#c62828;
      --shadow: 0 20px 60px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background-color: var(--bg); padding: 10px 10px 140px; color:#111827 }
    h2 { text-align: center; color: var(--teal); font-size: 20px; margin: 10px 0 0 }
    .container { max-width: 880px; margin: 20px auto; background: var(--card); border-radius: 14px; padding: 22px; box-shadow: 0 6px 22px rgba(2,8,23,.06) }
    .section-title{display:flex;align-items:center;gap:8px;margin:8px 0 6px;font-weight:800;color:#0b7660}
    .section-sub{margin:0 0 10px;color:var(--muted);font-size:12px}

    .field-row{display:grid;grid-template-columns:180px 1fr;gap:12px;align-items:center;margin:8px 0}
    .field-row label{font-weight:700;font-size:14px;margin:0}
    input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; background:#fff; font-size:14px }
    input:focus, select:focus, textarea:focus{ outline: 2px solid #94d3ce; border-color: #94d3ce }
    .muted{ color: var(--muted); font-size:12px }
    .pill{background:var(--chip); border:1px solid #cfe9e6; color:#0b7660; padding:4px 8px; border-radius:999px; font-size:12px; display:inline-flex; align-items:center; gap:6px }
    .row{display:flex;gap:8px;align-items:center}
    .nowrap{flex-wrap:nowrap}
    .grow{flex:1; min-width:0}

    .btn { display:inline-flex; gap:8px; align-items:center; justify-content:center; padding: 10px 12px; border-radius: 10px; border:none; cursor:pointer; font-weight:700; font-size:14px }
    .btn-primary{ background: var(--teal-600); color:#fff }
    .btn-save{ background:#43a047; color:#fff; padding:12px 18px }
    .btn-ghost{ background:#f1f5f9 }
    .btn-danger{ background: var(--danger); color:#fff }
    .btn-outline{ background:#fff; color:#0b7660; border:1px solid #a7e1da }
    .btn:disabled{ opacity:.55; cursor:not-allowed }

    .item-row { display: grid; grid-template-columns: 1.2fr 1.2fr .7fr .6fr auto; gap: 10px; margin-top: 10px; align-items: center }
    .item-row.single{grid-template-columns: 1.2fr 1.2fr .7fr .6fr auto}
    .item-actions{display:flex;justify-content:flex-end}

    .edit-panel {background:#f9fbfb;border:1px solid #e0efef;border-radius:14px;padding:16px;margin-top:16px}
    .chips{ margin-top:8px }
    .chip{display:inline-block;padding:6px 10px;border-radius:20px;border:1px solid #cde;cursor:pointer;background:#fff;margin:4px 6px 0 0;font-size:13px}
    .chip.active{background:#0b7660;color:#fff;border-color:#0b7660}
    .card{border:1px solid var(--line);padding:12px;border-radius:12px;margin:8px 0;display:flex;justify-content:space-between;gap:12px}
    .card .left{min-width:0}
    #editRecordList .card{ font-size:14px; }
    #editRecordList .card .left strong{ font-size:14px; font-weight:700; }
    #editRecordList .items-list{ font-size:14px; margin:4px 0 0; padding-left:18px; }
    #editRecordList .items-list li{ margin:0; line-height:1.35; }
    #editRecordList .total-line{ margin-top:6px; font-weight:700; color:#0b7660; font-size:14px; }
    #editRecordList .actions .btn{ font-size:13px; padding:8px 12px; }

    table{ width:100%; border-collapse: collapse; margin-top:8px }
    th, td{ border:1px solid var(--line); padding:8px; font-size:13px; vertical-align:top }
    thead tr{ background:#f8fafc }
    .actions{ display:flex; gap:6px; justify-content:center }

    .toggle{
      position: relative; display: inline-grid; grid-template-columns: 1fr 1fr;
      align-items:center; width: 160px; height: 38px; border:1px solid #a7e1da;
      border-radius: 999px; background: transparent; overflow:hidden; user-select:none;
    }
    .toggle span{
      text-align:center; font-weight:700; font-size:14px; z-index:2;
      color:#0b7660; padding:0 4px;
    }
    .toggle .knob{
      position:absolute; top:2px; bottom:2px; width: calc(50% - 4px);
      background: rgba(13,148,136,.18); border:1px solid rgba(13,148,136,.35);
      border-radius: 999px; z-index:1; transition: transform .18s ease;
      transform: translateX(2px);
    }
    .toggle[data-side="right"] .knob{ transform: translateX(calc(100% + 2px)); }
    .toggle input{ display:none }
    .toggle[data-side="left"] span:first-child{ color:#064e3b; font-weight:800 }
    .toggle[data-side="right"] span:last-child{ color:#064e3b; font-weight:800 }

    .amount-row input{ flex:1; min-width:0 }
    .amount-row .toggle{ flex: none; }

    .center-actions{ display:flex; justify-content:center; gap:10px; margin-top:12px; flex-wrap:wrap }
    .center-actions .btn{ min-width:180px }

    .lock-badge{ cursor:pointer; }
    .lock-badge:focus{ outline:2px solid #94d3ce; }

    @media (max-width:700px){
      .field-row{grid-template-columns:130px 1fr}
      .item-row, .item-row.single{grid-template-columns:1fr}
      .item-actions{justify-content:flex-start}
      .toggle{ width: 150px; height: 36px }
    }

    .diag-panel{background:#f7fffb;border:1px solid #bfeee3;border-radius:14px;padding:16px;margin-top:20px}
    .diag-title{font-weight:800;color:#0b7660;margin:0 0 10px}
    .chip-btn{border:1px solid #a7e1da;background:#fff;color:#0b7660;border-radius:999px;padding:8px 12px;font-size:12px;font-weight:700;cursor:pointer}
    .chip-btn:hover{background:#eaf9f6}
    #diag-count{margin-left:8px;color:#0b7660;font-size:12px}
    #diag-results{width:100%;border-collapse:collapse;margin-top:10px}
    #diag-results th,#diag-results td{border:1px solid var(--line);padding:8px;font-size:12px}
    #diag-results thead tr{background:#f0fdfa}

    /* =========================
       TAB BAR
       ========================= */
    .tab-bar{
      display:flex;
      gap:8px;
      margin: 12px 0 8px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .tab-btn{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid #a7e1da;
      background:#fff;
      font-weight:900;
      cursor:pointer;
      color:#0b7660;
      font-size:13px;
      -webkit-tap-highlight-color: transparent;
    }
    .tab-btn.active{
      background: var(--teal-600);
      color:#fff;
      border-color: var(--teal-600);
    }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    /* =========================
       POPUP: ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Ñ‡∏™ + QR)
       ========================= */
    .paycase-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2400;
      padding:14px;
    }
    .paycase-box{
      width: 860px;
      max-width: 100%;
      max-height: 92vh;
      overflow:auto;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .paycase-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding-bottom:12px;
      border-bottom:1px solid var(--line);
    }
    .paycase-title{
      margin:0;
      font-weight:1000;
      font-size:18px;
      color:#0b7660;
      letter-spacing:.2px;
    }
    .paycase-sub{
      margin:6px 0 0;
      color: var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .paycase-close{
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .paycase-grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:12px;
      margin-top:14px;
      align-items:start;
    }
    @media (max-width:900px){
      .paycase-grid{ grid-template-columns: 1fr; }
    }
    .paycase-card{
      border:1px solid var(--line);
      border-radius:16px;
      background: linear-gradient(180deg, #ffffff 0%, #fbfbfb 100%);
      padding:14px;
    }
    .paycase-card h4{
      margin:0 0 10px;
      font-size:14px;
      font-weight:1000;
      color:#0b7660;
      display:flex;
      align-items:center;
      gap:8px;
    }
    /* ‡∏ó‡∏≥‡∏´‡∏±‡∏ß‡∏ö‡∏¥‡∏•‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô */
.bill-field{
  border:1px solid var(--line);
  border-radius:12px;
  padding:8px 10px;          /* ‡πÄ‡∏î‡∏¥‡∏° 10px 12px */
  background:#fff;
}
.bill-field .k{
  font-size:10px;            /* ‡πÄ‡∏î‡∏¥‡∏° 11px */
  color:var(--muted);
  font-weight:900;
}
.bill-field .v{
  margin-top:4px;            /* ‡πÄ‡∏î‡∏¥‡∏° 6px */
  font-size:13px;            /* ‡πÄ‡∏î‡∏¥‡∏° 14px */
  font-weight:900;
  color:#111827;
}

/* ‡∏•‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 2 ‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
.bill-head{
  display:grid;
  grid-template-columns: 1fr 1fr; /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 2 ‡∏ä‡πà‡∏≠‡∏á */
  gap:8px;                        /* ‡πÄ‡∏î‡∏¥‡∏° 10px */
}


    .warn{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #fecaca;
      background:#fff7f7;
      color:#991b1b;
      font-size:12px;
      font-weight:800;
      display:none;
    }

    .paycase-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
      background:#fff;
    }
    .paycase-table th, .paycase-table td{
      border:1px solid var(--line);
      padding:8px;
      vertical-align:top;
    }
    .paycase-table th{
      background:#f8fafc;
      text-align:center;
      font-weight:1000;
    }

    .sumline{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid var(--line);
      font-weight:1000;
    }
    .sumline .label{ color:#111827; }
    .sumline .value{ color:#0b7660; font-size:16px; }

    .qr-wrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      margin-top:12px;
    }
    .qr-img{
      width: 320px;
      max-width: 90%;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
      padding:10px;
    }
    .qr-hint{
      text-align:center;
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }
    .paycase-actions{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:14px;
      padding-top:12px;
      border-top:1px solid var(--line);
    }

    /* =========================
       POPUP: ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏ä‡∏±‡πâ‡∏ô 1 ‡πÄ‡∏î‡∏¥‡∏°)
       ========================= */
    .modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2500;
      padding:14px;
    }
    .modal-box{
      background:#fff;
      width:760px;
      max-width:100%;
      max-height:92vh;
      overflow:auto;
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      padding:18px;
    }
    .modal-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      padding-bottom:10px; border-bottom:1px solid var(--line);
    }
    .modal-title{font-weight:900;color:#0b7660;font-size:18px;margin:0}
    .modal-sub{margin:4px 0 0;color:var(--muted);font-size:12px}
    .modal-close{
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
    }
    .mini-grid{
      display:grid; gap:10px; margin-top:12px;
      grid-template-columns:1fr 1fr;
    }
    .mini-grid .field{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:#fbfbfb;
    }
    .mini-grid .field b{display:block;margin-bottom:4px;color:#0b7660}
    .mini-grid .field .v{font-size:14px}
    .mini-grid .field input{
      margin-top:6px;
      background:#fff;
    }
    @media (max-width:700px){
      .mini-grid{grid-template-columns:1fr}
    }
    .modal-actions{
      display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
      margin-top:14px;
    }

    /* =========================
       POPUP: ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏ä‡∏±‡πâ‡∏ô 2)
       ========================= */
    .receipt-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:3000;
      padding:14px;
    }
    .receipt-box{
      background:#fff;
      width:820px;
      max-width:100%;
      max-height:92vh;
      overflow:auto;
      border-radius:16px;
      padding:22px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      font-size:8px;
    }
    .receipt-header{
      text-align:center;
      margin-bottom:12px;
    }
    .receipt-header h2{
      margin:0;
      font-size:20px;
      font-weight:900;
      color:#111827;
    }
    .receipt-subtitle{
      margin-top:4px;
      font-weight:800;
      color:#111827;
      font-size:13px;
    }
    .receipt-clinic{
      margin-top:6px;
      font-weight:900;
      color:#0b7660;
      font-size:14px;
    }
    .receipt-small{
      font-size:11px;
      color:#374151;
      line-height:1.45;
      margin-top:6px;
    }
    .receipt-section{ margin-top:8px; }
    .receipt-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:8px;
    }
    .receipt-table th,
    .receipt-table td{
      border:1px solid #d1d5db;
      padding:6px 8px;
      vertical-align:top;
    }
    .receipt-table th{
      background:#f3f4f6;
      text-align:center;
    }
    .receipt-total{
      text-align:right;
      margin-top:10px;
      font-weight:900;
      font-size:12px;
    }
    .fineprint{
      margin-top:14px;
      font-size:10px;
      line-height:1.5;
      color:#111827;
    }

   @media print{
  body{ padding:0 !important; background:#fff !important; }

  /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô */
  body *{ visibility:hidden !important; }

  /* ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à */
  #receiptOverlay, #receiptOverlay *{ visibility:visible !important; }

  /* ‡∏ó‡∏≥ overlay ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©" ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà popup */
  #receiptOverlay{
    position: static !important;
    inset: auto !important;
    background:#fff !important;
    display:block !important;
    padding:0 !important;
  }

  /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô */
  .receipt-box{
    width: 190mm !important;
    max-height: none !important;
    overflow: visible !important;
    box-shadow:none !important;
    border-radius:0 !important;
    margin: 0 auto !important;
    padding: 12mm !important;      /* ‡∏Ç‡∏≠‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
  }

  /* ‡πÑ‡∏°‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏∏‡πà‡∏° */
  .receipt-actions, .sig-actions{ display:none !important; }

  /* ‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á/‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ */
  table, tr, td, th{ page-break-inside: avoid !important; }
  .sig-wrap, .fineprint{ page-break-inside: avoid !important; }
}



    /* ====== Signature Pad ====== */
    .sig-wrap{
      margin-top: 18px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      background:#fafafa;
    }
    .sig-grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:14px;
    }
    .sig-card{
      background:#fff;
      padding:12px;
      box-shadow:0 8px 18px rgba(2,8,23,.05);
    }
    .sig-label{
      font-size:4x;
      color:#0b7660;
      font-weight:600;
      margin-bottom:6px;
    }
    .sig-pad{
  width:100%;
  height:60px; /* ‚úÖ ‡πÄ‡∏î‡∏¥‡∏° 140px -> ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á */
  border-radius:10px;
  background:#fff;
  touch-action:none;
}
    .sig-actions{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:8px;
      margin-top:8px;
    }
    .sig-btn{
  border:1px solid #d1d5db;
  background:#fff;

  border-radius:6px;     /* ‚¨ÖÔ∏è ‡∏°‡∏∏‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
  padding:2px 6px;       /* ‚¨ÖÔ∏è ‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏•‡∏á‡∏°‡∏≤‡∏Å */
  font-size:4px;        /* ‚¨ÖÔ∏è ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
  font-weight:700;

  line-height:1.2;
  cursor:pointer;
}
    .sig-btn:hover{ background:#f3f4f6; }

    .sig-under{
      margin-top:8px;
      font-size:12px;
      font-weight:800;
      color:#111827;
      border-top:1px solid #d1d5db;
      padding-top:6px;
      min-height:18px;
      text-align:center;
    }

    @media (max-width:700px){
      .sig-grid{ grid-template-columns: 1fr; }
    }
    @media print{
      .sig-wrap{ border:none !important; background:#fff !important; padding:0 !important; }
      .sig-card{ box-shadow:none !important; border:1px solid #111 !important; }
      .sig-under{ border-top:1px solid #111 !important; }
    }

    /* ===== ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≠‡∏ô capture ‡∏£‡∏π‡∏õ ===== */
.capture-mode .receipt-actions,
.capture-mode .sig-actions,
.capture-mode button {
  display: none !important;
}

/* ‚úÖ ‡∏ï‡∏≠‡∏ô capture ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à "‡∏¢‡∏∑‡∏î‡πÄ‡∏ï‡πá‡∏°" ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô */
.capture-mode .receipt-box{
  max-height: none !important;
  overflow: visible !important;
}
.capture-mode #receiptOverlay{
  overflow: visible !important;
}

/* ‚úÖ ‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à */
#receiptOverlay .receipt-table th{
  font-size:10px !important;
}
#receiptOverlay .receipt-table td{
  font-size:10px !important;  /* ‡∏õ‡∏£‡∏±‡∏ö 9-11 ‡πÑ‡∏î‡πâ */
  padding:4px 6px !important; /* ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏•‡∏á */
}

/* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö 4 ‡πÑ‡∏°‡πà‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
#tab-settings .edit-panel{
  max-width: 760px;
  margin: 0 auto;
}

/* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á label ‡πÉ‡∏ô field-row ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏ö 4 ‡πÉ‡∏´‡πâ‡∏ô‡∏∏‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
#tab-settings .field-row{
  grid-template-columns: 120px 1fr;
}

/* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
@media (max-width:700px){
  #tab-settings .field-row{
    grid-template-columns: 1fr;
  }
}

#tab-settings .btn-danger{
  width: auto;
  min-width: 260px;
}

@media print{
  #receipt_patient_info{
    border: 1px solid #111 !important;
    border-radius: 0 !important;
    resize: none !important;
  }
}



/* ===== Receipt: patient info textarea (no box, seamless) ===== */
#receiptOverlay #receipt_patient_info{
  border: none !important;          /* ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏≠‡∏ö */
  border-radius: 0 !important;
  outline: none !important;
  background: transparent !important; /* ‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô */
  box-shadow: none !important;

  padding: 0 !important;            /* ‡πÑ‡∏°‡πà‡∏î‡∏±‡∏ô‡∏Ç‡∏≠‡∏ö */
  margin-top: 4px;

  font-size: 8px !important;        /* ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏•‡∏á */
  line-height: 1.3 !important;
  resize: none !important;

  height: auto !important;
  min-height: 32px;
}

/* ‡∏Å‡∏±‡∏ô focus ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏£‡∏≠‡∏ö */
#receiptOverlay #receipt_patient_info:focus{
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
}

/* ‡πÄ‡∏ß‡∏•‡∏≤ print ‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥ */
@media print{
  #receiptOverlay #receipt_patient_info{
    border: none !important;
    background: transparent !important;
  }
}




/* ===== Signature name input (no border, printable) ===== */
.sig-under-input{
  width: 100%;
  border: none !important;
  outline: none !important;
  background: transparent !important;
  box-shadow: none !important;

  text-align: center;
  font-size: 8px;
  font-weight: 700;
  color: #111;

  padding: 2px 0;
}

/* ‡∏Å‡∏±‡∏ô focus ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö */
.sig-under-input:focus{
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
}

/* print: ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ */
@media print{
  .sig-under-input{
    border: none !important;
    background: transparent !important;
  }
}


/* =========================
   TAB 3: CUSTOMER STATUS (3 SECTIONS)  ‚úÖ font 10px + ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á
   ========================= */

/* ‡∏ï‡∏±‡πâ‡∏á‡∏ê‡∏≤‡∏ô‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏Ç‡∏≠‡∏á Tab 3 ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á (10px) */
#tab3, .tab3, .tab-3, [data-tab="3"]{
  font-size:10px;
}

/* ‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô Tab 3 */
.status-header,
.status-header * ,
.kpi-grid, .kpi-grid * ,
.seg-actions, .seg-actions * ,
.small-table, .small-table * ,
.ent-card, .ent-card * ,
.modal3-box, .modal3-box * ,
.ar-top, .ar-top * ,
.ar-cards, .ar-cards * ,
.ar-section, .ar-section * ,
.ar-table, .ar-table * ,
.ar-modal, .ar-modal * {
  font-size:10px;
}

/* header */
.status-header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:10px;
}
.status-header .who{
  display:flex;
  flex-direction:column;
  gap:3px;
}

/* badges (‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á) */
.status-badges{display:flex;gap:5px;flex-wrap:wrap}
.badge{
  display:inline-flex;align-items:center;gap:5px;
  padding:3px 8px;border-radius:999px;
  border:1px solid var(--line);
  background:#fff;font-size:10px;font-weight:900;
  line-height:1.2;
}
.badge.ar{border-color:#fecaca;background:#fff7f7;color:#991b1b}
.badge.credit{border-color:#bae6fd;background:#f0f9ff;color:#075985}
.badge.todo{border-color:#bbf7d0;background:#f0fdf4;color:#166534}

/* KPI cards (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏¢‡∏±‡∏á‡πÄ‡∏î‡πà‡∏ô ‡πÅ‡∏ï‡πà‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á) */
.kpi-grid{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap:8px;
  margin-top:8px;
}
@media (max-width:900px){
  .kpi-grid{ grid-template-columns: 1fr; }
}
.kpi{
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px;
  background:linear-gradient(180deg,#fff 0%, #fbfbfb 100%);
}
.kpi .t{font-weight:1000;color:#0b7660;display:flex;align-items:center;gap:6px;font-size:10px}
.kpi .v{margin-top:5px;font-size:16px;font-weight:1000}
.kpi .sub{margin-top:3px;color:var(--muted);font-size:10px}

/* action buttons */
.seg-actions{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  margin-top:8px;
}
.seg-actions .btn{min-width:140px}

/* tables */
.small-table{
  width:100%;
  border-collapse:collapse;
  margin-top:8px;
  background:#fff;
}
.small-table th,.small-table td{
  border:1px solid var(--line);
  padding:6px;
  font-size:10px;
}
.small-table thead tr{background:#f8fafc}
.right{text-align:right}
.center{text-align:center}

/* entitlement cards */
.ent-card{
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  background:#fff;
  margin-top:8px;
}
.ent-top{
  display:flex;
  justify-content:space-between;
  gap:8px;
  flex-wrap:wrap;
}
.ent-name{font-weight:1000;font-size:10px}
.ent-meta{color:var(--muted);font-size:10px}
.ent-bar{
  margin-top:8px;
  height:8px;
  border-radius:999px;
  background:#eef2f7;
  overflow:hidden;
}
.ent-bar > div{
  height:100%;
  background:rgba(13,148,136,.35);
  width:0%;
}
.ent-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.ent-actions .btn{min-width:130px}

/* Modal for Tab3 */
.modal3-overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2600;
  padding:12px;
}
.modal3-box{
  width:760px;
  max-width:100%;
  max-height:92vh;
  overflow:auto;
  background:#fff;
  border-radius:14px;
  box-shadow: var(--shadow);
  padding:14px;
}
.modal3-head{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:8px;
  padding-bottom:8px;
  border-bottom:1px solid var(--line);
}
.modal3-title{font-weight:1000;color:#0b7660;font-size:12px;margin:0}
.modal3-close{
  border:1px solid var(--line);
  background:#fff;
  border-radius:8px;
  padding:6px 8px;
  cursor:pointer;
  font-weight:900;
  font-size:10px;
  line-height:1.2;
}

/* =========================
   TAB 3: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤  ‚úÖ font 10px + ‡∏õ‡∏∏‡πà‡∏°/‡∏ä‡∏¥‡∏õ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á
   ========================= */
.ar-top{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
  margin-top:8px;
}
.ar-search{
  display:flex;
  gap:6px;
  align-items:center;
  flex:1;
  min-width:220px;
}

/* chip ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
.ar-filters{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.ar-chip{
  border:1px solid #a7e1da;
  background:#fff;
  color:#0b7660;
  border-radius:999px;
  padding:6px 10px;
  font-weight:900;
  font-size:10px;
  cursor:pointer;
  line-height:1.2;
}
.ar-chip.active{
  background: var(--teal-600);
  border-color: var(--teal-600);
  color:#fff;
}

/* summary cards */
.ar-cards{
  display:grid;
  grid-template-columns: repeat(3, minmax(0,1fr));
  gap:8px;
  margin-top:10px;
}
@media (max-width:900px){
  .ar-cards{ grid-template-columns:1fr; }
}
.ar-card{
  border:1px solid var(--line);
  background: linear-gradient(180deg, #ffffff 0%, #fbfbfb 100%);
  border-radius:14px;
  padding:10px;
}
.ar-card-title{
  font-weight:1000;
  color:#0b7660;
  font-size:10px;
}
.ar-card-main{
  margin-top:5px;
  font-size:14px;
  font-weight:1100;
  color:#111827;
}
.ar-card-sub{
  margin-top:3px;
  color:var(--muted);
  font-size:10px;
  font-weight:700;
}

.ar-section{
  margin-top:12px;
  border-top:1px dashed #dbe7e5;
  padding-top:10px;
}
.ar-section-head{
  display:flex;
  gap:8px;
  align-items:flex-start;
  justify-content:space-between;
  flex-wrap:wrap;
}
.ar-section-title{
  font-weight:1100;
  color:#0b7660;
  font-size:11px;
}
.ar-table-wrap{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  overflow:auto;
  background:#fff;
}
.ar-table{
  width:100%;
  border-collapse:collapse;
  font-size:10px;
}
.ar-table th, .ar-table td{
  border:1px solid var(--line);
  padding:6px;
  vertical-align:top;
  font-size:10px;
}
.ar-table thead tr{ background:#f8fafc; }
.ar-empty{ padding:8px; font-size:10px; }

.money-red{ color:#b91c1c; font-weight:1000; }
.money-green{ color:#0b7660; font-weight:1000; }

/* Modal */
.ar-overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2600;
  padding:12px;
}
.ar-modal{
  width: 860px;
  max-width: 100%;
  max-height: 92vh;
  overflow:auto;
  background:#fff;
  border-radius:14px;
  box-shadow: var(--shadow);
  padding:14px;
}
.ar-modal-head{
  display:flex;
  justify-content:space-between;
  gap:8px;
  border-bottom:1px solid var(--line);
  padding-bottom:8px;
}
.ar-modal-title{
  font-weight:1100;
  color:#0b7660;
  font-size:12px;
}
.ar-modal-sub{
  margin-top:3px;
  color:var(--muted);
  font-size:10px;
  font-weight:700;
}
.ar-x{
  border:1px solid var(--line);
  background:#fff;
  border-radius:8px;
  padding:6px 8px;
  cursor:pointer;
  font-weight:1000;
  font-size:10px;
  line-height:1.2;
}
.ar-modal-actions{
  display:flex;
  justify-content:center;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
  padding-top:10px;
  border-top:1px solid var(--line);
}

/* ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ input/select/textarea + ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Tab3 ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏î‡πâ‡∏ß‡∏¢ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å) */
#tab3 input, #tab3 select, #tab3 textarea,
.tab3 input, .tab3 select, .tab3 textarea,
.tab-3 input, .tab-3 select, .tab-3 textarea,
[data-tab="3"] input, [data-tab="3"] select, [data-tab="3"] textarea{
  font-size:10px;
  padding:6px 8px;
  border-radius:10px;
}

/* ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏∏‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏ô Tab3 */
#tab3 .btn, #tab3 button,
.tab3 .btn, .tab3 button,
.tab-3 .btn, .tab-3 button,
[data-tab="3"] .btn, [data-tab="3"] button{
  font-size:10px;
  padding:6px 10px;
  border-radius:10px;
  min-height:28px;
}

/* ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö icon-only ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏ô‡∏¥‡∏î */
#tab3 .btn.icon, .tab3 .btn.icon, .tab-3 .btn.icon, [data-tab="3"] .btn.icon{
  padding:6px;
  min-width:28px;
}


/* =========================
   TAB 3: Font 12px + compact UI
   ‡∏ß‡∏≤‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå CSS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
   ========================= */
#tab-ar, #tab-ar *{
  font-size:12px;
  line-height:1.35;
}

/* ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ / ‡∏ã‡∏±‡∏ö */
#tab-ar .section-title{ font-size:13px; font-weight:1100; }
#tab-ar .section-sub,
#tab-ar .muted{ font-size:11px; }

/* pill/badge */
#tab-ar .pill,
#tab-ar .badge{
  font-size:11px;
  padding:5px 10px;
  border-radius:999px;
}

/* ‡∏õ‡∏∏‡πà‡∏° */
#tab-ar .btn{
  font-size:12px;
  padding:7px 10px;
  border-radius:10px;
}

/* input/select */
#tab-ar input,
#tab-ar select{
  font-size:12px;
  padding:8px 10px;
  border-radius:10px;
}

/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö 3) */
#tab-ar table th,
#tab-ar table td{
  font-size:12px;
  padding:7px;
}

  </style>
</head>

<body>
   <!-- ‚úÖ floating menu -->
{% include 'floating_menu.html' %}
  <div class="container">
    <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>

    <!-- =========================
         TAB BAR
         ========================= -->
    <div class="tab-bar" role="tablist" aria-label="‡πÅ‡∏ñ‡∏ö‡∏á‡∏≤‡∏ô">
      <button type="button" class="tab-btn active" role="tab" aria-selected="true"
              onclick="switchTab('tab-sale', this)">1) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
      <button type="button" class="tab-btn" role="tab" aria-selected="false"
              onclick="switchTab('tab-opd', this)">2) ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö OPD</button>
      <button type="button" class="tab-btn" role="tab" aria-selected="false"
              onclick="switchTab('tab-ar', this)">3) ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</button>
      <button type="button" class="tab-btn" role="tab" aria-selected="false"
        onclick="switchTab('tab-settings', this)">4) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
    </div>

    <!-- =========================
         TAB 1: DAILY SALES
         ========================= -->
    <div id="tab-sale" class="tab-content active" role="tabpanel" aria-label="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô">
      <form id="saleForm" onsubmit="return false;">
        <input type="hidden" id="currentId" value="">

        <div class="section-title">üßæ ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>

        <div class="field-row">
          <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input type="date" id="date" name="date">
        </div>

        <div class="field-row">
          <label for="opd">‡πÄ‡∏•‡∏Ç OPD</label>
          <div class="row nowrap">
            <input
              type="text" id="opd" name="opd" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç OPD 4 ‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô 0001"
              inputmode="numeric" maxlength="4" pattern="\d{4}"
              oninput="onOPDInput(this);" class="grow">
            <span class="pill">‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å</span>
          </div>
        </div>

        <div class="field-row">
          <label for="name">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô-‡∏à‡∏£‡∏¥‡∏á</label>
          <div class="row nowrap">
            <input type="text" id="name" name="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ö‡∏ß‡πå - ‡πÄ‡∏°‡∏•‡∏î‡∏≤" disabled class="grow">
            <span id="lockNameBadge" class="pill lock-badge" style="display:none;"
                  role="button" tabindex="0" aria-label="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå"
                  onclick="unlockNamePhone()">üîí ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å</span>
          </div>
        </div>

        <div class="field-row">
          <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
          <div class="row nowrap">
            <input type="tel" id="phone" name="phone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0912345678" disabled class="grow">
            <span id="lockPhoneBadge" class="pill lock-badge" style="display:none;"
                  role="button" tabindex="0" aria-label="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå"
                  onclick="unlockNamePhone()">üîí ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å</span>
          </div>
        </div>

        <div class="section-title">üß¥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>
        <div class="muted" id="catalogHint" style="margin-top:-2px;display:none;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</div>
        <div id="itemList"></div>
        <div class="row" style="margin-top:8px">
          <button type="button" class="btn btn-outline" onclick="addItemRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        </div>

        <div class="field-row">
          <label>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</label>
          <div class="row nowrap">
            <div id="sumToggle" class="toggle" role="switch" aria-checked="false" tabindex="0" data-side="left"
                 onclick="toggleSum()" onkeydown="toggleSumKey(event)">
              <span>‡∏õ‡∏¥‡∏î</span><span>‡πÄ‡∏õ‡∏¥‡∏î</span>
              <div class="knob"></div>
              <input type="hidden" id="sumHidden" value="‡∏õ‡∏¥‡∏î">
            </div>
          </div>
        </div>

        <div class="field-row">
          <label for="amount">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</label>
          <div class="row nowrap amount-row">
            <input type="number" id="amount" name="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)" step="1" min="0" class="grow">
            <div id="payToggle" class="toggle" role="switch" aria-checked="true" tabindex="0" data-side="left"
                 onclick="togglePayment()" onkeydown="togglePaymentKey(event)">
              <span>‡πÇ‡∏≠‡∏ô</span><span>‡∏™‡∏î</span>
              <div class="knob"></div>
              <input type="hidden" id="paymentHidden" value="‡πÇ‡∏≠‡∏ô">
            </div>
          </div>
        </div>

        <div class="field-row">
          <label for="note">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <textarea id="note" name="note" rows="2" placeholder=""></textarea>
        </div>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Ñ‡∏™ + QR) / ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°: ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à -->
        <div class="center-actions">
          <button type="button" id="btnPayCase" class="btn btn-primary" onclick="openCasePaymentPopup()" disabled>
            ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
          </button>

          <button type="button" id="btnPayReceipt" class="btn btn-outline" onclick="openPayPopup()" disabled>
            ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
          </button>

          <button type="button" id="btnReview" class="btn btn-outline" onclick="reviewForm()" disabled>
            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
          </button>

          <button type="button" class="btn btn-ghost" onclick="clearForm()">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
        </div>

        
      </form>

      <div id="reviewSection" style="margin-top:16px;">
        <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
      </div>
      <div class="center-actions">
        <button class="btn btn-save" id="btnSaveAll" onclick="saveAllRecords()" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
    </div>

    <!-- =========================
         TAB 2: OPD EDIT + DIAGNOSTICS
         ========================= -->
    <div id="tab-opd" class="tab-content" role="tabpanel" aria-label="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö OPD">
      <div id="editSection" class="edit-panel">
        <div class="section-title">üõ†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°</div>
        <p class="section-sub">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏Ç OPD (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å) ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
        <div class="field-row">
          <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ OPD</label>
          <div class="row nowrap">
            <input type="text" id="editOPD" class="grow"
                   placeholder="‡πÄ‡∏ä‡πà‡∏ô 0007"
                   inputmode="numeric" pattern="\d{4}" maxlength="4"
                   oninput="digitsOnly(this)">
            <button type="button" class="btn btn-outline" onclick="loadDatesByOPD()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
          </div>
        </div>
        <div id="editDateButtons" class="chips" style="margin-top:12px;"></div>
        <div id="editRecordList" style="margin-top:12px;"></div>
      </div>

      <div class="diag-panel">
        <div class="diag-title">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ <span id="diag-count"></span></div>
        <div class="chips" style="gap:8px; flex-wrap:wrap;">
          <button class="chip-btn" onclick="runDiag('missingPhone')">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</button>
          <button class="chip-btn" onclick="runDiag('nameDifferentOPD')">‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥ (‡∏ï‡πà‡∏≤‡∏á OPD)</button>
          <button class="chip-btn" onclick="runDiag('phoneDifferentName')">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ã‡πâ‡∏≥ (‡∏ï‡πà‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠)</button>
          <button class="chip-btn" onclick="runDiag('opdDifferentNamePhone')">OPD ‡∏ã‡πâ‡∏≥ (‡∏ï‡πà‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå)</button>
          <button class="chip-btn" onclick="runDiag('invalidPhone')">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å</button>
          <button class="chip-btn" onclick="runDiag('invalidOPD')">OPD ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å</button>
          <button class="chip-btn" onclick="runDiag('splitGroups')">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏ï‡∏Å (name+phone+opd ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)</button>
          <button class="chip-btn" onclick="runDiag('sameNameMultiPhones')">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå/‡∏ß‡πà‡∏≤‡∏á</button>
        </div>

        <table id="diag-results" style="display:none;">
          <thead><tr id="diag-head"></tr></thead>
          <tbody id="diag-body"></tbody>
        </table>
      </div>
    </div>


<!-- =========================
     TAB 3: CUSTOMER BALANCES (DEBT / CREDIT / PENDING)  ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ß‡∏¢ + ‡∏•‡∏î inline style
     ========================= -->
<div id="tab-ar" class="tab-content tab3" role="tabpanel" aria-label="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á/‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï/‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥">

  <div class="ar-wrap">
    <div class="ar-hero">
      <div class="ar-hero-top">
        <div>
          <div class="ar-hero-title">üìå ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πâ‡∏≤‡∏á/‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï/‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥</div>
          <div class="ar-hero-sub">
            ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå/OPD ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
          </div>
        </div>
        <div class="ar-hero-chips">
          <span class="pill pill-debt" id="arStatDebt">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏≤: 0 ‡∏Ñ‡∏ô ‚Ä¢ 0 ‡∏ö‡∏≤‡∏ó</span>
          <span class="pill pill-credit" id="arStatCredit">‡πÄ‡∏£‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: 0 ‡∏Ñ‡∏ô ‚Ä¢ 0 ‡∏ö‡∏≤‡∏ó</span>
          <span class="pill pill-pending" id="arStatPending">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥: 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </div>
      </div>

      <!-- Search row -->
      <div class="ar-search-row">
        <div class="field grow">
          <label class="muted">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
          <input id="arSearch" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå / OPD ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
        </div>

        <div class="ar-search-actions">
          <button type="button" class="btn btn-outline" onclick="AR.applySearch()">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
          <button type="button" class="btn btn-ghost" onclick="AR.clearSearch()">‡∏•‡πâ‡∏≤‡∏á</button>
        </div>
      </div>
    </div>

    <!-- ========= SECTION A: debt ========= -->
    <section class="ar-section-card">
      <div class="ar-sec-head">
        <div>
          <div class="ar-sec-title">üßæ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏≤ (‡∏´‡∏ô‡∏µ‡πâ)</div>
          <div class="ar-sec-sub">‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ß‡πà‡∏≤ ‚Äú‡∏Ñ‡πâ‡∏≤‡∏á‡∏Å‡∏µ‡πà‡∏Ñ‡∏ô ‡∏Å‡∏µ‡πà‡∏ö‡∏≤‡∏ó‚Äù ‡πÅ‡∏•‡∏∞‡πÉ‡∏Ñ‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà</div>
        </div>

        <div class="ar-sec-actions">
          <button type="button" class="btn btn-outline"
            onclick="AR.openTxModal({section:'debt', mode:'add'})">
            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏µ‡πâ
          </button>
        </div>
      </div>

      <div class="ar-table-box">
        <table class="ar-table nice-table">
          <thead>
            <tr>
              <th class="col-opd">OPD</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠</th>
              <th class="col-phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
              <th class="col-money right">‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á (‡∏ö‡∏≤‡∏ó)</th>
              <th class="col-date center">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
              <th class="col-actions center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="arDebtBody"></tbody>
        </table>
      </div>

      <div class="muted ar-empty" id="arDebtEmpty" style="display:none;">
        ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà)
      </div>
    </section>

    <!-- ========= SECTION B: credit ========= -->
    <section class="ar-section-card">
      <div class="ar-sec-head">
        <div>
          <div class="ar-sec-title">üí≥ ‡πÄ‡∏£‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô / ‡∏ß‡πâ‡∏≠‡∏¢‡πÄ‡∏ä‡∏≠‡∏£‡πå / ‡∏°‡∏±‡∏î‡∏à‡∏≥)</div>
          <div class="ar-sec-sub">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà</div>
        </div>

        <div class="ar-sec-actions">
          <button type="button" class="btn btn-outline"
            onclick="AR.openTxModal({section:'credit', mode:'topup'})">
            ‚ûï ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô/‡∏ß‡πâ‡∏≠‡∏¢‡πÄ‡∏ä‡∏≠‡∏£‡πå
          </button>
        </div>
      </div>

      <div class="ar-table-box">
        <table class="ar-table nice-table">
          <thead>
            <tr>
              <th class="col-opd">OPD</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠</th>
              <th class="col-phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
              <th class="col-money right">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ö‡∏≤‡∏ó)</th>
              <th class="col-date center">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
              <th class="col-actions center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="arCreditBody"></tbody>
        </table>
      </div>

      <div class="muted ar-empty" id="arCreditEmpty" style="display:none;">
        ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô/‡∏ß‡πâ‡∏≠‡∏¢‡πÄ‡∏ä‡∏≠‡∏£‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà)
      </div>
    </section>

    <!-- ========= SECTION C: pending ========= -->
    <section class="ar-section-card">
      <div class="ar-sec-head">
        <div>
          <div class="ar-sec-title">üß¥ ‡πÄ‡∏£‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ä‡∏¥‡πâ‡∏ô)</div>
          <div class="ar-sec-sub">‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏•‡∏¢‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏Å‡∏µ‡πà‡∏ä‡∏¥‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>
        </div>

        <div class="ar-sec-actions">
          <button type="button" class="btn btn-outline"
            onclick="AR.openTxModal({section:'pending', mode:'add'})">
            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå/‡πÅ‡∏û‡∏Å‡πÄ‡∏Å‡∏à
          </button>
        </div>
      </div>

      <div class="ar-table-box">
        <table class="ar-table nice-table">
          <thead>
            <tr>
              <th class="col-opd">OPD</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠</th>
              <th class="col-phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
              <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th class="col-unit center">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
              <th class="col-qty center">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
              <th class="col-date center">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
              <th class="col-actions center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="arPendingBody"></tbody>
        </table>
      </div>

      <div class="muted ar-empty" id="arPendingEmpty" style="display:none;">
        ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå/‡πÅ‡∏û‡∏Å‡πÄ‡∏Å‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà)
      </div>
    </section>

  </div>
</div>

<!-- =========================
     MODAL: ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ + ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (TAB 3)  ‚úÖ ‡∏™‡∏ß‡∏¢ + 10px friendly
     ========================= -->
<div id="arTxOverlay" class="modal-overlay arTx" aria-hidden="true">
  <div class="modal-box arTx-box" role="dialog" aria-modal="true" aria-label="‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á/‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï/‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥">

    <div class="modal-head">
      <div>
        <div class="modal-title" id="arTxTitle">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        <div class="modal-sub" id="arTxSub">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
      </div>
      <button class="modal-close" onclick="AR.closeTxModal()">‚úï</button>
    </div>

    <!-- header customer -->
    <div class="mini-grid arTx-kpi">
      <div class="field">
        <b>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</b>
        <div class="v" id="arTxName">-</div>
        <div class="muted">
          OPD: <span id="arTxOPD">-</span> ‚Ä¢ ‡πÄ‡∏ö‡∏≠‡∏£‡πå: <span id="arTxPhone">-</span>
        </div>
      </div>

      <div class="field">
        <b>‡∏¢‡∏≠‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</b>
        <div class="v arTx-balance" id="arTxBalance">0</div>
        <div class="muted" id="arTxBalanceHint">‚Äî</div>
      </div>
    </div>

    <!-- form -->
    <div class="edit-panel arTx-panel">
      <div class="section-title">‚úçÔ∏è ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>

      <div class="field-row">
        <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
        <div class="row nowrap">
          <input id="arTxFind" class="grow" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå/OPD ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">
          <button class="btn btn-outline" type="button" onclick="AR.pickFirstMatch()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        </div>
      </div>

      <div class="field-row">
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <input id="arTxDate" type="date">
      </div>

      <div class="field-row" id="arTxAmountRow">
        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
        <input id="arTxAmount" type="number" step="1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10000">
      </div>

      <div class="field-row" id="arTxPayRow">
        <label>‡∏ß‡∏¥‡∏ò‡∏µ</label>
        <select id="arTxPayMethod">
          <option value="‡πÇ‡∏≠‡∏ô">‡πÇ‡∏≠‡∏ô</option>
          <option value="‡∏™‡∏î">‡∏™‡∏î</option>
        </select>
      </div>

      <div class="field-row" id="arTxCatRow" style="display:none;">
        <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
        <select id="arTxCategory" onchange="AR.onCatChange()">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î --</option>
        </select>
      </div>

      <div class="field-row" id="arTxProductRow" style="display:none;">
        <label>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
        <select id="arTxProduct">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>
        </select>
      </div>
      
      <input type="hidden" id="arTxItem">


      <div class="field-row" id="arTxUnitRow" style="display:none;">
        <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
        <select id="arTxUnit">
          <option value="‡∏Ñ‡∏£‡∏±‡πâ‡∏á">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</option>
          <option value="‡∏ä‡∏¥‡πâ‡∏ô">‡∏ä‡∏¥‡πâ‡∏ô</option>
        </select>
      </div>

      <div class="field-row" id="arTxQtyRow" style="display:none;">
        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
        <input id="arTxQty" type="number" step="1" min="1" value="1">
      </div>

      <div class="field-row">
        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <input id="arTxNote" type="text" placeholder="‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á/‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
      </div>

      <div class="center-actions arTx-actions">
        <button type="button" class="btn btn-primary" onclick="AR.submitTx()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button type="button" class="btn btn-ghost" onclick="AR.closeTxModal()">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>

    <!-- history -->
    <div class="edit-panel arTx-panel">
      <div class="section-title">üïò ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô)</div>
      <div class="muted" id="arTxHistEmpty" style="display:none;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>

      <div class="ar-table-box">
        <table id="arTxHistTable" class="ar-table nice-table">
          <thead>
            <tr>
              <th class="col-date center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th class="col-type center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
              <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
              <th class="col-money right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            </tr>
          </thead>
          <tbody id="arTxHistBody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>





<!-- =========================
     TAB 4: SETTINGS (REBUILD DISPLAY RECEIPTS)
     ========================= -->
<div id="tab-settings" class="tab-content" role="tabpanel" aria-label="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à">
  <div class="edit-panel" style="margin-top:0;">
    <div class="section-title">üß© ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (Display Number)</div>
    <p class="section-sub">
      ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏î‡∏á‡∏à‡∏∞ ‚Äú‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡∏°‡πà‚Äù ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ issued ‡πÉ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (RB-YYYY-XXXX)
    </p>

    <div class="field-row">
      <label for="rebuildYear">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</label>
      <select id="rebuildYear"></select>
    </div>

    <div class="center-actions" style="justify-content:flex-start;">
      <button type="button" class="btn btn-danger" onclick="rebuildDisplayReceipts()">
        ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡∏°‡πà (Rebuild Display)
      </button>
    </div>

    <div class="muted" style="margin-top:10px;">
      ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏•‡∏Ç RC (Original) ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏∞‡∏ó‡∏ö ‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
    </div>
    <div class="edit-panel" style="margin-top:14px;">
    <div class="section-title">üßæ ‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div>
<p class="section-sub">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å ‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ/OPD ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°</p>

    <div class="field-row">
      <label for="slipOPD">OPD</label>
      <input type="text" id="slipOPD" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0007" inputmode="numeric" maxlength="4" oninput="digitsOnly(this)">
    </div>

    <div class="field-row">
      <label>‡∏ß‡∏±‡∏ô / ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô / ‡∏õ‡∏µ</label>
      <div class="row nowrap">
        <select id="slipDay" class="grow"></select>
        <select id="slipMonth" class="grow"></select>
        <select id="slipYear" class="grow"></select>
       <button type="button" class="btn btn-outline" onclick="searchReceipts()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>

      </div>
    </div>

    <div id="slipResult" style="margin-top:12px;"></div>
  </div>
  </div>
</div>
  


  <!-- =========================
       POPUP: ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ + QR)  ‚úÖ ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏á API
       ========================= -->
  <div id="payCaseOverlay" class="paycase-overlay" aria-hidden="true">
    <div class="paycase-box" role="dialog" aria-modal="true" aria-label="‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô">
      <div class="paycase-head">
        <div>
          <div class="paycase-title">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
          <div class="paycase-sub">
            
          </div>
        </div>
        <button class="paycase-close" onclick="closeCasePaymentPopup()">‚úï</button>
      </div>

      <div class="paycase-grid">
        <div class="paycase-card">
          <h4>üßæ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•</h4>

          <div class="bill-head">
  <div class="bill-field">
    <div class="k">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</div>

    <div class="v" id="pc_name">-</div>
  </div>

  <div class="bill-field">
    <div class="k">OPD</div>
    <div class="v" id="pc_opd">-</div>
  </div>
</div>


          <div class="warn" id="pc_warn"></div>

          <h4 style="margin-top:14px;">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ <span class="muted" id="pc_itemCount"></span></h4>

          <div id="pc_tableWrap"></div>

          <div class="sumline">
            <div class="label">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
            <div class="value" id="pc_total">0</div>
          </div>
          
        </div>

        <div class="paycase-card">
          <h4>üí≥ ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h4>

          <div class="qr-wrap">
            <img class="qr-img" src="{{ url_for('static', filename='icon/bank.png') }}" alt="QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô">

            
          </div>

          <div class="paycase-actions">
            <button class="btn btn-outline" onclick="closeCasePaymentPopup()">‡∏õ‡∏¥‡∏î</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================
       POPUP ‡∏ä‡∏±‡πâ‡∏ô 1: ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÄ‡∏î‡∏¥‡∏°)
       ========================= -->
  <div id="payOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" aria-label="‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à">
      <div class="modal-head">
        <div>
          <div class="modal-title">‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div>
          <div class="modal-sub">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå</div>
        </div>
        <button class="modal-close" onclick="closePayPopup()">‚úï</button>
      </div>

      <div class="mini-grid">
        <div class="field">
          <b>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</b>
          <div class="v" id="pay_name">-</div>
          <div class="muted" id="pay_phone">-</div>
        </div>
        <div class="field">
          <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</b>
          <div class="v" id="pay_date">-</div>
          <div class="muted" id="pay_method">-</div>
        </div>
        <div class="field">
          <b>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</b>
          <div class="v" id="pay_total" style="font-weight:900;font-size:18px;color:#0b7660">0</div>
          <div class="muted">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á ‚Äú‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‚Äù</div>
        </div>

        <div class="field" style="grid-column:1/-1;">
          <b>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà)</b>
<textarea
  id="pay_note_input"
  rows="3"
  placeholder="‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤
‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤"
  style="width:100%;margin-top:6px;border:1px solid #d1d5db;border-radius:10px;padding:8px;font-size:14px;resize:vertical;"
></textarea>
        </div>
      </div>

      <div class="field" style="margin-top:6px;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fbfbfb;">
        <b style="display:block;color:#0b7660;margin-bottom:6px;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ï‡πâ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</b>
        <div class="row" style="flex-wrap:wrap;gap:10px;">
          <div class="grow">
            <label class="muted">1) ‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏≠‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</label>
            <input id="sig_authorized" type="text" value="‡∏û‡∏ç.‡∏õ‡∏¥‡∏¢‡∏∞‡∏é‡∏≤ ‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡∏´‡∏•‡∏ß‡∏á" readonly>

          </div>
          <div class="grow">
            <label class="muted">2) ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
            <input id="sig_customer" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£">
          </div>
          <div class="grow">
            <label class="muted">3) ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</label>
            <input id="sig_receiver" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô">
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closePayPopup()">‡∏Å‡∏•‡∏±‡∏ö</button>
        <button class="btn btn-primary" onclick="openReceiptFromPay()">‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°</button>
      </div>
    </div>
  </div>

  <!-- =========================
       POPUP ‡∏ä‡∏±‡πâ‡∏ô 2: ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°
       ========================= -->
  <div id="receiptOverlay" class="receipt-overlay" aria-hidden="true">
    <div class="receipt-box">
      <div class="receipt-header">
        <h2>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô)</h2>
        <div class="receipt-subtitle">‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</div>
        <div class="receipt-clinic">‡∏´‡∏°‡∏≠‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏°‡∏µ‡πà ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏° ‡∏•‡∏≥‡∏û‡∏π‡∏ô ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï 5110100116</div>
        <div class="receipt-small">
          ‡∏û‡∏ç.‡∏õ‡∏¥‡∏¢‡∏∞‡∏é‡∏≤ ‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡∏´‡∏•‡∏ß‡∏á ‡∏ß.51308<br>
          186/4 ‡∏°.5 ‡∏ï.‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏¢‡∏≠‡∏á ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏•‡∏≥‡∏û‡∏π‡∏ô 51000<br>
          ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå 0614296596
        </div>
        <div style="margin-top:10px; font-size:8px; font-weight:900; color:#111827;"> ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: <span id="receiptNo">-</span>   &nbsp;&nbsp;|&nbsp;&nbsp;   ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: <span id="receiptIssueDate">-</span></div>
 </div> 
      

      <div id="receiptContent"></div>

      <div class="fineprint">
        <b>‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</b><br>
        (1) ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏à‡πá‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏î‡πâ<br>
        (2) ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏¥‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£ ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡πÑ‡∏°‡πà‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏´‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏•‡∏á‡πÑ‡∏ß‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏°‡∏Ñ‡∏ß‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏≠‡∏±‡∏ô‡∏≠‡∏≤‡∏à‡∏Å‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡πÅ‡∏Å‡πà‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ß‡πà‡∏≤‡∏´‡∏≤‡∏Å‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
      </div>
      <div class="fineprint" style="margin-top:14px;">
        <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b><br>
        ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πà‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ
      </div>

      <div class="sig-wrap">
        <div class="sig-grid">
          <div class="sig-card">
            <div class="sig-label">1) ‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏≠‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</div>
            <canvas id="sigPad_authorized" class="sig-pad"></canvas>
            <div class="sig-actions">
              <button type="button" class="sig-btn" onclick="clearSig('authorized')">‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
            <input  class="sig-under-input"  id="sigUnder_authorized"  type="text"  value="‡∏û‡∏ç.‡∏õ‡∏¥‡∏¢‡∏∞‡∏é‡∏≤ ‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡∏´‡∏•‡∏ß‡∏á"  readonly>
          </div>

          <div class="sig-card">
            <div class="sig-label">2) ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
            <canvas id="sigPad_customer" class="sig-pad"></canvas>
            <div class="sig-actions">
              <button type="button" class="sig-btn" onclick="clearSig('customer')">‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
            <input  class="sig-under-input"  id="sigUnder_customer"  type="text"  placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠">
          </div>

          <div class="sig-card">
            <div class="sig-label">3) ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>
            <canvas id="sigPad_receiver" class="sig-pad"></canvas>
            <div class="sig-actions">
              <button type="button" class="sig-btn" onclick="clearSig('receiver')">‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
            <input   class="sig-under-input"  id="sigUnder_receiver"  type="text"  placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠">
          </div>
        </div>
      </div>

      

      <div class="receipt-actions" style="display:flex;justify-content:center;gap:10px;margin-top:14px;flex-wrap:wrap;">
  <button class="btn btn-outline" onclick="closeReceipt()">‡∏õ‡∏¥‡∏î</button>
  <button class="btn btn-outline" onclick="saveReceiptImage()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û</button>
  <button class="btn btn-primary" onclick="window.print()">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
</div>
  </div>
</div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // =========================
    // Tabs
    // =========================
    function switchTab(id, btn){
      document.querySelectorAll('.tab-btn').forEach(b=>{
        b.classList.remove('active');
        b.setAttribute('aria-selected','false');
      });
      document.querySelectorAll('.tab-content').forEach(t=> t.classList.remove('active'));

      const panel = document.getElementById(id);
      if(panel) panel.classList.add('active');

      if(btn){
        btn.classList.add('active');
        btn.setAttribute('aria-selected','true');
      }

      const container = document.querySelector('.container');
      if(container) container.scrollIntoView({behavior:'smooth', block:'start'});
    }

    // =========================
    // Helpers
    // =========================
    function safe(v){
      const map = {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
      return (v==null?'':String(v)).replace(/[&<>"']/g, s=>map[s]);
    }
    function nl2brSafe(text){
      return safe(text).replace(/\n/g, "<br>");
    }
    function formatDate(dateStr){
      if(!dateStr) return '';
      const [y,m,d] = dateStr.split('-');
      return `${d}/${m}/${y}`;
    }

    // =========================
    // ‚úÖ Product Catalog from Supabase: /api/products_map
    // =========================
    const PROMO_CAT_NAME = '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©';
    let subOptionsMap = {};

    async function loadCatalog(){
      const hint = document.getElementById('catalogHint');
      if(hint) hint.style.display = 'block';

      const res = await fetch('/api/products_map');
      const data = await res.json().catch(()=> ({}));
      if(!res.ok) throw new Error(data.error || '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

      subOptionsMap = data.map || {};
      if(!subOptionsMap['‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©']){
        subOptionsMap['‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©'] = [];
      }

      refreshAllItemMainSelects();
      if(hint) hint.style.display = 'none';
    }

    function mainCategoryKeys(){
      const keys = Object.keys(subOptionsMap || {}).filter(k => k !== PROMO_CAT_NAME);
      return [...keys, PROMO_CAT_NAME].filter(Boolean);
    }

    function buildMainOptionsHTML(){
      const keys = mainCategoryKeys();
      if(!keys.length){
        return `<option value="">-- (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤) --</option>`;
      }
      return `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å --</option>` +
        keys.map(k=>`<option value="${safe(k)}">${safe(k)}</option>`).join('');
    }

    function updateSubOptions(itemSelect, subSelect){
      const selectedCatName = itemSelect.value || '';
      let options = (subOptionsMap && subOptionsMap[selectedCatName]) ? subOptionsMap[selectedCatName] : [];

      if(selectedCatName === PROMO_CAT_NAME){
        options = Object.entries(subOptionsMap || {})
          .filter(([k]) => k !== PROMO_CAT_NAME)
          .flatMap(([_, arr]) => arr || []);
      }

      const uniqNames = [];
      const seen = new Set();

      (options || []).forEach(o=>{
        const n = String((typeof o === 'string') ? o : (o?.name || '')).trim();
        if(!n) return;
        if(seen.has(n)) return;
        seen.add(n);
        uniqNames.push(n);
      });

      subSelect.innerHTML =
        '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>' +
        uniqNames.map(n => `<option value="${safe(n)}">${safe(n)}</option>`).join('');

      subSelect.value = '';
    }

    function refreshAllItemMainSelects(){
      document.querySelectorAll('select[name="item[]"]').forEach(sel=>{
        const prev = sel.value;
        sel.innerHTML = buildMainOptionsHTML();
        if(prev && mainCategoryKeys().includes(prev)){
          sel.value = prev;
          const subSel = sel.nextElementSibling;
          if(subSel && subSel.tagName === 'SELECT'){
            updateSubOptions(sel, subSel);
          }
        }
      });
    }

    // =========================
    // ---------- State ----------
    // =========================
    let records = [];
    let customerMap = {};
    let currentEditId = null;
    let editDataByOPD = [];
    let manualUnlockNamePhone = false;
    let lastOPDForLock = '';
    let allSales = null;

    // ---------- Prefill customers ----------
    fetch('/api/customers').then(r=>r.json()).then(data=>{
      (data||[]).forEach(c=>{
        if(c.opd){ customerMap[c.opd] = {name:c.name||'', phone:c.phone||''}; }
      });
    }).catch(()=>{});

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', async () => {
      try{
        await loadCatalog();
      }catch(e){
        console.error(e);
        alert(e.message || '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }

      initFirstRow();
      initDateToday();

      const ipt = document.getElementById('editOPD');
      if (ipt) {
        ipt.addEventListener('keydown', (e)=>{
          if (e.key === 'Enter') { e.preventDefault(); loadDatesByOPD(); }
        });
      }

      ['lockNameBadge','lockPhoneBadge'].forEach(id=>{
        const el = document.getElementById(id);
        if(el){
          el.addEventListener('keydown', (e)=>{
            if(e.key==='Enter' || e.key===' '){ e.preventDefault(); unlockNamePhone(); }
          });
        }
      });
  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  const amt = document.getElementById('amount');
  if (amt) {
    amt.addEventListener('input', refreshActionButtonsState);
    amt.addEventListener('change', refreshActionButtonsState);
  }

      recalcAmount();
      refreshActionButtonsState();
    });

    initRebuildYearDropdown();
function initRebuildYearDropdown(){
  const sel = document.getElementById('rebuildYear');
  if(!sel) return;

  const y = new Date().getFullYear();
  const years = [];
  for(let i=y-3; i<=y+1; i++) years.push(i);

  sel.innerHTML = years.map(v=>`<option value="${v}">${v}</option>`).join('');
  sel.value = String(y);
}


async function rebuildDisplayReceipts(){
  const sel = document.getElementById('rebuildYear');
  const year = Number(sel?.value || 0);
  if(!year) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ');

  if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ ${year}?`)) return;

  try{
    const res = await fetch('/api/rebuild_display_receipts', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ year })
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok || data.success !== true){
      throw new Error(data.error || '‡∏à‡∏±‡∏î‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
    alert(`‚úÖ ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${data.count || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
  }catch(e){
    console.error(e);
    alert(`‚ùå ${e.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`);
  }
}


    // =========================
    // ---------- UI helpers ----------
    // =========================
    function digitsOnly(el){ el.value = (el.value || '').replace(/\D/g,'').slice(0,4); }
    function isValidOPD(opd){ return /^\d{4}$/.test(opd||''); }

    function unlockNamePhone(){
      manualUnlockNamePhone = true;
      const nameEl  = document.getElementById('name');
      const phoneEl = document.getElementById('phone');
      const lockName  = document.getElementById('lockNameBadge');
      const lockPhone = document.getElementById('lockPhoneBadge');
      nameEl.disabled = false; phoneEl.disabled = false;
      nameEl.readOnly = false; phoneEl.readOnly = false;
      lockName.style.display = 'none'; lockPhone.style.display = 'none';
      setTimeout(()=> nameEl.focus(), 0);
    }

    function onOPDInput(el){
      digitsOnly(el);
      document.getElementById('btnReview').disabled = !isValidOPD(el.value);

      const nameEl = document.getElementById('name');
      const phoneEl = document.getElementById('phone');
      const lockName = document.getElementById('lockNameBadge');
      const lockPhone = document.getElementById('lockPhoneBadge');

      if(!isValidOPD(el.value)){
        manualUnlockNamePhone = false;
        lastOPDForLock = '';
        nameEl.value=''; phoneEl.value='';
        nameEl.disabled = true; phoneEl.disabled = true;
        nameEl.readOnly = false; phoneEl.readOnly = false;
        lockName.style.display='none'; lockPhone.style.display='none';
        refreshActionButtonsState();
        return;
      }

      const opd = el.value;
      if(opd !== lastOPDForLock){
        manualUnlockNamePhone = false;
        lastOPDForLock = opd;
      }

      const c = customerMap[opd];
      if(c && !manualUnlockNamePhone){
        nameEl.value = c.name||''; phoneEl.value = c.phone||'';
        nameEl.disabled = true; phoneEl.disabled = true;
        nameEl.readOnly = true; phoneEl.readOnly = true;
        lockName.style.display='inline-flex'; lockPhone.style.display='inline-flex';
      }else{
        nameEl.disabled = false; phoneEl.disabled = false;
        nameEl.readOnly = false; phoneEl.readOnly = false;
        lockName.style.display='none'; lockPhone.style.display='none';
        if(c && manualUnlockNamePhone && !nameEl.value && !phoneEl.value){
          nameEl.value = c.name || '';
          phoneEl.value = c.phone || '';
        }
      }
      refreshActionButtonsState();
    }

    /* ----- Toggle utilities ----- */
    function setToggle(el, side){
      el.setAttribute('data-side', side);
      el.setAttribute('aria-checked', side==='right' ? 'true':'false');
    }

    function getPayment(){ return document.getElementById('paymentHidden').value || '‡πÇ‡∏≠‡∏ô'; }
    function setPayment(val){
      const toggle = document.getElementById('payToggle');
      const hidden = document.getElementById('paymentHidden');
      if(val === '‡∏™‡∏î'){ setToggle(toggle, 'right'); hidden.value = '‡∏™‡∏î'; }
      else { setToggle(toggle, 'left'); hidden.value = '‡πÇ‡∏≠‡∏ô'; }
      refreshActionButtonsState();
    }
    function togglePayment(){ setPayment(getPayment() === '‡πÇ‡∏≠‡∏ô' ? '‡∏™‡∏î' : '‡πÇ‡∏≠‡∏ô'); }
    function togglePaymentKey(e){
      if([' ','Enter','ArrowLeft','ArrowRight'].includes(e.key)){
        e.preventDefault();
        if(e.key==='ArrowLeft'){ setPayment('‡πÇ‡∏≠‡∏ô'); }
        else if(e.key==='ArrowRight'){ setPayment('‡∏™‡∏î'); }
        else { togglePayment(); }
      }
    }

    function getSumState(){ return document.getElementById('sumHidden').value || '‡∏õ‡∏¥‡∏î'; }
    function setSumState(val){
      const toggle = document.getElementById('sumToggle');
      const hidden = document.getElementById('sumHidden');
      if(val === '‡πÄ‡∏õ‡∏¥‡∏î'){ setToggle(toggle, 'right'); hidden.value = '‡πÄ‡∏õ‡∏¥‡∏î'; recalcAmount(); }
      else { setToggle(toggle, 'left'); hidden.value = '‡∏õ‡∏¥‡∏î'; }
      refreshActionButtonsState();
    }
    function toggleSum(){ setSumState(getSumState() === '‡πÄ‡∏õ‡∏¥‡∏î' ? '‡∏õ‡∏¥‡∏î' : '‡πÄ‡∏õ‡∏¥‡∏î'); }
    function toggleSumKey(e){
      if([' ','Enter','ArrowLeft','ArrowRight'].includes(e.key)){
        e.preventDefault();
        if(e.key==='ArrowLeft'){ setSumState('‡∏õ‡∏¥‡∏î'); }
        else if(e.key==='ArrowRight'){ setSumState('‡πÄ‡∏õ‡∏¥‡∏î'); }
        else { toggleSum(); }
      }
    }

    // =========================
    // Items
    // =========================
    function makeItemRow(){
      const row = document.createElement('div');
      row.className = 'item-row single';
      row.innerHTML = `
        <select name="item[]">
          ${buildMainOptionsHTML()}
        </select>
        <select name="subitem[]"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option></select>
        <input type="number" name="price[]" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" step="1" min="0">
        <input type="number" name="qty[]" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" step="1" min="1" value="1">
        <div class="item-actions">
          <button type="button" class="btn btn-ghost">‡∏•‡∏ö</button>
        </div>
      `;

      const mainSel = row.querySelector('select[name="item[]"]');
      const subSel  = row.querySelector('select[name="subitem[]"]');
      const priceEl = row.querySelector('input[name="price[]"]');
      const qtyEl   = row.querySelector('input[name="qty[]"]');
      const delBtn  = row.querySelector('.item-actions button');

      mainSel.addEventListener('change', ()=>{
        updateSubOptions(mainSel, subSel);
        recalcAmount();
        refreshActionButtonsState();
      });

      subSel.addEventListener('change', ()=>{
        refreshActionButtonsState();
      });

      priceEl.addEventListener('input', ()=> { recalcAmount(); refreshActionButtonsState(); });
      qtyEl.addEventListener('input', ()=> { recalcAmount(); refreshActionButtonsState(); });

      delBtn.addEventListener('click', ()=> removeItemRow(delBtn));
      return row;
    }

    function initFirstRow(){
      const list = document.getElementById('itemList');
      list.innerHTML = '';
      list.appendChild(makeItemRow());
      setPayment('‡πÇ‡∏≠‡∏ô');
      setSumState('‡∏õ‡∏¥‡∏î');
      refreshActionButtonsState();
    }

    function addItemRow(){
      const list = document.getElementById('itemList');
      list.appendChild(makeItemRow());
      refreshActionButtonsState();
    }

    function removeItemRow(btn){
      const row = btn.closest('.item-row');
      const list = document.getElementById('itemList');
      if(list.children.length>1){
        row.remove();
        recalcAmount();
      }
      refreshActionButtonsState();
    }

    function initDateToday(){
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      document.getElementById('date').value = `${d.getFullYear()}-${mm}-${dd}`;
    }

    // =========================
    // ‚úÖ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‚Äù ‡πÅ‡∏•‡∏∞ ‚Äú‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‚Äù
    // - OPD ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á 4 ‡∏´‡∏•‡∏±‡∏Å
    // - amount > 0
    // - ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å main ‡πÅ‡∏•‡πâ‡∏ß)
    // =========================
    function hasAtLeastOneMainSelected(){
      const mains = Array.from(document.querySelectorAll('select[name="item[]"]'));
      return mains.some(sel => String(sel.value || '').trim() !== '');
    }

    function refreshActionButtonsState(){
      const opdVal = (document.getElementById('opd').value||'').trim();
      const amount = Number(document.getElementById('amount').value||0);

      const ok = isValidOPD(opdVal)
        && Number.isFinite(amount)
        && amount > 0
        && hasAtLeastOneMainSelected();

      document.getElementById('btnPayCase').disabled = !ok;
      document.getElementById('btnPayReceipt').disabled = !ok;
    }

    // =========================
    // Auto-sum
    // =========================
    function recalcAmount(){
      if(getSumState() !== '‡πÄ‡∏õ‡∏¥‡∏î') return;
      const prices = document.querySelectorAll('input[name="price[]"]');
      const qtys   = document.querySelectorAll('input[name="qty[]"]');
      let total = 0;
      for(let i=0;i<prices.length;i++){
        const p = Number(prices[i].value==='' ? 0 : prices[i].value);
        const q = Number(qtys[i].value||0);
        total += p*q;
      }
      document.getElementById('amount').value = (Number.isInteger(total)? total : Math.round(total));
      refreshActionButtonsState();
    }

    function clearForm(){
      document.getElementById('saleForm').reset();
      initDateToday();
      initFirstRow();
      manualUnlockNamePhone = false;
      lastOPDForLock = '';
      onOPDInput(document.getElementById('opd'));
      document.getElementById('btnReview').disabled = true;
      recalcAmount();
      refreshActionButtonsState();
    }

    // =========================
    // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° (main+sub+qty+price)
    // =========================
    // =========================
    // ‚úÖ 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏µ‡∏¢‡πå)
    // =========================
    function collectItemsFromForm(){
      const itemNames = document.querySelectorAll('select[name="item[]"]');
      const itemSubs  = document.querySelectorAll('select[name="subitem[]"]');
      const itemPrices= document.querySelectorAll('input[name="price[]"]');
      const itemQtys  = document.querySelectorAll('input[name="qty[]"]');

      const items = [];
      for(let i=0; i<itemNames.length; i++){
        const main = (itemNames[i].value||'').trim();
        if(!main) continue;

        const sub  = (itemSubs[i].value||'').trim();
        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏Å‡πá‡πÄ‡∏≠‡∏≤ 0)
        const qty  = Math.max(1, Math.floor(Number(itemQtys[i].value||1) || 1));
        const price = Math.max(0, Math.floor(Number(itemPrices[i].value||0) || 0));

        const label = sub ? `${main} (${sub})` : main;
        
        // ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô Object ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
        items.push({ label, qty, price });
      }
      return items;
    }

   // =========================================================
    // üü¢ 2. ‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≤‡∏Ñ‡∏≤ (Visual Calculation Only)
    // =========================================================
    function distributeMixedAmount(amount, items){
      const amt = Math.max(0, Math.floor(Number(amount||0) || 0));

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏à‡∏£‡∏¥‡∏á vs ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
      const sumKeyed = items.reduce((s, it) => s + (it.price * it.qty), 0);
      
      // A) ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πä‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏ö‡∏≤‡∏ó -> ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢)
      if(Math.abs(sumKeyed - amt) <= 1){
         const lines = items.map(it => ({
            label: it.label,
            qty: it.qty,
            unit: it.price,
            lineTotal: it.price * it.qty,
            isFixed: true
         }));
         return { lines, fixedTotal: sumKeyed, remaining: 0, total: sumKeyed, warn: '' };
      }

      // B) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô -> ‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢
      const baseItems = items.map(it=>({ ...it }));
      const zeroIdx = [];
      
      baseItems.forEach((it, idx)=>{
        if(it.price > 0){
          it.lineTotal = it.price * it.qty; 
          it.unit = it.price;
          it.isFixed = true;
        }else{
          zeroIdx.push(idx);
        }
      });

      // ‡∏´‡∏≤‡∏¢‡∏≠‡∏î Fixed ‡∏£‡∏ß‡∏°
      const fixedTotal = baseItems.reduce((s, it) => it.isFixed ? s + it.lineTotal : s, 0);
      let remaining = amt - fixedTotal;
      let warn = '';
      
      if(remaining < 0) { 
          remaining = 0; 
          warn = '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á (‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î)'; 
      }

      // ‡πÅ‡∏à‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ 0 ‡∏ö‡∏≤‡∏ó
      if(zeroIdx.length > 0){
        const totalQty = zeroIdx.reduce((s, idx)=> s + baseItems[idx].qty, 0) || 1;
        const tmp = zeroIdx.map(idx=>{
          const raw = remaining * (baseItems[idx].qty / totalQty);
          const base = Math.floor(raw);
          return { idx, base, frac: raw - base };
        });

        let used = tmp.reduce((s,x)=> s + x.base, 0);
        let rem = remaining - used;
        tmp.sort((a,b)=> b.frac - a.frac); // ‡πÅ‡∏à‡∏Å‡πÄ‡∏®‡∏©
        for(let i=0; i<tmp.length && rem>0; i++, rem--){ tmp[i].base += 1; }

        tmp.forEach(x=>{
           const it = baseItems[x.idx];
           it.lineTotal = x.base;
           // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡πÇ‡∏ä‡∏ß‡πå‡∏™‡∏ß‡∏¢‡πÜ)
           it.unit = (it.qty > 0) ? Math.floor(x.base / it.qty) : 0;
           it.isFixed = false;
        });
      }

      return { lines: baseItems, fixedTotal, remaining, total: amt, warn };
    }


    // =========================
    // ‚úÖ ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£ ‚Äú‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏¢‡∏≠‡∏î‚Äù ‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤ (‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á popup ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô + ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à)
    // =========================
    function distributeMixedAmount(amount, items){
  const amt = Math.max(0, Math.floor(Number(amount||0) || 0));

  // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° out ‡πÅ‡∏ö‡∏ö‡∏£‡∏±‡∏Å‡∏©‡∏≤ label/qty/price
  const baseItems = (items||[]).map(it=>({
    label: it.label,
    qty: Math.max(1, Math.floor(Number(it.qty||1) || 1)),
    price: Math.max(0, Math.floor(Number(it.price||0) || 0)),
  }));

  // 1) fixed price ‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô
  let fixedTotal = 0;
  const fixedLines = [];
  const zeroIdx = [];

  baseItems.forEach((it, idx)=>{
    if(it.price > 0){
      const lineTotal = it.price * it.qty;
      fixedTotal += lineTotal;
      fixedLines.push({
        label: it.label,
        qty: it.qty,
        unit: it.price,       // ‚úÖ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô ‚Äú‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‚Äù
        lineTotal: lineTotal,
        isFixed: true
      });
    }else{
      zeroIdx.push(idx);
    }
  });

  let remaining = amt - fixedTotal;
  let warn = '';
  if(remaining < 0){
    remaining = 0;
    warn = '‡∏û‡∏ö‡∏¢‡∏≠‡∏î ‚Äú‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‚Äù ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ';
  }

  // 2) ‡πÅ‡∏à‡∏Å remaining ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏∏‡πà‡∏° price=0 ‡πÅ‡∏ö‡∏ö ‚Äú‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‚Äù (proportional by qty)
  //    ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° (‡∏ö‡∏≤‡∏ó) ‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏±‡∏î‡∏•‡∏á + ‡πÅ‡∏à‡∏Å‡πÄ‡∏®‡∏© 1 ‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡∏•‡∏∞‡∏Å‡πâ‡∏≠‡∏ô
  const allocTotals = new Array(baseItems.length).fill(0);

  if(zeroIdx.length > 0){
    const totalQty = zeroIdx.reduce((s, idx)=> s + baseItems[idx].qty, 0) || 1;

    const tmp = zeroIdx.map(idx=>{
      const raw = remaining * (baseItems[idx].qty / totalQty);
      const base = Math.floor(raw);
      return { idx, base, frac: raw - base };
    });

    let used = tmp.reduce((s,x)=> s + x.base, 0);
    let rem = remaining - used;

    // ‡πÅ‡∏à‡∏Å‡πÄ‡∏®‡∏©‡πÉ‡∏´‡πâ frac ‡∏°‡∏≤‡∏Å‡∏Å‡πà‡∏≠‡∏ô
    tmp.sort((a,b)=> b.frac - a.frac);
    for(let i=0; i<tmp.length && rem>0; i++, rem--){
      tmp[i].base += 1;
    }

    tmp.forEach(x=>{
      allocTotals[x.idx] = x.base; // ‚úÖ lineTotal (‡∏ö‡∏≤‡∏ó) ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô ‡πÜ
    });
  }

  // 3) ‡πÅ‡∏ï‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ price=0 ‡πÉ‡∏´‡πâ ‚Äú‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‚Äù ‡πÅ‡∏•‡∏∞ ‚Äú‡∏Ñ‡∏π‡∏ì‡∏•‡∏á‡∏ï‡∏±‡∏ß‚Äù
  //    ‡∏ñ‡πâ‡∏≤ lineTotal ‡∏´‡∏≤‡∏£ qty ‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ï‡∏±‡∏ß -> ‡πÅ‡∏ï‡∏Å‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î: (qty-rem)*baseUnit ‡πÅ‡∏•‡∏∞ rem*(baseUnit+1)
  const splitLines = [];
  zeroIdx.forEach(idx=>{
    const it = baseItems[idx];
    const lineTotal = Math.max(0, Math.floor(Number(allocTotals[idx]||0) || 0));
    const q = it.qty;

    const baseUnit = Math.floor(lineTotal / q);
    const rem = lineTotal - (baseUnit * q); // 0..q-1

    const qtyBase = q - rem; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏Ñ‡∏≤ baseUnit
    if(qtyBase > 0){
      splitLines.push({
        label: it.label,
        qty: qtyBase,
        unit: baseUnit,
        lineTotal: baseUnit * qtyBase,
        isFixed: false
      });
    }
    if(rem > 0){
      splitLines.push({
        label: it.label,
        qty: rem,
        unit: baseUnit + 1,
        lineTotal: (baseUnit + 1) * rem,
        isFixed: false
      });
    }
  });

  const lines = [...fixedLines, ...splitLines];
  const sum = lines.reduce((s,x)=> s + (Number(x.lineTotal)||0), 0);

  return { lines, fixedTotal, remaining, total: sum, warn };
}


    // =========================
    // ‚úÖ Popup: ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ + QR)  (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏á API)
    // =========================
    function openCasePaymentPopup(){
      const opdVal = (document.getElementById('opd').value||'').trim();
      if(!isValidOPD(opdVal)) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');

      const amount = Math.floor(Number(document.getElementById('amount').value||0));
      if(!Number.isFinite(amount) || amount<=0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó) ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

      const items = collectItemsFromForm();
      if(items.length===0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

      const date = (document.getElementById('date').value||'').slice(0,10);
      const method = getPayment();

      // ‡∏´‡∏±‡∏ß‡∏ö‡∏¥‡∏•
      document.getElementById('pc_name').textContent = document.getElementById('name').value || '-';
document.getElementById('pc_opd').textContent = opdVal;

      // ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏¢‡∏≠‡∏î
      const dist = distributeMixedAmount(amount, items);

      // warning
      const warnEl = document.getElementById('pc_warn');
      if(dist.warn){
        warnEl.style.display = 'block';
        warnEl.textContent = dist.warn;
      }else{
        warnEl.style.display = 'none';
        warnEl.textContent = '';
      }

      // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      document.getElementById('pc_itemCount').textContent = `(${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;

      // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      const tableHtml = `
        <table class="paycase-table">
          <thead>
            <tr>
              <th style="width:60px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th style="width:90px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô</th>
              <th style="width:140px;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</th>
            </tr>
          </thead>
          <tbody>
            ${dist.lines.map((r, idx)=>`
              <tr>
                <td style="text-align:center;">${idx+1}</td>
                <td>${safe(r.label)}</td>
                <td style="text-align:center;">${r.qty}</td>
                <td style="text-align:right;">${Math.floor(r.lineTotal).toLocaleString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('pc_tableWrap').innerHTML = tableHtml;

      // ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°/‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞
      document.getElementById('pc_total').textContent = `${Math.floor(amount).toLocaleString()} ‡∏ö‡∏≤‡∏ó`;


      const ov = document.getElementById('payCaseOverlay');
      ov.style.display = 'flex';
      ov.setAttribute('aria-hidden','false');
    }

    function closeCasePaymentPopup(){
      const ov = document.getElementById('payCaseOverlay');
      ov.style.display = 'none';
      ov.setAttribute('aria-hidden','true');
    }

    // =========================
    // Review / Save (‡πÄ‡∏î‡∏¥‡∏°)
    // =========================
    function reviewForm(){
      const opdVal = (document.getElementById('opd').value||'').trim();
      if(!/^\d{4}$/.test(opdVal)){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }

      const date = (document.getElementById('date').value||'').slice(0,10);
      const name = document.getElementById('name').value||'';
      const phone = document.getElementById('phone').value||'';
      
      let amount = parseFloat(document.getElementById('amount').value);
      if(!Number.isFinite(amount)) amount = 0;

      const payment = (typeof getPayment === 'function') ? getPayment() : '‡πÇ‡∏≠‡∏ô';
      const note = document.getElementById('note').value||'';

      const rawItems = collectItemsFromForm();
      if(rawItems.length===0){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); return; }

      // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á label -> name ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
      const cleanItems = rawItems.map(i => ({
        name: i.label || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
        qty: Number(i.qty) || 1,
        price: Number(i.price) || 0
      }));

      const rec = { 
          date, opd: opdVal, name, phone, 
          amount, payment, note, 
          items: cleanItems // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô Object
      };

      if(typeof currentEditId !== 'undefined' && currentEditId){ rec.id = currentEditId; }

      records.push(rec);
      renderReviewSection(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß
      validateSaveAllReady();

      // Reset Form
      const keepDate = date; const keepOPD = opdVal;
      document.getElementById('saleForm').reset();
      document.getElementById('date').value = keepDate;
      document.getElementById('opd').value = keepOPD;
      if(typeof onOPDInput === 'function') onOPDInput(document.getElementById('opd'));
      if(typeof initFirstRow === 'function') initFirstRow();
      if(typeof currentEditId !== 'undefined') currentEditId = null;
      if(document.getElementById('currentId')) document.getElementById('currentId').value = '';
      if(typeof recalcAmount === 'function') recalcAmount();
      if(typeof refreshActionButtonsState === 'function') refreshActionButtonsState();
    }



    function renderReviewSection(){
      const section = document.getElementById('reviewSection');
      section.innerHTML = '<h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>';

      const grouped = {};
      records.forEach((r,idx)=>{ const d=r.date||''; (grouped[d]||(grouped[d]=[])).push({...r, _idx: idx}); });

      Object.entries(grouped).sort(([a],[b])=> new Date(b)-new Date(a)).forEach(([date, list])=>{
        const dayTotal = list.reduce((s,r)=> s + (parseFloat(r.amount)||0), 0);
        const container = document.createElement('div'); container.style.marginBottom='24px';
        const header = document.createElement('h4'); header.textContent = `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDate(date)} ‚Äî ‡∏£‡∏ß‡∏° ${dayTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`; container.appendChild(header);

        const rowsHtml = list.map((r,i)=>{
          // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á String ‡πÅ‡∏•‡∏∞ Object
          const itemsHtml = (r.items||[]).map(x => {
             if(typeof x === 'string') return `<li>${safe(x)}</li>`; 
             // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡∏¥‡∏ö‡πÜ ‡πÄ‡∏•‡∏¢
             return `<li>${safe(x.name)} - ${x.qty} ‡∏ä‡∏¥‡πâ‡∏ô x ${x.price} ‡∏ö.</li>`;
          }).join('');

          return `<tr>
            <td>${i+1}</td>
            <td><div><strong>${safe(r.name||'-')}</strong></div><div class="muted">OPD: ${safe(r.opd)}</div></td>
            <td>${safe(r.phone||'-')}</td>
            <td><ul style='margin:0;padding-left:16px;'>${itemsHtml || '<span class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>'}</ul></td>
            <td>${safe(r.amount||0)} ‡∏ö‡∏≤‡∏ó (${safe(r.payment)})${r.note?`<div class='muted'>üìù ${safe(r.note)}</div>`:''}</td>
            <td style="text-align:center;">
              <div class="actions">
                <button type="button" class="btn btn-primary"
                  onclick="editRecordFromObject(records[${r._idx}]); currentEditId = records[${r._idx}].id || null; document.getElementById('currentId').value=currentEditId||'';">
                  ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteRecord(${r._idx})">‡∏•‡∏ö</button>
              </div>
            </td>
          </tr>`;
        }).join('');

        const table = document.createElement('table');
        table.innerHTML = `<thead><tr><th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏£‡∏¥‡∏á)</th><th>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody>${rowsHtml}</tbody>`;
        container.appendChild(table);
        section.appendChild(container);
      });
    }

    function deleteRecord(idx){
      if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?')) return;
      records.splice(idx,1);
      renderReviewSection();
      validateSaveAllReady();
    }

    function validateSaveAllReady(){
      const ok = records.length>0 && records.every(r=> isValidOPD(r.opd));
      document.getElementById('btnSaveAll').disabled = !ok;
    }

    function saveAllRecords(){
      if(records.length===0) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß');
      if(!records.every(r=> isValidOPD(r.opd))){
        alert('‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà OPD ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        return;
      }
      if(!confirm('‚ú® ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')) return;
      fetch('/api/save_sales', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(records)
      })
      .then(r=>r.json())
      .then(data=>{
        if(data && (data.message||'').includes('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')){
          alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ${data.updated||0} / ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ${data.inserted||0}`);
          records = []; renderReviewSection(); validateSaveAllReady();
          clearForm();
          allSales = null;
        }else{
          alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
      })
      .catch(err=>{ console.error(err); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'); });
    }

    function deleteRecordFromSupabase(id){
      if(!id) return;
      if(!confirm('‚ùå ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      fetch('/api/delete_sales_record', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({id})
      })
      .then(r=>r.json()).then(()=>{
        alert('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        loadDatesByOPD();
        allSales = null;
      })
      .catch(()=> alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
    }

    // =========================
    // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
    // - linesForSave ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö ‚Äúqty ‡∏ä‡∏¥‡πâ‡∏ô x price ‡∏ö‡∏≤‡∏ó‚Äù ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å (price=0 ‡πÑ‡∏î‡πâ)
    // =========================
    function collectItemsForReceiptAndSave(){
      const items = collectItemsFromForm();
      if(items.length===0){
        return { rows: [], linesForSave: [] };
      }

      const rows = items.map(it=>({ label: it.label, qty: it.qty, price: it.price }));
      const linesForSave = items.map(it => `${it.label} - ${it.qty} ‡∏ä‡∏¥‡πâ‡∏ô x ${Math.floor(it.price||0)} ‡∏ö‡∏≤‡∏ó`);
      return { rows, linesForSave };
    }

    // =========================
    // Popup ‡∏ä‡∏±‡πâ‡∏ô 1: ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
    // =========================
    function openPayPopup(){
      const opdVal = (document.getElementById('opd').value||'').trim();
      if(!isValidOPD(opdVal)) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');

      const total = Math.floor(Number(document.getElementById('amount').value||0));
      if(!Number.isFinite(total) || total<=0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó) ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

      const { rows } = collectItemsForReceiptAndSave();
      if(rows.length===0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

      const date = (document.getElementById('date').value||'').slice(0,10);
      document.getElementById('pay_name').textContent  = document.getElementById('name').value || '-';
      document.getElementById('pay_phone').textContent = (document.getElementById('phone').value || '-');
      document.getElementById('pay_date').textContent  = formatDate(date);
      document.getElementById('pay_method').textContent= `‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢: ${getPayment()}`;
      document.getElementById('pay_total').textContent = `${Math.floor(total).toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

      // default ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ï‡πâ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
      const name = document.getElementById('name').value || '';
      const a = document.getElementById('sig_authorized');
      const c = document.getElementById('sig_customer');
      const r = document.getElementById('sig_receiver');
      if(a){  a.value = '‡∏û‡∏ç.‡∏õ‡∏¥‡∏¢‡∏∞‡∏é‡∏≤ ‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡∏´‡∏•‡∏ß‡∏á';  a.readOnly = true;}
      if(c && !c.value) c.value = name;
      if(r && !r.value) r.value = '';

      const ov = document.getElementById('payOverlay');
      ov.style.display='flex';
      ov.setAttribute('aria-hidden','false');
    }

    function closePayPopup(){
      const ov = document.getElementById('payOverlay');
      ov.style.display='none';
      ov.setAttribute('aria-hidden','true');
    }

    function applySigNamesToReceipt(){
  const a = (document.getElementById('sig_authorized')?.value || '').trim();
  const c = (document.getElementById('sig_customer')?.value || '').trim();
  const r = (document.getElementById('sig_receiver')?.value || '').trim();

  const ua = document.getElementById('sigUnder_authorized');
  const uc = document.getElementById('sigUnder_customer');
  const ur = document.getElementById('sigUnder_receiver');

  if(ua) ua.value = a;
  if(uc) uc.value = c;
  if(ur) ur.value = r;
}

    // =========================
    // ‚úÖ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°: ‡πÉ‡∏ä‡πâ ‚Äú‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏¢‡∏≠‡∏î‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‚Äù ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô popup ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
    // =========================
    // =========================================================
    // üü¢ 3. ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á HTML (Helper)
    // =========================================================
    function buildReceiptRowsMixed(total, items){
      const dateStr = formatDate((document.getElementById('date').value||'').slice(0,10));
      const dist = distributeMixedAmount(total, items);

      let tbody = '';
      dist.lines.forEach((r, idx)=>{
        const qty = Math.max(1, Math.floor(Number(r.qty||1) || 1));
        const unit = Number.isFinite(r.unit) ? r.unit : 0;
        const lineTotal = Number.isFinite(r.lineTotal) ? r.lineTotal : (unit * qty);

        tbody += `
          <tr>
            <td style="text-align:center;">${idx+1}</td>
            <td>${safe(r.label)}</td>
            <td style="text-align:center;">${qty}</td>
            <td style="text-align:right;">${unit.toLocaleString()}</td>
            <td style="text-align:right;">${Math.floor(lineTotal).toLocaleString()}</td>
            <td style="text-align:center;">${safe(dateStr)}</td>
            <td style="text-align:center;">${safe(dateStr)}</td>
          </tr>
        `;
      });
      return { tbody, sum: dist.total, warn: dist.warn };
    }



// =========================================================
    // üü¢ 4. API Sender (‡πÅ‡∏õ‡∏•‡∏á label -> name ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î)
    // =========================================================
    async function issueReceiptFromForm(){
      const opd = (document.getElementById('opd').value||'').trim();
      const date = (document.getElementById('date').value||'').slice(0,10);
      let amount = parseFloat(document.getElementById('amount').value);
      if(!Number.isFinite(amount)) amount = 0;
      
      const payment_method = (typeof getPayment === 'function') ? getPayment() : '‡πÇ‡∏≠‡∏ô';
      const name  = (document.getElementById('name')?.value || '').trim();
      const phone = (document.getElementById('phone')?.value || '').trim();
      const note  = (document.getElementById('note')?.value || '').trim();
      const patient_info = (document.getElementById('pay_note_input')?.value || '').trim();
      
      const sig_authorized = (document.getElementById('sig_authorized')?.value || '').trim();
      const sig_customer   = (document.getElementById('sig_customer')?.value || '').trim();
      const sig_receiver   = (document.getElementById('sig_receiver')?.value || '').trim();

      if(!/^\d{4}$/.test(opd)) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
      if(!date) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
      
      const rawItems = collectItemsFromForm();
      if(!rawItems || rawItems.length === 0) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

      // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á label -> name ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Backend (app.py) ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à
      const cleanItems = rawItems.map(i => ({
        name: i.label || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 
        qty: Number(i.qty) || 1,
        price: Number(i.price) || 0
      }));

      const payload = {
        date, opd, amount, payment_method, 
        items: cleanItems, 
        name, phone, note,
        patient_info,
        sig: { authorized: sig_authorized, customer: sig_customer, receiver: sig_receiver }
      };

      const fetchFn = (typeof fetchWithTimeout === 'function') ? fetchWithTimeout : fetch;
      const res = await fetchFn('/api/sales_issue_receipt', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }, 10000);

      const data = await res.json().catch(()=> ({}));
      if(!res.ok || !data || data.success !== true){
        throw new Error(data.error || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
      return data;
    }





  // =========================================================
    // üü¢ 5. ‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°" (Orchestrator)
    // =========================================================
    async function openReceiptFromPay(){
      const btn = document.querySelector('#payOverlay .btn.btn-primary');
      if(btn) {
          btn.disabled = true;
          btn.dataset.originalText = btn.innerText;
          btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
      }

      try{
        // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
        const issued = await issueReceiptFromForm(); 
        
        // 2. ‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
        const dispNo = (issued.disp_no || '').trim();
        const origNo = (issued.orig_no || '').trim();
        const showNo = (dispNo) ? dispNo : (origNo ? origNo.replace(/^RC-/, 'RB-') : '-');
        const receiptNoEl = document.getElementById('receiptNo');
        if(receiptNoEl) receiptNoEl.textContent = showNo;

        const issueDateISO = (document.getElementById('date')?.value || '').slice(0,10);
        if(typeof setReceiptIssueDateFromISO === 'function') setReceiptIssueDateFromISO(issueDateISO);

        // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (Mockup Table)
        let total = parseFloat(document.getElementById('amount').value);
        if(!Number.isFinite(total)) total = 0;
        const items = collectItemsFromForm(); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å‡∏à‡∏≠
        const { tbody, sum } = buildReceiptRowsMixed(total, items); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå

        const patientInfo = (document.getElementById('pay_note_input')?.value || '').trim();

        document.getElementById('receiptContent').innerHTML = `
          <table class="receipt-table">
            <thead>
              <tr><th colspan="7" style="text-align:center; font-weight:900;">‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</th></tr>
              <tr>
                <th style="width:60px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                <th style="width:70px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                <th style="width:130px;">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ö‡∏≤‡∏ó)</th>
                <th style="width:120px;">‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡∏ö‡∏≤‡∏ó)</th>
                <th style="width:130px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
                <th style="width:130px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody>${tbody}</tbody>
          </table>
          <div class="receipt-total">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô ${sum.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
          <div class="receipt-section">
            <b>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà):</b><br>
            <textarea id="receipt_patient_info" rows="2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤&#10;‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤">${safe(patientInfo)}</textarea>
          </div>
        `;

        if(typeof closePayPopup === 'function') closePayPopup();
        const ov = document.getElementById('receiptOverlay');
        ov.style.display = 'flex';
        ov.setAttribute('aria-hidden','false');

        if(typeof applySigNamesToReceipt === 'function') applySigNamesToReceipt();
        requestAnimationFrame(() => {
            if(typeof initAllSigPads === 'function') initAllSigPads();
        });

      }catch(err){
        console.error(err);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (err.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
      }finally{
        if(btn) {
            btn.disabled = false;
            if(btn.dataset.originalText) btn.innerText = btn.dataset.originalText;
        }
      }
    }



    // =========================
    // Helper: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏£‡∏±‡∏ö total ‡πÅ‡∏•‡∏∞ items ‡∏î‡∏¥‡∏ö‡∏°‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Mockup)
    // =========================
    function buildReceiptRowsMixed(total, items){
      const dateStr = formatDate((document.getElementById('date').value||'').slice(0,10));
      
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô distributeMixedAmount (‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏õ‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1)
      const dist = distributeMixedAmount(total, items);

      let tbody = '';
      dist.lines.forEach((r, idx)=>{
        const qty = Math.max(1, Math.floor(Number(r.qty||1) || 1));
        
        // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (Mockup)
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏≤ r.unit ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
        const unit = Number.isFinite(r.unit) ? r.unit : (qty ? Math.floor(r.lineTotal / qty) : Math.floor(r.lineTotal));

        tbody += `
          <tr>
            <td style="text-align:center;">${idx+1}</td>
            <td>${safe(r.label)}</td>
            <td style="text-align:center;">${qty}</td>
            <td style="text-align:right;">${unit.toLocaleString()}</td>
            <td style="text-align:right;">${Math.floor(r.lineTotal).toLocaleString()}</td>
            <td style="text-align:center;">${safe(dateStr)}</td>
            <td style="text-align:center;">${safe(dateStr)}</td>
          </tr>
        `;
      });

      return { tbody, sum: dist.total, warn: dist.warn };
    }

async function fetchWithTimeout(url, options={}, ms=10000){
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), ms);
  
  const config = { ...options, signal: controller.signal };
  
  try {
    const response = await fetch(url, config);
    clearTimeout(id);
    return response;
  } catch (error) {
    clearTimeout(id);
    if (error.name === 'AbortError') {
      throw new Error('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (Timeout)');
    }
    throw error;
  }
}


    function closeReceipt(){
      const ov = document.getElementById('receiptOverlay');
      ov.style.display='none';
      ov.setAttribute('aria-hidden','true');
    }

    // =========================
    // Edit old records (‡πÄ‡∏î‡∏¥‡∏°)
    // =========================
    function loadDatesByOPD(){
      const raw = (document.getElementById('editOPD').value||'').trim();
      if(!isValidOPD(raw)) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
      const opd = raw;

      const list = document.getElementById('editRecordList');
      const dateBtns = document.getElementById('editDateButtons');
      dateBtns.innerHTML = '';
      list.innerHTML = '<div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>';

      fetch(`/api/sales?opd=${encodeURIComponent(opd)}`)
        .then(r=> r.ok ? r.json() : Promise.reject())
        .then(data=>{
          editDataByOPD = data || [];
          if(editDataByOPD.length===0){
            dateBtns.innerHTML = '';
            list.innerHTML = '<div class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á OPD ‡∏ô‡∏µ‡πâ</div>';
            return;
          }
          const dates = [...new Set(editDataByOPD.map(r=> (r.date||'').slice(0,10)))]
            .sort((a,b)=> new Date(b)-new Date(a));

          dateBtns.innerHTML = 'üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:<br>' + dates.map((d,i)=>(
            `<span class="chip ${i===0?'active':''}" data-date="${d}" onclick="selectEditDateChip(this)">${formatDate(d)}</span>`
          )).join('');
          showEditList(dates[0]);
        })
        .catch(()=> { list.innerHTML = '<div class="muted">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>'; });
    }

    function loadDatesByOPDFor(opd){
      const list = document.getElementById('editRecordList');
      const dateBtns = document.getElementById('editDateButtons');
      document.getElementById('editOPD').value = opd;
      dateBtns.innerHTML = '';
      list.innerHTML = '<div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>';
      return fetch(`/api/sales?opd=${encodeURIComponent(opd)}`)
        .then(r=> r.ok ? r.json() : Promise.reject())
        .then(data=>{
          editDataByOPD = data || [];
          if(editDataByOPD.length===0){
            dateBtns.innerHTML = '';
            list.innerHTML = '<div class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á OPD ‡∏ô‡∏µ‡πâ</div>';
            return;
          }
          const dates = [...new Set(editDataByOPD.map(r=> (r.date||'').slice(0,10)))]
            .sort((a,b)=> new Date(b)-new Date(a));

          dateBtns.innerHTML = 'üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:<br>' + dates.map((d,i)=>(
            `<span class="chip ${i===0?'active':''}" data-date="${d}" onclick="selectEditDateChip(this)">${formatDate(d)}</span>`
          )).join('');
          showEditList(dates[0]);
        })
        .catch(()=> { list.innerHTML = '<div class="muted">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>'; });
    }

    function selectEditDateChip(el){
      document.querySelectorAll('#editDateButtons .chip').forEach(c=> c.classList.remove('active'));
      el.classList.add('active');
      showEditList(el.getAttribute('data-date'));
    }

    function showEditList(date){
      const list = document.getElementById('editRecordList');
      const rows = editDataByOPD.filter(r => (r.date||'').slice(0,10) === date);
      if(rows.length === 0){
        list.innerHTML = '<div class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
        return;
      }

      const stripPrice = (s) => String(s).replace(/ - \d+(?:\.\d+)? ‡∏ä‡∏¥‡πâ‡∏ô x \d+(?:\.\d+)? ‡∏ö‡∏≤‡∏ó$/, '');
      const sumFromItems = (items=[]) => items.reduce((acc, line)=>{
        const m = String(line).match(/ - (\d+(?:\.\d+)?) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+(?:\.\d+)?) ‡∏ö‡∏≤‡∏ó$/);
        if(!m) return acc;
        const qty = parseFloat(m[1]||'0');
        const price = parseFloat(m[2]||'0');
        return acc + (qty*price);
      }, 0);

      const html = rows.map(r => {
        const items = Array.isArray(r.items) ? r.items : [];
        const cleanList = items.length
          ? `<ul class="items-list">${items.map(x => `<li>${safe(stripPrice(x))}</li>`).join('')}</ul>`
          : '<div class="muted">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>';

        const total = (r.amount != null && r.amount !== '') ? Number(r.amount) : sumFromItems(items);
        const totalStr = Number.isFinite(total) ? total.toLocaleString() : '0';

        return `
          <div class="card">
            <div class="left">
              <div><strong>${safe(r.name || '-')}</strong></div>
              ${cleanList}
              <div class="total-line">‡∏£‡∏ß‡∏°: ${totalStr} ‡∏ö‡∏≤‡∏ó</div>
            </div>
            <div class="actions">
              <button type="button" class="btn btn-primary" onclick="editSelectedRecordById('${r.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button type="button" class="btn btn-danger" onclick="deleteRecordFromSupabase('${r.id}')">‡∏•‡∏ö</button>
            </div>
          </div>
        `;
      }).join('');

      list.innerHTML = html;
    }

    function findRecordInEditCacheById(id){
      return (editDataByOPD || []).find(x => String(x.id) === String(id)) || null;
    }

    function editSelectedRecordById(id){
      const rec = findRecordInEditCacheById(id);
      if(!rec) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');

      currentEditId = rec.id || null;
      document.getElementById('currentId').value = currentEditId || '';
      editRecordFromObject(rec);

      records = [];
      renderReviewSection();

      const btnSale = document.querySelector('.tab-btn');
      switchTab('tab-sale', btnSale);

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function editRecordFromObject(rec){
      document.getElementById('date').value = (rec.date||'').slice(0,10);

      const opdEl = document.getElementById('opd');
      opdEl.value = (rec.opd||'').slice(0,4);
      onOPDInput(opdEl);

      if(!customerMap[opdEl.value]){
        document.getElementById('name').value = rec.name || '';
        document.getElementById('phone').value = rec.phone || '';
      }

      document.getElementById('amount').value = rec.amount || '';
      setPayment(rec.payment === '‡∏™‡∏î' ? '‡∏™‡∏î' : '‡πÇ‡∏≠‡∏ô');
      setSumState('‡∏õ‡∏¥‡∏î');
      document.getElementById('note').value = rec.note || '';

      const list = document.getElementById('itemList');
      list.innerHTML = '';
      if((rec.items||[]).length === 0){
        list.appendChild(makeItemRow());
      }else{
        (rec.items||[]).forEach(line => {
          const row = makeItemRow();
          const m = String(line).match(/^(.*?) ?(?:\((.*?)\))? - (\d+(?:\.\d+)?) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+(?:\.\d+)?) ‡∏ö‡∏≤‡∏ó/);
          const itemSel = row.querySelector('select[name="item[]"]');
          const subSel  = row.querySelector('select[name="subitem[]"]');
          if(m){
            const main = (m[1]||'').trim();
            const sub = (m[2]||'').trim();
            const qty = m[3]||'';
            const price = m[4]||'';

            if(mainCategoryKeys().includes(main)){
              itemSel.value = main;
              updateSubOptions(itemSel, subSel);
              const allSubOptions = Array.from(subSel.options).map(o=>o.value);
              if(allSubOptions.includes(sub)){
                subSel.value = sub;
              }
            }

            row.querySelector('input[name="qty[]"]').value = qty;
            row.querySelector('input[name="price[]"]').value = price;
          }else{
            const plain = String(line).trim();
            const main = plain.split('(')[0].split('-')[0].trim();
            if(mainCategoryKeys().includes(main)){
              itemSel.value = main;
              updateSubOptions(itemSel, subSel);
            }
          }
          list.appendChild(row);
        });
      }
      recalcAmount();
      refreshActionButtonsState();
    }

    // =========================
    // Diagnostics (‡πÄ‡∏î‡∏¥‡∏°)
    // =========================
    const normName = s => String(s||'').trim().toLowerCase().replace(/\s+/g,' ');
    const onlyDigits = s => String(s||'').replace(/\D/g,'');
    const normPhone = s => {
      let d = onlyDigits(s);
      if(d.startsWith('66') && d.length>=11) d = '0' + d.slice(-9);
      return d;
    };
    const normOPD = s => String(s||'').trim().padStart(4,'0');
    const isValidPhone = p => { const d = normPhone(p); return d.length===9 || d.length===10; };
    const isValidOPDVal = o => /^\d{4}$/.test(String(o||'').trim());

    async function ensureAllSales(){
      if(allSales) return allSales;
      const r = await fetch('/api/sales');
      const data = await r.json().catch(()=>[]);
      allSales = data || [];
      return allSales;
    }

    async function runDiag(type){
      await ensureAllSales();
      const rows = diagCompute(type);
      renderDiag(type, rows);
    }

    function diagCompute(type){
      const out = [];
      const byName = new Map();
      const byPhone = new Map();
      const byOPD = new Map();
      const byTripletNorm = new Map();

      (allSales||[]).forEach(r=>{
        const nameN = normName(r.name);
        const phoneN = normPhone(r.phone);
        const opdN = normOPD(r.opd);

        if(!byName.has(nameN)) byName.set(nameN,{opds:new Set(),phones:new Set(),rows:[]});
        byName.get(nameN).opds.add(opdN); byName.get(nameN).phones.add(phoneN||''); byName.get(nameN).rows.push(r);

        if(phoneN){
          if(!byPhone.has(phoneN)) byPhone.set(phoneN,{names:new Set(),opds:new Set(),rows:[]});
          byPhone.get(phoneN).names.add(nameN); byPhone.get(phoneN).opds.add(opdN); byPhone.get(phoneN).rows.push(r);
        }

        if(!byOPD.has(opdN)) byOPD.set(opdN,{names:new Set(),phones:new Set(),rows:[]});
        byOPD.get(opdN).names.add(nameN); byOPD.get(opdN).phones.add(phoneN||''); byOPD.get(opdN).rows.push(r);

        const tripKey = `${nameN}|${phoneN}|${opdN}`;
        if(!byTripletNorm.has(tripKey)) byTripletNorm.set(tripKey,{rawKeys:new Set(),rows:[]});
        byTripletNorm.get(tripKey).rawKeys.add(`${(r.name||'').trim()}|${(r.phone||'').trim()}`);
        byTripletNorm.get(tripKey).rows.push(r);
      });

      switch(type){
        case 'missingPhone': {
          (allSales||[]).forEach(r=>{
            const d = normPhone(r.phone);
            if(!d){ out.push({id:r.id, name:r.name||'-',opd:normOPD(r.opd),phone:'-',date:r.date}); }
          });
          break;
        }
        case 'nameDifferentOPD': {
          byName.forEach((v)=>{
            const opds = Array.from(v.opds).filter(x=>x!=='0000' && x!=='');
            if(new Set(opds).size>1){
              out.push({
                name: v.rows[0]?.name || '-',
                opds: Array.from(new Set(opds)),
                phones: Array.from(v.phones).filter(Boolean),
                count: v.rows.length
              });
            }
          });
          break;
        }
        case 'phoneDifferentName': {
          byPhone.forEach((v, phoneN)=>{
            if(!phoneN) return;
            if(v.names.size>1){
              out.push({
                phone: phoneN,
                names: Array.from(v.names).map(n=>v.rows.find(r=>normName(r.name)===n)?.name || n),
                opds: Array.from(v.opds),
                count: v.rows.length
              });
            }
          });
          break;
        }
        case 'opdDifferentNamePhone': {
          byOPD.forEach((v, opdN)=>{
            if(v.names.size>1 || (v.phones.size>1 && !v.phones.has(''))){
              out.push({
                opd: opdN,
                names: Array.from(v.names).map(n=>v.rows.find(r=>normName(r.name)===n)?.name || n),
                phones: Array.from(v.phones),
                count: v.rows.length
              });
            }
          });
          break;
        }
        case 'invalidPhone': {
          (allSales||[]).forEach(r=>{
            const d = normPhone(r.phone);
            if(d && !isValidPhone(d)){
              out.push({id:r.id, name:r.name||'-',opd:normOPD(r.opd),phone:r.phone||'-',date:r.date});
            }
          });
          break;
        }
        case 'invalidOPD': {
          (allSales||[]).forEach(r=>{
            if(!isValidOPDVal(String(r.opd||''))){
              out.push({id:r.id, name:r.name||'-',opd:String(r.opd||''),norm: normOPD(r.opd),phone:r.phone||'-',date:r.date});
            }
          });
          break;
        }
        case 'splitGroups': {
          byTripletNorm.forEach((v, k)=>{
            if(v.rawKeys.size>1){
              const [nameN, phoneN, opdN] = k.split('|');
              out.push({
                name: v.rows[0]?.name || nameN,
                opd: opdN,
                phone: v.rows[0]?.phone || phoneN,
                variants: Array.from(v.rawKeys),
                count: v.rows.length
              });
            }
          });
          break;
        }
        case 'sameNameMultiPhones': {
          byName.forEach((v)=>{
            const phones = Array.from(v.phones);
            const nonEmpty = phones.filter(p=>p);
            if(nonEmpty.length>1 || (nonEmpty.length>=1 && phones.includes(''))){
              out.push({
                name: v.rows[0]?.name || '-',
                phones: phones,
                opds: Array.from(v.opds),
                count: v.rows.length
              });
            }
          });
          break;
        }
      }
      return out;
    }

    function renderDiag(type, rows){
      const head = document.getElementById('diag-head');
      const body = document.getElementById('diag-body');
      const counter = document.getElementById('diag-count');

      const headersByType = {
        missingPhone: ['‡∏ä‡∏∑‡πà‡∏≠','OPD','‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£'],
        nameDifferentOPD: ['‡∏ä‡∏∑‡πà‡∏≠','OPDs','‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ö','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'],
        phoneDifferentName: ['‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏û‡∏ö','OPDs','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'],
        opdDifferentNamePhone: ['OPD','‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏û‡∏ö','‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ö','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'],
        invalidPhone: ['‡∏ä‡∏∑‡πà‡∏≠','OPD','‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£'],
        invalidOPD: ['‡∏ä‡∏∑‡πà‡∏≠','OPD (‡πÄ‡∏î‡∏¥‡∏°)','OPD ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î','‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£'],
        splitGroups: ['‡∏ä‡∏∑‡πà‡∏≠','OPD','‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏û‡∏ö (name|phone)','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'],
        sameNameMultiPhones: ['‡∏ä‡∏∑‡πà‡∏≠','‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î','OPDs','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç']
      };

      const cols = headersByType[type] || ['‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'];
      head.innerHTML = cols.map(c=>`<th>${c}</th>`).join('');

      body.innerHTML = rows.map(r=>{
        switch(type){
          case 'missingPhone': {
            return `<tr>
              <td>${safe(r.name)}</td>
              <td>${safe(r.opd)}</td>
              <td style="color:#b91c1c">-</td>
              <td>${formatDate((r.date||'').slice(0,10))}</td>
              <td><button class="btn btn-outline" onclick="editFromDiag('${r.opd}','${r.id||''}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button></td>
            </tr>`;
          }
          case 'nameDifferentOPD': {
            const opds = (r.opds||[]).map(o=>`<button class="btn btn-outline" onclick="goEditByOPD('${o}')">OPD ${o}</button>`).join(' ');
            return `<tr>
              <td>${safe(r.name)}</td>
              <td>${safe((r.opds||[]).join(', '))}</td>
              <td>${safe((r.phones||[]).join(', ')||'-')}</td>
              <td>${r.count}</td>
              <td>${opds||'-'}</td>
            </tr>`;
          }
          case 'phoneDifferentName': {
            const opds = (r.opds||[]).map(o=>`<button class="btn btn-outline" onclick="goEditByOPD('${o}')">OPD ${o}</button>`).join(' ');
            return `<tr>
              <td>${safe(r.phone)}</td>
              <td>${safe((r.names||[]).join(', '))}</td>
              <td>${safe((r.opds||[]).join(', '))}</td>
              <td>${r.count}</td>
              <td>${opds||'-'}</td>
            </tr>`;
          }
          case 'opdDifferentNamePhone': {
            return `<tr>
              <td>${safe(r.opd)}</td>
              <td>${safe((r.names||[]).join(', '))}</td>
              <td>${safe((r.phones||[]).join(', '))}</td>
              <td>${r.count}</td>
              <td><button class="btn btn-outline" onclick="goEditByOPD('${r.opd}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç OPD ${safe(r.opd)}</button></td>
            </tr>`;
          }
          case 'invalidPhone': {
            return `<tr>
              <td>${safe(r.name)}</td>
              <td>${safe(r.opd)}</td>
              <td style="color:#b91c1c">${safe(r.phone)}</td>
              <td>${formatDate((r.date||'').slice(0,10))}</td>
              <td><button class="btn btn-outline" onclick="editFromDiag('${r.opd}','${r.id||''}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button></td>
            </tr>`;
          }
          case 'invalidOPD': {
            return `<tr>
              <td>${safe(r.name)}</td>
              <td style="color:#b91c1c">${safe(r.opd)}</td>
              <td>${safe(r.norm)}</td>
              <td>${safe(r.phone)}</td>
              <td>${formatDate((r.date||'').slice(0,10))}</td>
              <td><button class="btn btn-outline" onclick="goEditByOPD('${r.norm}')">‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î OPD ${safe(r.norm)}</button></td>
            </tr>`;
          }
          case 'splitGroups': {
            return `<tr>
              <td>${safe(r.name)}</td>
              <td>${safe(r.opd)}</td>
              <td>${safe(r.phone)}</td>
              <td>${safe((r.variants||[]).join(' | '))}</td>
              <td>${r.count}</td>
              <td><button class="btn btn-outline" onclick="goEditByOPD('${r.opd}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç OPD ${safe(r.opd)}</button></td>
            </tr>`;
          }
          case 'sameNameMultiPhones': {
            const opds = (r.opds||[]).map(o=>`<button class="btn btn-outline" onclick="goEditByOPD('${o}')">OPD ${o}</button>`).join(' ');
            return `<tr>
              <td>${safe(r.name)}</td>
              <td>${safe((r.phones||[]).map(p=>p||'(‡∏ß‡πà‡∏≤‡∏á)').join(', '))}</td>
              <td>${safe((r.opds||[]).join(', '))}</td>
              <td>${r.count}</td>
              <td>${opds||'-'}</td>
            </tr>`;
          }
          default: return `<tr><td>‚Äî</td></tr>`;
        }
      }).join('');

      document.getElementById('diag-results').style.display = 'table';
      counter.textContent = rows.length ? `‡∏û‡∏ö ${rows.length} ‡πÄ‡∏Ñ‡∏™` : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
      document.getElementById('diag-results').scrollIntoView({behavior:'smooth', block:'start'});
    }

    function goEditByOPD(opd){
      if(!isValidOPD(opd)) { alert('OPD ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ'); return; }
      const btnTab2 = document.querySelectorAll('.tab-btn')[1];
      switchTab('tab-opd', btnTab2);

      loadDatesByOPDFor(opd).then(()=>{
        const top = document.getElementById('editSection').offsetTop;
        window.scrollTo({ top: Math.max(0, top - 10), behavior: 'smooth' });
      });
    }

    function editFromDiag(opd, id){
      if(!isValidOPD(opd)) { alert('OPD ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å'); return; }
      const btnTab2 = document.querySelectorAll('.tab-btn')[1];
      switchTab('tab-opd', btnTab2);

      loadDatesByOPDFor(opd).then(()=>{
        if(id){ editSelectedRecordById(id); }
        const top = document.getElementById('editSection').offsetTop;
        window.scrollTo({ top: Math.max(0, top - 10), behavior: 'smooth' });
      });
    }

    // ‡∏õ‡∏¥‡∏î popup ‡∏î‡πâ‡∏ß‡∏¢ ESC
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        if(document.getElementById('receiptOverlay').style.display==='flex') closeReceipt();
        else if(document.getElementById('payOverlay').style.display==='flex') closePayPopup();
        else if(document.getElementById('payCaseOverlay').style.display==='flex') closeCasePaymentPopup();
      }
    });

    // =========================
    // Signature Pads (3 ‡∏ä‡πà‡∏≠‡∏á)
    // =========================
    const sigState = {
      authorized: { drawing:false, last:null },
      customer:   { drawing:false, last:null },
      receiver:   { drawing:false, last:null }
    };

    function resizeSigCanvas(canvas, ctx){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      if(rect.width === 0 || rect.height === 0) return;

      canvas.width  = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);

      ctx.setTransform(dpr,0,0,dpr,0,0);

      ctx.save();
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,rect.width,rect.height);
      ctx.restore();
    }

    function setupSigPad(key){
      const canvas = document.getElementById(`sigPad_${key}`);
      if(!canvas) return;

      const ctx = canvas.getContext('2d');
      ctx.lineWidth = 2.2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      resizeSigCanvas(canvas, ctx);

      if(canvas.dataset.bound === '1') return;
      canvas.dataset.bound = '1';

      function getPos(e){
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
      }

      function start(e){
        e.preventDefault();
        sigState[key].drawing = true;
        sigState[key].last = getPos(e);
      }
      function move(e){
        if(!sigState[key].drawing) return;
        e.preventDefault();
        const p = getPos(e);
        const last = sigState[key].last;
        ctx.beginPath();
        ctx.moveTo(last.x, last.y);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        sigState[key].last = p;
      }
      function end(){
        sigState[key].drawing = false;
        sigState[key].last = null;
      }

      canvas.addEventListener('mousedown', start);
      window.addEventListener('mousemove', move);
      window.addEventListener('mouseup', end);

      canvas.addEventListener('touchstart', start, {passive:false});
      canvas.addEventListener('touchmove', move, {passive:false});
      canvas.addEventListener('touchend', end);

      window.addEventListener('resize', ()=> resizeSigCanvas(canvas, ctx));
    }

    function clearSig(key){
      const canvas = document.getElementById(`sigPad_${key}`);
      if(!canvas) return;
      const ctx = canvas.getContext('2d');

      ctx.setTransform(1,0,0,1,0,0);
      ctx.clearRect(0,0,canvas.width,canvas.height);

      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      const dpr = window.devicePixelRatio || 1;
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }

    function initAllSigPads(){
      setupSigPad('authorized');
      setupSigPad('customer');
      setupSigPad('receiver');
    }

async function saveReceiptImage(){
  const overlay = document.getElementById('receiptOverlay');
  const box = overlay?.querySelector('.receipt-box');
  if(!box) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û');

  // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤
  const prev = {
    ovOverflow: overlay.style.overflow,
    boxMaxH: box.style.maxHeight,
    boxOverflow: box.style.overflow,
    boxHeight: box.style.height
  };

  try{
    overlay.classList.add('capture-mode');

    // ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏∑‡∏î‡πÄ‡∏ï‡πá‡∏° ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô
    overlay.style.overflow = 'visible';
    box.style.maxHeight = 'none';
    box.style.overflow = 'visible';
    box.style.height = 'auto';

    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ DOM/‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ô‡∏¥‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô
    if(document.fonts && document.fonts.ready) await document.fonts.ready;
    await new Promise(r => setTimeout(r, 80));

    const fullW = box.scrollWidth;
    const fullH = box.scrollHeight;


// ‚úÖ ‡∏ó‡∏≥ input/textarea ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (html2canvas ‡∏ä‡∏≠‡∏ö)
const replaced = [];
const makeSpanFromInput = (inp) => {
  const span = document.createElement('span');
  span.textContent = inp.value || inp.getAttribute('value') || '';
  // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢ input ‡πÄ‡∏î‡∏¥‡∏°
  const cs = getComputedStyle(inp);
  span.style.display = 'block';
  span.style.width = cs.width;
  span.style.textAlign = cs.textAlign;
  span.style.fontSize = cs.fontSize;
  span.style.fontWeight = cs.fontWeight;
  span.style.color = cs.color;
  span.style.padding = cs.padding;
  span.style.margin = cs.margin;
  span.style.lineHeight = cs.lineHeight;
  span.style.whiteSpace = 'pre-wrap';
  return span;
};

// 1) ‡πÅ‡∏ó‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ï‡πâ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (input.sig-under-input) ‡∏î‡πâ‡∏ß‡∏¢ span
box.querySelectorAll('input.sig-under-input').forEach(inp => {
  const span = makeSpanFromInput(inp);
  inp.style.display = 'none';
  inp.insertAdjacentElement('afterend', span);
  replaced.push({ type:'input', inp, span });
});

// 2) ‡πÅ‡∏ó‡∏ô textarea ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‡∏î‡πâ‡∏ß‡∏¢ div (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ô‡πà ‡πÜ)
const ta = box.querySelector('#receipt_patient_info');
let taDiv = null;
if (ta) {
  taDiv = document.createElement('div');
  taDiv.textContent = ta.value || '';
  const cs = getComputedStyle(ta);
  taDiv.style.whiteSpace = 'pre-wrap';
  taDiv.style.fontSize = cs.fontSize;
  taDiv.style.fontWeight = cs.fontWeight;
  taDiv.style.color = cs.color;
  taDiv.style.lineHeight = cs.lineHeight;
  taDiv.style.marginTop = cs.marginTop;
  taDiv.style.padding = cs.padding;
  taDiv.style.minHeight = cs.minHeight || '32px';
  taDiv.style.border = 'none';
  taDiv.style.background = 'transparent';

  ta.style.display = 'none';
  ta.insertAdjacentElement('afterend', taDiv);
}




    const canvas = await html2canvas(box, {
      backgroundColor: '#ffffff',
      scale: Math.max(2, window.devicePixelRatio || 1),
      useCORS: true,

      // ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á element
      width: fullW,
      height: fullH,
      windowWidth: fullW,
      windowHeight: fullH,

      // ‚úÖ ‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á scroll ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤
      scrollX: 0,
      scrollY: 0
    });

    const dataUrl = canvas.toDataURL('image/png');

    const opd  = (document.getElementById('opd')?.value || '0000').trim();
    const date = (document.getElementById('date')?.value || '').trim();
    const fileName = `receipt_${opd}_${date || 'date'}.png`;

    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    a.remove();

  }catch(err){
    console.error(err);
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }finally{
    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°
    overlay.classList.remove('capture-mode');
    overlay.style.overflow = prev.ovOverflow;
    box.style.maxHeight = prev.boxMaxH;
    box.style.overflow = prev.boxOverflow;
    box.style.height = prev.boxHeight;
  }
}

// =========================
// TAB4: Slip Viewer (filter ‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ/OPD)
// ‡πÉ‡∏ä‡πâ /api/sales (‡∏î‡∏∂‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
// =========================
document.addEventListener('DOMContentLoaded', () => {
  initSlipFilters();
});

function initSlipFilters(){
  const dSel = document.getElementById('slipDay');
  const mSel = document.getElementById('slipMonth');
  const ySel = document.getElementById('slipYear');
  if(!dSel || !mSel || !ySel) return;

  // ‡∏ß‡∏±‡∏ô
  let dOpt = `<option value="">‡∏ß‡∏±‡∏ô (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>`;
  for(let d=1; d<=31; d++){
    dOpt += `<option value="${String(d).padStart(2,'0')}">${d}</option>`;
  }
  dSel.innerHTML = dOpt;

  // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  let mOpt = `<option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>`;
  for(let m=1; m<=12; m++){
    const mm = String(m).padStart(2,'0');
    mOpt += `<option value="${mm}">${m}</option>`;
  }
  mSel.innerHTML = mOpt;

  // ‡∏õ‡∏µ (‡πÉ‡∏ä‡πâ‡πÅ‡∏ô‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö rebuildYear)
  const y = new Date().getFullYear();
  let yOpt = `<option value="">‡∏õ‡∏µ (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>`;
  for(let i=y-3; i<=y+1; i++){
    yOpt += `<option value="${i}">${i}</option>`;
  }
  ySel.innerHTML = yOpt;
  ySel.value = String(y);
}


// =========================================================
// üîç ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å .filter is not a function)
// =========================================================
async function searchReceipts(){
  const result = document.getElementById('slipResult');
  if(!result) return;

  const opdRaw = (document.getElementById('slipOPD')?.value || '').trim();
  const day   = (document.getElementById('slipDay')?.value || '').trim();
  const month = (document.getElementById('slipMonth')?.value || '').trim();
  const year  = (document.getElementById('slipYear')?.value || '').trim();

  if(opdRaw && !/^\d{4}$/.test(opdRaw)){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏ä‡πà‡∏ô 0007)');
    return;
  }

  result.innerHTML = `<div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‚Ä¶</div>`;

  try{
    const rows = await ensureAllSales();

    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡∏ñ‡πâ‡∏≤‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Array) ‡πÉ‡∏´‡πâ‡∏ü‡πâ‡∏≠‡∏á Error
    if(!Array.isArray(rows)){
       console.error("API Error Data:", rows); // ‡∏î‡∏π Error ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô Console (F12)
       throw new Error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Server Error)");
    }

    const filtered = rows.filter(r => {
      const d = String((r.date||'')).slice(0,10);
      const [yy, mm, dd] = d.split('-');

      if(opdRaw && String(r.opd||'').trim().padStart(4,'0') !== opdRaw) return false;
      if(year && yy !== year) return false;
      if(month && mm !== month) return false;
      if(day && dd !== day) return false;
      return true;
    })
    .sort((a,b)=> new Date((b.date||'').slice(0,10)) - new Date((a.date||'').slice(0,10)));

    if(filtered.length === 0){
      result.innerHTML = `<div class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</div>`;
      return;
    }

    result.innerHTML = filtered.map(r=>{
      const date = formatDate(String(r.date||'').slice(0,10));
      const opd  = String(r.opd||'').trim().padStart(4,'0');
      const name = r.name || '-';
      const amount = Number(r.amount||0);
      const amtStr = Number.isFinite(amount) ? amount.toLocaleString() : '0';

      const dispNo = (r.disp_no || r.display_no || '').trim();
      const origNo = (r.orig_no || '').trim();
      const shownNo = dispNo || origNo || '-';

      return `
        <div class="card">
          <div class="left">
            <div><strong>${safe(name)}</strong> <span class="muted">OPD: ${safe(opd)}</span></div>
            <div class="muted">üìÖ ${safe(date)} ‚Ä¢ üí∞ ${safe(amtStr)} ‡∏ö‡∏≤‡∏ó ‚Ä¢ üßæ ${safe(shownNo)}</div>
          </div>
          <div class="actions">
            <button type="button" class="btn btn-primary" onclick="openReceiptFromRecord('${r.id}')">‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
          </div>
        </div>
      `;
    }).join('');

  }catch(err){
    console.error(err);
    result.innerHTML = `<div class="muted">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</div>`;
    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á Alert ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏û‡∏≠
  }
}


function findAnySaleById(id){
  return (allSales || []).find(x => String(x.id) === String(id)) || null;
}

function parseItemsStringToRows(items){
  // items ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô array of string: "label - qty ‡∏ä‡∏¥‡πâ‡∏ô x price ‡∏ö‡∏≤‡∏ó"
  const out = [];
  (Array.isArray(items) ? items : []).forEach(line=>{
    const m = String(line).match(/^(.*?) ?(?:\((.*?)\))? - (\d+(?:\.\d+)?) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+(?:\.\d+)?) ‡∏ö‡∏≤‡∏ó/);
    if(m){
      const main = (m[1]||'').trim();
      const sub  = (m[2]||'').trim();
      const qty  = Math.max(1, Math.floor(Number(m[3]||1)));
      const price= Math.max(0, Math.floor(Number(m[4]||0)));
      const label = sub ? `${main} (${sub})` : main;
      out.push({ label, qty, price });
    }else{
      // ‡∏ñ‡πâ‡∏≤ format ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡∏Å‡πá‡∏¢‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ 1 ‡∏ä‡∏¥‡πâ‡∏ô ‡∏£‡∏≤‡∏Ñ‡∏≤ 0
      const label = String(line||'').trim();
      if(label) out.push({ label, qty:1, price:0 });
    }
  });
  return out;
}

function buildReceiptRowsMixedFromDate(total, rows, dateISO){
  const dateStr = formatDate(String(dateISO||'').slice(0,10));
  const dist = distributeMixedAmount(total, rows);

  let tbody = '';
  dist.lines.forEach((r, idx)=>{
    const qty = Math.max(1, Math.floor(Number(r.qty||1) || 1));
    const unit = Number.isFinite(r.unit) ? r.unit : (qty ? Math.floor(r.lineTotal / qty) : Math.floor(r.lineTotal));

    tbody += `
      <tr>
        <td style="text-align:center;">${idx+1}</td>
        <td>${safe(r.label)}</td>
        <td style="text-align:center;">${qty}</td>
        <td style="text-align:right;">${unit.toLocaleString()}</td>
        <td style="text-align:right;">${Math.floor(r.lineTotal).toLocaleString()}</td>
        <td style="text-align:center;">${safe(dateStr)}</td>
        <td style="text-align:center;">${safe(dateStr)}</td>
      </tr>
    `;
  });

  return { tbody, sum: dist.total, warn: dist.warn };
}

function openReceiptFromRecord(id){
  const rec = findAnySaleById(id);
  if(!rec) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ');

  const total = Math.floor(Number(rec.amount||0));
  const rows = parseItemsStringToRows(rec.items || []);
  if(!rows.length) return alert('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î items');

  const dispNo = (rec.disp_no || rec.display_no || '').trim();
  const origNo = (rec.orig_no || '').trim();
  const showNo = dispNo ? dispNo : (origNo ? origNo.replace(/^RC-/, 'RB-') : '-');

  const receiptNoEl = document.getElementById('receiptNo');
  if(receiptNoEl) receiptNoEl.textContent = showNo;
// ===== B) ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô record) =====
const issueDateISO = (rec.date || '').slice(0,10);
const issueDateText = issueDateISO ? formatDate(issueDateISO) : '-';

const issueEl = document.getElementById('receiptIssueDate');
if(issueEl) issueEl.textContent = issueDateText;
  // ‚úÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á record
  const { tbody, sum } = buildReceiptRowsMixedFromDate(total, rows, rec.date);

  document.getElementById('receiptContent').innerHTML = `
    <table class="receipt-table">
      <thead>
        <tr>
          <th colspan="7" style="text-align:center; font-weight:900;">
            ‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå
          </th>
        </tr>
        <tr>
          <th style="width:60px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
          <th style="width:70px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th style="width:130px;">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ö‡∏≤‡∏ó)</th>
          <th style="width:120px;">‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡∏ö‡∏≤‡∏ó)</th>
          <th style="width:130px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
          <th style="width:130px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody>${tbody}</tbody>
    </table>

    <div class="receipt-total">
      ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô ${sum.toLocaleString()} ‡∏ö‡∏≤‡∏ó
    </div>

    <div class="receipt-section">
      <b>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà):</b><br>
      <textarea id="receipt_patient_info" rows="2"
        placeholder="‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤&#10;‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤"
      ></textarea>
    </div>
  `;

  const ov = document.getElementById('receiptOverlay');
  ov.style.display = 'flex';
  ov.setAttribute('aria-hidden','false');
// ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à = ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á record
setReceiptIssueDateFromISO(rec.date || '');
  applySigNamesToReceipt();
  requestAnimationFrame(() => initAllSigPads());
}



document.addEventListener('DOMContentLoaded', () => {
  const ipt = document.getElementById('slipOPD');
  if(ipt){
    ipt.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); searchReceipts(); }
    });
  }
});

function setReceiptIssueDateFromISO(dateISO){
  const el = document.getElementById('receiptIssueDate');
  if(!el) return;

  if(!dateISO){
    el.textContent = '-';
    return;
  }

  el.textContent = formatDate(dateISO.slice(0,10));
}



// =========================
// TAB 3: Customer Status (State)  ‚úÖ (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)
// =========================
let csState = {
  opd: '',
  name: '',
  phone: '',
  ar: [],      // {dt, type, amount, method, note}
  credit: [],  // {dt, type, amount, note}
  ent: []      // {id, name, unit, purchased, used, purchased_at, note}
};

let csModalMode = '';

function nowLocalInputValue(){
  const d = new Date();
  const pad = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function money(n){
  const x = Math.floor(Number(n||0) || 0);
  return `${x.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
}

function setBadges(){
  const wrap = document.getElementById('cs_badges');
  if(!wrap) return;
  wrap.innerHTML = '';

  const arBal = calcAR();
  const crBal = calcCredit();
  const entCount = (csState.ent || []).filter(e => (e.purchased - e.used) > 0).length;

  if(arBal > 0){
    const b = document.createElement('span');
    b.className = 'badge ar';
    b.textContent = `‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ${money(arBal)}`;
    wrap.appendChild(b);
  }
  if(crBal > 0){
    const b = document.createElement('span');
    b.className = 'badge credit';
    b.textContent = `‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï ${money(crBal)}`;
    wrap.appendChild(b);
  }
  if(entCount > 0){
    const b = document.createElement('span');
    b.className = 'badge todo';
    b.textContent = `‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥ ${entCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    wrap.appendChild(b);
  }
  if(arBal<=0 && crBal<=0 && entCount<=0 && csState.opd){
    const b = document.createElement('span');
    b.className = 'badge';
    b.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á';
    wrap.appendChild(b);
  }
}

function calcAR(){
  // CHARGE +, PAYMENT -, REFUND/ADJUST -
  return (csState.ar||[]).reduce((bal, r)=>{
    const amt = Math.floor(Number(r.amount||0) || 0);
    if(r.type === 'CHARGE') return bal + amt;
    if(r.type === 'PAYMENT') return bal - amt;
    if(r.type === 'REFUND' || r.type === 'ADJUST') return bal - amt;
    return bal;
  }, 0);
}
function calcCredit(){
  // TOPUP +, APPLY -, REFUND -
  return (csState.credit||[]).reduce((bal, r)=>{
    const amt = Math.floor(Number(r.amount||0) || 0);
    if(r.type === 'TOPUP') return bal + amt;
    if(r.type === 'APPLY') return bal - amt;
    if(r.type === 'REFUND') return bal - amt;
    if(r.type === 'ADJUST') return bal + amt; // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î‡πÑ‡∏î‡πâ (‡∏Ñ‡∏∏‡∏°‡∏à‡∏≤‡∏Å note)
    return bal;
  }, 0);
}

function renderCS(){
  document.getElementById('cs_name').textContent = csState.opd ? (csState.name || '(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)') : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å OPD';
  document.getElementById('cs_opd_show').textContent = csState.opd || '-';
  document.getElementById('cs_phone').textContent = csState.phone || '-';

  document.getElementById('cs_ar_balance').textContent = csState.opd ? money(calcAR()) : '-';
  document.getElementById('cs_credit_balance').textContent = csState.opd ? money(calcCredit()) : '-';
  const entCount = (csState.ent||[]).filter(e => (e.purchased - e.used) > 0).length;
  document.getElementById('cs_ent_count').textContent = csState.opd ? `${entCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : '-';

  renderARTable();
  renderCRTable();
  renderEntitlements();

  setBadges();
}

function renderARTable(){
  const tbl = document.getElementById('cs_ar_table');
  const body = document.getElementById('cs_ar_body');
  const empty = document.getElementById('cs_ar_empty');
  const rows = csState.ar || [];

  if(!csState.opd || rows.length===0){
    tbl.style.display='none';
    empty.style.display='block';
    empty.textContent = csState.opd ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ OPD ‡∏Å‡πà‡∏≠‡∏ô';
    return;
  }

  let bal = 0;
  const sorted = [...rows].sort((a,b)=> new Date(a.dt) - new Date(b.dt));

  body.innerHTML = '';
  sorted.forEach(r=>{
    const amt = Math.floor(Number(r.amount||0)||0);
    if(r.type === 'CHARGE') bal += amt;
    else if(r.type === 'PAYMENT') bal -= amt;
    else if(r.type === 'REFUND' || r.type === 'ADJUST') bal -= amt;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${safe(new Date(r.dt).toLocaleString())}</td>
      <td class="center">${safe(r.type)}</td>
      <td class="right">${amt.toLocaleString()}</td>
      <td>${safe(r.method||'-')}</td>
      <td>${safe(r.note||'')}</td>
      <td class="right" style="font-weight:900;">${bal.toLocaleString()}</td>
    `;
    body.appendChild(tr);
  });

  tbl.style.display='table';
  empty.style.display='none';
}

function renderCRTable(){
  const tbl = document.getElementById('cs_cr_table');
  const body = document.getElementById('cs_cr_body');
  const empty = document.getElementById('cs_cr_empty');
  const rows = csState.credit || [];

  if(!csState.opd || rows.length===0){
    tbl.style.display='none';
    empty.style.display='block';
    empty.textContent = csState.opd ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ OPD ‡∏Å‡πà‡∏≠‡∏ô';
    return;
  }

  let bal = 0;
  const sorted = [...rows].sort((a,b)=> new Date(a.dt) - new Date(b.dt));

  body.innerHTML = '';
  sorted.forEach(r=>{
    const amt = Math.floor(Number(r.amount||0)||0);
    if(r.type === 'TOPUP') bal += amt;
    else if(r.type === 'APPLY') bal -= amt;
    else if(r.type === 'REFUND') bal -= amt;
    else if(r.type === 'ADJUST') bal += amt;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${safe(new Date(r.dt).toLocaleString())}</td>
      <td class="center">${safe(r.type)}</td>
      <td class="right">${amt.toLocaleString()}</td>
      <td>${safe(r.note||'')}</td>
      <td class="right" style="font-weight:900;">${bal.toLocaleString()}</td>
    `;
    body.appendChild(tr);
  });

  tbl.style.display='table';
  empty.style.display='none';
}

function renderEntitlements(){
  const list = document.getElementById('cs_ent_list');
  const empty = document.getElementById('cs_ent_empty');
  const ents = csState.ent || [];

  list.innerHTML = '';

  if(!csState.opd){
    empty.style.display='block';
    empty.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ OPD ‡∏Å‡πà‡∏≠‡∏ô';
    return;
  }
  if(ents.length===0){
    empty.style.display='block';
    empty.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠';
    return;
  }

  empty.style.display='none';

  ents.forEach(e=>{
    const purchased = Math.floor(Number(e.purchased||0)||0);
    const used = Math.floor(Number(e.used||0)||0);
    const remain = Math.max(0, purchased - used);
    const pct = purchased>0 ? Math.min(100, Math.round((used/purchased)*100)) : 0;

    const card = document.createElement('div');
    card.className = 'ent-card';
    card.innerHTML = `
      <div class="ent-top">
        <div>
          <div class="ent-name">${safe(e.name || '-')}</div>
          <div class="ent-meta">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${safe(e.purchased_at ? new Date(e.purchased_at).toLocaleDateString() : '-')} ‚Ä¢ ‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${safe(e.unit||'-')}</div>
        </div>
        <div style="font-weight:1000;color:#0b7660;">
          ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remain.toLocaleString()} / ${purchased.toLocaleString()} ${safe(e.unit||'')}
        </div>
      </div>

      <div class="ent-bar"><div style="width:${pct}%"></div></div>

      <div class="ent-actions">
        <button type="button" class="btn btn-primary" onclick="openUseEntitlement('${safe(e.id)}')">‡∏ï‡∏±‡∏î‡πÉ‡∏ä‡πâ</button>
        <button type="button" class="btn btn-outline" onclick="alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥')">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
      </div>
      ${e.note ? `<div class="muted" style="margin-top:8px;">üìù ${safe(e.note)}</div>` : ``}
    `;
    list.appendChild(card);
  });
}

// ‚úÖ ‡πÅ‡∏Å‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô ‚Äú‡πÄ‡∏™‡∏°‡∏≠‚Äù ‡πÅ‡∏°‡πâ customerMap ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°
function loadCustomerStatus(){
  const opd = (document.getElementById('cs_opd')?.value || '').trim();
  if(!/^\d{4}$/.test(opd)) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å');

  // ‡πÉ‡∏ä‡πâ customerMap ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å state ‡∏Ç‡∏≠‡∏á AR (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  const c0 = customerMap?.[opd] || null;

  let name = (c0?.name || '').trim();
  let phone= (c0?.phone|| '').trim();

  // fallback: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å AR state (debt/credit/pending) ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô
  try{
    if((!name || !phone) && typeof AR !== 'undefined' && AR && typeof AR.getCustomerFallback === 'function'){
      const f = AR.getCustomerFallback(opd) || {};
      name = name || (f.name || '').trim();
      phone= phone|| (f.phone|| '').trim();
    }
  }catch(e){}

  csState.opd = opd;
  csState.name = name;
  csState.phone = phone;

  // ‚úÖ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏∂‡∏á history ‡∏Ç‡∏≠‡∏á csState ‡∏à‡∏≤‡∏Å backend ‡πÉ‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ú‡∏°‡∏ï‡πà‡∏≠ /api/*_history ‡πÉ‡∏´‡πâ)
  renderCS();
}

function clearCustomerStatus(){
  csState = { opd:'', name:'', phone:'', ar:[], credit:[], ent:[] };
  const ipt = document.getElementById('cs_opd');
  if(ipt) ipt.value = '';
  renderCS();
}

// ---- Modal controls ----
function openCSModal(mode){
  if(!csState.opd) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ OPD ‡∏Å‡πà‡∏≠‡∏ô');
  csModalMode = mode;

  const title = document.getElementById('csModalTitle');
  const sub = document.getElementById('csModalSub');

  // reset fields
  document.getElementById('cs_m_date').value = nowLocalInputValue();
  document.getElementById('cs_m_amount').value = '';
  document.getElementById('cs_m_method').value = '';
  document.getElementById('cs_m_note').value = '';
  document.getElementById('cs_m_unit').value = '‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
  document.getElementById('cs_m_qty').value = 1;
  document.getElementById('cs_m_product').value = '';

  // show/hide rows
  const show = (id, yes)=>{ const el=document.getElementById(id); if(el) el.style.display = yes?'grid':'none'; };
  show('cs_m_method_row', false);
  show('cs_m_unit_row', false);
  show('cs_m_qty_row', false);
  show('cs_m_product_row', false);
  document.getElementById('cs_m_amount_row').style.display = 'grid';

  if(mode==='ar_charge'){
    title.textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏µ‡πâ (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏≤)';
    sub.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô CHARGE';
  }
  if(mode==='ar_pay'){
    title.textContent = 'üí∏ ‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞ (‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)';
    sub.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PAYMENT';
    show('cs_m_method_row', true);
  }
  if(mode==='ar_adjust'){
    title.textContent = 'üßæ ‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ/‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô';
    sub.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô REFUND/ADJUST';
  }

  if(mode==='cr_topup'){
    title.textContent = '‚ûï ‡∏£‡∏±‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥/‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï';
    sub.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô TOPUP';
    show('cs_m_method_row', true);
  }
  if(mode==='cr_apply'){
    title.textContent = 'üßæ ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï';
    sub.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô APPLY (‡∏´‡∏±‡∏Å‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï)';
  }
  if(mode==='cr_refund'){
    title.textContent = '‚Ü©Ô∏è ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï';
    sub.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô REFUND (‡∏´‡∏±‡∏Å‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï)';
  }

  if(mode==='en_add'){
    title.textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥)';
    sub.textContent = '‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏≠‡∏£‡πå‡∏™ 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ 2 ‡∏ä‡∏¥‡πâ‡∏ô';
    document.getElementById('cs_m_amount_row').style.display = 'none';
    show('cs_m_product_row', true);
    show('cs_m_unit_row', true);
    show('cs_m_qty_row', true);
  }

  const ov = document.getElementById('csModal');
  ov.style.display='flex';
  ov.setAttribute('aria-hidden','false');
}

function closeCSModal(){
  const ov = document.getElementById('csModal');
  ov.style.display='none';
  ov.setAttribute('aria-hidden','true');
}

function openUseEntitlement(entId){
  const ent = (csState.ent||[]).find(x=> String(x.id)===String(entId));
  if(!ent) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ô‡∏µ‡πâ');

  csModalMode = `en_use:${entId}`;

  document.getElementById('csModalTitle').textContent = `‚úÖ ‡∏ï‡∏±‡∏î‡πÉ‡∏ä‡πâ: ${ent.name}`;
  document.getElementById('csModalSub').textContent = `‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${ent.unit} ‚Ä¢ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${Math.max(0, ent.purchased-ent.used)} / ${ent.purchased}`;

  document.getElementById('cs_m_date').value = nowLocalInputValue();
  document.getElementById('cs_m_note').value = '';

  document.getElementById('cs_m_amount_row').style.display = 'none';
  document.getElementById('cs_m_method_row').style.display = 'none';

  document.getElementById('cs_m_product_row').style.display = 'none';
  document.getElementById('cs_m_unit_row').style.display = 'none';
  document.getElementById('cs_m_qty_row').style.display = 'grid';
  document.getElementById('cs_m_qty').value = 1;

  const ov = document.getElementById('csModal');
  ov.style.display='flex';
  ov.setAttribute('aria-hidden','false');
}

function saveCSModal(){
  const dt = document.getElementById('cs_m_date').value;
  const note = (document.getElementById('cs_m_note').value||'').trim();

  const iso = dt ? new Date(dt).toISOString() : new Date().toISOString();

  if(String(csModalMode||'').startsWith('en_use:')){
    const entId = csModalMode.split(':')[1];
    const ent = (csState.ent||[]).find(x=> String(x.id)===String(entId));
    if(!ent) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ô‡∏µ‡πâ');

    const usedQty = Math.max(1, Math.floor(Number(document.getElementById('cs_m_qty').value||1) || 1));
    const remain = Math.max(0, ent.purchased - ent.used);
    if(usedQty > remain) return alert(`‡∏ï‡∏±‡∏î‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remain})`);

    ent.used += usedQty;
    closeCSModal();
    renderCS();
    return;
  }

  if(csModalMode === 'en_add'){
    const name = (document.getElementById('cs_m_product').value||'').trim();
    const unit = document.getElementById('cs_m_unit').value || '‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
    const qty = Math.max(1, Math.floor(Number(document.getElementById('cs_m_qty').value||1) || 1));
    if(!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£');

    csState.ent.push({
      id: 'ent_' + Math.random().toString(16).slice(2),
      name,
      unit,
      purchased: qty,
      used: 0,
      purchased_at: iso,
      note
    });

    closeCSModal();
    renderCS();
    return;
  }

  const amt = Math.floor(Number(document.getElementById('cs_m_amount').value||0) || 0);
  if(!Number.isFinite(amt) || amt<=0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

  const method = (document.getElementById('cs_m_method').value||'').trim();

  if(csModalMode === 'ar_charge'){
    csState.ar.push({dt: iso, type:'CHARGE', amount: amt, method:'', note});
  }
  if(csModalMode === 'ar_pay'){
    csState.ar.push({dt: iso, type:'PAYMENT', amount: amt, method: method || getPayment(), note});
  }
  if(csModalMode === 'ar_adjust'){
    csState.ar.push({dt: iso, type:'ADJUST', amount: amt, method:'', note});
  }

  if(csModalMode === 'cr_topup'){
    csState.credit.push({dt: iso, type:'TOPUP', amount: amt, note: note || `‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (${method||getPayment()})`});
  }
  if(csModalMode === 'cr_apply'){
    csState.credit.push({dt: iso, type:'APPLY', amount: amt, note});
  }
  if(csModalMode === 'cr_refund'){
    csState.credit.push({dt: iso, type:'REFUND', amount: amt, note});
  }

  closeCSModal();
  renderCS();
}

// ESC close cs modal
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    const ov = document.getElementById('csModal');
    if(ov && ov.style.display==='flex') closeCSModal();
  }
});

// initial render (empty)
document.addEventListener('DOMContentLoaded', ()=> {
  try{ renderCS(); }catch(e){}
});



// =========================
// TAB 3: Data + UI  (Legacy local modal)  ‚úÖ ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ AR ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á‡πÉ‡∏ä‡πâ Supabase ‡πÅ‡∏•‡πâ‡∏ß
// =========================
let arFilter = 'all';

// storage (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á)
let arDebt = [];     // [{opd,name,phone,amount,last_paid_at,note}]
let arCredit = [];   // [{opd,name,phone,balance,last_topup_at,credit_type,note}]
let arPending = [];  // [{opd,name,phone,item,unit,qty,updated_at,note}]

function arInitTab3(){
  const d = new Date();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const today = `${d.getFullYear()}-${mm}-${dd}`;
  const dateEl = document.getElementById('ar_date');
  if(dateEl) dateEl.value = today;

  arBuildCustomerDatalist();

  const s = document.getElementById('arSearch');
  if(s){
    s.addEventListener('input', ()=> arRenderAll());
  }

  const pick = document.getElementById('arCustomerPick');
  if(pick){
    pick.addEventListener('change', ()=> arApplyPickedCustomer());
    pick.addEventListener('input', ()=> {});
  }

  arRenderAll();
}

function arBuildCustomerDatalist(){
  const dl = document.getElementById('arCustomerList');
  if(!dl) return;

  const entries = Object.entries(customerMap || {});
  const opts = entries.map(([opd, c])=>{
    const name = (c?.name || '').trim();
    const phone= (c?.phone|| '').trim();
    const label = `${opd} | ${name}${phone?` | ${phone}`:''}`.trim();
    return `<option value="${safe(label)}"></option>`;
  }).join('');

  dl.innerHTML = opts;
}

function arApplyPickedCustomer(){
  const v = (document.getElementById('arCustomerPick')?.value || '').trim();
  if(!v) return;

  const parts = v.split('|').map(x=>x.trim()).filter(Boolean);
  let opd = '';
  let name = '';
  let phone = '';
  if(parts.length >= 1 && /^\d{4}$/.test(parts[0])) opd = parts[0];
  if(parts.length >= 2) name = parts[1];
  if(parts.length >= 3) phone = parts[2];

  if(opd && customerMap[opd]){
    const c = customerMap[opd];
    name = name || (c.name||'');
    phone = phone || (c.phone||'');
  }

  const opdEl = document.getElementById('ar_opd');
  const nameEl= document.getElementById('ar_name');
  const phEl  = document.getElementById('ar_phone');
  if(opdEl) opdEl.value = opd || '';
  if(nameEl) nameEl.value = name || '';
  if(phEl) phEl.value = phone || '';
}

function arClearPicked(){
  const pick = document.getElementById('arCustomerPick');
  if(pick) pick.value = '';
  const opdEl = document.getElementById('ar_opd');
  const nameEl= document.getElementById('ar_name');
  const phEl  = document.getElementById('ar_phone');
  if(opdEl) opdEl.value = '';
  if(nameEl) nameEl.value = '';
  if(phEl) phEl.value = '';
}

function arSetFilter(type, btn){
  arFilter = type;
  document.querySelectorAll('.ar-chip').forEach(x=>x.classList.remove('active'));
  if(btn) btn.classList.add('active');
  arRenderAll();
}

function arClearSearch(){
  const s = document.getElementById('arSearch');
  if(s) s.value = '';
  arRenderAll();
}

function arMatchSearch(obj, q){
  const needle = String(q||'').trim().toLowerCase();
  if(!needle) return true;
  const hay = [
    obj.opd || '',
    obj.name || '',
    obj.phone || '',
    obj.item || ''
  ].join(' ').toLowerCase();
  return hay.includes(needle);
}

function arFmtDate(iso){
  if(!iso) return '-';
  return formatDate(String(iso).slice(0,10));
}
function arMoney(n){
  const x = Math.max(0, Math.floor(Number(n||0) || 0));
  return x.toLocaleString();
}

function arComputeSummary(){
  const debtTotal = arDebt.reduce((s,x)=> s + (Number(x.amount)||0), 0);
  const debtPeople = new Set(arDebt.map(x=>x.opd||'')).size;
  const debtLast = arDebt
    .map(x=>x.last_paid_at || '')
    .filter(Boolean)
    .sort((a,b)=> new Date(b) - new Date(a))[0] || '';

  const creditTotal = arCredit.reduce((s,x)=> s + (Number(x.balance)||0), 0);
  const creditPeople = new Set(arCredit.map(x=>x.opd||'')).size;
  const creditLast = arCredit
    .map(x=>x.last_topup_at || '')
    .filter(Boolean)
    .sort((a,b)=> new Date(b) - new Date(a))[0] || '';

  const pendingQty = arPending.reduce((s,x)=> s + (Number(x.qty)||0), 0);
  const pendingPeople = new Set(arPending.map(x=>x.opd||'')).size;
  const pendingLast = arPending
    .map(x=>x.updated_at || '')
    .filter(Boolean)
    .sort((a,b)=> new Date(b) - new Date(a))[0] || '';

  return {
    debtTotal, debtPeople, debtLast,
    creditTotal, creditPeople, creditLast,
    pendingQty, pendingPeople, pendingLast
  };
}

function arRenderAll(){
  const q = (document.getElementById('arSearch')?.value || '').trim();

  const sum = arComputeSummary();
  document.getElementById('sumDebtMoney').textContent = `${arMoney(sum.debtTotal)} ‡∏ö‡∏≤‡∏ó`;
  document.getElementById('sumDebtPeople').textContent = `${sum.debtPeople} ‡∏Ñ‡∏ô`;
  document.getElementById('sumDebtLast').textContent = sum.debtLast ? arFmtDate(sum.debtLast) : '-';

  document.getElementById('sumCreditMoney').textContent = `${arMoney(sum.creditTotal)} ‡∏ö‡∏≤‡∏ó`;
  document.getElementById('sumCreditPeople').textContent = `${sum.creditPeople} ‡∏Ñ‡∏ô`;
  document.getElementById('sumCreditLast').textContent = sum.creditLast ? arFmtDate(sum.creditLast) : '-';

  document.getElementById('sumPendingQty').textContent = `${arMoney(sum.pendingQty)} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ä‡∏¥‡πâ‡∏ô`;
  document.getElementById('sumPendingPeople').textContent = `${sum.pendingPeople} ‡∏Ñ‡∏ô`;
  document.getElementById('sumPendingLast').textContent = sum.pendingLast ? arFmtDate(sum.pendingLast) : '-';

  const showDebt = (arFilter === 'all' || arFilter === 'debt');
  const showCredit = (arFilter === 'all' || arFilter === 'credit');
  const showPending = (arFilter === 'all' || arFilter === 'pending');

  document.getElementById('secDebt').style.display = showDebt ? 'block' : 'none';
  document.getElementById('secCredit').style.display = showCredit ? 'block' : 'none';
  document.getElementById('secPending').style.display = showPending ? 'block' : 'none';

  const debtRows = arDebt.filter(x=> arMatchSearch(x, q)).sort((a,b)=> (Number(b.amount)||0) - (Number(a.amount)||0));
  const creditRows = arCredit.filter(x=> arMatchSearch(x, q)).sort((a,b)=> (Number(b.balance)||0) - (Number(a.balance)||0));
  const pendingRows = arPending.filter(x=> arMatchSearch(x, q)).sort((a,b)=> new Date((b.updated_at||'1970-01-01')) - new Date((a.updated_at||'1970-01-01')));

  const tbDebt = document.getElementById('tbDebt');
  tbDebt.innerHTML = debtRows.map(r=>`
    <tr>
      <td>${safe(r.opd||'-')}</td>
      <td><strong>${safe(r.name||'-')}</strong></td>
      <td>${safe(r.phone||'-')}</td>
      <td class="money-red" style="text-align:right;">${arMoney(r.amount)} ‡∏ö‡∏≤‡∏ó</td>
      <td style="text-align:center;">${arFmtDate(r.last_paid_at)}</td>
      <td>${safe(r.note||'')}</td>
    </tr>
  `).join('');
  document.getElementById('emptyDebt').style.display = debtRows.length ? 'none' : 'block';

  const tbCredit = document.getElementById('tbCredit');
  tbCredit.innerHTML = creditRows.map(r=>`
    <tr>
      <td>${safe(r.opd||'-')}</td>
      <td><strong>${safe(r.name||'-')}</strong></td>
      <td>${safe(r.phone||'-')}</td>
      <td class="money-green" style="text-align:right;">${arMoney(r.balance)} ‡∏ö‡∏≤‡∏ó</td>
      <td style="text-align:center;">${arFmtDate(r.last_topup_at)}</td>
      <td style="text-align:center;">${safe(r.credit_type||'-')}</td>
      <td>${safe(r.note||'')}</td>
    </tr>
  `).join('');
  document.getElementById('emptyCredit').style.display = creditRows.length ? 'none' : 'block';

  const tbPending = document.getElementById('tbPending');
  tbPending.innerHTML = pendingRows.map(r=>`
    <tr>
      <td>${safe(r.opd||'-')}</td>
      <td><strong>${safe(r.name||'-')}</strong></td>
      <td>${safe(r.phone||'-')}</td>
      <td>${safe(r.item||'-')}</td>
      <td style="text-align:right;font-weight:1000;color:#0b7660;">${arMoney(r.qty)} ${safe(r.unit||'‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ä‡∏¥‡πâ‡∏ô')}</td>
      <td style="text-align:center;">${arFmtDate(r.updated_at)}</td>
      <td>${safe(r.note||'')}</td>
    </tr>
  `).join('');
  document.getElementById('emptyPending').style.display = pendingRows.length ? 'none' : 'block';
}

// =========================
// TAB 3: Modal add (legacy local)  ‚úÖ ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏•‡∏á Supabase
// =========================
let arModalMode = 'debt'; // debt | credit | pending

function openArModal(mode){
  arModalMode = mode;

  const ov = document.getElementById('arOverlay');
  ov.style.display = 'flex';
  ov.setAttribute('aria-hidden','false');

  const d = new Date();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const today = `${d.getFullYear()}-${mm}-${dd}`;
  const dateEl = document.getElementById('ar_date');
  if(dateEl && !dateEl.value) dateEl.value = today;

  arClearPicked();
  document.getElementById('ar_note').value = '';

  const dyn = document.getElementById('arDynamicFields');
  dyn.innerHTML = '';

  const title = document.getElementById('arModalTitle');
  const sub = document.getElementById('arModalSub');

  if(mode === 'debt'){
    title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏¥‡∏ô';
    sub.textContent = '‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡πà‡∏≤‡∏¢ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡πÅ‡∏ó‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ)';
    dyn.innerHTML = `
      <div class="mini-grid">
        <div class="field">
          <b>‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</b>
          <input id="ar_amount" type="number" min="0" step="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1500">
        </div>
        <div class="field">
          <b>‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡πà‡∏≤‡∏¢ (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)</b>
          <input id="ar_last" type="date">
          <div class="muted">‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏¢ ‡πÉ‡∏™‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ</div>
        </div>
      </div>
    `;
    document.getElementById('ar_last').value = (document.getElementById('ar_date')?.value || today);
  }

  if(mode === 'credit'){
    title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô';
    sub.textContent = '‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏ì‡∏µ‡∏ß‡πâ‡∏≠‡∏¢‡πÄ‡∏ä‡∏≠‡∏£‡πå/‡∏°‡∏±‡∏î‡∏à‡∏≥/‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏)';
    dyn.innerHTML = `
      <div class="mini-grid">
        <div class="field">
          <b>‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ö‡∏≤‡∏ó)</b>
          <input id="ar_balance" type="number" min="0" step="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3000">
        </div>
        <div class="field">
          <b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</b>
          <select id="ar_credit_type">
            <option value="‡∏°‡∏±‡∏î‡∏à‡∏≥">‡∏°‡∏±‡∏î‡∏à‡∏≥</option>
            <option value="‡∏ß‡πâ‡∏≠‡∏¢‡πÄ‡∏ä‡∏≠‡∏£‡πå">‡∏ß‡πâ‡∏≠‡∏¢‡πÄ‡∏ä‡∏≠‡∏£‡πå</option>
            <option value="‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</option>
          </select>
        </div>
        <div class="field">
          <b>‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏ï‡∏¥‡∏° (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)</b>
          <input id="ar_last_topup" type="date">
        </div>
      </div>
    `;
    document.getElementById('ar_last_topup').value = (document.getElementById('ar_date')?.value || today);
  }

  if(mode === 'pending'){
    title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥';
    sub.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå/‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏ß‡πâ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥ (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏Ñ‡∏£‡∏±‡πâ‡∏á‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏ä‡∏¥‡πâ‡∏ô‚Äù)';
    dyn.innerHTML = `
      <div class="mini-grid">
        <div class="field" style="grid-column:1/-1;">
          <b>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥</b>
          <input id="ar_item" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏£‡∏±‡∏Å‡πÅ‡∏£‡πâ / ‡∏ó‡∏£‡∏µ‡∏ï‡πÄ‡∏°‡∏ô‡∏ï‡πå / ‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå 50u">
        </div>
        <div class="field">
          <b>‡∏´‡∏ô‡πà‡∏ß‡∏¢</b>
          <select id="ar_unit">
            <option value="‡∏Ñ‡∏£‡∏±‡πâ‡∏á">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</option>
            <option value="‡∏ä‡∏¥‡πâ‡∏ô">‡∏ä‡∏¥‡πâ‡∏ô</option>
          </select>
        </div>
        <div class="field">
          <b>‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</b>
          <input id="ar_qty" type="number" min="1" step="1" value="1">
        </div>
        <div class="field">
          <b>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)</b>
          <input id="ar_updated" type="date">
        </div>
      </div>
    `;
    document.getElementById('ar_updated').value = (document.getElementById('ar_date')?.value || today);
  }
}

function closeArModal(){
  const ov = document.getElementById('arOverlay');
  ov.style.display = 'none';
  ov.setAttribute('aria-hidden','true');
}

function saveArModal(){
  const opd = (document.getElementById('ar_opd')?.value || '').trim();
  const name = (document.getElementById('ar_name')?.value || '').trim();
  const phone = (document.getElementById('ar_phone')?.value || '').trim();
  const dateBase = (document.getElementById('ar_date')?.value || '').slice(0,10);
  const note = (document.getElementById('ar_note')?.value || '').trim();

  if(!/^\d{4}$/.test(opd)) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å');
  if(!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠');

  if(arModalMode === 'debt'){
    const amount = Math.floor(Number(document.getElementById('ar_amount')?.value || 0));
    const last = (document.getElementById('ar_last')?.value || dateBase || '').slice(0,10);
    if(!(amount > 0)) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏¥‡∏ô (> 0)');

    arDebt = arDebt.filter(x=> String(x.opd) !== String(opd));
    arDebt.push({ opd, name, phone, amount, last_paid_at: last || dateBase, note });

    closeArModal();
    arRenderAll();
    return;
  }

  if(arModalMode === 'credit'){
    const balance = Math.floor(Number(document.getElementById('ar_balance')?.value || 0));
    const credit_type = (document.getElementById('ar_credit_type')?.value || '‡∏°‡∏±‡∏î‡∏à‡∏≥').trim();
    const last = (document.getElementById('ar_last_topup')?.value || dateBase || '').slice(0,10);
    if(!(balance > 0)) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (> 0)');

    arCredit = arCredit.filter(x=> String(x.opd) !== String(opd));
    arCredit.push({ opd, name, phone, balance, last_topup_at: last || dateBase, credit_type, note });

    closeArModal();
    arRenderAll();
    return;
  }

  if(arModalMode === 'pending'){
    const item = (document.getElementById('ar_item')?.value || '').trim();
    const unit = (document.getElementById('ar_unit')?.value || '‡∏Ñ‡∏£‡∏±‡πâ‡∏á').trim();
    const qty = Math.floor(Number(document.getElementById('ar_qty')?.value || 0));
    const updated = (document.getElementById('ar_updated')?.value || dateBase || '').slice(0,10);

    if(!item) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥');
    if(!(qty > 0)) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á (> 0)');

    arPending.push({ opd, name, phone, item, unit, qty, updated_at: updated || dateBase, note });

    closeArModal();
    arRenderAll();
    return;
  }
}

document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    if(document.getElementById('arOverlay')?.style.display === 'flex') closeArModal();
  }
});

document.addEventListener('DOMContentLoaded', () => {
  arInitTab3();
});


// =========================
// TAB 3 Controller (DEBT / CREDIT / PENDING) - ‚úÖ Supabase Connected + ‚úÖ ‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å API ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
// =========================
// ‚úÖ 2. ‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡∏Å‡πâ‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏±‡∏ö const AR ‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤ "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
const AR = (() => {

  // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Dropdown ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ---
  function populateTxCats() {
    const catSel = document.getElementById('arTxCategory');
    if (!catSel) return;
    const keys = (typeof mainCategoryKeys === 'function') ? mainCategoryKeys() : []; 
    catSel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î --</option>` +
      keys.map(k => `<option value="${safe(k)}">${safe(k)}</option>`).join('');
  }

  function onCatChange() {
    const catSel = document.getElementById('arTxCategory');
    const prodSel = document.getElementById('arTxProduct');
    if (!catSel || !prodSel) return;

    const selectedCat = catSel.value;
    let options = (typeof subOptionsMap !== 'undefined' && subOptionsMap[selectedCat]) ? subOptionsMap[selectedCat] : [];

    if (selectedCat === '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©') {
       options = Object.entries(subOptionsMap || {})
         .filter(([k]) => k !== '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©')
         .flatMap(([_, arr]) => arr || []);
    }

    const uniqNames = [];
    const seen = new Set();
    (options || []).forEach(o => {
      const n = String((typeof o === 'string') ? o : (o?.name || '')).trim();
      if (!n || seen.has(n)) return;
      seen.add(n);
      uniqNames.push(n);
    });

    prodSel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>' +
      uniqNames.map(n => `<option value="${safe(n)}">${safe(n)}</option>`).join('');
  }

  // --- HTTP Helpers ---
  async function apiGet(url){
    const res = await fetch(url, { credentials: 'include' });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
    return data;
  }

  async function apiPost(url, body){
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(body || {})
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
    return data;
  }

  // --- Data & State ---
  function getCustomerList(){
    const out = [];
    Object.entries(customerMap || {}).forEach(([opd, v])=>{
      out.push({ opd, name: v?.name || '', phone: v?.phone || '' });
    });
    return out;
  }

  const state = {
    q: '',
    debt: new Map(), credit: new Map(), pending: new Map(), hist: new Map(),
    modal: { section:null, mode:null, target:null }
  };

  // --- Utils ---
  const todayISO = () => {
    const d = new Date();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${d.getFullYear()}-${mm}-${dd}`;
  };
  const fmtDate = (iso) => formatDate(String(iso||'').slice(0,10));
  const money = (n) => (Math.floor(Number(n||0))).toLocaleString();
  function norm(s){ return String(s||'').trim().toLowerCase(); }
  function digits(s){ return String(s||'').replace(/\D/g,''); }

  function findMatches(q){
    const qq = norm(q), dd = digits(q);
    const list = getCustomerList();
    return list.filter(c=>{
      const op = norm(c.opd), nm = norm(c.name), ph = digits(c.phone);
      if(!qq && !dd) return true;
      return (qq && (nm.includes(qq) || op.includes(qq))) || (dd && ph.includes(dd)) || (qq && digits(qq) && ph.includes(digits(qq)));
    });
  }

  function ensureCustomerFromOPD(opd){
    const fromMap = (getCustomerList().find(x=>x.opd===opd) || {opd, name:'', phone:''});
    const d = state.debt.get(opd) || {}, c = state.credit.get(opd) || {};
    return { opd, name: (fromMap.name || d.name || c.name || ''), phone:(fromMap.phone|| d.phone|| c.phone|| '') };
  }

  function getCustomerFallback(opd){
    const d = state.debt.get(opd) || {}, c = state.credit.get(opd) || {};
    let pName = '', pPhone = '';
    state.pending.forEach(v=>{ if(v && v.opd === opd){ pName = pName || (v.name||''); pPhone= pPhone|| (v.phone||''); } });
    return { name: d.name || c.name || pName || '', phone: d.phone || c.phone || pPhone || '' };
  }

  function histKeyDebt(opd){ return `debt:${opd}`; }
  function histKeyCredit(opd){ return `credit:${opd}`; }
  function pendingKey(opd,item,unit){ return `${opd}|${item}|${unit}`; }
  function histKeyPending(opd,item,unit){ return `pending:${pendingKey(opd,item,unit)}`; }

  function pushHist(key, tx){
    if(!state.hist.has(key)) state.hist.set(key, []);
    state.hist.get(key).unshift(tx);
  }

  function typeLabel(section, mode){
    const map = {
      debt:   { add:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏µ‡πâ', pay:'‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞', adjust:'‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î' },
      credit: { topup:'‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô/‡∏ß‡πâ‡∏≠‡∏¢‡πÄ‡∏ä‡∏≠‡∏£‡πå', spend:'‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô', adjust:'‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î' },
      pending:{ add:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå/‡πÅ‡∏û‡∏Å‡πÄ‡∏Å‡∏à', use:'‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß (‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å)', adjust:'‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î' }
    };
    return (map[section] && map[section][mode]) ? map[section][mode] : '‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
  }

  // --- Render ---
  function applySearch(){ state.q = (document.getElementById('arSearch')?.value || '').trim(); renderAll(); }
  function clearSearch(){ const el = document.getElementById('arSearch'); if(el) el.value = ''; state.q = ''; renderAll(); }

  function renderStats(){
    let debtPeople=0, debtSum=0; state.debt.forEach(v=>{ const b=Number(v.balance||0); if(b>0){ debtPeople++; debtSum+=b; } });
    document.getElementById('arStatDebt').textContent = `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏≤: ${debtPeople} ‡∏Ñ‡∏ô ‚Ä¢ ${money(debtSum)} ‡∏ö‡∏≤‡∏ó`;

    let creditPeople=0, creditSum=0; state.credit.forEach(v=>{ const b=Number(v.balance||0); if(b>0){ creditPeople++; creditSum+=b; } });
    document.getElementById('arStatCredit').textContent = `‡πÄ‡∏£‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${creditPeople} ‡∏Ñ‡∏ô ‚Ä¢ ${money(creditSum)} ‡∏ö‡∏≤‡∏ó`;

    let pendingLines=0; state.pending.forEach(v=>{ if(Number(v.qty||0)>0) pendingLines++; });
    document.getElementById('arStatPending').textContent = `‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥: ${pendingLines} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  }

  function renderAll(){
    renderStats();
    // (Render logic for Debt/Credit/Pending omitted for brevity, assuming standard render functions exist below or are handled implicitly by specific tab logic if separated. 
    // BUT since we are replacing the WHOLE block, I must include them to be safe.
    // ... Re-including render functions ...)
    renderDebt(); renderCredit(); renderPending();
  }
  
  function passesSearchCustomer(c, extraText){
    const q = norm(state.q), d = digits(state.q);
    if(!q && !d) return true;
    const extra = norm(extraText || ''), p = digits(extraText || '');
    return norm(c.opd).includes(q) || norm(c.name).includes(q) || digits(c.phone).includes(d) || (q && extra.includes(q)) || (d && p.includes(d));
  }

  function renderDebt(){
    const body=document.getElementById('arDebtBody'), empty=document.getElementById('arDebtEmpty'); if(!body)return;
    const rows=[];
    state.debt.forEach((v,opd)=>{
      const c=ensureCustomerFromOPD(opd); if(!passesSearchCustomer(c, `${v.name} ${v.phone}`)) return;
      if(Number(v.balance||0)>0) rows.push({ opd, name: c.name||v.name||'-', phone:c.phone||v.phone||'-', balance:v.balance, last_at:v.last_at });
    });
    rows.sort((a,b)=>b.balance-a.balance);
    body.innerHTML = rows.map(r=>`<tr><td style="text-align:center;">${safe(r.opd)}</td><td><strong>${safe(r.name)}</strong></td><td style="text-align:center;">${safe(r.phone)}</td><td style="text-align:right;font-weight:1000;color:#b91c1c;">${money(r.balance)}</td><td style="text-align:center;">${r.last_at?fmtDate(r.last_at):'-'}</td><td style="text-align:center;"><button class="btn btn-outline" onclick="AR.openTxModal({section:'debt',mode:'pay',opd:'${safe(r.opd)}'})">‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞</button> <button class="btn btn-outline" onclick="AR.openTxModal({section:'debt',mode:'add',opd:'${safe(r.opd)}'})">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏µ‡πâ</button> <button class="btn btn-primary" onclick="AR.openHistoryOnly({section:'debt',opd:'${safe(r.opd)}'})">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button></td></tr>`).join('');
    empty.style.display = rows.length?'none':'block';
  }

  function renderCredit(){
    const body=document.getElementById('arCreditBody'), empty=document.getElementById('arCreditEmpty'); if(!body)return;
    const rows=[];
    state.credit.forEach((v,opd)=>{
      const c=ensureCustomerFromOPD(opd); if(!passesSearchCustomer(c, `${v.name} ${v.phone}`)) return;
      if(Number(v.balance||0)>0) rows.push({ opd, name: c.name||v.name||'-', phone:c.phone||v.phone||'-', balance:v.balance, last_at:v.last_at });
    });
    rows.sort((a,b)=>b.balance-a.balance);
    body.innerHTML = rows.map(r=>`<tr><td style="text-align:center;">${safe(r.opd)}</td><td><strong>${safe(r.name)}</strong></td><td style="text-align:center;">${safe(r.phone)}</td><td style="text-align:right;font-weight:1000;color:#0b7660;">${money(r.balance)}</td><td style="text-align:center;">${r.last_at?fmtDate(r.last_at):'-'}</td><td style="text-align:center;"><button class="btn btn-outline" onclick="AR.openTxModal({section:'credit',mode:'topup',opd:'${safe(r.opd)}'})">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button> <button class="btn btn-outline" onclick="AR.openTxModal({section:'credit',mode:'spend',opd:'${safe(r.opd)}'})">‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô</button> <button class="btn btn-primary" onclick="AR.openHistoryOnly({section:'credit',opd:'${safe(r.opd)}'})">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button></td></tr>`).join('');
    empty.style.display = rows.length?'none':'block';
  }

  function renderPending(){
    const body=document.getElementById('arPendingBody'), empty=document.getElementById('arPendingEmpty'); if(!body)return;
    const rows=[];
    state.pending.forEach((v,key)=>{
      const c=ensureCustomerFromOPD(v.opd); if(!passesSearchCustomer(c, `${v.name} ${v.phone}`)) return;
      if(Number(v.qty||0)>0) rows.push({ key, opd:v.opd, name: c.name||v.name||'-', phone:c.phone||v.phone||'-', item:v.item, unit:v.unit, qty:v.qty, last_at:v.last_at });
    });
    rows.sort((a,b)=>norm(a.name).localeCompare(norm(b.name)));
    body.innerHTML = rows.map(r=>`<tr><td style="text-align:center;">${safe(r.opd)}</td><td><strong>${safe(r.name)}</strong></td><td style="text-align:center;">${safe(r.phone)}</td><td>${safe(r.item)}</td><td style="text-align:center;">${safe(r.unit)}</td><td style="text-align:center;font-weight:1000;color:#0b7660;">${Math.floor(r.qty)}</td><td style="text-align:center;">${r.last_at?fmtDate(r.last_at):'-'}</td><td style="text-align:center;"><button class="btn btn-outline" onclick="AR.openTxModal({section:'pending',mode:'use',pending_key:'${safe(r.key)}'})">‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß</button> <button class="btn btn-outline" onclick="AR.openTxModal({section:'pending',mode:'add',opd:'${safe(r.opd)}',item:'${safe(r.item)}',unit:'${safe(r.unit)}'})">‡πÄ‡∏û‡∏¥‡πà‡∏°</button> <button class="btn btn-primary" onclick="AR.openHistoryOnly({section:'pending',pending_key:'${safe(r.key)}'})">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button></td></tr>`).join('');
    empty.style.display = rows.length?'none':'block';
  }

  async function refreshFromServer(){
    const [arSum, vcSum, workSum] = await Promise.all([
      apiGet('/api/ar_summary'), apiGet('/api/voucher_summary'), apiGet('/api/work_summary')
    ]);
    state.debt.clear(); (arSum||[]).forEach(r=>{ if(r.opd) state.debt.set(r.opd, { balance:Number(r.balance||0), last_at:r.last_tx_date||'', name:r.name, phone:r.phone }); });
    state.credit.clear(); (vcSum||[]).forEach(r=>{ if(r.opd) state.credit.set(r.opd, { balance:Number(r.balance||0), last_at:r.last_tx_date||'', name:r.name, phone:r.phone }); });
    state.pending.clear(); (workSum||[]).forEach(row=>{ 
      if(!row.opd) return; 
      (row.items||[]).forEach(it=>{ if(it.item) state.pending.set(pendingKey(row.opd,it.item,'‡∏Ñ‡∏£‡∏±‡πâ‡∏á'), { opd:row.opd, name:row.name, phone:row.phone, item:it.item, unit:'‡∏Ñ‡∏£‡∏±‡πâ‡∏á', qty:Number(it.qty_pending||0), last_at:row.last_tx_date }); });
    });
    renderAll();
  }

  // --- MODAL ---
  function openTxModal(ctx){
    state.modal = { section: ctx.section, mode: ctx.mode, target: null };
    const dateEl=document.getElementById('arTxDate'); if(dateEl) dateEl.value = todayISO();
    ['arTxFind','arTxAmount','arTxNote','arTxQty'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value = (id==='arTxQty'?'1':''); });

    // Reset Dropdowns
    const catSel = document.getElementById('arTxCategory');
    const prodSel = document.getElementById('arTxProduct');
    if(catSel) catSel.value = "";
    if(prodSel) prodSel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>';

    const isPending = ctx.section === 'pending';
    document.getElementById('arTxAmountRow').style.display = isPending ? 'none' : '';
    document.getElementById('arTxPayRow').style.display = (ctx.section==='debt' && ctx.mode==='pay') ? '' : (ctx.section==='credit'?'':'none');
    
    // ‚úÖ ‡∏™‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ Dropdown
    const disp = isPending ? 'grid' : 'none'; 
    if(document.getElementById('arTxCatRow')) document.getElementById('arTxCatRow').style.display = disp;
    if(document.getElementById('arTxProductRow')) document.getElementById('arTxProductRow').style.display = disp;
    if(isPending) populateTxCats(); // Load waiting

    if(document.getElementById('arTxItemRow')) document.getElementById('arTxItemRow').style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤
    document.getElementById('arTxUnitRow').style.display = isPending ? '' : 'none';
    document.getElementById('arTxQtyRow').style.display  = isPending ? '' : 'none';

    document.getElementById('arTxTitle').textContent = typeLabel(ctx.section, ctx.mode);
    document.getElementById('arTxSub').textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥';

    if(ctx.pending_key){
      const v = state.pending.get(ctx.pending_key);
      if(v){
        const c = ensureCustomerFromOPD(v.opd);
        state.modal.target = { type:'pending', key:ctx.pending_key, opd:v.opd, item:v.item, unit:v.unit, customer:c };
        setModalCustomer(c);
        // Pre-fill dropdown is hard because async loading, skipping specific pre-select for now or simplify
      }
    } else if(ctx.opd){
      const c = ensureCustomerFromOPD(ctx.opd);
      state.modal.target = { type:'customer', opd:ctx.opd, customer:c };
      setModalCustomer(c);
    } else {
      setModalCustomer(null);
    }
    renderModalHistory();
    document.getElementById('arTxOverlay').style.display = 'flex';
  }

  function closeTxModal(){ document.getElementById('arTxOverlay').style.display = 'none'; state.modal={section:null,mode:null,target:null}; }

  function setModalCustomer(c){
    const nEl=document.getElementById('arTxName'), oEl=document.getElementById('arTxOPD'), pEl=document.getElementById('arTxPhone');
    if(!c){ nEl.textContent='-'; oEl.textContent='-'; pEl.textContent='-'; document.getElementById('arTxBalance').textContent='0'; return; }
    const d=state.debt.get(c.opd)||{}, cr=state.credit.get(c.opd)||{};
    nEl.textContent = c.name||d.name||cr.name||'-'; oEl.textContent=c.opd||'-'; pEl.textContent=c.phone||d.phone||cr.phone||'-';
    
    const sec=state.modal.section;
    if(sec==='debt') { document.getElementById('arTxBalance').textContent = `${money(d.balance||0)} ‡∏ö‡∏≤‡∏ó`; document.getElementById('arTxBalanceHint').textContent='‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà'; }
    else if(sec==='credit') { document.getElementById('arTxBalance').textContent = `${money(cr.balance||0)} ‡∏ö‡∏≤‡∏ó`; document.getElementById('arTxBalanceHint').textContent='‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô'; }
    else { document.getElementById('arTxBalance').textContent = '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á'; document.getElementById('arTxBalanceHint').textContent='‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥'; }
  }

  function openHistoryOnly(ctx){
    if(ctx.section==='pending') openTxModal({section:'pending', mode:'use', pending_key:ctx.pending_key});
    else openTxModal({section:ctx.section, mode:(ctx.section==='debt'?'pay':'spend'), opd:ctx.opd});
    setTimeout(()=>{ const h=document.getElementById('arTxHistTable'); if(h) h.scrollIntoView({behavior:'smooth'}); },60);
  }

  function pickFirstMatch(){
    const q=(document.getElementById('arTxFind')?.value||'').trim();
    const m=findMatches(q)[0]; if(!m) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
    state.modal.target={type:'customer', opd:m.opd, customer:m};
    setModalCustomer(m); renderModalHistory();
  }

  function renderModalHistory(){
    const body=document.getElementById('arTxHistBody'), table=document.getElementById('arTxHistTable'), empty=document.getElementById('arTxHistEmpty');
    let key=null;
    if(state.modal.section==='pending'){
      if(state.modal.target?.type==='pending') { 
        const pk = state.modal.target.key; if(pk) { const ps=pk.split('|'); key=histKeyPending(ps[0],ps[1],ps[2]); }
      }
    } else if(state.modal.section==='debt'){ const opd=state.modal.target?.opd||state.modal.target?.customer?.opd; if(opd) key=histKeyDebt(opd); }
    else if(state.modal.section==='credit'){ const opd=state.modal.target?.opd||state.modal.target?.customer?.opd; if(opd) key=histKeyCredit(opd); }

    const list = key ? (state.hist.get(key)||[]) : [];
    if(list.length===0){ empty.style.display='block'; table.style.display='none'; return; }
    empty.style.display='none'; table.style.display='table';
    body.innerHTML = list.slice(0,30).map(x=>`<tr><td style="text-align:center;">${safe(fmtDate(x.date))}</td><td style="text-align:center;">${safe(x.type)}</td><td>${safe(x.detail)}</td><td style="text-align:right;">${safe(x.display_amount)}</td></tr>`).join('');
  }

  // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Submit ‡∏û‡∏£‡πâ‡∏≠‡∏° Logic ‡∏≠‡πà‡∏≤‡∏ô Dropdown ‡πÉ‡∏´‡∏°‡πà
  async function submitTx(){
    const sec=state.modal.section, mode=state.modal.mode;
    if(!state.modal.target?.customer) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
    const c=state.modal.target.customer, opd=c.opd, date=(document.getElementById('arTxDate')?.value||'').slice(0,10);
    if(!date) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
    const note=(document.getElementById('arTxNote')?.value||'').trim(), payM=(document.getElementById('arTxPayMethod')?.value||'‡πÇ‡∏≠‡∏ô').trim();
    const txBase={ date, type:typeLabel(sec,mode), detail:'', display_amount:'' };

    try{
      if(sec==='debt'){
        const amt=Math.floor(Number(document.getElementById('arTxAmount')?.value||0)); if(amt<=0) return alert('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á > 0');
        if(mode==='add'){ await apiPost('/api/ar_tx', { opd, tx_date:date, tx_type:'add', amount:amt, note }); txBase.display_amount=`+${money(amt)}`; pushHist(histKeyDebt(opd), txBase); }
        if(mode==='pay'){ await apiPost('/api/ar_tx', { opd, tx_date:date, tx_type:'pay', amount:amt, note:`‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞ ${payM} ${note}` }); txBase.display_amount=`-${money(amt)}`; pushHist(histKeyDebt(opd), txBase); }
      }
      if(sec==='credit'){
        const amt=Math.floor(Number(document.getElementById('arTxAmount')?.value||0)); if(amt<=0) return alert('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á > 0');
        if(mode==='topup'){ await apiPost('/api/voucher_tx', { opd, tx_date:date, tx_type:'topup', amount:amt, note:`‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô ${payM} ${note}` }); txBase.display_amount=`+${money(amt)}`; pushHist(histKeyCredit(opd), txBase); }
        if(mode==='spend'){ await apiPost('/api/voucher_tx', { opd, tx_date:date, tx_type:'use', amount:amt, note }); txBase.display_amount=`-${money(amt)}`; pushHist(histKeyCredit(opd), txBase); }
      }
      if(sec==='pending'){
        // --- Logic ‡πÉ‡∏´‡∏°‡πà: ‡∏≠‡πà‡∏≤‡∏ô Dropdown ---
        let item = (document.getElementById('arTxProduct')?.value || '').trim();
        if(!item) item = (document.getElementById('arTxCategory')?.value || '').trim();
        if(!item) item = (document.getElementById('arTxItem')?.value || '').trim(); // fallback

        const unit=(document.getElementById('arTxUnit')?.value||'‡∏Ñ‡∏£‡∏±‡πâ‡∏á').trim(), qty=Math.max(1, Math.floor(Number(document.getElementById('arTxQty')?.value||1)));
        if(!item) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');

        if(mode==='add'){ await apiPost('/api/work_tx', { opd, tx_date:date, tx_type:'add', item, qty, note }); txBase.display_amount=`+${qty} ${unit}`; pushHist(histKeyPending(opd,item,unit), txBase); }
        if(mode==='use'){ await apiPost('/api/work_tx', { opd, tx_date:date, tx_type:'done', item, qty, note }); txBase.display_amount=`-${qty} ${unit}`; pushHist(histKeyPending(opd,item,unit), txBase); }
      }
      await refreshFromServer();
      setModalCustomer(c); renderModalHistory();
      document.getElementById('arTxAmount').value=''; document.getElementById('arTxNote').value='';
      // Clear Dropdowns
      if(sec==='pending'){ 
         const p=document.getElementById('arTxProduct'); if(p) p.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>';
         const cat=document.getElementById('arTxCategory'); if(cat) cat.value='';
      }
      alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }catch(e){ console.error(e); alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message); }
  }

  function bind(){
    const s=document.getElementById('arSearch'); if(s) s.addEventListener('keydown', e=>{ if(e.key==='Enter'){e.preventDefault();applySearch();}});
    const f=document.getElementById('arTxFind'); if(f) f.addEventListener('keydown', e=>{ if(e.key==='Enter'){e.preventDefault();pickFirstMatch();}});
  }

  async function init(){ bind(); try{ await refreshFromServer(); }catch(e){console.error(e); renderAll();} }

  document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ const ov=document.getElementById('arTxOverlay'); if(ov&&ov.style.display==='flex') closeTxModal(); } });

  return { init, applySearch, clearSearch, openTxModal, closeTxModal, submitTx, pickFirstMatch, openHistoryOnly, refreshFromServer, getCustomerFallback, onCatChange };
})();

document.addEventListener('DOMContentLoaded', () => {
  try{ AR.init(); }catch(e){ console.error(e); }
});

// ‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏™‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (flatten) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö datalist ‡πÉ‡∏ô modal
function flattenCatalogNames(){
  const out = [];
  const seen = new Set();

  Object.entries(subOptionsMap || {}).forEach(([cat, arr])=>{
    (arr || []).forEach(o=>{
      const name = String((typeof o === 'string') ? o : (o?.name || '')).trim();
      if(!name) return;

      // ‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏°‡∏ß‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ (‡∏™‡∏ß‡∏¢‡πÄ‡∏ß‡∏•‡∏≤ search)
      const label = `${name} (${cat})`;

      if(seen.has(label)) return;
      seen.add(label);
      out.push({ label, name, cat, raw:o });
    });
  });

  return out;
}

function fillArTxItemDatalist(){
  const dl = document.getElementById('arTxItemList');
  if(!dl) return;

  const items = flattenCatalogNames();
  dl.innerHTML = items.map(x => `<option value="${safe(x.name)}"></option>`).join('');
}
document.addEventListener('DOMContentLoaded', async () => {
  try{
    await loadCatalog();        // ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å /api/products_map
    fillArTxItemDatalist();     // ‡πÄ‡∏ï‡∏¥‡∏° datalist ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á ‚Äú‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‚Äù ‡πÉ‡∏ô modal
  }catch(e){
    console.error(e);
  }
});


  </script>


</body>
</html>
