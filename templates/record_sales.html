<!DOCTYPE html>
<html lang="th">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta charset="UTF-8" />
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f7f7f7; padding: 10px 10px 140px; }
    h2 { text-align: center; color: teal; font-size: 20px; margin-top: 0; }
    .container { max-width: 700px; margin: 30px auto; background: #fff; border-radius: 12px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    label { font-weight: bold; display: block; margin-top: 20px; }
    input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
    .flex-row { display: flex; gap: 10px; }
    .flex-row > * { flex: 1; }
    .item-row { display: flex; gap: 10px; margin-top: 10px; }
    .item-row select, .item-row input { flex: 1; }
    .add-button { margin-top: 10px; padding: 10px; background-color: #0288d1; color: white; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; }
    button[type="button"], .save-all-btn { margin-top: 20px; padding: 12px; width: 100%; background-color: #43a047; color: white; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }

    /* floating dock (‡πÄ‡∏î‡∏¥‡∏°) */
    .floating-toggle{position:fixed;bottom:env(safe-area-inset-bottom,18px);left:50%;transform:translateX(-50%);background:rgba(0,128,128,0);width:58px;height:58px;border-radius:50%;box-shadow:0 4px 16px rgba(251,251,251,0);display:flex;justify-content:center;align-items:center;z-index:1000;cursor:pointer}
    .floating-menu{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:#fff;border-radius:16px;padding:10px;display:none;flex-direction:column;align-items:center;gap:10px;box-shadow:0 6px 20px rgba(0,0,0,.2);z-index:999;max-height:60vh;overflow-y:auto}
    .floating-menu a img{width:52px;height:52px}
  </style>
</head>
<body>
  <div class="container">
    <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>

    <!-- üîé ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (IDs ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥) -->
    <button class="add-button" onclick="startEditExisting()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏î‡∏¥‡∏°</button>
    <div id="editSection" style="display:none; margin-top:20px;">
      <label>‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç OPD ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</label>
      <div class="flex-row">
        <input type="text" id="editOPD" placeholder="‡∏Å‡∏£‡∏≠‡∏Å OPD (4 ‡∏´‡∏•‡∏±‡∏Å)">
        <button type="button" class="save-all-btn" style="background-color: teal;" onclick="loadDatesByOPD()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div id="editDateButtons" style="margin-top: 12px;"></div>
      <div id="editRecordList" style="margin-top: 12px;"></div>
    </div>

    <form id="saleForm" onsubmit="return false;">
      <!-- ‡πÄ‡∏Å‡πá‡∏ö id ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
      <input type="hidden" id="currentId" value="">

      <label for="date">1. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" id="date" name="date">

      <label for="opd">2. ‡πÄ‡∏•‡∏Ç OPD</label>
      <input type="text" id="opd" name="opd" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç OPD" oninput="autoFillByOPD()">

      <label for="name">3. ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</label>
      <input type="text" id="name" name="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ö‡∏ß‡πå - ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏à ‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì">

      <label for="phone">4. ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
      <input type="tel" id="phone" name="phone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0912345678">

      <label>5. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
      <div class="item-list" id="itemList">
        <div class="item-row">
          <select name="item[]" onchange="updateSubOptions(this, this.nextElementSibling)">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å --</option>
          </select>
          <select name="subitem[]">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>
          </select>
          <input type="number" name="price[]" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" step="0.01">
          <input type="number" name="qty[]" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" step="1">
        </div>
      </div>
      <button type="button" class="add-button" onclick="addItemRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>

      <label for="amount">6. ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</label>
      <div class="flex-row">
        <input type="number" id="amount" name="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)" step="0.01">
        <select id="paymentType" name="paymentType">
          <option value="‡πÇ‡∏≠‡∏ô">‡πÇ‡∏≠‡∏ô</option>
          <option value="‡∏™‡∏î">‡∏™‡∏î</option>
        </select>
      </div>

      <label for="note">7. ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
      <textarea id="note" name="note" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡πÅ‡∏ñ‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡∏à‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ / ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥ / ‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ"></textarea>

      <button type="button" class="save-all-btn" onclick="reviewForm()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ)</button>
    </form>

    <div id="reviewSection" style="margin-top:16px;">
      <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
    </div>
    <button class="save-all-btn" onclick="saveAllRecords()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // ---------- Static data ----------
    const subOptionsMap = {
      "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": ["Aestox 50 u", "Aestox 100 u", "Allergan 50 u", "Allergan 100 u", "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î", "‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß", "Nabota"],
      "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥", "Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á", "E.P.T.Q ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢", "Restylane ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢"],
      "Fat/Hifu": ["Bromi", "Sisi", "HIFU", "HIFU ‡πÅ‡∏ñ‡∏°"],
      "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": [
        "Meso Chanel", "P - Cell", "Aquatic", "Hestina", "Exosome", "Rejuran",
        "Belotero Revive", "Sculptra", "Juvelook", "Aesthefill",
        "PRP", "Mesowink", "‡∏™‡∏∞‡∏Å‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "Alphaarbutin", "Transamine", "Biocollagen"
      ],
      "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster"],
      "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": ["‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤", "‡∏ú‡∏•‡∏±‡∏Å‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô", "‡∏õ‡∏±‡πà‡∏ô RF", "‡∏Å‡∏î‡∏™‡∏¥‡∏ß", "subcision‡∏™‡∏¥‡∏ß"],
      "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": [
        "‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤", "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤",
        "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÑ‡∏´‡∏° PDO", "‡πÑ‡∏´‡∏° Collagen",
        "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô/‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏™‡∏•‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå", "PRP‡∏ú‡∏°", "‡∏à‡∏µ‡πâ‡πÑ‡∏ù"
      ],
      "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©": []
    };

    // fill options for the first row
    (function initFirstRow(){
      const sel = document.querySelector('select[name="item[]"]');
      sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å --</option>' +
        Object.keys(subOptionsMap).map(k=>`<option value="${k}">${k}</option>`).join('');
      // default date today
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      document.getElementById('date').value = `${d.getFullYear()}-${mm}-${dd}`;
    })();

    // ---------- State ----------
    let records = [];                 // pending to save
    let customerMap = {};             // opd -> {name, phone}
    let currentEditId = null;         // id of record being edited (if any)
    let editDataByOPD = [];           // cache for edit list

    // ---------- Prefill customers ----------
    fetch('/api/customers').then(r=>r.json()).then(data=>{
      (data||[]).forEach(c=>{ if(c.opd){ customerMap[c.opd] = {name:c.name||'', phone:c.phone||''}; } });
    }).catch(()=>{});

    // ---------- UI helpers ----------
    function startEditExisting(){ document.getElementById('editSection').style.display='block'; }

    function updateSubOptions(itemSelect, subSelect){
      const selected = itemSelect.value;
      if(selected === '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©'){
        const allOptions = Object.entries(subOptionsMap)
          .filter(([k])=>k!== '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©')
          .flatMap(([_,v])=>v);
        subSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>' +
          [...new Set(allOptions)].map(opt=>`<option value="${opt}">${opt}</option>`).join('');
        return;
      }
      const options = subOptionsMap[selected] || [];
      subSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>' +
        options.map(opt=>`<option value="${opt}">${opt}</option>`).join('');
    }

    function addItemRow(){
      const row = document.createElement('div');
      row.className = 'item-row';
      row.innerHTML = `
        <select name="item[]" onchange="updateSubOptions(this, this.nextElementSibling)">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å --</option>
          ${Object.keys(subOptionsMap).map(k=>`<option value="${k}">${k}</option>`).join('')}
        </select>
        <select name="subitem[]"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option></select>
        <input type="number" name="price[]" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" step="0.01">
        <input type="number" name="qty[]" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" step="1">
      `;
      document.getElementById('itemList').appendChild(row);
    }

    function formatDate(dateStr){ if(!dateStr) return ''; const [y,m,d] = dateStr.split('-'); return `${d}/${m}/${y.slice(-2)}`; }

    function autoFillByOPD(){
      const opd = document.getElementById('opd').value.trim().padStart(4,'0');
      if(!opd) return;
      const c = customerMap[opd];
      if(c){ document.getElementById('name').value = c.name; document.getElementById('phone').value = c.phone; }
    }

    function loadDatesByOPD(){
      const opdRaw = document.getElementById('editOPD').value.trim();
      if(!opdRaw) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD');
      const opd = opdRaw.padStart(4,'0');
      fetch(`/api/sales?opd=${encodeURIComponent(opd)}`)
        .then(r=>r.json())
        .then(data=>{
          editDataByOPD = data || [];
          if(editDataByOPD.length===0) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OPD ‡∏ô‡∏µ‡πâ');
          const dates = [...new Set(editDataByOPD.map(r=> (r.date||'').slice(0,10)))];
          const buttons = dates.map(d=>`<button type="button" onclick="showEditList('${d}')" style="margin:5px">${formatDate(d)}</button>`).join('');
          document.getElementById('editDateButtons').innerHTML = `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:<br>${buttons}`;
          document.getElementById('editRecordList').innerHTML = '';
        })
        .catch(()=>alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
    }

    function showEditList(date){
      const rows = editDataByOPD.filter(r => (r.date||'').slice(0,10) === date);
      const html = rows.map((r,i)=>`
        <div style="border:1px solid #ccc;padding:10px;margin-bottom:8px;border-radius:8px;">
          <div><strong>${safe(r.name)}</strong> (${safe(r.phone)})</div>
          <div>‡∏¢‡∏≠‡∏î: ${safe(r.amount)} ‡∏ö‡∏≤‡∏ó / ${safe(r.payment)}</div>
          <div style="margin-top:6px;display:flex;gap:6px;">
            <button type="button" onclick="editSelectedRecord(${i})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ</button>
            <button type="button" style="background:#c62828" onclick="deleteRecordFromSupabase('${r.id}')">üóëÔ∏è ‡∏•‡∏ö</button>
          </div>
        </div>`).join('');
      document.getElementById('editRecordList').innerHTML = `<h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDate(date)}:</h4>` + html;
    }

    function editSelectedRecord(index){
      const rec = editDataByOPD[index];
      if(!rec) return;
      // set current edit id
      currentEditId = rec.id || null;
      document.getElementById('currentId').value = currentEditId || '';
      // fill form
      editRecordFromObject(rec);
      // clear preview queue so user confirms fresh
      records = [];
      renderReviewSection();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function editRecordFromObject(rec){
      document.getElementById('date').value = (rec.date||'').slice(0,10);
      document.getElementById('opd').value = rec.opd || '';
      document.getElementById('name').value = rec.name || '';
      document.getElementById('phone').value = rec.phone || '';
      document.getElementById('amount').value = rec.amount || '';
      document.getElementById('paymentType').value = rec.payment || '‡πÇ‡∏≠‡∏ô';
      document.getElementById('note').value = rec.note || '';

      // items
      const itemList = document.getElementById('itemList');
      itemList.innerHTML = '';
      (rec.items||[]).forEach(line => {
        const row = document.createElement('div');
        row.className = 'item-row';
        row.innerHTML = `
          <select name="item[]" onchange="updateSubOptions(this, this.nextElementSibling)">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å --</option>
            ${Object.keys(subOptionsMap).map(k=>`<option value="${k}">${k}</option>`).join('')}
          </select>
          <select name="subitem[]"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option></select>
          <input type="number" name="price[]" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" step="0.01">
          <input type="number" name="qty[]" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" step="1">
        `;
        const m = String(line).match(/^(.*?) ?(?:\((.*?)\))? - (\d+(?:\.\d+)?) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+(?:\.\d+)?) ‡∏ö‡∏≤‡∏ó/);
        const itemSel = row.querySelector('select[name="item[]"]');
        const subSel  = row.querySelector('select[name="subitem[]"]');
        if(m){
          const main = (m[1]||'').trim();
          const sub = m[2]||''; const qty = m[3]||''; const price = m[4]||'';
          itemSel.value = main; updateSubOptions(itemSel, subSel); subSel.value = sub;
          row.querySelector('input[name="qty[]"]').value = qty;
          row.querySelector('input[name="price[]"]').value = price;
        }
        itemList.appendChild(row);
      });
      if((rec.items||[]).length===0){
        // keep one empty row
        addItemRow();
      }
    }

    function reviewForm(){
      const date = (document.getElementById('date').value||'').slice(0,10);
      const opd  = (document.getElementById('opd').value||'').trim().padStart(4,'0');
      const name = document.getElementById('name').value||'';
      const phone = document.getElementById('phone').value||'';
      const amount = document.getElementById('amount').value||'';
      const payment = document.getElementById('paymentType').value||'‡πÇ‡∏≠‡∏ô';
      const note = document.getElementById('note').value||'';

      const itemNames = document.querySelectorAll('select[name="item[]"]');
      const itemSubs  = document.querySelectorAll('select[name="subitem[]"]');
      const itemPrices= document.querySelectorAll('input[name="price[]"]');
      const itemQtys  = document.querySelectorAll('input[name="qty[]"]');

      const items = [];
      for(let i=0;i<itemNames.length;i++){
        const main = itemNames[i].value; const sub = itemSubs[i].value;
        const price = itemPrices[i].value; const qty = itemQtys[i].value;
        if(main && price && qty){
          const label = sub ? `${main} (${sub})` : main;
          items.push(`${label} - ${qty} ‡∏ä‡∏¥‡πâ‡∏ô x ${price} ‡∏ö‡∏≤‡∏ó`);
        }
      }

      const rec = { date, opd, name, phone, amount, payment, note, items };
      if(currentEditId){ rec.id = currentEditId; }

      // queue & preview
      records.push(rec);
      renderReviewSection();

      // reset form but keep date & opd for speed
      const keepDate = date; const keepOPD = opd;
      document.getElementById('saleForm').reset();
      document.getElementById('date').value = keepDate; document.getElementById('opd').value = keepOPD;
      document.getElementById('itemList').innerHTML = document.querySelector('.item-row').outerHTML;
      // clear edit-id after staged to queue (so you can queue multiple updates)
      currentEditId = null; document.getElementById('currentId').value = '';
    }

    function renderReviewSection(){
      const section = document.getElementById('reviewSection');
      section.innerHTML = '<h3>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô</h3>';

      const grouped = {};
      records.forEach((r,idx)=>{ const d=r.date||''; (grouped[d]||(grouped[d]=[])).push({...r, _idx: idx}); });

      Object.entries(grouped).sort(([a],[b])=> new Date(b)-new Date(a)).forEach(([date, list])=>{
        const dayTotal = list.reduce((s,r)=> s + (parseFloat(r.amount)||0), 0);
        const container = document.createElement('div'); container.style.marginBottom='24px';
        const header = document.createElement('h4'); header.textContent = `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDate(date)} ‚Äî ‡∏£‡∏ß‡∏° ${dayTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`; container.appendChild(header);

        const rowsHtml = list.map((r,i)=>{
          const itemsHtml = (r.items||[]).map(x=>`<li>${safe(x)}</li>`).join('');
          return `<tr>
            <td style="border:1px solid #ccc;padding:6px;font-size:13px;">${i+1}</td>
            <td style="border:1px solid #ccc;padding:6px;font-size:13px;"><div><strong>${safe(r.name)}</strong></div><div style="font-size:12px;color:#777;">OPD: ${safe(r.opd)}</div></td>
            <td style="border:1px solid #ccc;padding:6px;font-size:13px;">${safe(r.phone)}</td>
            <td style="border:1px solid #ccc;padding:6px;font-size:13px;"><ul style='margin:0;padding-left:16px;'>${itemsHtml}</ul></td>
            <td style="border:1px solid #ccc;padding:6px;font-size:13px;">${safe(r.amount)} ‡∏ö‡∏≤‡∏ó (${safe(r.payment)})${r.note?`<div style='font-size:12px;color:#555;'>üìù ${safe(r.note)}</div>`:''}</td>
            <td style="border:1px solid #ccc;padding:6px;text-align:center;font-size:13px;">
              <button type="button" onclick="editRecordFromObject(records[${r._idx}]); currentEditId = records[${r._idx}].id || null; document.getElementById('currentId').value=currentEditId||'';">‚úèÔ∏è</button>
              <button type="button" onclick="deleteRecord(${r._idx})">üóëÔ∏è</button>
            </td>
          </tr>`;
        }).join('');

        const table = document.createElement('table');
        table.style.width='100%'; table.style.borderCollapse='collapse'; table.innerHTML = `
          <thead>
            <tr style="background:#f0f0f0;">
              <th style="border:1px solid #ccc;padding:6px;font-size:13px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
              <th style="border:1px solid #ccc;padding:6px;font-size:13px;">‡∏ä‡∏∑‡πà‡∏≠</th>
              <th style="border:1px solid #ccc;padding:6px;font-size:13px;">‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
              <th style="border:1px solid #ccc;padding:6px;font-size:13px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th style="border:1px solid #ccc;padding:6px;font-size:13px;">‡∏¢‡∏≠‡∏î</th>
              <th style="border:1px solid #ccc;padding:6px;font-size:13px;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>`;
        container.appendChild(table);
        section.appendChild(container);
      });
    }

    function deleteRecord(idx){ if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?')) return; records.splice(idx,1); renderReviewSection(); }

    function saveAllRecords(){
      if(records.length===0) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß');
      if(!confirm('‚ú® ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')) return;
      fetch('/api/save_sales', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(records) })
        .then(r=>r.json())
        .then(data=>{
          if(data && (data.message||'').includes('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')){
            alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ${data.updated||0} / ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ${data.inserted||0}`);
            records = []; renderReviewSection();
            document.getElementById('saleForm').reset();
            document.getElementById('itemList').innerHTML = document.querySelector('.item-row').outerHTML;
          }else{
            alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          }
        })
        .catch(err=>{ console.error(err); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'); });
    }

    function deleteRecordFromSupabase(id){
      if(!id) return; if(!confirm('‚ùå ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      fetch('/api/delete_sales_record', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id}) })
        .then(r=>r.json()).then(data=>{ alert('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); loadDatesByOPD(); })
        .catch(()=> alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
    }

    // tiny helpers
    function safe(v){ return (v==null?'':String(v)).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",
      ">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }

    // floating menu (unchanged)
    function toggleFloatingMenu(){ const menu = document.getElementById('floatingMenu'); menu.style.display = (menu.style.display==='flex')?'none':'flex'; }
    document.addEventListener('click', function(e){ const t=document.getElementById('floatingToggle'); const m=document.getElementById('floatingMenu'); if(!t.contains(e.target)&&!m.contains(e.target)){ m.style.display='none'; }});
  </script>

  <!-- floating menu (unchanged) -->
  <div id="floatingToggle" class="floating-toggle" onclick="toggleFloatingMenu()">
    <img src="{{ url_for('static', filename='icon/icon_menu_toggle.png') }}" alt="menu" style="width:60px;height:60px;">
  </div>
  <div id="floatingMenu" class="floating-menu">
    <a href="{{ url_for('dashboard') }}"><img src="{{ url_for('static', filename='icon/icon_dashboard.png') }}"></a>
    <a href="{{ url_for('sale_summary') }}"><img src="{{ url_for('static', filename='icon/icon_sale_summary.png') }}"></a>
    <a href="{{ url_for('record_sales') }}"><img src="{{ url_for('static', filename='icon/icon_record_sales.png') }}"></a>
    <a href="{{ url_for('customer_list') }}"><img src="{{ url_for('static', filename='icon/icon_customer_list.png') }}"></a>
    <a href="{{ url_for('record_customer') }}"><img src="{{ url_for('static', filename='icon/icon_customer_history.png') }}"></a>
    <a href="{{ url_for('oldsaledata') }}"><img src="{{ url_for('static', filename='icon/icon_old_customers.png') }}"></a>
    <a href="{{ url_for('inventory') }}"><img src="{{ url_for('static', filename='icon/icon_inventory.png') }}"></a>
    <a href="#"><img src="{{ url_for('static', filename='icon/icon_staff.png') }}"></a>
    <a href="#"><img src="{{ url_for('static', filename='icon/icon_appointments.png') }}"></a>
  </div>
</body>
</html>