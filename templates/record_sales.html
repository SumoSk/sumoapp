<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background-color: #f7f7f7;
      padding: 10px;
    }
    .menu-bar {
      display: flex;
      justify-content: space-around;
      background-color: white;
      padding: 10px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .menu-bar a {
      text-decoration: none;
      font-weight: bold;
      color: teal;
    }
    h2 {
      text-align: center;
      color: teal;
      font-size: 20px;
      margin-top: 0;
    }
    .search-bar {
      max-width: 90%;
      margin: auto;
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .search-bar input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .container {
      max-width: 700px;
      margin: 30px auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    h2 {
      text-align: center;
      color: #004d40;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 20px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
    }
    .flex-row {
      display: flex;
      gap: 10px;
    }
    .flex-row > * {
      flex: 1;
    }
    .item-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .item-row select {
      margin-bottom: 5px;
    }

    .item-row select, .item-row input {
      flex: 1;
    }
    .add-button {
      margin-top: 10px;
      padding: 10px;
      background-color: #0288d1;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button[type="submit"], .save-all-btn {
      margin-top: 30px;
      padding: 12px;
      width: 100%;
      background-color: #43a047;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="menu-bar">
        <a href="{{ url_for('dashboard') }}">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
      <a href="{{ url_for('sale_summary') }}">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</a>
      <a href="{{ url_for('record_sales') }}">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</a>
      <a href="{{ url_for('record_customer') }}">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</a>
      <a href="{{ url_for('customer_list') }}">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</a>
      <a href="{{ url_for('oldsaledata') }}">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤</a>
    </div>
  <div class="container">
    <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>
    <button class="add-button" onclick="startEditExisting()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏î‡∏¥‡∏°</button>
    <div id="editSection" style="display:none; margin-top:20px;">
      <label>‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç OPD ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</label>
      <input type="text" id="editOPD" placeholder="‡∏Å‡∏£‡∏≠‡∏Å OPD">
      <button type="button" class="save-all-btn" style="background-color: teal;" onclick="loadDatesByOPD()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <div id="editDateButtons" style="margin-top: 20px;"></div>
      <div id="editRecordList" style="margin-top: 20px;"></div>
    </div>


    <form id="saleForm">
      <div id="editSection" style="display:none; margin-top:20px;">
        <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</label>
        <div class="flex-row">
          <input type="text" id="editOPD" placeholder="‡∏Å‡∏£‡∏≠‡∏Å OPD">
          
        </div>
       
      </div>
      
      <label for="date">1. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" id="date" name="date">

      <label for="opd">2. ‡πÄ‡∏•‡∏Ç OPD</label>
      <input type="text" id="opd" name="opd" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç OPD" oninput="autoFillByOPD()">

      <label for="name">3. ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</label>
      <input type="text" id="name" name="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ö‡∏ß‡πå - ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏à ‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì">

      <label for="phone">4. ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
      <input type="tel" id="phone" name="phone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0912345678">

      <label>5. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
      <div class="item-list" id="itemList">
        <div class="item-row">
          <select name="item[]" onchange="updateSubOptions(this, this.nextElementSibling)">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å --</option>
            <option value="‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ">‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ</option>
            <option value="‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå">‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå</option>
            <option value="‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß">‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß</option>
            <option value="‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß">‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß</option>
            <option value="‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå">‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå</option>
            <option value="Fat/Hifu">Fat/Hifu</option>
            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
            <option value="‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
          </select>
          <select name="subitem[]">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>
          </select>
          <input type="number" name="price[]" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤">
          <input type="number" name="qty[]" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">
        </div>
       
      </div>
      <button type="button" class="add-button" onclick="addItemRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>

      <label for="amount">6. ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</label>
      <div class="flex-row">
        <input type="number" id="amount" name="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)">
        <select id="paymentType" name="paymentType">
          <option value="‡πÇ‡∏≠‡∏ô">‡πÇ‡∏≠‡∏ô</option>
          <option value="‡∏™‡∏î">‡∏™‡∏î</option>
        </select>
      </div>

      <label for="note">7. ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
      <textarea id="note" name="note" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡πÅ‡∏ñ‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡∏à‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ / ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏≥ / ‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ"></textarea>

      <button type="button" class="save-all-btn" onclick="reviewForm()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ)</button>
    </form>

    <div id="reviewSection">
      <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
    </div>
    <button class="save-all-btn" onclick="saveAllRecords()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
let customerMap = {};

fetch("/api/customers")
  .then(res => res.json())
  .then(data => {
    data.forEach(c => {
      if (c.opd) {
        customerMap[c.opd] = {
          name: c.name || "",
          phone: c.phone || ""
        };
      }
    });
  });





    let records = [];
    function startEditExisting() {
  document.getElementById('editSection').style.display = 'block';
}

function loadDatesByOPD() {
  const opd = document.getElementById('editOPD').value.trim();
  if (!opd) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD");

  fetch("/api/sales")
    .then(res => res.json())
    .then(data => {
      const filtered = data.filter(r => r.opd === opd);
      if (filtered.length === 0) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OPD ‡∏ô‡∏µ‡πâ");

      const dates = [...new Set(filtered.map(r => r.date.slice(0, 10)))];
      const buttons = dates.map(d => `<button onclick="showEditList('${d}')" style="margin:5px">${formatDate(d)}</button>`).join('');
      document.getElementById('editDateButtons').innerHTML = `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:<br>${buttons}`;
      window.editDataByOPD = filtered;
    });
}

function showEditList(date) {
  const records = window.editDataByOPD.filter(r => r.date.slice(0, 10) === date);
  const html = records.map((r, i) => `
    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 8px; border-radius: 8px;">
      <strong>${r.name}</strong> (${r.phone})<br>
      ‡∏¢‡∏≠‡∏î: ${r.amount} ‡∏ö‡∏≤‡∏ó / ${r.payment}
      <button onclick="editSelectedRecord(${i})">‚úèÔ∏è</button>
    </div>
  `).join('');
  document.getElementById('editRecordList').innerHTML = `<h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDate(date)}:</h4>` + html;
}

function editSelectedRecord(index) {
  const rec = window.editDataByOPD[index];
  if (!rec) return;
  records = [rec];
  editRecord(0);
}

const subOptionsMap = {
  "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": ["Aestox 50 u", "Aestox 100 u", "Allergan 50 u", "Allergan 100 u", "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î", "‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß"],
  "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥", "Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á", "E.P.T.Q ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢", "Restylane ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢"],
  "Fat/Hifu": ["Bromi", "Sisi", "HIFU", "HIFU ‡πÅ‡∏ñ‡∏°"],
  "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": [
    "Meso Chanel", "P - Cell", "Aquatic", "Hestina", "Exosome", "Rejuran", 
    "Belotero Revive", "Sculptra", "Juvelook", "Aesthefill", 
    "PRP", "Mesowink", "‡∏™‡∏∞‡∏Å‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "Alphaarbutin", "Transamine"
  ],
  "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster"],
  "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": [
    "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤", 
    "‡∏ú‡∏•‡∏±‡∏Å‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô", "‡∏õ‡∏±‡πà‡∏ô RF", "‡∏Å‡∏î‡∏™‡∏¥‡∏ß", "subcision‡∏™‡∏¥‡∏ß"
  ],
  "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": [
    "‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤", "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤", 
    "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÑ‡∏´‡∏° PDO", "‡πÑ‡∏´‡∏° Collagen", 
    "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô/‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏™‡∏•‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå", "PRP‡∏ú‡∏°", "‡∏à‡∏µ‡πâ‡πÑ‡∏ù"
  ],
  "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©": []
};

  
function updateSubOptions(itemSelect, subSelect) {
  const selected = itemSelect.value;

  if (selected === "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©") {
    // ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡πÇ‡∏õ‡∏£‡∏Ø‡πÄ‡∏≠‡∏á)
    const allOptions = Object.entries(subOptionsMap)
      .filter(([key]) => key !== "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©")
      .flatMap(([_, values]) => values);

    // ‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ã‡πâ‡∏≥ + ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô dropdown
    subSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>` +
      [...new Set(allOptions)]
        .map(opt => `<option value="${opt}">${opt}</option>`)
        .join('');

    return;
  }

  // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
  const options = subOptionsMap[selected] || [];
  subSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>` +
    options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
}

  
    
    function addItemRow() {
  const itemList = document.getElementById('itemList');
  const newRow = document.createElement('div');
  newRow.classList.add('item-row');
  newRow.innerHTML = `
    <select name="item[]" onchange="updateSubOptions(this, this.nextElementSibling)">
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å --</option>
      ${Object.keys(subOptionsMap).map(opt => `<option value="${opt}">${opt}</option>`).join('')}
    </select>
    <select name="subitem[]">
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>
    </select>
    <input type="number" name="price[]" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤">
    <input type="number" name="qty[]" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">
  `;
  itemList.appendChild(newRow);
}

    function reviewForm() {
      const date = document.getElementById('date').value;
      const opd = document.getElementById('opd').value;
      const name = document.getElementById('name').value;
      const phone = document.getElementById('phone').value;
      const amount = document.getElementById('amount').value;
      const payment = document.getElementById('paymentType').value;
      const note = document.getElementById('note').value;

      const itemNames = document.querySelectorAll('select[name="item[]"]');
      const itemSubItems = document.querySelectorAll('select[name="subitem[]"]');
      const itemPrices = document.querySelectorAll('input[name="price[]"]');
      const itemQtys = document.querySelectorAll('input[name="qty[]"]');


const items = [];
for (let i = 0; i < itemNames.length; i++) {
  const item = itemNames[i].value;
  const sub = itemSubItems[i].value;
  const price = itemPrices[i].value;
  const qty = itemQtys[i].value;
  if (item && price && qty) {
    const label = sub ? `${item} (${sub})` : item;
    items.push(`${label} - ${qty} ‡∏ä‡∏¥‡πâ‡∏ô x ${price} ‡∏ö‡∏≤‡∏ó`);
  }
}


const newRecord = { items };  // ‡πÉ‡∏™‡πà items ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô

if (date) newRecord.date = date;
if (opd) newRecord.opd = opd;
if (name) newRecord.name = name;
if (phone) newRecord.phone = phone;
if (amount) newRecord.amount = amount;
if (payment) newRecord.payment = payment;
if (note) newRecord.note = note;


records.push(newRecord);
renderReviewSection();  
   

      document.getElementById('saleForm').reset();
      document.getElementById('itemList').innerHTML = document.querySelector('.item-row').outerHTML;
    }

    function renderReviewSection() {
  const section = document.getElementById('reviewSection');
  section.innerHTML = '<h3>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô</h3>';

  const grouped = {};
  records.forEach((rec, index) => {
    const date = rec.date;
    if (!grouped[date]) grouped[date] = [];
    grouped[date].push({ ...rec, index });
  });

  Object.entries(grouped).sort(([d1], [d2]) => new Date(d2) - new Date(d1)).forEach(([date, group]) => {
    const dayTotal = group.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);

    const itemSummary = {};
const itemTotal = {};
const itemSources = {};  // <--- ‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ item

group.forEach(r => {
  r.items.forEach(text => {
    const match = text.match(/^(.+?) ?(?:\((.*?)\))? - (\d+) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+) ‡∏ö‡∏≤‡∏ó/);
    if (match) {
      const main = match[1];         // ‡πÄ‡∏ä‡πà‡∏ô "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©"
      const name = match[2] || main; // ‡∏ä‡∏∑‡πà‡∏≠ item (‡∏¢‡πà‡∏≠‡∏¢), ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ main
      const qty = parseInt(match[3]);
      const price = parseInt(match[4]);

      itemSummary[name] = (itemSummary[name] || 0) + qty;
      itemTotal[name] = (itemTotal[name] || 0) + (qty * price);
      itemSources[name] = main; // üü¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏ô‡∏°‡∏≤‡∏à‡∏£‡∏¥‡∏á ‡πÜ
    }
  });
});

    const container = document.createElement('div');
    container.style.marginBottom = '30px';

    const header = document.createElement('h4');
    header.textContent = `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDate(date)} ‚Äî ‡∏£‡∏ß‡∏° ${dayTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
    container.appendChild(header);

    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.style.marginTop = '10px';

    const tbodyRows = group.map((r, i) => {
      const itemList = r.items.map(item => `<li>${item}</li>`).join('');
      return `
        <tr>
          <td style="border: 1px solid #ccc; padding: 6px; font-size: 13px;">${i + 1}</td>
          <td style="border: 1px solid #ccc; padding: 6px; font-size: 13px;">
            <div><strong>${r.name}</strong></div>
            <div style="font-size: 12px; color: #777;">OPD: ${r.opd}</div>
          </td>
          <td style="border: 1px solid #ccc; padding: 6px; font-size: 13px;">${r.phone}</td>
          <td style="border: 1px solid #ccc; padding: 6px; font-size: 13px;"><ul style='margin:0; padding-left: 16px;'>${itemList}</ul></td>
          <td style="border: 1px solid #ccc; padding: 6px; font-size: 13px;">
            ${r.amount} ‡∏ö‡∏≤‡∏ó (${r.payment})
            ${r.note ? `<div style="font-size: 12px; color: #555;">üìù ${r.note}</div>` : ''}
          </td>
          <td style="border: 1px solid #ccc; padding: 6px; text-align: center; font-size: 13px;">
            <button onclick="editRecord(${r.index})">‚úèÔ∏è</button>
            <button onclick="deleteRecord(${r.index})">üóëÔ∏è</button>
          </td>
        </tr>
      `;
    }).join('');

    table.innerHTML = `
      <thead>
        <tr style="background-color: #f0f0f0;">
          <th style="border: 1px solid #ccc; padding: 6px; font-size: 13px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th style="border: 1px solid #ccc; padding: 6px; font-size: 13px;">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th style="border: 1px solid #ccc; padding: 6px; font-size: 13px;">‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
          <th style="border: 1px solid #ccc; padding: 6px; font-size: 13px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
          <th style="border: 1px solid #ccc; padding: 6px; font-size: 13px;">‡∏¢‡∏≠‡∏î</th>
          <th style="border: 1px solid #ccc; padding: 6px; font-size: 13px;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody>${tbodyRows}</tbody>
    `;

    container.appendChild(table);

    const itemSummaryDiv = document.createElement('div');
    itemSummaryDiv.style.marginTop = '8px';
    itemSummaryDiv.style.textAlign = 'right';
    itemSummaryDiv.style.fontSize = '14px';
    itemSummaryDiv.style.color = '#333';

    itemSummaryDiv.innerHTML = 'üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢:<br>';

    // üîÅ ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
    for (const main in subOptionsMap) {
      if (main === "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©") continue;

      const itemsInGroup = Object.entries(itemSummary).filter(([item]) =>
        (subOptionsMap[main] || []).includes(item)
      );

      if (itemsInGroup.length === 0) continue;

      const groupTotal = itemsInGroup.reduce((sum, [item]) => sum + itemTotal[item], 0);
      const subList = itemsInGroup.map(
        ([item]) => `‚Ä¢ ${item} ${itemSummary[item]} ‡∏ä‡∏¥‡πâ‡∏ô = ${itemTotal[item].toLocaleString()} ‡∏ö‡∏≤‡∏ó`
      ).join('<br>');

      itemSummaryDiv.innerHTML += `‚ñ∂Ô∏è <strong>${main}</strong> ‚Äî ‡∏£‡∏ß‡∏° ${groupTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó<br>${subList}<br><br>`;
    }

    // ‚úÖ ‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏î‡πÄ‡∏•‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£)
    const ungroupedItems = Object.entries(itemSources).filter(
  ([_, main]) => main === "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©"
).map(([item]) => [item, itemSummary[item]]);

    if (ungroupedItems.length > 0) {
  const groupTotal = ungroupedItems.reduce((sum, [item]) => sum + itemTotal[item], 0);
  const subList = ungroupedItems.map(
    ([item]) => `‚Ä¢ ${item} ${itemSummary[item]} ‡∏ä‡∏¥‡πâ‡∏ô = ${itemTotal[item].toLocaleString()} ‡∏ö‡∏≤‡∏ó`
  ).join('<br>');

  itemSummaryDiv.innerHTML += `‚ñ∂Ô∏è <strong>‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</strong> ‚Äî ‡∏£‡∏ß‡∏° ${groupTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó<br>${subList}`;
}

    container.appendChild(itemSummaryDiv);
    section.appendChild(container);
  });
}



function saveAllRecords() {
  if (!confirm('‚ú® ‡∏ä‡∏±‡∏ß‡∏ô‡∏∞? ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢! üí™üòÑ')) return;

  const editOPD = document.getElementById('editOPD')?.value?.trim();
  const editDate = document.getElementById('date')?.value;

  const payload = [...records];

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á delete_before ‡∏î‡πâ‡∏ß‡∏¢
  if (editOPD && editDate) {
    payload.unshift({ delete_before: true, opd: editOPD, date: editDate });
  }

  fetch("/api/save_sales", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    if (data.message === "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à") {
      window.location.href = "/sale_summary";
    } else {
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
    }
  })
  .catch(err => {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢");
  });
}





    function formatDate(dateStr) {
      if (!dateStr) return '';
      const [year, month, day] = dateStr.split('-');
      return `${day}/${month}/${year.slice(-2)}`;
    }
  
    function deleteRecord(index) {
      if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) {
        records.splice(index, 1);
        
      }
    }
    
function startEditExisting() {
  document.getElementById('editSection').style.display = 'block';
}

function loadRecordForEdit() {
  const opd = document.getElementById('editOPD').value.trim();
  const date = document.getElementById('editDate').value;

  if (!opd || !date) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  fetch("/api/sales")
    .then(res => res.json())
    .then(data => {
      const match = data.find(r =>
        r.opd?.trim() === opd &&
        (r.date?.slice(0, 10) === date)
      );

      if (!match) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç");
        console.log("üîç ‡πÑ‡∏°‡πà‡∏°‡∏µ match:", { opd, date, data });
        return;
      }

      records = [];       // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
      records.push(match); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà

      editRecord(0);       // ‡∏ô‡∏≥‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
    })
    .catch(err => {
      console.error("üö´ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
      alert("‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    });
}

    function editRecord(index) {
      const rec = records[index];
      document.getElementById('date').value = rec.date;
      document.getElementById('opd').value = rec.opd;
      document.getElementById('name').value = rec.name;
      document.getElementById('phone').value = rec.phone;
      document.getElementById('amount').value = rec.amount;
      document.getElementById('paymentType').value = rec.payment;
      document.getElementById('note').value = rec.note;

      const itemList = document.getElementById('itemList');
      itemList.innerHTML = '';
      rec.items.forEach(text => {
  const row = document.createElement('div');
  row.classList.add('item-row');
  row.innerHTML = `
    <select name="item[]" onchange="updateSubOptions(this, this.nextElementSibling)">
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å --</option>
      ${Object.keys(subOptionsMap).map(opt => `<option value="${opt}">${opt}</option>`).join('')}
    </select>
    <select name="subitem[]">
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>
    </select>
    <input type="number" name="price[]" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤">
    <input type="number" name="qty[]" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">
  `;

  const match = text.match(/^(.*?) ?(?:\((.*?)\))? - (\d+) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+) ‡∏ö‡∏≤‡∏ó/);
  if (match) {
    const item = match[1].trim();
    const sub = match[2] || "";
    const qty = match[3];
    const price = match[4];

    const itemSelect = row.querySelector('select[name="item[]"]');
    const subSelect = row.querySelector('select[name="subitem[]"]');
    itemSelect.value = item;
    updateSubOptions(itemSelect, subSelect);
    subSelect.value = sub;

    row.querySelector('input[name="qty[]"]').value = qty;
    row.querySelector('input[name="price[]"]').value = price;
  }

  itemList.appendChild(row);
});


      records.splice(index, 1);
      
    }
  
    function deleteRecordFromSupabase(id) {
  if (!confirm("‚ùå ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

  fetch("/api/delete_sales_record", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id })
  })
  .then(res => res.json())
  .then(data => {
    if (data.message === "‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à") {
      alert("‚úÖ ‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      location.reload();  // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
    } else {
      alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + data.error);
    }
  })
  .catch(err => {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö");
    console.error(err);
  });
}

function autoFillByOPD() {
  const opd = document.getElementById('opd').value.trim().padStart(4, '0');
  if (!opd) return;
  const customer = customerMap[opd];
  if (customer) {
    document.getElementById('name').value = customer.name;
    document.getElementById('phone').value = customer.phone;
  }
}




</script>
</body>
</html>
