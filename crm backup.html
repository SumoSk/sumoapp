<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>{% block title %}CRM ‚Äî Sales Pitch{% endblock %}</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">

  {% block head %}
  <style>
    :root{
      --bg:#f7faf9; --card:#ffffff; --muted:#6b7280; --text:#0f172a;
      --primary:#0ea5a4; --primary-600:#0c8e8d; --ring:#9fe8e7;
      --line:#e5e7eb; --danger:#ef4444; --warn:#f59e0b; --success:#22c55e;
      --radius:14px;
      --appbar-h:56px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Prompt','Segoe UI',sans-serif;
      color:var(--text); background:var(--bg);
      font-size:12px; margin:0;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    /* ===== Layout / Container / Appbar ===== */
    .container{
      max-width:1180px;
      margin:18px auto 100px;
      padding:0 12px;
    }
    .appbar{
      position:sticky; top:0; z-index:40;
      backdrop-filter: blur(8px);
      background: rgba(255,255,255,.7);
      background: color-mix(in oklab, var(--bg) 70%, white 30%);
      border-bottom:1px solid var(--line);
    }
    .appbar-inner{
      max-width:1180px;
      margin:0 auto;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      min-height: var(--appbar-h);
    }
    .title{
      font-weight:800;
      font-size: clamp(16px,2.2vw,20px);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }

    /* ===== Buttons ===== */
    .btn{
      appearance:none; border:none; border-radius:10px;
      padding:7px 10px; cursor:pointer; font-weight:700;
      display:inline-flex; align-items:center; gap:6px;
      transition:.15s; font-size:12px;
      background:#fff; color:var(--text);
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      background:var(--primary); color:#fff;
      box-shadow:0 6px 18px rgba(14,165,164,.15);
    }
    .btn-primary:hover{ background:var(--primary-600); }
    .btn-ghost{
      background:#fff; color:var(--text);
      border:1px solid var(--line);
    }
    .btn-icon{ padding:6px; border-radius:8px; }

    /* ===== Focus-visible (keyboard friendly) ===== */
    .btn:focus-visible,
    .input:focus-visible,
    select:focus-visible,
    textarea:focus-visible,
    .tab-btn:focus-visible,
    .icon-btn:focus-visible{
      outline:none;
      box-shadow:0 0 0 3px var(--ring);
    }

    /* ===== Card / Sections ===== */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 8px 22px rgba(2,8,23,.05);
    }
    .section{ margin-top:14px; }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding:10px;
      border-bottom:1px solid var(--line);
      align-items:center;
    }

    /* ===== Form Fields ===== */
    .field{ display:grid; gap:4px; }
    .input, select, textarea{
      width:100%; padding:8px 10px;
      border:1px solid var(--line);
      border-radius:10px;
      outline:none; font-size:12px; background:#fff;
    }
    .input:focus, select:focus, textarea:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 3px var(--ring);
    }
    .invalid{
      border-color:#f87171 !important;
      box-shadow:0 0 0 3px rgba(248,113,113,.25) !important;
    }

    /* ===== New Plan Table ===== */
    .plan-header{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:space-between;
    }
    .plan-title{ font-weight:800; font-size:14px; }
    .plan-actions{ display:flex; gap:8px; align-items:center; }
    .plan-footer{
      padding:10px 12px;
      border-top:1px solid var(--line);
      display:flex; gap:8px; justify-content:flex-end;
      flex-wrap:wrap;
    }

    .table-wrap{ overflow:auto; }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:980px;
    }
    thead th{
      position:sticky; top:0; z-index:1;
      background:#f0fdfa; color:#0f766e;
      font-weight:800; font-size:12px;
      text-align:left; padding:8px 10px;
      border-bottom:1px solid var(--line);
      white-space:nowrap;
    }
    tbody td{
      background:#fff;
      padding:8px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
    }
    tbody tr:hover td{ background:#fafafa; }
    .row-actions{ display:flex; gap:6px; }

    /* ===== KPI Badge ===== */
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:2px 8px; border-radius:999px;
      font-size:11px; background:#ecfeff;
      color:#155e75; border:1px solid #a5f3fc;
    }
    .kpis{ display:flex; gap:8px; flex-wrap:wrap; }

    /* ===== Toast ===== */
    .toast-wrap{
      position:fixed; right:12px; bottom:12px;
      display:grid; gap:8px; z-index:80;
    }
    .toast{
      background:#fff;
      border:1px solid var(--line);
      border-left:5px solid var(--success);
      padding:8px 10px; border-radius:12px;
      min-width:220px;
      box-shadow:0 12px 30px rgba(2,8,23,.15);
      display:flex; gap:8px; font-size:12px;
    }
    .toast.warn{ border-left-color:var(--warn); }
    .toast.error{ border-left-color:var(--danger); }

    /* ===== History Section ===== */
    .history-toolbar{
      padding:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      border-bottom:1px solid var(--line);
      align-items:center;
    }
    .day-card{ border-top:1px solid var(--line); }
    .day-head{
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
      background:#fff;
    }
    .day-head:hover{ background:#f8fafc; }
    .day-title{ font-weight:800; }
    .day-meta{
      color:#64748b;
      display:flex; gap:8px; align-items:center;
      flex-wrap:wrap;
    }
    .day-body{
      padding:6px 12px 12px;
      display:none;
    }
    .day-body.open{ display:block; }

    .history-row{
      display:grid;
      grid-template-columns: 78px 1fr 1.1fr 1fr 2fr 0.8fr 92px;
      gap:8px;
      padding:8px 0;
      border-bottom:1px dashed var(--line);
      font-size:12px;
    }
    .history-row [data-cell="actions"]{
      display:flex;
      gap:6px;
      align-items:center;
      justify-content:center;
      flex-wrap:nowrap;
    }
    .history-head{ font-weight:700; color:#0f766e; }
    .outcome-badge{
      padding:2px 6px;
      border-radius:999px;
      font-size:11px;
      border:1px solid #e2e8f0;
      background:#f8fafc;
    }
    .sortable{
      cursor:pointer; user-select:none;
      display:inline-flex; align-items:center; gap:6px;
    }
    .sort-ind{ font-size:11px; color:#0f766e; opacity:.8; }

    /* ===== Inline edit buttons ===== */
    .icon-btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff; color:#0f172a;
      border-radius:8px;
      padding:3px 6px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .icon-btn + .icon-btn{ margin-left:6px; }
    .icon-btn:hover{ box-shadow:0 0 0 3px var(--ring); }
    .icon-save{ border-color:#a7f3d0; }
    .icon-cancel{ border-color:#fecaca; }

    /* ===== Customer Modal ===== */
    #customer-modal{
      position:fixed; inset:0; display:none;
      align-items:center; justify-content:center;
      background:rgba(2,8,23,.45); z-index:200;
    }
    #customer-modal .panel{
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      width:min(860px, 94vw);
      max-height:82vh;
      overflow:auto;
      padding:18px 20px;
      box-shadow:0 22px 50px rgba(2,8,23,.3);
      position:relative;
    }
    .customer-link{
      cursor:pointer;
      color:#0ea5a4;
      font-weight:700;
    }
    .customer-link:hover{ text-decoration:underline; }

    /* ===== Followup Summary ===== */
    .summary-card-title{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      font-weight:800;
      font-size:14px;
      background:#f9fafb;
    }
    .summary-section{
      padding:10px 12px;
      border-top:1px solid var(--line);
      background:#fff;
    }
    .summary-section:first-of-type{ border-top:none; }
    .summary-title{
      font-weight:800;
      margin-bottom:6px;
      font-size:13px;
    }
    .summary-table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:12px;
      min-width:720px;
    }
    .summary-table th,
    .summary-table td{
      padding:4px 6px;
      border-bottom:1px dashed var(--line);
      text-align:left;
      vertical-align:top;
    }
    .summary-table th{
      color:#0f766e;
      font-weight:700;
      white-space:nowrap;
      background:#f0fdfa;
    }
    .summary-table th:nth-child(n+2),
    .summary-table td:nth-child(n+2){ font-size:11px; }
    .summary-last-note{
      margin-top:2px;
      font-size:10px;
      color:#6b7280;
    }
    .summary-empty{ color:#9ca3af; font-size:11px; }

    /* ===== Tabs (Sticky) ===== */
    .tabs-wrap{
      position: sticky;
      top: calc(var(--appbar-h) + 1px);
      z-index: 30;
      background: var(--bg);
      padding: 10px 0 10px;
      border-bottom: 1px solid var(--line);
      margin-bottom: 10px;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .tabs-wrap::-webkit-scrollbar { display: none; }

    .tab-btn{
      flex: 1;
      min-width: 120px;
      padding: 10px 8px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      color: var(--muted);
      cursor: pointer;
      font-weight: 700;
      font-size: 12px;
      text-align: center;
      transition: all 0.2s;
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      user-select:none;
    }
    .tab-btn:hover { background: #f8fafc; }
    .tab-btn.active{
      border-color: transparent;
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }
    .tab-btn[data-tab="1"].active { background: #10b981; }
    .tab-btn[data-tab="2"].active { background: #f59e0b; }
    .tab-btn[data-tab="3"].active { background: #ef4444; }
    .tab-btn[data-tab="4"].active { background: #64748b; }

    .tab-count{
      font-size: 10px;
      background: rgba(255,255,255,0.25);
      padding: 2px 8px;
      border-radius: 20px;
    }
    .tab-btn:not(.active) .tab-count{
      background: #e2e8f0; color: #64748b;
    }

    /* ===== Responsive Desktop ‚Üí Tablet ===== */
    @media (max-width: 1024px){
      .container{ margin:14px auto 80px; padding:0 10px; }
      .history-toolbar{ padding:8px; gap:6px; }
      .plan-header, .plan-footer{ padding:8px 10px; }
    }

    /* ===== Responsive Tablet / Mobile ===== */
    @media (max-width: 820px){
      body{ font-size:11px; }
      .container{ margin:12px auto 70px; padding:0 10px; }
      .appbar-inner{ padding:8px 10px; gap:6px; }
      .title{ font-size:15px; }
      .kpis{ flex:0 0 100%; }
      .badge{ font-size:10px; padding:2px 6px; }
      .history-row{ grid-template-columns: 66px 1fr 1fr 64px; }
      .hide-sm{ display:none; }
      table{ min-width:860px; }
      .summary-table{ min-width:600px; }
    }

    /* ===== Responsive Small Mobile ===== */
    @media (max-width: 480px){
      .appbar-inner{ flex-wrap:wrap; }
      .title{ flex:1 0 100%; margin-bottom:4px; }
      .btn{ font-size:11px; padding:6px 8px; }
      .history-toolbar{ padding:8px; gap:6px; }
      .field span{ font-size:11px; }
      .summary-title{ font-size:12px; }
      .summary-table{ font-size:11px; }
      .summary-table th:nth-child(n+2),
      .summary-table td:nth-child(n+2){ font-size:9px; }
    }
  </style>
  {% endblock %}
</head>

<body>
{% block content %}

  <div class="appbar">
    <div class="appbar-inner">
      <div class="title">üéß Sales Pitch</div>
      <div class="kpis">
        <div class="badge">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <span id="kpiToday">0</span></div>
        <div class="badge">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ: <span id="kpiWeek">0</span></div>
        <div class="badge">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <span id="kpiMonth">0</span></div>
      </div>
      <div style="flex:1"></div>
      <button id="newPlanBtn" class="btn btn-primary" type="button">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
    </div>
  </div>

  <div class="container">

    <div class="section card" id="newPlanCard" style="display:none;">
      <div class="plan-header">
        <div>
          <div class="plan-title" id="planTitle">Sale Pitch ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‚Äî</div>
        </div>
        <div class="plan-actions">
          <label class="field" style="min-width: 180px;">
            <span style="font-weight:700;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
            <input id="planDate" type="date" class="input">
          </label>
        </div>
      </div>

      <div class="toolbar" style="gap:14px;">
        <div class="badge">Draft ‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
        <button id="clearDraftBtn" class="btn btn-ghost" type="button">‡∏•‡πâ‡∏≤‡∏á Draft</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:48px;">#</th>
              <th style="min-width: 280px;">‡∏ä‡∏∑‡πà‡∏≠ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)</th>
              <th class="hide-sm">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</th>
              <th>Outcome</th>
              <th class="hide-sm">‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</th>
              <th class="hide-sm" style="width:120px;">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
              <th style="width:68px;">‡∏•‡∏ö</th>
            </tr>
          </thead>
          <tbody id="planTbody"></tbody>
        </table>
      </div>

      <div class="plan-footer">
        <button id="addRowBtn" class="btn btn-ghost" type="button">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        <button id="saveAllBtn" class="btn btn-primary" type="button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
    </div>

    <div class="section card" id="summaryCard">
      <div class="summary-card-title">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</div>
      <div id="summaryBody"></div>
    </div>

    <div class="section card">
      <div class="history-toolbar">
        <div class="field">
          <span style="font-weight:700;">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
          <div style="display:flex; gap:6px;">
            <input type="date" id="histFrom" class="input">
            <input type="date" id="histTo" class="input">
          </div>
        </div>

        <div class="field" style="min-width:200px;">
          <span style="font-weight:700;">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span>
          <input type="text" id="histQ" class="input" placeholder="‡∏ä‡∏∑‡πà‡∏≠ / ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô / ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå">
        </div>

        <div class="field" style="min-width:200px;">
          <span style="font-weight:700;">Outcome</span>
          <select id="histOutcome"></select>
        </div>

        <div class="field" style="min-width:160px;">
          <span style="font-weight:700;">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</span>
          <select id="histChannel"></select>
        </div>

        <div style="display:flex; gap:8px; align-items:flex-end; margin-left:auto;">
          <button id="reloadHistoryBtn" class="btn btn-ghost" type="button">‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î</button>
          <button id="toggleAllBtn" class="btn btn-ghost" type="button">‡∏Å‡∏≤‡∏á/‡∏û‡∏±‡∏ö ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          <button id="exportCsvBtn" class="btn btn-ghost" type="button">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
        </div>
      </div>

      <div id="historyWrap"></div>
    </div>

  </div>

  <div class="toast-wrap" id="toastWrap"></div>
  <datalist id="customerList"></datalist>

  <!-- Accessible Modal -->
  <div id="customer-modal" aria-hidden="true">
    <div class="panel" id="customer-modal-box" role="dialog" aria-modal="true" aria-labelledby="customer-modal-title" tabindex="-1">
      <div style="position:absolute; top:10px; left:14px; display:flex; gap:10px; z-index:2;">
        <button type="button" id="customerModalSaveBtn" class="btn btn-ghost btn-icon" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">üíæ</button>
      </div>
      <div style="position:absolute; top:10px; right:10px;">
        <button type="button" id="customerModalCloseBtn" class="btn btn-ghost btn-icon" title="‡∏õ‡∏¥‡∏î">‚ùå</button>
      </div>
      <div id="modal-content"></div>
    </div>
  </div>

  <script>
    // ========= Utils =========
    const $ = (q, p=document)=>p.querySelector(q);
    const $$ = (q, p=document)=>Array.from(p.querySelectorAll(q));
    const toastWrap = $('#toastWrap');

    const showToast = (msg, type='ok')=>{
      const el = document.createElement('div');
      el.className = 'toast' + (type==='warn' ? ' warn' : type==='error' ? ' error' : '');
      el.innerHTML = `<div>üí°</div><div>${msg}</div>`;
      toastWrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; }, 2200);
      setTimeout(()=>{ el.remove(); }, 2800);
    };

    const fmtShortDate = (iso)=>{
      try{
        const d = new Date(iso);
        if (isNaN(d)) return iso || '';
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yy = String(d.getFullYear()).slice(-2);
        return `${dd}-${mm}-${yy}`;
      }catch{
        return iso || '';
      }
    };
    const fmtThaiDate = fmtShortDate;

    const todayISO = ()=> new Date().toISOString().slice(0,10);
    const debounce = (fn,ms=300)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };
    const pad4 = s => String(s ?? '').trim().padStart(4,'0');
    const esc = s => String(s||'')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#039;");

    // Sync appbar height for sticky tabs
    function syncAppbarHeight(){
      const appbarInner = document.querySelector('.appbar-inner');
      if(!appbarInner) return;
      const h = Math.ceil(appbarInner.getBoundingClientRect().height);
      document.documentElement.style.setProperty('--appbar-h', `${h}px`);
    }
    window.addEventListener('resize', syncAppbarHeight);
    window.addEventListener('load', syncAppbarHeight);

    // ========= Data (customers + enums) =========
    const OUTCOMES = [
      '‡∏™‡∏ô‡πÉ‡∏à‡πÇ‡∏≠‡∏ô‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏±‡∏î‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
      '‡∏™‡∏ô‡πÉ‡∏à‡πÇ‡∏≠‡∏ô‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ô‡∏±‡∏î‡∏ß‡∏±‡∏ô',
      '‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠',
      '‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ',
      '‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡πÑ‡∏°‡πà‡∏ö‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•',
      '‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á',
      '‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÇ‡∏õ‡∏£‡∏≠‡∏∑‡πà‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤',
      '‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß',
      '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏¥‡∏î',
      '‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢',
      '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á',
    ];
    const CHANNELS = ['call','line','visit','facebook','instagram','other'];

    let customers = [];
    let customerIndex = new Map();
    let customerByOPD = new Map();
    let recordsByKey = new Map();

    // ========= Elements =========
    const newPlanBtn = $('#newPlanBtn');
    const newPlanCard = $('#newPlanCard');
    const planDate = $('#planDate');
    const planTitle = $('#planTitle');
    const planTbody = $('#planTbody');
    const addRowBtn = $('#addRowBtn');
    const saveAllBtn = $('#saveAllBtn');
    const clearDraftBtn = $('#clearDraftBtn');

    const histFrom = $('#histFrom'), histTo = $('#histTo'), histQ = $('#histQ'), histOutcome = $('#histOutcome'), histChannel = $('#histChannel');
    const historyWrap = $('#historyWrap');
    const reloadHistoryBtn = $('#reloadHistoryBtn');
    const toggleAllBtn = $('#toggleAllBtn');
    const exportCsvBtn = $('#exportCsvBtn');

    const kpiToday = $('#kpiToday'), kpiWeek = $('#kpiWeek'), kpiMonth = $('#kpiMonth');

    // ========= Draft LocalStorage =========
    const DRAFT_KEY = 'crm_pitch_draft_v1';
    const loadDraft = ()=>{ try{ return JSON.parse(localStorage.getItem(DRAFT_KEY)) || null; }catch{return null;} };
    const saveDraft = debounce(()=>{
      const draft = { date: planDate.value || todayISO(), rows: getRowsPayload(true) };
      localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
    }, 250);
    const clearDraft = ()=> localStorage.removeItem(DRAFT_KEY);

    // ========= Init =========
    (async function init(){
      histOutcome.innerHTML = [`<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`, ...OUTCOMES.map(o=>`<option>${o}</option>`)].join('');
      histChannel.innerHTML = [`<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`, ...CHANNELS.map(c=> `<option value="${c}">${c}</option>`)].join('');

      histFrom.value = '';
      histTo.value = '';

      await loadCustomers();
      buildCustomerDatalist();

      await loadCustomerRecords();

      const draft = loadDraft();
      newPlanCard.style.display = 'block';
      planDate.value = draft?.date || todayISO();
      updatePlanTitle();

      planTbody.innerHTML = '';
      if(draft?.rows?.length){ draft.rows.forEach(addRowFromDraft); }
      else { addEmptyRow(); }

      await reloadHistory();
      updateKPIsFromHistoryCache();
      syncAppbarHeight();
    })();

    async function loadCustomers(){
      try{
        const res = await fetch('/api/customers');
        if(!res.ok) throw 0;
        const data = await res.json();
        customers = Array.isArray(data) ? data : [];
        customers.forEach(c=>{
          const opd = pad4(c?.opd);
          const phone = String(c?.phone ?? '');
          const name = String(c?.name ?? '').trim();
          const label = name ? `${name} ‚Äî ${opd}${phone?` / ${phone}`:''}` : opd;
          if(label) customerIndex.set(label, {opd, name, phone});
          if(opd) customerByOPD.set(opd, {opd, name, phone});
        });
      }catch{
        showToast('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
      }
    }
    function buildCustomerDatalist(){
      const dl = $('#customerList');
      const keys = Array.from(customerIndex.keys());
      keys.sort((a,b)=> a.localeCompare(b,'th'));
      dl.innerHTML = keys.map(k=> `<option value="${k}"></option>`).join('');
    }

    function makeCustomerKey(opd, name, phone){
      opd   = pad4(opd || '');
      name  = String(name || '').trim();
      phone = String(phone || '');
      if(opd) return opd;
      if(phone) return `phone:${phone}`;
      return name || '';
    }

    function rebuildRecordsIndex(){
      recordsByKey = new Map();
      const list = window.allCustomerRecords || [];
      list.forEach(r=>{
        const opd   = pad4(r.opd || '');
        const name  = (r.name || '').trim();
        const phone = r.phone || '';
        const key = makeCustomerKey(opd, name, phone);
        if(!key) return;
        if(!recordsByKey.has(key)) recordsByKey.set(key, []);
        recordsByKey.get(key).push(r);
      });
    }

    function updatePlanTitle(){
      const d = planDate.value || todayISO();
      planTitle.textContent = `Sale Pitch ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${fmtThaiDate(d)}`;
    }

    // ========= Plan Rows =========
    function addEmptyRow(){
      const idx = planTbody.children.length + 1;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="text-align:center; color:#64748b;">${idx}</td>
        <td>
          <input class="input input-cust" list="customerList" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ / OPD / ‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">
          <div class="cust-meta" style="font-size:11px; color:#64748b; margin-top:4px;"></div>
        </td>
        <td class="hide-sm"><input class="input input-promo" placeholder="‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠"></td>
        <td>
          <select class="input sel-outcome">
            ${OUTCOMES.map(o=> `<option>${o}</option>`).join('')}
          </select>
        </td>
        <td class="hide-sm"><input class="input input-note" placeholder="‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></td>
        <td class="hide-sm">
          <select class="input sel-channel">
            ${CHANNELS.map(c=> `<option value="${c}">${c}</option>`).join('')}
          </select>
        </td>
        <td>
          <div class="row-actions">
            <button class="btn btn-icon btn-ghost" type="button" title="‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß" data-row-del>üóëÔ∏è</button>
          </div>
        </td>
      `;
      planTbody.appendChild(tr);
    }

    function addRowFromDraft(row){
      addEmptyRow();
      const tr = planTbody.lastElementChild;
      const custInput = tr.querySelector('.input-cust');
      const meta = tr.querySelector('.cust-meta');

      if(row.opd && customerByOPD.has(row.opd)){
        const c = customerByOPD.get(row.opd);
        const label = `${(c.name||c.opd)||''} ‚Äî ${c.opd}${c.phone?` / ${c.phone}`:''}`;
        custInput.value = label; tr.dataset.opd = c.opd;
        meta.textContent = `OPD ${c.opd}${c.phone?` ‚Ä¢ ${c.phone}`:''}`;
      }else if(row.customer_label){
        custInput.value = row.customer_label;
        const picked = customerIndex.get(row.customer_label);
        if(picked){
          tr.dataset.opd = picked.opd;
          meta.textContent = `OPD ${picked.opd}${picked.phone?` ‚Ä¢ ${picked.phone}`:''}`;
        }
      }

      tr.querySelector('.input-promo').value = row.promotion||'';
      tr.querySelector('.sel-outcome').value = row.outcome||OUTCOMES[0];
      tr.querySelector('.input-note').value = row.content||'';
      tr.querySelector('.sel-channel').value = row.channel||'call';
    }

    function reindexRows(){
      $$('#planTbody > tr').forEach((tr,i)=> tr.firstElementChild.textContent = String(i+1));
    }

    function getRowsPayload(includeInvalid=false){
      const date = planDate.value || todayISO();
      const rows = [];
      $$('#planTbody > tr').forEach(tr=>{
        const opd = tr.dataset.opd || '';
        const customer_label = tr.querySelector('.input-cust').value.trim();
        const promotion = tr.querySelector('.input-promo')?.value.trim() || '';
        const outcome = tr.querySelector('.sel-outcome')?.value || '';
        const content = tr.querySelector('.input-note')?.value.trim() || '';
        const channel = tr.querySelector('.sel-channel')?.value || 'call';
        const valid = !!opd && !!outcome;
        if(valid || includeInvalid){
          rows.push({ date, opd, promotion, outcome, content, channel, customer_label });
        }
      });
      return rows;
    }

    function getFirstPromoFromPlan(){
      const firstRow = $('#planTbody > tr');
      if(!firstRow) return '';
      return firstRow.querySelector('.input-promo')?.value || '';
    }

    // ========= Plan events =========
    newPlanBtn.addEventListener('click', ()=>{
      newPlanCard.style.display = 'block';
      if(!planDate.value) planDate.value = todayISO();
      updatePlanTitle();
      showToast('‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà');
      syncAppbarHeight();
    });

    planDate.addEventListener('change', ()=>{
      updatePlanTitle();
      saveDraft();
    });

    addRowBtn.addEventListener('click', ()=>{
      const firstPromo = getFirstPromoFromPlan();
      addEmptyRow();
      const last = planTbody.lastElementChild;
      const promoInput = last?.querySelector('.input-promo');
      if(promoInput && firstPromo) promoInput.value = firstPromo;
      saveDraft();
    });

    clearDraftBtn.addEventListener('click', ()=>{
      if(confirm('‡∏•‡πâ‡∏≤‡∏á Draft ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){
        clearDraft();
        planTbody.innerHTML = '';
        addEmptyRow();
        showToast('‡∏•‡πâ‡∏≤‡∏á Draft ‡πÅ‡∏•‡πâ‡∏ß','warn');
      }
    });

    // Event delegation for plan table (performance + simpler)
    planTbody.addEventListener('input', ()=>{
      saveDraft();
    });

    planTbody.addEventListener('change', (e)=>{
      const tr = e.target.closest('tr');
      if(!tr) return;
      if(e.target.classList.contains('input-cust')){
        const custInput = e.target;
        const meta = tr.querySelector('.cust-meta');
        const picked = customerIndex.get(custInput.value.trim());
        if(picked){
          meta.textContent = `OPD ${picked.opd}${picked.phone?` ‚Ä¢ ${picked.phone}`:''}`;
          tr.dataset.opd = picked.opd;
          custInput.classList.remove('invalid');
        }else{
          meta.textContent = '';
          tr.dataset.opd = '';
          custInput.classList.add('invalid');
        }
        saveDraft();
      }
    });

    planTbody.addEventListener('click', (e)=>{
      const del = e.target.closest('[data-row-del]');
      if(!del) return;
      const tr = del.closest('tr');
      if(!tr) return;
      tr.remove();
      reindexRows();
      saveDraft();
      if(!planTbody.children.length) addEmptyRow();
    });

    saveAllBtn.addEventListener('click', async ()=>{
      const rows = getRowsPayload();
      if(!rows.length){
        showToast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å','warn');
        return;
      }

      const invalids = rows.filter(r=> !r.opd || !r.outcome);
      if(invalids.length){
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå','warn');
        $$('#planTbody > tr').forEach(tr=>{
          const custInput = tr.querySelector('.input-cust');
          if(!tr.dataset.opd) custInput.classList.add('invalid');
        });
        return;
      }

      const count = rows.length;
      const confirmMsg = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`;
      if(!confirm(confirmMsg)){
        showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        return;
      }

      saveAllBtn.disabled = true;
      saveAllBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      try{
        const res = await fetch('/api/add_pitches_bulk', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(rows.map(r=>({
            date: r.date,
            opd: r.opd,
            promotion: r.promotion,
            outcome: r.outcome,
            content: r.content,
            channel: r.channel
          })))
        });
        const d = await res.json();
        if(res.ok){
          showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${d.inserted||rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚úÖ`);
          planTbody.innerHTML='';
          addEmptyRow();
          clearDraft();
          await reloadHistory();
          updateKPIsFromHistoryCache();
        }else{
          showToast(d.error||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
        }
      }catch{
        showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ','error');
      }finally{
        saveAllBtn.disabled = false;
        saveAllBtn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
      }
    });

    // ========= History (sortable Outcome + actions) =========
    let historyCache = [];
    let outcomeFreqMap = {};
    const dayOutcomeOrder = new Map();

    function buildOutcomeFreq(){
      const freq = {};
      for(const x of historyCache){
        const k = x.outcome || '';
        freq[k] = (freq[k]||0) + 1;
      }
      outcomeFreqMap = freq;
    }

    async function reloadHistory(){
      const from = (histFrom.value || '').trim();
      const to   = (histTo.value   || '').trim();
      const q = (histQ.value||'').trim();
      const outcome = histOutcome.value || '';
      const channel = histChannel.value || '';

      historyWrap.innerHTML = '<div style="padding:12px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
      try{
        const url = new URL('/api/pitches_by_date', window.location.origin);

        if(!from && !to){
          url.searchParams.set('from', '1970-01-01');
          url.searchParams.set('to',   '9999-12-31');
        }else{
          if(from) url.searchParams.set('from', from);
          if(to)   url.searchParams.set('to',   to);
        }

        if(q)       url.searchParams.set('q', q);
        if(outcome) url.searchParams.set('outcome', outcome);
        if(channel) url.searchParams.set('channel', channel);

        const res = await fetch(url);
        if(!res.ok) throw 0;
        const list = await res.json();
        if(!Array.isArray(list)) throw new Error('invalid');

        historyCache = list;

        buildOutcomeFreq();
        buildFollowupSummary();

        const groups = new Map();
        for(const x of list){
          const d = (x.created_at||x.date||'').slice(0,10);
          if(!groups.has(d)) groups.set(d, []);
          groups.get(d).push(x);
        }

        const days = Array.from(groups.keys()).sort((a,b)=> b.localeCompare(a));
        const frag = document.createDocumentFragment();

        days.forEach(day=>{
          if(!dayOutcomeOrder.has(day)) dayOutcomeOrder.set(day, '');
          frag.appendChild(renderDayCard(day, groups.get(day)));
        });

        historyWrap.innerHTML='';
        historyWrap.appendChild(frag);

        if(!days.length){
          historyWrap.innerHTML = '<div style="padding:12px; color:#64748b;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</div>';
        }
      }catch{
        historyWrap.innerHTML = '<div style="padding:12px; color:#b91c1c;">‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API /api/pitches_by_date)</div>';
      }
    }

    function isInterested(outcomeText){
      return /^‡∏™‡∏ô‡πÉ‡∏à/.test(String(outcomeText || '').trim());
    }

    function sortItemsByOutcomeFreq(items, order){
      if(!order) return [...items].sort((a,b)=> (b.created_at||'').localeCompare(a.created_at||''));
      return [...items].sort((a,b)=>{
        const fa = outcomeFreqMap[a.outcome||'']||0;
        const fb = outcomeFreqMap[b.outcome||'']||0;
        if(fa === fb) return (b.created_at||'').localeCompare(a.created_at||'');
        return order === 'desc' ? (fb - fa) : (fa - fb);
      });
    }

    function renderDayCard(dayISO, items){
      const order = dayOutcomeOrder.get(dayISO) || '';
      const itemsSorted = sortItemsByOutcomeFreq(items, order);

      const div = document.createElement('div');
      div.className = 'day-card';

      const total = items.length;
      const interested = items.filter(x=> isInterested(x.outcome)).length;
      const notInterested = total - interested;
      const opened = (dayISO === todayISO());

      div.innerHTML = `
        <div class="day-head" data-toggle>
          <div class="day-title">${fmtThaiDate(dayISO)}</div>
          <div class="day-meta">
            <span class="badge">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total}</span>
            <span class="badge">‡∏™‡∏ô‡πÉ‡∏à: ${interested}</span>
            <span class="badge">‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à: ${notInterested}</span>
          </div>
        </div>
        <div class="day-body ${opened?'open':''}">
          <div class="history-row history-head">
            <div>‡πÄ‡∏ß‡∏•‡∏≤</div>
            <div>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
            <div class="hide-sm">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</div>
            <div class="sortable" data-sort-outcome>
              Outcome <span class="sort-ind" data-sort-ind>${order===''?'‚Üï':order==='desc'?'‚ñº ‡∏°‡∏≤‡∏Å‚Üí‡∏ô‡πâ‡∏≠‡∏¢':'‚ñ≤ ‡∏ô‡πâ‡∏≠‡∏¢‚Üí‡∏°‡∏≤‡∏Å'}</span>
            </div>
            <div class="hide-sm">‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</div>
            <div class="hide-sm">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</div>
            <div>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div>
          </div>
          <div class="rows" data-rows>
            ${itemsSorted.map(renderHistoryRow).join('')}
          </div>
        </div>
      `;

      div.querySelector('[data-toggle]').addEventListener('click', (e)=>{
        if(e.target.closest('[data-sort-outcome]')) return;
        div.querySelector('.day-body').classList.toggle('open');
      });

      div.querySelector('[data-sort-outcome]').addEventListener('click', ()=>{
        const current = dayOutcomeOrder.get(dayISO) || '';
        const next = current==='' ? 'desc' : (current==='desc' ? 'asc' : '');
        dayOutcomeOrder.set(dayISO, next);

        const rowsWrap = div.querySelector('[data-rows]');
        const ind = div.querySelector('[data-sort-ind]');
        ind.textContent = next==='' ? '‚Üï' : (next==='desc'?'‚ñº ‡∏°‡∏≤‡∏Å‚Üí‡∏ô‡πâ‡∏≠‡∏¢':'‚ñ≤ ‡∏ô‡πâ‡∏≠‡∏¢‚Üí‡∏°‡∏≤‡∏Å');

        const sorted = sortItemsByOutcomeFreq(items, next);
        rowsWrap.innerHTML = sorted.map(renderHistoryRow).join('');
      });

      return div;
    }

    function renderHistoryRow(x){
      const time = (x.created_at||'').slice(11,16);
      const opd = pad4(x.opd||'');
      const name = x.customer_name || (customerByOPD.get(opd)?.name) || opd;
      const phone = customerByOPD.get(opd)?.phone || x.customer_phone || '';
      const promo = x.promotion || '';
      const outcome = x.outcome || '';
      const content = String(x.content||'').replace(/</g,'&lt;');
      const channel = x.channel || '';
      const id = x.id || `${x.created_at||''}|${opd}`;

      return `
        <div class="history-row" data-row data-id="${esc(id)}">
          <div data-cell="time">${time||'-'}</div>
          <div data-cell="name">
            <span class="customer-link"
                  data-name="${esc(name)}"
                  data-phone="${esc(phone)}"
                  data-opd="${esc(opd)}">${esc(name)}</span>
            <span style="color:#64748b;">‚Ä¢ OPD ${esc(opd)}</span>
          </div>
          <div class="hide-sm" data-cell="promotion">${esc(promo)||''}</div>
          <div data-cell="outcome"><span class="outcome-badge">${esc(outcome)||''}</span></div>
          <div class="hide-sm" data-cell="content">${content||''}</div>
          <div class="hide-sm" data-cell="channel">${esc(channel)||''}</div>
          <div data-cell="actions">
            <button class="icon-btn" type="button" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" data-action="edit">‚úèÔ∏è</button>
            <button class="icon-btn" type="button" title="‡∏•‡∏ö" data-action="delete">üóëÔ∏è</button>
          </div>
        </div>
      `;
    }

    // ===== Inline edit / delete handlers =====
    function enterEditMode(rowEl){
      if(rowEl.dataset.editing === '1') return;
      rowEl.dataset.editing = '1';
      const get = s => rowEl.querySelector(`[data-cell="${s}"]`);

      const promoVal   = (get('promotion')?.textContent.trim() === '‚Äî') ? '' : get('promotion')?.textContent.trim();
      const outcomeVal = (get('outcome')?.textContent || '').replace(/<[^>]*>/g,'').trim();
      const contentVal = (get('content')?.textContent.trim() === '‚Äî') ? '' : get('content')?.textContent.trim();
      const channelVal = (get('channel')?.textContent.trim() === '‚Äî') ? '' : get('channel')?.textContent.trim();

      if(get('promotion')) get('promotion').innerHTML = `<input class="input" data-edit="promotion" value="${esc(promoVal)||''}">`;
      get('outcome').innerHTML = `<select class="input" data-edit="outcome">
        ${OUTCOMES.map(o=> `<option ${o===outcomeVal?'selected':''}>${o}</option>`).join('')}
      </select>`;
      if(get('content')) get('content').innerHTML = `<input class="input" data-edit="content" value="${esc(contentVal)||''}" placeholder="‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå">`;
      if(get('channel')) get('channel').innerHTML = `<select class="input" data-edit="channel">
        ${CHANNELS.map(c=> `<option value="${c}" ${c===channelVal?'selected':''}>${c}</option>`).join('')}
      </select>`;

      get('actions').innerHTML = `
        <button class="icon-btn icon-save" type="button" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" data-action="save">üíæ</button>
        <button class="icon-btn icon-cancel" type="button" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" data-action="cancel">‚Ü©Ô∏è</button>
      `;
    }

    function exitEditMode(rowEl, original){
      rowEl.dataset.editing = '0';
      const get = s => rowEl.querySelector(`[data-cell="${s}"]`);
      if(original){
        if(get('promotion')) get('promotion').textContent = original.promotion||'‚Äî';
        get('outcome').innerHTML = `<span class="outcome-badge">${esc(original.outcome||'-')}</span>`;
        if(get('content')) get('content').textContent = original.content||'‚Äî';
        if(get('channel')) get('channel').textContent = original.channel||'-';
      }
      get('actions').innerHTML = `
        <button class="icon-btn" type="button" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" data-action="edit">‚úèÔ∏è</button>
        <button class="icon-btn" type="button" title="‡∏•‡∏ö" data-action="delete">üóëÔ∏è</button>
      `;
    }

    async function saveRow(rowEl){
      const id = rowEl.dataset.id;
      const get = s => rowEl.querySelector(`[data-edit="${s}"]`);
      const payload = {
        id,
        promotion: get('promotion')?.value?.trim() || '',
        outcome: get('outcome')?.value || '',
        content: get('content')?.value?.trim() || '',
        channel: get('channel')?.value || ''
      };
      try{
        const res = await fetch('/api/update_pitch', {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw 0;
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
        await reloadHistory();
        updateKPIsFromHistoryCache();
      }catch{
        showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
      }
    }

    async function deleteRow(rowEl){
      const id = rowEl.dataset.id;
      if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      try{
        const res = await fetch(`/api/delete_pitch?id=${encodeURIComponent(id)}`, { method:'DELETE' });
        if(!res.ok) throw 0;
        showToast('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
        rowEl.remove();
      }catch{
        showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
      }
    }

    // Event delegation for history edit/delete
    historyWrap.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-action]');
      if(!btn) return;
      const row = e.target.closest('[data-row]');
      if(!row) return;

      const action = btn.dataset.action;
      if(action==='edit'){
        row._original = {
          promotion: row.querySelector('[data-cell="promotion"]')?.textContent.trim(),
          outcome: row.querySelector('[data-cell="outcome"]')?.textContent.replace(/<[^>]*>/g,'').trim(),
          content: row.querySelector('[data-cell="content"]')?.textContent.trim(),
          channel: row.querySelector('[data-cell="channel"]')?.textContent.trim()
        };
        enterEditMode(row);
      }else if(action==='cancel'){
        exitEditMode(row, row._original);
      }else if(action==='save'){
        saveRow(row);
      }else if(action==='delete'){
        deleteRow(row);
      }
    });

    // history controls
    reloadHistoryBtn.addEventListener('click', reloadHistory);
    histFrom.addEventListener('change', reloadHistory);
    histTo.addEventListener('change', reloadHistory);
    histQ.addEventListener('input', debounce(reloadHistory, 400));
    histOutcome.addEventListener('change', reloadHistory);
    histChannel.addEventListener('change', reloadHistory);

    // Make "toggle all" deterministic
    toggleAllBtn.addEventListener('click', ()=>{
      const bodies = $$('#historyWrap .day-body');
      const hasClosed = bodies.some(b=> !b.classList.contains('open'));
      bodies.forEach(b=> b.classList.toggle('open', hasClosed));
    });

    exportCsvBtn.addEventListener('click', ()=>{
      if(!historyCache.length){ showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å','warn'); return; }
      const header = ['date','time','opd','name','promotion','outcome','content','channel'];
      const lines = [header.join(',')];
      for(const x of historyCache){
        const d = (x.created_at||x.date||'').slice(0,10);
        const t = (x.created_at||'').slice(11,19);
        const opd = pad4(x.opd||'');
        const name = (x.customer_name || customerByOPD.get(opd)?.name || '').replaceAll('"','""');
        const promo = String(x.promotion||'').replaceAll('"','""');
        const outcome = String(x.outcome||'').replaceAll('"','""');
        const content = String(x.content||'').replaceAll('"','""');
        const channel = String(x.channel||'').replaceAll('"','""');
        const escq = v=> `"${v}"`;
        lines.push([d,t,opd,name,promo,outcome,content,channel].map(escq).join(','));
      }
      const csv = lines.join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
      a.download = `pitches_${histFrom.value||''}_${histTo.value||''}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
      showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV ‡πÅ‡∏•‡πâ‡∏ß');
    });

    // ========= KPIs =========
    function updateKPIsFromHistoryCache(){
      const today = todayISO();
      const now = new Date();
      const dow = now.getDay();
      const diffToMon = (dow + 6) % 7;
      const startOfWeek = new Date(now); startOfWeek.setDate(now.getDate() - diffToMon);
      const sow = startOfWeek.toISOString().slice(0,10);
      const som = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0,10);

      let t=0,w=0,m=0;
      for(const x of historyCache){
        const d = (x.created_at||x.date||'').slice(0,10);
        if(d===today) t++;
        if(d>=sow) w++;
        if(d>=som) m++;
      }
      kpiToday.textContent = t;
      kpiWeek.textContent = w;
      kpiMonth.textContent = m;
    }

    // ========= Followup Summary (Logic 4 groups + Tabs sticky) =========
    let currentSummaryTab = 1;

    function buildFollowupSummary(){
      const wrap = document.getElementById('summaryBody');
      if(!wrap) return;

      if(!historyCache.length){
        wrap.innerHTML = '<div class="summary-section"><div class="summary-empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£</div></div>';
        return;
      }

      // Group by customer
      const byCustomer = new Map();
      historyCache.forEach(x=>{
        const opd   = pad4(x.opd || '');
        const cust  = customerByOPD.get(opd) || {};
        const name  = (x.customer_name || cust.name || '').trim();
        const phone = x.customer_phone || cust.phone || '';
        const key   = makeCustomerKey(opd, name, phone);
        if(!key) return;

        if(!byCustomer.has(key)){
          byCustomer.set(key, { opd, name: name || opd || '(‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠)', phone, pitches:[] });
        }
        byCustomer.get(key).pitches.push(x);
      });

      const groups = { 1:[], 2:[], 3:[], 4:[] };

      byCustomer.forEach((cust, key)=>{
        const pitches = cust.pitches.slice().sort((a,b)=> (a.created_at||a.date||'').localeCompare(b.created_at||b.date||''));

        // last visit date
        let recs = recordsByKey.get(key) || [];
        if((!recs || !recs.length) && cust.opd){
          const op = cust.opd;
          recs = (window.allCustomerRecords || []).filter(r => pad4(r.opd || '') === op);
        }

        let lastVisitDate = null;
        recs.forEach(r=>{
          const d = String(r.date || '').slice(0,10);
          if(d && (!lastVisitDate || d > lastVisitDate)) lastVisitDate = d;
        });

        // active pitches (after visit if visit exists)
        const activePitches = lastVisitDate
          ? pitches.filter(p=> ((p.created_at || p.date || '').slice(0,10)) > lastVisitDate)
          : pitches;

        if(!activePitches.length) return;

        const lastPitch = activePitches[activePitches.length - 1];
        const lastOutcome = String(lastPitch.outcome || '').trim();
        const lastDate = (lastPitch.created_at || lastPitch.date || '').slice(0,10);
        const count = activePitches.length;

        const interestPitch = activePitches.find(p => isInterested(p.outcome));
        const hasEverBeenInterested = !!interestPitch;
        const isCurrentlyReject = /^‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à/.test(lastOutcome);

        const timelineTexts = activePitches.map(p => p.outcome).filter(Boolean);

        const dataObj = {
          opd: cust.opd, name: cust.name, phone: cust.phone,
          activePitches, lastVisitDate, lastDate, lastOutcome, count, timelineTexts, interestPitch
        };

        if (hasEverBeenInterested) {
          const callsAfterInterest = activePitches.filter(p => (p.created_at||p.date) > (interestPitch.created_at||interestPitch.date)).length;
          if (isCurrentlyReject || callsAfterInterest >= 3) groups[2].push(dataObj);
          else groups[1].push(dataObj);
        } else {
          if (isCurrentlyReject || count >= 3) groups[3].push(dataObj);
          else groups[4].push(dataObj);
        }
      });

      groups[1].sort((a,b) => (b.interestPitch?.date||b.lastDate).localeCompare(a.interestPitch?.date||a.lastDate));
      [2,3,4].forEach(g => groups[g].sort((a,b) => b.lastDate.localeCompare(a.lastDate)));

      const renderTabs = () => `
        <div class="tabs-wrap" role="tablist" aria-label="‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°">
          <button class="tab-btn ${currentSummaryTab===1?'active':''}" data-tab="1" role="tab" aria-selected="${currentSummaryTab===1}">
            <span>üü¢ ‡∏™‡∏ô‡πÉ‡∏à/‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠</span><span class="tab-count">${groups[1].length}</span>
          </button>
          <button class="tab-btn ${currentSummaryTab===2?'active':''}" data-tab="2" role="tab" aria-selected="${currentSummaryTab===2}">
            <span>üü† ‡πÄ‡∏Ñ‡∏¢‡∏™‡∏ô/‡∏´‡∏•‡∏∏‡∏î</span><span class="tab-count">${groups[2].length}</span>
          </button>
          <button class="tab-btn ${currentSummaryTab===3?'active':''}" data-tab="3" role="tab" aria-selected="${currentSummaryTab===3}">
            <span>üî¥ ‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏≤‡∏° (&gt;3)</span><span class="tab-count">${groups[3].length}</span>
          </button>
          <button class="tab-btn ${currentSummaryTab===4?'active':''}" data-tab="4" role="tab" aria-selected="${currentSummaryTab===4}">
            <span>üîµ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 3</span><span class="tab-count">${groups[4].length}</span>
          </button>
        </div>
      `;

      const renderContent = () => {
        const list = groups[currentSummaryTab];
        if(!list || !list.length) {
          return `<div style="padding:30px; text-align:center; color:#9ca3af;">
            <div style="font-size:40px; margin-bottom:10px;">üì≠</div>
            ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ
          </div>`;
        }

        let thead = '';
        if(currentSummaryTab === 1){
          thead = `<tr><th width="25%">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th width="30%">‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à (Spark)</th><th width="25%">Timeline ‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠</th><th width="20%">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th></tr>`;
        } else if(currentSummaryTab === 2){
          thead = `<tr><th width="25%">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th width="30%">‡πÄ‡∏Ñ‡∏¢‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠</th><th width="45%">‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏∏‡∏î / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏ö</th></tr>`;
        } else if(currentSummaryTab === 3){
          thead = `<tr><th width="30%">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th width="20%">‡∏ß‡∏±‡∏ô‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th><th width="50%">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò)</th></tr>`;
        } else {
          thead = `<tr><th width="30%">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th width="20%">‡πÇ‡∏ó‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</th><th width="50%">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th></tr>`;
        }

        const rows = list.map((r,idx) => {
          const i = idx + 1;
          const custHtml = `<span class="customer-link" data-name="${esc(r.name)}" data-phone="${esc(r.phone)}" data-opd="${esc(r.opd)}">${i}. ${esc(r.name)}</span>`;

          if(currentSummaryTab === 1){
            const intDate = fmtShortDate(r.interestPitch.created_at || r.interestPitch.date);
            const intNote = r.interestPitch.content || r.interestPitch.promotion || '-';
            const after = r.activePitches.filter(p => (p.created_at||p.date) > (r.interestPitch.created_at||r.interestPitch.date));
            const afterText = after.length
              ? after.map(x=>`<div><span style="color:#6b7280;font-size:10px;">${fmtShortDate(x.created_at||x.date)}:</span> ${esc(x.outcome||'')}</div>`).join('')
              : '<span style="color:#d1d5db; font-size:10px;">-‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°-</span>';

            return `<tr>
              <td>${custHtml}</td>
              <td style="background:#f0fdf4;">
                <div style="font-weight:700; color:#166534;">${esc(intDate)}</div>
                <div style="font-size:11px; color:#15803d;">${esc(intNote)}</div>
              </td>
              <td>${afterText}</td>
              <td><span style="font-weight:700; color:#059669;">${esc(r.lastOutcome)}</span></td>
            </tr>`;
          }

          if(currentSummaryTab === 2){
            const intDate = fmtShortDate(r.interestPitch.created_at || r.interestPitch.date);
            return `<tr>
              <td>${custHtml}</td>
              <td style="color:#92400e; background:#fffbeb;">
                <div>üìÖ ${esc(intDate)}</div>
                <div style="font-size:11px;">${esc(r.interestPitch.content||'-')}</div>
              </td>
              <td>
                <div style="color:#b91c1c; font-weight:600;">${esc(r.lastOutcome)}</div>
                <div style="font-size:10px; color:#6b7280;">(‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á‡∏™‡∏ô‡πÉ‡∏à‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${r.activePitches.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div>
              </td>
            </tr>`;
          }

          if(currentSummaryTab === 3){
            return `<tr>
              <td>${custHtml}</td>
              <td>${esc(fmtShortDate(r.lastVisitDate)||'-')}</td>
              <td>
                <div><span style="color:#ef4444;">${esc(r.lastOutcome)}</span></div>
                <div style="font-size:10px; color:#6b7280;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: ${esc(r.timelineTexts.join(' ‚Üí '))} (‡∏£‡∏ß‡∏° ${r.count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div>
              </td>
            </tr>`;
          }

          return `<tr>
            <td>${custHtml}</td>
            <td><strong>${r.count}</strong> / 3</td>
            <td>${esc(r.lastOutcome)}</td>
          </tr>`;
        }).join('');

        return `<div class="table-wrap"><table class="summary-table"><thead>${thead}</thead><tbody>${rows}</tbody></table></div>`;
      };

      wrap.innerHTML = renderTabs() + `<div id="summaryContentArea">${renderContent()}</div>`;

      // Tab switching via delegation (no inline onclick)
      wrap.onclick = (e)=>{
        const btn = e.target.closest('.tab-btn[data-tab]');
        if(!btn) return;
        const id = parseInt(btn.dataset.tab, 10);
        if(!id || id === currentSummaryTab) return;

        currentSummaryTab = id;

        wrap.querySelectorAll('.tab-btn[data-tab]').forEach(b=>{
          const active = parseInt(b.dataset.tab,10) === id;
          b.classList.toggle('active', active);
          b.setAttribute('aria-selected', active ? 'true' : 'false');
        });

        const contentArea = document.getElementById('summaryContentArea');
        if(contentArea) contentArea.innerHTML = renderContent();
      };

      syncAppbarHeight();
    }

    /* ==================== Customer Modal & Records Loader ==================== */
    let _recordsLoaded = false;

    async function loadCustomerRecords(){
      try{
        const res = await fetch('/api/reccord_sale');
        if(!res.ok) throw 0;
        const data = await res.json();
        window.allCustomerRecords = Array.isArray(data) ? data : [];
        _recordsLoaded = true;
        rebuildRecordsIndex();
      }catch(e){
        window.allCustomerRecords = [];
        _recordsLoaded = false;
        showToast('‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ reccord_sale ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
      }
    }

    async function ensureRecordsLoaded(){
      if(_recordsLoaded) return true;
      await loadCustomerRecords();
      return _recordsLoaded;
    }

    function recordAmount(r){
      const n = parseFloat(r.amount || 0);
      return isNaN(n) ? 0 : n;
    }

    (function ensureSubOptionsMap(){
      if (window.subOptionsMap) return;
      window.subOptionsMap = {
        "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ":[
          "Aestox 50 u","Aestox 100 u","Allergan 50 u","Allergan 100 u",
          "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î","‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß","Nabota"
        ],
        "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå":[
          "Neuramis ‡∏™‡∏µ‡∏î‡∏≥","Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á","E.P.T.Q ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢","Restylane ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢"
        ],
        "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß":[
          "Meso Chanel","P - Cell","Aquatic","Hestina","Exosome","Rejuran",
          "Belotero Revive","Sculptra","Juvelook","Aesthefill","Mesowink",
          "AlphaArbutin","PRP","Biocollagen","Transamine"
        ],
        "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß":[
          "Snow White","Super Aurawhite","Vitamin Mix",
          "Brain Booster","Energy Booster"
        ],
        "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå":[
          "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™","‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß","‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤"
        ],
        "Fat/Hifu":[
          "Bromi","Sisi","HIFU","HIFU ‡πÅ‡∏ñ‡∏°"
        ],
        "‡∏≠‡∏∑‡πà‡∏ô‡πÜ":[
          "‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤","‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤","‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤",
          "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤","‡πÑ‡∏´‡∏° PDO","‡πÑ‡∏´‡∏° Collagen",
          "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô/‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
        ],
        "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©":[
          "‡∏™‡∏•‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå","‡πÑ‡∏´‡∏° PDO","‡∏õ‡∏±‡πà‡∏ô RF","‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤","‡∏ú‡∏•‡∏±‡∏Å‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô"
        ]
      };
    })();

    window.formatDate ||= function (d) {
      if (!d) return '-';
      const x = new Date(d); if (isNaN(x)) return d;
      const dd = String(x.getDate()).padStart(2,'0');
      const mm = String(x.getMonth()+1).padStart(2,'0');
      const yy = x.getFullYear();
      return `${dd}/${mm}/${yy}`;
    };

    let lastFocusEl = null;
    function showCustomerModal(){
      const modal = document.getElementById('customer-modal');
      const box = document.getElementById('customer-modal-box');
      if(!modal || !box) return;
      lastFocusEl = document.activeElement;
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
      box.focus();
    }
    function hideCustomerModal(){
      const modal = document.getElementById('customer-modal');
      if(!modal) return;
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
      if(lastFocusEl && typeof lastFocusEl.focus === 'function') lastFocusEl.focus();
    }

    $('#customerModalCloseBtn')?.addEventListener('click', hideCustomerModal);

    // close on backdrop click
    (function(){
      const modal = document.getElementById('customer-modal');
      if(!modal) return;
      modal.addEventListener('click', e=>{
        const panel = modal.querySelector('.panel');
        if(panel && !panel.contains(e.target)) hideCustomerModal();
      });
    })();

    // close on ESC
    document.addEventListener('keydown', e=>{
      if(e.key === 'Escape') hideCustomerModal();
    });

    async function saveModalAsImage(){
      const box = document.getElementById('customer-modal-box');
      if(!box){
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
        return;
      }
      if(typeof html2canvas === 'undefined'){
        alert('‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î html2canvas');
        return;
      }
      const canvas = await html2canvas(box);
      const link = document.createElement('a');
      link.download = `customer_${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }
    $('#customerModalSaveBtn')?.addEventListener('click', saveModalAsImage);




    
    // Click customer link opens modal
    document.addEventListener('click', async function(e){
      const el = e.target.closest('.customer-link');
      if(!el) return;

      const name  = el.getAttribute('data-name')  || el.textContent.trim();
      const phone = el.getAttribute('data-phone') || '';
      const opd   = el.getAttribute('data-opd')   || '';

      if(!(await ensureRecordsLoaded())) return;

      const key = makeCustomerKey(opd, name, phone);
      openCustomerModal(key);
    });

    async function openCustomerModal(key){
      let records = (typeof recordsByKey !== 'undefined' && recordsByKey.get(key)) || [];

      if (!records || !records.length){
        const all = window.allCustomerRecords || [];
        if (/^\d{4}$/.test(key)){
          records = all.filter(r => pad4(r.opd || '') === key);
        }else if (key.startsWith('phone:')){
          const phone = key.slice(6);
          records = all.filter(r => String(r.phone || '') === phone);
        }else{
          const nm = String(key || '').trim();
          records = all.filter(r => String(r.name || '').trim() === nm);
        }
      }

      const modal = document.getElementById('modal-content');
      if(!records || !records.length){
        modal.innerHTML = `
          <h3 id="customer-modal-title" style="font-size:16px; margin-bottom:4px;">üìá ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3>
          <div style="font-size:12px;color:#64748b;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ</div>`;
        showCustomerModal();
        return;
      }

      records.sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')));

      const first = records[0];
      const customer = {
        name: first.name,
        phone: first.phone || '-',
        opd: pad4(first.opd || '-')
      };

      const latestRecord = records[0];
      const lastDateStr = (latestRecord.date || '').slice(0,10);
      const lastDate = new Date(lastDateStr);
      const today = new Date();
      const daysAbsent = isNaN(lastDate) ? 0 : Math.floor((today - lastDate) / (1000*60*60*24));

      const paidRecords = records.filter(r => recordAmount(r) > 0);
      const paidVisits = paidRecords.length;
      const totalAmount = paidRecords.reduce((s,r)=> s + recordAmount(r), 0);
      const average = paidVisits > 0 ? Math.round(totalAmount/paidVisits) : 0;

      // item summary
      const allItems = {};
      records.forEach(r=>{
        (r.items || []).forEach(item=>{
          let name = item;
          const m = item.match(/\((.*?)\)/);
          if (m) name = m[1];
          else name = item.split(' - ')[0];

          const qtyMatch = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
          const qty = qtyMatch ? parseInt(qtyMatch[1],10) : 1;
          allItems[name] = (allItems[name] || 0) + qty;
        });
      });

      const categorizedItems = {};
      const map = window.subOptionsMap || {};
      for(const [cat, names] of Object.entries(map)){
        names.forEach(n=>{
          if(allItems[n]){
            (categorizedItems[cat] ??= []).push(`${esc(n)} : ${allItems[n]}`);
            delete allItems[n];
          }
        });
      }
      if(Object.keys(allItems).length){
        (categorizedItems['‡∏≠‡∏∑‡πà‡∏ô‡πÜ'] ??= []).push(
          ...Object.entries(allItems).map(([n,q])=>`${esc(n)} : ${q}`)
        );
      }

      const itemSummary = Object.entries(categorizedItems)
        .map(([cat, items])=> `<div style="margin-bottom:4px;"><strong>${esc(cat)}</strong>: ${items.join(' | ')}</div>`)
        .join('');

      const historyHtml = records.map(r=>{
        const itemsHtml = (r.items||[]).map(item=>{
          let name = item;
          const m = item.match(/\((.*?)\)/);
          if (m) name = m[1];
          else name = item.split(' - ')[0];

          const qtyMatch=item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
          const qty = qtyMatch ? parseInt(qtyMatch[1],10) : 1;
          return `<li>${esc(name)} : ${qty}</li>`;
        }).join('');

        const noteText = r.note
          ? `<div style="font-size:11px; margin-top:2px; font-style:italic; color:#444;">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${esc(r.note)}</div>`
          : '';

        return `
          <div style="margin-bottom:14px;">
            <div style="font-weight:600; font-size:12px;">üìÖ ${formatDate((r.date || '').slice(0,10))}</div>
            <ul style="padding-left:16px;margin:0;font-size:11px;">${itemsHtml}</ul>
            <div style="margin-top:4px;color:#0a645a;font-size:11px;">üíµ ${Math.round(recordAmount(r)).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
            ${noteText}
            <hr style="margin:8px auto; border:0; border-top:1px dashed #ddd; width:60%;">
          </div>`;
      }).join('');

      // fetch pitches short
      let pitchSectionHtml = '';
      try{
        const opdClean = (customer.opd || '').replace(/\D/g,'');
        if (opdClean){
          const res = await fetch(`/api/pitches?opd=${encodeURIComponent(opdClean)}`);
          if (res.ok){
            const pitches = await res.json() || [];
            if (pitches.length){
              pitches.sort((a,b)=> String(b.created_at||'').localeCompare(String(a.created_at||'')));
              pitchSectionHtml = pitches.map(p=>{
                const dIso = String(p.created_at || p.date || '').slice(0,10);
                const d = formatDate(dIso);
                return `<div style="padding:2px 0; font-size:11px; color:#374151;">
                  ${esc(d)} ‚Äî ${esc(p.promotion || '-')} ‚Äî ${esc(p.outcome || '-')}
                </div>`;
              }).join('');
            } else {
              pitchSectionHtml = `<div style="font-size:11px;color:#888;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sale Pitch</div>`;
            }
          } else {
            pitchSectionHtml = `<div style="font-size:11px;color:#888;">‡πÇ‡∏´‡∏•‡∏î Sale Pitch ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`;
          }
        } else {
          pitchSectionHtml = `<div style="font-size:11px;color:#888;">‡πÑ‡∏°‡πà‡∏°‡∏µ OPD ‡∏à‡∏∂‡∏á‡∏î‡∏∂‡∏á Sale Pitch ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>`;
        }
      }catch(e){
        console.error(e);
        pitchSectionHtml = `<div style="font-size:11px;color:#888;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Sale Pitch</div>`;
      }

      const daysAbsentText = `<span style="color:red;">(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß: ${daysAbsent} ‡∏ß‡∏±‡∏ô)</span>`;

      modal.innerHTML = `
        <h3 id="customer-modal-title" style="font-size:16px; margin-bottom:4px;">üìá ${esc(customer.name)}</h3>
        <div style="font-size:12px;">üÜî OPD: ${esc(customer.opd)}</div>
        <div style="font-size:12px;">üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${esc(customer.phone)}</div>
        <div style="font-size:12px;">üìÖ ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${formatDate(lastDateStr)} ${daysAbsentText}</div>
        <div style="font-size:12px; color:#00796b;">üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${Math.round(totalAmount).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
        <div style="font-size:12px;">üîÅ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ${records.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${paidVisits} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô)</div>
        <div style="font-size:12px;">üí≥ ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ${average.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>

        <hr style="margin:14px 0; border:0; border-top:1px solid #ccc;">

        <div style="font-weight:600; font-size:13px; margin-bottom:6px;">üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</div>
        <div style="font-size:11px;">${itemSummary || '-'}</div>

        <hr style="margin:14px 0; border:0; border-top:1px solid #ccc;">

        <div style="font-weight:600; font-size:13px; margin-bottom:4px;">üó£Ô∏è Sale Pitch (‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô):</div>
        ${pitchSectionHtml}

        <hr style="margin:14px 0; border:0; border-top:1px solid #ccc;">

        <div style="font-weight:600; font-size:13px; margin-bottom:6px;">üõçÔ∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á:</div>
        ${historyHtml}

        <div style="margin-top:10px;font-weight:bold;color:#b8860b;">üí∞ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${Math.round(totalAmount).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
      `;

      showCustomerModal();
    }
    /* ==================== End Customer Modal & Records Loader ==================== */
  </script>

{% endblock %}
{% include "floating_menu.html" %}
</body>
</html>
