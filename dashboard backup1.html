<!DOCTYPE html>
<html lang="th">
<head>
  
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta charset="UTF-8" />
  
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
  body {
    font-family: 'Prompt', 'Segoe UI', sans-serif;
    margin: 0;
    background-color: white;
    padding: 10px;
    padding-bottom: 120px;
    font-size: 14px;
  }

  .menu-bar {
    display: flex;
    justify-content: space-around;
    background-color: white;
    padding: 10px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }

  .menu-bar a {
    text-decoration: none;
    font-weight: bold;
    color: teal;
  }

  .month-nav {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
  }

  .month-nav button {
    background-color: #009688;
    color: white;
    border: none;
    padding: 8px 16px;
    font-size: 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .month-nav button:hover {
    background-color: #00796b;
  }

  #mainTitle {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background-color: #e0f2f1;
    border-radius: 16px;
    padding: 20px 30px;
    margin: 0 auto 30px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    max-width: fit-content;
    text-align: center;
  }

  #mainTitle .month {
    font-size: 26px;
    font-weight: 600;
    color: #004d40;
  }

  #mainTitle .total {
    font-size: 18px;
    color: #009688;
    margin-top: 6px;
  }

  .top10-box {
    max-width: 1200px;
    margin: 0 auto 20px;
    background: #fff;
    padding: 15px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
  }

  .top10-box h3 {
    margin-top: 0;
    color: teal;
    font-size: 18px;
    text-align: center;
  }

  .top10-box ul {
    list-style: none;
    padding-left: 0;
  }

  .top10-box li {
    margin-bottom: 6px;
    padding: 4px 0;
    border-bottom: 1px dashed #ddd;
  }

  .top10-box li span.name {
    font-weight: 600;
    color: #333;
  }

  .top10-box li span.date {
    font-size: 13px;
    color: #999;
    margin-left: 6px;
  }

  .top10-box li span.amount {
    float: right;
    color: #009688;
    font-weight: 600;
  }

  @media (max-width: 768px) {
  .top10-box li span.date {
    font-size: 8px !important;
  }
}

  .chart-summary-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
    max-width: 1200px;
    margin: 0 auto 20px;
    flex-wrap: wrap;
  }

  .chart-container {
    flex: 1;
    background: #fff;
    padding: 15px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
  }

  canvas {
    width: 100% !important;
    height: 300px !important;
  }

  .summary-list {
    flex: 1;
    background: #fff;
    padding: 15px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    font-size: 14px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
  }

 .summary-group ul {
  list-style: none;
  padding-left: 0px;
  margin: 5px 0 10px;
}

  .summary-group li {
    margin-bottom: 4px;
  }

  .summary-group strong {
    color: #00796b;
    display: block;
    margin-bottom: 6px;
    font-size: 15px;
  }

  .floating-dock {
    position: fixed;
    bottom: env(safe-area-inset-bottom, 16px);
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border-radius: 16px;
    padding: 6px 6px env(safe-area-inset-bottom, 16px);
    display: flex;
    gap: 6px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    z-index: 1000;
    max-width: 95vw;
  }

  .icon-button {
    width: 64px;
    height: 64px;
    padding: 4px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease;
    text-decoration: none;
    flex: 0 0 auto;
  }

  .icon-button img {
    width: 60px;
    height: 60px;
    object-fit: contain;
  }

  .icon-button:hover {
    transform: scale(1.1);
  }

  .inline-field {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
  flex-wrap: wrap;
  max-width: 600px;
}

.inline-field label {
  min-width: 160px;
  font-weight: bold;
  font-size: 14px;
  color: #333;
}

.inline-field .input-pair {
  display: flex;
  gap: 6px;
  align-items: center;
}

.inline-field input,
.inline-field select {
  padding: 6px 8px;
  font-size: 13px;
  width: 120px;
  border: 1px solid #ccc;
  border-radius: 6px;
  max-width: 100%;
}

button[type="button"] {
  background-color: teal;
  color: white;
  border: none;
  padding: 6px 16px;
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
  margin-top: 10px;
}

/* Responsive */
@media (max-width: 768px) {
  .inline-field {
    flex-direction: column;
    align-items: flex-start;
    max-width: 100%;
  }

  .inline-field label {
    min-width: unset;
  }

  .inline-field input,
  .inline-field select {
    width: auto;
    min-width: 100px;
    max-width: 100%;
  }

  .inline-field .input-pair {
    flex-direction: row;
    width: 100%;
  }
}


  .add-product-button {
    background-color: #e0f7fa;
    color: #00796b;
    border: 1px solid #00bfa5;
    padding: 6px 14px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .add-product-button:hover {
    background-color: #b2dfdb;
    color: #004d40;
    transform: scale(1.03);
  }

  .floating-toggle {
    position: fixed;
    bottom: env(safe-area-inset-bottom, 18px);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 128, 128, 0);
    width: 58px;
    height: 58px;
    border-radius: 50%;
    box-shadow: 0 4px 16px rgba(251, 251, 251, 0);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    cursor: pointer;
  }

  .floating-menu {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border-radius: 16px;
    padding: 10px;
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    z-index: 999;
    max-height: 60vh;
    overflow-y: auto;
  }

  .floating-menu a img {
    width: 52px;
    height: 52px;
  }

  /* ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≠ <= 768px */
  @media (max-width: 768px) {
    body {
      font-size: 10px;
    }

    #mainTitle .month {
      font-size: 14px;
    }

    #mainTitle .total,
    #mainTitle .compare {
      font-size: 10px;
    }

    .summary-list {
      font-size: 10px;
      grid-template-columns: repeat(4, 1fr); /* ‚úÖ ‡πÑ‡∏î‡πâ 3 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
    }

    .summary-group strong {
      font-size: 10px;
    }

    .top10-box h3 {
      font-size: 12px;
    }

    .top10-box li span.name,
    .top10-box li span.date,
    .top10-box li span.amount {
      font-size: 10px;
    }

    .inline-field label,
    .inline-field input,
    .inline-field select {
      font-size: 10px;
    }

    .add-product-button {
      font-size: 10px;
      padding: 4px 8px;
    }

    #customer-modal > div {
      font-size: 10px !important;
    }

    .icon-button {
      width: 48px;
      height: 48px;
    }

    .icon-button img {
      width: 48px;
      height: 48px;
    }

    .chart-summary-row {
      flex-direction: column;
    }
  }

  @media (max-width: 1024px) {
    .floating-dock {
      bottom: 0;
      padding-bottom: env(safe-area-inset-bottom);
    }
  }

#mainTitle .compare {
  font-size: 13px;
}

@media (max-width: 768px) {
  #mainTitle .compare {
    font-size: 10px;
  }
}


.filter-section {
  max-width: 650px;
  margin: auto;
  padding: 20px;
  background: #fefefe;
  border: 1px solid #ddd;
  border-radius: 12px;
  font-size: 14px;
}

h3 {
  margin-top: 0;
  color: #00695c;
  margin-bottom: 20px;
  font-size: 16px;
}

.product-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}

.add-product-button {
  background-color: #e0f7fa;
  color: #00796b;
  border: 1px solid #00bfa5;
  padding: 6px 12px;
  font-size: 13px;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
}

.add-product-button:hover {
  background-color: #b2dfdb;
  color: #004d40;
}

.inline-field {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 12px;
}

.inline-field label {
  min-width: 180px;
  font-weight: bold;
  font-size: 14px;
  color: #333;
}

.input-pair {
  display: flex;
  gap: 6px;
  align-items: center;
}

.input-pair input {
  padding: 6px 8px;
  font-size: 13px;
  width: 120px;
  max-width: 100%;
  border: 1px solid #ccc;
  border-radius: 6px;
}

.product-list-container {
  margin-bottom: 16px;
}

.search-button {
  background-color: teal;
  color: white;
  border: none;
  padding: 8px 20px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  margin-top: 12px;
}

.search-button:hover {
  background-color: #00796b;
}

@media (max-width: 768px) {
  .inline-field {
    flex-direction: column;
    align-items: flex-start;
  }

  .inline-field label {
    min-width: unset;
  }

  .input-pair {
    width: 100%;
  }

  .input-pair input {
    width: 100%;
  }

  .product-row {
    flex-direction: column;
    align-items: flex-start;
  }
}

@media (max-width: 768px) {
  body {
    font-size: 10px;
  }

  .filter-section,
  .inline-field label,
  .inline-field input,
  .inline-field select,
  .add-product-button,
  .search-button,
  .input-pair input {
    font-size: 10px !important;
  }

  h3 {
    font-size: 11px !important;
  }
}


@media (max-width: 768px) {
  #filterResults,
  #filterResults div,
  #filterResults strong,
  #filterResults span {
    font-size: 10px !important;
  }
}

.inline-field input[type="text"] {
  padding: 6px 8px;
  font-size: 13px;
  width: 240px;
  max-width: 100%;
  border: 1px solid #ccc;
  border-radius: 6px;
}

@media (max-width: 768px) {
  .inline-field input[type="text"] {
    font-size: 10px !important;
  }
}


@media (max-width: 480px) {
  #customer-modal > div {
    max-width: 94vw !important;
    padding: 12px !important;
  }
}

.group-header {
  font-size: 18px;
  color: #004d40;
  font-weight: bold;
  margin-bottom: 20px;
  text-align: center;
  background: #e0f2f1;
  padding: 10px 16px;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.customer-entry {
  padding: 12px 16px;
  background: #f9f9f9;
  border-radius: 10px;
  margin-bottom: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.customer-name {
  font-size: 15px;
  color: #00695c;
  margin-bottom: 6px;
}

.date-info {
  font-size: 13px;
  color: #444;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.date-box {
  background: #e0f7fa;
  color: #004d40;
  padding: 4px 8px;
  border-radius: 8px;
  font-size: 13px;
  white-space: nowrap;
  border: 1px solid #b2dfdb;
}
.group-header {
  font-size: 18px;
  color: #004d40;
  font-weight: bold;
  margin-bottom: 20px;
  text-align: center;
  background: #e0f2f1;
  padding: 10px 16px;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

#customer-modal-box {
  width: auto;
  max-width: 90vw;
  max-height: 90vh;
  font-size: 13.5px;
  padding: 16px;
  border-radius: 16px;
  overflow: auto;
  background: white;
  box-sizing: border-box;
}

#customer-modal {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 16px;
}

</style>





  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>


<!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ó‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ -->
<div id="group-modal" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
  
  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ -->
  <div id="group-modal-content" style="background:#fff; padding:20px; border-radius:10px; max-height:80vh; overflow:auto; width:90%; max-width:500px;">
    <div id="groupSelectedList"></div>
    <div style="text-align:right; margin-top:20px;">
      <button onclick="closeGroupModal()" style="padding:6px 12px;">‚ùå ‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>


  <div id="customer-modal" style="display:none;position:fixed;inset:0;background-color:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;">
  <div id="customer-modal-box" style="background:white;padding:16px;border-radius:16px;width:auto;max-width:90vw;box-sizing:border-box;margin:auto;max-height:90vh;overflow:auto;position:relative; font-size:13.5px;">


    <button onclick="closeCustomerModal()" style="position:absolute;top:10px;right:14px;font-size:20px;border:none;background:none;cursor:pointer;">&times;</button>
    <div id="modal-content"></div>
  </div>
</div>

  <div class="month-nav">
    <button onclick="changeMonth(-1)">‚Üê ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
    <button onclick="changeMonth(1)">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
  </div>

  <div id="mainTitle">
    <div class="month"></div>
    <div class="total"></div>
    <div class="compare" style="margin-top: 6px;"></div>
  </div>

  <div class="top10-box">
    <h3>Top 10 ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
    <ul id="top10List"></ul>
    <p id="totalCustomer" onclick="toggleCustomerList()" style="text-align:center; margin-top: 10px; font-weight: bold; color: teal; cursor: pointer;"></p>
<ul id="allCustomerList" style="display:none; padding-top: 10px;"></ul>

  </div>

  <div class="chart-summary-row">
        <div class="summary-list" id="summaryList"></div>
  </div>

<!-- ‚úÖ Modal ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° -->
<div id="group-modal" style="display:none;position:fixed;inset:0;background-color:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;">
  <div id="group-modal-content" style="background:white;padding:20px;border-radius:16px;width:95%;max-width:700px;max-height:90vh;overflow:auto;position:relative; font-size:13px;">
    <div style="position:absolute; top:10px; right:10px; display:flex; gap:10px;">
      <button onclick="saveGroupModalAsImage()" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" style="background:white; border:none; border-radius:50%; width:36px; height:36px; box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer; display:flex; align-items:center; justify-content:center;">üíæ</button>
      <button onclick="closeGroupModal()" title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á" style="background:white; border:none; border-radius:50%; width:36px; height:36px; box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer; display:flex; align-items:center; justify-content:center;">‚ùå</button>
    </div>
    <div style="margin-top: 20px;" id="groupSelectedList"></div>
  </div>
</div>

  <script>
    const categoryMap = {
  "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": [  "Aestox 50 u",  "Aestox 100 u",  "Allergan 50 u",  "Allergan 100 u",  "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î",  "‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß" ],
  "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥", "Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á", "E.P.T.Q ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢", "Restylane ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢"  ],
  "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": ["Meso Chanel","P - Cell","Aquatic","Hestina","Exosome","Rejuran","Belotero Revive","Sculptra","Juvelook","Aesthefill","Mesowink","AlphaArbutin","PRP"],
  "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster"  ],
  "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": [    "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤"  ],
  "Fat/Hifu": [    "Bromi", "Sisi", "HIFU", "HIFU ‡πÅ‡∏ñ‡∏°"  ],
  "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": [    "‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤", "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤", "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÑ‡∏´‡∏° PDO", "‡πÑ‡∏´‡∏° Collagen", "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô/‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"  ],
  "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©": [    "‡∏™‡∏•‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå", "‡πÑ‡∏´‡∏° PDO", "‡∏õ‡∏±‡πà‡∏ô RF", "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡∏ú‡∏•‡∏±‡∏Å‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô"  ]
};

let viewingDate = new Date(); // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Global ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  let allSalesRecords = [];
let fullCustomerList = [];
let allCustomerRecords = [];


  function changeMonth(delta) {
    viewingDate.setMonth(viewingDate.getMonth() + delta);
    fetchDataAndUpdate();
     refreshCustomerList();
  }

  function fetchAllCustomerRecords() {
  return fetch("/api/sales")
    .then(res => res.json())
    .then(records => {
      allCustomerRecords = records;
    })
    .catch(err => {
      console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
    });
}

  function fetchDataAndUpdate() {
  // ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  if (allSalesRecords.length > 0 && allCustomerRecords.length > 0) {
    updateDashboard(allSalesRecords);
  } else {
    Promise.all([
      fetch("/api/sales").then(res => res.json()), // allSalesRecords
      fetchAllCustomerRecords()
    ]).then(([salesRecords]) => {
      allSalesRecords = salesRecords;
      updateDashboard(allSalesRecords);
    }).catch(err => {
      console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    });
  }
}

  function updateDashboard(records) {
    const monthName = viewingDate.toLocaleString('th-TH', { month: 'long' });
    const yearBE = viewingDate.getFullYear() + 543;
    const prefix = viewingDate.toISOString().slice(0, 7);

    document.querySelector('#mainTitle .month').textContent = `${monthName} ${yearBE}`;

    let totalSales = 0;
    let lastMonthSales = 0;
    let toDateSales = 0;
    let toDateLastMonthSales = 0;


// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô reference)
const today = new Date();
const todayRealDate = today.getDate();

// ‡πÄ‡∏≠‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π
const viewingDay = Math.min(todayRealDate, daysInMonth(viewingDate.getFullYear(), viewingDate.getMonth() + 1));
const todayDate = viewingDay;




const currentPrefix = viewingDate.toISOString().slice(0, 7);
const lastMonthDate = new Date(viewingDate);
lastMonthDate.setMonth(viewingDate.getMonth() - 1);
const lastPrefix = lastMonthDate.toISOString().slice(0, 7);
    const categoryCounts = {};
    const categoryDetails = {};
    const customerMap = {};

    // ‚úÖ ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
records.forEach(r => {
  const amount = parseFloat(r.amount || 0);
  if (r.date.startsWith(currentPrefix)) {
  totalSales += amount;

  const recDay = parseInt(r.date.split("-")[2]);
  if (recDay <= todayDate) {
    toDateSales += amount;
  }
}

if (r.date.startsWith(lastPrefix)) {
  lastMonthSales += amount;

  const recDay = parseInt(r.date.split("-")[2]);
  if (recDay <= todayDate) {
    toDateLastMonthSales += amount;
  }
}
  
});

// ‚úÖ ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 2: ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
records
  .filter(r => r.date.startsWith(prefix))
  .forEach(r => {
    const key = `${r.name}|${r.phone}`;
    if (!customerMap[key]) {
      customerMap[key] = {
  name: r.name,
  phone: r.phone,
  opd: r.opd || '-',      // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
  date: r.date,
  amount: 0
};
    }
    customerMap[key].amount += parseFloat(r.amount || 0);
    customerMap[key].date = r.date > customerMap[key].date ? r.date : customerMap[key].date;

    (r.items || []).forEach(item => {
      const match = item.match(/\((.*?)\)/);
      const subItem = match ? match[1] : item;
      const qtyMatch = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+)/);
      const qty = qtyMatch ? parseInt(qtyMatch[1]) : 0;
      const price = qtyMatch ? parseInt(qtyMatch[2]) : 0;
      const total = qty * price;

      const categoryMatch = item.match(/^(.+?) ?\(/);
      const category = categoryMatch ? categoryMatch[1].trim() : "‡∏≠‡∏∑‡πà‡∏ô‡πÜ";

      if (!categoryCounts[category]) categoryCounts[category] = 0;
      if (!categoryDetails[category]) categoryDetails[category] = {};

      categoryCounts[category] += qty;
      categoryDetails[category][subItem] = categoryDetails[category][subItem] || { qty: 0, total: 0 };
      categoryDetails[category][subItem].qty += qty;
      categoryDetails[category][subItem].total += total;
    });
  });


    document.querySelector('#mainTitle .total').innerHTML = `üí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° ${totalSales.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;



const compareEl = document.querySelector('#mainTitle .compare');

let diff = totalSales - lastMonthSales;
let text = diff > 0
  ? `<span style="color: green;">+${diff.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`
  : diff < 0
    ? `<span style="color: red;">-${Math.abs(diff).toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`
    : `<span style="color: gray;">‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`;

diff = toDateSales - toDateLastMonthSales;
let text2 = diff > 0
  ? `<span style="color: green;">üìÜ ‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ${todayDate} ‡∏ß‡∏±‡∏ô : +${diff.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`
  : diff < 0
    ? `<span style="color: red;">üìÜ ‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ${todayDate} ‡∏ß‡∏±‡∏ô: -${Math.abs(diff).toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`
    : `<span style="color: gray;">üìÜ ‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ${todayDate} ‡∏ß‡∏±‡∏ô: ‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`;

compareEl.innerHTML = `${text}<br>${text2}`;

const allDates = records.map(r => r.date).filter(Boolean);
const latestDate = allDates.sort().reverse()[0];

if (latestDate) {
  const todayDay = today.getDate();
  const viewingDay = Math.min(today.getDate(), daysInMonth(viewingDate.getFullYear(), viewingDate.getMonth() + 1));
const targetRangeEnd = viewingDay;

  const groupByMonth = {};

  records.forEach(r => {
    if (!r.date) return;
    const [y, m, d] = r.date.split("-");
    const ym = `${y}-${m}`;
    const day = parseInt(d);
    if (day <= targetRangeEnd) {
      if (!groupByMonth[ym]) groupByMonth[ym] = 0;
      groupByMonth[ym] += parseFloat(r.amount || 0);
    }
  });

 // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô 300,000
const VALID_MONTH_THRESHOLD = 400000;

// ‚úÖ ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏≠‡∏î >= 300,000 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
const allMonths = Object.keys(groupByMonth)
  .filter(m => m !== currentPrefix && groupByMonth[m] >= VALID_MONTH_THRESHOLD);

// ‚úÖ ‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏≤‡∏Ñ‡∏¥‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
const totalPastMonths = allMonths.reduce((sum, m) => sum + groupByMonth[m], 0);
const averagePastMonths = Math.round(totalPastMonths / (allMonths.length || 1));


  const currentMonth14Total = groupByMonth[currentPrefix] || 0;

  const diffFromAvg = currentMonth14Total - averagePastMonths;
const formattedDiff = diffFromAvg.toLocaleString();

const compareAvgDiv = document.createElement('div');
compareAvgDiv.style.marginTop = '4px';
compareAvgDiv.style.color = diffFromAvg > 0 ? 'green' : diffFromAvg < 0 ? 'crimson' : 'gray';

compareAvgDiv.innerHTML = `üìä ‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ${targetRangeEnd} ‡∏ß‡∏±‡∏ô ‡∏Ñ‡∏∑‡∏≠: ${currentMonth14Total.toLocaleString()} ‡∏ö‡∏≤‡∏ó ${
  diffFromAvg > 0
    ? `‚úÖ ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ +${formattedDiff} ‡∏ö‡∏≤‡∏ó (${averagePastMonths.toLocaleString()})`
    : diffFromAvg < 0
      ? `‚ö†Ô∏è ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${formattedDiff} ‡∏ö‡∏≤‡∏ó (${averagePastMonths.toLocaleString()})`
      : `üòê ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (${formattedDiff} ‡∏ö‡∏≤‡∏ó)`
}`;
compareEl.appendChild(compareAvgDiv);
}





    const sortedEntries = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1]);
    const labels = sortedEntries.map(([cat]) => cat);
    const data = sortedEntries.map(([, qty]) => qty);

    

    document.getElementById('summaryList').innerHTML = sortedEntries.map(([cat]) => {
  const items = Object.entries(categoryDetails[cat] || {})
    .map(([sub, d]) => `‚Ä¢ ${sub} ${d.qty}`).join('<br>');
  const sumQty = categoryCounts[cat];
  return `
    <div class="summary-group" style="cursor:pointer;" onclick="openGroupModalByCategory('${cat}')">
      <strong>${cat}</strong> ‡∏£‡∏ß‡∏° ${sumQty} ‡∏ä‡∏¥‡πâ‡∏ô
      <ul>${items}</ul>
    </div>
  `;
}).join('');

    fullCustomerList = Object.values(customerMap).sort((a, b) => b.amount - a.amount);

    const sortedCustomers = Object.values(customerMap)
      .sort((a, b) => b.amount - a.amount)
      .slice(0, 10);

    document.getElementById('top10List').innerHTML = sortedCustomers.map((c) => {
  const key = `${c.name}|${c.phone}`;
  const allRecords = allCustomerRecords.filter(r => `${r.name}|${r.phone}` === key);

  const totalVisits = allRecords.length;
const paidRecords = allRecords.filter(r => parseFloat(r.amount || 0) > 0);
const paidVisits = paidRecords.length;
const totalAmount = paidRecords.reduce((sum, r) => sum + parseFloat(r.amount), 0);
const avg = paidVisits > 0 ? Math.round(totalAmount / paidVisits) : 0;


  const latest = allRecords.length > 0
    ? new Date(Math.max(...allRecords.map(r => new Date(r.date))))
    : null;

  const daysSinceLastVisit = latest
    ? Math.floor((new Date() - latest) / (1000 * 60 * 60 * 24))
    : null;

  // üîö ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô
  let absentColor = 'gray';
  if (daysSinceLastVisit < 30) absentColor = 'green';
  else if (daysSinceLastVisit <= 90) absentColor = 'orange';
  else absentColor = 'crimson';

  // üí∞ ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
 let totalColor = 'gray';
let totalExtra = '';
let totalIcon = '';

if (totalAmount < 50000) {
  totalColor = 'crimson';
} else if (totalAmount <= 99999) {
  totalColor = 'green';
} else if (totalAmount <= 200000) {
  totalColor = 'goldenrod';
} else {
  totalColor = '#8B6508'; // ‡∏ó‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏°‡∏≤‡∏Å
  totalExtra = 'font-weight:bold;';
  totalIcon = ' üíé';
}

  // üí≥ ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
  let avgColor = 'gray';
  if (avg < 5000) avgColor = 'crimson';
  else if (avg <= 9999) avgColor = 'green';
  else avgColor = '#b8860b'; // ‡∏ó‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏°

  // üîÅ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏°‡∏≤ X ‡∏ß‡∏±‡∏ô"
  const totalVisitsText = `<span>‡∏°‡∏≤ ${totalVisits} ‡∏ß‡∏±‡∏ô</span>`;

  // üîö ‡πÑ‡∏°‡πà‡∏°‡∏≤ ... ‡∏ß‡∏±‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏µ
  const lastVisitText = daysSinceLastVisit != null
    ? `<span style="color:${absentColor};">üîö ‡πÑ‡∏°‡πà‡∏°‡∏≤ ${daysSinceLastVisit} ‡∏ß‡∏±‡∏ô</span>`
    : `<span>üîö ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>`;

  // üìÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  const formatted = new Date(c.date).toLocaleDateString('th-TH', {
    day: 'numeric', month: 'numeric'
  });

  const previousRecords = allRecords.filter(r => r.date < `${viewingDate.toISOString().slice(0, 7)}-01`);
  const isNewCustomer = previousRecords.length === 0;
  const newBadge = isNewCustomer ? `<span style="color:red; font-weight:bold;"> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</span>` : "";

  return `
    <li style="margin-bottom: 8px;">
      <span class="name" style="cursor:pointer;" onclick="openCustomerModal('${key}')">
        ${c.name}${newBadge}
      </span>
      <span class="date">
        (${formatted} |
        ${totalVisitsText} |
        üí≥ <span style="color:${avgColor};">${avg.toLocaleString()}</span> |
        üí∞ <span style="color:${totalColor}; ${totalExtra}">${totalAmount.toLocaleString()}${totalIcon}</span> |

        ${lastVisitText})
      </span>
      <span class="amount">${c.amount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
    </li>
  `;
}).join('');




    document.getElementById('totalCustomer').textContent = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${Object.keys(customerMap).length} ‡∏Ñ‡∏ô (‡∏Å‡∏î‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)`;
  }

  fetchDataAndUpdate();
fetchAllCustomerRecords();


function openGroupModalByCategory(cat) {
  const prefix = viewingDate.toISOString().slice(0, 7);
  const summary = {};
  const totalQty = { count: 0 };

  const catElement = Array.from(document.querySelectorAll(".summary-group"))
    .find(group => group.querySelector("strong")?.textContent === cat);

  const catText = catElement?.innerText || "";

  allSalesRecords
    .filter(r => r.date.startsWith(prefix))
    .forEach(r => {
      (r.items || []).forEach(item => {
        const match = item.match(/\((.*?)\)/);
        const subItem = match ? match[1] : item.split(" - ")[0].trim();

        const qtyMatch = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
        const qty = qtyMatch ? parseInt(qtyMatch[1]) : 1;

        if (!catText.includes(subItem) && !catText.includes(item)) return;

        if (!summary[subItem]) summary[subItem] = {};
        const key = `${r.name}|${r.phone}`;
        if (!summary[subItem][key]) summary[subItem][key] = {
          name: r.name,
          dates: {}
        };
        summary[subItem][key].dates[r.date] = 
          (summary[subItem][key].dates[r.date] || 0) + qty;

        totalQty.count += qty;
      });
    });

  const html = Object.entries(summary).map(([productName, buyers]) => {
    const buyerLines = Object.values(buyers).map(c => {
      const dateParts = Object.entries(c.dates)
        .sort(([a], [b]) => a.localeCompare(b))
        .map(([date, qty]) => {
          const thDate = new Date(date).toLocaleDateString('th-TH', {
            day: 'numeric', month: 'short'
          });
          return `${thDate} = ${qty}`;
        }).join(" | ");
      return `üë§ <strong>${c.name}</strong>: ${dateParts}`;
    }).join("<br>");

    return `<div style="margin-bottom:15px;">
      <div style="font-weight:bold; color:#00796b; margin-bottom:5px;">üîπ ${productName}</div>
      <div>${buyerLines}</div>
    </div>`;
  }).join("");

  document.getElementById("groupSelectedList").innerHTML = `
    <div class="group-header">
      üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î: ${cat}<br>
      ‚úÖ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong style="font-size: 18px; color: #00796b;">${totalQty.count}</strong> ‡∏ä‡∏¥‡πâ‡∏ô
    </div>
    ${html || '<div style="padding:10px; color:#888;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>'}
  `;

  document.getElementById("group-modal").style.display = "flex";
}


function closeGroupModal() {
  document.getElementById("group-modal").style.display = "none";
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener
document.getElementById("group-modal").addEventListener("click", function (e) {
  const content = document.getElementById("group-modal-content");
  if (!content.contains(e.target)) {
    closeGroupModal();
  }
});



function toggleCustomerList() {
  const listEl = document.getElementById("allCustomerList");
  const currentPrefix = viewingDate.toISOString().slice(0, 7);

  if (listEl.style.display === "none") {
    listEl.style.display = "block";

    const customerMap = {};
    allSalesRecords
      .filter(r => r.date.startsWith(currentPrefix))
      .forEach(r => {
        const key = `${r.name}|${r.phone}`;
        if (!customerMap[key]) {
          customerMap[key] = {
            name: r.name,
            phone: r.phone,
            opd: r.opd || "-",
            date: r.date,
            amount: 0
          };
        }
        customerMap[key].amount += parseFloat(r.amount || 0);
        customerMap[key].date = r.date > customerMap[key].date ? r.date : customerMap[key].date;
      });

    const customerList = Object.values(customerMap)
      .sort((a, b) => b.amount - a.amount)
      .slice(10); // ‡∏Ç‡πâ‡∏≤‡∏° Top 10

    listEl.innerHTML = customerList.map((c, i) => {
      const key = `${c.name}|${c.phone}`;
      const allRecords = allCustomerRecords.filter(r => `${r.name}|${r.phone}` === key);

      const totalVisits = allRecords.length;
const paidRecords = allRecords.filter(r => parseFloat(r.amount || 0) > 0);
const paidVisits = paidRecords.length;
const totalAmount = paidRecords.reduce((sum, r) => sum + parseFloat(r.amount), 0);
const avg = paidVisits > 0 ? Math.round(totalAmount / paidVisits) : 0;

      const latest = allRecords.length > 0
        ? new Date(Math.max(...allRecords.map(r => new Date(r.date))))
        : null;

      const daysSinceLastVisit = latest
        ? Math.floor((new Date() - latest) / (1000 * 60 * 60 * 24))
        : null;

      let absentColor = 'gray';
      if (daysSinceLastVisit < 30) absentColor = 'green';
      else if (daysSinceLastVisit <= 90) absentColor = 'orange';
      else absentColor = 'crimson';

      let totalColor = 'gray';
let totalExtra = '';
let totalIcon = '';

if (totalAmount < 50000) {
  totalColor = 'crimson';
} else if (totalAmount <= 99999) {
  totalColor = 'green';
} else if (totalAmount <= 200000) {
  totalColor = 'goldenrod';
} else {
  totalColor = '#8B6508'; // ‡∏ó‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏°‡∏≤‡∏Å
  totalExtra = 'font-weight:bold;';
  totalIcon = ' üíé';
}

      let avgColor = 'gray';
      if (avg < 5000) avgColor = 'crimson';
      else if (avg <= 9999) avgColor = 'green';
      else avgColor = '#b8860b'; // ‡∏ó‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏°

      const totalVisitsText = `<span>‡∏°‡∏≤ ${totalVisits} ‡∏ß‡∏±‡∏ô</span>`;
      const lastVisitText = daysSinceLastVisit != null
        ? `<span style="color:${absentColor};">üîö ‡πÑ‡∏°‡πà‡∏°‡∏≤ ${daysSinceLastVisit} ‡∏ß‡∏±‡∏ô</span>`
        : `<span>üîö ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>`;

      const formattedDate = new Date(c.date).toLocaleDateString('th-TH', {
        day: 'numeric', month: 'numeric'
      });

      const previousRecords = allRecords.filter(r => r.date < `${currentPrefix}-01`);
      const isNewCustomer = previousRecords.length === 0;
      const newBadge = isNewCustomer ? `<span style="color:red; font-weight:bold;"> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</span>` : "";

      return `
        <li style="margin-bottom: 8px;">
          <span class="name" style="cursor:pointer;" onclick="openCustomerModal('${key}')">
            ${i + 11}. ${c.name}${newBadge}
          </span>
          <span class="date">
            (${formattedDate} |
            ${totalVisitsText} |
            üí≥ <span style="color:${avgColor};">${avg.toLocaleString()}</span> |
            üí∞ <span style="color:${totalColor}; ${totalExtra}">${totalAmount.toLocaleString()}${totalIcon}</span> |

            ${lastVisitText})
          </span>
          <span class="amount">${c.amount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
        </li>
      `;
    }).join('');
  } else {
    listEl.style.display = "none";
  }
}



function refreshCustomerList() {
  const listEl = document.getElementById("allCustomerList");
  if (listEl.style.display === "block") {
    listEl.style.display = "none";
    toggleCustomerList();
  }
}




function daysInMonth(year, month) {
  return new Date(year, month, 0).getDate();
}


function closeCustomerModal() {
  document.getElementById("customer-modal").style.display = "none";
}

function formatDate(d) {
  if (!d) return '';
  const [y, m, day] = d.split('-');
  return `${day}/${m}/${y.slice(-2)}`;
}




function openCustomerModal(key) {
  const records = allCustomerRecords.filter(r => `${r.name}|${r.phone}` === key);
  if (records.length === 0) return;

  const first = records[0];
  const customer = {
    name: first.name,
    phone: first.phone || '-',
    opd: first.opd || '-'
  };

  const latestRecord = records.reduce((latest, r) =>
    new Date(r.date) > new Date(latest.date) ? r : latest
  , records[0]);

  const lastDate = new Date(latestRecord.date);
  const today = new Date();
  const daysAbsent = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
  const totalVisits = records.length;
const paidRecords = records.filter(r => parseFloat(r.amount || 0) > 0);
const paidVisits = paidRecords.length;
const totalAmount = paidRecords.reduce((sum, r) => sum + parseFloat(r.amount), 0);
const average = paidVisits > 0 ? Math.round(totalAmount / paidVisits) : 0;

  // ‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏à‡∏≤‡∏Å categoryMap
  const allItems = {};
  records.forEach(r => {
    (r.items || []).forEach(item => {
      let name = item;
      const match = item.match(/\((.*?)\)/);
      if (match) {
        name = match[1];
      } else {
        name = item.split(" - ")[0];
      }
      const qtyMatch = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
      const qty = qtyMatch ? parseInt(qtyMatch[1]) : 1;
      allItems[name] = (allItems[name] || 0) + qty;
    });
  });

  const categorizedItems = {};

  for (const [cat, names] of Object.entries(categoryMap)) {
    names.forEach(n => {
      if (allItems[n]) {
        if (!categorizedItems[cat]) categorizedItems[cat] = [];
        categorizedItems[cat].push(`${n} : ${allItems[n]}`);
        delete allItems[n];
      }
    });
  }

  if (Object.keys(allItems).length) {
    categorizedItems["‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] = Object.entries(allItems).map(([name, qty]) => `${name} : ${qty}`);
  }

  const itemSummary = Object.entries(categorizedItems)
    .map(([cat, items]) => `<div style="margin-bottom:6px;"><strong>${cat}</strong>: ${items.join(" | ")}</div>`)
    .join("");

  const historyHtml = records
  .sort((a, b) => b.date.localeCompare(a.date))
  .map(r => {
    const items = (r.items || []).map(item => {
      let name = item;
      const match = item.match(/\((.*?)\)/);
      if (match) {
        name = match[1];
      } else {
        name = item.split(" - ")[0];
      }
      const qtyMatch = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
      const qty = qtyMatch ? parseInt(qtyMatch[1]) : 1;
      return `<li>${name} : ${qty}</li>`;
    }).join("");

    const noteText = r.note
      ? `<div style="margin-top:2px; font-style:italic; color:#444;">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${r.note}</div>`
      : "";

    return `
      <div style="margin-bottom:16px;">
        <div style="margin-bottom:4px;font-weight:bold;">üìÖ ${formatDate(r.date)}</div>
        <ul style="padding-left:16px;margin:0;">${items}</ul>
        <div style="margin-top:4px;color:#00796b;">üíµ ‡∏¢‡∏≠‡∏î: ${parseFloat(r.amount || 0).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
        ${noteText}
        <hr style="margin: 10px auto; border: 0; border-top: 1px dashed #999; width: 60%;">
      </div>
    `;
  }).join("");

  const daysAbsentText = `<span style="color:red;">(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß: ${daysAbsent} ‡∏ß‡∏±‡∏ô)</span>`;

  document.getElementById("modal-content").innerHTML = `
  <div style="position:absolute; top:10px; right:10px; display:flex; gap:10px;">
    <button onclick="saveModalAsImage()" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" style="background:white; border:none; border-radius:50%; width:36px; height:36px; box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer; display:flex; align-items:center; justify-content:center;">üíæ</button>
    <button onclick="closeCustomerModal()" title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á" style="background:white; border:none; border-radius:50%; width:36px; height:36px; box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer; display:flex; align-items:center; justify-content:center;">‚ùå</button>
  </div>

  <h3 style="font-size:18px;margin-bottom:4px;">üìá ${customer.name}</h3>
  <div>üÜî <strong>OPD:</strong> ${customer.opd}</div>
  <div>üìû <strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå:</strong> ${customer.phone}</div>
  <div>üìÖ <strong>‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${formatDate(latestRecord.date)} ${daysAbsentText}</div>
  <div style="color:#00796b;"><strong>üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</strong> ${totalAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
  <div>üîÅ ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£: ${totalVisits} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${paidVisits} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô)</div>
  <div>üí≥ <strong>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á:</strong> ${Math.round(average).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>

  <hr style="margin: 16px auto 8px; border: 0; border-top: 1px solid #ccc; width: 60%;">

  <div style="font-weight:bold;">üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</div>
  <div style="margin:6px 0 12px;">${itemSummary}</div>

  <hr style="margin: 16px auto 8px; border: 0; border-top: 1px solid #ccc; width: 60%;">

  <div style="font-weight:bold;margin-bottom:6px;">üõçÔ∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á:</div>
  ${historyHtml}

  <div style="margin-top:10px;font-weight:bold;color:#b8860b;">üí∞ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
`;

  document.getElementById("customer-modal").style.display = "flex";
}

function closeCustomerModal() {
  document.getElementById("customer-modal").style.display = "none";
}

function saveModalAsImage() {
  const node = document.getElementById("modal-content");
  if (!node) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô modal");
    return;
  }

  html2canvas(node, { scale: 2 }).then(canvas => {
    const dataUrl = canvas.toDataURL("image/jpeg", 0.95);

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    if (isIOS) {
      // ‚úÖ iPhone/iPad: ‡πÅ‡∏™‡∏î‡∏á preview ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏ü
      const previewArea = document.createElement("div");
      previewArea.style.marginTop = "20px";
      previewArea.innerHTML = `
        <div style="font-weight:bold; margin-bottom:6px;">‡πÅ‡∏ï‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ</div>
        <img src="${dataUrl}" style="width:100%; border:1px solid #ccc; border-radius:12px;">
      `;

      const existing = document.getElementById("modalImagePreview");
      if (existing) existing.remove();
      previewArea.id = "modalImagePreview";

      node.appendChild(previewArea);
    } else {
      // ‚úÖ Android / ‡∏Ñ‡∏≠‡∏°: ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      const link = document.createElement("a");
      link.download = 'customer-info.jpg';
      link.href = dataUrl;
      link.click();
    }
  }).catch(error => {
    console.error("‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", error);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");
  });
}





function closeCustomerModal() {
  document.getElementById("customer-modal").style.display = "none";
}

// ‚úÖ ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏£‡∏≠ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏ú‡∏π‡∏Å event ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢






function calcDaysAbsent(dateStr) {
  const today = new Date();
  const lastDate = new Date(dateStr);
  const diff = today - lastDate;
  return Math.floor(diff / (1000 * 60 * 60 * 24));
}
// ‚úÖ UI ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ + ‡∏õ‡∏£‡∏±‡∏ö UI ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢

const productCategories = {
  "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": ["Aestox 50 u", "Aestox 100 u", "Allergan 50 u", "Allergan 100 u"],
  "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥", "Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á", "E.P.T.Q", "Restylane"],
  "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": ["Meso Chanel", "P - Cell", "Aquatic", "Hestina", "Exosome", "Rejuran", "Belotero Revive", "Sculptra", "Juvelook", "Aesthefill"],
  "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster"],
  "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": ["‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤"],
  "Fat/Hifu": ["Bromi", "Sisi", "HIFU", "HIFU ‡πÅ‡∏ñ‡∏°"],
  "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": ["‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤", "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤", "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÑ‡∏´‡∏° PDO", "‡πÑ‡∏´‡∏° Collagen"]
};

const filterUI = document.createElement("div");
filterUI.style.cssText = "margin: 40px auto 20px; padding: 20px; background: #fefefe; border: 1px solid #e0e0e0; border-radius: 12px; max-width: 1100px; font-size: 13px; line-height: 1.6; font-family: 'Prompt', sans-serif; box-shadow: 0 3px 10px rgba(0,0,0,0.03);";

filterUI.innerHTML = `
  <div class="filter-section">
  <h3>üîç ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>

  <div class="product-row">
    <label>üß¥ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ã‡∏∑‡πâ‡∏≠:</label>
    <button type="button" class="add-product-button" onclick="addProductSelect()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
  </div>
  <div id="productListContainer" class="product-list-container"></div>

  <div class="inline-field">
    <label>üìÖ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</label>
    <div class="input-pair">
      <input type="date" id="startDate">
      <span>-</span>
      <input type="date" id="endDate">
    </div>
  </div>

  <div class="inline-field">
    <label>üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏≤‡∏ó):</label>
    <div class="input-pair">
      <input type="number" id="minTotal" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
      <span>-</span>
      <input type="number" id="maxTotal" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
    </div>
  </div>

  <div class="inline-field">
    <label>üìÑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏°‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å:</label>
    <div class="input-pair">
      <input type="number" id="minVisits" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
      <span>-</span>
      <input type="number" id="maxVisits" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
    </div>
  </div>

  <div class="inline-field">
    <label>‚è≥ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å:</label>
    <div class="input-pair">
      <input type="number" id="minAbsent" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
      <span>-</span>
      <input type="number" id="maxAbsent" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
    </div>
  </div>

  <div class="inline-field">
    <label>üí≥ ‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏• (‡∏ö‡∏≤‡∏ó):</label>
    <div class="input-pair">
      <input type="number" id="minAvg" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
      <span>-</span>
      <input type="number" id="maxAvg" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
    </div>
  </div>

  <div class="inline-field">
  <label>üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</label>
  <input type="text" id="customerName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
</div>


  <button type="button" onclick="filterGeneral()" class="search-button">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
  <button type="button" onclick="resetFilters()" class="add-product-button" style="margin-left: 10px;">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤</button>
  <button type="button" onclick="openGroupModal()" class="add-product-button" style="margin-left: 10px;">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>


</div>


 

<div id="filterResults" style="margin-top: 24px; font-size: 13px;"></div>
`;


document.body.appendChild(filterUI);



function filterGeneral() {
  const nameInput = document.getElementById("customerName").value.trim().toLowerCase();
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  const minTotal = parseFloat(document.getElementById("minTotal").value) || 0;
  const maxTotal = parseFloat(document.getElementById("maxTotal").value) || Infinity;
  const minVisits = parseInt(document.getElementById("minVisits").value) || 0;
  const maxVisits = parseInt(document.getElementById("maxVisits").value) || Infinity;
  const minAbsent = parseInt(document.getElementById("minAbsent").value) || 0;
  const maxAbsent = parseInt(document.getElementById("maxAbsent").value) || Infinity;
  const minAvg = parseFloat(document.getElementById("minAvg").value) || 0;
  const maxAvg = parseFloat(document.getElementById("maxAvg").value) || Infinity;

  const selectedProducts = Array.from(document.querySelectorAll('.productInput'))
    .map(el => el.value)
    .filter(Boolean);

  const grouped = {};
  const today = new Date();

  allCustomerRecords.forEach(r => {
    const key = `${r.name}|${r.phone}`;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(r);
  });

  const results = Object.entries(grouped).map(([key, records]) => {
    const name = records[0].name;
    const phone = records[0].phone || "";

    const totalVisits = records.length;
    const paidRecords = records.filter(r => parseFloat(r.amount || 0) > 0);
    const paidVisits = paidRecords.length;
    const totalAmount = paidRecords.reduce((sum, r) => sum + parseFloat(r.amount), 0);
    const averageBill = paidVisits > 0 ? totalAmount / paidVisits : 0;

    const latestRecord = records.reduce((latest, r) =>
      new Date(r.date) > new Date(latest.date) ? r : latest,
      records[0]
    );

    const absentDays = Math.floor((today - new Date(latestRecord.date)) / (1000 * 60 * 60 * 24));
    const lastVisit = latestRecord.date;

    const allProducts = records.flatMap(r => r.items || []).map(item => {
      const match = item.match(/\((.*?)\)/);
      if (match) return match[1];
      return item.split(" - ")[0].trim();
    });

    return {
      key,
      name,
      totalAmount,
      totalVisits,
      paidVisits,
      averageBill,
      absentDays,
      lastVisit,
      products: allProducts
    };
  }).filter(c => {
    const nameMatch = !nameInput || c.name.toLowerCase().includes(nameInput);
    const totalMatch = c.totalAmount >= minTotal && c.totalAmount <= maxTotal;
    const visitMatch = c.totalVisits >= minVisits && c.totalVisits <= maxVisits;
    const absentMatch = c.absentDays >= minAbsent && c.absentDays <= maxAbsent;
    const avgMatch = c.averageBill >= minAvg && c.averageBill <= maxAvg;
    const dateMatch =
      (!startDate || new Date(c.lastVisit) >= new Date(startDate)) &&
      (!endDate || new Date(c.lastVisit) <= new Date(endDate));
    const productMatch = selectedProducts.length === 0 ||
      selectedProducts.every(p => c.products.some(prod => prod.includes(p)));

    return nameMatch && totalMatch && visitMatch && absentMatch && avgMatch && dateMatch && productMatch;
  }).sort((a, b) => b.totalAmount - a.totalAmount);

  const html = results.map(c => {
    const formattedDate = new Date(c.lastVisit).toLocaleDateString('th-TH', {
      day: 'numeric', month: 'short', year: '2-digit'
    });

    return `<div>
      <input type="checkbox" class="selectCustomerCheckbox" value="${c.key}" style="margin-right:6px; vertical-align: middle;">
      üìá <strong style="cursor:pointer;color:#00796b;" onclick="openCustomerModal('${c.key}')">${c.name}</strong>
      üí∞ ‡∏¢‡∏≠‡∏î: ${c.totalAmount.toLocaleString()} |
      üí≥ ${Math.round(c.averageBill).toLocaleString()} |
      üîÅ ${c.totalVisits} (${c.paidVisits} ‡∏à‡πà‡∏≤‡∏¢) |
      ‚è±Ô∏è ${c.absentDays} ‡∏ß‡∏±‡∏ô |
      ${formattedDate}
    <div style="border-top: 1px dashed #ccc; display: inline-block; width: auto; max-width: 180px; margin: 6px 0;"></div>
`;
  }).join('');

  document.getElementById("filterResults").innerHTML = `<h4>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ${results.length} ‡∏Ñ‡∏ô</h4>` + html;
}






/* ‡∏à‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå*/


function addProductSelect() {
  const container = document.getElementById("productListContainer");
  const wrapper = document.createElement("div");
  wrapper.style.marginBottom = "6px";
  const select = document.createElement("select");
  select.className = "productInput";
  select.style.cssText = "width: 240px; padding: 4px; font-size: 13px;";
  const defaultOption = document.createElement("option");
  defaultOption.textContent = "‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
  defaultOption.value = "";
  defaultOption.selected = true;
  defaultOption.disabled = true;
  defaultOption.selected = true;
  select.appendChild(defaultOption);
  Object.entries(productCategories).forEach(([cat, items]) => {
    const group = document.createElement("optgroup");
    group.label = cat;
    items.forEach(p => {
      const option = document.createElement("option");
      option.value = p;
      option.textContent = p;
      group.appendChild(option);
    });
    select.appendChild(group);
  });
  wrapper.appendChild(select);
  container.appendChild(wrapper);
}

// ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô filterGeneral() ‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ä‡∏∑‡πà‡∏≠


function filterGeneral() {
  const nameInput = document.getElementById("customerName").value.trim().toLowerCase();
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  const minTotal = parseFloat(document.getElementById("minTotal").value) || 0;
  const maxTotal = parseFloat(document.getElementById("maxTotal").value) || Infinity;
  const minVisits = parseInt(document.getElementById("minVisits").value) || 0;
  const maxVisits = parseInt(document.getElementById("maxVisits").value) || Infinity;
  const minAbsent = parseInt(document.getElementById("minAbsent").value) || 0;
  const maxAbsent = parseInt(document.getElementById("maxAbsent").value) || Infinity;
  const minAvg = parseFloat(document.getElementById("minAvg").value) || 0;
  const maxAvg = parseFloat(document.getElementById("maxAvg").value) || Infinity;

  const selectedProducts = Array.from(document.querySelectorAll('.productInput'))
    .map(el => el.value)
    .filter(Boolean);

  const grouped = {};
  const today = new Date();

  allCustomerRecords.forEach(r => {
    const key = `${r.name}|${r.phone}`;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(r);
  });

  const results = Object.entries(grouped).map(([key, records]) => {
    const name = records[0].name;
    const phone = records[0].phone || "";

    const totalVisits = records.length;
    const paidRecords = records.filter(r => parseFloat(r.amount || 0) > 0);
    const paidVisits = paidRecords.length;
    const totalAmount = paidRecords.reduce((sum, r) => sum + parseFloat(r.amount), 0);
    const averageBill = paidVisits > 0 ? totalAmount / paidVisits : 0;

    const latestRecord = records.reduce((latest, r) =>
      new Date(r.date) > new Date(latest.date) ? r : latest,
      records[0]
    );

    const absentDays = Math.floor((today - new Date(latestRecord.date)) / (1000 * 60 * 60 * 24));
    const lastVisit = latestRecord.date;

    const allProducts = records.flatMap(r => r.items || []).map(item => {
      const match = item.match(/\((.*?)\)/);
      if (match) return match[1];
      return item.split(" - ")[0].trim();
    });

    return {
      key,
      name,
      totalAmount,
      totalVisits,
      paidVisits,
      averageBill,
      absentDays,
      lastVisit,
      products: allProducts
    };
  }).filter(c => {
    const nameMatch = !nameInput || c.name.toLowerCase().includes(nameInput);
    const totalMatch = c.totalAmount >= minTotal && c.totalAmount <= maxTotal;
    const visitMatch = c.totalVisits >= minVisits && c.totalVisits <= maxVisits;
    const absentMatch = c.absentDays >= minAbsent && c.absentDays <= maxAbsent;
    const avgMatch = c.averageBill >= minAvg && c.averageBill <= maxAvg;
    const dateMatch =
      (!startDate || new Date(c.lastVisit) >= new Date(startDate)) &&
      (!endDate || new Date(c.lastVisit) <= new Date(endDate));
    const productMatch = selectedProducts.length === 0 ||
      selectedProducts.every(p => c.products.some(prod => prod.includes(p)));

    return nameMatch && totalMatch && visitMatch && absentMatch && avgMatch && dateMatch && productMatch;
  }).sort((a, b) => b.totalAmount - a.totalAmount);

  const html = results.map(c => {
    const formattedDate = new Date(c.lastVisit).toLocaleDateString('th-TH', {
      day: 'numeric', month: 'short', year: '2-digit'
    });

    return `<div>
      <input type="checkbox" class="selectCustomerCheckbox" value="${c.key}" style="margin-right:6px; vertical-align: middle;">
      üìá <strong style="cursor:pointer;color:#00796b;" onclick="openCustomerModal('${c.key}')">${c.name}</strong>
      üí∞ ‡∏¢‡∏≠‡∏î: ${c.totalAmount.toLocaleString()} |
      üí≥ ${Math.round(c.averageBill).toLocaleString()} |
      üîÅ ${c.totalVisits} (${c.paidVisits} ‡∏à‡πà‡∏≤‡∏¢) |
      ‚è±Ô∏è ${c.absentDays} ‡∏ß‡∏±‡∏ô |
       ${formattedDate}
    </div><hr>`;
  }).join('');

  document.getElementById("filterResults").innerHTML = `<h4>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ${results.length} ‡∏Ñ‡∏ô</h4>` + html;
}





function toggleFloatingMenu() {
    const menu = document.getElementById("floatingMenu");
    menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
  }

  // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏ñ‡πâ‡∏≤‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô
  document.addEventListener('click', function(e) {
    const toggle = document.getElementById("floatingToggle");
    const menu = document.getElementById("floatingMenu");
    if (!toggle.contains(e.target) && !menu.contains(e.target)) {
      menu.style.display = "none";
    }
  });


function closeCustomerModal() {
  document.getElementById("customer-modal").style.display = "none";
}

document.addEventListener("DOMContentLoaded", function () {
  const modal = document.getElementById("customer-modal");
  if (modal) {
    modal.addEventListener("click", function (event) {
      const modalBox = modal.querySelector(".modal-box");
      if (!modalBox.contains(event.target)) {
        closeCustomerModal();
      }
    });
  }
});

function closeCustomerModal() {
  document.getElementById("customer-modal").style.display = "none";
}

document.addEventListener("DOMContentLoaded", function () {
  const modal = document.getElementById("customer-modal");
  if (!modal) return;

  modal.addEventListener("click", function (event) {
    const modalBox = modal.querySelector(".modal-box");
    if (!modalBox.contains(event.target)) {
      closeCustomerModal();
    }
  });
});


document.addEventListener("DOMContentLoaded", function () {
  const modal = document.getElementById("customer-modal");
  const modalBox = document.getElementById("customer-modal-box");

  if (modal && modalBox) {
    modal.addEventListener("click", function (event) {
      if (!modalBox.contains(event.target)) {
        closeCustomerModal();
      }
    });
  }
});



  </script>
  <div id="floatingToggle" class="floating-toggle" onclick="toggleFloatingMenu()">
  <img src="{{ url_for('static', filename='icon/icon_menu_toggle.png') }}" alt="menu" style="width:60px;height:60px;">
</div>

<!-- ‚úÖ 2. ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà (‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á) -->
<div id="floatingMenu" class="floating-menu">
  <a href="{{ url_for('dashboard') }}"><img src="{{ url_for('static', filename='icon/icon_dashboard.png') }}"></a>
  <a href="{{ url_for('sale_summary') }}"><img src="{{ url_for('static', filename='icon/icon_sale_summary.png') }}"></a>
  <a href="{{ url_for('record_sales') }}"><img src="{{ url_for('static', filename='icon/icon_record_sales.png') }}"></a>
  <a href="{{ url_for('customer_list') }}"><img src="{{ url_for('static', filename='icon/icon_customer_list.png') }}"></a>
  <a href="{{ url_for('record_customer') }}"><img src="{{ url_for('static', filename='icon/icon_customer_history.png') }}"></a>
  <a href="{{ url_for('oldsaledata') }}"><img src="{{ url_for('static', filename='icon/icon_old_customers.png') }}"></a>
  <a href="{{ url_for('inventory') }}"><img src="{{ url_for('static', filename='icon/icon_inventory.png') }}"></a>
  <a href="#"><img src="{{ url_for('static', filename='icon/icon_staff.png') }}"></a>
  <a href="{{ url_for('appointments') }}"><img src="{{ url_for('static', filename='icon/icon_appointments.png') }}"></a>

</div>

</body>
</html>
