<!DOCTYPE html>
<html lang="th">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta charset="UTF-8" />
<title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  /* =========================
     MODERN UI (clean + fast)
     ========================= */

  :root{
    --bg: #0b1220;
    --bg2:#0a1020;
    --card: rgba(255,255,255,.06);
    --card2: rgba(255,255,255,.08);
    --line: rgba(255,255,255,.10);

    --text:#eaf2ff;
    --muted: rgba(234,242,255,.68);

    --brand:#14b8a6;
    --brand2:#22c55e;
    --danger:#fb7185;
    --warn:#fbbf24;

    --shadow: 0 14px 40px rgba(0,0,0,.35);
    --shadow2: 0 10px 24px rgba(0,0,0,.28);

    --r14: 14px;
    --r18: 18px;
    --r22: 22px;

    --pad: 16px;
    --pad2: 18px;
  }

  *{ box-sizing:border-box; }
  html, body{ height:100%; }
  body{
    font-family:'Prompt', system-ui, -apple-system, Segoe UI, sans-serif;
    margin:0;
    padding: 14px;
    padding-bottom: 130px;
    color: var(--text);
    background:
      radial-gradient(900px 450px at 10% 10%, rgba(20,184,166,.22), transparent 60%),
      radial-gradient(700px 360px at 92% 0%, rgba(34,197,94,.18), transparent 55%),
      radial-gradient(650px 380px at 75% 95%, rgba(59,130,246,.12), transparent 60%),
      linear-gradient(180deg, var(--bg), var(--bg2));
    -webkit-font-smoothing:antialiased;
    text-rendering:optimizeLegibility;
    font-size: 14px;
  }

  a{ color: inherit; }

  /* ---- Top Menu ---- */
  .menu-bar{
    display:flex;
    justify-content:space-around;
    gap:10px;
    background: rgba(255,255,255,.06);
    border:1px solid var(--line);
    padding: 12px 12px;
    border-radius: var(--r18);
    margin: 6px auto 16px;
    box-shadow: var(--shadow2);
    max-width: 1200px;
    backdrop-filter: blur(10px);
  }
  .menu-bar a{
    text-decoration:none;
    font-weight:700;
    color: rgba(234,242,255,.86);
    padding: 10px 12px;
    border-radius: 999px;
    transition: background .15s ease, transform .12s ease;
  }
  .menu-bar a:hover{
    background: rgba(20,184,166,.14);
    transform: translateY(-1px);
  }

  /* ---- Month nav ---- */
  .month-nav{
    max-width:1200px;
    margin: 0 auto 14px;
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .month-nav button{
    border:none;
    color:#07101e;
    font-weight:800;
    background: linear-gradient(135deg, var(--brand), rgba(20,184,166,.65));
    padding: 10px 16px;
    border-radius: 999px;
    cursor:pointer;
    box-shadow: 0 14px 24px rgba(20,184,166,.18);
    transition: transform .12s ease, filter .18s ease, box-shadow .18s ease;
    white-space:nowrap;
  }
  .month-nav button:hover{
    filter: brightness(1.06);
    transform: translateY(-1px);
    box-shadow: 0 18px 30px rgba(20,184,166,.22);
  }
  .month-nav button:active{ transform: translateY(0px) scale(.99); }

  #openRangeBtn{
    background: linear-gradient(135deg, rgba(59,130,246,.9), rgba(147,197,253,.85));
    box-shadow: 0 14px 24px rgba(59,130,246,.18);
  }
  #clearRangeBtn{
    background: linear-gradient(135deg, rgba(251,113,133,.95), rgba(244,63,94,.8));
    box-shadow: 0 14px 24px rgba(244,63,94,.18);
  }

  /* ---- Hero ---- */
  #mainTitle{
    max-width:1200px;
    margin: 0 auto 16px;
    padding: 18px 18px;
    border-radius: var(--r22);
    border:1px solid rgba(255,255,255,.10);
    background:
      radial-gradient(700px 220px at 15% 20%, rgba(20,184,166,.18), transparent 60%),
      radial-gradient(550px 200px at 90% 15%, rgba(34,197,94,.16), transparent 55%),
      rgba(255,255,255,.06);
    box-shadow: var(--shadow);
    backdrop-filter: blur(12px);
    cursor:pointer;

    display:flex;
    flex-direction:column;
    gap:6px;
    align-items:flex-start;
  }
  #mainTitle .month{
    font-size: 20px;
    font-weight: 800;
    letter-spacing:.3px;
  }
  #mainTitle .total{
    font-size: 16px;
    color: rgba(234,242,255,.92);
  }
  #mainTitle .compare{
    font-size: 12px;
    color: var(--muted);
    line-height: 1.35;
  }

  /* ---- Cards ---- */
  .card{
    max-width:1200px;
    margin: 0 auto 16px;
    background: rgba(255,255,255,.06);
    border: 1px solid var(--line);
    border-radius: var(--r18);
    box-shadow: var(--shadow2);
    backdrop-filter: blur(12px);
    overflow:hidden;
  }
  .card-header{
    padding: 14px 16px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    border-bottom: 1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.04);
  }
  .card-header h3{
    margin:0;
    font-size: 14px;
    font-weight: 800;
    color: rgba(234,242,255,.92);
    letter-spacing:.2px;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .card-body{ padding: 14px 16px; }

  /* ---- Top10 ---- */
  .top10-box{ padding:0; }
  .top10-box ul{ list-style:none; padding:0; margin:0; }
  .top10-box li{
    padding: 10px 0;
    border-bottom: 1px dashed rgba(255,255,255,.14);
    display:flex;
    gap:8px;
    align-items:flex-start;
    flex-wrap:wrap;
  }
  .top10-box li:last-child{ border-bottom:none; }
  .top10-box .name{
    font-weight:800;
    color: rgba(234,242,255,.92);
  }
  .top10-box .date{
    font-size: 12px;
    color: var(--muted);
  }
  .top10-box .amount{
    margin-left:auto;
    font-weight:900;
    font-variant-numeric: tabular-nums;
    color: #7dd3fc;
    white-space:nowrap;
  }

  #totalCustomer{
    margin: 10px 0 0;
    padding: 10px 12px;
    border-radius: 12px;
    background: rgba(255,255,255,.05);
    border: 1px solid rgba(255,255,255,.10);
    text-align:center;
    cursor:pointer;
    color: rgba(234,242,255,.86);
    font-weight:700;
  }
  #totalCustomer:hover{
    background: rgba(20,184,166,.10);
    border-color: rgba(20,184,166,.20);
  }

  /* ---- Summary grid ---- */
  .chart-summary-row{
    max-width:1200px;
    margin: 0 auto 16px;
    display:flex;
    gap:14px;
    flex-wrap:wrap;
  }
  .summary-list{
    flex: 1;
    min-width: 320px;
    background: rgba(255,255,255,.06);
    border: 1px solid var(--line);
    border-radius: var(--r18);
    box-shadow: var(--shadow2);
    backdrop-filter: blur(12px);
    padding: 14px;
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
  }

  .summary-group{
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
    border-radius: 14px;
    padding: 12px;
    transition: transform .12s ease, background .18s ease, border-color .18s ease;
    cursor:pointer;
    min-height: 92px;
  }
  .summary-group:hover{
    transform: translateY(-1px);
    background: rgba(20,184,166,.09);
    border-color: rgba(20,184,166,.22);
  }
  .summary-group strong{
    display:block;
    font-size: 12px;
    font-weight: 900;
    color: rgba(234,242,255,.92);
    margin-bottom: 6px;
  }
  .summary-group ul{
    list-style:none;
    padding:0;
    margin: 8px 0 0;
    color: rgba(234,242,255,.80);
    font-size: 11px;
    line-height: 1.35;
  }

  /* ---- Filter Section ---- */
  .filter-section{
    max-width:1200px;
    margin: 0 auto 16px;
    background: rgba(255,255,255,.06);
    border: 1px solid var(--line);
    border-radius: var(--r18);
    box-shadow: var(--shadow2);
    backdrop-filter: blur(12px);
    padding: 14px 16px;
  }

  .filter-section h3{
    margin:0 0 10px;
    font-size: 14px;
    font-weight: 900;
  }

  .inline-field{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom: 10px;
  }
  .inline-field label{
    min-width: 170px;
    font-weight: 800;
    color: rgba(234,242,255,.88);
  }

  .input-pair{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

  input, select{
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(10,16,32,.55);
    color: rgba(234,242,255,.92);
    padding: 9px 10px;
    border-radius: 12px;
    font-size: 13px;
    outline:none;
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  input:focus, select:focus{
    border-color: rgba(20,184,166,.45);
    box-shadow: 0 0 0 4px rgba(20,184,166,.18);
  }

  .search-button{
    border:none;
    color:#07101e;
    font-weight: 900;
    background: linear-gradient(135deg, var(--brand2), rgba(34,197,94,.65));
    padding: 10px 16px;
    border-radius: 999px;
    cursor:pointer;
    box-shadow: 0 14px 24px rgba(34,197,94,.18);
    transition: transform .12s ease, filter .18s ease, box-shadow .18s ease;
  }
  .search-button:hover{
    filter: brightness(1.06);
    transform: translateY(-1px);
    box-shadow: 0 18px 30px rgba(34,197,94,.22);
  }

  .add-product-button{
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.06);
    color: rgba(234,242,255,.92);
    padding: 10px 14px;
    border-radius: 999px;
    cursor:pointer;
    font-weight: 800;
    transition: transform .12s ease, background .18s ease, border-color .18s ease;
  }
  .add-product-button:hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,.10);
    border-color: rgba(20,184,166,.25);
  }

  /* ---- Lead Score ---- */
  .lead-score-box{
    max-width:1200px;
    margin: 0 auto 16px;
    background: rgba(255,255,255,.06);
    border: 1px solid var(--line);
    border-radius: var(--r18);
    box-shadow: var(--shadow2);
    backdrop-filter: blur(12px);
    overflow:hidden;
  }
  .lead-score-box .head{
    padding: 14px 16px;
    border-bottom: 1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.04);
  }
  .lead-score-box h3{
    margin:0;
    font-size:14px;
    font-weight:900;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .lead-score-sub{
    margin-top:6px;
    font-size: 11px;
    color: var(--muted);
    line-height:1.45;
  }
  #leadScoreList{ list-style:none; padding: 0 16px 12px; margin:0; }
  #leadScoreList li{
    padding: 12px 0;
    border-bottom: 1px dashed rgba(255,255,255,.14);
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  #leadScoreList li:last-child{ border-bottom:none; }

  .lead-name{
    font-weight: 900;
    color: rgba(234,242,255,.92);
    cursor:pointer;
  }
  .lead-score-badge{
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 900;
    border: 1px solid rgba(20,184,166,.22);
    background: rgba(20,184,166,.10);
    color: rgba(234,242,255,.92);
  }
  .lead-score-meta{
    flex: 1 1 auto;
    font-size: 11px;
    color: rgba(234,242,255,.78);
  }
  .lead-absent{ color: var(--danger); font-weight: 900; }
  .lead-money{ margin-left:auto; font-variant-numeric: tabular-nums; font-weight: 900; color: #7dd3fc; }

  /* ---- Modals ---- */
  #customer-modal, #group-modal, #group-modal-legacy, .range-modal{
    display:none;
    position:fixed;
    inset:0;
    background: rgba(0,0,0,.65);
    backdrop-filter: blur(8px);
    z-index: 9999;
    justify-content:center;
    align-items:center;
    padding: 14px;
  }
  #customer-modal-box, .range-modal__panel, #group-modal-content, #group-modal-content-legacy{
    background: rgba(10,16,32,.92) !important;
    border: 1px solid rgba(255,255,255,.12) !important;
    border-radius: var(--r22) !important;
    box-shadow: var(--shadow) !important;
    color: rgba(234,242,255,.92);
    backdrop-filter: blur(14px);
  }
  #customer-modal-box{
    width: min(900px, 92vw);
    max-height: 90vh;
    overflow:auto;
    padding: 16px;
    position: relative;
  }
  #customer-modal-box button{
    border:none;
    background: rgba(255,255,255,.06);
    color: rgba(234,242,255,.92);
    width: 38px;
    height: 38px;
    border-radius: 999px;
    cursor:pointer;
    transition: transform .12s ease, background .18s ease;
  }
  #customer-modal-box button:hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,.10);
  }

  /* Range modal */
  .range-modal{ z-index: 1200; }
  .range-modal__backdrop{ position:absolute; inset:0; }
  .range-modal__panel{
    position:relative;
    width:min(420px, 92vw);
    overflow:hidden;
  }
  .range-modal__header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding: 12px 14px;
    background: rgba(255,255,255,.05);
    border-bottom: 1px solid rgba(255,255,255,.10);
    font-weight: 900;
  }
  .range-modal__close{
    width:auto !important;
    height:auto !important;
    padding: 6px 10px !important;
    border-radius: 999px !important;
    background: rgba(255,255,255,.06) !important;
  }
  .range-modal__body{
    padding: 14px;
    display:grid;
    gap: 12px;
  }
  .range-modal__body label{ display:grid; gap:6px; font-size: 12px; color: rgba(234,242,255,.78); }
  .range-modal__footer{
    display:flex;
    justify-content:flex-end;
    gap: 10px;
    padding: 12px 14px;
    border-top: 1px solid rgba(255,255,255,.10);
  }
  .btn-primary, .btn-secondary{
    border:none;
    padding: 10px 14px;
    border-radius: 999px;
    cursor:pointer;
    font-weight: 900;
  }
  .btn-primary{
    background: linear-gradient(135deg, var(--brand), rgba(20,184,166,.65));
    color:#07101e;
  }
  .btn-secondary{
    background: rgba(255,255,255,.06);
    color: rgba(234,242,255,.92);
    border:1px solid rgba(255,255,255,.12);
  }

  /* Popup table (mini) */
  .table-mini{
    width:100%;
    border-collapse: collapse;
    font-size: 12px;
    overflow:hidden;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.12);
  }
  .table-mini th{
    text-align:left;
    padding: 10px 10px;
    background: rgba(255,255,255,.06);
    color: rgba(234,242,255,.88);
    border-bottom: 1px solid rgba(255,255,255,.10);
    white-space:nowrap;
  }
  .table-mini td{
    padding: 10px 10px;
    border-bottom: 1px dashed rgba(255,255,255,.12);
    color: rgba(234,242,255,.82);
    vertical-align:top;
  }
  .table-mini tr:last-child td{ border-bottom:none; }

  .badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 4px 10px;
    border-radius: 999px;
    background: rgba(20,184,166,.12);
    border: 1px solid rgba(20,184,166,.20);
    color: rgba(234,242,255,.90);
    font-size: 11px;
    font-weight: 900;
    margin: 4px 6px 0 0;
    white-space:nowrap;
  }

  /* Group modal UI */
  .group-header{
    font-size: 14px;
    font-weight: 900;
    color: rgba(234,242,255,.92);
    margin-bottom: 12px;
    padding: 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
  }
  .customer-entry{
    padding: 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
    margin-bottom: 10px;
  }
  .customer-name{ font-weight: 900; margin-bottom: 6px; }
  .date-info{ display:flex; flex-wrap:wrap; gap:8px; }
  .date-box{
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.12);
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 11px;
    color: rgba(234,242,255,.86);
    white-space:nowrap;
  }

  /* Responsive */
  @media (max-width: 1024px){
    .summary-list{ grid-template-columns: repeat(3, 1fr); }
  }
  @media (max-width: 768px){
    body{ font-size: 12px; padding: 12px; padding-bottom: 150px; }
    #mainTitle .month{ font-size: 16px; }
    #mainTitle .total{ font-size: 13px; }
    #mainTitle .compare{ font-size: 11px; }
    .summary-list{ grid-template-columns: repeat(2, 1fr); }
    .inline-field{ flex-direction:column; align-items:flex-start; }
    .inline-field label{ min-width: unset; }
    input, select{ width: 100%; }
    .input-pair{ width: 100%; }
  }
  @media (max-width: 420px){
    .summary-list{ grid-template-columns: 1fr; }
  }
</style>
</head>

<body>
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Legacy Group modal -->
<div id="group-modal-legacy">
  <div id="group-modal-content-legacy" style="padding:16px; max-height:80vh; overflow:auto; width:min(520px, 92vw);">
    <div id="groupSelectedList-legacy"></div>
    <div style="text-align:right; margin-top:14px;">
      <button onclick="closeGroupModal()" style="padding:10px 14px; border-radius:999px; font-weight:900;">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>

<!-- Customer modal -->
<div id="customer-modal">
  <div id="customer-modal-box">
    <button onclick="closeCustomerModal()" style="position:absolute; top:10px; right:12px;">‚úï</button>
    <div id="modal-content"></div>
  </div>
</div>

<!-- Month nav -->
<div class="month-nav">
  <button onclick="changeMonth(-1)">‚Üê ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
  <button id="openRangeBtn" onclick="openRangeModal()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
  <button id="clearRangeBtn" onclick="clearRange()">‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á</button>
  <button onclick="changeMonth(1)">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
</div>

<!-- Range modal -->
<div id="rangeModal" class="range-modal">
  <div class="range-modal__backdrop" onclick="closeRangeModal()"></div>
  <div class="range-modal__panel">
    <div class="range-modal__header">
      <div>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
      <button class="range-modal__close" onclick="closeRangeModal()">‚úï</button>
    </div>
    <div class="range-modal__body">
      <label>
        ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        <input type="month" id="rangeStartModal">
      </label>
      <label>
        ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
        <input type="month" id="rangeEndModal">
      </label>
    </div>
    <div class="range-modal__footer">
      <button class="btn-secondary" onclick="closeRangeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn-primary" onclick="applyRangeFromModal()">‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>
  </div>
</div>

<!-- Hero -->
<div id="mainTitle">
  <div class="month">...</div>
  <div class="total">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  <div class="compare"></div>
</div>

<!-- Top10 card -->
<div class="card top10-box">
  <div class="card-header">
    <h3>üèÜ Top 10 ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
  </div>
  <div class="card-body">
    <ul id="top10List"><li style="text-align:center; color: rgba(234,242,255,.65);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</li></ul>
    <p id="totalCustomer" onclick="toggleCustomerList()"></p>
    <ul id="allCustomerList" style="display:none; padding-top: 10px;"></ul>
  </div>
</div>

<!-- Summary grid -->
<div class="chart-summary-row">
  <div class="summary-list" id="summaryList">
    <div style="text-align:center; color: rgba(234,242,255,.65); grid-column: 1 / -1;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</div>
  </div>
</div>

<div id="filter-placeholder"></div>

<!-- Lead score -->
<div class="lead-score-box">
  <div class="head">
    <h3>üìû ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ï‡∏≤‡∏°‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
    <div class="lead-score-sub">
      ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏π‡∏à‡∏≤‡∏Å <b>= ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° + ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á + ‡∏ö‡∏¥‡∏•‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢) + ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ô‡∏≤‡∏ô (‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ä‡πà‡∏ß‡∏á 46‚Äì120 ‡∏ß‡∏±‡∏ô) ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤ 45 ‡∏ß‡∏±‡∏ô</b>
      <br><span style="opacity:.8;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏•‡∏ö Sale Pitch ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô</span>
    </div>
  </div>
  <ul id="leadScoreList">
    <li style="text-align:center; color: rgba(234,242,255,.65); padding:14px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</li>
  </ul>
</div>

<!-- Group modal -->
<div id="group-modal">
  <div id="group-modal-content" style="padding:16px; width:min(760px, 95vw); max-height:90vh; overflow:auto; position:relative;">
    <div style="position:absolute; top:10px; right:10px; display:flex; gap:10px;">
      <button onclick="saveGroupModalAsImage()" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" style="width:40px; height:40px; border-radius:999px; background:rgba(255,255,255,.06); color:rgba(234,242,255,.92); border:1px solid rgba(255,255,255,.12); cursor:pointer;">üíæ</button>
      <button onclick="closeGroupModal()" title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á" style="width:40px; height:40px; border-radius:999px; background:rgba(255,255,255,.06); color:rgba(234,242,255,.92); border:1px solid rgba(255,255,255,.12); cursor:pointer;">‚úï</button>
    </div>
    <div style="margin-top: 40px;" id="groupSelectedList"></div>
  </div>
</div>

<script>
  // ===== Helpers / State =====
  function formatYM(d){const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');return `${y}-${m}`;}
  const dateYM = (s)=> s.slice(0,7);
  const ymNum = (ym)=>{const[a,b]=ym.split('-').map(Number);return a*100+b;}

  const pad4 = (s) => String(s||'').padStart(4,'0');
  const esc = (s) => (s||'').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  const fmtShortDate = (d) => { if(!d)return'-'; const date=new Date(d); return `${date.getDate()}/${date.getMonth()+1}/${String(date.getFullYear()).slice(-2)}`; };
  const makeCustomerKey = (opd, name, phone) => `${opd}|${name}|${phone}`;

  let viewingDate = new Date();
  let allSalesRecords = [];
  let allCustomerRecords = [];

  // ‡πÇ‡∏´‡∏°‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  const monthRange = { enabled:false, startYM:null, endYM:null };

  function activeFilter(r){
    if (monthRange.enabled){
      const ym = dateYM(r.date);
      return ymNum(ym) >= ymNum(monthRange.startYM) && ymNum(ym) <= ymNum(monthRange.endYM);
    }
    return r.date.startsWith(formatYM(viewingDate));
  }

  function changeMonth(delta) {
    viewingDate.setMonth(viewingDate.getMonth() + delta);
    monthRange.enabled = false;
    fetchDataAndUpdate();
    refreshCustomerList();
  }

  function fetchAllCustomerRecords() {
    return fetch("/api/sales")
      .then(res => res.json())
      .then(records => {
        allCustomerRecords = records;
        if(records.length > 0) buildLeadScoreList();
      })
      .catch(err => { console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err); });
  }

  function fetchDataAndUpdate() {
    if (allSalesRecords.length > 0 && allCustomerRecords.length > 0) {
      updateDashboard(allSalesRecords);
    } else {
      Promise.all([
        fetch("/api/sales").then(res => res.json()),
        fetchAllCustomerRecords()
      ]).then(([salesRecords]) => {
        allSalesRecords = salesRecords;
        updateDashboard(allSalesRecords);
      }).catch(err => {
        console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
      });
    }
  }

  function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }

  function updateDashboard(records) {
    const compareEl = document.querySelector('#mainTitle .compare');
    compareEl.innerHTML = '';

    if (monthRange.enabled){
      const [sy, sm] = monthRange.startYM.split('-').map(Number);
      const [ey, em] = monthRange.endYM.split('-').map(Number);
      const startText = new Date(sy, sm-1, 1).toLocaleString('th-TH',{month:'long'}) + ' ' + (sy+543);
      const endText   = new Date(ey, em-1, 1).toLocaleString('th-TH',{month:'long'}) + ' ' + (ey+543);
      document.querySelector('#mainTitle .month').textContent = `${startText} ‚Äì ${endText}`;
    } else {
      const monthName = viewingDate.toLocaleString('th-TH', { month: 'long' });
      const yearBE = viewingDate.getFullYear() + 543;
      document.querySelector('#mainTitle .month').textContent = `${monthName} ${yearBE}`;
    }

    let totalSales = 0;

    if (monthRange.enabled){
      records.filter(activeFilter).forEach(r => totalSales += parseFloat(r.amount || 0));
      document.querySelector('#mainTitle .total').innerHTML = `üí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° <b>${totalSales.toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó`;
      compareEl.innerHTML = `<span style="opacity:.85;">‡πÇ‡∏´‡∏°‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`;
    } else {
      const today = new Date();
      const todayDate = Math.min(today.getDate(), daysInMonth(viewingDate.getFullYear(), viewingDate.getMonth()+1));

      const currentPrefix = formatYM(viewingDate);
      const prev = new Date(viewingDate); prev.setMonth(viewingDate.getMonth() - 1);
      const lastPrefix = formatYM(prev);

      let lastMonthSales = 0, toDateSales = 0, toDateLastMonthSales = 0;

      records.forEach(r => {
        const amt = parseFloat(r.amount||0);
        if (r.date.startsWith(currentPrefix)){
          totalSales += amt;
          const d = parseInt(r.date.split('-')[2]); if (d <= todayDate) toDateSales += amt;
        }
        if (r.date.startsWith(lastPrefix)){
          lastMonthSales += amt;
          const d = parseInt(r.date.split('-')[2]); if (d <= todayDate) toDateLastMonthSales += amt;
        }
      });

      document.querySelector('#mainTitle .total').innerHTML = `üí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° <b>${totalSales.toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó`;

      let diff = totalSales - lastMonthSales;
      let text = diff > 0
        ? `<span style="color:${'#22c55e'}; font-weight:900;">+${diff.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span> <span style="opacity:.8;">‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`
        : diff < 0
          ? `<span style="color:${'#fb7185'}; font-weight:900;">-${Math.abs(diff).toLocaleString()} ‡∏ö‡∏≤‡∏ó</span> <span style="opacity:.8;">‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`
          : `<span style="opacity:.85;">‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`;

      diff = toDateSales - toDateLastMonthSales;
      let text2 = diff > 0
        ? `<span style="color:${'#22c55e'}; font-weight:900;">üìÜ ${todayDate} ‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å: +${diff.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span> <span style="opacity:.8;">‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`
        : diff < 0
          ? `<span style="color:${'#fb7185'}; font-weight:900;">üìÜ ${todayDate} ‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å: -${Math.abs(diff).toLocaleString()} ‡∏ö‡∏≤‡∏ó</span> <span style="opacity:.8;">‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`
          : `<span style="opacity:.85;">üìÜ ${todayDate} ‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å: ‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>`;

      compareEl.innerHTML = `${text}<br>${text2}`;

      // today/week
      let todaySales = 0, weekSales = 0;
      const todayObj = new Date();
      const dow = todayObj.getDay();
      const curM = viewingDate.getMonth(), curY = viewingDate.getFullYear();
      let monday = new Date(todayObj); monday.setDate(todayObj.getDate() - ((dow + 6) % 7));
      if (monday.getMonth() !== curM) monday = new Date(curY, curM, 1);
      const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);

      records.forEach(r => {
        const rd = new Date(r.date);
        const amt = parseFloat(r.amount || 0);
        const sameDate = rd.getFullYear()===todayObj.getFullYear() && rd.getMonth()===todayObj.getMonth() && rd.getDate()===todayObj.getDate();
        if (sameDate) todaySales += amt;

        const inCurrentMonth = rd.getMonth()===curM && rd.getFullYear()===curY;
        if (rd >= monday && rd <= sunday && inCurrentMonth) weekSales += amt;
      });

      const extraInfo = document.createElement("div");
      extraInfo.style.marginTop = "6px";
      extraInfo.style.fontSize = "11px";
      extraInfo.style.color = "rgba(234,242,255,.78)";
      extraInfo.innerHTML = `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <b>${todaySales.toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó ¬∑ ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ (${monday.getDate()}‚Äì${sunday.getDate()}): <b>${weekSales.toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó`;
      compareEl.appendChild(extraInfo);
    }

    // ===== Summary by category =====
    const categoryCounts = {}, categoryDetails = {}, customerMap = {};
    records.filter(activeFilter).forEach(r => {
      const key = `${r.name}|${r.phone}`;
      if (!customerMap[key]) customerMap[key] = { name:r.name, phone:r.phone, opd:r.opd||'-', date:r.date, amount:0 };
      customerMap[key].amount += parseFloat(r.amount||0);
      if (r.date > customerMap[key].date) customerMap[key].date = r.date;

      (r.items || []).forEach(item => {
        const match = item.match(/\((.*?)\)/);
        const subItem = match ? match[1] : item;
        const qtyMatch = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+)/);
        const qty = qtyMatch ? parseInt(qtyMatch[1]) : 0;
        const categoryMatch = item.match(/^(.+?) ?\(/);
        const category = categoryMatch ? categoryMatch[1].trim() : "‡∏≠‡∏∑‡πà‡∏ô‡πÜ";

        if (!categoryCounts[category]) categoryCounts[category] = 0;
        if (!categoryDetails[category]) categoryDetails[category] = {};
        categoryCounts[category] += qty;
        (categoryDetails[category][subItem] ||= { qty:0, total:0 }).qty += qty;
      });
    });

    const sortedEntries = Object.entries(categoryCounts).sort((a,b)=>b[1]-a[1]);
    document.getElementById('summaryList').innerHTML = sortedEntries.length
      ? sortedEntries.map(([cat]) => {
          const items = Object.entries(categoryDetails[cat] || {})
            .slice(0, 8)
            .map(([sub, d]) => `‚Ä¢ ${esc(sub)} <b>${d.qty}</b>`)
            .join('<br>');
          const sumQty = categoryCounts[cat];
          return `
            <div class="summary-group" onclick="openGroupModalByCategory('${esc(cat).replace(/'/g,"\\'")}')">
              <strong>${esc(cat)}</strong>
              ‡∏£‡∏ß‡∏° <b>${sumQty}</b> ‡∏ä‡∏¥‡πâ‡∏ô
              <ul>${items || ''}</ul>
            </div>`;
        }).join('')
      : `<div style="text-align:center; color: rgba(234,242,255,.65); grid-column: 1 / -1;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</div>`;

    if (typeof buildLeadScoreList === 'function') buildLeadScoreList();

    // ===== Top10 =====
    const top10 = Object.values(customerMap).sort((a,b)=>b.amount-a.amount).slice(0,10);
    document.getElementById('top10List').innerHTML = top10.map((c) => {
      const key = `${c.name}|${c.phone}`;
      const allRec = allCustomerRecords.filter(r => `${r.name}|${r.phone}` === key);

      const totalVisits = allRec.length;
      const paid = allRec.filter(r => parseFloat(r.amount||0) > 0);
      const paidVisits = paid.length;
      const totalAmount = paid.reduce((s,r)=>s+parseFloat(r.amount),0);
      const avg = paidVisits>0 ? Math.round(totalAmount/paidVisits) : 0;

      const latest = allRec.length? new Date(Math.max(...allRec.map(r=>new Date(r.date)))):null;
      const daysSinceLastVisit = latest? Math.floor((new Date()-latest)/(1000*60*60*24)) : null;

      let absentColor = 'rgba(234,242,255,.7)';
      if (daysSinceLastVisit < 30) absentColor = '#22c55e';
      else if (daysSinceLastVisit <= 90) absentColor = '#fbbf24';
      else absentColor = '#fb7185';

      let totalColor='rgba(234,242,255,.75)', totalExtra='', totalIcon='';
      if (totalAmount < 50000) totalColor='#fb7185';
      else if (totalAmount <= 99999) totalColor='#22c55e';
      else if (totalAmount <= 200000) totalColor='#fbbf24';
      else { totalColor='#7dd3fc'; totalExtra='font-weight:900;'; totalIcon=' üíé'; }

      let avgColor='rgba(234,242,255,.75)';
      if (avg < 5000) avgColor='#fb7185';
      else if (avg <= 9999) avgColor='#22c55e';
      else avgColor='#fbbf24';

      const lastVisitText = daysSinceLastVisit != null
        ? `<span style="color:${absentColor}; font-weight:900;">‡πÑ‡∏°‡πà‡∏°‡∏≤ ${daysSinceLastVisit} ‡∏ß‡∏±‡∏ô</span>` : `<span style="opacity:.8;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>`;

      const isNewCustomer = monthRange.enabled
        ? allRec.filter(r => ymNum(dateYM(r.date)) < ymNum(monthRange.startYM)).length === 0
        : allRec.filter(r => r.date < `${formatYM(viewingDate)}-01`).length === 0;
      const newBadge = isNewCustomer ? `<span style="color:#fb7185; font-weight:900;"> ¬∑ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</span>` : "";

      return `
      <li>
        <span class="name" style="cursor:pointer;" onclick="openCustomerModal('${key}')">${esc(c.name)}${newBadge}</span>
        <span class="date">
          (üí≥ <span style="color:${avgColor}; font-weight:900;">${avg.toLocaleString()}</span> √ó ${totalVisits}
           ¬∑ üí∞ <span style="color:${totalColor}; ${totalExtra}">${totalAmount.toLocaleString()}${totalIcon}</span>
           ¬∑ ${lastVisitText})
        </span>
        <span class="amount">${c.amount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
      </li>`;
    }).join('');

    document.getElementById('totalCustomer').textContent =
      `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${Object.keys(customerMap).length} ‡∏Ñ‡∏ô (‡∏Å‡∏î‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)`;
  }

  document.getElementById('mainTitle').addEventListener('click', openMonthlySalesPopup);

  function openGroupModalByCategory(cat) {
    const summary = {};
    const totalQty = { count: 0 };

    const catElement = Array.from(document.querySelectorAll(".summary-group"))
      .find(group => group.querySelector("strong")?.textContent === cat);
    const catText = catElement?.innerText || "";

    allSalesRecords.filter(activeFilter).forEach(r => {
      (r.items || []).forEach(item => {
        const match = item.match(/\((.*?)\)/);
        const subItem = match ? match[1] : item.split(" - ")[0].trim();

        const qtyMatch = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
        const qty = qtyMatch ? parseInt(qtyMatch[1]) : 1;

        if (!catText.includes(subItem) && !catText.includes(item)) return;

        if (!summary[subItem]) summary[subItem] = {};
        const key = `${r.name}|${r.phone}`;
        if (!summary[subItem][key]) summary[subItem][key] = { name: r.name, dates: {} };
        summary[subItem][key].dates[r.date] = (summary[subItem][key].dates[r.date] || 0) + qty;

        totalQty.count += qty;
      });
    });

    const html = Object.entries(summary).map(([productName, buyers]) => {
      const buyerLines = Object.values(buyers).map(c => {
        const dateParts = Object.entries(c.dates)
          .sort(([a],[b]) => a.localeCompare(b))
          .map(([date, qty]) => {
            const thDate = new Date(date).toLocaleDateString('th-TH',{ day:'numeric', month:'short' });
            return `${thDate} = ${qty}`;
          }).join(" ¬∑ ");
        return `üë§ <b>${esc(c.name)}</b>: ${dateParts}`;
      }).join("<br>");

      return `<div style="margin-bottom:12px;">
        <div style="font-weight:900; color: rgba(234,242,255,.92); margin-bottom:6px;">üîπ ${esc(productName)}</div>
        <div style="color: rgba(234,242,255,.80); font-size:12px; line-height:1.5;">${buyerLines}</div>
      </div>`;
    }).join("");

    document.getElementById("groupSelectedList").innerHTML = `
      <div class="group-header">
        üì¶ ‡∏´‡∏°‡∏ß‡∏î: <b>${esc(cat)}</b><br>
        ‚úÖ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span style="font-size:16px; color:#7dd3fc; font-weight:900;">${totalQty.count}</span> ‡∏ä‡∏¥‡πâ‡∏ô
      </div>
      ${html || '<div style="padding:10px; opacity:.75;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</div>'}
    `;
    document.getElementById("group-modal").style.display = "flex";
  }

  function closeGroupModal() {
    const m1 = document.getElementById("group-modal");
    const m2 = document.getElementById("group-modal-legacy");
    if (m1) m1.style.display = "none";
    if (m2) m2.style.display = "none";
  }

  document.getElementById("group-modal").addEventListener("click", function (e) {
    const content = document.getElementById("group-modal-content");
    if (content && !content.contains(e.target)) closeGroupModal();
  });

  function saveGroupModalAsImage() {
    const node = document.getElementById("group-modal-content");
    if (!node) return;
    html2canvas(node, { scale: 2 }).then(canvas => {
      const a = document.createElement("a");
      a.download = 'group-summary.jpg';
      a.href = canvas.toDataURL("image/jpeg", 0.95);
      a.click();
    });
  }

  function toggleCustomerList() {
    const listEl = document.getElementById("allCustomerList");

    if (listEl.style.display === "none") {
      listEl.style.display = "block";
      const customerMap = {};
      allSalesRecords.filter(activeFilter).forEach(r => {
        const key = `${r.name}|${r.phone}`;
        if (!customerMap[key]) customerMap[key] = { name:r.name, phone:r.phone, opd:r.opd||"-", date:r.date, amount:0 };
        customerMap[key].amount += parseFloat(r.amount || 0);
        if (r.date > customerMap[key].date) customerMap[key].date = r.date;
      });

      const customerList = Object.values(customerMap).sort((a,b)=>b.amount-a.amount).slice(10);

      listEl.innerHTML = customerList.map((c, i) => {
        const key = `${c.name}|${c.phone}`;
        const allRec = allCustomerRecords.filter(r => `${r.name}|${r.phone}` === key);

        const totalVisits = allRec.length;
        const paid = allRec.filter(r => parseFloat(r.amount||0) > 0);
        const paidVisits = paid.length;
        const totalAmount = paid.reduce((s,r)=>s+parseFloat(r.amount),0);
        const avg = paidVisits>0 ? Math.round(totalAmount/paidVisits) : 0;

        const latest = allRec.length? new Date(Math.max(...allRec.map(r=>new Date(r.date)))):null;
        const daysSinceLastVisit = latest? Math.floor((new Date()-latest)/(1000*60*60*24)) : null;

        let absentColor='rgba(234,242,255,.7)';
        if (daysSinceLastVisit < 30) absentColor='#22c55e';
        else if (daysSinceLastVisit <= 90) absentColor='#fbbf24';
        else absentColor='#fb7185';

        let totalColor='rgba(234,242,255,.75)', totalExtra='', totalIcon='';
        if (totalAmount < 50000) totalColor='#fb7185';
        else if (totalAmount <= 99999) totalColor='#22c55e';
        else if (totalAmount <= 200000) totalColor='#fbbf24';
        else { totalColor='#7dd3fc'; totalExtra='font-weight:900;'; totalIcon=' üíé'; }

        let avgColor='rgba(234,242,255,.75)';
        if (avg < 5000) avgColor='#fb7185';
        else if (avg <= 9999) avgColor='#22c55e';
        else avgColor='#fbbf24';

        const lastVisitText = daysSinceLastVisit != null
          ? `<span style="color:${absentColor}; font-weight:900;">‡πÑ‡∏°‡πà‡∏°‡∏≤ ${daysSinceLastVisit} ‡∏ß‡∏±‡∏ô</span>` : `<span style="opacity:.8;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>`;

        const isNewCustomer = monthRange.enabled
          ? allRec.filter(r => ymNum(dateYM(r.date)) < ymNum(monthRange.startYM)).length === 0
          : allRec.filter(r => r.date < `${formatYM(viewingDate)}-01`).length === 0;
        const newBadge = isNewCustomer ? `<span style="color:#fb7185; font-weight:900;"> ¬∑ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</span>` : "";

        return `
        <li>
          <span class="name" style="cursor:pointer;" onclick="openCustomerModal('${key}')">${i+11}. ${esc(c.name)}${newBadge}</span>
          <span class="date">
            (üí≥ <span style="color:${avgColor}; font-weight:900;">${avg.toLocaleString()}</span> √ó ${totalVisits}
             ¬∑ üí∞ <span style="color:${totalColor}; ${totalExtra}">${totalAmount.toLocaleString()}${totalIcon}</span>
             ¬∑ ${lastVisitText})
          </span>
          <span class="amount">${c.amount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
        </li>`;
      }).join('');
    } else {
      listEl.style.display = "none";
    }
  }

  function refreshCustomerList(){
    const listEl = document.getElementById("allCustomerList");
    if(listEl.style.display==="block"){ listEl.style.display="none"; toggleCustomerList(); }
  }

  function escapeHTML(s=''){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) );}
  function closeCustomerModal(){ document.getElementById("customer-modal").style.display = "none"; }
  function formatDate(d){ if(!d) return ''; const [y,m,day]=d.split('-'); return `${day}/${m}/${y.slice(-2)}`; }

  // ===== Customer Modal (Sale Pitch removed) =====
  function openCustomerModal(key) {
    const [name, phone = ''] = String(key).split('|');
    const norm = s => (s || '').trim().toLowerCase();

    const records = allCustomerRecords.filter(r =>
      norm(r.name) === norm(name) &&
      norm(r.phone || '') === norm(phone)
    );

    if (!records.length) {
      alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ');
      return;
    }

    records.sort((a, b) => b.date.localeCompare(a.date));

    const customer = { name: records[0].name, phone: records[0].phone || '-', opd: records[0].opd || '-' };

    const lastDateStr = (records[0].date || '').slice(0, 10);
    const baseDate = new Date();
    const lastDate = new Date(lastDateStr);
    const daysAbsent = isNaN(lastDate) ? 0 : Math.floor((baseDate - lastDate) / (1000 * 60 * 60 * 24));

    const totalVisits = records.length;

    const paidRecords = records.filter(r => parseFloat(r.amount || 0) > 0);
    const paidVisits = paidRecords.length;
    const totalAmount = paidRecords.reduce((s, r) => s + parseFloat(r.amount || 0), 0);
    const average = paidVisits > 0 ? Math.round(totalAmount / paidVisits) : 0;

    const allItems = {};
    records.forEach(r => {
      (r.items || []).forEach(item => {
        let n = item;
        const m = item.match(/\((.*?)\)/);
        n = m ? m[1] : item.split(' - ')[0];
        const q = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
        const qty = q ? parseInt(q[1]) : 1;
        allItems[n] = (allItems[n] || 0) + qty;
      });
    });

    const categoryMap = {
      "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": ["Aestox 50 u", "Aestox 100 u", "Allergan 50 u", "Allergan 100 u", "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î", "‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß", "Nabota"],
      "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥", "Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á", "E.P.T.Q ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢", "Restylane ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢"],
      "Fat/Hifu": ["Bromi", "Sisi", "HIFU", "HIFU ‡πÅ‡∏ñ‡∏°"],
      "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": ["Meso Chanel", "P - Cell", "Aquatic", "Hestina", "Exosome", "Rejuran", "Belotero Revive", "Sculptra", "Juvelook", "Aesthefill", "PRP", "Mesowink", "‡∏™‡∏∞‡∏Å‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "Alphaarbutin", "Transamine", "Biocollagen"],
      "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster"],
      "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": ["‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤", "‡∏ú‡∏•‡∏±‡∏Å‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô", "‡∏õ‡∏±‡πà‡∏ô RF", "‡∏Å‡∏î‡∏™‡∏¥‡∏ß", "subcision‡∏™‡∏¥‡∏ß"],
      "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": ["‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤", "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤", "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÑ‡∏´‡∏° PDO", "‡πÑ‡∏´‡∏° Collagen", "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô/‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏™‡∏•‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå", "PRP‡∏ú‡∏°", "‡∏à‡∏µ‡πâ‡πÑ‡∏ù"],
      "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©": []
    };

    const categorizedItems = {};
    for (const [cat, names] of Object.entries(categoryMap)) {
      names.forEach(n => {
        if (allItems[n]) {
          (categorizedItems[cat] ||= []).push(`${escapeHTML(n)} : ${allItems[n]}`);
          delete allItems[n];
        }
      });
    }
    if (Object.keys(allItems).length) {
      (categorizedItems["‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] ||= []).push(...Object.entries(allItems).map(([n, q]) => `${escapeHTML(n)} : ${q}`));
    }

    const itemSummary = Object.entries(categorizedItems)
      .map(([cat, items]) => `
        <div style="margin-bottom:6px;">
          <b>${escapeHTML(cat)}</b>: <span style="opacity:.9;">${items.join(" ¬∑ ")}</span>
        </div>
      `).join("");

    const historyHtml = records.map(r => {
      const items = (r.items || []).map(item => {
        const m = item.match(/\((.*?)\)/);
        const name = m ? m[1] : item.split(" - ")[0];
        const q = item.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/);
        const qty = q ? parseInt(q[1]) : 1;
        return `<li style="margin:3px 0;">${escapeHTML(name)} : <b>${qty}</b></li>`;
      }).join("");

      const noteText = r.note
        ? `<div style="font-size:11px; margin-top:6px; opacity:.85;">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${escapeHTML(r.note)}</div>`
        : "";

      return `
        <div style="margin-bottom:14px;">
          <div style="font-weight:900; font-size:12px;">üìÖ ${formatDate((r.date || '').slice(0, 10))}</div>
          <ul style="padding-left:16px; margin:6px 0 0; font-size:12px; opacity:.92;">${items}</ul>
          <div style="margin-top:6px; font-size:12px; color:#7dd3fc; font-weight:900;">üíµ ${Math.round(parseFloat(r.amount || 0)).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
          ${noteText}
          <div style="height:1px; background: rgba(255,255,255,.10); margin:10px 0;"></div>
        </div>
      `;
    }).join("");

    const daysAbsentText = `<span style="color:#fb7185; font-weight:900;">(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß: ${daysAbsent} ‡∏ß‡∏±‡∏ô)</span>`;

    document.getElementById("modal-content").innerHTML = `
      <div style="display:flex; flex-wrap:wrap; justify-content:space-between; gap:10px; align-items:flex-start;">
        <div>
          <div style="font-size:18px; font-weight:900;">üìá ${escapeHTML(customer.name)}</div>
          <div style="font-size:12px; opacity:.85; margin-top:2px;">üÜî OPD: ${escapeHTML(customer.opd)}</div>
          <div style="font-size:12px; opacity:.85;">üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${escapeHTML(customer.phone)}</div>
          <div style="font-size:12px; opacity:.85;">üìÖ ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${formatDate(lastDateStr)} ${daysAbsentText}</div>
        </div>
        <div style="min-width:220px;">
          <div class="badge">üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${Math.round(totalAmount).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
          <div class="badge">üîÅ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ${totalVisits} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
          <div class="badge">üí≥ ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏•: ${average.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
        </div>
      </div>

      <div style="height:1px; background: rgba(255,255,255,.10); margin:14px 0;"></div>

      <div style="font-weight:900; font-size:13px; margin-bottom:8px;">üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      <div style="font-size:12px; opacity:.92; line-height:1.55;">${itemSummary || '-'}</div>

      <div style="height:1px; background: rgba(255,255,255,.10); margin:14px 0;"></div>

      <div style="font-weight:900; font-size:13px; margin-bottom:8px;">üßæ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</div>
      ${historyHtml}
    `;

    document.getElementById("customer-modal").style.display = 'flex';
  }

  // ===== Modal close on backdrop click =====
  document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("customer-modal");
    const box = document.getElementById("customer-modal-box");
    if (modal && box) modal.addEventListener("click", e => { if (!box.contains(e.target)) closeCustomerModal(); });
  });

  // ===== Filter UI =====
  const productCategories = {
    "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Ñ": ["Aestox 50 u", "Aestox 100 u", "Allergan 50 u", "Allergan 100 u"],
    "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå": ["Neuramis ‡∏™‡∏µ‡∏î‡∏≥", "Neuramis ‡∏™‡∏µ‡∏ó‡∏≠‡∏á", "E.P.T.Q", "Restylane"],
    "‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß": ["Meso Chanel", "P - Cell", "Aquatic", "Hestina", "Exosome", "Rejuran", "Belotero Revive", "Sculptra", "Juvelook", "Aesthefill"],
    "‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏ß": ["Snow White", "Super Aurawhite", "Vitamin Mix", "Brain Booster", "Energy Booster"],
    "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå": ["‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏¥‡∏ß", "‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ù‡πâ‡∏≤"],
    "Fat/Hifu": ["Bromi", "Sisi", "HIFU", "HIFU ‡πÅ‡∏ñ‡∏°"],
    "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": ["‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏•‡∏≤‡∏¢‡∏ù‡πâ‡∏≤", "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ô‡∏ù‡πâ‡∏≤", "‡πÑ‡∏´‡∏°‡∏•‡∏¥‡∏ü‡∏ó‡πå‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÑ‡∏´‡∏° PDO", "‡πÑ‡∏´‡∏° Collagen"]
  };

  const filterUI = document.createElement("div");
  filterUI.innerHTML = `
    <div class="filter-section">
      <h3>üîç ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>

      <div class="inline-field" style="margin-top:10px;">
        <label>üß¥ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ã‡∏∑‡πâ‡∏≠</label>
        <button type="button" class="add-product-button" onclick="addProductSelect()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      </div>
      <div id="productListContainer" style="margin-bottom:12px;"></div>

      <div class="inline-field">
        <label>üìÖ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
        <div class="input-pair">
          <input type="date" id="startDate">
          <span style="opacity:.7;">‚Äì</span>
          <input type="date" id="endDate">
        </div>
      </div>

      <div class="inline-field">
        <label>üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏≤‡∏ó)</label>
        <div class="input-pair">
          <input type="number" id="minTotal" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
          <span style="opacity:.7;">‚Äì</span>
          <input type="number" id="maxTotal" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
        </div>
      </div>

      <div class="inline-field">
        <label>üìÑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏°‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</label>
        <div class="input-pair">
          <input type="number" id="minVisits" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
          <span style="opacity:.7;">‚Äì</span>
          <input type="number" id="maxVisits" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
        </div>
      </div>

      <div class="inline-field">
        <label>‚è≥ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</label>
        <div class="input-pair">
          <input type="number" id="minAbsent" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
          <span style="opacity:.7;">‚Äì</span>
          <input type="number" id="maxAbsent" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
        </div>
      </div>

      <div class="inline-field">
        <label>üí≥ ‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏• (‡∏ö‡∏≤‡∏ó)</label>
        <div class="input-pair">
          <input type="number" id="minAvg" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
          <span style="opacity:.7;">‚Äì</span>
          <input type="number" id="maxAvg" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
        </div>
      </div>

      <div class="inline-field">
        <label>üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
        <input type="text" id="customerName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" style="width:min(360px, 100%);">
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px;">
        <button type="button" onclick="filterGeneral()" class="search-button">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <button type="button" onclick="resetFilters()" class="add-product-button">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤</button>
        <button type="button" onclick="openGroupModal()" class="add-product-button">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
      </div>

      <div id="filterResults" style="margin-top: 18px; font-size: 13px;"></div>
    </div>
  `;

  const placeholder = document.getElementById('filter-placeholder');
  if (placeholder) placeholder.appendChild(filterUI);
  else document.body.appendChild(filterUI);

  function addProductSelect() {
    const container = document.getElementById("productListContainer");
    const wrapper = document.createElement("div");
    wrapper.style.marginBottom = "8px";

    const select = document.createElement("select");
    select.className = "productInput";
    select.style.width = "min(360px, 100%)";

    const def = document.createElement("option");
    def.textContent = "‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
    def.value = "";
    def.disabled = true;
    def.selected = true;
    select.appendChild(def);

    Object.entries(productCategories).forEach(([cat, items]) => {
      const group = document.createElement("optgroup");
      group.label = cat;
      items.forEach(p => {
        const option = document.createElement("option");
        option.value = p;
        option.textContent = p;
        group.appendChild(option);
      });
      select.appendChild(group);
    });

    wrapper.appendChild(select);
    container.appendChild(wrapper);
  }

  function filterGeneral() {
    const nameInput = document.getElementById("customerName").value.trim().toLowerCase();
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    const minTotal = parseFloat(document.getElementById("minTotal").value) || 0;
    const maxTotal = parseFloat(document.getElementById("maxTotal").value) || Infinity;
    const minVisits = parseInt(document.getElementById("minVisits").value) || 0;
    const maxVisits = parseInt(document.getElementById("maxVisits").value) || Infinity;
    const minAbsent = parseInt(document.getElementById("minAbsent").value) || 0;
    const maxAbsent = parseInt(document.getElementById("maxAbsent").value) || Infinity;
    const minAvg = parseFloat(document.getElementById("minAvg").value) || 0;
    const maxAvg = parseFloat(document.getElementById("maxAvg").value) || Infinity;

    const selectedProducts = Array.from(document.querySelectorAll('.productInput')).map(el => el.value).filter(Boolean);

    const grouped = {};
    const today = new Date();

    allCustomerRecords.forEach(r => {
      const key = `${r.name}|${r.phone}`;
      (grouped[key] ||= []).push(r);
    });

    const results = Object.entries(grouped).map(([key, records]) => {
      const name = records[0].name;

      const totalVisits = records.length;
      const paidRecords = records.filter(r => parseFloat(r.amount || 0) > 0);
      const paidVisits = paidRecords.length;
      const totalAmount = paidRecords.reduce((sum, r) => sum + parseFloat(r.amount), 0);
      const averageBill = paidVisits > 0 ? totalAmount / paidVisits : 0;

      const latestRecord = records.reduce((latest, r) =>
        new Date(r.date) > new Date(latest.date) ? r : latest,
        records[0]
      );

      const absentDays = Math.floor((today - new Date(latestRecord.date)) / (1000 * 60 * 60 * 24));
      const lastVisit = latestRecord.date;

      const allProducts = records.flatMap(r => r.items || []).map(item => {
        const match = item.match(/\((.*?)\)/);
        return match ? match[1] : item.split(" - ")[0].trim();
      });

      return { key, name, totalAmount, totalVisits, paidVisits, averageBill, absentDays, lastVisit, products: allProducts };
    }).filter(c => {
      const nameMatch = !nameInput || c.name.toLowerCase().includes(nameInput);
      const totalMatch = c.totalAmount >= minTotal && c.totalAmount <= maxTotal;
      const visitMatch = c.totalVisits >= minVisits && c.totalVisits <= maxVisits;
      const absentMatch = c.absentDays >= minAbsent && c.absentDays <= maxAbsent;
      const avgMatch = c.averageBill >= minAvg && c.averageBill <= maxAvg;
      const dateMatch = (!startDate || new Date(c.lastVisit) >= new Date(startDate)) && (!endDate || new Date(c.lastVisit) <= new Date(endDate));
      const productMatch = selectedProducts.length === 0 || selectedProducts.every(p => c.products.some(prod => prod.includes(p)));
      return nameMatch && totalMatch && visitMatch && absentMatch && avgMatch && dateMatch && productMatch;
    }).sort((a, b) => b.totalAmount - a.totalAmount);

    const html = results.map(c => {
      const formattedDate = new Date(c.lastVisit).toLocaleDateString('th-TH',{day:'numeric', month:'short', year:'2-digit'});
      return `<div style="padding:10px 0;">
        <input type="checkbox" class="selectCustomerCheckbox" value="${c.key}" style="margin-right:8px; transform: translateY(1px);">
        üìá <b style="cursor:pointer; color:#7dd3fc;" onclick="openCustomerModal('${c.key}')">${esc(c.name)}</b>
        <span style="opacity:.85;">¬∑ üí∞ ${c.totalAmount.toLocaleString()} ¬∑ üí≥ ${Math.round(c.averageBill).toLocaleString()}
        ¬∑ üîÅ ${c.totalVisits} (${c.paidVisits} ‡∏à‡πà‡∏≤‡∏¢) ¬∑ ‚è±Ô∏è ${c.absentDays} ‡∏ß‡∏±‡∏ô ¬∑ ${formattedDate}</span>
      </div>
      <div style="height:1px; background: rgba(255,255,255,.10);"></div>`;
    }).join('');

    document.getElementById("filterResults").innerHTML = `<div style="font-weight:900; margin-bottom:10px;">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ${results.length} ‡∏Ñ‡∏ô</div>` + (html || `<div style="opacity:.75;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`);
  }

  function openGroupModal() {
    const checked = Array.from(document.querySelectorAll('.selectCustomerCheckbox:checked'))
      .map(cb => cb.value);

    const box = document.getElementById("groupSelectedList");
    if (!box) return;

    if (!checked.length) {
      box.innerHTML = `<div style="padding:12px; opacity:.8;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ï‡∏¥‡πä‡∏Å checkbox ‡∏Å‡πà‡∏≠‡∏ô)</div>`;
    } else {
      box.innerHTML = checked.map((key, idx) => {
        const [name, phone=''] = String(key).split('|');
        return `
          <div class="customer-entry">
            <div class="customer-name">${idx+1}. ${escapeHTML(name || '-')}</div>
            <div class="date-info">
              <span class="date-box">üìû ${escapeHTML(phone || '-')}</span>
              <span class="date-box" style="cursor:pointer; border-color: rgba(125,211,252,.25);" onclick="openCustomerModal('${key}')">üîç ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
            </div>
          </div>
        `;
      }).join('');
    }

    document.getElementById("group-modal").style.display = "flex";
  }

  function resetFilters(){
    ['startDate','endDate','minTotal','maxTotal','minVisits','maxVisits','minAbsent','maxAbsent','minAvg','maxAvg','customerName'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.value = '';
    });
    const container = document.getElementById("productListContainer");
    if(container) container.innerHTML = '';
    const results = document.getElementById("filterResults");
    if(results) results.innerHTML = '';
  }

  // ===== Range modal =====
  function openRangeModal(){
    const s = document.getElementById('rangeStartModal');
    const e = document.getElementById('rangeEndModal');
    s.value = monthRange.startYM || '';
    e.value = monthRange.endYM || '';
    document.getElementById('rangeModal').style.display = 'flex';
  }
  function closeRangeModal(){ document.getElementById('rangeModal').style.display = 'none'; }
  function applyRangeFromModal(){
    const s = document.getElementById('rangeStartModal').value;
    const e = document.getElementById('rangeEndModal').value;
    if(!s || !e){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'); return; }
    if(ymNum(s) > ymNum(e)){ alert('‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'); return; }
    monthRange.enabled = true;
    monthRange.startYM = s;
    monthRange.endYM = e;
    closeRangeModal();
    fetchDataAndUpdate();
  }
  function clearRange(){
    monthRange.enabled = false;
    monthRange.startYM = monthRange.endYM = null;
    closeRangeModal();
    fetchDataAndUpdate();
  }

  // ===== Popup ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô =====
  function openMonthlySalesPopup(){
    const fmtYM = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const parseQty = (items=[]) => items.reduce((s,it)=>{ const m = it.match(/- (\d+) ‡∏ä‡∏¥‡πâ‡∏ô/); return s + (m? parseInt(m[1]):1); },0);
    const thDateWithWeekday = (iso)=>{ const d = new Date(iso); const wd = d.toLocaleDateString('th-TH',{ weekday:'long' }); const dt = d.toLocaleDateString('th-TH',{ day:'2-digit', month:'short', year:'numeric' }); return `${dt} (${wd})`; };

    const now = new Date();
    const curY = viewingDate.getFullYear();
    const curM = viewingDate.getMonth();

    let curStart = new Date(curY, curM, 1);
    let curEnd   = (curY===now.getFullYear() && curM===now.getMonth())
                    ? new Date(now.getFullYear(), now.getMonth(), now.getDate())
                    : new Date(curY, curM+1, 0);

    const prevStart = new Date(curY, curM-1, 1);
    const prevEnd   = new Date(curY, curM, 0);

    const curPrefix  = fmtYM(curStart);
    const prevPrefix = fmtYM(prevStart);

    function dailySummary(from, to, prefix){
      const map = {};
      allSalesRecords.forEach(r=>{
        if(!r.date.startsWith(prefix)) return;
        const d = new Date(r.date);
        if(d < from || d > to) return;

        if(!map[r.date]) map[r.date] = { total:0, bills:0, items:0, customers:new Set() };
        map[r.date].total   += parseFloat(r.amount||0);
        map[r.date].bills   += 1;
        map[r.date].items   += parseQty(r.items);
        map[r.date].customers.add(`${r.name}|${r.phone}`);
      });

      const rows = Object.entries(map)
        .map(([date, v])=>({ date, total:v.total, bills:v.bills, avgBill: v.bills ? Math.round(v.total / v.bills) : 0, items:v.items, customers:v.customers.size }))
        .filter(r=>r.total>0)
        .sort((a,b)=>a.date.localeCompare(b.date));

      const sum = rows.reduce((s,r)=>s+r.total,0);
      const days = rows.length;
      const avgPerDay = days? Math.round(sum/days):0;
      const best = rows.slice().sort((a,b)=>b.total-a.total)[0] || null;
      const worst = rows.slice().sort((a,b)=>a.total-b.total)[0] || null;

      const wdTotal = {0:0,1:0,2:0,3:0,4:0,5:0,6:0};
      rows.forEach(r=>{ const wd = new Date(r.date).getDay(); wdTotal[wd] += r.total; });

      return { rows, sum, days, avgPerDay, best, worst, wdTotal };
    }

    const cur = dailySummary(curStart, curEnd, curPrefix);
    const prev = dailySummary(prevStart, prevEnd, prevPrefix);

    const toRow = r => `
      <tr>
        <td>${thDateWithWeekday(r.date)}</td>
        <td style="text-align:right;">${r.total.toLocaleString()}</td>
        <td style="text-align:right;">${r.bills.toLocaleString()}</td>
        <td style="text-align:right;">${r.avgBill.toLocaleString()}</td>
        <td style="text-align:right;">${r.items.toLocaleString()}</td>
        <td style="text-align:right;">${r.customers.toLocaleString()}</td>
      </tr>`;

    const wdNames = ['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™'];
    const wdBadges = (wdTotal)=> wdNames.map((n,i)=>`<span class="badge" title="‡∏£‡∏ß‡∏° ${n}">${n}: ${Math.round(wdTotal[i]).toLocaleString()}</span>`).join(' ');

    const curTitle = new Date(curStart).toLocaleString('th-TH',{month:'long'}) + ' ' + (curStart.getFullYear()+543);
    const prevTitle= new Date(prevStart).toLocaleString('th-TH',{month:'long'}) + ' ' + (prevStart.getFullYear()+543);

    const html = `
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px;">
        <div style="font-weight:900; font-size:14px;">üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‚Äî ${curTitle}</div>
        <button onclick="closeCustomerModal()" title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á">‚úï</button>
      </div>

      <div style="margin-bottom:10px;">
        <span class="badge">‡∏£‡∏ß‡∏°: ${cur.sum.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
        <span class="badge">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏≤‡∏¢: ${cur.days} ‡∏ß‡∏±‡∏ô</span>
        <span class="badge">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô: ${cur.avgPerDay.toLocaleString()}</span>
        ${cur.best ? `<span class="badge">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${thDateWithWeekday(cur.best.date)} = ${cur.best.total.toLocaleString()}</span>`:''}
        ${cur.worst ? `<span class="badge">‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î: ${thDateWithWeekday(cur.worst.date)} = ${cur.worst.total.toLocaleString()}</span>`:''}
      </div>
      <div style="margin-bottom:10px;">${wdBadges(cur.wdTotal)}</div>
      <table class="table-mini">
        <thead>
          <tr>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ß‡∏±‡∏ô)</th>
            <th style="text-align:right;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
            <th style="text-align:right;">‡∏ö‡∏¥‡∏•</th>
            <th style="text-align:right;">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏•</th>
            <th style="text-align:right;">‡∏ä‡∏¥‡πâ‡∏ô</th>
            <th style="text-align:right;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
          </tr>
        </thead>
        <tbody>${cur.rows.map(toRow).join('')}</tbody>
      </table>

      <div style="height:1px; background: rgba(255,255,255,.10); margin:16px 0;"></div>

      <div style="font-weight:900; font-size:14px; margin-bottom:10px;">üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Äî ${prevTitle}</div>
      <div style="margin-bottom:10px;">
        <span class="badge">‡∏£‡∏ß‡∏°: ${prev.sum.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
        <span class="badge">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏≤‡∏¢: ${prev.days} ‡∏ß‡∏±‡∏ô</span>
        <span class="badge">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô: ${prev.avgPerDay.toLocaleString()}</span>
        ${prev.best ? `<span class="badge">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${thDateWithWeekday(prev.best.date)} = ${prev.best.total.toLocaleString()}</span>`:''}
        ${prev.worst ? `<span class="badge">‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î: ${thDateWithWeekday(prev.worst.date)} = ${prev.worst.total.toLocaleString()}</span>`:''}
      </div>
      <div style="margin-bottom:10px;">${wdBadges(prev.wdTotal)}</div>
      <table class="table-mini">
        <thead>
          <tr>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ß‡∏±‡∏ô)</th>
            <th style="text-align:right;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
            <th style="text-align:right;">‡∏ö‡∏¥‡∏•</th>
            <th style="text-align:right;">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏•</th>
            <th style="text-align:right;">‡∏ä‡∏¥‡πâ‡∏ô</th>
            <th style="text-align:right;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
          </tr>
        </thead>
        <tbody>${prev.rows.map(toRow).join('')}</tbody>
      </table>
    `;

    document.getElementById('modal-content').innerHTML = html;
    document.getElementById('customer-modal').style.display = 'flex';
  }

  // ===== Lead Score (no pitch fetch) =====
  function recencyScore(absentDays) {
    if (absentDays <= 45) return 0;
    if (absentDays <= 90)  return 20 + (absentDays - 46) * (20 / (90 - 46));
    if (absentDays <= 180) return 40 - (absentDays - 90) * (15 / (180 - 90));
    if (absentDays <= 365) return 25 - (absentDays - 180) * (15 / (365 - 180));
    if (absentDays <= 730) return 10 - (absentDays - 365) * (7 / (730 - 365));
    if (absentDays <= 1460) return 3 - (absentDays - 730) * (2 / (1460 - 730));
    return 0.5;
  }
  function valueScore(totalAmount) {
    if (totalAmount >= 200000) return 45;
    if (totalAmount >= 100000) return 40;
    if (totalAmount >= 50000)  return 32;
    if (totalAmount >= 20000)  return 24;
    if (totalAmount >= 10000)  return 16;
    if (totalAmount >= 5000)   return 10;
    if (totalAmount >= 3000)   return 6;
    if (totalAmount >= 1000)   return 3;
    return 0;
  }
  function visitScore(totalVisits) {
    if (totalVisits >= 12) return 18;
    if (totalVisits >= 8)  return 14;
    if (totalVisits >= 5)  return 10;
    if (totalVisits >= 3)  return 6;
    if (totalVisits >= 2)  return 3;
    return 0;
  }
  function avgScore(averageBill) {
    if (averageBill >= 20000) return 18;
    if (averageBill >= 12000) return 14;
    if (averageBill >= 8000)  return 10;
    if (averageBill >= 5000)  return 7;
    if (averageBill >= 3000)  return 4;
    if (averageBill >= 1500)  return 2;
    return 0;
  }
  function computeLeadScoreForCustomer(core) {
    const totalAmount  = core.totalAmount || 0;
    const totalVisits  = core.totalVisits || 0;
    const averageBill  = core.averageBill || 0;
    const absentDays   = core.absentDays || 0;

    if (totalAmount < 2000 && totalVisits <= 1) return 0;

    const r = recencyScore(absentDays);
    const v = valueScore(totalAmount);
    const f = visitScore(totalVisits);
    const a = avgScore(averageBill);

    let vipBoost = 0;
    const isVIP = (totalAmount >= 100000) || (averageBill >= 10000);
    if (isVIP) {
      if (absentDays >= 60 && absentDays <= 210) vipBoost = 10;
      else if (absentDays <= 365) vipBoost = 5;
    }
    return Math.round(r + v + f + a + vipBoost);
  }

  async function buildLeadScoreList() {
    const ul = document.getElementById('leadScoreList');
    if (!ul || !allCustomerRecords.length) return;

    const grouped = {};
    const today = new Date();

    allCustomerRecords.forEach(r => {
      const key = `${r.name}|${r.phone}`;
      if (!grouped[key]) {
        grouped[key] = { key, name: r.name, phone: r.phone || '-', opd: r.opd || '-', records: [] };
      }
      grouped[key].records.push(r);
    });

    let scored = Object.values(grouped).map(c => {
      const recs = c.records;
      const totalVisits = recs.length;
      const paid = recs.filter(r => parseFloat(r.amount || 0) > 0);
      const paidVisits = paid.length;
      const totalAmount = paid.reduce((s, r) => s + parseFloat(r.amount || 0), 0);
      const averageBill = paidVisits > 0 ? totalAmount / paidVisits : 0;

      const latest = recs.reduce((last, r) => new Date(r.date) > new Date(last.date) ? r : last, recs[0]);
      const lastDate = new Date(latest.date);
      const absentDays = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));

      const core = { key: c.key, name: c.name, phone: c.phone, opd: c.opd, totalVisits, totalAmount, averageBill, absentDays, lastDate: latest.date };
      const score = computeLeadScoreForCustomer(core);
      return { ...core, score };
    });

    const topLeadCandidates = scored
      .filter(c => c.absentDays > 45)
      .filter(c => c.score >= 20)
      .sort((a, b) => b.score - a.score)
      .slice(0, 45);

    if (!topLeadCandidates.length) {
      ul.innerHTML = `<li style="text-align:center; padding:16px; opacity:.8;">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå (‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 45 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏û‡∏≠‡∏™‡∏°‡∏Ñ‡∏ß‡∏£)
      </li>`;
      return;
    }

    ul.innerHTML = topLeadCandidates.map(c => {
      const total = Math.round(c.totalAmount || 0).toLocaleString();
      const last  = new Date(c.lastDate).toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: '2-digit' });

      return `
        <li>
          <span class="lead-name" onclick="openCustomerModal('${c.key}')">${escapeHTML(c.name || '-')}</span>
          <span class="lead-score-badge">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${c.score}</span>
          <span class="lead-score-meta">
            ‚è≥ ‡πÑ‡∏°‡πà‡∏°‡∏≤ <span class="lead-absent">${c.absentDays} ‡∏ß‡∏±‡∏ô</span>
            ¬∑ üí∞ ‡∏£‡∏ß‡∏° <b>${total}</b> ‡∏ö.
            ¬∑ üìÖ ‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <b>${last}</b>
          </span>
          <span class="lead-money">${Math.round(c.averageBill || 0).toLocaleString()} /‡∏ö‡∏¥‡∏•</span>
        </li>`;
    }).join('');
  }

  // Start load
  document.addEventListener('DOMContentLoaded', function() {
    fetchDataAndUpdate();
    fetchAllCustomerRecords();
  });
</script>

{% endblock %}
{% include "floating_menu.html" %}
</body>
</html>
