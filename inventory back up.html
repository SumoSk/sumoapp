<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <title>‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå | Inventory</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #00897b;
      --primary-light: #e0f2f1;
      --primary-dark: #00695c;
      --text-main: #37474f;
      --text-light: #78909c;
      --bg-body: #f0f4f4;
      --white: #ffffff;
      --shadow-card: 0 4px 20px rgba(0,0,0,0.06);
      --radius: 16px;
      --success: #43a047;
      --danger: #e53935;
    }

    html { -webkit-text-size-adjust:100%; text-size-adjust:100%; box-sizing: border-box; }
    *, *:before, *:after { box-sizing: inherit; }

    body {
      font-family: 'Prompt', sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      margin: 0;
      padding: 20px;
      padding-bottom: 140px; /* ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏≠‡∏¢ */
      font-size: 14px;
      line-height: 1.5;
    }

    h2 {
      text-align: center;
      color: var(--primary-dark);
      margin: 0 0 20px;
      font-weight: 600;
      font-size: 1.5rem;
      letter-spacing: -0.5px;
    }

    /* --- Month Navigation --- */
    .month-nav {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .nav-btn {
      background: var(--white);
      color: var(--primary);
      border: 1px solid var(--primary);
      padding: 8px 20px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 50px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .nav-btn:hover:not(:disabled) {
      background: var(--primary);
      color: var(--white);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,121,107,0.3);
    }
    .nav-btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: #ccc;
      color: #999;
      background: #f9f9f9;
    }
    .nav-btn svg { width: 18px; height: 18px; fill: currentColor; }

    /* --- Card Container for Table --- */
    .table-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow-card);
      overflow: hidden; /* ‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô */
      border: 1px solid rgba(0,0,0,0.02);
    }

    /* --- Table Styles --- */
    .table-wrapper {
      overflow-x: auto;
      width: 100%;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px; /* ‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏µ‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    }
    th, td {
      padding: 12px 10px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    th {
      background: var(--primary);
      color: var(--white);
      font-weight: 500;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    /* ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà input ‡∏ö‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    th input[type="date"] {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.4);
      color: #fff;
      padding: 4px 8px;
      border-radius: 6px;
      font-family: inherit;
      cursor: pointer;
    }
    th input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }

    /* ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ */
    td.name {
      text-align: left;
      font-weight: 500;
      color: var(--primary-dark);
      min-width: 150px;
    }
    
    /* ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà */
    tr.category-header {
      background: var(--primary-light);
      text-align: left;
    }
    tr.category-header td {
      font-weight: 600;
      color: var(--primary-dark);
      padding: 10px 15px;
      font-size: 1.05em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-top: 2px solid #fff;
    }
    tr.category-header td svg {
        vertical-align: middle; margin-right: 6px; width: 18px; height: 18px;
    }

    /* ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô */
    td input[type="number"] {
      width: 70px;
      text-align: center;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border 0.2s;
      background: #fafafa;
    }
    td input[type="number"]:focus {
      outline: none;
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(0,137,123,0.1);
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÅ‡∏ñ‡∏ß */
    .btn-single {
      background: var(--primary-light);
      color: var(--primary-dark);
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-single:hover {
      background: var(--primary);
      color: #fff;
    }

    /* Logic ‡∏™‡∏µ */
    .latest-cell { position: relative; }
    .latest-val { font-weight: 700; font-size: 1.1em; color: #333; }
    .latest-val.val-low { color: var(--danger); }
    
    .diff-badge {
      display: inline-block;
      font-size: 0.85em;
      margin-left: 6px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #f5f5f5;
      font-weight: 500;
    }
    .diff-up { color: var(--success); background: #e8f5e9; }
    .diff-down { color: var(--danger); background: #ffebee; }
    .diff-flat { color: #9aa0a6; background: #f1f3f4; }

    /* --- Action Bar (Bottom) --- */
    .btn-bar {
      margin-top: 30px;
      display: flex;
      justify-content: center;
      gap: 16px;
    }
    .action-btn {
      border: none;
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #btnAdd {
      background: #fff; color: var(--primary); border: 1px solid var(--primary);
    }
    #btnAdd:hover { background: #f0fdfc; transform: translateY(-2px); }
    
    #btnSaveAll {
      background: linear-gradient(135deg, #00897b, #004d40);
      color: #fff;
    }
    #btnSaveAll:hover {
      box-shadow: 0 6px 15px rgba(0,137,123,0.4);
      transform: translateY(-2px);
    }

    /* --- Popup --- */
    #popupForm {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      display: none; justify-content: center; align-items: center; z-index: 9999;
    }
    .form-box {
      background: #fff; padding: 30px; border-radius: 20px;
      width: 90%; max-width: 400px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
      animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes popIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .form-box h3 { text-align: center; color: var(--primary); margin-bottom: 20px; font-size: 1.3em; }
    .form-box label { font-size: 0.9em; color: var(--text-light); margin-bottom: 5px; display: block; }
    .form-box input {
      width: 100%; padding: 12px; margin-bottom: 15px;
      border: 1px solid #ddd; border-radius: 10px;
      font-family: inherit; font-size: 1em;
    }
    .form-box input:focus { border-color: var(--primary); outline: none; }
    
    .popup-actions { display: flex; gap: 10px; margin-top: 10px; }
    .popup-actions button {
      flex: 1; padding: 12px; border: none; border-radius: 10px;
      font-size: 1em; font-weight: 600; cursor: pointer;
    }
    .submit-btn { background: var(--primary); color: #fff; }
    .cancel-btn { background: #f5f5f5; color: #666; }

    /* --- Floating Menu --- */
    .floating-toggle {
      position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
      width: 65px; height: 65px; cursor: pointer; z-index: 2000;
      transition: transform 0.2s;
    }
    .floating-toggle:hover { transform: translateX(-50%) scale(1.05); }
    .floating-toggle img { width: 100%; height: 100%; drop-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    
    .floating-menu {
      position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,0.95);
      border-radius: 24px; padding: 15px;
      display: none; flex-direction: column; gap: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      z-index: 1999; backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.5);
      max-height: 60vh; overflow-y: auto;
    }
    .floating-menu a { transition: transform 0.2s; }
    .floating-menu a:hover { transform: scale(1.1); }
    .floating-menu img { width: 50px; height: 50px; }

  </style>
</head>
<body>

  <h2>üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</h2>

  <div class="month-nav">
    <button class="nav-btn" id="btnPrev" type="button">
      <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
      ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
    </button>
    <button class="nav-btn" id="btnNext" type="button">
      ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
      <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
    </button>
  </div>

  <div class="table-card">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr id="tableHeader"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <div class="btn-bar">
    <button class="action-btn" id="btnAdd" type="button">
      <span style="font-size:1.2em">Ôºã</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    </button>
    <button class="action-btn" id="btnSaveAll" type="button">
      <span style="font-size:1.2em">üíæ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    </button>
  </div>

  <div id="popupForm">
    <div class="form-box">
      <h3>‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÉ‡∏´‡∏°‡πà</h3>
      <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</label>
      <input type="text" id="newName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Syringe 20ml" />
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
      <input type="number" id="newQty" min="0" placeholder="0" inputmode="numeric" />
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö</label>
      <input type="date" id="newDate" />
      <div class="popup-actions">
        <button class="cancel-btn" id="popupCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="submit-btn" id="popupSubmit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <div id="floatingToggle" class="floating-toggle">
    <img src="{{ url_for('static', filename='icon/icon_menu_toggle.png') }}" alt="menu">
  </div>
  <div id="floatingMenu" class="floating-menu">
    <a href="{{ url_for('dashboard') }}"><img src="{{ url_for('static', filename='icon/icon_dashboard.png') }}" title="Dashboard"></a>
    <a href="{{ url_for('sale_summary') }}"><img src="{{ url_for('static', filename='icon/icon_sale_summary.png') }}" title="Sale summary"></a>
    <a href="{{ url_for('crm') }}"><img src="{{ url_for('static', filename='icon/icon_crm.png') }}" title="CRM"></a>
    <a href="{{ url_for('record_sales') }}"><img src="{{ url_for('static', filename='icon/icon_record_sales.png') }}" title="Record sales"></a>
    <a href="{{ url_for('customer_list') }}"><img src="{{ url_for('static', filename='icon/icon_customer_list.png') }}" title="Customer list"></a>
    <a href="{{ url_for('record_customer') }}"><img src="{{ url_for('static', filename='icon/icon_customer_history.png') }}" title="Record customer"></a>
    <a href="{{ url_for('oldsaledata') }}"><img src="{{ url_for('static', filename='icon/icon_old_customers.png') }}" title="Old customers"></a>
    <a href="{{ url_for('inventory') }}"><img src="{{ url_for('static', filename='icon/icon_inventory.png') }}" title="Inventory"></a>
    <a href="{{ url_for('staff') }}"><img src="{{ url_for('static', filename='icon/icon_staff.png') }}" title="Staff"></a>
    <a href="{{ url_for('appointments') }}"><img src="{{ url_for('static', filename='icon/icon_appointments.png') }}" title="Appointments"></a>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    
    // ===== 1. Categorized Data =====
    // ‡∏à‡∏±‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠: ‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠/‡∏¢‡∏≤/‡∏™‡∏Å‡∏¥‡∏ô‡πÅ‡∏Ñ‡∏£‡πå ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô + ‡πÄ‡∏û‡∏¥‡πà‡∏° b12, ‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏¥‡∏ß, ‡∏≠‡∏™‡∏¥‡∏ï‡∏¥‡∏ô
    const categories = {
      "üíâ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏â‡∏µ‡∏î/‡πÄ‡∏à‡∏≤‡∏∞ (Injection)": [
        "Syringe 10","Syringe 5","Syringe 3","Syringe 1",
        "‡πÄ‡∏Ç‡πá‡∏° 32","‡πÄ‡∏Ç‡πá‡∏° 30","‡πÄ‡∏Ç‡πá‡∏° 24","‡πÄ‡∏Ç‡πá‡∏° 18Gx1","‡πÄ‡∏Ç‡πá‡∏° 18Gx1 1/2",
        "Cannula","Medicut","‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠ 24","‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠ 25","Set IV","‡∏´‡∏•‡∏≠‡∏î PRR"
      ],
      "üíß ‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠/‡∏¢‡∏≤/‡∏™‡∏Å‡∏¥‡∏ô‡πÅ‡∏Ñ‡∏£‡πå (Medicines & Liquids)": [
        // ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠
        "Nss 1000 ML","Nss 100 ML","Nss 5 ML","SWI 5 ML","Milky","B100","‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏ã‡∏µ","‡∏ä‡∏≤‡πÅ‡∏ô‡∏• #‡πÄ‡∏Ç‡πá‡∏°","‡∏¢‡∏≤‡∏ô‡∏µ‡∏î‡∏â‡∏µ‡∏î‡∏™‡∏¥‡∏ß #‡πÄ‡∏Ç‡πá‡∏°","‡∏ó‡∏£‡∏≤‡∏ô‡∏™‡∏°‡∏¥‡∏ô #‡πÄ‡∏Ç‡πá‡∏°","‡πÄ‡∏°‡πÇ‡∏™‡∏ß‡∏¥‡πâ‡∏á",
        // ‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°
        "b12", "‡∏¢‡∏≤‡∏â‡∏µ‡∏î‡∏™‡∏¥‡∏ß", "‡∏≠‡∏™‡∏¥‡∏ï‡∏¥‡∏ô",
        // ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡∏≤‡∏ó‡∏≤
        "‡∏¢‡∏≤‡∏ä‡∏≤ (‡∏Ñ‡∏£‡∏µ‡∏°)","‡∏¢‡∏≤‡∏ó‡∏≤‡∏ù‡πâ‡∏≤","‡∏¢‡∏≤‡∏ó‡∏≤‡∏™‡∏¥‡∏ß","‡∏≠‡∏∞‡πÇ‡∏•‡πÄ‡∏à‡∏•","Scrub","‡∏ó‡∏£‡∏≤‡∏ô‡∏™‡∏°‡∏¥‡∏ô"
      ],
      "üß§ ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á (Disposable)": [
        "‡∏ñ‡∏∏‡∏á‡∏°‡∏∑‡∏≠ S","‡∏™‡∏≥‡∏•‡∏µ‡∏Å‡πâ‡∏≠‡∏ô","‡∏™‡∏≥‡∏•‡∏µ‡πÅ‡∏ú‡πà‡∏ô","Swabs","‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå","‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡∏û‡∏≠‡∏£‡πå ‡πÄ‡∏ó‡∏õ‡∏Ç‡∏∏‡πà‡∏ô IV"
      ]
    };

    // ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ä‡πá‡∏Ñ
    const fixedItemList = Object.values(categories).flat();
    
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    let allData = [];
    let allDates = [];
    let uniqueMonths = [];
    let currentMonthIdx = 0;
    let groupedData = {}; // { item_name: { 'YYYY-MM-DD': qty } }

    // ===== Helpers =====
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const escapeHtml = s => String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
    
    // Today YYYY-MM-DD (Local Time aware)
    const todayIso = () => {
        const d = new Date();
        const offset = d.getTimezoneOffset() * 60000;
        return (new Date(d - offset)).toISOString().slice(0, 10);
    };

    const monthOf = d => d.slice(0,7); // 'YYYY-MM'

    function formatDateTH(dateStr){
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString('th-TH', { day:'2-digit', month:'2-digit', year:'2-digit' });
    }

    function buildGrouped(){
      groupedData = {};
      for (const row of allData) {
        (groupedData[row.item_name] ??= {})[row.date] = Number(row.quantity||0);
      }
    }

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    function computeCalendars(){
      const dateSet = new Set(allData.map(d => d.date));
      allDates = Array.from(dateSet).sort((a,b) => new Date(b) - new Date(a)); // Newest first

      const monthSet = new Set(allDates.map(d => monthOf(d)));
      uniqueMonths = Array.from(monthSet).sort((a,b) => a < b ? 1 : (a > b ? -1 : 0)); // Desc

      if (uniqueMonths.length === 0) {
        uniqueMonths = [todayIso().slice(0,7)];
      }
      currentMonthIdx = 0;
    }

    function getSelectedMonth(){ return uniqueMonths[currentMonthIdx]; }
    function getFilteredDates(){
      const ym = getSelectedMonth();
      const dates = allDates.filter(d => d.startsWith(ym)).sort(); // asc for columns
      return dates.slice(-3); // show last 3 days
    }
    function defaultInputDateForMonth(){
      const ym = getSelectedMonth();
      const dates = allDates.filter(d => d.startsWith(ym)).sort();
      if (dates.length) return dates[dates.length - 1];
      return todayIso();
    }

    // Low stock threshold logic
    function lowThresholdFor(name){
      if(name.includes("Syringe")) return 20;
      if(name.includes("‡πÄ‡∏Ç‡πá‡∏°")) return 20;
      if(name.includes("Nss")) return 5;
      return 10; // default
    }

    // ===== Fetch =====
    async function fetchData(){
      try{
        // ‡πÉ‡∏ä‡πâ Pagination Loop ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (10,000+)
        let fetchedData = [];
        let start = 0;
        let limit = 1000;
        while(true){
           const res = await fetch(`/api/inventory?offset=${start}&limit=${limit}`, { // *Note: Backend should handle param or loop internally if fixed route
             headers:{'Accept':'application/json'}
           });
           // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏≤‡πÅ‡∏Å‡πâ backend ‡πÉ‡∏´‡πâ loop ‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ route ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß
           // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤ /api/inventory ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å step ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
           if (!res.ok) throw new Error('Network err');
           const batch = await res.json();
           fetchedData = batch; 
           break; // ‡∏´‡∏¢‡∏∏‡∏î loop client side ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ backend ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß
        }

        // Normalize
        allData = (Array.isArray(fetchedData) ? fetchedData : []).map(r => {
            let dStr = r.date ? String(r.date) : todayIso();
            if (dStr.includes('T')) dStr = dStr.split('T')[0];
            dStr = dStr.substring(0, 10);
            let nameStr = r.item_name ? String(r.item_name).trim() : '';
            return {
                item_name: nameStr,
                date: dStr,
                quantity: Number(r.quantity ?? 0)
            };
        });

      }catch(e){
        console.error(e);
        allData = [];
      }
      computeCalendars();
      buildGrouped();
      renderTable();
      updateNavButtons();
    }

    // ===== Render Table with Categories =====
    function renderTable(){
      const headerRow = $('#tableHeader');
      const tbody = $('#tableBody');
      if (!headerRow || !tbody) return;

      const filteredDates = getFilteredDates();
      const inputDateDefault = defaultInputDateForMonth();

      // 1. Header
      headerRow.innerHTML =
        `<th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>` +
        filteredDates.map(d => `<th>${formatDateTH(d)}</th>`).join('') +
        `<th><input type="date" id="inputDate" value="${inputDateDefault}"></th>
         <th style="width:80px">Action</th>`;

      tbody.innerHTML = '';

      // ‡∏´‡∏≤ item ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô category (‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà)
      const allKnownItems = new Set(fixedItemList);
      const dataItems = new Set(Object.keys(groupedData));
      const uncategorized = Array.from(dataItems).filter(x => !allKnownItems.has(x)).sort();

      // ‡∏£‡∏ß‡∏° Categories + Uncategorized
      const displayMap = { ...categories };
      if(uncategorized.length > 0) {
          displayMap["üì¶ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Others)"] = uncategorized;
      }

      // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß
      Object.entries(displayMap).forEach(([catName, items]) => {
          // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ item ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
          const validItems = items.filter(name => {
              // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô fixedItemList ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏•‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô groupedData ‡∏Å‡πá‡πÇ‡∏ä‡∏ß‡πå
              return fixedItemList.includes(name) || groupedData[name]; 
          });

          if(validItems.length === 0) return;

          // Header Row ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
          const catTr = document.createElement('tr');
          catTr.className = 'category-header';
          catTr.innerHTML = `<td colspan="${filteredDates.length + 3}">${escapeHtml(catName)}</td>`;
          tbody.appendChild(catTr);

          // Item Rows
          validItems.forEach((name, idx) => {
              const vals = filteredDates.map(d => groupedData[name]?.[d]);
              const cells = [];

              for (let i=0; i<filteredDates.length; i++){
                  const v = vals[i];
                  const isLatest = (i === filteredDates.length - 1);
                  if (!isLatest){
                      cells.push(`<td>${Number.isFinite(v) ? v : '-'}</td>`);
                  } else {
                      // Comparison
                      const prev = vals.length >= 2 ? vals[filteredDates.length - 2] : undefined;
                      let diffHtml = `<span class="diff-badge diff-flat">-</span>`;
                      
                      if (Number.isFinite(v) && Number.isFinite(prev)){
                          let rawDiff = v - prev;
                          // Fix Decimal
                          const diff = Number(rawDiff.toFixed(2));
                          
                          if(diff > 0) diffHtml = `<span class="diff-badge diff-up">‚ñ≤${diff}</span>`;
                          else if(diff < 0) diffHtml = `<span class="diff-badge diff-down">‚ñº${Math.abs(diff)}</span>`;
                          else diffHtml = `<span class="diff-badge diff-flat">0</span>`;
                      }

                      // Check Low Stock
                      const thr = lowThresholdFor(name);
                      const isLow = (Number.isFinite(v) && v < thr);
                      const valClass = isLow ? 'val-low' : '';
                      const vText = Number.isFinite(v) ? v : '-';

                      cells.push(
                          `<td class="latest-cell">
                             <span class="latest-val ${valClass}">${vText}</span>
                             ${diffHtml}
                           </td>`
                      );
                  }
              }

              const tr = document.createElement('tr');
              tr.innerHTML =
                  `<td class="name">${escapeHtml(name)}</td>` +
                  cells.join('') +
                  `<td><input type="number" min="0" step="1" inputmode="numeric" data-item="${escapeHtml(name)}"></td>` +
                  `<td><button class="btn-single" type="button" data-item="${escapeHtml(name)}">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></td>`;
              tbody.appendChild(tr);
          });
      });
    }

    function updateNavButtons(){
      const prev = $('#btnPrev'), next = $('#btnNext');
      if (prev) prev.disabled = currentMonthIdx >= (uniqueMonths.length - 1);
      if (next) next.disabled = currentMonthIdx <= 0;
    }

    // ===== Save Logic =====
    function isDuplicateEntry(itemName, date, qty){
       return allData.some(entry => entry.item_name === itemName && entry.date === date && Number(entry.quantity) === Number(qty));
    }

    async function saveData(payload){
      try{
        const res = await fetch('/api/save_inventory', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('bad status');
        await res.json();
        
        // Show subtle notification instead of Alert
        const btn = $('#btnSaveAll');
        const oldText = btn.innerHTML;
        btn.innerHTML = '‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
        btn.style.background = '#43a047';
        setTimeout(() => {
            btn.innerHTML = oldText;
            btn.style.background = '';
        }, 2000);
        
        await fetchData();
      }catch(e){
        alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
      }
    }

    // Event Delegation for Single Save
    $('#tableBody')?.addEventListener('click', (e) => {
      const btn = e.target.closest('.btn-single');
      if (!btn) return;
      
      const itemName = btn.dataset.item;
      const inputDateEl = $('#inputDate');
      const tr = btn.closest('tr');
      const inputEl = tr ? tr.querySelector('input[type="number"]') : null;

      const inputDate = inputDateEl?.value || '';
      const qtyStr = inputEl?.value?.trim();

      if (!inputDate || !qtyStr){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
      const nQty = Number(qtyStr);
      if (Number.isNaN(nQty) || nQty < 0){ alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }

      if (isDuplicateEntry(itemName, inputDate, nQty)){
        if(!confirm(`‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥: ${itemName} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${inputDate} ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ ${nQty} ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡πâ‡∏≥?`)) return;
      }
      saveData([{ item_name:itemName, date:inputDate, quantity:nQty }]);
      // Clear input after save
      inputEl.value = '';
    });

    // Save All
    $('#btnSaveAll')?.addEventListener('click', () => {
      const inputDate = $('#inputDate')?.value || '';
      if (!inputDate){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'); return; }

      const payload = [];
      const duplicateList = [];

      $$('#tableBody input[type="number"]').forEach(input => {
        const val = input.value.trim();
        if (val === '') return;
        const name = input.dataset.item;
        const qty = Number(val);
        if (Number.isNaN(qty) || qty < 0) return;

        if (isDuplicateEntry(name, inputDate, qty)){
           duplicateList.push(name);
        } else {
           payload.push({ item_name:name, date:inputDate, quantity:qty });
        }
      });

      if (duplicateList.length){
        if(!confirm(`‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥ ${duplicateList.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
      }
      if (!payload.length && !duplicateList.length){
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'); return;
      }
      if(payload.length) saveData(payload);
    });

    // Popup Logic
    const popup = $('#popupForm');
    $('#btnAdd')?.addEventListener('click', () => {
       $('#newName').value = '';
       $('#newQty').value = '';
       $('#newDate').value = $('#inputDate')?.value || todayIso();
       popup.style.display = 'flex';
       setTimeout(() => $('#newName').focus(), 50);
    });
    const hidePopup = () => popup.style.display = 'none';
    $('#popupCancel')?.addEventListener('click', hidePopup);
    popup.addEventListener('click', e => { if(e.target === popup) hidePopup(); });
    
    $('#popupSubmit')?.addEventListener('click', () => {
       const name = $('#newName').value.trim();
       const qty = Number($('#newQty').value);
       const date = $('#newDate').value;
       if(!name || !date || qty < 0) { alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö'); return; }
       
       saveData([{ item_name:name, date, quantity:qty }]);
       hidePopup();
    });

    // Month Nav
    $('#btnPrev')?.addEventListener('click', () => {
      if(currentMonthIdx < uniqueMonths.length - 1){ currentMonthIdx++; renderTable(); updateNavButtons(); }
    });
    $('#btnNext')?.addEventListener('click', () => {
      if(currentMonthIdx > 0){ currentMonthIdx--; renderTable(); updateNavButtons(); }
    });

    // Menu Toggle
    const menu = $('#floatingMenu');
    const toggle = $('#floatingToggle');
    toggle?.addEventListener('click', (e) => {
        e.stopPropagation();
        menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
    });
    document.addEventListener('click', (e) => {
        if(menu && toggle && !menu.contains(e.target) && !toggle.contains(e.target)){
            menu.style.display = 'none';
        }
    });

    // Init
    fetchData();
  });
  </script>
</body>
</html>