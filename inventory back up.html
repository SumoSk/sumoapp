<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      font-family: 'Prompt', sans-serif;
      background: #f4f4f4;
      padding: 20px;
      padding-bottom: 120px;
    }
    h2 {
      text-align: center;
      color: #00695c;
    }
    .month-nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    .month-nav button {
      background: #009688;
      color: white;
      border: none;
      padding: 8px 16px;
      font-size: 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .month-nav button:hover {
      background: #00796b;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: center;
    }
    th {
      background-color: #e0f2f1;
      color: #00695c;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    td.name {
      font-weight: bold;
      text-align: left;
    }
    td input[type="number"] {
      width: 80px;
      padding: 4px;
      font-size: 14px;
      text-align: center;
    }
    .btn-bar {
      margin-top: 20px;
      text-align: center;
    }
    .btn-bar button {
      padding: 10px 20px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #00796b;
      color: white;
      margin: 0 10px;
    }
    .btn-bar button:hover {
      background: #004d40;
    }

    /* Popup */
    #popupForm {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #popupForm .form-box {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    #popupForm h3 {
      margin-top: 0;
      color: #00695c;
      text-align: center;
    }
    #popupForm label {
      display: block;
      margin: 10px 0 4px;
      font-weight: bold;
    }
    #popupForm input {
      width: 100%;
      padding: 8px;
      font-size: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    #popupForm .popup-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    #popupForm button {
      padding: 8px 16px;
      font-size: 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #popupForm .submit-btn {
      background: #00796b;
      color: white;
    }
    #popupForm .cancel-btn {
      background: #ccc;
    }

.btn-single {
  padding: 6px 12px;
  font-size: 14px;
  background-color: #009688;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s ease;
}
.btn-single:hover {
  background-color: #00796b;
}

.floating-toggle {
  position: fixed;
  bottom: 18px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 128, 128, 0);
  width: 58px;
  height: 58px;
  border-radius: 50%;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  cursor: pointer;
}
.floating-menu {
  position: fixed;
  bottom: 90px;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  border-radius: 16px;
  padding: 10px;
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  z-index: 999;
  max-height: 60vh;
  overflow-y: auto;
}
.floating-menu a img {
  width: 52px;
  height: 52px;
}


  </style>
</head>
<body>

<h2>‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</h2>
<div class="month-nav">
  <button onclick="prevMonth()"><span class="material-icons">chevron_left</span> ‡∏î‡∏π‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
  <button onclick="nextMonth()">‡∏î‡∏π‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <span class="material-icons">chevron_right</span></button>
</div>

<table>
  <thead>
    <tr id="tableHeader"></tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<div class="btn-bar">
  <button onclick="showAddPopup()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÉ‡∏´‡∏°‡πà</button>
  <button onclick="submitAll()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
</div>

<!-- ‚úÖ Popup Form -->
<div id="popupForm">
  <div class="form-box">
    <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÉ‡∏´‡∏°‡πà</h3>
    <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</label>
    <input type="text" id="newName" />
    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
    <input type="number" id="newQty" />
    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
    <input type="date" id="newDate" />
    <div class="popup-actions">
      <button class="submit-btn" onclick="submitNewItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button class="cancel-btn" onclick="hideAddPopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>
</div>

<script>
const fixedItemList = [ /* ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° 30 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */ 
  "Syringe 10", "Syringe 5", "Syringe 3", "Syringe 1",
  "‡πÄ‡∏Ç‡πá‡∏° 32", "‡πÄ‡∏Ç‡πá‡∏° 30", "‡πÄ‡∏Ç‡πá‡∏° 24", "‡πÄ‡∏Ç‡πá‡∏° 18Gx1", "‡πÄ‡∏Ç‡πá‡∏° 18Gx1 1/2",
  "Cannula", "Medicut", "‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠ 24", "‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠ 25", "Set IV", "‡∏´‡∏•‡∏≠‡∏î PRR",
  "Nss 1000 ML", "Nss 100 ML", "Nss 5 ML", "SWI 5 ML", "‡∏ñ‡∏∏‡∏á‡∏°‡∏∑‡∏≠ S",
  "‡∏™‡∏≥‡∏•‡∏µ‡∏Å‡πâ‡∏≠‡∏ô", "‡∏™‡∏≥‡∏•‡∏µ‡πÅ‡∏ú‡πà‡∏ô", "‡∏¢‡∏≤‡∏ä‡∏≤ (‡∏Ñ‡∏£‡∏µ‡∏°)", "Swabs", "‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå",
  "‡∏¢‡∏≤‡∏ó‡∏≤‡∏ù‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ó‡∏≤‡∏™‡∏¥‡∏ß", "‡∏≠‡∏∞‡πÇ‡∏•‡πÄ‡∏à‡∏•", "Scrub", "Milky"
];
let sortedItemList = [...fixedItemList];
const groupedData = {};
let allData = [], allDates = [], currentMonth = null;

async function fetchData() {
  const res = await fetch("/api/inventory");
  allData = await res.json();
  const dateSet = new Set(allData.map(d => d.date));
  allDates = Array.from(dateSet).sort((a, b) => new Date(b) - new Date(a));
  currentMonth = new Date(allDates[0]).getMonth();
  groupByItem();
  extendWithNewItems();
  renderTable();
}

function groupByItem() {
  for (const row of allData) {
    if (!groupedData[row.item_name]) groupedData[row.item_name] = {};
    groupedData[row.item_name][row.date] = row.quantity;
  }
}

function extendWithNewItems() {
  const allItems = new Set(allData.map(d => d.item_name));
  const additionalItems = Array.from(allItems).filter(name => !fixedItemList.includes(name));
  additionalItems.sort((a, b) => a.localeCompare(b, 'th'));
  sortedItemList = [...fixedItemList, ...additionalItems];
}

function getFilteredDates() {
  return allDates.filter(d => new Date(d).getMonth() === currentMonth).slice(0, 3).reverse();
}

function renderTable() {
  const filteredDates = getFilteredDates();
  const headerRow = document.getElementById("tableHeader");
  const tbody = document.getElementById("tableBody");
  headerRow.innerHTML = `<th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</th>` +
    filteredDates.map(date => `<th>${formatDate(date)}</th>`).join('') +
    `<th><input type='date' id='inputDate'></th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>`;
  tbody.innerHTML = "";
  sortedItemList.forEach((name, index) => {
    const preview = filteredDates.map(d => `<td>${groupedData[name]?.[d] ?? '-'}</td>`).join('');
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${index + 1}</td><td class='name'>${name}</td>` +
      preview +
      `<td><input type='number' name='${name}'></td>
       <td><button class="btn-single" onclick='submitSingle("${name}")'>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></td>`;
    tbody.appendChild(tr);
  });
}

function formatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString("th-TH", { day: "2-digit", month: "2-digit", year: "2-digit" });
}

function submitSingle(itemName) {
  const inputDate = document.getElementById("inputDate").value;
  const input = document.querySelector(`input[name='${itemName}']`);
  if (!inputDate || !input.value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

  const qty = parseFloat(input.value);

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏ã‡πâ‡∏≥
  const isDuplicate = allData.some(entry =>
    entry.item_name === itemName &&
    entry.date === inputDate &&
    parseFloat(entry.quantity) === qty
  );

  if (isDuplicate) {
    alert(`‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥:
‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå: ${itemName}
‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${inputDate}
‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${qty}`);
    return;
  }

  const payload = [{ item_name: itemName, date: inputDate, quantity: qty }];
  saveData(payload);
}



function submitAll() {
  const inputDate = document.getElementById("inputDate").value;
  if (!inputDate) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");

  const payload = [];
  const duplicateList = [];

  document.querySelectorAll("input[type='number']").forEach(input => {
    if (input.value !== '') {
      const name = input.name;
      const qty = parseFloat(input.value);

      const isDuplicate = allData.some(entry =>
        entry.item_name === name &&
        entry.date === inputDate &&
        parseFloat(entry.quantity) === qty
      );

      if (isDuplicate) {
        duplicateList.push(`- ${name} | ${inputDate} | ${qty}`);
      } else {
        payload.push({ item_name: name, date: inputDate, quantity: qty });
      }
    }
  });

  if (duplicateList.length > 0) {
    alert(`‚ö†Ô∏è ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥ ${duplicateList.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:\n\n${duplicateList.join('\n')}`);
  }

  if (payload.length === 0) {
    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
    return;
  }

  saveData(payload);
}


function saveData(payload) {
  fetch("/api/save_inventory", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(res => res.json())
    .then(() => {
      alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      fetchData();
    })
    .catch(() => alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"));
}

function prevMonth() {
  if (currentMonth > 0) {
    currentMonth--;
    renderTable();
  }
}

function nextMonth() {
  if (currentMonth < 11) {
    currentMonth++;
    renderTable();
  }
}

// üü¢ Popup Functions
function showAddPopup() {
  document.getElementById("popupForm").style.display = "flex";
}
function hideAddPopup() {
  document.getElementById("popupForm").style.display = "none";
}

function submitNewItem() {
  const name = document.getElementById("newName").value.trim();
  const qty = parseFloat(document.getElementById("newQty").value);
  const date = document.getElementById("newDate").value;

  if (!name || isNaN(qty) || !date) {
    return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
  }

  // üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà-‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
  const isDuplicate = allData.some(entry =>
    entry.item_name === name &&
    entry.date === date &&
    parseFloat(entry.quantity) === qty
  );

  if (isDuplicate) {
    return alert("‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏ä‡∏∑‡πà‡∏≠, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô)");
  }

  const payload = [{ item_name: name, quantity: qty, date }];
  saveData(payload);
  hideAddPopup();
}

fetchData();

function toggleFloatingMenu() {
  const menu = document.getElementById("floatingMenu");
  menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
}

document.addEventListener('click', function(e) {
  const toggle = document.getElementById("floatingToggle");
  const menu = document.getElementById("floatingMenu");
  if (!toggle.contains(e.target) && !menu.contains(e.target)) {
    menu.style.display = "none";
  }
});
</script>
<div id="floatingToggle" class="floating-toggle" onclick="toggleFloatingMenu()">
  <img src="{{ url_for('static', filename='icon/icon_menu_toggle.png') }}" alt="menu" style="width:60px;height:60px;">
</div>

<div id="floatingMenu" class="floating-menu">
  <a href="{{ url_for('dashboard') }}"><img src="{{ url_for('static', filename='icon/icon_dashboard.png') }}"></a>
  <a href="{{ url_for('sale_summary') }}"><img src="{{ url_for('static', filename='icon/icon_sale_summary.png') }}"></a>
  <a href="{{ url_for('record_sales') }}"><img src="{{ url_for('static', filename='icon/icon_record_sales.png') }}"></a>
  <a href="{{ url_for('customer_list') }}"><img src="{{ url_for('static', filename='icon/icon_customer_list.png') }}"></a>
  <a href="{{ url_for('record_customer') }}"><img src="{{ url_for('static', filename='icon/icon_customer_history.png') }}"></a>
  <a href="{{ url_for('oldsaledata') }}"><img src="{{ url_for('static', filename='icon/icon_old_customers.png') }}"></a>
  <a href="{{ url_for('inventory') }}"><img src="{{ url_for('static', filename='icon/icon_inventory.png') }}"></a>
  <a href="#"><img src="{{ url_for('static', filename='icon/icon_staff.png') }}"></a>
  <a href="#"><img src="{{ url_for('static', filename='icon/icon_appointments.png') }}"></a>
</div>

</body>
</html>
