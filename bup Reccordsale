<!DOCTYPE html>
<html lang="th">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta charset="UTF-8" />
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</title>

  <style>
    :root{
      --teal:#0f766e;
      --teal-600:#0d9488;
      --bg:#f7f7f7;
      --card:#ffffff;
      --muted:#6b7280;
      --line:#e5e7eb;
      --chip:#eef7f6;
      --danger:#c62828;
    }
    *{box-sizing:border-box}
    body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background-color: var(--bg); padding: 10px 10px 140px; color:#111827 }
    h2 { text-align: center; color: var(--teal); font-size: 20px; margin: 10px 0 0 }
    .container { max-width: 880px; margin: 20px auto; background: var(--card); border-radius: 14px; padding: 22px; box-shadow: 0 6px 22px rgba(2,8,23,.06) }
    .section-title{display:flex;align-items:center;gap:8px;margin:8px 0 6px;font-weight:800;color:#0b7660}
    .section-sub{margin:0 0 10px;color:var(--muted);font-size:12px}

    .field-row{display:grid;grid-template-columns:180px 1fr;gap:12px;align-items:center;margin:8px 0}
    .field-row label{font-weight:700;font-size:14px;margin:0}
    input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; background:#fff; font-size:14px }
    input:focus, select:focus, textarea:focus{ outline: 2px solid #94d3ce; border-color: #94d3ce }
    .muted{ color: var(--muted); font-size:12px }
    .pill{background:var(--chip); border:1px solid #cfe9e6; color:#0b7660; padding:4px 8px; border-radius:999px; font-size:12px; display:inline-flex; align-items:center; gap:6px }
    .row{display:flex;gap:8px;align-items:center}
    .nowrap{flex-wrap:nowrap}
    .grow{flex:1; min-width:0}

    .btn { display:inline-flex; gap:8px; align-items:center; justify-content:center; padding: 10px 12px; border-radius: 10px; border:none; cursor:pointer; font-weight:700; font-size:14px }
    .btn-primary{ background: var(--teal-600); color:#fff }
    .btn-save{ background:#43a047; color:#fff; padding:12px 18px }
    .btn-ghost{ background:#f1f5f9 }
    .btn-danger{ background: var(--danger); color:#fff }
    .btn-outline{ background:#fff; color:#0b7660; border:1px solid #a7e1da }

    .item-row { display: grid; grid-template-columns: 1.2fr 1.2fr .7fr .6fr auto; gap: 10px; margin-top: 10px; align-items: center }
    .item-row.single{grid-template-columns: 1.2fr 1.2fr .7fr .6fr auto}
    .item-actions{display:flex;justify-content:flex-end}

    .edit-panel {background:#f9fbfb;border:1px solid #e0efef;border-radius:14px;padding:16px;margin-top:16px}
    .chips{ margin-top:8px }
    .chip{display:inline-block;padding:6px 10px;border-radius:20px;border:1px solid #cde;cursor:pointer;background:#fff;margin:4px 6px 0 0;font-size:13px}
    .chip.active{background:#0b7660;color:#fff;border-color:#0b7660}
    .card{border:1px solid var(--line);padding:12px;border-radius:12px;margin:8px 0;display:flex;justify-content:space-between;gap:12px}
    .card .left{min-width:0}
    #editRecordList .card{ font-size:14px; }
    #editRecordList .card .left strong{ font-size:14px; font-weight:700; }
    #editRecordList .items-list{ font-size:14px; margin:4px 0 0; padding-left:18px; }
    #editRecordList .items-list li{ margin:0; line-height:1.35; }
    #editRecordList .total-line{ margin-top:6px; font-weight:700; color:#0b7660; font-size:14px; }
    #editRecordList .actions .btn{ font-size:13px; padding:8px 12px; }

    table{ width:100%; border-collapse: collapse; margin-top:8px }
    th, td{ border:1px solid var(--line); padding:8px; font-size:13px; vertical-align:top }
    thead tr{ background:#f8fafc }
    .actions{ display:flex; gap:6px; justify-content:center }

    .toggle{
      position: relative; display: inline-grid; grid-template-columns: 1fr 1fr;
      align-items:center; width: 160px; height: 38px; border:1px solid #a7e1da;
      border-radius: 999px; background: transparent; overflow:hidden; user-select:none;
    }
    .toggle span{
      text-align:center; font-weight:700; font-size:14px; z-index:2;
      color:#0b7660; padding:0 4px;
    }
    .toggle .knob{
      position:absolute; top:2px; bottom:2px; width: calc(50% - 4px);
      background: rgba(13,148,136,.18); border:1px solid rgba(13,148,136,.35);
      border-radius: 999px; z-index:1; transition: transform .18s ease;
      transform: translateX(2px);
    }
    .toggle[data-side="right"] .knob{ transform: translateX(calc(100% + 2px)); }
    .toggle input{ display:none }
    .toggle[data-side="left"] span:first-child{ color:#064e3b; font-weight:800 }
    .toggle[data-side="right"] span:last-child{ color:#064e3b; font-weight:800 }

    .amount-row input{ flex:1; min-width:0 }
    .amount-row .toggle{ flex: none; }

    .center-actions{ display:flex; justify-content:center; gap:10px; margin-top:12px; flex-wrap:wrap }
    .center-actions .btn{ min-width:180px }

    .lock-badge{ cursor:pointer; }
    .lock-badge:focus{ outline:2px solid #94d3ce; }

    @media (max-width:700px){
      .field-row{grid-template-columns:130px 1fr}
      .item-row, .item-row.single{grid-template-columns:1fr}
      .item-actions{justify-content:flex-start}
      .toggle{ width: 150px; height: 36px }
    }

    .diag-panel{background:#f7fffb;border:1px solid #bfeee3;border-radius:14px;padding:16px;margin-top:20px}
    .diag-title{font-weight:800;color:#0b7660;margin:0 0 10px}
    .chip-btn{border:1px solid #a7e1da;background:#fff;color:#0b7660;border-radius:999px;padding:8px 12px;font-size:12px;font-weight:700;cursor:pointer}
    .chip-btn:hover{background:#eaf9f6}
    #diag-count{margin-left:8px;color:#0b7660;font-size:12px}
    #diag-results{width:100%;border-collapse:collapse;margin-top:10px}
    #diag-results th,#diag-results td{border:1px solid var(--line);padding:8px;font-size:12px}
    #diag-results thead tr{background:#f0fdfa}

    /* =========================
       POPUP: ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏ä‡∏±‡πâ‡∏ô 1)
       ========================= */
    .modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2500;
      padding:14px;
    }
    .modal-box{
      background:#fff;
      width:760px;
      max-width:100%;
      max-height:92vh;
      overflow:auto;
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      padding:18px;
    }
    .modal-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      padding-bottom:10px; border-bottom:1px solid var(--line);
    }
    .modal-title{font-weight:900;color:#0b7660;font-size:18px;margin:0}
    .modal-sub{margin:4px 0 0;color:var(--muted);font-size:12px}
    .modal-close{
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
    }
    .mini-grid{
      display:grid; gap:10px; margin-top:12px;
      grid-template-columns:1fr 1fr;
    }
    .mini-grid .field{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:#fbfbfb;
    }
    .mini-grid .field b{display:block;margin-bottom:4px;color:#0b7660}
    .mini-grid .field .v{font-size:14px}
    .mini-grid .field input{
      margin-top:6px;
      background:#fff;
    }
    @media (max-width:700px){
      .mini-grid{grid-template-columns:1fr}
    }
    .modal-actions{
      display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
      margin-top:14px;
    }

    /* =========================
       POPUP: ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏ä‡∏±‡πâ‡∏ô 2)
       ========================= */
    .receipt-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:3000;
      padding:14px;
    }
    .receipt-box{
      background:#fff;
      width:820px;
      max-width:100%;
      max-height:92vh;
      overflow:auto;
      border-radius:16px;
      padding:22px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      font-size:14px;
    }
    .receipt-header{
      text-align:center;
      margin-bottom:12px;
    }
    .receipt-header h2{
      margin:0;
      font-size:20px;
      font-weight:900;
      color:#111827;
    }
    .receipt-subtitle{
      margin-top:4px;
      font-weight:800;
      color:#111827;
      font-size:13px;
    }
    .receipt-clinic{
      margin-top:6px;
      font-weight:900;
      color:#0b7660;
      font-size:14px;
    }
    .receipt-small{
      font-size:11px;
      color:#374151;
      line-height:1.45;
      margin-top:6px;
    }
    .receipt-section{ margin-top:12px; }
    .receipt-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    .receipt-table th,
    .receipt-table td{
      border:1px solid #d1d5db;
      padding:6px 8px;
      vertical-align:top;
    }
    .receipt-table th{
      background:#f3f4f6;
      text-align:center;
    }
    .receipt-total{
      text-align:right;
      margin-top:10px;
      font-weight:900;
      font-size:15px;
    }
    .fineprint{
      margin-top:14px;
      font-size:10px;
      line-height:1.5;
      color:#111827;
    }

    @media print{
      body *{ visibility:hidden !important; }
      #receiptOverlay, #receiptOverlay *{ visibility:visible !important; }
      #receiptOverlay{
        position:absolute; inset:0;
        background:#fff !important;
        padding:0 !important;
      }
      .receipt-box{
        box-shadow:none !important;
        max-height:none !important;
        border-radius:0 !important;
        width:100% !important;
      }
      .receipt-actions{ display:none !important; }
      .sig-actions{ display:none !important; }
    }

    /* ====== Signature Pad (‡πÅ‡∏Å‡πâ: ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å popup ‡∏ä‡∏±‡πâ‡∏ô 1 ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ã‡πâ‡∏≥) ====== */
    .sig-wrap{
      margin-top: 18px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      background:#fafafa;
    }
    .sig-grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:14px;
    }
    .sig-card{
      background:#fff;      
      padding:12px;
      box-shadow:0 8px 18px rgba(2,8,23,.05);
    }
    .sig-label{
      font-size:12px;
      color:#0b7660;
      font-weight:900;
      margin-bottom:8px;
    }
    .sig-pad{
      width:100%;
      height:140px;
      border-radius:12px;
      background:#fff;
      touch-action:none;
    }
    .sig-actions{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:8px;
      margin-top:8px;
    }
    .sig-btn{
      border:1px solid #d1d5db;
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      font-weight:800;
      cursor:pointer;
    }
    .sig-btn:hover{ background:#f3f4f6; }

    .sig-under{
      margin-top:8px;
      font-size:12px;
      font-weight:800;
      color:#111827;
      border-top:1px solid #d1d5db;
      padding-top:6px;
      min-height:18px;
      text-align:center;
    }

    @media (max-width:700px){
      .sig-grid{ grid-template-columns: 1fr; }
    }
    @media print{
      .sig-wrap{ border:none !important; background:#fff !important; padding:0 !important; }
      .sig-card{ box-shadow:none !important; border:1px solid #111 !important; }
      .sig-under{ border-top:1px solid #111 !important; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>

    <!-- üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏° -->
    <div id="editSection" class="edit-panel">
      <div class="section-title">üõ†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°</div>
      <p class="section-sub">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏Ç OPD (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å) ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
      <div class="field-row">
        <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ OPD</label>
        <div class="row nowrap">
          <input type="text" id="editOPD" class="grow"
                 placeholder="‡πÄ‡∏ä‡πà‡∏ô 0007"
                 inputmode="numeric" pattern="\d{4}" maxlength="4"
                 oninput="digitsOnly(this)">
          <button type="button" class="btn btn-outline" onclick="loadDatesByOPD()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </div>
      </div>
      <div id="editDateButtons" class="chips" style="margin-top:12px;"></div>
      <div id="editRecordList" style="margin-top:12px;"></div>
    </div>

    <!-- üìù ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
    <form id="saleForm" onsubmit="return false;">
      <input type="hidden" id="currentId" value="">

      <div class="section-title">üßæ ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>

      <div class="field-row">
        <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <input type="date" id="date" name="date">
      </div>

      <div class="field-row">
        <label for="opd">‡πÄ‡∏•‡∏Ç OPD</label>
        <div class="row nowrap">
          <input
            type="text" id="opd" name="opd" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç OPD 4 ‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô 0001"
            inputmode="numeric" maxlength="4" pattern="\d{4}"
            oninput="onOPDInput(this);" class="grow">
          <span class="pill">‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å</span>
        </div>
      </div>

      <div class="field-row">
        <label for="name">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô-‡∏à‡∏£‡∏¥‡∏á</label>
        <div class="row nowrap">
          <input type="text" id="name" name="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ö‡∏ß‡πå - ‡πÄ‡∏°‡∏•‡∏î‡∏≤" disabled class="grow">
          <span id="lockNameBadge" class="pill lock-badge" style="display:none;"
                role="button" tabindex="0" aria-label="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå"
                onclick="unlockNamePhone()">üîí ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å</span>
        </div>
      </div>

      <div class="field-row">
        <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
        <div class="row nowrap">
          <input type="tel" id="phone" name="phone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0912345678" disabled class="grow">
          <span id="lockPhoneBadge" class="pill lock-badge" style="display:none;"
                role="button" tabindex="0" aria-label="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå"
                onclick="unlockNamePhone()">üîí ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å</span>
        </div>
      </div>

      <div class="section-title">üß¥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>
      <div class="muted" id="catalogHint" style="margin-top:-2px;display:none;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</div>
      <div id="itemList"></div>
      <div class="row" style="margin-top:8px">
        <button type="button" class="btn btn-outline" onclick="addItemRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      </div>

      <div class="field-row">
        <label>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</label>
        <div class="row nowrap">
          <div id="sumToggle" class="toggle" role="switch" aria-checked="false" tabindex="0" data-side="left"
               onclick="toggleSum()" onkeydown="toggleSumKey(event)">
            <span>‡∏õ‡∏¥‡∏î</span><span>‡πÄ‡∏õ‡∏¥‡∏î</span>
            <div class="knob"></div>
            <input type="hidden" id="sumHidden" value="‡∏õ‡∏¥‡∏î">
          </div>
        </div>
      </div>

      <div class="field-row">
        <label for="amount">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</label>
        <div class="row nowrap amount-row">
          <input type="number" id="amount" name="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)" step="1" min="0" class="grow">
          <div id="payToggle" class="toggle" role="switch" aria-checked="true" tabindex="0" data-side="left"
               onclick="togglePayment()" onkeydown="togglePaymentKey(event)">
            <span>‡πÇ‡∏≠‡∏ô</span><span>‡∏™‡∏î</span>
            <div class="knob"></div>
            <input type="hidden" id="paymentHidden" value="‡πÇ‡∏≠‡∏ô">
          </div>
        </div>
      </div>

      <div class="field-row">
        <label for="note">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea id="note" name="note" rows="2" placeholder=""></textarea>
      </div>

      <div class="center-actions">
        <button type="button" id="btnPayReceipt" class="btn btn-primary" onclick="openPayPopup()" disabled>
          ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô / ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
        </button>
        <button type="button" id="btnReview" class="btn btn-outline" onclick="reviewForm()" disabled>
          ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </button>
        <button type="button" class="btn btn-ghost" onclick="clearForm()">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      </div>
      <div class="muted" style="text-align:center;margin-top:6px;">
        * ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô / ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‚Äù ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î Popup ‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏° (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤)
      </div>
    </form>

    <div id="reviewSection" style="margin-top:16px;">
      <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
    </div>
    <div class="center-actions">
      <button class="btn btn-save" id="btnSaveAll" onclick="saveAllRecords()" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <!-- Diagnostics -->
    <div class="diag-panel">
      <div class="diag-title">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ <span id="diag-count"></span></div>
      <div class="chips" style="gap:8px; flex-wrap:wrap;">
        <button class="chip-btn" onclick="runDiag('missingPhone')">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</button>
        <button class="chip-btn" onclick="runDiag('nameDifferentOPD')">‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥ (‡∏ï‡πà‡∏≤‡∏á OPD)</button>
        <button class="chip-btn" onclick="runDiag('phoneDifferentName')">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ã‡πâ‡∏≥ (‡∏ï‡πà‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠)</button>
        <button class="chip-btn" onclick="runDiag('opdDifferentNamePhone')">OPD ‡∏ã‡πâ‡∏≥ (‡∏ï‡πà‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå)</button>
        <button class="chip-btn" onclick="runDiag('invalidPhone')">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å</button>
        <button class="chip-btn" onclick="runDiag('invalidOPD')">OPD ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å</button>
        <button class="chip-btn" onclick="runDiag('splitGroups')">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏ï‡∏Å (name+phone+opd ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)</button>
        <button class="chip-btn" onclick="runDiag('sameNameMultiPhones')">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå/‡∏ß‡πà‡∏≤‡∏á</button>
      </div>

      <table id="diag-results" style="display:none;">
        <thead><tr id="diag-head"></tr></thead>
        <tbody id="diag-body"></tbody>
      </table>
    </div>
  </div>

  <!-- =========================
       POPUP ‡∏ä‡∏±‡πâ‡∏ô 1: ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏£‡∏∏‡∏õ + ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à)
       ========================= -->
  <div id="payOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" aria-label="‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à">
      <div class="modal-head">
        <div>
          <div class="modal-title">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
          <div class="modal-sub">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå</div>
        </div>
        <button class="modal-close" onclick="closePayPopup()">‚úï</button>
      </div>

      <div class="mini-grid">
        <div class="field">
          <b>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</b>
          <div class="v" id="pay_name">-</div>
          <div class="muted" id="pay_phone">-</div>
        </div>
        <div class="field">
          <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</b>
          <div class="v" id="pay_date">-</div>
          <div class="muted" id="pay_method">-</div>
        </div>
        <div class="field">
          <b>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</b>
          <div class="v" id="pay_total" style="font-weight:900;font-size:18px;color:#0b7660">0</div>
          <div class="muted">‡∏õ‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏≤‡∏ó / ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏ä‡∏¥‡πâ‡∏ô‡πÅ‡∏£‡∏Å‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î)</div>
        </div>

        <!-- ‚úÖ ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏ä‡∏∑‡πà‡∏≠-‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà -->
        <div class="field" style="grid-column:1/-1;">
          <b>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà)</b>
          <textarea
            id="pay_note_input"
            rows="3"
            placeholder="‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"
            style="width:100%;margin-top:6px;border:1px solid #d1d5db;border-radius:10px;padding:8px;font-size:14px;resize:vertical;"
          ></textarea>
        </div>
      </div>

      <!-- ‚úÖ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠ (‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) -->
      <div class="field" style="margin-top:8px;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fbfbfb;">
        <b style="display:block;color:#0b7660;margin-bottom:6px;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ï‡πâ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</b>
        <div class="row" style="flex-wrap:wrap;gap:10px;">
          <div class="grow">
            <label class="muted">1) ‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏≠‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</label>
            <input id="sig_authorized" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏ç.‡∏õ‡∏¥‡∏¢‡∏∞‡∏é‡∏≤ ‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡∏´‡∏•‡∏ß‡∏á">
          </div>
          <div class="grow">
            <label class="muted">2) ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
            <input id="sig_customer" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£">
          </div>
          <div class="grow">
            <label class="muted">3) ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</label>
            <input id="sig_receiver" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô">
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closePayPopup()">‡∏Å‡∏•‡∏±‡∏ö</button>
        <button class="btn btn-primary" onclick="openReceiptFromPay()">‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°</button>
      </div>
    </div>
  </div>

  <!-- =========================
       POPUP ‡∏ä‡∏±‡πâ‡∏ô 2: ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°
       ========================= -->
  <div id="receiptOverlay" class="receipt-overlay" aria-hidden="true">
    <div class="receipt-box">
      <div class="receipt-header">
        <h2>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô)</h2>
        <div class="receipt-subtitle">‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</div>
        <div class="receipt-clinic">‡∏´‡∏°‡∏≠‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏°‡∏µ‡πà ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏° ‡∏•‡∏≥‡∏û‡∏π‡∏ô ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï 5110100116</div>
        <div class="receipt-small">
          ‡∏û‡∏ç.‡∏õ‡∏¥‡∏¢‡∏∞‡∏é‡∏≤ ‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡∏´‡∏•‡∏ß‡∏á ‡∏ß.51308<br>
          186/4 ‡∏°.5 ‡∏ï.‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏¢‡∏≠‡∏á ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏•‡∏≥‡∏û‡∏π‡∏ô 51000<br>
          ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå 0614296596
        </div>
      </div>

      <div id="receiptContent"></div>

      <div class="fineprint">
        <b>‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</b><br>
        (1) ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏à‡πá‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏î‡πâ<br>
        (2) ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏¥‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£ ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡πÑ‡∏°‡πà‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏´‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏•‡∏á‡πÑ‡∏ß‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏°‡∏Ñ‡∏ß‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏≠‡∏±‡∏ô‡∏≠‡∏≤‡∏à‡∏Å‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡πÅ‡∏Å‡πà‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ß‡πà‡∏≤‡∏´‡∏≤‡∏Å‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
      </div>

      <!-- ‚úÖ ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡πÉ‡∏ï‡πâ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å popup ‡∏ä‡∏±‡πâ‡∏ô 1) -->
      <div class="sig-wrap">
        <div class="sig-grid">
          <div class="sig-card">
            <div class="sig-label">1) ‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏≠‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>
            <canvas id="sigPad_authorized" class="sig-pad"></canvas>
            <div class="sig-actions">
              <button type="button" class="sig-btn" onclick="clearSig('authorized')">‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
            <div class="sig-under" id="sigUnder_authorized"></div>
          </div>

          <div class="sig-card">
            <div class="sig-label">2) ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
            <canvas id="sigPad_customer" class="sig-pad"></canvas>
            <div class="sig-actions">
              <button type="button" class="sig-btn" onclick="clearSig('customer')">‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
            <div class="sig-under" id="sigUnder_customer"></div>
          </div>

          <div class="sig-card">
            <div class="sig-label">3) ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>
            <canvas id="sigPad_receiver" class="sig-pad"></canvas>
            <div class="sig-actions">
              <button type="button" class="sig-btn" onclick="clearSig('receiver')">‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
            <div class="sig-under" id="sigUnder_receiver"></div>
          </div>
        </div>
      </div>

      <div class="fineprint" style="margin-top:14px;">
        <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b><br>
        ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πà‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ<br>
        ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ
      </div>

      <div class="receipt-actions" style="display:flex;justify-content:center;gap:10px;margin-top:14px;flex-wrap:wrap;">
        <button class="btn btn-outline" onclick="closeReceipt()">‡∏õ‡∏¥‡∏î</button>
        <button class="btn btn-primary" onclick="window.print()">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // =========================
    // Helpers
    // =========================
    function safe(v){
      const map = {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
      return (v==null?'':String(v)).replace(/[&<>"']/g, s=>map[s]);
    }
    function nl2brSafe(text){
      return safe(text).replace(/\n/g, "<br>");
    }

    // =========================
    // ‚úÖ Product Catalog from Supabase: /api/products_map
    // =========================
    const PROMO_CAT_NAME = '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©';
    let subOptionsMap = {};

    async function loadCatalog(){
      const hint = document.getElementById('catalogHint');
      if(hint) hint.style.display = 'block';

      const res = await fetch('/api/products_map');
      const data = await res.json().catch(()=> ({}));
      if(!res.ok) throw new Error(data.error || '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

      subOptionsMap = data.map || {};
      if(!subOptionsMap['‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©']){
        subOptionsMap['‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏≠‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©'] = [];
      }

      refreshAllItemMainSelects();
      if(hint) hint.style.display = 'none';
    }

    function mainCategoryKeys(){
      const keys = Object.keys(subOptionsMap || {}).filter(k => k !== PROMO_CAT_NAME);
      return [...keys, PROMO_CAT_NAME].filter(Boolean);
    }

    function buildMainOptionsHTML(){
      const keys = mainCategoryKeys();
      if(!keys.length){
        return `<option value="">-- (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤) --</option>`;
      }
      return `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å --</option>` +
        keys.map(k=>`<option value="${safe(k)}">${safe(k)}</option>`).join('');
    }

    function updateSubOptions(itemSelect, subSelect){
      const selectedCatName = itemSelect.value || '';
      let options = (subOptionsMap && subOptionsMap[selectedCatName]) ? subOptionsMap[selectedCatName] : [];

      if(selectedCatName === PROMO_CAT_NAME){
        options = Object.entries(subOptionsMap || {})
          .filter(([k]) => k !== PROMO_CAT_NAME)
          .flatMap(([_, arr]) => arr || []);
      }

      const uniqNames = [];
      const seen = new Set();

      (options || []).forEach(o=>{
        const n = String((typeof o === 'string') ? o : (o?.name || '')).trim();
        if(!n) return;
        if(seen.has(n)) return;
        seen.add(n);
        uniqNames.push(n);
      });

      subSelect.innerHTML =
        '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>' +
        uniqNames.map(n => `<option value="${safe(n)}">${safe(n)}</option>`).join('');

      subSelect.value = '';
    }

    function refreshAllItemMainSelects(){
      document.querySelectorAll('select[name="item[]"]').forEach(sel=>{
        const prev = sel.value;
        sel.innerHTML = buildMainOptionsHTML();
        if(prev && mainCategoryKeys().includes(prev)){
          sel.value = prev;
          const subSel = sel.nextElementSibling;
          if(subSel && subSel.tagName === 'SELECT'){
            updateSubOptions(sel, subSel);
          }
        }
      });
    }

    // =========================
    // ---------- State ----------
    // =========================
    let records = [];
    let customerMap = {};
    let currentEditId = null;
    let editDataByOPD = [];
    let manualUnlockNamePhone = false;
    let lastOPDForLock = '';
    let allSales = null;

    // ---------- Prefill customers ----------
    fetch('/api/customers').then(r=>r.json()).then(data=>{
      (data||[]).forEach(c=>{
        if(c.opd){ customerMap[c.opd] = {name:c.name||'', phone:c.phone||''}; }
      });
    }).catch(()=>{});

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', async () => {
      try{
        await loadCatalog();
      }catch(e){
        console.error(e);
        alert(e.message || '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }

      initFirstRow();
      initDateToday();

      const ipt = document.getElementById('editOPD');
      if (ipt) {
        ipt.addEventListener('keydown', (e)=>{
          if (e.key === 'Enter') { e.preventDefault(); loadDatesByOPD(); }
        });
      }

      ['lockNameBadge','lockPhoneBadge'].forEach(id=>{
        const el = document.getElementById(id);
        if(el){
          el.addEventListener('keydown', (e)=>{
            if(e.key==='Enter' || e.key===' '){ e.preventDefault(); unlockNamePhone(); }
          });
        }
      });

      recalcAmount();
      refreshPayReceiptButtonState();
    });

    // =========================
    // ---------- UI helpers ----------
    // =========================
    function digitsOnly(el){ el.value = (el.value || '').replace(/\D/g,'').slice(0,4); }
    function isValidOPD(opd){ return /^\d{4}$/.test(opd||''); }

    function unlockNamePhone(){
      manualUnlockNamePhone = true;
      const nameEl  = document.getElementById('name');
      const phoneEl = document.getElementById('phone');
      const lockName  = document.getElementById('lockNameBadge');
      const lockPhone = document.getElementById('lockPhoneBadge');
      nameEl.disabled = false; phoneEl.disabled = false;
      nameEl.readOnly = false; phoneEl.readOnly = false;
      lockName.style.display = 'none'; lockPhone.style.display = 'none';
      setTimeout(()=> nameEl.focus(), 0);
    }

    function onOPDInput(el){
      digitsOnly(el);
      document.getElementById('btnReview').disabled = !isValidOPD(el.value);

      const nameEl = document.getElementById('name');
      const phoneEl = document.getElementById('phone');
      const lockName = document.getElementById('lockNameBadge');
      const lockPhone = document.getElementById('lockPhoneBadge');

      if(!isValidOPD(el.value)){
        manualUnlockNamePhone = false;
        lastOPDForLock = '';
        nameEl.value=''; phoneEl.value='';
        nameEl.disabled = true; phoneEl.disabled = true;
        nameEl.readOnly = false; phoneEl.readOnly = false;
        lockName.style.display='none'; lockPhone.style.display='none';
        refreshPayReceiptButtonState();
        return;
      }

      const opd = el.value;
      if(opd !== lastOPDForLock){
        manualUnlockNamePhone = false;
        lastOPDForLock = opd;
      }

      const c = customerMap[opd];
      if(c && !manualUnlockNamePhone){
        nameEl.value = c.name||''; phoneEl.value = c.phone||'';
        nameEl.disabled = true; phoneEl.disabled = true;
        nameEl.readOnly = true; phoneEl.readOnly = true;
        lockName.style.display='inline-flex'; lockPhone.style.display='inline-flex';
      }else{
        nameEl.disabled = false; phoneEl.disabled = false;
        nameEl.readOnly = false; phoneEl.readOnly = false;
        lockName.style.display='none'; lockPhone.style.display='none';
        if(c && manualUnlockNamePhone && !nameEl.value && !phoneEl.value){
          nameEl.value = c.name || '';
          phoneEl.value = c.phone || '';
        }
      }
      refreshPayReceiptButtonState();
    }

    /* ----- Toggle utilities ----- */
    function setToggle(el, side){
      el.setAttribute('data-side', side);
      el.setAttribute('aria-checked', side==='right' ? 'true':'false');
    }

    function getPayment(){ return document.getElementById('paymentHidden').value || '‡πÇ‡∏≠‡∏ô'; }
    function setPayment(val){
      const toggle = document.getElementById('payToggle');
      const hidden = document.getElementById('paymentHidden');
      if(val === '‡∏™‡∏î'){ setToggle(toggle, 'right'); hidden.value = '‡∏™‡∏î'; }
      else { setToggle(toggle, 'left'); hidden.value = '‡πÇ‡∏≠‡∏ô'; }
      refreshPayReceiptButtonState();
    }
    function togglePayment(){ setPayment(getPayment() === '‡πÇ‡∏≠‡∏ô' ? '‡∏™‡∏î' : '‡πÇ‡∏≠‡∏ô'); }
    function togglePaymentKey(e){
      if([' ','Enter','ArrowLeft','ArrowRight'].includes(e.key)){
        e.preventDefault();
        if(e.key==='ArrowLeft'){ setPayment('‡πÇ‡∏≠‡∏ô'); }
        else if(e.key==='ArrowRight'){ setPayment('‡∏™‡∏î'); }
        else { togglePayment(); }
      }
    }

    function getSumState(){ return document.getElementById('sumHidden').value || '‡∏õ‡∏¥‡∏î'; }
    function setSumState(val){
      const toggle = document.getElementById('sumToggle');
      const hidden = document.getElementById('sumHidden');
      if(val === '‡πÄ‡∏õ‡∏¥‡∏î'){ setToggle(toggle, 'right'); hidden.value = '‡πÄ‡∏õ‡∏¥‡∏î'; recalcAmount(); }
      else { setToggle(toggle, 'left'); hidden.value = '‡∏õ‡∏¥‡∏î'; }
      refreshPayReceiptButtonState();
    }
    function toggleSum(){ setSumState(getSumState() === '‡πÄ‡∏õ‡∏¥‡∏î' ? '‡∏õ‡∏¥‡∏î' : '‡πÄ‡∏õ‡∏¥‡∏î'); }
    function toggleSumKey(e){
      if([' ','Enter','ArrowLeft','ArrowRight'].includes(e.key)){
        e.preventDefault();
        if(e.key==='ArrowLeft'){ setSumState('‡∏õ‡∏¥‡∏î'); }
        else if(e.key==='ArrowRight'){ setSumState('‡πÄ‡∏õ‡∏¥‡∏î'); }
        else { toggleSum(); }
      }
    }

    // =========================
    // Items
    // =========================
    function makeItemRow(){
      const row = document.createElement('div');
      row.className = 'item-row single';
      row.innerHTML = `
        <select name="item[]">
          ${buildMainOptionsHTML()}
        </select>
        <select name="subitem[]"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option></select>
        <input type="number" name="price[]" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" step="1" min="0">
        <input type="number" name="qty[]" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" step="1" min="1" value="1">
        <div class="item-actions">
          <button type="button" class="btn btn-ghost">‡∏•‡∏ö</button>
        </div>
      `;

      const mainSel = row.querySelector('select[name="item[]"]');
      const subSel  = row.querySelector('select[name="subitem[]"]');
      const priceEl = row.querySelector('input[name="price[]"]');
      const qtyEl   = row.querySelector('input[name="qty[]"]');
      const delBtn  = row.querySelector('.item-actions button');

      mainSel.addEventListener('change', ()=>{
        updateSubOptions(mainSel, subSel);
        recalcAmount();
        refreshPayReceiptButtonState();
      });

      subSel.addEventListener('change', ()=>{
        refreshPayReceiptButtonState();
      });

      priceEl.addEventListener('input', ()=> { recalcAmount(); refreshPayReceiptButtonState(); });
      qtyEl.addEventListener('input', ()=> { recalcAmount(); refreshPayReceiptButtonState(); });

      delBtn.addEventListener('click', ()=> removeItemRow(delBtn));
      return row;
    }

    function initFirstRow(){
      const list = document.getElementById('itemList');
      list.innerHTML = '';
      list.appendChild(makeItemRow());
      setPayment('‡πÇ‡∏≠‡∏ô');
      setSumState('‡∏õ‡∏¥‡∏î');
      refreshPayReceiptButtonState();
    }

    function addItemRow(){
      const list = document.getElementById('itemList');
      list.appendChild(makeItemRow());
      refreshPayReceiptButtonState();
    }

    function removeItemRow(btn){
      const row = btn.closest('.item-row');
      const list = document.getElementById('itemList');
      if(list.children.length>1){
        row.remove();
        recalcAmount();
      }
      refreshPayReceiptButtonState();
    }

    function initDateToday(){
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      document.getElementById('date').value = `${d.getFullYear()}-${mm}-${dd}`;
    }

    function formatDate(dateStr){
      if(!dateStr) return '';
      const [y,m,d] = dateStr.split('-');
      return `${d}/${m}/${y}`;
    }

    // =========================
    // Edit old records (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏∏‡∏ì)
    // =========================
    function loadDatesByOPD(){
      const raw = (document.getElementById('editOPD').value||'').trim();
      if(!isValidOPD(raw)) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
      const opd = raw;

      const list = document.getElementById('editRecordList');
      const dateBtns = document.getElementById('editDateButtons');
      dateBtns.innerHTML = '';
      list.innerHTML = '<div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>';

      fetch(`/api/sales?opd=${encodeURIComponent(opd)}`)
        .then(r=> r.ok ? r.json() : Promise.reject())
        .then(data=>{
          editDataByOPD = data || [];
          if(editDataByOPD.length===0){
            dateBtns.innerHTML = '';
            list.innerHTML = '<div class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á OPD ‡∏ô‡∏µ‡πâ</div>';
            return;
          }
          const dates = [...new Set(editDataByOPD.map(r=> (r.date||'').slice(0,10)))]
            .sort((a,b)=> new Date(b)-new Date(a));

          dateBtns.innerHTML = 'üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:<br>' + dates.map((d,i)=>(
            `<span class="chip ${i===0?'active':''}" data-date="${d}" onclick="selectEditDateChip(this)">${formatDate(d)}</span>`
          )).join('');
          showEditList(dates[0]);
        })
        .catch(()=> { list.innerHTML = '<div class="muted">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>'; });
    }

    function loadDatesByOPDFor(opd){
      const list = document.getElementById('editRecordList');
      const dateBtns = document.getElementById('editDateButtons');
      document.getElementById('editOPD').value = opd;
      dateBtns.innerHTML = '';
      list.innerHTML = '<div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>';
      return fetch(`/api/sales?opd=${encodeURIComponent(opd)}`)
        .then(r=> r.ok ? r.json() : Promise.reject())
        .then(data=>{
          editDataByOPD = data || [];
          if(editDataByOPD.length===0){
            dateBtns.innerHTML = '';
            list.innerHTML = '<div class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á OPD ‡∏ô‡∏µ‡πâ</div>';
            return;
          }
          const dates = [...new Set(editDataByOPD.map(r=> (r.date||'').slice(0,10)))]
            .sort((a,b)=> new Date(b)-new Date(a));

          dateBtns.innerHTML = 'üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:<br>' + dates.map((d,i)=>(
            `<span class="chip ${i===0?'active':''}" data-date="${d}" onclick="selectEditDateChip(this)">${formatDate(d)}</span>`
          )).join('');
          showEditList(dates[0]);
        })
        .catch(()=> { list.innerHTML = '<div class="muted">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>'; });
    }

    function selectEditDateChip(el){
      document.querySelectorAll('#editDateButtons .chip').forEach(c=> c.classList.remove('active'));
      el.classList.add('active');
      showEditList(el.getAttribute('data-date'));
    }

    function showEditList(date){
      const list = document.getElementById('editRecordList');
      const rows = editDataByOPD.filter(r => (r.date||'').slice(0,10) === date);
      if(rows.length === 0){
        list.innerHTML = '<div class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
        return;
      }

      const stripPrice = (s) => String(s).replace(/ - \d+(?:\.\d+)? ‡∏ä‡∏¥‡πâ‡∏ô x \d+(?:\.\d+)? ‡∏ö‡∏≤‡∏ó$/, '');
      const sumFromItems = (items=[]) => items.reduce((acc, line)=>{
        const m = String(line).match(/ - (\d+(?:\.\d+)?) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+(?:\.\d+)?) ‡∏ö‡∏≤‡∏ó$/);
        if(!m) return acc;
        const qty = parseFloat(m[1]||'0');
        const price = parseFloat(m[2]||'0');
        return acc + (qty*price);
      }, 0);

      const html = rows.map(r => {
        const items = Array.isArray(r.items) ? r.items : [];
        const cleanList = items.length
          ? `<ul class="items-list">${items.map(x => `<li>${safe(stripPrice(x))}</li>`).join('')}</ul>`
          : '<div class="muted">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>';

        const total = (r.amount != null && r.amount !== '') ? Number(r.amount) : sumFromItems(items);
        const totalStr = Number.isFinite(total) ? total.toLocaleString() : '0';

        return `
          <div class="card">
            <div class="left">
              <div><strong>${safe(r.name || '-')}</strong></div>
              ${cleanList}
              <div class="total-line">‡∏£‡∏ß‡∏°: ${totalStr} ‡∏ö‡∏≤‡∏ó</div>
            </div>
            <div class="actions">
              <button type="button" class="btn btn-primary" onclick="editSelectedRecordById('${r.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button type="button" class="btn btn-danger" onclick="deleteRecordFromSupabase('${r.id}')">‡∏•‡∏ö</button>
            </div>
          </div>
        `;
      }).join('');

      list.innerHTML = html;
    }

    function findRecordInEditCacheById(id){
      return (editDataByOPD || []).find(x => String(x.id) === String(id)) || null;
    }

    function editSelectedRecordById(id){
      const rec = findRecordInEditCacheById(id);
      if(!rec) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
      currentEditId = rec.id || null;
      document.getElementById('currentId').value = currentEditId || '';
      editRecordFromObject(rec);
      records = [];
      renderReviewSection();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function editRecordFromObject(rec){
      document.getElementById('date').value = (rec.date||'').slice(0,10);

      const opdEl = document.getElementById('opd');
      opdEl.value = (rec.opd||'').slice(0,4);
      onOPDInput(opdEl);

      if(!customerMap[opdEl.value]){
        document.getElementById('name').value = rec.name || '';
        document.getElementById('phone').value = rec.phone || '';
      }

      document.getElementById('amount').value = rec.amount || '';
      setPayment(rec.payment === '‡∏™‡∏î' ? '‡∏™‡∏î' : '‡πÇ‡∏≠‡∏ô');
      setSumState('‡∏õ‡∏¥‡∏î');
      document.getElementById('note').value = rec.note || '';

      const list = document.getElementById('itemList');
      list.innerHTML = '';
      if((rec.items||[]).length === 0){
        list.appendChild(makeItemRow());
      }else{
        (rec.items||[]).forEach(line => {
          const row = makeItemRow();
          const m = String(line).match(/^(.*?) ?(?:\((.*?)\))? - (\d+(?:\.\d+)?) ‡∏ä‡∏¥‡πâ‡∏ô x (\d+(?:\.\d+)?) ‡∏ö‡∏≤‡∏ó/);
          const itemSel = row.querySelector('select[name="item[]"]');
          const subSel  = row.querySelector('select[name="subitem[]"]');
          if(m){
            const main = (m[1]||'').trim();
            const sub = (m[2]||'').trim();
            const qty = m[3]||'';
            const price = m[4]||'';

            if(mainCategoryKeys().includes(main)){
              itemSel.value = main;
              updateSubOptions(itemSel, subSel);
              const allSubOptions = Array.from(subSel.options).map(o=>o.value);
              if(allSubOptions.includes(sub)){
                subSel.value = sub;
              }
            }

            row.querySelector('input[name="qty[]"]').value = qty;
            row.querySelector('input[name="price[]"]').value = price;
          }else{
            const plain = String(line).trim();
            const main = plain.split('(')[0].split('-')[0].trim();
            if(mainCategoryKeys().includes(main)){
              itemSel.value = main;
              updateSubOptions(itemSel, subSel);
            }
          }
          list.appendChild(row);
        });
      }
      recalcAmount();
      refreshPayReceiptButtonState();
    }

    // =========================
    // Review / Save (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏∏‡∏ì)
    // =========================
    function reviewForm(){
      const opdVal = (document.getElementById('opd').value||'').trim();
      if(!isValidOPD(opdVal)){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }

      const date = (document.getElementById('date').value||'').slice(0,10);
      const opd  = opdVal;
      const name = document.getElementById('name').value||'';
      const phone = document.getElementById('phone').value||'';
      const amount = document.getElementById('amount').value||'';
      const payment = getPayment();
      const note = document.getElementById('note').value||'';

      const { linesForSave } = collectItemsForReceiptAndSave();

      const rec = { date, opd, name, phone, amount, payment, note, items: linesForSave };
      if(currentEditId){ rec.id = currentEditId; }

      records.push(rec);
      renderReviewSection();
      validateSaveAllReady();

      const keepDate = date; const keepOPD = opd;
      document.getElementById('saleForm').reset();
      document.getElementById('date').value = keepDate;
      document.getElementById('opd').value = keepOPD;
      onOPDInput(document.getElementById('opd'));
      initFirstRow();
      currentEditId = null;
      document.getElementById('currentId').value = '';
      recalcAmount();
      refreshPayReceiptButtonState();
    }

    function renderReviewSection(){
      const section = document.getElementById('reviewSection');
      section.innerHTML = '<h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>';

      const grouped = {};
      records.forEach((r,idx)=>{ const d=r.date||''; (grouped[d]||(grouped[d]=[])).push({...r, _idx: idx}); });

      Object.entries(grouped).sort(([a],[b])=> new Date(b)-new Date(a)).forEach(([date, list])=>{
        const dayTotal = list.reduce((s,r)=> s + (parseFloat(r.amount)||0), 0);
        const container = document.createElement('div'); container.style.marginBottom='24px';
        const header = document.createElement('h4'); header.textContent = `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDate(date)} ‚Äî ‡∏£‡∏ß‡∏° ${dayTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`; container.appendChild(header);

        const rowsHtml = list.map((r,i)=>{
          const itemsHtml = (r.items||[]).map(x=>`<li>${safe(x)}</li>`).join('');
          return `<tr>
            <td>${i+1}</td>
            <td><div><strong>${safe(r.name||'-')}</strong></div><div class="muted">OPD: ${safe(r.opd)}</div></td>
            <td>${safe(r.phone||'-')}</td>
            <td><ul style='margin:0;padding-left:16px;'>${itemsHtml || '<span class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>'}</ul></td>
            <td>${safe(r.amount||0)} ‡∏ö‡∏≤‡∏ó (${safe(r.payment)})${r.note?`<div class='muted'>üìù ${safe(r.note)}</div>`:''}</td>
            <td style="text-align:center;">
              <div class="actions">
                <button type="button" class="btn btn-primary"
                  onclick="editRecordFromObject(records[${r._idx}]); currentEditId = records[${r._idx}].id || null; document.getElementById('currentId').value=currentEditId||'';">
                  ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteRecord(${r._idx})">‡∏•‡∏ö</button>
              </div>
            </td>
          </tr>`;
        }).join('');

        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr>
              <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠</th>
              <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
              <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th>‡∏¢‡∏≠‡∏î</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>`;
        container.appendChild(table);
        section.appendChild(container);
      });
    }

    function deleteRecord(idx){
      if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?')) return;
      records.splice(idx,1);
      renderReviewSection();
      validateSaveAllReady();
    }

    function validateSaveAllReady(){
      const ok = records.length>0 && records.every(r=> isValidOPD(r.opd));
      document.getElementById('btnSaveAll').disabled = !ok;
    }

    function saveAllRecords(){
      if(records.length===0) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß');
      if(!records.every(r=> isValidOPD(r.opd))){
        alert('‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà OPD ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        return;
      }
      if(!confirm('‚ú® ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')) return;
      fetch('/api/save_sales', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(records)
      })
      .then(r=>r.json())
      .then(data=>{
        if(data && (data.message||'').includes('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')){
          alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ${data.updated||0} / ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ${data.inserted||0}`);
          records = []; renderReviewSection(); validateSaveAllReady();
          clearForm();
        }else{
          alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
      })
      .catch(err=>{ console.error(err); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'); });
    }

    function deleteRecordFromSupabase(id){
      if(!id) return;
      if(!confirm('‚ùå ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      fetch('/api/delete_sales_record', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({id})
      })
      .then(r=>r.json()).then(()=>{ alert('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); loadDatesByOPD(); })
      .catch(()=> alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
    }

    // =========================
    // Auto-sum (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏∏‡∏ì)
    // =========================
    function recalcAmount(){
      if(getSumState() !== '‡πÄ‡∏õ‡∏¥‡∏î') return;
      const prices = document.querySelectorAll('input[name="price[]"]');
      const qtys   = document.querySelectorAll('input[name="qty[]"]');
      let total = 0;
      for(let i=0;i<prices.length;i++){
        const p = Number(prices[i].value==='' ? 0 : prices[i].value);
        const q = Number(qtys[i].value||0);
        total += p*q;
      }
      document.getElementById('amount').value = (Number.isInteger(total)? total : Math.round(total));
      refreshPayReceiptButtonState();
    }

    function clearForm(){
      document.getElementById('saleForm').reset();
      initDateToday();
      initFirstRow();
      manualUnlockNamePhone = false;
      lastOPDForLock = '';
      onOPDInput(document.getElementById('opd'));
      document.getElementById('btnReview').disabled = true;
      recalcAmount();
      refreshPayReceiptButtonState();
    }

    // =========================
    // ‚úÖ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏° (Option A)
    // =========================
    function collectItemsForReceiptAndSave(){
      const itemNames = document.querySelectorAll('select[name="item[]"]');
      const itemSubs  = document.querySelectorAll('select[name="subitem[]"]');
      const itemQtys  = document.querySelectorAll('input[name="qty[]"]');

      const rows = [];
      for(let i=0;i<itemNames.length;i++){
        const main = (itemNames[i].value||'').trim();
        const sub  = (itemSubs[i].value||'').trim();
        const qty  = Number(itemQtys[i].value||1) || 1;

        if(!main) continue;
        const label = sub ? `${main} (${sub})` : main;
        rows.push({ label, qty });
      }

      if(rows.length === 0){
        return { rows: [], linesForSave: [] };
      }

      const linesForSave = rows.map(r => `${r.label} - ${r.qty} ‡∏ä‡∏¥‡πâ‡∏ô x 0 ‡∏ö‡∏≤‡∏ó`);
      return { rows, linesForSave };
    }

    function buildReceiptRowsOptionA(total, rows){
      const n = rows.length || 1;
      const base = Math.floor(total / n);
      const rem  = total - (base*n);

      const dateStr = formatDate((document.getElementById('date').value||'').slice(0,10));

      let tbody = '';
      let running = 0;

      rows.forEach((r, idx)=>{
        const lineTotal = (idx===0) ? (base + rem) : base;
        running += lineTotal;

        tbody += `
          <tr>
            <td style="text-align:center;">${idx+1}</td>
            <td>${safe(r.label)}</td>
            <td style="text-align:center;">${Number(r.qty)||1}</td>
            <td style="text-align:right;">${lineTotal.toLocaleString()}</td>
            <td style="text-align:right;">${lineTotal.toLocaleString()}</td>
            <td style="text-align:center;">${safe(dateStr)}</td>
            <td style="text-align:center;">${safe(dateStr)}</td>
          </tr>
        `;
      });

      if(!Number.isFinite(total)) total = running;
      return { tbody, sum: running, base, rem };
    }

    function refreshPayReceiptButtonState(){
      const opdVal = (document.getElementById('opd').value||'').trim();
      const amount = Number(document.getElementById('amount').value||0);
      const hasValid = isValidOPD(opdVal) && Number.isFinite(amount) && amount > 0;
      document.getElementById('btnPayReceipt').disabled = !hasValid;
    }

    // =========================
    // Popup ‡∏ä‡∏±‡πâ‡∏ô 1: ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡πÅ‡∏Å‡πâ: ‡πÑ‡∏°‡πà init ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
    // =========================
    function openPayPopup(){
      const opdVal = (document.getElementById('opd').value||'').trim();
      if(!isValidOPD(opdVal)) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OPD 4 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');

      const total = Number(document.getElementById('amount').value||0);
      if(!Number.isFinite(total) || total<=0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó) ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

      const { rows } = collectItemsForReceiptAndSave();
      if(rows.length===0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

      const date = (document.getElementById('date').value||'').slice(0,10);
      document.getElementById('pay_name').textContent  = document.getElementById('name').value || '-';
      document.getElementById('pay_phone').textContent = (document.getElementById('phone').value || '-');
      document.getElementById('pay_date').textContent  = formatDate(date);
      document.getElementById('pay_method').textContent= `‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢: ${getPayment()}`;
      document.getElementById('pay_total').textContent = `${Math.floor(total).toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

      // default ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ï‡πâ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
      const name = document.getElementById('name').value || '';
      const a = document.getElementById('sig_authorized');
      const c = document.getElementById('sig_customer');
      const r = document.getElementById('sig_receiver');
      if(a && !a.value) a.value = '‡∏û‡∏ç.‡∏õ‡∏¥‡∏¢‡∏∞‡∏é‡∏≤ ‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡∏´‡∏•‡∏ß‡∏á';
      if(c && !c.value) c.value = name;
      if(r && !r.value) r.value = '';

      const ov = document.getElementById('payOverlay');
      ov.style.display='flex';
      ov.setAttribute('aria-hidden','false');
    }

    function closePayPopup(){
      const ov = document.getElementById('payOverlay');
      ov.style.display='none';
      ov.setAttribute('aria-hidden','true');
    }

    // =========================
    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å popup ‡∏ä‡∏±‡πâ‡∏ô 1 ‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ï‡πâ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
    // =========================
    function applySigNamesToReceipt(){
      const a = (document.getElementById('sig_authorized')?.value || '').trim();
      const c = (document.getElementById('sig_customer')?.value || '').trim();
      const r = (document.getElementById('sig_receiver')?.value || '').trim();

      const ua = document.getElementById('sigUnder_authorized');
      const uc = document.getElementById('sigUnder_customer');
      const ur = document.getElementById('sigUnder_receiver');

      if(ua) ua.textContent = a ? `(${a})` : '';
      if(uc) uc.textContent = c ? `(${c})` : '';
      if(ur) ur.textContent = r ? `(${r})` : '';
    }

    // =========================
    // Popup ‡∏ä‡∏±‡πâ‡∏ô 2: ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏° (‡πÅ‡∏Å‡πâ: ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ init ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô, ‡πÑ‡∏°‡πà‡∏ú‡∏π‡∏Å‡∏ã‡πâ‡∏≥)
    // =========================
    function openReceiptFromPay(){
      const total = Math.floor(Number(document.getElementById('amount').value || 0));

      const customerInfo = (document.getElementById('pay_note_input')?.value || '').trim();

      const { rows } = collectItemsForReceiptAndSave();
      if(!rows.length) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

      const { tbody, sum } = buildReceiptRowsOptionA(total, rows);

      document.getElementById('receiptContent').innerHTML = `
        <table class="receipt-table">
          <thead>
            <tr>
              <th colspan="7" style="text-align:center; font-weight:900;">
                ‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå
              </th>
            </tr>
            <tr>
              <th style="width:60px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
              <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th style="width:70px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
              <th style="width:130px;">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ö‡∏≤‡∏ó)</th>
              <th style="width:120px;">‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡∏ö‡∏≤‡∏ó)</th>
              <th style="width:130px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
              <th style="width:130px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody>${tbody}</tbody>
        </table>

        <div class="receipt-total">
          ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô ${sum.toLocaleString()} ‡∏ö‡∏≤‡∏ó
        </div>

        <div class="receipt-section" style="margin-top:14px; font-size:12px; line-height:1.7;">
          <b>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà):</b><br>
          ${customerInfo ? nl2brSafe(customerInfo) : '-'}
        </div>
      `;

      // ‡∏õ‡∏¥‡∏î‡∏ä‡∏±‡πâ‡∏ô 1 ‡∏Å‡πà‡∏≠‡∏ô (‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡∏ö/‡∏Å‡∏±‡∏ô‡∏£‡∏ß‡∏ô‡∏ö‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)
      closePayPopup();

      // ‡πÄ‡∏õ‡∏¥‡∏î‡∏ä‡∏±‡πâ‡∏ô 2 ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ init (‡πÉ‡∏´‡πâ canvas ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á)
      const ov = document.getElementById('receiptOverlay');
      ov.style.display = 'flex';
      ov.setAttribute('aria-hidden','false');

      // ‚úÖ ‡πÄ‡∏≠‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ä‡∏±‡πâ‡∏ô 1 ‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ï‡πâ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
      applySigNamesToReceipt();

      requestAnimationFrame(() => {
        initAllSigPads();
      });
    }

    function closeReceipt(){
      const ov = document.getElementById('receiptOverlay');
      ov.style.display='none';
      ov.setAttribute('aria-hidden','true');
    }

    // =========================
    // Diagnostics (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏∏‡∏ì)
    // =========================
    const normName = s => String(s||'').trim().toLowerCase().replace(/\s+/g,' ');
    const onlyDigits = s => String(s||'').replace(/\D/g,'');
    const normPhone = s => {
      let d = onlyDigits(s);
      if(d.startsWith('66') && d.length>=11) d = '0' + d.slice(-9);
      return d;
    };
    const normOPD = s => String(s||'').trim().padStart(4,'0');
    const isValidPhone = p => { const d = normPhone(p); return d.length===9 || d.length===10; };
    const isValidOPDVal = o => /^\d{4}$/.test(String(o||'').trim());

    async function ensureAllSales(){
      if(allSales) return allSales;
      const r = await fetch('/api/sales');
      const data = await r.json().catch(()=>[]);
      allSales = data || [];
      return allSales;
    }

    async function runDiag(type){
      await ensureAllSales();
      const rows = diagCompute(type);
      renderDiag(type, rows);
    }

    function diagCompute(type){
      const out = [];
      const byName = new Map();
      const byPhone = new Map();
      const byOPD = new Map();
      const byTripletNorm = new Map();

      (allSales||[]).forEach(r=>{
        const nameN = normName(r.name);
        const phoneN = normPhone(r.phone);
        const opdN = normOPD(r.opd);

        if(!byName.has(nameN)) byName.set(nameN,{opds:new Set(),phones:new Set(),rows:[]});
        byName.get(nameN).opds.add(opdN); byName.get(nameN).phones.add(phoneN||''); byName.get(nameN).rows.push(r);

        if(phoneN){
          if(!byPhone.has(phoneN)) byPhone.set(phoneN,{names:new Set(),opds:new Set(),rows:[]});
          byPhone.get(phoneN).names.add(nameN); byPhone.get(phoneN).opds.add(opdN); byPhone.get(phoneN).rows.push(r);
        }

        if(!byOPD.has(opdN)) byOPD.set(opdN,{names:new Set(),phones:new Set(),rows:[]});
        byOPD.get(opdN).names.add(nameN); byOPD.get(opdN).phones.add(phoneN||''); byOPD.get(opdN).rows.push(r);

        const tripKey = `${nameN}|${phoneN}|${opdN}`;
        if(!byTripletNorm.has(tripKey)) byTripletNorm.set(tripKey,{rawKeys:new Set(),rows:[]});
        byTripletNorm.get(tripKey).rawKeys.add(`${(r.name||'').trim()}|${(r.phone||'').trim()}`);
        byTripletNorm.get(tripKey).rows.push(r);
      });

      switch(type){
        case 'missingPhone': {
          (allSales||[]).forEach(r=>{
            const d = normPhone(r.phone);
            if(!d){ out.push({id:r.id, name:r.name||'-',opd:normOPD(r.opd),phone:'-',date:r.date}); }
          });
          break;
        }
        case 'nameDifferentOPD': {
          byName.forEach((v)=>{
            const opds = Array.from(v.opds).filter(x=>x!=='0000' && x!=='');
            if(new Set(opds).size>1){
              out.push({
                name: v.rows[0]?.name || '-',
                opds: Array.from(new Set(opds)),
                phones: Array.from(v.phones).filter(Boolean),
                count: v.rows.length
              });
            }
          });
          break;
        }
        case 'phoneDifferentName': {
          byPhone.forEach((v, phoneN)=>{
            if(!phoneN) return;
            if(v.names.size>1){
              out.push({
                phone: phoneN,
                names: Array.from(v.names).map(n=>v.rows.find(r=>normName(r.name)===n)?.name || n),
                opds: Array.from(v.opds),
                count: v.rows.length
              });
            }
          });
          break;
        }
        case 'opdDifferentNamePhone': {
          byOPD.forEach((v, opdN)=>{
            if(v.names.size>1 || (v.phones.size>1 && !v.phones.has(''))){
              out.push({
                opd: opdN,
                names: Array.from(v.names).map(n=>v.rows.find(r=>normName(r.name)===n)?.name || n),
                phones: Array.from(v.phones),
                count: v.rows.length
              });
            }
          });
          break;
        }
        case 'invalidPhone': {
          (allSales||[]).forEach(r=>{
            const d = normPhone(r.phone);
            if(d && !isValidPhone(d)){
              out.push({id:r.id, name:r.name||'-',opd:normOPD(r.opd),phone:r.phone||'-',date:r.date});
            }
          });
          break;
        }
        case 'invalidOPD': {
          (allSales||[]).forEach(r=>{
            if(!isValidOPDVal(String(r.opd||''))){
              out.push({id:r.id, name:r.name||'-',opd:String(r.opd||''),norm: normOPD(r.opd),phone:r.phone||'-',date:r.date});
            }
          });
          break;
        }
        case 'splitGroups': {
          byTripletNorm.forEach((v, k)=>{
            if(v.rawKeys.size>1){
              const [nameN, phoneN, opdN] = k.split('|');
              out.push({
                name: v.rows[0]?.name || nameN,
                opd: opdN,
                phone: v.rows[0]?.phone || phoneN,
                variants: Array.from(v.rawKeys),
                count: v.rows.length
              });
            }
          });
          break;
        }
        case 'sameNameMultiPhones': {
          byName.forEach((v)=>{
            const phones = Array.from(v.phones);
            const nonEmpty = phones.filter(p=>p);
            if(nonEmpty.length>1 || (nonEmpty.length>=1 && phones.includes(''))){
              out.push({
                name: v.rows[0]?.name || '-',
                phones: phones,
                opds: Array.from(v.opds),
                count: v.rows.length
              });
            }
          });
          break;
        }
      }
      return out;
    }

    function renderDiag(type, rows){
      const head = document.getElementById('diag-head');
      const body = document.getElementById('diag-body');
      const counter = document.getElementById('diag-count');

      const headersByType = {
        missingPhone: ['‡∏ä‡∏∑‡πà‡∏≠','OPD','‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£'],
        nameDifferentOPD: ['‡∏ä‡∏∑‡πà‡∏≠','OPDs','‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ö','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'],
        phoneDifferentName: ['‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏û‡∏ö','OPDs','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'],
        opdDifferentNamePhone: ['OPD','‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏û‡∏ö','‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ö','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'],
        invalidPhone: ['‡∏ä‡∏∑‡πà‡∏≠','OPD','‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£'],
        invalidOPD: ['‡∏ä‡∏∑‡πà‡∏≠','OPD (‡πÄ‡∏î‡∏¥‡∏°)','OPD ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î','‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£'],
        splitGroups: ['‡∏ä‡∏∑‡πà‡∏≠','OPD','‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏û‡∏ö (name|phone)','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'],
        sameNameMultiPhones: ['‡∏ä‡∏∑‡πà‡∏≠','‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î','OPDs','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç']
      };

      const cols = headersByType[type] || ['‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'];
      head.innerHTML = cols.map(c=>`<th>${c}</th>`).join('');

      body.innerHTML = rows.map(r=>{
        switch(type){
          case 'missingPhone': {
            return `<tr>
              <td>${safe(r.name)}</td>
              <td>${safe(r.opd)}</td>
              <td style="color:#b91c1c">-</td>
              <td>${formatDate((r.date||'').slice(0,10))}</td>
              <td><button class="btn btn-outline" onclick="editFromDiag('${r.opd}','${r.id||''}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button></td>
            </tr>`;
          }
          case 'nameDifferentOPD': {
            const opds = (r.opds||[]).map(o=>`<button class="btn btn-outline" onclick="goEditByOPD('${o}')">OPD ${o}</button>`).join(' ');
            return `<tr>
              <td>${safe(r.name)}</td>
              <td>${safe((r.opds||[]).join(', '))}</td>
              <td>${safe((r.phones||[]).join(', ')||'-')}</td>
              <td>${r.count}</td>
              <td>${opds||'-'}</td>
            </tr>`;
          }
          case 'phoneDifferentName': {
            const opds = (r.opds||[]).map(o=>`<button class="btn btn-outline" onclick="goEditByOPD('${o}')">OPD ${o}</button>`).join(' ');
            return `<tr>
              <td>${safe(r.phone)}</td>
              <td>${safe((r.names||[]).join(', '))}</td>
              <td>${safe((r.opds||[]).join(', '))}</td>
              <td>${r.count}</td>
              <td>${opds||'-'}</td>
            </tr>`;
          }
          case 'opdDifferentNamePhone': {
            return `<tr>
              <td>${safe(r.opd)}</td>
              <td>${safe((r.names||[]).join(', '))}</td>
              <td>${safe((r.phones||[]).join(', '))}</td>
              <td>${r.count}</td>
              <td><button class="btn btn-outline" onclick="goEditByOPD('${r.opd}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç OPD ${safe(r.opd)}</button></td>
            </tr>`;
          }
          case 'invalidPhone': {
            return `<tr>
              <td>${safe(r.name)}</td>
              <td>${safe(r.opd)}</td>
              <td style="color:#b91c1c">${safe(r.phone)}</td>
              <td>${formatDate((r.date||'').slice(0,10))}</td>
              <td><button class="btn btn-outline" onclick="editFromDiag('${r.opd}','${r.id||''}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button></td>
            </tr>`;
          }
          case 'invalidOPD': {
            return `<tr>
              <td>${safe(r.name)}</td>
              <td style="color:#b91c1c">${safe(r.opd)}</td>
              <td>${safe(r.norm)}</td>
              <td>${safe(r.phone)}</td>
              <td>${formatDate((r.date||'').slice(0,10))}</td>
              <td><button class="btn btn-outline" onclick="goEditByOPD('${r.norm}')">‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î OPD ${safe(r.norm)}</button></td>
            </tr>`;
          }
          case 'splitGroups': {
            return `<tr>
              <td>${safe(r.name)}</td>
              <td>${safe(r.opd)}</td>
              <td>${safe(r.phone)}</td>
              <td>${safe((r.variants||[]).join(' | '))}</td>
              <td>${r.count}</td>
              <td><button class="btn btn-outline" onclick="goEditByOPD('${r.opd}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç OPD ${safe(r.opd)}</button></td>
            </tr>`;
          }
          case 'sameNameMultiPhones': {
            const opds = (r.opds||[]).map(o=>`<button class="btn btn-outline" onclick="goEditByOPD('${o}')">OPD ${o}</button>`).join(' ');
            return `<tr>
              <td>${safe(r.name)}</td>
              <td>${safe((r.phones||[]).map(p=>p||'(‡∏ß‡πà‡∏≤‡∏á)').join(', '))}</td>
              <td>${safe((r.opds||[]).join(', '))}</td>
              <td>${r.count}</td>
              <td>${opds||'-'}</td>
            </tr>`;
          }
          default: return `<tr><td>‚Äî</td></tr>`;
        }
      }).join('');

      document.getElementById('diag-results').style.display = 'table';
      counter.textContent = rows.length ? `‡∏û‡∏ö ${rows.length} ‡πÄ‡∏Ñ‡∏™` : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
      document.getElementById('diag-results').scrollIntoView({behavior:'smooth', block:'start'});
    }

    function goEditByOPD(opd){
      if(!isValidOPD(opd)) { alert('OPD ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ'); return; }
      loadDatesByOPDFor(opd).then(()=>{
        const top = document.getElementById('editSection').offsetTop;
        window.scrollTo({ top: Math.max(0, top - 10), behavior: 'smooth' });
      });
    }

    function editFromDiag(opd, id){
      if(!isValidOPD(opd)) { alert('OPD ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å'); return; }
      loadDatesByOPDFor(opd).then(()=>{
        if(id){ editSelectedRecordById(id); }
        const top = document.getElementById('editSection').offsetTop;
        window.scrollTo({ top: Math.max(0, top - 10), behavior: 'smooth' });
      });
    }

    // ‡∏õ‡∏¥‡∏î popup ‡∏î‡πâ‡∏ß‡∏¢ ESC
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        if(document.getElementById('receiptOverlay').style.display==='flex') closeReceipt();
        else if(document.getElementById('payOverlay').style.display==='flex') closePayPopup();
      }
    });

    // =========================
    // Signature Pads (3 ‡∏ä‡πà‡∏≠‡∏á) - ‡πÅ‡∏Å‡πâ: ‡∏Å‡∏±‡∏ô‡∏ú‡∏π‡∏Å listener ‡∏ã‡πâ‡∏≥ + init ‡∏ï‡∏≠‡∏ô overlay ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á
    // =========================
    const sigState = {
      authorized: { drawing:false, last:null },
      customer:   { drawing:false, last:null },
      receiver:   { drawing:false, last:null }
    };

    function resizeSigCanvas(canvas, ctx){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      if(rect.width === 0 || rect.height === 0) return;

      canvas.width  = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);

      ctx.setTransform(dpr,0,0,dpr,0,0);

      ctx.save();
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,rect.width,rect.height);
      ctx.restore();
    }

    function setupSigPad(key){
      const canvas = document.getElementById(`sigPad_${key}`);
      if(!canvas) return;

      const ctx = canvas.getContext('2d');
      ctx.lineWidth = 2.2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      // ‚úÖ resize ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î
      resizeSigCanvas(canvas, ctx);

      // ‚úÖ ‡∏Å‡∏±‡∏ô‡∏ú‡∏π‡∏Å event ‡∏ã‡πâ‡∏≥
      if(canvas.dataset.bound === '1') return;
      canvas.dataset.bound = '1';

      function getPos(e){
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
      }

      function start(e){
        e.preventDefault();
        sigState[key].drawing = true;
        sigState[key].last = getPos(e);
      }
      function move(e){
        if(!sigState[key].drawing) return;
        e.preventDefault();
        const p = getPos(e);
        const last = sigState[key].last;
        ctx.beginPath();
        ctx.moveTo(last.x, last.y);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        sigState[key].last = p;
      }
      function end(){
        sigState[key].drawing = false;
        sigState[key].last = null;
      }

      canvas.addEventListener('mousedown', start);
      window.addEventListener('mousemove', move);
      window.addEventListener('mouseup', end);

      canvas.addEventListener('touchstart', start, {passive:false});
      canvas.addEventListener('touchmove', move, {passive:false});
      canvas.addEventListener('touchend', end);

      window.addEventListener('resize', ()=> resizeSigCanvas(canvas, ctx));
    }

    function clearSig(key){
      const canvas = document.getElementById(`sigPad_${key}`);
      if(!canvas) return;
      const ctx = canvas.getContext('2d');

      // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á canvas
      ctx.setTransform(1,0,0,1,0,0);
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // ‡∏Ñ‡∏∑‡∏ô transform ‡∏ï‡∏≤‡∏° dpr
      const dpr = window.devicePixelRatio || 1;
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }

    function initAllSigPads(){
      setupSigPad('authorized');
      setupSigPad('customer');
      setupSigPad('receiver');
    }
  </script>

  <!-- ‚úÖ floating menu -->
  {% include 'floating_menu.html' %}
</body>
</html>
